---
title: ç¬¬12ç« ï¼šå®Œå–„ORMæ¡†æ¶ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œ
lock: need
---

# ã€ŠMybatis æ‰‹æ’¸ä¸“æ ã€‹ç¬¬12ç« ï¼šå®Œå–„ORMæ¡†æ¶ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œ

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/_-LYA6uZhB7GQ-50C0IZYA](https://mp.weixin.qq.com/s/_-LYA6uZhB7GQ-50C0IZYA)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=430236300&bvid=BV1eG411G7fk&cid=823607781&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`æ—¶é—´å†å¤šä¸€ä»¶äº‹æƒ…ä¹Ÿä¸å¯èƒ½åšçš„å®Œç¾ï¼Œä½†æ€»æœ‰æ—¶é—´åšå®Œä¸€ä»¶äº‹æƒ…ï¼`

åœ¨æˆ‘ä»¬çš„ç”Ÿæ´»ä¸­ï¼Œè¦ç»å†å¾ˆå¤šé‡è¦çš„é˜¶æ®µï¼ŒåŒ…æ‹¬ï¼›é«˜è€ƒã€æ±‚å©šã€é¢è¯•ã€è¿°èŒï¼Œåœ¨æ‰€æœ‰äº‹æƒ…å‘ç”Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½åœ¨åšç€å¤§é‡çš„å‡†å¤‡ï¼Œç”šè‡³åƒä¸ºäº†é«˜è€ƒçš„è¿™æ ·çš„æ—¶é—´ç‚¹ï¼Œè¦å‡†å¤‡å¥½å‡ å¹´ã€‚å¯å³ä½¿æœ‰è¿™æ ·çš„å¤§é‡çš„å‡†å¤‡æ—¶é—´ï¼Œæˆ‘ä»¬å‡ ä¹ä¹Ÿæ²¡æœ‰åŠæ³•æŠŠæœ€ç»ˆçš„ç»“æœåšåˆ°å®Œç¾ï¼Œåªèƒ½æ˜¯æŠŠç»“æœåšå®Œã€‚*æ²¡æœ‰é—æ†¾çš„äººç”Ÿï¼Œæ‰æ˜¯é—æ†¾ï¼*

å…¶å®æˆ‘ä»¬çš„ç³»ç»Ÿè®¾è®¡å¼€å‘ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç³»ç»Ÿè¶Šåšè¶Šå¤æ‚ï¼ŒåŠŸèƒ½è¶Šåšè¶Šå¤šï¼Œä½†äººçš„æ™ºåŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œæ°¸è¿œæ— æ³•å®Œå…¨è¯„ä¼°æœªå‘ç”Ÿçš„äº‹æƒ…ã€‚æ‰€ä»¥å¯¹äºä¸€ä¸ªå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬å‡ ä¹æ°¸è¿œä¸å¯èƒ½æ‰¾åˆ°å¹¶ä¿®å¤æ‰€æœ‰çš„ bugï¼Œæœ‰æ—¶å€™è§£å†³æ–¹æ³•ä¹Ÿä¸æ˜¯å®Œå…¨æ‰¾å‡ºæ‰€æœ‰é—®é¢˜å¹¶æ¶ˆç­ï¼Œè€Œæ˜¯èƒ½å®¹å¿éƒ¨åˆ†å°é—®é¢˜ï¼Œå¹¶åœ¨è¿™äº›é—®é¢˜å‘ç”Ÿæ—¶å¯ä»¥è‡ªåŠ¨æ¢å¤ï¼Œåšåˆ°æœ€ç»ˆè¡¥å¿å¤„ç†ã€‚è€Œè¿™æ ·çš„è®¾è®¡ä¹Ÿç§°ä¸ºé«˜å¯ç”¨å’Œå¼¹æ€§è®¾è®¡ã€‚

## äºŒã€ç›®æ ‡

å‰é¢å„ä¸ªç« èŠ‚çš„å†…å®¹ï¼Œæ¸è¿›å¼çš„é€æ­¥ä¸ºæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåŸºæœ¬çš„æ¡†æ¶ç»“æ„ï¼Œèƒ½æ»¡è¶³æˆ‘ä»¬å¯¹ä¸€ä¸ª DAO æ–¹æ³•çš„æŸ¥è¯¢æ“ä½œï¼Œä»¥åŠå¤„ç†å¯¹åº”çš„å‚æ•°å’Œè¿”å›ç»“æœã€‚

é‚£ä¹ˆç›®å‰è¿™ä¸ªæ¡†æ¶ä¸­æ‰€æä¾›çš„ SQL å¤„ç†ä»…æœ‰ä¸€ä¸ª select æŸ¥è¯¢æ“ä½œï¼Œè¿˜æ²¡æœ‰å…¶ä»–æˆ‘ä»¬æ—¥å¸¸å¸¸ç”¨çš„ insertã€updateã€deleteï¼Œä»¥åŠ select æŸ¥è¯¢è¿”å›çš„é›†åˆç±»å‹æ•°æ®ã€‚

å…¶å®è¿™ä¸€éƒ¨åˆ†æ–°å¢å¤„ç† SQL çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯åœ¨ SqlSession éœ€è¦å®šä¹‰æ–°çš„æ¥å£ï¼Œé€šçŸ¥è®©è¿™äº›æ¥å£è¢«æ˜ å°„å™¨ç±»æ–¹æ³• MapperMethod è¿›è¡Œè°ƒç”¨å¤„ç†ã€‚å¦‚å›¾ 12-1 æ‰€ç¤º SqlSession å®šä¹‰æ“ä½œSQLæ–¹æ³•

![å›¾ 12-1  SqlSession å®šä¹‰æ“ä½œSQLæ–¹æ³• ](https://bugstack.cn/images/article/spring/mybatis-220610-01.png)

- ç»“åˆç€æˆ‘ä»¬ç›®å‰æ¡†æ¶çš„å¼€å‘ç»“æ„ï¼Œå¯¹äºæ‰©å±• `insert/update/delete` è¿™éƒ¨åˆ†åŠŸèƒ½æ¥è¯´ï¼Œå¹¶ä¸ä¼šå¤ªå¤æ‚çš„ã€‚å› ä¸ºä» XML å¯¹æ–¹æ³•çš„è§£æã€å‚æ•°çš„å¤„ç†ã€ç»“æœçš„å°è£…ï¼Œéƒ½å·²ç»æ˜¯æˆå‹çš„ç»“æ„ã€‚è€Œæˆ‘ä»¬åªæ˜¯å¯¹æŠŠè¿™éƒ¨åˆ†æ–°å¢é€»è¾‘ä»å‰åˆ°åä¸²è”åˆ° ORM æ¡†æ¶ä¸­å°±å¯ä»¥å®ç°å¯¹æ•°æ®åº“çš„æ–°å¢ã€ä¿®æ”¹å’Œåˆ é™¤æ“ä½œäº†ã€‚
- æ‰€ä»¥è¯»è€…åœ¨é˜…è¯»è¿™éƒ¨åˆ†ä»£ç çš„æ—¶å€™ï¼Œå¯ä»¥ç»“åˆ XMLMapperBuilder æ–°å¢è§£æ `insert/update/delete` å’Œ SqlSession è°ƒç”¨æ‰§è¡Œå…¥å£è¿›è¡Œä»£ç è°ƒè¯•ï¼Œè¿™æ ·å°±èƒ½ä¸²è”å‡ºæ•´ä¸ªåŠŸèƒ½é“¾è·¯äº†ã€‚

## ä¸‰ã€è®¾è®¡

å‡å®šè¿™å°±æ˜¯ä½ æ­£åœ¨æ‰¿æ¥çš„ä¸šåŠ¡åŠŸèƒ½éœ€æ±‚ï¼Œä½ è¦åœ¨ç°åœ¨æœ‰çš„æ¡†æ¶ä¸­å®Œæˆå¯¹ `insert/update/delete` æ–¹æ³•çš„æ‰©å±•ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½ éœ€è¦æ€è€ƒï¼Œå“ªé‡Œæ˜¯è¿™ä¸ªæµç¨‹çš„å¼€å§‹ï¼Œä¹‹åä»æµç¨‹çš„å¼€å§‹è¿›è¡Œæ¢³ç†ã€‚

é‚£ä¹ˆè¿™é‡Œæ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆè§£å†³çš„æ˜¯å¯¹ XML çš„è§£æï¼Œç”±äºä¹‹å‰åœ¨ ORM æ¡†æ¶çš„å¼€å‘ä¸­ï¼Œä»…æ˜¯å¤„ç†äº† select çš„ SQL ä¿¡æ¯ï¼Œç°åœ¨åˆ™éœ€è¦æŠŠ `insert/update/delete` çš„è¯­å¥ä¹ŸæŒ‰ç…§è§£æ select çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚å¦‚å›¾ 12-2 æ‰€ç¤ºï¼Œæ–°å¢è§£æå†…å®¹

![å›¾ 12-2 æ–°å¢è§£æå†…å®¹](https://bugstack.cn/images/article/spring/mybatis-220610-02.png)

åœ¨æ·»åŠ äº†è§£ææ–°ç±»å‹ SQL æ“ä½œå‰æä¸‹ï¼Œåç»­ DefaultSqlSession ä¸­æ–°å¢çš„æ‰§è¡Œ SQL æ–¹æ³• insert/update/delete å°±å¯ä»¥é€šè¿‡ Configuration é…ç½®é¡¹æ‹¿åˆ°å¯¹åº”çš„æ˜ å°„å™¨è¯­å¥ï¼Œå¹¶æ‰§è¡Œåç»­çš„å¤„ç†æµç¨‹ã€‚å…·ä½“è®¾è®¡ï¼Œå¦‚å›¾ 12-3 æ‰€ç¤ºï¼Œè§£æXML å¹¶å¤„ç† SQL è¯­å¥

![å›¾ 12-3 è§£æXML å¹¶å¤„ç† SQL è¯­å¥](https://bugstack.cn/images/article/spring/mybatis-220610-03.png)

- åœ¨æ‰§è¡Œ `sqlSession.getMapper(IUserDao.class)` è·å– Mapper ä»¥åï¼Œåç»­çš„æµç¨‹ä¼šä¾æ¬¡ä¸²è”åˆ°æ˜ å°„å™¨å·¥å‚ã€æ˜ å°„å™¨ï¼Œä»¥åŠè·å–å¯¹åº”çš„æ˜ å°„å™¨æ–¹æ³•ï¼Œä» MapperMethod æ˜ å°„å™¨æ–¹æ³•å¼€å§‹ï¼Œè°ƒç”¨çš„å°±æ˜¯ DefaultSqlSession äº†ã€‚
- é‚£ä¹ˆè¿™é‡Œè¦æ³¨æ„ï¼Œé™¤äº†æˆ‘ä»¬å·²ç»å¼€å‘å®Œçš„ DefaultSqlSession#select æ–¹æ³•ï¼Œå…¶ä»–å®šä¹‰çš„ insertã€deleteã€updateï¼Œéƒ½æ˜¯è°ƒç”¨å†…éƒ¨çš„ update æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ Mybatis ORM æ¡†æ¶å¯¹æ­¤ç±»è¯­å¥å¤„ç†çš„ä¸€ä¸ªåŒ…è£…ã€‚å› ä¸ºé™¤äº† select æ–¹æ³•ï¼Œinsertã€deleteã€updateï¼Œéƒ½æ˜¯å…±æ€§å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥å¯ä»¥è¢«åŒ…è£…æˆä¸€ä¸ªé€»è¾‘æ¥å¤„ç†ã€‚

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
mybatis-step-11
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”‚   â”œâ”€â”€ MapperMethod.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java
    â”‚           â”‚   â””â”€â”€ MapperRegistry.java
    â”‚           â”œâ”€â”€ builder
    â”‚           â”‚   â”œâ”€â”€ xml
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLConfigBuilder.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLMapperBuilder.java
    â”‚           â”‚   â”‚   â””â”€â”€ XMLStatementBuilder.java
    â”‚           â”‚   â”œâ”€â”€ BaseBuilder.java
    â”‚           â”‚   â”œâ”€â”€ MapperBuilderAssistant.java
    â”‚           â”‚   â”œâ”€â”€ ParameterExpression.java
    â”‚           â”‚   â”œâ”€â”€ SqlSourceBuilder.java
    â”‚           â”‚   â””â”€â”€ StaticSqlSource.java
    â”‚           â”œâ”€â”€ datasource
    â”‚           â”œâ”€â”€ executor
    â”‚           â”‚   â”œâ”€â”€ parameter
    â”‚           â”‚   â”‚   â””â”€â”€ ParameterHandler.java
    â”‚           â”‚   â”œâ”€â”€ result
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultResultContext.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultResultHandler.java
    â”‚           â”‚   â”œâ”€â”€ resultset
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultResultSetHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ ResultSetHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ ResultSetWrapper.java
    â”‚           â”‚   â”œâ”€â”€ statement
    â”‚           â”‚   â”‚   â”œâ”€â”€ BaseStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ PreparedStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ SimpleStatementHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ StatementHandler.java
    â”‚           â”‚   â”œâ”€â”€ BaseExecutor.java
    â”‚           â”‚   â”œâ”€â”€ Executor.java
    â”‚           â”‚   â””â”€â”€ SimpleExecutor.java
    â”‚           â”œâ”€â”€ io
    â”‚           â”œâ”€â”€ mapping
    â”‚           â”‚   â”œâ”€â”€ BoundSql.java
    â”‚           â”‚   â”œâ”€â”€ Environment.java
    â”‚           â”‚   â”œâ”€â”€ MappedStatement.java
    â”‚           â”‚   â”œâ”€â”€ ParameterMapping.java
    â”‚           â”‚   â”œâ”€â”€ ResultMap.java
    â”‚           â”‚   â”œâ”€â”€ ResultMapping.java
    â”‚           â”‚   â”œâ”€â”€ SqlCommandType.java
    â”‚           â”‚   â””â”€â”€ SqlSource.java
    â”‚           â”œâ”€â”€ parsing
    â”‚           â”œâ”€â”€ reflection
    â”‚           â”œâ”€â”€ scripting
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultParameterHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ RawSqlSource.java
    â”‚           â”‚   â”œâ”€â”€ xmltags
    â”‚           â”‚   â”‚   â”œâ”€â”€ DynamicContext.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ MixedSqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ SqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ StaticTextSqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLLanguageDriver.java
    â”‚           â”‚   â”‚   â””â”€â”€ XMLScriptBuilder.java
    â”‚           â”‚   â”œâ”€â”€ LanguageDriver.java
    â”‚           â”‚   â””â”€â”€ LanguageDriverRegistry.java
    â”‚           â”œâ”€â”€ session
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSqlSession.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Configuration.java
    â”‚           â”‚   â”œâ”€â”€ ResultContext.java
    â”‚           â”‚   â”œâ”€â”€ ResultHandler.java
    â”‚           â”‚   â”œâ”€â”€ RowBounds.java
    â”‚           â”‚   â”œâ”€â”€ SqlSession.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactoryBuilder.java
    â”‚           â”‚   â””â”€â”€ TransactionIsolationLevel.java
    â”‚           â”œâ”€â”€ transaction
    â”‚           â””â”€â”€ type
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ cn.bugstack.mybatis.test.dao
        â”‚       â”œâ”€â”€ dao
        â”‚       â”‚   â””â”€â”€ IUserDao.java
        â”‚       â”œâ”€â”€ po
        â”‚       â”‚   â””â”€â”€ User.java
        â”‚       â””â”€â”€ ApiTest.java
        â””â”€â”€ resources
            â”œâ”€â”€ mapper
            â”‚   â””â”€â”€User_Mapper.xml
            â””â”€â”€ mybatis-config-datasource.xml
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šæ‰‹å†™Mybatisï¼Œè·å–å®Œæ•´æºç `

å®Œå–„ORMæ¡†æ¶ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œæ ¸å¿ƒç±»å…³ç³»ï¼Œå¦‚å›¾ 12-4 æ‰€ç¤º

![å›¾ 12-4 å®Œå–„ORMæ¡†æ¶ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œæ ¸å¿ƒç±»å…³ç³»](https://bugstack.cn/images/article/spring/mybatis-220610-04.png)

- é¦–å…ˆåœ¨ XML æ˜ å°„å™¨æ„å»ºå™¨ä¸­ï¼Œæ‰©å±• XMLMapperBuilder#configurationElement æ–¹æ³•ï¼Œæ·»åŠ å¯¹ insert/update/delete çš„è§£ææ“ä½œã€‚è¿™éƒ¨åˆ†ä¸éœ€è¦å¤ªå¤šçš„å¤„ç†ï¼Œåªè¦æ·»åŠ ä¸Šè§£æç±»å‹ï¼Œå°±èƒ½æ»¡è¶³å½“å‰ç« èŠ‚çš„è¯‰æ±‚ã€‚åŒæ ·è¿™é‡Œçš„è§£æä¿¡æ¯éƒ½ä¼šå­˜æ”¾åˆ° Configuration é…ç½®é¡¹çš„æ˜ å°„è¯­å¥Mapé›†åˆ mappedStatements ä¸­ï¼Œä¾›åç»­ DefaultSqlSession æ‰§è¡ŒSQLè·å–é…ç½®ä¿¡æ¯æ—¶ä½¿ç”¨ã€‚
- æ¥ä¸‹æ¥æ˜¯å¯¹ MapperMethod æ˜ å°„å™¨æ–¹æ³•çš„æ”¹é€ ï¼Œåœ¨å‰é¢ç« èŠ‚æˆ‘ä»¬åªæ˜¯å¤„ç†äº† MapperMethod#execute ä¸­ SELECT ç±»å‹çš„è¯­å¥ï¼Œè¿™ä¸€ç« èŠ‚éœ€è¦åœ¨è¿™é‡Œæ‰©å±• INSERTã€DELETEã€UPDATEï¼ŒåŒæ—¶è¿˜éœ€è¦å¯¹ SELECT è¿›è¡Œæ‰©å±•æŸ¥è¯¢å‡ºå¤šä¸ªç»“æœé›†çš„æ–¹æ³•ã€‚
- æ‰€éœ€è¦æ‰©å±•çš„è¿™äº›ä¿¡æ¯ï¼Œéƒ½æ˜¯æœ‰ DefaultSqlSession è°ƒç”¨æ‰§è¡Œå™¨ Executor è¿›è¡Œå¤„ç†çš„ï¼Œè¿™é‡Œä½ ä¼šçœ‹åˆ° Executor ä¸­åªæœ‰ update è¿™ä¸ªæ–°å¢æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ insertã€deleteï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯è°ƒç”¨çš„ update è¿›è¡Œå¤„ç†çš„ã€‚
- ä»¥ä¸Šè¿™äº›å†…å®¹å®ç°å®Œæˆåï¼Œæ‰€æœ‰æ–°å¢æ–¹æ³•çš„è°ƒç”¨ï¼Œéƒ½ä¼šæŒ‰ç…§å‰é¢ç« èŠ‚å®ç°çš„è¯­å¥æ‰§è¡Œã€å‚æ•°å¤„ç†ã€ç»“æœå°è£…ç­‰æ­¥éª¤ï¼ŒæŠŠæµç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶è¿”å›æœ€ç»ˆçš„ç»“æœã€‚

### 2. æ‰©å±•è§£æå…ƒç´ 

é¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆè§£å†³æ–°å¢ SQL ç±»å‹çš„ XML è¯­å¥ï¼ŒæŠŠ insertã€updateã€deleteï¼Œå‡ ç§ç±»å‹çš„ SQL è§£æå®Œæˆåï¼Œå­˜æ”¾åˆ° Configuration é…ç½®é¡¹çš„æ˜ å°„å™¨è¯­å¥ä¸­ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.builder.xml.XMLMapperBuilder`

```java
public class XMLMapperBuilder extends BaseBuilder {

    // çœç•¥éƒ¨åˆ†æœªæ”¹å˜ä»£ç ï¼Œå¯å‚è€ƒå¯¹åº”çš„æºç å­¦ä¹ ...

    // é…ç½®mapperå…ƒç´ 
    // <mapper namespace="org.mybatis.example.BlogMapper">
    //   <select id="selectBlog" parameterType="int" resultType="Blog">
    //    select * from Blog where id = #{id}
    //   </select>
    // </mapper>
    private void configurationElement(Element element) {
        // 1.é…ç½®namespace
        String namespace = element.attributeValue("namespace");
        if (namespace.equals("")) {
            throw new RuntimeException("Mapper's namespace cannot be empty");
        }
        builderAssistant.setCurrentNamespace(namespace);

        // 2.é…ç½®select|insert|update|delete
        buildStatementFromContext(element.elements("select"),
                element.elements("insert"),
                element.elements("update"),
                element.elements("delete")
        );
    }

    // é…ç½®select|insert|update|delete
    @SafeVarargs
    private final void buildStatementFromContext(List<Element>... lists) {
        for (List<Element> list : lists) {
            for (Element element : list) {
                final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, element);
                statementParser.parseStatementNode();
            }
        }
    }

}
```

- ä¸å‰é¢ç« èŠ‚ç›¸æ¯”ï¼Œè¿™é‡Œæ”¹é€  buildStatementFromContext æ–¹æ³•çš„å…¥å‚ç±»å‹ä¸º list çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯å¤„ç†æ‰€ä¼ é€’åˆ°æ–¹æ³•ä¸­çš„æ‰€æœ‰è¯­å¥çš„é›†åˆã€‚
- ä¹‹ååœ¨ XMLMapperBuilder#configurationElement è°ƒç”¨å±‚ï¼Œä¼ é€’ `element.elements("select")ã€element.elements("insert")ã€element.elements("update")ã€element.elements("delete")` å››ä¸ªç±»å‹çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æŠŠé…ç½®åˆ° Mapper XML ä¸­çš„ä¸åŒ SQL è§£æå­˜æ”¾èµ·æ¥äº†ã€‚

### 3. æ–°å¢æ‰§è¡Œæ–¹æ³•

åœ¨ Mybatis çš„ ORM æ¡†æ¶ä¸­ï¼ŒDefaultSqlSession ä¸­æœ€ç»ˆçš„ SQL æ‰§è¡Œéƒ½ä¼šè°ƒç”¨åˆ° Executor æ‰§è¡Œå™¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å…³äºæ‰§è¡Œå™¨ä¸­æ–°å¢æ–¹æ³•çš„å˜åŒ–ã€‚

#### 3.1 updateæ¥å£å®šä¹‰

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.Executor`

```java
public interface Executor {

    ResultHandler NO_RESULT_HANDLER = null;

    int update(MappedStatement ms, Object parameter) throws SQLException;

    <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException;
		
		// ...çœç•¥éƒ¨åˆ†ä»£ç 

}
```

- update æ˜¯ Executor æ‰§è¡Œæ¥å£æ–°å¢çš„æ–¹æ³•ï¼Œåœ¨è¿™æ¬¡åŠŸèƒ½æ‰©å±•ä¸­ï¼ŒExecutor æ‰§è¡Œå™¨ä¹Ÿå°±åªå¢åŠ äº†è¿™ä¹ˆä¸€ä¸ª update æ–¹æ³•ã€‚å› ä¸ºå…¶ä»–ä¸¤ä¸ªæ–¹æ³• insertã€delete çš„è°ƒç”¨ï¼Œä¹Ÿéƒ½æ˜¯è°ƒç”¨ update å°±å¤Ÿäº†ï¼Œæ‰€ä»¥è¿™é‡Œ Mybatis å¹¶æ²¡æœ‰åœ¨æ‰§è¡Œå™¨ä¸­å®šä¹‰æ–°çš„æ–¹æ³•ã€‚

#### 3.3  updateæ¥å£å®ç°

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.SimpleExecutor`

```java
public class SimpleExecutor extends BaseExecutor {

    public SimpleExecutor(Configuration configuration, Transaction transaction) {
        super(configuration, transaction);
    }

    @Override
    protected int doUpdate(MappedStatement ms, Object parameter) throws SQLException {
        Statement stmt = null;
        try {
            Configuration configuration = ms.getConfiguration();
            // æ–°å»ºä¸€ä¸ª StatementHandler
            StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);
            // å‡†å¤‡è¯­å¥
            stmt = prepareStatement(handler);
            // StatementHandler.update
            return handler.update(stmt);
        } finally {
            closeStatement(stmt);
        }
    }

    @Override
    protected <E> List<E> doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
        Statement stmt = null;
        try {
            Configuration configuration = ms.getConfiguration();
            // æ–°å»ºä¸€ä¸ª StatementHandler
            StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, rowBounds, resultHandler, boundSql);
            // å‡†å¤‡è¯­å¥
            stmt = prepareStatement(handler);
            // è¿”å›ç»“æœ
            return handler.query(stmt, resultHandler);
        } finally {
            closeStatement(stmt);
        }
    }

}
```

- SimpleExecutor#doUpdate æ–¹æ³•æ˜¯ BaseExecutor æŠ½è±¡ç±»å®ç° Executor#update æ¥å£åï¼Œå®šä¹‰çš„æŠ½è±¡æ–¹æ³•ã€‚
- è¿™ä¸ªæŠ½è±¡æ–¹æ³•ä¸­ï¼Œå’Œ doQuery æ–¹æ³•å‡ ä¹ç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ StatementHandler è¯­å¥å¤„ç†å™¨ï¼Œä¹‹åå‡†å¤‡è¯­å¥ï¼Œæ‰§è¡Œå¤„ç†ã€‚
- ä½†è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒdoUpdate åˆ›å»º StatementHandler è¯­å¥å¤„ç†å™¨çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ resultHandlerã€boundSql ä¸¤ä¸ªå‚æ•°çš„ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯éœ€è¦å¯¹æœ‰å¿…è¦ä½¿ç”¨çš„ boundSql è¿›è¡Œåˆ¤æ–­å¤„ç†çš„ã€‚*è¿™éƒ¨åˆ†å†…å®¹ä¸»è¦ä½“ç°åœ¨ BaseStatementHandler çš„æ„é€ å‡½æ•°ä¸­ï¼Œå…³äº boundSql çš„åˆ¤æ–­å’Œå®ä¾‹åŒ–å¤„ç†*

#### 3.4 è¯­å¥å¤„ç†å™¨å®ç°

è¯­å¥å¤„ç†å™¨çš„å®ç°ï¼Œä¸»è¦å˜åŒ–åœ¨ BaseStatementHandler çš„æ„é€ å‡½æ•°ä¸­æ·»åŠ äº† boundSql çš„åˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼›

```java
public abstract class BaseStatementHandler implements StatementHandler {

		// ... çœç•¥éƒ¨åˆ†ä»£ç 
    protected BoundSql boundSql;

    public BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) {
      
        // æ–°å¢åˆ¤æ–­ï¼Œå› ä¸º update ä¸ä¼šä¼ å…¥ boundSql å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œè¦åšåˆå§‹åŒ–å¤„ç†
        if (boundSql == null) {
            boundSql = mappedStatement.getBoundSql(parameterObject);
        }

    }

}
```

å› ä¸ºåªæœ‰è·å–äº† BoundSql çš„å‚æ•°ï¼Œæ‰èƒ½æ–¹ä¾¿çš„æ‰§è¡Œåç»­å¯¹ SQL å¤„ç†çš„æ“ä½œã€‚æ‰€ä»¥åœ¨æ‰§è¡Œ update æ–¹æ³•ï¼Œæ²¡æœ‰ä¼ å…¥ BoundSql çš„æ—¶å€™ï¼Œåˆ™éœ€è¦è¿™é‡Œè¿›è¡Œåˆ¤æ–­ä»¥åŠè‡ªå·±è·å–çš„å¤„ç†æ“ä½œã€‚æ¥ä¸‹æ¥æ˜¯å¯¹æŠ½è±¡ç±»çš„å®ç°ï¼Œå…·ä½“çš„å¤„ç† update æ–¹æ³•ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.statement.PreparedStatementHandler`

```java
public class PreparedStatementHandler extends BaseStatementHandler{

    @Override
    public int update(Statement statement) throws SQLException {
        PreparedStatement ps = (PreparedStatement) statement;
        ps.execute();
        return ps.getUpdateCount();
    }

    @Override
    public <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException {
        PreparedStatement ps = (PreparedStatement) statement;
        ps.execute();
        return resultSetHandler.<E> handleResultSets(ps);
    }
    
    // ... çœç•¥éƒ¨åˆ†ä»£ç 

}
```

- åœ¨ PreparedStatementHandler é¢„å¤„ç†è¯­å¥å¤„ç†å™¨ä¸­ï¼Œå®ç°äº† update æ–¹æ³•ï¼Œç›¸å¯¹äº query æ–¹æ³•çš„å®ç°ï¼Œå…¶å®åªæ˜¯ç›¸å½“äº JDBC æ“ä½œæ•°æ®åº“è¿”å›ç»“æœé›†çš„å˜åŒ–ï¼Œupdate å¤„ç†è¦è¿”å› SQL çš„æ“ä½œå½±å“äº†å¤šå°‘æ¡æ•°æ®çš„æ•°é‡ã€‚

### 4. SqlSession å®šä¹‰å’Œå®ç°CRUDæ¥å£

åœ¨ SqlSession ä¸­éœ€è¦æ–°å¢å‡ºå¤„ç†æ•°æ®åº“çš„æ¥å£ï¼ŒåŒ…æ‹¬ï¼šselectListã€insertã€updateã€deleteï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹ä¸‹ DefaultSqlSession å¯¹ SqlSession æ¥å£æ–¹æ³•çš„å…·ä½“å®ç°ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.defaults.DefaultSqlSession`

```java
public class DefaultSqlSession implements SqlSession {

    private Logger logger = LoggerFactory.getLogger(DefaultSqlSession.class);

    private Configuration configuration;
    private Executor executor;

    public DefaultSqlSession(Configuration configuration, Executor executor) {
        this.configuration = configuration;
        this.executor = executor;
    }

    @Override
    public <T> T selectOne(String statement) {
        return this.selectOne(statement, null);
    }

    @Override
    public <T> T selectOne(String statement, Object parameter) {
        List<T> list = this.<T>selectList(statement, parameter);
        if (list.size() == 1) {
            return list.get(0);
        } else if (list.size() > 1) {
            throw new RuntimeException("Expected one result (or null) to be returned by selectOne(), but found: " + list.size());
        } else {
            return null;
        }
    }

    @Override
    public <E> List<E> selectList(String statement, Object parameter) {
        logger.info("æ‰§è¡ŒæŸ¥è¯¢ statementï¼š{} parameterï¼š{}", statement, JSON.toJSONString(parameter));
        MappedStatement ms = configuration.getMappedStatement(statement);
        try {
            return executor.query(ms, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, ms.getSqlSource().getBoundSql(parameter));
        } catch (SQLException e) {
            throw new RuntimeException("Error querying database.  Cause: " + e);
        }
    }

    @Override
    public int insert(String statement, Object parameter) {
        // åœ¨ Mybatis ä¸­ insert è°ƒç”¨çš„æ˜¯ update
        return update(statement, parameter);
    }

    @Override
    public int update(String statement, Object parameter) {
        MappedStatement ms = configuration.getMappedStatement(statement);
        try {
            return executor.update(ms, parameter);
        } catch (SQLException e) {
            throw new RuntimeException("Error updating database.  Cause: " + e);
        }
    }

    @Override
    public Object delete(String statement, Object parameter) {
        return update(statement, parameter);
    }
		
		// ... çœç•¥éƒ¨åˆ†ä»£ç 

}
```

- åœ¨ DefaultSqlSession çš„å…·ä½“å®ç°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œupdate æ–¹æ³•è°ƒç”¨äº†å…·ä½“çš„æ‰§è¡Œå™¨å°è£…æˆæ–¹æ³•ä»¥åï¼Œinsertã€delete éƒ½æ˜¯è°ƒç”¨çš„è¿™ä¸ª update æ–¹æ³•è¿›è¡Œæ“ä½œçš„ã€‚*æ¥å£å®šä¹‰çš„æ˜¯å•ä¸€æ‰§è¡Œï¼Œæ¥å£å®ç°æ˜¯åšäº†é€‚é…å°è£…*
- å¦å¤–è¿™é‡Œå•ç‹¬æä¾›äº† selectList æ–¹æ³•ï¼Œæ‰€ä»¥æŠŠä¹‹å‰åœ¨ selectOne å…³äº executor.query çš„æ‰§è¡Œå¤„ç†ï¼Œéƒ½è¿ç§»åˆ° selectList æ–¹æ³•ä¸­ã€‚ä¹‹ååœ¨ selectOne ä¸­è°ƒç”¨ selectList æ–¹æ³•ï¼Œå¹¶ç»™å‡ºç›¸åº”çš„åˆ¤æ–­å¤„ç†ã€‚

### 5. æ˜ å°„å™¨å‘½ä»¤æ‰§è¡Œè°ƒåº¦

ä»¥ä¸Šè¿™äº›æ‰€å®ç°çš„è¯­å¥æ‰§è¡Œå™¨ã€SqlSession åŒ…è£…ï¼Œæœ€ç»ˆéƒ½ä¼šäº¤ç»™ MapperMethod æ˜ å°„å™¨æ–¹æ³•æ ¹æ®ä¸åŒçš„ SQL å‘½ä»¤è°ƒç”¨ä¸åŒçš„ SqlSession æ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚

```java
public class MapperMethod {

    private final SqlCommand command;
    private final MethodSignature method;

    public MapperMethod(Class<?> mapperInterface, Method method, Configuration configuration) {
        this.command = new SqlCommand(configuration, mapperInterface, method);
        this.method = new MethodSignature(configuration, method);
    }

    public Object execute(SqlSession sqlSession, Object[] args) {
        Object result = null;
        switch (command.getType()) {
            case INSERT: {
                Object param = method.convertArgsToSqlCommandParam(args);
                result = sqlSession.insert(command.getName(), param);
                break;
            }
            case DELETE: {
                Object param = method.convertArgsToSqlCommandParam(args);
                result = sqlSession.delete(command.getName(), param);
                break;
            }
            case UPDATE: {
                Object param = method.convertArgsToSqlCommandParam(args);
                result = sqlSession.update(command.getName(), param);
                break;
            }
            case SELECT: {
                Object param = method.convertArgsToSqlCommandParam(args);
                if (method.returnsMany) {
                    result = sqlSession.selectList(command.getName(), param);
                } else {
                    result = sqlSession.selectOne(command.getName(), param);
                }
                break;
            }
            default:
                throw new RuntimeException("Unknown execution method for: " + command.getName());
        }
        return result;
    }

    // çœç•¥ SQLæŒ‡ä»¤å’Œæ–¹æ³•å‰é¢ä»£ç å—ï¼Œå¯ä»¥å‚è€ƒæºç 
}
```

- æ˜ å°„å™¨æ–¹æ³• MapperMethod#execute ä¼šæ ¹æ®ä¸åŒçš„ SqlCommand æŒ‡ä»¤è°ƒç”¨åˆ°ä¸åŒçš„æ–¹æ³•ä¸Šå»ï¼ŒINSERTã€DELETEã€UPDATE åˆ†åˆ«æŒ‰ç…§å¯¹åº”çš„æ–¹æ³•è°ƒç”¨å³å¯ã€‚è¿™é‡Œ SELECT è¿›è¡Œäº†æ‰©å±•ï¼Œå› ä¸ºéœ€è¦æŒ‰ç…§ä¸åŒçš„æ–¹æ³•å‡ºå‚ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯ selectListã€selectOne çš„åŒºåˆ«ã€‚
- å¦å¤–è¿™é‡Œ method.returnsMany æ¥è‡ªäº MapperMethod.MethodSignature æ–¹æ³•ç­¾åä¸­è¿›è¡Œé€šè¿‡ï¼Œè¿”å›ç±»å‹è¿›è¡Œè·å–çš„ï¼Œä»£ç å¦‚å›¾ 12-5 æ‰€ç¤ºã€‚

	![å›¾ 12-5 æ–¹æ³•ç­¾åè·å–æ–¹æ³•çš„è¿”å›å‚æ•°ç±»å‹](https://bugstack.cn/images/article/spring/mybatis-220610-05.png)

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

#### 1.1 åˆ›å»ºåº“è¡¨

åˆ›å»ºä¸€ä¸ªæ•°æ®åº“åç§°ä¸º mybatis å¹¶åœ¨åº“ä¸­åˆ›å»ºè¡¨ user ä»¥åŠæ·»åŠ æµ‹è¯•æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
CREATE TABLE
    USER
    (
        id bigint NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
        userId VARCHAR(9) COMMENT 'ç”¨æˆ·ID',
        userHead VARCHAR(16) COMMENT 'ç”¨æˆ·å¤´åƒ',
        createTime TIMESTAMP NULL COMMENT 'åˆ›å»ºæ—¶é—´',
        updateTime TIMESTAMP NULL COMMENT 'æ›´æ–°æ—¶é—´',
        userName VARCHAR(64),
        PRIMARY KEY (id)
    )
    ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
insert into user (id, userId, userHead, createTime, updateTime, userName) values (1, '10001', '1_04', '2022-04-13 00:00:00', '2022-04-13 00:00:00', 'å°å‚…å“¥');    
```

#### 1.2 é…ç½®æ•°æ®æº

```xml
<environments default="development">
    <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="POOLED">
            <property name="driver" value="com.mysql.jdbc.Driver"/>
            <property name="url" value="jdbc:mysql://127.0.0.1:3306/mybatis?useUnicode=true&characterEncoding=utf8"/>
            <property name="username" value="root"/>
            <property name="password" value="123456"/>
        </dataSource>
    </environment>
</environments>
```

- é€šè¿‡ `mybatis-config-datasource.xml` é…ç½®æ•°æ®æºä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šdriverã€urlã€usernameã€password
- åœ¨è¿™é‡Œ dataSource å¯ä»¥æŒ‰éœ€é…ç½®æˆ DRUIDã€UNPOOLED å’Œ POOLED è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚

#### 1.3 é…ç½®Mapper

```xml
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>

<select id="queryUserInfo" parameterType="cn.bugstack.mybatis.test.po.User" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id} and userId = #{userId}
</select>

<select id="queryUserInfoList" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
</select>

<update id="updateUserInfo" parameterType="cn.bugstack.mybatis.test.po.User">
    UPDATE user
    SET userName = #{userName}
    WHERE id = #{id}
</update>

<insert id="insertUserInfo" parameterType="cn.bugstack.mybatis.test.po.User">
   INSERT INTO user
   (userId, userName, userHead, createTime, updateTime)
   VALUES (#{userId}, #{userName}, #{userHead}, now(), now())
</insert>

<delete id="deleteUserInfoByUserId" parameterType="java.lang.String">
    DELETE FROM user WHERE userId = #{userId}
</delete>
```

- æœ¬ç« èŠ‚å·²ç»æŠŠ ORM æ¡†æ¶çš„åŸºæœ¬åŠŸèƒ½å…¨éƒ¨å¼€å‘å®Œæˆäº†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥åˆ†åˆ«é…ç½®æµ‹è¯•ä¸åŒç±»å‹çš„ SQL è¯­å¥ï¼ŒåŒ…æ‹¬ï¼šinsertã€deleteã€updateã€select

### 2. å•å…ƒæµ‹è¯•

**IUserDao** é…ç½®ç›¸åº”çš„æ–¹æ³•ï¼Œä¸ Mapper XML åŒ¹é…ã€‚

```java
public interface IUserDao {

    User queryUserInfoById(Long id);

    User queryUserInfo(User req);

    List<User> queryUserInfoList();

    int updateUserInfo(User req);

    void insertUserInfo(User req);

    int deleteUserInfoByUserId(String userId);

}
```

#### 2.1 æ’å…¥æµ‹è¯•

```java
@Test
public void test_insertUserInfo() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);

    // 2. æµ‹è¯•éªŒè¯
    User user = new User();
    user.setUserId("10002");
    user.setUserName("å°ç™½");
    user.setUserHead("1_05");
    userDao.insertUserInfo(user);
    logger.info("æµ‹è¯•ç»“æœï¼š{}", "Insert OK");

    // 3. æäº¤äº‹åŠ¡
    sqlSession.commit();
}
```

**æµ‹è¯•ç»“æœ**

```java
14:45:25.166 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"10002"
14:45:25.166 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"å°ç™½"
14:45:25.166 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"1_05"
14:45:25.171 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼šInsert OK

Process finished with exit code 0
```

![](https://bugstack.cn/images/article/spring/mybatis-220610-06.png)

- ä»æµ‹è¯•æ—¥å¿—ä¿¡æ¯å’Œæ•°æ®åº“çš„æˆªå›¾ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®å·²ç»æ’å…¥åˆ°æ•°æ®åº“ï¼ŒéªŒè¯é€šè¿‡ã€‚
- å¦å¤–è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬æ‰§è¡Œå®Œ SQL ä»¥åï¼Œè¿˜æ‰§è¡ŒåŠ›ä¸€æ¬¡ sqlSession.commit(); è¿™æ˜¯å› ä¸ºåœ¨ DefaultSqlSessionFactory#openSession å¼€å¯ Session åˆ›å»ºäº‹åŠ¡å·¥å‚çš„æ—¶å€™ï¼Œä¼ å…¥ç»™äº‹åŠ¡å·¥å‚æ„é€ å‡½æ•°çš„äº‹åŠ¡æ˜¯å¦è‡ªåŠ¨æäº¤ä¸º false æ‰€ä»¥è¿™é‡Œå°±éœ€è¦æˆ‘ä»¬è‡ªå·±å»æ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼Œå¦åˆ™æ˜¯ä¸ä¼šæ’å…¥åˆ°æ•°æ®åº“çš„ã€‚ä¸‹é¢å‡ ä¸ªæµ‹è¯•ä¹Ÿæ˜¯åŒæ ·çš„å¤„ç†æ–¹å¼ã€‚

#### 2.2 æŸ¥è¯¢æµ‹è¯•(å¤šæ¡æ•°æ®)

```java
@Test
public void test_queryUserInfoList() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    // 2. æµ‹è¯•éªŒè¯ï¼šå¯¹è±¡å‚æ•°
    List<User> users = userDao.queryUserInfoList();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(users));
}
```

**æµ‹è¯•ç»“æœ**

```java
14:50:19.063 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š[{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"},{"id":4,"userHead":"1_05","userId":"10002","userName":"å°ç™½"}]

Process finished with exit code 0
```

- ç°åœ¨æˆ‘ä»¬å†æŸ¥è¯¢ç»“æœçš„æ—¶å€™ï¼Œå°±å¯ä»¥æŸ¥è¯¢åˆ°2æ¡è®°å½•çš„é›†åˆäº†ï¼Œè¿™è¯´æ˜æˆ‘ä»¬æ·»åŠ çš„ MapperMethod#execute è°ƒç”¨ `sqlSession.selectList(command.getName(), param);` æ˜¯æµ‹è¯•é€šè¿‡çš„ã€‚è¯»è€…ä¼™ä¼´ä¹Ÿå¯ä»¥æ ¹æ®è¿™ä¸ªæµ‹è¯•çš„ä»£ç ï¼Œè¿›è¡Œæ–­æ‰è°ƒè¯•ã€‚

#### 2.3 ä¿®æ”¹æµ‹è¯•

```java
@Test
public void test_updateUserInfo() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    // 2. æµ‹è¯•éªŒè¯
    int count = userDao.updateUserInfo(new User(1L, "10001", "å®å½“çŒ«"));
    logger.info("æµ‹è¯•ç»“æœï¼š{}", count);
    // 3. æäº¤äº‹åŠ¡
    sqlSession.commit();
}
```

**æµ‹è¯•ç»“æœ**

```java
14:52:09.550 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"å®å½“çŒ«"
14:52:09.550 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š1
14:52:09.553 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š1
```

![](https://bugstack.cn/images/article/spring/mybatis-220610-07.png)

- è¿™é‡Œæµ‹è¯•éªŒè¯æŠŠID=1çš„ç”¨æˆ·ï¼ŒuserName ä¿®æ”¹ä¸º å®å½“çŒ«ï¼Œé€šè¿‡æµ‹è¯•æ—¥å¿—å’Œæ•°æ®åº“æˆªå›¾ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæµ‹è¯•å·²ç»é€šè¿‡ã€‚

#### 2.4 åˆ é™¤æµ‹è¯•

```java
@Test
public void test_deleteUserInfoByUserId() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    // 2. æµ‹è¯•éªŒè¯
    int count = userDao.deleteUserInfoByUserId("10002");
    logger.info("æµ‹è¯•ç»“æœï¼š{}", count == 1);
    // 3. æäº¤äº‹åŠ¡
    sqlSession.commit();
}
```

**æµ‹è¯•ç»“æœ**

```java
14:57:39.536 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"10002"
14:57:39.539 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼štrue

Process finished with exit code 0
```

![](https://bugstack.cn/images/article/spring/mybatis-220610-08.png)

- è¿™é‡Œæˆ‘ä»¬æŠŠæ•°æ®åº“è¡¨ä¸­ userId = â€œ10002â€ çš„ç”¨æˆ·åˆ é™¤æ‰ï¼Œé€šè¿‡æµ‹è¯•æ—¥å¿—å’Œæ•°æ®åº“æˆªå›¾ï¼Œå¯ä»¥çœ‹å‡ºæµ‹è¯•é€šè¿‡ã€‚

## å…­ã€æ€»ç»“

- åˆ°æœ¬ç« èŠ‚æˆ‘ä»¬å°±æŠŠ Mybatis çš„å…¨éƒ¨ä¸»å¹²æµç¨‹ä¸²è”å®ç°å®Œæˆäº†ï¼Œå¯ä»¥æ‰§è¡Œå¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè¯»è€…ä¼™ä¼´ä¹Ÿå¯ä»¥å‘ç°ï¼Œæœ¬ç« èŠ‚åœ¨åŸæœ‰çš„å†…å®¹ä¸‹ï¼Œè¿›è¡Œæ‰©å±•çš„æ—¶å€™ä¹Ÿæ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œç”šè‡³ä¸è¦å¤šå¤§çš„ä»£ç æ”¹åŠ¨ã€‚è¿™ä¸»è¦ä¹Ÿå¾—ç›Šäºæ¡†æ¶åœ¨è®¾è®¡å®ç°è¿‡ç¨‹ä¸­ï¼Œåˆç†è¿ç”¨è®¾è®¡åŸåˆ™å’Œè®¾è®¡æ¨¡å¼çš„å¥½å¤„ã€‚
- è¯»è€…åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è°ƒè¯•æºç ä¸­çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚åƒäº‹åŠ¡æ˜¯å¦è‡ªåŠ¨æäº¤ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„å‚æ•°æ˜¯å¦å¯ä»¥æ·»åŠ å…¶ä»–ç±»å‹ï¼Œåœ¨å¢åˆ æ”¹æŸ¥ä¸­ï¼Œæ˜¯å¦è¿˜æœ‰å…¶ä»–æƒ…å†µçš„å¤„ç†ã€‚è¿™äº›å°çš„åŠŸèƒ½ç‚¹ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ·»åŠ ç»ƒä¹ ï¼Œå¦‚æœä½ èƒ½æ­£ç¡®çš„æ·»åŠ å¹¶èµ°å®Œæµç¨‹éªŒè¯å…¬å›½ï¼Œé‚£ä¹ˆè¯´æ˜ä½ æ˜¯çœŸçš„å­¦ä¹ ä¼šäº†ã€‚
- åœ¨æœ¬ç« èŠ‚å…¨éƒ¨åŸºç¡€åŠŸèƒ½é“¾è·¯ä¸²è”å®Œæ¯•ä»¥åï¼Œå…³äº Mybatis çš„æ¡†æ¶ä¸­ï¼Œè¿˜æœ‰ä¸€äº›é¢å¤–æ‰©å±•çš„çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚ï¼šæ’å…¥æ—¶è¿”å›å½“å‰IDã€Map ç±»å‹æ˜ å°„ã€ä¸€çº§äºŒçº§ç¼“å­˜ã€æ’ä»¶æ¨¡å—ç­‰ï¼Œåç»­çš„ç« èŠ‚ä¸­æˆ‘ä»¬ä¼šæ‰¾ä¸€äº›æœ‰ä»£è¡¨æ€§çš„å†…å®¹ï¼Œè¿›è¡Œæ‰©å±•å¼€å‘å­¦ä¹ ã€‚è¯»è€…ä¼™ä¼´ä¹Ÿå¯ä»¥æŒ‰ç…§ç›®å‰çš„æ¡†æ¶ç»“æ„ï¼Œè‡ªè¡Œæ·»åŠ è¿™å†™æ¨¡å—è¿›è¡Œç»ƒä¹ å­¦ä¹ ã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [ä¸²è”ç°åœ¨æ‰€æœ‰çš„ä¸»å¹²æµç¨‹ @æ¨æ¨å¾—äº¿ğŸ™‰](https://t.zsxq.com/07MVb6aqz)
- [åŸºäºå‰é¢å„ç« èŠ‚çš„è§£æMAPPER_XMLã€å¤„ç†å‚æ•°ã€å°è£…ç»“æœï¼Œå¢åŠ insertã€updateã€deleteä»¥åŠselectè¿”å›é›†åˆçš„æ“ä½œ @liuc](https://t.zsxq.com/09u8LJtrZ)
- [å®Œå–„ORMæ¡†æ¶ï¼Œå¢åˆ æ”¹æŸ¥æ“ä½œ @ADé’™å¥¶](https://t.zsxq.com/11hc2GWF4)