---
title: ç¬¬7ç« ï¼šSQLæ‰§è¡Œå™¨çš„å®šä¹‰å’Œå®ç°
lock: need
---

# ã€ŠMybatis æ‰‹æ’¸ä¸“æ ã€‹ç¬¬7ç« ï¼šSQLæ‰§è¡Œå™¨çš„å®šä¹‰å’Œå®ç°

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/MJYKOn0-jhnGurcbDxgWtA](https://mp.weixin.qq.com/s/MJYKOn0-jhnGurcbDxgWtA)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=513680657&bvid=BV1ig411Z7k9&cid=781884068&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`ä¸ºä»€ä¹ˆï¼Œè¦è¯»æ¡†æ¶æºç ï¼Ÿ`

å› ä¸ºæ‰‹é‡Œçš„ä¸šåŠ¡å·¥ç¨‹ä»£ç å¤ªæ‹‰èƒ¯äº†ï¼é€šå¸¸ä½œä¸ºä¸šåŠ¡ç ”å‘ï¼Œæ‰€å¼€å‘å‡ºæ¥çš„ä»£ç ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€è¿ä¸²çš„æµç¨‹åŒ–å¤„ç†ï¼Œç¼ºå°‘åŠŸèƒ½é€»è¾‘çš„è§£è€¦ï¼Œæœ‰ç€è¿­ä»£é¢‘ç¹ä½†å¯è¿­ä»£æ€§å·®çš„ç‰¹ç‚¹ã€‚æ‰€ä»¥è¿™æ ·çš„ä»£ç é€šå¸¸åªèƒ½å­¦ä¹ ä¸šåŠ¡é€»è¾‘ï¼Œå´å¾ˆéš¾å¸æ”¶åˆ°å¤§å‹ç³»ç»Ÿè®¾è®¡å’ŒåŠŸèƒ½é€»è¾‘å®ç°çš„æˆåŠŸç»éªŒï¼Œå¾€å¾€éƒ½æ˜¯å¤±è´¥çš„æ•™è®­ã€‚

è€Œæ‰€æœ‰ç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°ï¼Œæ ¸å¿ƒéƒ½åœ¨äºå¦‚ä½•è§£è€¦ï¼Œå¦‚æœè§£è€¦ä¸æ¸…æ™°æœ€åç›´æ¥å¯¼è‡´çš„å°±æ˜¯å†ç»§ç»­è¿­ä»£åŠŸèƒ½æ—¶ï¼Œä¼šè®©æ•´ä¸ªç³»ç»Ÿçš„å®ç°è¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œç¨³å®šæ€§è¶Šæ¥è¶Šå·®ã€‚è€Œå…³äºè§£è€¦çš„å®è·µåœ¨å„ç±»æ¡†æ¶çš„æºç ä¸­éƒ½æœ‰éå¸¸ä¸é”™çš„è®¾è®¡å®ç°ï¼Œæ‰€ä»¥é˜…è¯»è¿™éƒ¨åˆ†æºç ï¼Œå°±æ˜¯åœ¨å¸æ”¶æˆåŠŸçš„ç»éªŒã€‚æŠŠè§£è€¦çš„æ€æƒ³é€æ­¥è¿ç”¨åˆ°å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæ‰ä¼šè®©æˆ‘ä»¬å†™å‡ºæ›´åŠ ä¼˜ç§€çš„ä»£ç ç»“æ„ã€‚

## äºŒã€ç›®æ ‡

åœ¨ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬å®ç°äº†æœ‰/æ— è¿æ¥æ± çš„æ•°æ®æºï¼Œå¯ä»¥åœ¨è°ƒç”¨æ‰§è¡ŒSQLçš„æ—¶å€™ï¼Œé€šè¿‡æˆ‘ä»¬å®ç°æ± åŒ–æŠ€æœ¯å®Œæˆæ•°æ®åº“çš„æ“ä½œã€‚

é‚£ä¹ˆå…³äºæ± åŒ–æ•°æ®æºçš„è°ƒç”¨ã€æ‰§è¡Œå’Œç»“æœå°è£…ï¼Œç›®å‰æˆ‘ä»¬è¿˜éƒ½åªæ˜¯åœ¨ DefaultSqlSession ä¸­è¿›è¡Œå‘èµ· å¦‚å›¾ 7-1 æ‰€ç¤ºã€‚é‚£ä¹ˆè¿™æ ·çš„æŠŠä»£ç æµç¨‹å†™æ­»çš„æ–¹å¼è‚¯å®šä¸åˆé€‚äºæˆ‘ä»¬æ‰©å±•ä½¿ç”¨ï¼Œä¹Ÿä¸åˆ©äº SqlSession ä¸­æ¯ä¸€ä¸ªæ–°å¢å®šä¹‰çš„æ–¹æ³•å¯¹æ± åŒ–æ•°æ®æºçš„è°ƒç”¨ã€‚

![å›¾ 7-1 DefaultSqlSession è°ƒç”¨æ•°æ®æº](https://bugstack.cn/images/article/spring/mybatis-220428-01.png)

- è§£è€¦ DefaultSqlSession#selectOne æ–¹æ³•ä¸­å…³äºå¯¹æ•°æ®æºçš„è°ƒç”¨ã€æ‰§è¡Œå’Œç»“æœå°è£…ï¼Œæä¾›æ–°çš„åŠŸèƒ½æ¨¡å—æ›¿ä»£è¿™éƒ¨åˆ†ç¡¬ç¼–ç çš„é€»è¾‘å¤„ç†ã€‚
- åªæœ‰æä¾›äº†å•ç‹¬çš„æ‰§è¡Œæ–¹æ³•å…¥å£ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å¥½çš„æ‰©å±•å’Œåº”å¯¹è¿™éƒ¨åˆ†å†…å®¹é‡Œçš„éœ€æ±‚å˜åŒ–ï¼ŒåŒ…æ‹¬äº†å„ç±»å…¥å‚ã€ç»“æœå°è£…ã€æ‰§è¡Œå™¨ç±»å‹ã€æ‰¹å¤„ç†ç­‰ï¼Œæ¥æ»¡è¶³ä¸åŒæ ·å¼çš„ç”¨æˆ·éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯é…ç½®åˆ° Mapper.xml ä¸­çš„å…·ä½“ä¿¡æ¯ã€‚

## ä¸‰ã€è®¾è®¡

ä»æˆ‘ä»¬å¯¹ ORM æ¡†æ¶æ¸è¿›å¼çš„å¼€å‘è¿‡ç¨‹ä¸Šï¼Œå¯ä»¥åˆ†å‡ºçš„æ‰§è¡ŒåŠ¨ä½œåŒ…æ‹¬ï¼Œè§£æé…ç½®ã€ä»£ç†å¯¹è±¡ã€æ˜ å°„æ–¹æ³•ç­‰ï¼Œç›´è‡³æˆ‘ä»¬å‰é¢ç« èŠ‚å¯¹æ•°æ®æºçš„åŒ…è£…å’Œä½¿ç”¨ï¼Œåªä¸è¿‡æˆ‘ä»¬æŠŠæ•°æ®æºçš„æ“ä½œç¡¬æ†ç»‘åˆ°äº† DefaultSqlSession çš„æ‰§è¡Œæ–¹æ³•ä¸Šäº†ã€‚

é‚£ä¹ˆç°åœ¨ä¸ºäº†è§£è€¦è¿™å—çš„å¤„ç†ï¼Œåˆ™éœ€è¦å•ç‹¬æå‡ºä¸€å—æ‰§è¡Œå™¨çš„æœåŠ¡åŠŸèƒ½ï¼Œä¹‹åå°†æ‰§è¡Œå™¨çš„åŠŸèƒ½éšç€ DefaultSqlSession åˆ›å»ºæ—¶ä¼ å…¥æ‰§è¡Œå™¨åŠŸèƒ½ï¼Œä¹‹åå…·ä½“çš„æ–¹æ³•è°ƒç”¨å°±å¯ä»¥è°ƒç”¨æ‰§è¡Œå™¨æ¥å¤„ç†äº†ï¼Œä»è€Œè§£è€¦è¿™éƒ¨åˆ†åŠŸèƒ½æ¨¡å—ã€‚å¦‚å›¾ 7-2 æ‰€ç¤ºã€‚

![å›¾ 7-2 å¼•å…¥æ‰§è¡Œå™¨è§£è€¦è®¾è®¡](https://bugstack.cn/images/article/spring/mybatis-220428-02.png)

- é¦–å…ˆæˆ‘ä»¬è¦æå–å‡ºæ‰§è¡Œå™¨çš„æ¥å£ï¼Œå®šä¹‰å‡ºæ‰§è¡Œæ–¹æ³•ã€äº‹åŠ¡è·å–å’Œç›¸åº”æäº¤ã€å›æ»šã€å…³é—­çš„å®šä¹‰ï¼ŒåŒæ—¶ç”±äºæ‰§è¡Œå™¨æ˜¯ä¸€ç§æ ‡å‡†çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ç”±æŠ½è±¡ç±»è¿›è¡Œå®ç°ï¼Œå¯¹è¿‡ç¨‹å†…å®¹è¿›è¡Œæ¨¡æ¿æ¨¡å¼çš„è¿‡ç¨‹åŒ…è£…ã€‚åœ¨åŒ…è£…è¿‡ç¨‹ä¸­å®šä¹‰æŠ½è±¡ç±»ï¼Œç”±å…·ä½“çš„å­ç±»æ¥å®ç°ã€‚è¿™ä¸€éƒ¨åˆ†åœ¨ä¸‹æ–‡çš„ä»£ç ä¸­ä¼šä½“ç°åˆ° `SimpleExecutor` ç®€å•æ‰§è¡Œå™¨å®ç°ä¸­ã€‚
- ä¹‹åæ˜¯å¯¹ SQL çš„å¤„ç†ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“åœ¨ä½¿ç”¨ JDBC æ‰§è¡Œ SQL çš„æ—¶å€™ï¼Œåˆ†ä¸ºäº†ç®€å•å¤„ç†å’Œé¢„å¤„ç†ï¼Œé¢„å¤„ç†ä¸­åŒ…æ‹¬å‡†å¤‡è¯­å¥ã€å‚æ•°åŒ–ä¼ é€’ã€æ‰§è¡ŒæŸ¥è¯¢ï¼Œä»¥åŠæœ€åçš„ç»“æœå°è£…å’Œè¿”å›ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹Ÿéœ€è¦æŠŠ JDBC è¿™éƒ¨åˆ†çš„æ­¥éª¤ï¼Œåˆ†ä¸ºç»“æ„åŒ–çš„ç±»è¿‡ç¨‹æ¥å®ç°ï¼Œä¾¿äºåŠŸèƒ½çš„æ‹“å±•ã€‚å…·ä½“ä»£ç ä¸»è¦ä½“ç°åœ¨è¯­å¥å¤„ç†å™¨ `StatementHandler` çš„æ¥å£å®ç°ä¸­ã€‚

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
mybatis-step-06
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”‚   â”œâ”€â”€ MapperMethod.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java
    â”‚           â”‚   â””â”€â”€ MapperRegistry.java
    â”‚           â”œâ”€â”€ builder
    â”‚           â”œâ”€â”€ datasource
    â”‚           â”œâ”€â”€ executor
    â”‚           â”‚   â”œâ”€â”€ resultset
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultResultSetHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ ResultSetHandler.java
    â”‚           â”‚   â”œâ”€â”€ statement
    â”‚           â”‚   â”‚   â”œâ”€â”€ BaseStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ PreparedStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ SimpleStatementHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ StatementHandler.java
    â”‚           â”‚   â”œâ”€â”€ BaseExecutor.java
    â”‚           â”‚   â”œâ”€â”€ Executor.java
    â”‚           â”‚   â””â”€â”€ SimpleExecutor.java
    â”‚           â”œâ”€â”€ io
    â”‚           â”œâ”€â”€ mapping
    â”‚           â”œâ”€â”€ session
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSqlSession.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Configuration.java
    â”‚           â”‚   â”œâ”€â”€ ResultHandler.java
    â”‚           â”‚   â”œâ”€â”€ SqlSession.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactoryBuilder.java
    â”‚           â”‚   â””â”€â”€ TransactionIsolationLevel.java
    â”‚           â”œâ”€â”€ transaction
    â”‚           â””â”€â”€ type
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ cn.bugstack.mybatis.test.dao
        â”‚       â”œâ”€â”€ dao
        â”‚       â”‚   â””â”€â”€ IUserDao.java
        â”‚       â”œâ”€â”€ po
        â”‚       â”‚   â””â”€â”€ User.java
        â”‚       â””â”€â”€ ApiTest.java
        â””â”€â”€ resources
            â”œâ”€â”€ mapper
            â”‚   â””â”€â”€User_Mapper.xml
            â””â”€â”€ mybatis-config-datasource.xml
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šæ‰‹å†™Mybatisï¼Œè·å–å®Œæ•´æºç `

SQLæ–¹æ³•æ‰§è¡Œå™¨æ ¸å¿ƒç±»å…³ç³»ï¼Œå¦‚å›¾ 7-3 æ‰€ç¤º

![å›¾ 7-3 SQLæ–¹æ³•æ‰§è¡Œå™¨æ ¸å¿ƒç±»å…³ç³»](https://bugstack.cn/images/article/spring/mybatis-220428-03.png)

- ä»¥ Executor æ¥å£å®šä¹‰ä¸ºæ‰§è¡Œå™¨å…¥å£ï¼Œç¡®å®šå‡ºäº‹åŠ¡å’Œæ“ä½œå’Œ SQL æ‰§è¡Œçš„ç»Ÿä¸€æ ‡å‡†æ¥å£ã€‚å¹¶ä»¥æ‰§è¡Œå™¨æ¥å£å®šä¹‰å®ç°æŠ½è±¡ç±»ï¼Œä¹Ÿå°±æ˜¯ç”¨æŠ½è±¡ç±»å¤„ç†ç»Ÿä¸€å…±ç”¨çš„äº‹åŠ¡å’Œæ‰§è¡ŒSQLçš„æ ‡å‡†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå®šä¹‰çš„æ‰§è¡Œ SQL çš„æŠ½è±¡æ¥å£ç”±å­ç±»å®ç°ã€‚
- åœ¨å…·ä½“çš„ç®€å• SQL æ‰§è¡Œå™¨å®ç°ç±»ä¸­ï¼Œå¤„ç† doQuery æ–¹æ³•çš„å…·ä½“æ“ä½œè¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­åˆ™ä¼šå¼•å…¥è¿›æ¥ SQL è¯­å¥å¤„ç†å™¨çš„åˆ›å»ºï¼Œåˆ›å»ºè¿‡ç¨‹ä»æœ‰ configuration é…ç½®é¡¹æä¾›ã€‚*ä½ ä¼šå‘ç°å¾ˆå¤šè¿™æ ·çš„ç”Ÿæˆå¤„ç†ï¼Œéƒ½æ¥è‡ªäºé…ç½®é¡¹*
- å½“æ‰§è¡Œå™¨å¼€å‘å®Œæˆä»¥åï¼Œæ¥ä¸‹æ¥å°±æ˜¯äº¤ç»™ DefaultSqlSessionFactory å¼€å¯ openSession çš„æ—¶å€™éšç€æ„é€ å‡½æ•°å‚æ•°ä¼ é€’ç»™ DefaultSqlSession ä¸­ï¼Œè¿™æ ·åœ¨æ‰§è¡Œ DefaultSqlSession#selectOne çš„æ—¶å€™å°±å¯ä»¥è°ƒç”¨æ‰§è¡Œå™¨è¿›è¡Œå¤„ç†äº†ã€‚ä¹Ÿå°±ç”±æ­¤å®Œæˆè§£è€¦æ“ä½œäº†ã€‚

### 2. æ‰§è¡Œå™¨çš„å®šä¹‰å’Œå®ç°

æ‰§è¡Œå™¨åˆ†ä¸ºæ¥å£ã€æŠ½è±¡ç±»ã€ç®€å•æ‰§è¡Œå™¨å®ç°ç±»ä¸‰éƒ¨åˆ†ï¼Œé€šå¸¸åœ¨æ¡†æ¶çš„æºç ä¸­å¯¹äºä¸€äº›æ ‡å‡†æµç¨‹çš„å¤„ç†ï¼Œéƒ½ä¼šæœ‰æŠ½è±¡ç±»çš„å­˜åœ¨ã€‚å®ƒè´Ÿè´£æä¾›å…±æ€§åŠŸèƒ½é€»è¾‘ï¼Œä»¥åŠå¯¹æ¥å£æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œå®šä¹‰å’Œå¤„ç†ï¼Œå¹¶æå–æŠ½è±¡æ¥å£äº¤ç”±å­ç±»å®ç°ã€‚è¿™ç§è®¾è®¡æ¨¡å¼ä¹Ÿè¢«å®šä¹‰ä¸ºæ¨¡æ¿æ¨¡å¼ã€‚

#### 2.1 Executor

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.Executor`

```java
public interface Executor {

    ResultHandler NO_RESULT_HANDLER = null;

    <E> List<E> query(MappedStatement ms, Object parameter, ResultHandler resultHandler, BoundSql boundSql);

    Transaction getTransaction();

    void commit(boolean required) throws SQLException;

    void rollback(boolean required) throws SQLException;

    void close(boolean forceRollback);

}
```

- åœ¨æ‰§è¡Œå™¨ä¸­å®šä¹‰çš„æ¥å£åŒ…æ‹¬äº‹åŠ¡ç›¸å…³çš„å¤„ç†æ–¹æ³•å’Œæ‰§è¡ŒSQLæŸ¥è¯¢çš„æ“ä½œï¼Œéšç€åç»­åŠŸèƒ½çš„è¿­ä»£è¿˜ä¼šç»§ç»­è¡¥å……å…¶ä»–çš„æ–¹æ³•ã€‚

#### 2.2 BaseExecutor æŠ½è±¡åŸºç±»

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.BaseExecutor`

```java
public abstract class BaseExecutor implements Executor {

    protected Configuration configuration;
    protected Transaction transaction;
    protected Executor wrapper;

    private boolean closed;

    protected BaseExecutor(Configuration configuration, Transaction transaction) {
        this.configuration = configuration;
        this.transaction = transaction;
        this.wrapper = this;
    }

    @Override
    public <E> List<E> query(MappedStatement ms, Object parameter, ResultHandler resultHandler, BoundSql boundSql) {
        if (closed) {
            throw new RuntimeException("Executor was closed.");
        }
        return doQuery(ms, parameter, resultHandler, boundSql);
    }

    protected abstract <E> List<E> doQuery(MappedStatement ms, Object parameter, ResultHandler resultHandler, BoundSql boundSql);

    @Override
    public void commit(boolean required) throws SQLException {
        if (closed) {
            throw new RuntimeException("Cannot commit, transaction is already closed");
        }
        if (required) {
            transaction.commit();
        }
    }

}
```

- åœ¨æŠ½è±¡åŸºç±»ä¸­å°è£…äº†æ‰§è¡Œå™¨çš„å…¨éƒ¨æ¥å£ï¼Œè¿™æ ·å…·ä½“çš„å­ç±»ç»§æ‰¿æŠ½è±¡ç±»åï¼Œå°±ä¸ç”¨åœ¨å¤„ç†è¿™äº›å…±æ€§çš„æ–¹æ³•ã€‚ä¸æ­¤åŒæ—¶åœ¨ query æŸ¥è¯¢æ–¹æ³•ä¸­ï¼Œå°è£…ä¸€äº›å¿…è¦çš„æµç¨‹å¤„ç†ï¼Œå¦‚æœæ£€æµ‹å…³é—­ç­‰ï¼Œåœ¨ Mybatis æºç ä¸­è¿˜æœ‰ä¸€äº›ç¼“å­˜çš„æ“ä½œï¼Œè¿™é‡Œæš‚æ—¶å‰”é™¤æ‰ï¼Œä»¥æ ¸å¿ƒæµç¨‹ä¸ºä¸»ã€‚è¯»è€…ä¼™ä¼´åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å¯ä»¥ä¸æºç è¿›è¡Œå¯¹ç…§å­¦ä¹ ã€‚

#### 2.3 SimpleExecutor ç®€å•æ‰§è¡Œå™¨å®ç°

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.SimpleExecutor`

```java
public class SimpleExecutor extends BaseExecutor {

    public SimpleExecutor(Configuration configuration, Transaction transaction) {
        super(configuration, transaction);
    }

    @Override
    protected <E> List<E> doQuery(MappedStatement ms, Object parameter, ResultHandler resultHandler, BoundSql boundSql) {
        try {
            Configuration configuration = ms.getConfiguration();
            StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, resultHandler, boundSql);
            Connection connection = transaction.getConnection();
            Statement stmt = handler.prepare(connection);
            handler.parameterize(stmt);
            return handler.query(stmt, resultHandler);
        } catch (SQLException e) {
            e.printStackTrace();
            return null;
        }
    }

}
```

- ç®€å•æ‰§è¡Œå™¨ SimpleExecutor ç»§æ‰¿æŠ½è±¡åŸºç±»ï¼Œå®ç°æŠ½è±¡æ–¹æ³• doQueryï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­åŒ…è£…æ•°æ®æºçš„è·å–ã€è¯­å¥å¤„ç†å™¨çš„åˆ›å»ºï¼Œä»¥åŠå¯¹ Statement çš„å®ä¾‹åŒ–å’Œç›¸å…³å‚æ•°è®¾ç½®ã€‚æœ€åæ‰§è¡Œ SQL çš„å¤„ç†å’Œç»“æœçš„è¿”å›æ“ä½œã€‚
- å…³äº StatementHandler è¯­å¥å¤„ç†å™¨çš„å®ç°ï¼Œæ¥ä¸‹æ¥ä»‹ç»ã€‚

### 3. è¯­å¥å¤„ç†å™¨

è¯­å¥å¤„ç†å™¨æ˜¯ SQL æ‰§è¡Œå™¨ä¸­ä¾èµ–çš„éƒ¨åˆ†ï¼ŒSQL æ‰§è¡Œå™¨å°è£…äº‹åŠ¡ã€è¿æ¥å’Œæ£€æµ‹ç¯å¢ƒç­‰ï¼Œè€Œè¯­å¥å¤„ç†å™¨åˆ™æ˜¯å‡†å¤‡è¯­å¥ã€å‚æ•°åŒ–ä¼ é€’ã€æ‰§è¡Œ SQLã€å°è£…ç»“æœçš„å¤„ç†ã€‚

#### 3.1 StatementHandler

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.statement.StatementHandler`

```java
public interface StatementHandler {

    /** å‡†å¤‡è¯­å¥ */
    Statement prepare(Connection connection) throws SQLException;

    /** å‚æ•°åŒ– */
    void parameterize(Statement statement) throws SQLException;

    /** æ‰§è¡ŒæŸ¥è¯¢ */
    <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException;

}
```

- è¯­å¥å¤„ç†å™¨çš„æ ¸å¿ƒåŒ…æ‹¬äº†ï¼›å‡†å¤‡è¯­å¥ã€å‚æ•°åŒ–ä¼ é€’å‚æ•°ã€æ‰§è¡ŒæŸ¥è¯¢çš„æ“ä½œï¼Œè¿™é‡Œå¯¹åº”çš„ Mybatis æºç ä¸­è¿˜åŒ…æ‹¬äº† updateã€æ‰¹å¤„ç†ã€è·å–å‚æ•°å¤„ç†å™¨ç­‰ã€‚

#### 3.2 BaseStatementHandler æŠ½è±¡åŸºç±»

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.statement.BaseStatementHandler`

```java
public abstract class BaseStatementHandler implements StatementHandler {

    protected final Configuration configuration;
    protected final Executor executor;
    protected final MappedStatement mappedStatement;

    protected final Object parameterObject;
    protected final ResultSetHandler resultSetHandler;

    protected BoundSql boundSql;

    public BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, ResultHandler resultHandler, BoundSql boundSql) {
        this.configuration = mappedStatement.getConfiguration();
        this.executor = executor;
        this.mappedStatement = mappedStatement;
        this.boundSql = boundSql;
				
				// å‚æ•°å’Œç»“æœé›†
        this.parameterObject = parameterObject;
        this.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, boundSql);
    }

    @Override
    public Statement prepare(Connection connection) throws SQLException {
        Statement statement = null;
        try {
            // å®ä¾‹åŒ– Statement
            statement = instantiateStatement(connection);
            // å‚æ•°è®¾ç½®ï¼Œå¯ä»¥è¢«æŠ½å–ï¼Œæä¾›é…ç½®
            statement.setQueryTimeout(350);
            statement.setFetchSize(10000);
            return statement;
        } catch (Exception e) {
            throw new RuntimeException("Error preparing statement.  Cause: " + e, e);
        }
    }

    protected abstract Statement instantiateStatement(Connection connection) throws SQLException;

}
```

- åœ¨è¯­å¥å¤„ç†å™¨åŸºç±»ä¸­ï¼Œå°†å‚æ•°ä¿¡æ¯ã€ç»“æœä¿¡æ¯è¿›è¡Œå°è£…å¤„ç†ã€‚ä¸è¿‡æš‚æ—¶è¿™é‡Œæˆ‘ä»¬è¿˜ä¸ä¼šåšè¿‡å¤šçš„å‚æ•°å¤„ç†ï¼ŒåŒ…æ‹¬JDBCå­—æ®µç±»å‹è½¬æ¢ç­‰ã€‚è¿™éƒ¨åˆ†å†…å®¹éšç€æˆ‘ä»¬æ•´ä¸ªæ‰§è¡Œå™¨çš„ç»“æ„å»ºè®¾å®Œæ¯•åï¼Œå†è¿›è¡Œè¿­ä»£å¼€å‘ã€‚
- ä¹‹åæ˜¯å¯¹ BaseStatementHandler#prepare æ–¹æ³•çš„å¤„ç†ï¼ŒåŒ…æ‹¬å®šä¹‰å®ä¾‹åŒ–æŠ½è±¡æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•äº¤ç”±å„ä¸ªå…·ä½“çš„å®ç°å­ç±»è¿›è¡Œå¤„ç†ã€‚åŒ…æ‹¬ï¼›SimpleStatementHandler ç®€å•è¯­å¥å¤„ç†å™¨å’Œ PreparedStatementHandler é¢„å¤„ç†è¯­å¥å¤„ç†å™¨ã€‚
  - ç®€å•è¯­å¥å¤„ç†å™¨åªæ˜¯å¯¹ SQL çš„æœ€åŸºæœ¬æ‰§è¡Œï¼Œæ²¡æœ‰å‚æ•°çš„è®¾ç½®ã€‚
  - é¢„å¤„ç†è¯­å¥å¤„ç†å™¨åˆ™æ˜¯æˆ‘ä»¬åœ¨ JDBC ä¸­ä½¿ç”¨çš„æœ€å¤šçš„æ“ä½œæ–¹å¼ï¼ŒPreparedStatement è®¾ç½® SQLï¼Œä¼ é€’å‚æ•°çš„è®¾ç½®è¿‡ç¨‹ã€‚

#### 3.3 PreparedStatementHandler é¢„å¤„ç†è¯­å¥å¤„ç†å™¨

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.statement.PreparedStatementHandler`

```java
public class PreparedStatementHandler extends BaseStatementHandler{

    @Override
    protected Statement instantiateStatement(Connection connection) throws SQLException {
        String sql = boundSql.getSql();
        return connection.prepareStatement(sql);
    }

    @Override
    public void parameterize(Statement statement) throws SQLException {
        PreparedStatement ps = (PreparedStatement) statement;
        ps.setLong(1, Long.parseLong(((Object[]) parameterObject)[0].toString()));
    }

    @Override
    public <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException {
        PreparedStatement ps = (PreparedStatement) statement;
        ps.execute();
        return resultSetHandler.<E> handleResultSets(ps);
    }

}
```

- åœ¨é¢„å¤„ç†è¯­å¥å¤„ç†å™¨ä¸­åŒ…æ‹¬ instantiateStatement é¢„å¤„ç† SQLã€parameterize è®¾ç½®å‚æ•°ï¼Œä»¥åŠ query æŸ¥è¯¢çš„æ‰§è¡Œçš„æ“ä½œã€‚
- è¿™é‡Œéœ€è¦æ³¨æ„ parameterize è®¾ç½®å‚æ•°ä¸­è¿˜æ˜¯å†™æ­»çš„å¤„ç†ï¼Œåç»­è¿™éƒ¨åˆ†å†è¿›è¡Œå®Œå–„ã€‚
- query æ–¹æ³•åˆ™æ˜¯æ‰§è¡ŒæŸ¥è¯¢å’Œå¯¹ç»“æœçš„å°è£…ï¼Œç»“æœçš„å°è£…ç›®å‰ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„å¤„ç†ï¼Œåªæ˜¯æŠŠæˆ‘ä»¬å‰é¢ç« èŠ‚ä¸­å¯¹è±¡çš„å†…å®¹æ‘˜å–å‡ºæ¥è¿›è¡Œå°è£…ï¼Œè¿™éƒ¨åˆ†æš‚æ—¶æ²¡æœ‰æ”¹å˜ã€‚éƒ½æ”¾åœ¨åç»­è¿›è¡Œå®Œå–„å¤„ç†ã€‚

### 4. æ‰§è¡Œå™¨åˆ›å»ºå’Œä½¿ç”¨

æ‰§è¡Œå™¨å¼€å‘å®Œæˆä»¥åï¼Œåˆ™éœ€è¦åœ¨ä¸²è”åˆ° DefaultSqlSession ä¸­è¿›è¡Œä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸²è”è¿‡ç¨‹å°±éœ€è¦åœ¨ åˆ›å»º DefaultSqlSession çš„æ—¶å€™ï¼Œæ„å»ºå‡ºæ‰§è¡Œå™¨å¹¶ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚é‚£ä¹ˆè¿™å—å°±æ¶‰åŠåˆ° DefaultSqlSessionFactory#openSession çš„å¤„ç†ã€‚

#### 4.1 å¼€å¯æ‰§è¡Œå™¨

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.defaults.DefaultSqlSessionFactory`

```java
public class DefaultSqlSessionFactory implements SqlSessionFactory {

    private final Configuration configuration;

    public DefaultSqlSessionFactory(Configuration configuration) {
        this.configuration = configuration;
    }

    @Override
    public SqlSession openSession() {
        Transaction tx = null;
        try {
            final Environment environment = configuration.getEnvironment();
            TransactionFactory transactionFactory = environment.getTransactionFactory();
            tx = transactionFactory.newTransaction(configuration.getEnvironment().getDataSource(), TransactionIsolationLevel.READ_COMMITTED, false);
            // åˆ›å»ºæ‰§è¡Œå™¨
            final Executor executor = configuration.newExecutor(tx);
            // åˆ›å»ºDefaultSqlSession
            return new DefaultSqlSession(configuration, executor);
        } catch (Exception e) {
            try {
                assert tx != null;
                tx.close();
            } catch (SQLException ignore) {
            }
            throw new RuntimeException("Error opening session.  Cause: " + e);
        }
    }

}
```

- åœ¨ openSession ä¸­å¼€å¯äº‹åŠ¡ä¼ é€’ç»™æ‰§è¡Œå™¨çš„åˆ›å»ºï¼Œå…³äºæ‰§è¡Œå™¨çš„åˆ›å»ºå…·ä½“å¯ä»¥å‚è€ƒ configuration.newExecutor ä»£ç ï¼Œè¿™éƒ¨åˆ†æ²¡æœ‰å¤ªå¤šå¤æ‚çš„é€»è¾‘ã€‚è¯»è€…å¯ä»¥å‚è€ƒæºç è¿›è¡Œå­¦ä¹ ã€‚
- åœ¨æ‰§è¡Œå™¨åˆ›å»ºå®Œæ¯•åï¼Œåˆ™æ˜¯æŠŠå‚æ•°ä¼ é€’ç»™ DefaultSqlSessionï¼Œè¿™æ ·å°±æŠŠæ•´ä¸ªè¿‡ç¨‹ä¸²è”èµ·æ¥äº†ã€‚

#### 4.2 ä½¿ç”¨æ‰§è¡Œå™¨

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.defaults.DefaultSqlSession`

```java
public class DefaultSqlSession implements SqlSession {

    private Configuration configuration;
    private Executor executor;

    public DefaultSqlSession(Configuration configuration, Executor executor) {
        this.configuration = configuration;
        this.executor = executor;
    }

    @Override
    public <T> T selectOne(String statement, Object parameter) {
        MappedStatement ms = configuration.getMappedStatement(statement);
        List<T> list = executor.query(ms, parameter, Executor.NO_RESULT_HANDLER, ms.getBoundSql());
        return list.get(0);
    }

}
```

- å¥½äº†ï¼Œç»è¿‡ä¸Šé¢æ‰§è¡Œå™¨çš„æ‰€æœ‰å®ç°å®Œæˆåï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£è€¦åçš„è°ƒç”¨äº†ã€‚åœ¨ DefaultSqlSession#selectOne ä¸­è·å– MappedStatement æ˜ å°„è¯­å¥ç±»åï¼Œåˆ™ä¼ é€’ç»™æ‰§è¡Œå™¨è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆç°åœ¨è¿™ä¸ªç±»ç»è¿‡è®¾è®¡æ€æƒ³çš„è§£è€¦åï¼Œå°±å˜å¾—æ›´åŠ èµ¶ç´§æ•´æ´äº†ï¼Œä¹Ÿå°±æ˜¯æ˜“äºç»´æŠ¤å’Œæ‰©å±•äº†ã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

#### 1.1 åˆ›å»ºåº“è¡¨

åˆ›å»ºä¸€ä¸ªæ•°æ®åº“åç§°ä¸º mybatis å¹¶åœ¨åº“ä¸­åˆ›å»ºè¡¨ user ä»¥åŠæ·»åŠ æµ‹è¯•æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
CREATE TABLE
    USER
    (
        id bigint NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
        userId VARCHAR(9) COMMENT 'ç”¨æˆ·ID',
        userHead VARCHAR(16) COMMENT 'ç”¨æˆ·å¤´åƒ',
        createTime TIMESTAMP NULL COMMENT 'åˆ›å»ºæ—¶é—´',
        updateTime TIMESTAMP NULL COMMENT 'æ›´æ–°æ—¶é—´',
        userName VARCHAR(64),
        PRIMARY KEY (id)
    )
    ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
insert into user (id, userId, userHead, createTime, updateTime, userName) values (1, '10001', '1_04', '2022-04-13 00:00:00', '2022-04-13 00:00:00', 'å°å‚…å“¥');    
```

#### 1.2 é…ç½®æ•°æ®æº

```xml
<environments default="development">
    <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="POOLED">
            <property name="driver" value="com.mysql.jdbc.Driver"/>
            <property name="url" value="jdbc:mysql://127.0.0.1:3306/mybatis?useUnicode=true"/>
            <property name="username" value="root"/>
            <property name="password" value="123456"/>
        </dataSource>
    </environment>
</environments>
```

- é€šè¿‡ `mybatis-config-datasource.xml` é…ç½®æ•°æ®æºä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šdriverã€urlã€usernameã€password
- åœ¨è¿™é‡Œ dataSource å¯ä»¥æŒ‰éœ€é…ç½®æˆ DRUIDã€UNPOOLED å’Œ POOLED è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚

#### 1.3 é…ç½®Mapper

```xml
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>
```

- è¿™éƒ¨åˆ†æš‚æ—¶ä¸éœ€è¦è°ƒæ•´ï¼Œç›®å‰è¿˜åªæ˜¯ä¸€ä¸ªå…¥å‚çš„ç±»å‹çš„å‚æ•°ï¼Œåç»­æˆ‘ä»¬å…¨éƒ¨å®Œå–„è¿™éƒ¨åˆ†å†…å®¹ä»¥åï¼Œåˆ™å†æä¾›æ›´å¤šçš„å…¶ä»–å‚æ•°è¿›è¡ŒéªŒè¯ã€‚

### 2. å•å…ƒæµ‹è¯•

```java
@Test
public void test_SqlSessionFactory() throws IOException {
    // 1. ä»SqlSessionFactoryä¸­è·å–SqlSession
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(Resources.getResourceAsReader("mybatis-config-datasource.xml"));
    SqlSession sqlSession = sqlSessionFactory.openSession();
   
    // 2. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    
    // 3. æµ‹è¯•éªŒè¯
    User user = userDao.queryUserInfoById(1L);
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(user));
}
```

- åœ¨å•å…ƒæµ‹è¯•ä¸­æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåªæ˜¯æˆ‘ä»¬ä»æ—§æ˜¯ä¼ é€’ä¸€ä¸ª 1L çš„ long ç±»å‹å‚æ•°ï¼Œè¿›è¡Œæ–¹æ³•çš„è°ƒç”¨å¤„ç†ã€‚é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯æ‰§è¡Œå™¨çš„å¤„ç†è¿‡ç¨‹ï¼Œè¯»è€…åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å¯ä»¥è¿›è¡Œæ–­ç‚¹æµ‹è¯•ï¼Œå­¦ä¹ æ¯ä¸ªè¿‡ç¨‹çš„å¤„ç†å†…å®¹ã€‚

**æµ‹è¯•ç»“æœ**

```java
22:16:25.770 [main] INFO  c.b.m.d.pooled.PooledDataSource - PooledDataSource forcefully closed/removed all connections.
22:16:26.076 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 540642172.
22:16:26.198 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}

Process finished with exit code 0
```

![](https://bugstack.cn/images/article/spring/mybatis-220428-04.png)

- ä»æµ‹è¯•ç»“æœçœ‹æˆ‘ä»¬å·²ç»å¯ä»¥æŠŠ DefaultSqlSession#selectOne ä¸­çš„è°ƒç”¨ï¼Œæ¢æˆæ‰§è¡Œå™¨å®Œæˆæ•´ä¸ªè¿‡ç¨‹çš„å¤„ç†äº†ï¼Œè§£è€¦äº†è¿™éƒ¨åˆ†çš„é€»è¾‘æ“ä½œï¼Œä¹Ÿèƒ½æ–¹ä¾¿æˆ‘ä»¬åç»­çš„æ‰©å±•ã€‚

## å…­ã€æ€»ç»“

- æ•´ä¸ªç« èŠ‚çš„å®ç°éƒ½æ˜¯åœ¨å¤„ç†è§£è€¦è¿™ä»¶äº‹æƒ…ï¼Œä» DefaultSqlSession#selectOne å¯¹æ•°æ®æºçš„å¤„ç†è§£è€¦åˆ°æ‰§è¡Œå™¨ä¸­è¿›è¡Œæ“ä½œã€‚è€Œæ‰§è¡Œå™¨ä¸­åˆåŒ…æ‹¬äº†å¯¹ JDBC å¤„ç†çš„æ‹†è§£ï¼Œé“¾æ¥ã€å‡†å¤‡è¯­å¥ã€å°è£…å‚æ•°ã€å¤„ç†ç»“æœï¼Œæ‰€æœ‰çš„è¿™äº›è¿‡ç¨‹ç»è¿‡è§£è€¦åçš„ç±»å’Œæ–¹æ³•ï¼Œå°±éƒ½å¯ä»¥åœ¨ä»¥åçš„åŠŸèƒ½è¿­ä»£ä¸­éå¸¸æ–¹ä¾¿çš„å®Œæˆæ‰©å±•äº†ã€‚
- æœ¬ç« èŠ‚ä¹Ÿä¸ºæˆ‘ä»¬åç»­æ‰©å±•å‚æ•°çš„å¤„ç†ã€ç»“æœé›†çš„å°è£…é¢„ç•™å‡ºäº†æ‰©å±•ç‚¹ï¼Œä»¥åŠå¯¹äºä¸åŒçš„è¯­å¥å¤„ç†å™¨é€‰æ‹©çš„é—®é¢˜ï¼Œéƒ½éœ€è¦åœ¨åç»­è¿›è¡Œå®Œå–„å’Œè¡¥å……ã€‚ç›®å‰æˆ‘ä»¬ä¸²è”å‡ºæ¥çš„æ˜¯æœ€æ ¸å¿ƒçš„éª¨æ¶ç»“æ„ï¼Œéšç€åç»­çš„æ¸è¿›å¼å¼€å‘é™†ç»­è¿­ä»£å®Œå–„ã€‚
- å¯¹äºæºç çš„å­¦ä¹ ï¼Œè¯»è€…è¦ç»å†çœ‹ã€å†™ã€æ€è€ƒã€åº”ç”¨ç­‰å‡ ä¸ªæ­¥éª¤çš„è¿‡ç¨‹ï¼Œæ‰èƒ½æ›´å¥½çš„å¸æ”¶è¿™é‡Œé¢çš„æ€æƒ³ï¼Œä¸åªæ˜¯ç…§ç€CPä¸€éå°±å®Œäº‹äº†ï¼Œå¦åˆ™ä¹Ÿå°±å¤±å»äº†è·Ÿç€å­¦ä¹ æºç çš„æ„ä¹‰ã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [ä¸ºä»€ä¹ˆè¦å®šä¹‰SQLæ‰§è¡Œå™¨ï¼Ÿ](https://t.zsxq.com/05bYB6iqb)