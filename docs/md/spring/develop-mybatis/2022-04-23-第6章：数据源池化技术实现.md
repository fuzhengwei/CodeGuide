---
title: ç¬¬6ç« ï¼šæ•°æ®æºæ± åŒ–æŠ€æœ¯å®ç°
lock: need
---

# ã€ŠMybatis æ‰‹æ’¸ä¸“æ ã€‹ç¬¬6ç« ï¼šæ•°æ®æºæ± åŒ–æŠ€æœ¯å®ç°

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/cvW7V-wd86DV-Rzs-Fdv1w](https://mp.weixin.qq.com/s/cvW7V-wd86DV-Rzs-Fdv1w)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=898079301&bvid=BV1dN4y1g789&cid=761584030&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`ç å†œï¼Œåªä¼šåšä¸ä¼šè¯´ï¼Ÿ`

ä½ æœ‰å‘ç°å—ï¼Œå…¶å®å¾ˆå¤§ä¸€éƒ¨åˆ†ç å†œï¼Œéƒ½åªæ˜¯ä¼šå†™ä»£ç ï¼Œä¸ä¼šè®²ä¸œè¥¿ã€‚ä¸€é‡åˆ°è¿°èŒã€ç­”è¾©ã€åˆ†äº«ã€æ±‡æŠ¥ï¼Œå°±å¾ˆéš¾æµç•…ä¸”æœ‰é«˜åº¦ã€æœ‰æ·±åº¦ï¼Œå¹¶èåˆä¸€éƒ¨åˆ†å¼•å…¥å…¥èƒœçš„è¶£å‘³æ€§æ¥è®©è§‚ä¼—æ›´å¥½çš„æ¥å—å’Œç†è§£ä½ è¦ä¼ é€’çš„ä¿¡æ¯ã€‚

é‚£ä¸ºä»€ä¹ˆå·²ç»åšäº†è¿˜è®²ä¸å‡ºæ¥å‘¢ï¼Ÿå› ä¸ºåšåªæ˜¯åœ¨å·²ç¡®å®šç›®æ ‡å’Œæ—¢å®šè·¯çº¿ä¸‹çš„æ‰§è¡Œï¼Œä½†ä¸ºä»€ä¹ˆç¡®å®šè¿™ä¸ªç›®æ ‡ã€ä¸ºä»€ä¹ˆåˆ¶å®šè¿™ä¸ªè·¯çº¿ã€æ¨ªå‘çš„å‚ç…§å¯¹æ¯”ã€çºµå‘çš„æ·±åº¦è®¾è®¡ï¼Œéƒ½æ²¡æœ‰åœ¨ä¸€ä¸ªæ‰§è¡Œè€…çš„å¤´è„‘ä¸­å½¢æˆè¿‡ç¨‹çš„æ¨æ¼”ï¼Œæ›´å¤šçš„æ—¶å€™éƒ½åªæ˜¯æ‰§è¡Œã€‚æ‰€ä»¥ä¹Ÿå°±å¾ˆéš¾æŠŠä¸€ä¸ªäº‹å®Œæ•´çš„è¡¨è¿°å‡ºæ¥ã€‚

æ‰€ä»¥ï¼Œåªæœ‰å½“ä½ ç»å†çš„è¶³å¤Ÿå¤šï¼Œé˜…å†çš„è¶³å¤Ÿä¸°å¯Œï¼Œæ‰èƒ½æœ‰æ›´å¥½çš„è¡¨è¿°èƒ½åŠ›å’Œä¸´åœºåº”å˜æŠ€å·§ï¼Œä¹Ÿå°±æ›´èƒ½æ›´æ¸…æ¥šçš„ä¼ é€’å‡ºä½ è¦è¡¨è¾¾çš„ä¿¡æ¯ã€‚

## äºŒã€ç›®æ ‡

åœ¨ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬è§£æäº† XML ä¸­æ•°æ®æºé…ç½®ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ Druid åˆ›å»ºæ•°æ®æºå®Œæˆæ•°æ®åº“çš„æ“ä½œã€‚ä½†å…¶å®åœ¨ Mybatis ä¸­æ˜¯æœ‰è‡ªå·±çš„æ•°æ®æºå®ç°çš„ï¼ŒåŒ…æ‹¬æ— æ± åŒ–çš„ UnpooledDataSource å®ç°æ–¹å¼å’Œæœ‰æ± åŒ–çš„ PooledDataSource å®ç°æ–¹å¼ã€‚

é‚£ä¹ˆæœ¬ç« èŠ‚æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸‹å…³äºæ± åŒ–æ•°æ®æºçš„å¤„ç†ï¼Œé€šè¿‡è¿™äº›å®ç°è¯»è€…ä¹Ÿèƒ½æ›´å¥½çš„ç†è§£åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä¸€äº›å…³äºæ•°æ®æºçš„é…ç½®å±æ€§åˆ°åº•æ„æ¬²ä½•ä¸ºï¼ŒåŒ…æ‹¬ï¼šæœ€å¤§æ´»è·ƒè¿æ¥æ•°ã€ç©ºé—²è¿æ¥æ•°ã€æ£€æµ‹æ—¶é•¿ç­‰ï¼Œåœ¨è¿æ¥æ± ä¸­æ‰€èµ·åˆ°çš„ä½œç”¨ã€‚

## ä¸‰ã€è®¾è®¡

é¦–å…ˆä½ å¯ä»¥æŠŠæ± åŒ–æŠ€æœ¯ç†è§£ä¸ºäº«å…ƒæ¨¡å¼çš„å…·ä½“å®ç°æ–¹æ¡ˆï¼Œé€šå¸¸æˆ‘ä»¬å¯¹ä¸€äº›éœ€è¦è¾ƒé«˜åˆ›å»ºæˆæœ¬ä¸”é«˜é¢‘ä½¿ç”¨çš„èµ„æºï¼Œéœ€è¦è¿›è¡Œç¼“å­˜æˆ–è€…ä¹Ÿç§°é¢„çƒ­å¤„ç†ã€‚å¹¶æŠŠè¿™äº›èµ„æºå­˜æ”¾åˆ°ä¸€ä¸ªé¢„çƒ­æ± å­ä¸­ï¼Œéœ€è¦ç”¨çš„æ—¶å€™ä»æ± å­ä¸­è·å–ï¼Œä½¿ç”¨å®Œæ¯•å†è¿›è¡Œä½¿ç”¨ã€‚é€šè¿‡æ± åŒ–å¯ä»¥éå¸¸æœ‰æ•ˆçš„æ§åˆ¶èµ„æºçš„ä½¿ç”¨æˆæœ¬ï¼ŒåŒ…æ‹¬ï¼›èµ„æºæ•°é‡ã€ç©ºé—²æ—¶é•¿ã€è·å–æ–¹å¼ç­‰è¿›è¡Œç»Ÿä¸€æ§åˆ¶å’Œç®¡ç†ã€‚å¦‚å›¾ 6-1 æ‰€ç¤º

![å›¾ 6-1 æ± åŒ–æ•°æ®æºè®¾è®¡](https://bugstack.cn/images/article/spring/mybatis-220423-01.png)

- é€šè¿‡æä¾›ç»Ÿä¸€çš„è¿æ¥æ± ä¸­å¿ƒï¼Œå­˜æ”¾æ•°æ®æºé“¾æ¥ï¼Œå¹¶æ ¹æ®é…ç½®æŒ‰ç…§è¯·æ±‚è·å–é“¾æ¥çš„æ“ä½œï¼Œåˆ›å»ºè¿æ¥æ± çš„æ•°æ®æºé“¾æ¥æ•°é‡ã€‚è¿™é‡Œå°±åŒ…æ‹¬äº†æœ€å¤§ç©ºé—²é“¾æ¥å’Œæœ€å¤§æ´»è·ƒé“¾æ¥ï¼Œéƒ½éšç€åˆ›å»ºè¿‡ç¨‹è¢«æ§åˆ¶ã€‚
- æ­¤å¤–ç”±äºæ§åˆ¶äº†è¿æ¥æ± ä¸­è¿æ¥çš„æ•°é‡ï¼Œæ‰€ä»¥å½“å¤–éƒ¨ä»è¿æ¥æ± è·å–é“¾æ¥æ—¶ï¼Œå¦‚æœé“¾æ¥å·²æ»¡åˆ™ä¼šè¿›è¡Œå¾ªç¯ç­‰å¾…ã€‚è¿™ä¹Ÿæ˜¯å¤§å®¶æ—¥å¸¸ä½¿ç”¨DBè¿æ¥æ± ï¼Œå¦‚æœä¸€ä¸ªSQLæ“ä½œå¼•èµ·äº†æ…¢æŸ¥è¯¢ï¼Œåˆ™ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡è¿›å…¥ç˜«ç—ªçš„é˜¶æ®µï¼Œå„ä¸ªå’Œæ•°æ®åº“ç›¸å…³çš„æ¥å£è°ƒç”¨ï¼Œéƒ½ä¸èƒ½è·å¾—åˆ°é“¾æ¥ï¼Œæ¥å£æŸ¥è¯¢TP99é™¡ç„¶å¢é«˜ï¼Œç³»ç»Ÿå¼€å§‹å¤§é‡æŠ¥è­¦ã€‚*é‚£è¿æ¥æ± å¯ä»¥é…ç½®çš„å¾ˆå¤§å—ï¼Œä¹Ÿä¸å¯ä»¥ï¼Œå› ä¸ºè¿æ¥æ± è¦å’Œæ•°æ®åº“æ‰€åˆ†é…çš„è¿æ¥æ± å¯¹åº”ä¸Šï¼Œé¿å…åº”ç”¨é…ç½®è¿æ¥æ± è¶…è¿‡æ•°æ®åº“æ‰€æä¾›çš„è¿æ¥æ± æ•°é‡ï¼Œå¦åˆ™ä¼šå‡ºç°å¤¯ä½ä¸èƒ½åˆ†é…é“¾æ¥çš„é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®åº“æ‹–å®ä»è€Œå¼•èµ·è¿é”ååº”ã€‚*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
mybatis-step-05
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”œâ”€â”€ builder
    â”‚           â”œâ”€â”€ datasource
    â”‚           â”‚   â”œâ”€â”€ druid
    â”‚           â”‚   â”‚   â””â”€â”€ DruidDataSourceFactory.java
    â”‚           â”‚   â”œâ”€â”€ pooled
    â”‚           â”‚   â”‚   â”œâ”€â”€ PooledConnection.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ PooledDataSource.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ PooledDataSourceFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ PoolState.java
    â”‚           â”‚   â”œâ”€â”€ unpooled
    â”‚           â”‚   â”‚   â”œâ”€â”€ UnpooledDataSource.java
    â”‚           â”‚   â”‚   â””â”€â”€ UnpooledDataSourceFactory.java
    â”‚           â”‚   â””â”€â”€ DataSourceFactory.java
    â”‚           â”œâ”€â”€ io
    â”‚           â”œâ”€â”€ mapping
    â”‚           â”œâ”€â”€ session
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSqlSession.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Configuration.java
    â”‚           â”‚   â”œâ”€â”€ SqlSession.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactoryBuilder.java
    â”‚           â”‚   â””â”€â”€ TransactionIsolationLevel.java  
    â”‚           â”œâ”€â”€ transaction
    â”‚           â””â”€â”€ type
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ cn.bugstack.mybatis.test.dao
        â”‚       â”œâ”€â”€ dao
        â”‚       â”‚   â””â”€â”€ IUserDao.java
        â”‚       â”œâ”€â”€ po
        â”‚       â”‚   â””â”€â”€ User.java
        â”‚       â””â”€â”€ ApiTest.java
        â””â”€â”€ resources
            â”œâ”€â”€ mapper
            â”‚   â””â”€â”€User_Mapper.xml
            â””â”€â”€ mybatis-config-datasource.xml
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šæ‰‹å†™Mybatisï¼Œè·å–å®Œæ•´æºç `

æ± åŒ–æ•°æ®æºæ ¸å¿ƒç±»å…³ç³»ï¼Œå¦‚å›¾ 6-2 æ‰€ç¤º

![å›¾ 6-2 æ± åŒ–æ•°æ®æºæ ¸å¿ƒç±»å…³ç³»](https://bugstack.cn/images/article/spring/mybatis-220423-02.png)

- åœ¨ Mybatis æ•°æ®æºçš„å®ç°ä¸­ï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†åˆ†ä¸ºæ— æ± åŒ–çš„ UnpooledDataSource å®ç°ç±»å’Œæœ‰æ± åŒ–çš„ PooledDataSource å®ç°ç±»ï¼Œæ± åŒ–çš„å®ç°ç±» PooledDataSource ä»¥å¯¹æ— æ± åŒ–çš„ UnpooledDataSource è¿›è¡Œæ‰©å±•å¤„ç†ã€‚æŠŠåˆ›å»ºå‡ºæ¥çš„é“¾æ¥ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œè®°å½•ä¸ºç©ºé—²é“¾æ¥å’Œæ´»è·ƒé“¾æ¥ï¼Œåœ¨ä¸åŒçš„é˜¶æ®µè¿›è¡Œä½¿ç”¨ã€‚
- PooledConnection æ˜¯å¯¹é“¾æ¥çš„ä»£ç†æ“ä½œï¼Œé€šè¿‡invokeæ–¹æ³•çš„åå°„è°ƒç”¨ï¼Œå¯¹å…³é—­çš„é“¾æ¥è¿›è¡Œå›æ”¶å¤„ç†ï¼Œå¹¶ä½¿ç”¨ notifyAll é€šçŸ¥æ­£åœ¨ç­‰å¾…é“¾æ¥çš„ç”¨æˆ·è¿›è¡ŒæŠ¢é“¾æ¥ã€‚
- å¦å¤–æ˜¯å¯¹ DataSourceFactory æ•°æ®æºå·¥å‚æ¥å£çš„å®ç°ï¼Œç”±æ— æ± åŒ–å·¥å‚å®ç°åï¼Œæœ‰æ± åŒ–å·¥å‚ç»§æ‰¿çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œæ²¡æœ‰å¤ªå¤šçš„å¤æ‚æ“ä½œï¼Œæ± åŒ–çš„å¤„ç†ä¸»è¦é›†ä¸­åœ¨ PooledDataSource ç±»ä¸­è¿›è¡Œå¤„ç†ã€‚

### 2. æ— æ± åŒ–é“¾æ¥å®ç°

å¯¹äºæ•°æ®åº“è¿æ¥æ± çš„å®ç°ï¼Œä¸ä¸€å®šéå¾—æä¾›æ± åŒ–æŠ€æœ¯ï¼Œå¯¹äºæŸäº›åœºæ™¯å¯ä»¥åªä½¿ç”¨æ— æ± åŒ–çš„è¿æ¥æ± ã€‚é‚£ä¹ˆåœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æŠŠæ— æ± åŒ–çš„å®ç°å’Œæ± åŒ–å®ç°æ‹†åˆ†è§£è€¦ï¼Œåœ¨éœ€è¦çš„æ—¶å€™åªéœ€è¦é…ç½®å¯¹åº”çš„æ•°æ®æºå³å¯ã€‚

```java
public class UnpooledDataSource implements DataSource {

    private ClassLoader driverClassLoader;
    // é©±åŠ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥æ‰©å±•å±æ€§ä¿¡æ¯ driver.encoding=UTF8
    private Properties driverProperties;
    // é©±åŠ¨æ³¨å†Œå™¨
    private static Map<String, Driver> registeredDrivers = new ConcurrentHashMap<>();
    // é©±åŠ¨
    private String driver;
    // DB é“¾æ¥åœ°å€
    private String url;
    // è´¦å·
    private String username;
    // å¯†ç 
    private String password;
    // æ˜¯å¦è‡ªåŠ¨æäº¤
    private Boolean autoCommit;
    // äº‹åŠ¡çº§åˆ«
    private Integer defaultTransactionIsolationLevel;

    static {
        Enumeration<Driver> drivers = DriverManager.getDrivers();
        while (drivers.hasMoreElements()) {
            Driver driver = drivers.nextElement();
            registeredDrivers.put(driver.getClass().getName(), driver);
        }
    }

    private Connection doGetConnection(Properties properties) throws SQLException {
        initializerDriver();
        Connection connection = DriverManager.getConnection(url, properties);
        if (autoCommit != null && autoCommit != connection.getAutoCommit()) {
            connection.setAutoCommit(autoCommit);
        }
        if (defaultTransactionIsolationLevel != null) {
            connection.setTransactionIsolation(defaultTransactionIsolationLevel);
        }
        return connection;
    }

    /**
     * åˆå§‹åŒ–é©±åŠ¨
     */
    private synchronized void initializerDriver() throws SQLException {
        if (!registeredDrivers.containsKey(driver)) {
            try {
                Class<?> driverType = Class.forName(driver, true, driverClassLoader);
                // https://www.kfu.com/~nsayer/Java/dyn-jdbc.html
                Driver driverInstance = (Driver) driverType.newInstance();
                DriverManager.registerDriver(new DriverProxy(driverInstance));
                registeredDrivers.put(driver, driverInstance);
            } catch (Exception e) {
                throw new SQLException("Error setting driver on UnpooledDataSource. Cause: " + e);
            }
        }
    }
	
}
```

- æ— æ± åŒ–çš„æ•°æ®æºé“¾æ¥å®ç°æ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒåœ¨äº initializerDriver åˆå§‹åŒ–é©±åŠ¨ä¸­ä½¿ç”¨äº† Class.forName å’Œ newInstance çš„æ–¹å¼åˆ›å»ºäº†æ•°æ®æºé“¾æ¥æ“ä½œã€‚
- åœ¨åˆ›å»ºå®Œæˆè¿æ¥ä»¥åï¼ŒæŠŠé“¾æ¥å­˜æ”¾åˆ°é©±åŠ¨æ³¨å†Œå™¨ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ä¸­å¯ä»¥ç›´æ¥è·å–é“¾æ¥ï¼Œé¿å…é‡å¤åˆ›å»ºæ‰€å¸¦æ¥çš„èµ„æºæ¶ˆè€—ã€‚

### 3. æœ‰æ± åŒ–é“¾æ¥å®ç°

æœ‰æ± åŒ–çš„æ•°æ®æºé“¾æ¥ï¼Œæ ¸å¿ƒåœ¨äºå¯¹æ— æ± åŒ–é“¾æ¥çš„åŒ…è£…ï¼ŒåŒæ—¶æä¾›äº†ç›¸åº”çš„æ± åŒ–æŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬ï¼špushConnectionã€popConnectionã€forceCloseAllã€pingConnection çš„æ“ä½œå¤„ç†ã€‚

è¿™æ ·å½“ç”¨æˆ·æƒ³è¦è·å–é“¾æ¥çš„æ—¶å€™ï¼Œåˆ™ä¼šä»è¿æ¥æ± ä¸­è¿›è¡Œè·å–ï¼ŒåŒæ—¶åˆ¤æ–­æ˜¯å¦æœ‰ç©ºé—²é“¾æ¥ã€æœ€å¤§æ´»è·ƒé“¾æ¥å¤šå°‘ï¼Œä»¥åŠæ˜¯å¦éœ€è¦ç­‰å¾…å¤„ç†æˆ–æ˜¯æœ€ç»ˆæŠ›å‡ºå¼‚å¸¸ã€‚

#### 3.1 æ± åŒ–è¿æ¥çš„ä»£ç†

ç”±äºæˆ‘ä»¬éœ€è¦å¯¹è¿æ¥è¿›è¡Œæ± åŒ–å¤„ç†ï¼Œæ‰€ä»¥å½“é“¾æ¥è°ƒç”¨ä¸€äº› CLOSE æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦æŠŠé“¾æ¥ä»æ± ä¸­å…³é—­å’Œæ¢å¤å¯ç”¨ï¼Œå…è®¸å…¶ä»–ç”¨æˆ·è·å–åˆ°é“¾æ¥ã€‚é‚£ä¹ˆè¿™é‡Œå°±éœ€è¦å¯¹è¿æ¥ç±»è¿›è¡Œä»£ç†åŒ…è£…ï¼Œå¤„ç† CLOSE æ–¹æ³•ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.datasource.pooled.PooledConnection`

```java
public class PooledConnection implements InvocationHandler {

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        String methodName = method.getName();
        // å¦‚æœæ˜¯è°ƒç”¨ CLOSE å…³é—­é“¾æ¥æ–¹æ³•ï¼Œåˆ™å°†é“¾æ¥åŠ å…¥è¿æ¥æ± ä¸­ï¼Œå¹¶è¿”å›null
        if (CLOSE.hashCode() == methodName.hashCode() && CLOSE.equals(methodName)) {
            dataSource.pushConnection(this);
            return null;
        } else {
            if (!Object.class.equals(method.getDeclaringClass())) {
                // é™¤äº†toString()æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•è°ƒç”¨ä¹‹å‰è¦æ£€æŸ¥connectionæ˜¯å¦è¿˜æ˜¯åˆæ³•çš„,ä¸åˆæ³•è¦æŠ›å‡ºSQLException
                checkConnection();
            }
            // å…¶ä»–æ–¹æ³•äº¤ç»™connectionå»è°ƒç”¨
            return method.invoke(realConnection, args);
        }
    }
    
}
```

- é€šè¿‡ PooledConnection å®ç° InvocationHandler#invoke æ–¹æ³•ï¼ŒåŒ…è£…ä»£ç†é“¾æ¥ï¼Œè¿™æ ·å°±å¯ä»¥å¯¹å…·ä½“çš„è°ƒç”¨æ–¹æ³•è¿›è¡Œæ§åˆ¶äº†ã€‚
- åœ¨ invoke æ–¹æ³•ä¸­å¤„ç†å¯¹ CLOSE æ–¹æ³•æ§åˆ¶ä»¥å¤–ï¼Œæ’é™¤ toString ç­‰Object çš„æ–¹æ³•åï¼Œåˆ™æ˜¯å…¶ä»–çœŸæ­£éœ€è¦è¢« DB é“¾æ¥å¤„ç†çš„æ–¹æ³•äº†ã€‚
- é‚£ä¹ˆè¿™é‡Œæœ‰ä¸€ä¸ªå¯¹äº CLOSE æ–¹æ³•çš„æ•°æ®æºå›æ”¶æ“ä½œ dataSource.pushConnection(this); æœ‰ä¸€ä¸ªå…·ä½“çš„å®ç°æ–¹æ³•ï¼Œåœ¨æ± åŒ–å®ç°ç±» PooledDataSource ä¸­è¿›è¡Œå¤„ç†ã€‚

#### 3.2 pushConnection å›æ”¶é“¾æ¥

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.datasource.pooled.PooledDataSource`

```java
protected void pushConnection(PooledConnection connection) throws SQLException {
    synchronized (state) {
        state.activeConnections.remove(connection);
        // åˆ¤æ–­é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
        if (connection.isValid()) {
            // å¦‚æœç©ºé—²é“¾æ¥å°äºè®¾å®šæ•°é‡ï¼Œä¹Ÿå°±æ˜¯å¤ªå°‘æ—¶
            if (state.idleConnections.size() < poolMaximumIdleConnections && connection.getConnectionTypeCode() == expectedConnectionTypeCode) {
                state.accumulatedCheckoutTime += connection.getCheckoutTime();
                if (!connection.getRealConnection().getAutoCommit()) {
                    connection.getRealConnection().rollback();
                }
                // å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„DBè¿æ¥ï¼ŒåŠ å…¥åˆ°idleåˆ—è¡¨
                PooledConnection newConnection = new PooledConnection(connection.getRealConnection(), this);
                state.idleConnections.add(newConnection);
                newConnection.setCreatedTimestamp(connection.getCreatedTimestamp());
                newConnection.setLastUsedTimestamp(connection.getLastUsedTimestamp());
                connection.invalidate();
                logger.info("Returned connection " + newConnection.getRealHashCode() + " to pool.");
                // é€šçŸ¥å…¶ä»–çº¿ç¨‹å¯ä»¥æ¥æŠ¢DBè¿æ¥äº†
                state.notifyAll();
            }
            // å¦åˆ™ï¼Œç©ºé—²é“¾æ¥è¿˜æ¯”è¾ƒå……è¶³
            else {
                state.accumulatedCheckoutTime += connection.getCheckoutTime();
                if (!connection.getRealConnection().getAutoCommit()) {
                    connection.getRealConnection().rollback();
                }
                // å°†connectionå…³é—­
                connection.getRealConnection().close();
                logger.info("Closed connection " + connection.getRealHashCode() + ".");
                connection.invalidate();
            }
        } else {
            logger.info("A bad connection (" + connection.getRealHashCode() + ") attempted to return to the pool, discarding connection.");
            state.badConnectionCount++;
        }
    }
}
```

- åœ¨ PooledDataSource#pushConnection æ•°æ®æºå›æ”¶çš„å¤„ç†ä¸­ï¼Œæ ¸å¿ƒåœ¨äºåˆ¤æ–­é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œä»¥åŠè¿›è¡Œç›¸å…³çš„ç©ºé—²é“¾æ¥æ ¡éªŒï¼Œåˆ¤æ–­æ˜¯å¦æŠŠè¿æ¥å›æ”¶åˆ° idle ç©ºé—²é“¾æ¥åˆ—è¡¨ä¸­ï¼Œå¹¶é€šçŸ¥å…¶ä»–çº¿ç¨‹æ¥æŠ¢å ã€‚
- å¦‚æœç°åœ¨ç©ºé—²é“¾æ¥å……è¶³ï¼Œé‚£ä¹ˆè¿™ä¸ªå›æ”¶çš„é“¾æ¥åˆ™ä¼šè¿›è¡Œå›æ»šå’Œå…³é—­çš„å¤„ç†ä¸­ã€‚connection.getRealConnection().close();

#### 3.3 popConnection è·å–é“¾æ¥

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.datasource.pooled.PooledDataSource`

```java
private PooledConnection popConnection(String username, String password) throws SQLException {
    boolean countedWait = false;
    PooledConnection conn = null;
    long t = System.currentTimeMillis();
    int localBadConnectionCount = 0;
    while (conn == null) {
        synchronized (state) {
            // å¦‚æœæœ‰ç©ºé—²é“¾æ¥ï¼šè¿”å›ç¬¬ä¸€ä¸ª
            if (!state.idleConnections.isEmpty()) {
                conn = state.idleConnections.remove(0);
                logger.info("Checked out connection " + conn.getRealHashCode() + " from pool.");
            }
            // å¦‚æœæ— ç©ºé—²é“¾æ¥ï¼šåˆ›å»ºæ–°çš„é“¾æ¥
            else {
                // æ´»è·ƒè¿æ¥æ•°ä¸è¶³
                if (state.activeConnections.size() < poolMaximumActiveConnections) {
                    conn = new PooledConnection(dataSource.getConnection(), this);
                    logger.info("Created connection " + conn.getRealHashCode() + ".");
                }
                // æ´»è·ƒè¿æ¥æ•°å·²æ»¡
                else {
                    // å–å¾—æ´»è·ƒé“¾æ¥åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯æœ€è€çš„ä¸€ä¸ªè¿æ¥
                    PooledConnection oldestActiveConnection = state.activeConnections.get(0);
                    long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();
                    // å¦‚æœcheckoutæ—¶é—´è¿‡é•¿ï¼Œåˆ™è¿™ä¸ªé“¾æ¥æ ‡è®°ä¸ºè¿‡æœŸ
                    if (longestCheckoutTime > poolMaximumCheckoutTime) {
                        state.claimedOverdueConnectionCount++;
                        state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;
                        state.accumulatedCheckoutTime += longestCheckoutTime;
                        state.activeConnections.remove(oldestActiveConnection);
                        if (!oldestActiveConnection.getRealConnection().getAutoCommit()) {
                            oldestActiveConnection.getRealConnection().rollback();
                        }
                        // åˆ æ‰æœ€è€çš„é“¾æ¥ï¼Œç„¶åé‡æ–°å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„é“¾æ¥
                        conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);
                        oldestActiveConnection.invalidate();
                        logger.info("Claimed overdue connection " + conn.getRealHashCode() + ".");
                    }
                    // å¦‚æœcheckoutè¶…æ—¶æ—¶é—´ä¸å¤Ÿé•¿ï¼Œåˆ™ç­‰å¾…
                    else {
                        try {
                            if (!countedWait) {
                                state.hadToWaitCount++;
                                countedWait = true;
                            }
                            logger.info("Waiting as long as " + poolTimeToWait + " milliseconds for connection.");
                            long wt = System.currentTimeMillis();
                            state.wait(poolTimeToWait);
                            state.accumulatedWaitTime += System.currentTimeMillis() - wt;
                        } catch (InterruptedException e) {
                            break;
                        }
                    }
                }
            }
            // è·å¾—åˆ°é“¾æ¥
            if (conn != null) {
                if (conn.isValid()) {
                    if (!conn.getRealConnection().getAutoCommit()) {
                        conn.getRealConnection().rollback();
                    }
                    conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));
                    // è®°å½•checkoutæ—¶é—´
                    conn.setCheckoutTimestamp(System.currentTimeMillis());
                    conn.setLastUsedTimestamp(System.currentTimeMillis());
                    state.activeConnections.add(conn);
                    state.requestCount++;
                    state.accumulatedRequestTime += System.currentTimeMillis() - t;
                } else {
                    logger.info("A bad connection (" + conn.getRealHashCode() + ") was returned from the pool, getting another connection.");
                    // å¦‚æœæ²¡æ‹¿åˆ°ï¼Œç»Ÿè®¡ä¿¡æ¯ï¼šå¤±è´¥é“¾æ¥ +1
                    state.badConnectionCount++;
                    localBadConnectionCount++;
                    conn = null;
                    // å¤±è´¥æ¬¡æ•°è¾ƒå¤šï¼ŒæŠ›å¼‚å¸¸
                    if (localBadConnectionCount > (poolMaximumIdleConnections + 3)) {
                        logger.debug("PooledDataSource: Could not get a good connection to the database.");
                        throw new SQLException("PooledDataSource: Could not get a good connection to the database.");
                    }
                }
            }
        }
    }

    return conn;
}
```

- popConnection è·å–é“¾æ¥æ˜¯ä¸€ä¸ª while æ­»å¾ªç¯æ“ä½œï¼Œåªæœ‰è·å–åˆ°é“¾æ¥æŠ›å¼‚å¸¸æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œå¦‚æœä»”ç»†é˜…è¯»è¿™äº›å¼‚å¸¸ä»£ç ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä½ åœ¨åšä¸€äº›å¼€å‘çš„æ—¶å€™æ‰€é‡åˆ°çš„å¼‚å¸¸å‘¢ã€‚
- è·å–é“¾æ¥çš„è¿‡ç¨‹ä¼šä½¿ç”¨ synchronized è¿›è¡ŒåŠ é”ï¼Œå› ä¸ºæ‰€æœ‰çº¿ç¨‹åœ¨èµ„æºç«äº‰çš„æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦è¿›è¡ŒåŠ é”å¤„ç†ã€‚åœ¨åŠ é”çš„ä»£ç å—ä¸­é€šè¿‡åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—²é“¾æ¥è¿›è¡Œè¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šåˆ¤æ–­æ´»è·ƒè¿æ¥æ•°æ˜¯å¦å……è¶³ï¼Œä¸å……è¶³åˆ™è¿›è¡Œåˆ›å»ºåè¿”å›ã€‚åœ¨è¿™é‡Œä¹Ÿä¼šé‡åˆ°æ´»è·ƒé“¾æ¥å·²ç»è¿›è¡Œå¾ªç¯ç­‰å¾…çš„è¿‡ç¨‹ï¼Œæœ€åå†ä¸èƒ½è·å–åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

### 4. æ•°æ®æºå·¥å‚

æ•°æ®æºå·¥å‚åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æ— æ± åŒ–å’Œæœ‰æ± åŒ–ï¼Œæœ‰æ± åŒ–çš„å·¥å‚ç»§æ‰¿æ— æ± åŒ–å·¥å‚ï¼Œå› ä¸ºåœ¨ Mybatis æºç çš„å®ç°ç±»ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å¯¹ Properties ç»Ÿä¸€åŒ…è£…çš„åå°„æ–¹å¼çš„å±æ€§å¤„ç†ã€‚ç”±äºæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰å¯¹è¿™å—é€»è¾‘è¿›è¡Œå¼€å‘ï¼Œåªæ˜¯ç®€å•çš„è·å–å±æ€§ä¼ å‚ï¼Œæ‰€ä»¥è¿˜ä¸èƒ½ä½“ç°å‡ºè¿™æ ·çš„ç»§æ‰¿æœ‰å¤šä¾¿æ·ï¼Œè¯»è€…å¯ä»¥å‚è€ƒæºç è¿›è¡Œç†è§£ã€‚æºç ç±»ï¼šUnpooledDataSourceFactory

#### 4.1 æ— æ± åŒ–å·¥å‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.datasource.unpooled.UnpooledDataSourceFactory`

```java
public class UnpooledDataSourceFactory implements DataSourceFactory {

    protected Properties props;

    @Override
    public void setProperties(Properties props) {
        this.props = props;
    }

    @Override
    public DataSource getDataSource() {
        UnpooledDataSource unpooledDataSource = new UnpooledDataSource();
        unpooledDataSource.setDriver(props.getProperty("driver"));
        unpooledDataSource.setUrl(props.getProperty("url"));
        unpooledDataSource.setUsername(props.getProperty("username"));
        unpooledDataSource.setPassword(props.getProperty("password"));
        return unpooledDataSource;
    }

}
```

- ç®€å•åŒ…è£… getDataSource è·å–æ•°æ®æºå¤„ç†ï¼ŒæŠŠå¿…è¦çš„å‚æ•°è¿›è¡Œä¼ é€’è¿‡å»ã€‚åœ¨ Mybatis æºç ä¸­è¿™éƒ¨åˆ†åˆ™æ˜¯è¿›è¡Œäº†å¤§é‡çš„åå°„å­—æ®µå¤„ç†çš„æ–¹å¼è¿›è¡Œå­˜æ”¾å’Œè·å–çš„ã€‚

#### 4.2 æœ‰æ± åŒ–å·¥å‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.datasource.pooled.PooledDataSourceFactory`

```java
public class PooledDataSourceFactory extends UnpooledDataSourceFactory {

    @Override
    public DataSource getDataSource() {
        PooledDataSource pooledDataSource = new PooledDataSource();
        pooledDataSource.setDriver(props.getProperty("driver"));
        pooledDataSource.setUrl(props.getProperty("url"));
        pooledDataSource.setUsername(props.getProperty("username"));
        pooledDataSource.setPassword(props.getProperty("password"));
        return pooledDataSource;
    }

}
```

- æœ‰æ± åŒ–çš„æ•°æ®æºå·¥å‚å®ç°çš„ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ç»§æ‰¿ UnpooledDataSourceFactory å…±ç”¨è·å–å±æ€§çš„èƒ½åŠ›ï¼Œä»¥åŠå®ä¾‹åŒ–å‡ºæ± åŒ–æ•°æ®æºå³å¯ã€‚

### 5. æ–°å¢ç±»å‹åˆ«åæ³¨å†Œå™¨

å½“æˆ‘ä»¬æ–°å¼€å‘äº†ä¸¤ä¸ªæ•°æ®æºå’Œå¯¹åº”çš„å·¥å‚å®ç°ç±»ä»¥åï¼Œåˆ™éœ€è¦æŠŠå®ƒä»¬é…ç½®åˆ° Configuration ä¸­ï¼Œè¿™æ ·æ‰èƒ½åœ¨è§£æ XML æ—¶å€™æ ¹æ®ä¸åŒçš„æ•°æ®æºç±»å‹è·å–å’Œå®ä¾‹åŒ–å¯¹åº”çš„å®ç°ç±»ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.Configuration`

```java
public class Configuration {

    // ç±»å‹åˆ«åæ³¨å†Œæœº
    protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry();

    public Configuration() {
        typeAliasRegistry.registerAlias("JDBC", JdbcTransactionFactory.class);

        typeAliasRegistry.registerAlias("DRUID", DruidDataSourceFactory.class);
        typeAliasRegistry.registerAlias("UNPOOLED", UnpooledDataSourceFactory.class);
        typeAliasRegistry.registerAlias("POOLED", PooledDataSourceFactory.class);
    }

}
```

- åœ¨æ„é€ æ–¹æ³• Configuration æ·»åŠ  UNPOOLEDã€POOLED ä¸¤ä¸ªæ•°æ®æºæ³¨å†Œåˆ°ç±»å‹æ³¨å†Œå™¨ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ XMLConfigBuilder#environmentsElement æ–¹æ³•è§£æ XML å¤„ç†æ•°æ®æºæ—¶å€™è¿›è¡Œä½¿ç”¨ã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

#### 1.1 åˆ›å»ºåº“è¡¨

åˆ›å»ºä¸€ä¸ªæ•°æ®åº“åç§°ä¸º mybatis å¹¶åœ¨åº“ä¸­åˆ›å»ºè¡¨ user ä»¥åŠæ·»åŠ æµ‹è¯•æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
CREATE TABLE
    USER
    (
        id bigint NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
        userId VARCHAR(9) COMMENT 'ç”¨æˆ·ID',
        userHead VARCHAR(16) COMMENT 'ç”¨æˆ·å¤´åƒ',
        createTime TIMESTAMP NULL COMMENT 'åˆ›å»ºæ—¶é—´',
        updateTime TIMESTAMP NULL COMMENT 'æ›´æ–°æ—¶é—´',
        userName VARCHAR(64),
        PRIMARY KEY (id)
    )
    ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
insert into user (id, userId, userHead, createTime, updateTime, userName) values (1, '10001', '1_04', '2022-04-13 00:00:00', '2022-04-13 00:00:00', 'å°å‚…å“¥');    
```

#### 1.2 é…ç½®æ•°æ®æº

```xml
<environments default="development">
    <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="DRUID">
            <property name="driver" value="com.mysql.jdbc.Driver"/>
            <property name="url" value="jdbc:mysql://127.0.0.1:3306/mybatis?useUnicode=true"/>
            <property name="username" value="root"/>
            <property name="password" value="123456"/>
        </dataSource>
    </environment>
</environments>
```

- é€šè¿‡ `mybatis-config-datasource.xml` é…ç½®æ•°æ®æºä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šdriverã€urlã€usernameã€password
- åœ¨è¿™é‡Œ dataSource çš„é…ç½®åˆä¸Šä¸€ç« èŠ‚çš„ DRUID ä¿®æ”¹ä¸ºï¼ŒUNPOOLED å’Œ POOLED è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚è¿™ä¸¤ä¸ªæ•°æ®æºä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ¬ç« èŠ‚è‡ªå·±å®ç°çš„æ•°æ®æºã€‚

#### 1.3 é…ç½®Mapper

```xml
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>
```

- Mapper çš„é…ç½®å†…å®¹åœ¨ä¸Šä¸€ç« èŠ‚çš„è§£æå­¦ä¹ ä¸­å·²ç»åšäº†é…ç½®ï¼Œæœ¬ç« èŠ‚åšäº†ç®€å•çš„è°ƒæ•´ã€‚

### 2. å•å…ƒæµ‹è¯•

```java
@Test
public void test_SqlSessionFactory() throws IOException {
    // 1. ä»SqlSessionFactoryä¸­è·å–SqlSession
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(Resources.getResourceAsReader("mybatis-config-datasource.xml"));
    SqlSession sqlSession = sqlSessionFactory.openSession();
    
    // 2. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    
    // 3. æµ‹è¯•éªŒè¯
    for (int i = 0; i < 50; i++) {
        User user = userDao.queryUserInfoById(1L);
        logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(user));
    }
}
```

- åœ¨æ— æ± åŒ–å’Œæœ‰æ± åŒ–çš„æµ‹è¯•ä¸­ï¼ŒåŸºç¡€çš„å•å…ƒæµ‹è¯•ç±»ä¸éœ€è¦æ”¹å˜ï¼Œä»æ˜¯é€šè¿‡ SqlSessionFactory ä¸­è·å– SqlSession å¹¶è·å¾—æ˜ å°„å¯¹è±¡å’Œæ‰§è¡Œæ–¹æ³•è°ƒç”¨ã€‚å¦å¤–è¿™é‡Œæ˜¯æ·»åŠ äº†50æ¬¡çš„æŸ¥è¯¢è°ƒç”¨ï¼Œä¾¿äºéªŒè¯è¿æ¥æ± çš„åˆ›å»ºå’Œè·å–ä»¥åŠç­‰å¾…ã€‚
- å˜åŒ–çš„åœ¨äº mybatis-config-datasource.xml ä¸­ dataSource æ•°æ®æºç±»å‹çš„è°ƒæ•´ `dataSource type="POOLED/UNPOOLED"`

#### 2.1 æ— æ± åŒ–æµ‹è¯•

```xml
<dataSource type="UNPOOLED"></dataSource>
```

**æµ‹è¯•ç»“æœ**

```java
11:27:48.604 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.618 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.622 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.632 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.637 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.642 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:27:48.649 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
...
```

- æ— æ± åŒ–çš„è¿æ¥æ± æ“ä½œï¼Œä¼šä¸æ–­çš„ä¸æ•°æ®åº“å»ºç«‹æ–°çš„é“¾æ¥å¹¶æ‰§è¡Œ SQL æ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åªè¦æ•°æ®åº“è¿˜æœ‰é“¾æ¥å¯ä»¥è¢«é“¾æ¥ï¼Œå°±å¯ä»¥åˆ›å»ºé“¾æ¥ã€‚

#### 2.2 æœ‰æ± åŒ–æµ‹è¯•

```xml
<dataSource type="POOLED"></dataSource>
```

**æµ‹è¯•ç»“æœ**

```java
11:30:22.536 [main] INFO  c.b.m.d.pooled.PooledDataSource - PooledDataSource forcefully closed/removed all connections.
11:30:22.541 [main] INFO  c.b.m.d.pooled.PooledDataSource - PooledDataSource forcefully closed/removed all connections.
11:30:22.541 [main] INFO  c.b.m.d.pooled.PooledDataSource - PooledDataSource forcefully closed/removed all connections.
11:30:22.541 [main] INFO  c.b.m.d.pooled.PooledDataSource - PooledDataSource forcefully closed/removed all connections.
11:30:22.860 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 540642172.
11:30:22.996 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.009 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 140799417.
11:30:23.011 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.018 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 110431793.
11:30:23.019 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.032 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 1053631449.
11:30:23.033 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.041 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 1693847660.
11:30:23.042 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.047 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 212921632.
11:30:23.048 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.055 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 682376643.
11:30:23.056 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.060 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 334203599.
11:30:23.062 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.067 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 1971851377.
11:30:23.068 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.073 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 399534175.
11:30:23.074 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
11:30:23.074 [main] INFO  c.b.m.d.pooled.PooledDataSource - Waiting as long as 20000 milliseconds for connection.
11:30:43.078 [main] INFO  c.b.m.d.pooled.PooledDataSource - Claimed overdue connection 540642172.
11:30:43.079 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}

...
```

- é€šè¿‡ä½¿ç”¨è¿æ¥æ± çš„é…ç½®å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨å’Œè·å–è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå½“è°ƒç”¨æ¬¡æ•°æ‰“åˆ°10æ¬¡ä»¥åï¼Œè¿æ¥æ± ä¸­å°±æœ‰äº†10ä¸ªæ´»è·ƒçš„é“¾æ¥ï¼Œå†è°ƒç”¨çš„æ—¶å€™åˆ™éœ€è¦ç­‰å¾…è¿æ¥é‡Šæ”¾åæ‰èƒ½ä½¿ç”¨å¹¶æ‰§è¡Œ SQL æ“ä½œã€‚
- æµ‹è¯•çš„è¿‡ç¨‹ä¸­è¿˜åŒ…æ‹¬äº†è¿æ¥çš„ç©ºé—²æ•°é‡ã€æ´»è·ƒæ•°é‡ã€å…³é—­ã€å¼‚å¸¸ç­‰ï¼Œè¯»è€…ä¼™ä¼´ä¹Ÿå¯ä»¥åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­è¿›è¡ŒéªŒè¯å¤„ç†ã€‚

## å…­ã€æ€»ç»“

- æœ¬ç« èŠ‚æˆ‘ä»¬å®Œæˆäº† Mybatis æ•°æ®æºæ± åŒ–çš„è®¾è®¡å’Œå®ç°ï¼Œä¹Ÿèƒ½é€šè¿‡è¿™æ ·çš„åˆ†æã€å®ç°ã€éªŒè¯çš„è¿‡ç¨‹è®©å¤§å®¶æ›´å¥½çš„ç†è§£æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„è¿æ¥æ± æ‰€é‡åˆ°çš„ä¸€äº›çœŸå®é—®é¢˜éƒ½æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼Œåšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚
- å¦å¤–å…³äºè¿æ¥æ± çš„å®ç°é‡ç‚¹å¯ä»¥éšç€è°ƒè¯•éªŒè¯çš„è¿‡ç¨‹ä¸­è¿›è¡Œå­¦ä¹ ï¼ŒåŒ…æ‹¬ï¼šsynchronized åŠ é”ã€åˆ›å»ºè¿æ¥ã€æ´»è·ƒæ•°é‡æ§åˆ¶ã€ä¼‘çœ ç­‰å¾…æ—¶é•¿ï¼ŒæŠ›å¼‚å¸¸é€»è¾‘ç­‰ï¼Œè¿™äº›éƒ½ä¸æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨è¿æ¥æ± æ—¶çš„é…ç½®æ¯æ¯ç›¸å…³ã€‚
- è¿™ä¸€ç« èŠ‚çš„å†…å®¹å¯ä»¥ç®—ä½œæ˜¯ Mybatis æ ¸å¿ƒåŠŸèƒ½å®ç°è¿‡ç¨‹ä¸Šçš„é‡è¦åˆ†æ”¯ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨ Druid æ›¿ä»£æ•°æ®æºçš„å¤„ç†ï¼Œä½†åªæœ‰åŠ¨æ‰‹è‡ªå·±å®ç°ä¸€éæ•°æ®æºè¿æ¥æ± æ‰èƒ½æ›´å¥½çš„ç†è§£æ± åŒ–æŠ€æœ¯çš„è½åœ°æ–¹æ¡ˆï¼Œä¹Ÿèƒ½ä¸ºä»¥ååšæ­¤ç±»åŠŸèƒ½æ—¶ï¼Œæœ‰ä¸€ä¸ªå¯è½åœ°çš„å…·ä½“æ–¹æ¡ˆã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [æ± åŒ–è¿æ¥æ± æ‰§è¡Œè¿‡ç¨‹ @JabesYang](https://t.zsxq.com/05AiEAMfu)
- [ä¸ºä»€ä¹ˆè¦è¿›è¡Œæ•°æ®åº“çš„æ± åŒ–å‘¢ï¼Ÿ @æ™“ä¼Ÿ](https://t.zsxq.com/05JUnEYrR)
- [é‡æ–°è®¾ç½®æ•°æ®æºå±æ€§çš„æ—¶å€™ï¼Œå¼ºåˆ¶å…³é—­æ´»è·ƒè¿æ¥å’Œç©ºé—²è¿æ¥ @æ¬§é˜³å®‡](https://t.zsxq.com/05JujAQZn)