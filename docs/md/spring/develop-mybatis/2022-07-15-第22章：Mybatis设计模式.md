---
title: ã€ç•ªå¤–ã€‘ç¬¬22ç« ï¼šMybatis æ¡†æ¶æºç 10ç§è®¾è®¡æ¨¡å¼åˆ†æ
lock: need
---

# ã€ç•ªå¤–ã€‘ç¬¬22ç« ï¼šMybatis æ¡†æ¶æºç 10ç§è®¾è®¡æ¨¡å¼åˆ†æ

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€ï¼šå°é•‡å·ç å®¶

æ€»æœ‰ä¸å°‘ç ”å‘ä¼™ä¼´é—®å°å‚…å“¥ï¼šâ€œä¸ºä»€ä¹ˆå­¦è®¾è®¡æ¨¡å¼ã€çœ‹æ¡†æ¶æºç ã€è¡¥æŠ€æœ¯çŸ¥è¯†ï¼Œå°±ä¸€ä¸ªæ™®é€šçš„ä¸šåŠ¡é¡¹ç›®ï¼Œä¼šé€ é£æœºä¸ä¹Ÿæ˜¯å¤©å¤©å†™CRUDå—ï¼Ÿâ€

ä½ è¯´çš„æ²¡é”™ï¼Œä½†ä½ å¤©å¤©å†™CRUDï¼Œä½ è§‰å¾— **çƒ¦ä¸ï¼Ÿ** **æ…Œä¸ï¼Ÿ** æ˜¯ä¸æ˜¯æ—¢æ‹…å¿ƒè‡ªå·±æ²¡æœ‰å¾—åˆ°æŠ€æœ¯æˆé•¿ï¼Œä¹Ÿå®³æ€•å°†æ¥æ²¡æ³•ç”¨è¿™äº›éƒ½æ˜¯CRUDçš„é¡¹ç›®å»å‚åŠ ï¼›è¿°èŒã€æ™‹å‡ã€ç­”è¾©ï¼Œç”šè‡³å¯èƒ½è¦è¢«è¿«é¢è¯•æ—¶ï¼Œè‡ªå·±æ‰‹é‡Œä¸€ç‚¹å¹²è´§ä¹Ÿæ²¡æœ‰çš„æƒ…å†µã€‚

æ‰€ä»¥ä½ /æˆ‘ä½œä¸ºä¸€ä¸ª**å°é•‡å·ç å®¶**ï¼Œå½“ç„¶è¦æ‰©å……è‡ªå·±çš„çŸ¥è¯†å‚¨å¤‡ï¼Œå¦åˆ™`æ¶æ„ï¼Œæ¶æ„æ€ç»´ä¸æ‡‚`ã€`è®¾è®¡ï¼Œè®¾è®¡æ¨¡å¼ä¸ä¼š`ã€`æºç ã€æºç å­¦ä¹ ä¸æ·±`ï¼Œæœ€åå°±ç”¨ä¸€å †CRUDå†™ç®€å†å—ï¼Ÿ

## äºŒã€æºç ï¼šå­¦è®¾è®¡æ¨¡å¼

åœ¨ Mybatis ä¸¤ä¸‡å¤šè¡Œçš„æ¡†æ¶æºç å®ç°ä¸­ï¼Œä½¿ç”¨äº†å¤§é‡çš„è®¾è®¡æ¨¡å¼æ¥è§£è€¦å·¥ç¨‹æ¶æ„ä¸­é¢å¯¹å¤æ‚åœºæ™¯çš„è®¾è®¡ï¼Œè¿™äº›æ˜¯è®¾è®¡æ¨¡å¼çš„å·§å¦™ä½¿ç”¨æ‰æ˜¯æ•´ä¸ªæ¡†æ¶çš„ç²¾åï¼Œ**è¿™ä¹Ÿæ˜¯å°å‚…å“¥å–œæ¬¢å·æºç çš„é‡è¦åŸå› **ã€‚ç»è¿‡å°å‚…å“¥çš„æ•´ç†æœ‰å¦‚ä¸‹10ç§è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ï¼Œå¦‚å›¾æ‰€ç¤º

![Mybatis æ¡†æ¶æºç 10ç§è®¾è®¡æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-01.png)

è®²é“ç†ï¼Œå¦‚æœåªæ˜¯æŠŠè¿™10ç§è®¾è®¡æ¨¡å¼èƒŒä¸‹æ¥ï¼Œç­‰ç€ä¸‹æ¬¡é¢è¯•çš„æ—¶å€™æ‹¿å‡ºæ¥è¯´ä¸€è¯´ï¼Œè™½ç„¶èƒ½æœ‰ç‚¹å¸®åŠ©ï¼Œä¸è¿‡è¿™ç§å­¦ä¹ æ–¹å¼å°±çœŸçš„ç®—æ˜¯æŠŠè·¯èµ°çª„äº†ã€‚å°±åƒä½ æ¯è¯´ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œèƒ½è”æƒ³åˆ°è¿™ä¸ªè®¾è®¡æ¨¡å¼åœ¨Mybatisçš„æ¡†æ¶ä¸­ï¼Œä½“ç°åˆ°å“ªä¸ªæµç¨‹ä¸­çš„æºç å®ç°ä¸Šäº†å—ï¼Ÿè¿™ä¸ªæºç å®ç°çš„æ€è·¯èƒ½ä¸èƒ½ç”¨åˆ°ä½ çš„ä¸šåŠ¡æµç¨‹å¼€å‘é‡Œï¼Ÿ**åˆ«æ€»è¯´ä½ çš„æµç¨‹ç®€å•ï¼Œç”¨ä¸ä¸Šè®¾è®¡æ¨¡å¼ï¼éš¾åº¦å› ä¸ºæœ‰é’±ã€å¯ŒäºŒä»£ï¼Œå°±ä¸è€ƒè¯•å—ï¼ŸğŸ¤”**

å¥½å•¦ï¼Œä¸æ‰¯æ·¡äº†ï¼Œæ¥ä¸‹æ¥å°å‚…å“¥å°±ä»¥[ã€Šæ‰‹å†™Mybatisï¼šæ¸è¿›å¼æºç å®è·µã€‹](https://gitcode.net/KnowledgePlanet/doc/-/wikis/home)çš„å­¦ä¹ ï¼Œç»™å¤§å®¶åˆ—ä¸¾å‡ºè¿™10ç§è®¾è®¡æ¨¡å¼ï¼Œåœ¨Mybatisæ¡†æ¶ä¸­éƒ½ä½“ç°åœ¨å“ªé‡Œäº†ï¼

- å­¦ä¹ æ‰‹å†Œï¼š`å…³æ³¨å…¬ä¼—å·ã€bugstackè™«æ´æ ˆã€‘å›å¤ã€Mybatisã€‘`
- æºç ä»“åº“ï¼š[https://gitcode.net/KnowledgePlanet/doc/-/wikis/home](https://gitcode.net/KnowledgePlanet/doc/-/wikis/home)

## ä¸‰ã€ç±»å‹ï¼šåˆ›å»ºå‹æ¨¡å¼

### 1. å·¥å‚æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.SqlSessionFactory`

```java
public interface SqlSessionFactory {

   SqlSession openSession();

}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.defaults.DefaultSqlSessionFactory`

```java
public class DefaultSqlSessionFactory implements SqlSessionFactory {

    private final Configuration configuration;

    public DefaultSqlSessionFactory(Configuration configuration) {
        this.configuration = configuration;
    }

    @Override
    public SqlSession openSession() {
        Transaction tx = null;
        try {
            final Environment environment = configuration.getEnvironment();
            TransactionFactory transactionFactory = environment.getTransactionFactory();
            tx = transactionFactory.newTransaction(configuration.getEnvironment().getDataSource(), TransactionIsolationLevel.READ_COMMITTED, false);
            // åˆ›å»ºæ‰§è¡Œå™¨
            final Executor executor = configuration.newExecutor(tx);
            // åˆ›å»ºDefaultSqlSession
            return new DefaultSqlSession(configuration, executor);
        } catch (Exception e) {
            try {
                assert tx != null;
                tx.close();
            } catch (SQLException ignore) {
            }
            throw new RuntimeException("Error opening session.  Cause: " + e);
        }
    }

}
```

![Mybatis å·¥å‚æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-02.png)

- **å·¥å‚æ¨¡å¼**ï¼šç®€å•å·¥å‚ï¼Œæ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶åœ¨çˆ¶ç±»ä¸­æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œå…è®¸å­ç±»å†³å®šå®ä¾‹å¯¹è±¡çš„ç±»å‹ã€‚
- **åœºæ™¯ä»‹ç»**ï¼š`SqlSessionFactory` æ˜¯è·å–ä¼šè¯çš„å·¥å‚ï¼Œæ¯æ¬¡æˆ‘ä»¬ä½¿ç”¨ Mybatis æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œéƒ½ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„ä¼šè¯ã€‚åœ¨ä¼šè¯å·¥å‚çš„å®ç°ä¸­è´Ÿè´£è·å–æ•°æ®æºç¯å¢ƒé…ç½®ä¿¡æ¯ã€æ„å»ºäº‹åŠ¡å·¥å‚ã€åˆ›å»ºæ“ä½œSQLçš„æ‰§è¡Œå™¨ï¼Œå¹¶æœ€ç»ˆè¿”å›ä¼šè¯å®ç°ç±»ã€‚
- **åŒç±»è®¾è®¡**ï¼š`SqlSessionFactory`ã€`ObjectFactory`ã€`MapperProxyFactory`ã€`DataSourceFactory`

### 2. å•ä¾‹æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.Configuration`

```java
public class Configuration {

    // ç¼“å­˜æœºåˆ¶ï¼Œé»˜è®¤ä¸é…ç½®çš„æƒ…å†µæ˜¯ SESSION
    protected LocalCacheScope localCacheScope = LocalCacheScope.SESSION;

    // æ˜ å°„æ³¨å†Œæœº
    protected MapperRegistry mapperRegistry = new MapperRegistry(this);

    // æ˜ å°„çš„è¯­å¥ï¼Œå­˜åœ¨Mapé‡Œ
    protected final Map<String, MappedStatement> mappedStatements = new HashMap<>();
    // ç¼“å­˜,å­˜åœ¨Mapé‡Œ
    protected final Map<String, Cache> caches = new HashMap<>();
    // ç»“æœæ˜ å°„ï¼Œå­˜åœ¨Mapé‡Œ
    protected final Map<String, ResultMap> resultMaps = new HashMap<>();
    protected final Map<String, KeyGenerator> keyGenerators = new HashMap<>();

    // æ’ä»¶æ‹¦æˆªå™¨é“¾
    protected final InterceptorChain interceptorChain = new InterceptorChain();

    // ç±»å‹åˆ«åæ³¨å†Œæœº
    protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry();
    protected final LanguageDriverRegistry languageRegistry = new LanguageDriverRegistry();

    // ç±»å‹å¤„ç†å™¨æ³¨å†Œæœº
    protected final TypeHandlerRegistry typeHandlerRegistry = new TypeHandlerRegistry();

    // å¯¹è±¡å·¥å‚å’Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚
    protected ObjectFactory objectFactory = new DefaultObjectFactory();
    protected ObjectWrapperFactory objectWrapperFactory = new DefaultObjectWrapperFactory();

    protected final Set<String> loadedResources = new HashSet<>();
 
    //...
}
```

![Mybatis å•ä¾‹æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-03.png)

- **å•ä¾‹æ¨¡å¼**ï¼šæ˜¯ä¸€ç§åˆ›å»ºå‹æ¨¡å¼ï¼Œè®©ä½ èƒ½å¤Ÿä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€èŠ‚ç‚¹ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šConfiguration å°±åƒç‹—çš®è†è¯ä¸€æ ·å¤§å•ä¾‹ï¼Œè´¯ç©¿æ•´ä¸ªä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥çš„é…ç½®å¯¹è±¡ï¼›æ˜ å°„ã€ç¼“å­˜ã€å…¥å‚ã€å‡ºå‚ã€æ‹¦æˆªå™¨ã€æ³¨å†Œæœºã€å¯¹è±¡å·¥å‚ç­‰ï¼Œéƒ½åœ¨ Configuration é…ç½®é¡¹ä¸­åˆå§‹åŒ–ã€‚å¹¶éšç€ SqlSessionFactoryBuilder æ„å»ºé˜¶æ®µå®Œæˆå®ä¾‹åŒ–æ“ä½œã€‚
- **åŒç±»åœºæ™¯**ï¼š`ErrorContext`ã€`LogFactory`ã€`Configuration`

### 3. å»ºé€ è€…æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.mapping.ResultMap#Builder`

```java
public class ResultMap {

    private String id;
    private Class<?> type;
    private List<ResultMapping> resultMappings;
    private Set<String> mappedColumns;

    private ResultMap() {
    }

    public static class Builder {
        private ResultMap resultMap = new ResultMap();

        public Builder(Configuration configuration, String id, Class<?> type, List<ResultMapping> resultMappings) {
            resultMap.id = id;
            resultMap.type = type;
            resultMap.resultMappings = resultMappings;
        }

        public ResultMap build() {
            resultMap.mappedColumns = new HashSet<>();
            // step-13 æ–°å¢åŠ ï¼Œæ·»åŠ  mappedColumns å­—æ®µ
            for (ResultMapping resultMapping : resultMap.resultMappings) {
                final String column = resultMapping.getColumn();
                if (column != null) {
                    resultMap.mappedColumns.add(column.toUpperCase(Locale.ENGLISH));
                }
            }
            return resultMap;
        }

    }
    
    // ... get
}
```

![Mybatis å»ºé€ è€…æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-04.png)

- **å»ºé€ è€…æ¨¡å¼**ï¼šä½¿ç”¨å¤šä¸ªç®€å•çš„å¯¹è±¡ä¸€æ­¥ä¸€æ­¥æ„å»ºæˆä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œè¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šå…³äºå»ºé€ è€…æ¨¡å¼åœ¨ Mybatis æ¡†æ¶é‡Œçš„ä½¿ç”¨ï¼Œé‚£çœŸæ˜¯çº±çª—æ“¦å±è‚¡ï¼Œç»™ä½ æ¼äº†ä¸€æ‰‹ã€‚åˆ°å¤„éƒ½æ˜¯ XxxxBuilderï¼Œæ‰€æœ‰å…³äº XML æ–‡ä»¶çš„è§£æåˆ°å„ç±»å¯¹è±¡çš„å°è£…ï¼Œéƒ½ä½¿ç”¨å»ºé€ è€…ä»¥åŠå»ºé€ è€…åŠ©æ‰‹æ¥å®Œæˆå¯¹è±¡çš„å°è£…ã€‚å®ƒçš„æ ¸å¿ƒç›®çš„å°±æ˜¯ä¸å¸Œæœ›æŠŠè¿‡å¤šçš„å…³äºå¯¹è±¡çš„å±æ€§è®¾ç½®ï¼Œå†™åˆ°å…¶ä»–ä¸šåŠ¡æµç¨‹ä¸­ï¼Œè€Œæ˜¯ç”¨å»ºé€ è€…çš„æ–¹å¼æä¾›æœ€ä½³çš„è¾¹ç•Œéš”ç¦»ã€‚
- **åŒç±»åœºæ™¯**ï¼š`SqlSessionFactoryBuilder`ã€`XMLConfigBuilder`ã€`XMLMapperBuilder`ã€`XMLStatementBuilder`ã€`CacheBuilder`

## å››ã€ç±»å‹ï¼šç»“æ„å‹æ¨¡å¼

### 1. é€‚é…å™¨æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.logging.Log`

```java
public interface Log {

  boolean isDebugEnabled();

  boolean isTraceEnabled();

  void error(String s, Throwable e);

  void error(String s);

  void debug(String s);

  void trace(String s);

  void warn(String s);

}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.logging.slf4j.Slf4jImpl`

```java
public class Slf4jImpl implements Log {

  private Log log;

  public Slf4jImpl(String clazz) {
    Logger logger = LoggerFactory.getLogger(clazz);

    if (logger instanceof LocationAwareLogger) {
      try {
        // check for slf4j >= 1.6 method signature
        logger.getClass().getMethod("log", Marker.class, String.class, int.class, String.class, Object[].class, Throwable.class);
        log = new Slf4jLocationAwareLoggerImpl((LocationAwareLogger) logger);
        return;
      } catch (SecurityException e) {
        // fail-back to Slf4jLoggerImpl
      } catch (NoSuchMethodException e) {
        // fail-back to Slf4jLoggerImpl
      }
    }

    // Logger is not LocationAwareLogger or slf4j version < 1.6
    log = new Slf4jLoggerImpl(logger);
  }

  @Override
  public boolean isDebugEnabled() {
    return log.isDebugEnabled();
  }

  @Override
  public boolean isTraceEnabled() {
    return log.isTraceEnabled();
  }

  @Override
  public void error(String s, Throwable e) {
    log.error(s, e);
  }

  @Override
  public void error(String s) {
    log.error(s);
  }

  @Override
  public void debug(String s) {
    log.debug(s);
  }

  @Override
  public void trace(String s) {
    log.trace(s);
  }

  @Override
  public void warn(String s) {
    log.warn(s);
  }

}
```

![Mybatis é€‚é…å™¨æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-05.png)

- **é€‚é…å™¨æ¨¡å¼**ï¼šæ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒèƒ½ä½¿æ¥å£ä¸å…¼å®¹çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’åˆä½œã€‚
- **åœºæ™¯ä»‹ç»**ï¼šæ­£æ˜¯å› ä¸ºæœ‰å¤ªå¤šçš„æ—¥å¿—æ¡†æ¶ï¼ŒåŒ…æ‹¬ï¼šLog4jã€Log4j2ã€Slf4Jç­‰ç­‰ï¼Œè€Œè¿™äº›æ—¥å¿—æ¡†æ¶çš„ä½¿ç”¨æ¥å£åˆéƒ½å„æœ‰å·®å¼‚ï¼Œä¸ºäº†ç»Ÿä¸€è¿™äº›æ—¥å¿—å·¥å…·çš„æ¥å£ï¼ŒMybatis å®šä¹‰äº†ä¸€å¥—ç»Ÿä¸€çš„æ—¥å¿—æ¥å£ï¼Œä¸ºæ‰€æœ‰çš„å…¶ä»–æ—¥å¿—å·¥å…·æ¥å£åšç›¸åº”çš„é€‚é…æ“ä½œã€‚
- **åŒç±»åœºæ™¯**ï¼šä¸»è¦é›†ä¸­åœ¨å¯¹æ—¥å¿—çš„é€‚é…ä¸Šï¼ŒLog å’Œ å¯¹åº”çš„å®ç°ç±»ï¼Œä»¥åŠåœ¨ LogFactory å·¥å‚æ–¹æ³•ä¸­è¿›è¡Œä½¿ç”¨ã€‚

### 2. ä»£ç†æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.binding.MapperProxy`

```java
public class MapperProxy<T> implements InvocationHandler, Serializable {

    private static final long serialVersionUID = -6424540398559729838L;

    private SqlSession sqlSession;
    private final Class<T> mapperInterface;
    private final Map<Method, MapperMethod> methodCache;

    public MapperProxy(SqlSession sqlSession, Class<T> mapperInterface, Map<Method, MapperMethod> methodCache) {
        this.sqlSession = sqlSession;
        this.mapperInterface = mapperInterface;
        this.methodCache = methodCache;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, args);
        } else {
            final MapperMethod mapperMethod = cachedMapperMethod(method);
            return mapperMethod.execute(sqlSession, args);
        }
    }
    
    // ...

}
```

![Mybatis ä»£ç†æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-06.png)

- **ä»£ç†æ¨¡å¼**ï¼šæ˜¯ä¸€ç§ç»“æ„å‹æ¨¡å¼ï¼Œè®©ä½ èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“æˆ–å…¶å ä½ç¬¦ã€‚ä»£ç†æ§åˆ¶ç€å¯¹åŸå¯¹è±¡çš„è®¿é—®ï¼Œå¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰è¿›è¡Œä¸€äº›å¤„ç†ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šä¸å¹ç‰›çš„è®²ï¼Œæ²¡æœ‰ä»£ç†æ¨¡å¼ï¼Œå°±ä¸ä¼šæœ‰å„ç±»çš„æ¡†æ¶å­˜åœ¨ã€‚å°±åƒ Mybatis ä¸­çš„ MapperProxy æ˜ å°„å™¨ä»£ç†å®ç°ç±»ï¼Œå®ƒæ‰€å®ç°çš„åŠŸèƒ½å°±æ˜¯å¸®åŠ©æˆ‘ä»¬å®Œæˆ DAO æ¥å£çš„å…·ä½“å®ç°ç±»çš„æ–¹æ³•æ“ä½œï¼Œä½ çš„ä»»ä½•ä¸€ä¸ªé…ç½®çš„ DAO æ¥å£æ‰€è°ƒç”¨çš„ CRUD æ–¹æ³•ï¼Œéƒ½ä¼šè¢« MapperProxy æ¥ç®¡ï¼Œè°ƒç”¨åˆ°æ–¹æ³•æ‰§è¡Œå™¨ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œå¹¶è¿”å›æœ€ç»ˆçš„æ•°æ®åº“æ‰§è¡Œç»“æœã€‚
- **åŒç±»åœºæ™¯**ï¼š`DriverProxy`ã€`Plugin`ã€`Invoker`ã€`MapperProxy`

### 3. ç»„åˆæ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.scripting.xmltags.SqlNode`

```java
public interface SqlNode {

    boolean apply(DynamicContext context);

}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.scripting.xmltags.IfSqlNode`

```java
public class IfSqlNode implements SqlNode{

    private ExpressionEvaluator evaluator;
    private String test;
    private SqlNode contents;

    public IfSqlNode(SqlNode contents, String test) {
        this.test = test;
        this.contents = contents;
        this.evaluator = new ExpressionEvaluator();
    }

    @Override
    public boolean apply(DynamicContext context) {
        // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™applyï¼Œå¹¶è¿”å›true
        if (evaluator.evaluateBoolean(test, context.getBindings())) {
            contents.apply(context);
            return true;
        }
        return false;
    }

}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.scripting.xmltags.XMLScriptBuilder`

```java
public class XMLScriptBuilder extends BaseBuilder {

    private void initNodeHandlerMap() {
        // 9ç§ï¼Œå®ç°å…¶ä¸­2ç§ trim/where/set/foreach/if/choose/when/otherwise/bind
        nodeHandlerMap.put("trim", new TrimHandler());
        nodeHandlerMap.put("if", new IfHandler());
    }
 
    List<SqlNode> parseDynamicTags(Element element) {
        List<SqlNode> contents = new ArrayList<>();
        List<Node> children = element.content();
        for (Node child : children) {
            if (child.getNodeType() == Node.TEXT_NODE || child.getNodeType() == Node.CDATA_SECTION_NODE) {

            } else if (child.getNodeType() == Node.ELEMENT_NODE) {
                String nodeName = child.getName();
                NodeHandler handler = nodeHandlerMap.get(nodeName);
                if (handler == null) {
                    throw new RuntimeException("Unknown element " + nodeName + " in SQL statement.");
                }
                handler.handleNode(element.element(child.getName()), contents);
                isDynamic = true;
            }
        }
        return contents;
    }
    
    // ...
}
```

**é…ç½®è¯¦è§**ï¼š`resources/mapper/Activity_Mapper.xml`

```xml
<select id="queryActivityById" parameterType="cn.bugstack.mybatis.test.po.Activity" resultMap="activityMap" flushCache="false" useCache="true">
    SELECT activity_id, activity_name, activity_desc, create_time, update_time
    FROM activity
    <trim prefix="where" prefixOverrides="AND | OR" suffixOverrides="and">
        <if test="null != activityId">
            activity_id = #{activityId}
        </if>
    </trim>
</select>
```

![Mybatis ç»„åˆæ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-07.png)

- **ç»„åˆæ¨¡å¼**ï¼šæ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒå°†å¯¹è±¡ç»„åˆæˆæ ‘çŠ¶ç»“æ„ï¼Œå¹¶ä¸”èƒ½ç‹¬ç«‹ä½¿ç”¨å¯¹è±¡ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šåœ¨ Mybatis XML åŠ¨æ€çš„ SQL é…ç½®ä¸­ï¼Œå…±æä¾›äº†9ç§(trim/where/set/foreach/if/choose/when/otherwise/bind)æ ‡ç­¾çš„ä½¿ç”¨ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç»„åˆå‡ºå„ç±»åœºæ™¯çš„ SQL è¯­å¥ã€‚è€Œ SqlNode æ¥å£çš„å®ç°å°±æ˜¯æ¯ä¸€ä¸ªç»„åˆç»“æ„ä¸­çš„è§„åˆ™èŠ‚ç‚¹ï¼Œé€šè¿‡è§„åˆ™èŠ‚ç‚¹çš„ç»„è£…å®Œæˆä¸€é¢—è§„åˆ™æ ‘ç»„åˆæ¨¡å¼çš„ä½¿ç”¨ã€‚*å…·ä½“ä½¿ç”¨æºç å¯ä»¥é˜…è¯»[ã€Šæ‰‹å†™Mybatisï¼šæ¸è¿›å¼æºç å®è·µã€‹](https://bugstack.cn/md/spring/develop-mybatis/2022-06-28-%E7%AC%AC16%E7%AB%A0%EF%BC%9A%E8%A7%A3%E6%9E%90%E5%90%AB%E6%A0%87%E7%AD%BE%E7%9A%84%E5%8A%A8%E6%80%81SQL%E8%AF%AD%E5%8F%A5.html)*
- **åŒç±»åœºæ™¯**ï¼šä¸»è¦ä½“ç°åœ¨å¯¹å„ç±»SQLæ ‡ç­¾çš„è§£æä¸Šï¼Œä»¥å®ç° SqlNode æ¥å£çš„å„ä¸ªå­ç±»ä¸ºä¸»ã€‚

### 4. è£…é¥°å™¨æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.session.Configuration`

```java
public Executor newExecutor(Transaction transaction) {
    Executor executor = new SimpleExecutor(this, transaction);
    // é…ç½®å¼€å¯ç¼“å­˜ï¼Œåˆ›å»º CachingExecutor(é»˜è®¤å°±æ˜¯æœ‰ç¼“å­˜)è£…é¥°è€…æ¨¡å¼
    if (cacheEnabled) {
        executor = new CachingExecutor(executor);
    }
    return executor;
}
```

![Mybatis è£…é¥°å™¨æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-08.png)

- **è£…é¥°å™¨æ¨¡å¼**ï¼šæ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå…è®¸ä½ é€šè¿‡å°†å¯¹è±¡æ”¾å…¥åŒ…å«è¡Œä¸ºçš„ç‰¹æ®Šå°è£…å¯¹è±¡ä¸­æ¥ä¸ºåŸå¯¹è±¡ç»‘å®šæ–°çš„è¡Œä¸ºã€‚
- **åœºæ™¯ä»‹ç»**ï¼šMybatis çš„æ‰€æœ‰ SQL æ“ä½œï¼Œéƒ½æ˜¯ç»è¿‡ SqlSession ä¼šè¯è°ƒç”¨ SimpleExecutor  ç®€å•å®ç°çš„æ‰§è¡Œå™¨å®Œæˆçš„ï¼Œè€Œä¸€çº§ç¼“å­˜çš„æ“ä½œä¹Ÿæ˜¯åœ¨ç®€å•æ‰§è¡Œå™¨ä¸­å¤„ç†ã€‚é‚£ä¹ˆè¿™é‡ŒäºŒçº§ç¼“å­˜å› ä¸ºæ˜¯åŸºäºä¸€çº§ç¼“å­˜åˆ·æ–°æ“ä½œçš„ï¼Œæ‰€ä»¥åœ¨å®ç°ä¸Šï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªç¼“å­˜æ‰§è¡Œå™¨ï¼ŒåŒ…è£…ç®€å•æ‰§è¡Œå™¨çš„å¤„ç†é€»è¾‘ï¼Œå®ç°äºŒçº§ç¼“å­˜æ“ä½œã€‚é‚£ä¹ˆè¿™é‡Œç”¨åˆ°çš„å°±æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œä¹Ÿå«ä¿„ç½—æ–¯å¥—å¨ƒæ¨¡å¼ã€‚
- **åŒç±»åœºæ™¯**ï¼šä¸»è¦æå‰åœ¨ Cache ç¼“å­˜æ¥å£çš„å®ç°å’Œ CachingExecutor æ‰§è¡Œå™¨ä¸­ã€‚

## äº”ã€ç±»å‹ï¼šè¡Œä¸ºå‹æ¨¡å¼

### 1. æ¨¡æ¿æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.BaseExecutor`

```java
public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
    if (closed) {
        throw new RuntimeException("Executor was closed.");
    }
    // æ¸…ç†å±€éƒ¨ç¼“å­˜ï¼ŒæŸ¥è¯¢å †æ ˆä¸º0åˆ™æ¸…ç†ã€‚queryStack é¿å…é€’å½’è°ƒç”¨æ¸…ç†
    if (queryStack == 0 && ms.isFlushCacheRequired()) {
        clearLocalCache();
    }
    List<E> list;
    try {
        queryStack++;
        // æ ¹æ®cacheKeyä»localCacheä¸­æŸ¥è¯¢æ•°æ®
        list = resultHandler == null ? (List<E>) localCache.getObject(key) : null;
        if (list == null) {
            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
        }
    } finally {
        queryStack--;
    }
    if (queryStack == 0) {
        if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
            clearLocalCache();
        }
    }
    return list;
}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.executor.SimpleExecutor`

```java
protected int doUpdate(MappedStatement ms, Object parameter) throws SQLException {
    Statement stmt = null;
    try {
        Configuration configuration = ms.getConfiguration();
        // æ–°å»ºä¸€ä¸ª StatementHandler
        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);
        // å‡†å¤‡è¯­å¥
        stmt = prepareStatement(handler);
        // StatementHandler.update
        return handler.update(stmt);
    } finally {
        closeStatement(stmt);
    }
}
```

![Mybatis æ¨¡æ¿æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-09.png)

- **æ¨¡æ¿æ¨¡å¼**ï¼šæ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œå®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œå…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šåªè¦å­˜åœ¨ä¸€ç³»åˆ—å¯è¢«æ ‡å‡†å®šä¹‰çš„æµç¨‹ï¼Œåœ¨æµç¨‹çš„æ­¥éª¤å¤§éƒ¨åˆ†æ˜¯é€šç”¨é€»è¾‘ï¼Œåªæœ‰ä¸€å°‘éƒ¨åˆ†æ˜¯éœ€è¦å­ç±»å®ç°çš„ï¼Œé‚£ä¹ˆé€šå¸¸ä¼šé‡‡ç”¨æ¨¡æ¿æ¨¡å¼æ¥å®šä¹‰å‡ºè¿™ä¸ªæ ‡å‡†çš„æµç¨‹ã€‚å°±åƒ Mybatis çš„ BaseExecutor å°±æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰æ¨¡æ¿æ¨¡å¼çš„æŠ½è±¡ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­æŠŠæŸ¥è¯¢ã€ä¿®æ”¹çš„æ“ä½œéƒ½å®šä¹‰å‡ºäº†ä¸€å¥—æ ‡å‡†çš„æµç¨‹ã€‚
- **åŒç±»åœºæ™¯**ï¼š`BaseExecutor`ã€`SimpleExecutor`ã€`BaseTypeHandler`

### 2. ç­–ç•¥æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.TypeHandler`

```java
public interface TypeHandler<T> {

    /**
     * è®¾ç½®å‚æ•°
     */
    void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;

    /**
     * è·å–ç»“æœ
     */
    T getResult(ResultSet rs, String columnName) throws SQLException;

    /**
     * å–å¾—ç»“æœ
     */
    T getResult(ResultSet rs, int columnIndex) throws SQLException;

}
```

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.LongTypeHandler`

```java
public class LongTypeHandler extends BaseTypeHandler<Long> {

    @Override
    protected void setNonNullParameter(PreparedStatement ps, int i, Long parameter, JdbcType jdbcType) throws SQLException {
        ps.setLong(i, parameter);
    }

    @Override
    protected Long getNullableResult(ResultSet rs, String columnName) throws SQLException {
        return rs.getLong(columnName);
    }

    @Override
    public Long getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
        return rs.getLong(columnIndex);
    }

}
```

![Mybatis ç­–ç•¥æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-10.png)

- **ç­–ç•¥æ¨¡å¼**ï¼šæ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œå®ƒèƒ½å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ç§ç®—æ³•åˆ†åˆ«æ”¾å…¥ç‹¬ç«‹çš„ç±»ä¸­ï¼Œä»¥ä½¿ç®—æ³•çš„å¯¹è±¡èƒ½å¤Ÿäº’ç›¸æ›¿æ¢ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šåœ¨ Mybatis å¤„ç† JDBC æ‰§è¡Œåè¿”å›çš„ç»“æœæ—¶ï¼Œéœ€è¦æŒ‰ç…§ä¸åŒçš„ç±»å‹è·å–å¯¹åº”çš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å¤§é‡çš„ if åˆ¤æ–­ã€‚æ‰€ä»¥è¿™é‡ŒåŸºäº TypeHandler æ¥å£å¯¹æ¯ä¸ªå‚æ•°ç±»å‹åˆ†åˆ«åšäº†è‡ªå·±çš„ç­–ç•¥å®ç°ã€‚
- **åŒç±»åœºæ™¯**ï¼š`PooledDataSource\UnpooledDataSource`ã€`BatchExecutor\ResuseExecutor\SimpleExector\CachingExecutor`ã€`LongTypeHandler\StringTypeHandler\DateTypeHandler`

### 3. è¿­ä»£å™¨æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.reflection.property.PropertyTokenizer`

```java
public class PropertyTokenizer implements Iterable<PropertyTokenizer>, Iterator<PropertyTokenizer> {

    public PropertyTokenizer(String fullname) {
        // ç­çº§[0].å­¦ç”Ÿ.æˆç»©
        // æ‰¾è¿™ä¸ªç‚¹ .
        int delim = fullname.indexOf('.');
        if (delim > -1) {
            name = fullname.substring(0, delim);
            children = fullname.substring(delim + 1);
        } else {
            // æ‰¾ä¸åˆ°.çš„è¯ï¼Œå–å…¨éƒ¨éƒ¨åˆ†
            name = fullname;
            children = null;
        }
        indexedName = name;
        // æŠŠä¸­æ‹¬å·é‡Œçš„æ•°å­—ç»™è§£æå‡ºæ¥
        delim = name.indexOf('[');
        if (delim > -1) {
            index = name.substring(delim + 1, name.length() - 1);
            name = name.substring(0, delim);
        }
    }

		// ...

}
```

![Mybatis è¿­ä»£å™¨æ¨¡å¼](https://bugstack.cn/images/article/spring/mybatis-220715-11.png)

- **è¿­ä»£å™¨æ¨¡å¼**ï¼šæ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œè®©ä½ èƒ½åœ¨ä¸æš´éœ²é›†åˆåº•å±‚è¡¨ç°å½¢å¼çš„æƒ…å†µä¸‹éå†é›†åˆä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚
- **åœºæ™¯ä»‹ç»**ï¼šPropertyTokenizer æ˜¯ç”¨äº Mybatis æ¡†æ¶ MetaObject åå°„å·¥å…·åŒ…ä¸‹ï¼Œç”¨äºè§£æå¯¹è±¡å…³ç³»çš„è¿­ä»£æ“ä½œã€‚è¿™ä¸ªç±»åœ¨ Mybatis æ¡†æ¶ä¸­ä½¿ç”¨çš„éå¸¸é¢‘ç¹ï¼ŒåŒ…æ‹¬è§£ææ•°æ®æºé…ç½®ä¿¡æ¯å¹¶å¡«å……åˆ°æ•°æ®æºç±»ä¸Šï¼Œä»¥åŠå‚æ•°çš„è§£æã€å¯¹è±¡çš„è®¾ç½®éƒ½ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚
- **åŒç±»åœºæ™¯**ï¼š`PropertyTokenizer`

## å…­ã€æ€»ç»“ï¼šâ€œå·ç‹â€çš„å¿ƒå¾—

ä¸€ä»½æºç çš„æˆä½“ç³»æ‹†è§£æ¸è¿›å¼å­¦ä¹ ï¼Œå¯èƒ½éœ€è¦1~2ä¸ªæœˆçš„æ—¶é—´ï¼Œç›¸æ¯”äºçˆ½æ–‡å’Œç–²äºåº”è¯•è¦èŠ±è´¹æ›´å¤šçš„ç»å†ã€‚ä½†ä½ æ€»ä¼šåœ¨ä¸€ä¸ªå¤§å—æ—¶é—´å­¦ä¹ å®Œåï¼Œä¼šåœ¨è‡ªå·±çš„å¤´è„‘ä¸­æ„å»ºå‡ºä¸€å¥—å®Œæ•´ä½“ç³»å…³äºæ­¤ç±»çŸ¥è¯†çš„æŠ€æœ¯æ¶æ„ï¼Œæ— è®ºä»å“ªé‡Œå…¥å£ä½ éƒ½èƒ½æ¸…æ¥šå„ä¸ªåˆ†æ”¯æµç¨‹çš„èµ°å‘ï¼Œè¿™ä¹Ÿæ˜¯ä½ æˆä¸ºæŠ€æœ¯ä¸“å®¶è·¯ä¸Šçš„æ·±åº¦å­¦ä¹ ã€‚

å¦‚æœä½ ä¹Ÿæƒ³æœ‰è¿™æ ·é…£ç•…æ·‹æ¼“çš„å­¦ä¹ ï¼Œåƒä¸‡åˆ«é”™è¿‡å‚…å“¥ä¸ºä½ ç¼–å†™çš„èµ„æ–™[ã€Šæ‰‹å†™Mybatisï¼šæ¸è¿›å¼æºç å®è·µã€‹](https://bugstack.cn/md/spring/develop-mybatis/2022-03-20-%E7%AC%AC1%E7%AB%A0%EF%BC%9A%E5%BC%80%E7%AF%87%E4%BB%8B%E7%BB%8D%EF%BC%8C%E6%89%8B%E5%86%99Mybatis%E8%83%BD%E7%BB%99%E4%BD%A0%E5%B8%A6%E6%9D%A5%E4%BB%80%E4%B9%88%EF%BC%9F.html)ç›®å½•å¦‚å›¾æ‰€ç¤ºï¼Œå…±è®¡20ç« 

![ã€Šæ‰‹å†™Mybatisï¼šæ¸è¿›å¼æºç å®è·µã€‹](https://bugstack.cn/images/article/spring/mybatis-220708-03.png)