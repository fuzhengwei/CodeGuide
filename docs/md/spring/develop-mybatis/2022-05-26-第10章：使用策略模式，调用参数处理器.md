---
title: ç¬¬10ç« ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œè°ƒç”¨å‚æ•°å¤„ç†å™¨
lock: need
---

# ã€ŠMybatis æ‰‹æ’¸ä¸“æ ã€‹ç¬¬10ç« ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œè°ƒç”¨å‚æ•°å¤„ç†å™¨

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/f-1g66RrbDeJI5tmHQykHg](https://mp.weixin.qq.com/s/f-1g66RrbDeJI5tmHQykHg)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=344648924&bvid=BV12d4y1P756&cid=809802013&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`ä½ è¿™ä»£ç å†™çš„ï¼Œå’‹è¿™ä¹ˆè½´å‘¢ï¼`

è¯´åˆ°è½´ï¼Œè®©æˆ‘æƒ³èµ·åˆä¸­ä¸Šå­¦æ—¶è€å¸ˆè¯´çš„è¯ï¼š**â€œä½ é‚£è„‘ç“œå­ï¼Œå’‹è·Ÿæ‰‹ç„–å­ä¼¼çš„ï¼â€** ä¸œåŒ—è¯æ‰‹ç„–å­å°±æ˜¯é‚£ç§å†¬å¤©æˆ´çš„å¤§æ£‰æ‰‹å¥—ï¼Œæ£‰æ‰‹å¥—é‡Œçš„æ£‰èŠ±éƒ½è¢«å‹çš„åˆæ²‰åˆç¡¬çš„äº†ï¼Œæ‰€ä»¥æ¥æ¯”å–»è„‘ç“œå­ç¬¨ã€‚

è€Œå†™è½´ä»£ç çš„å¤§éƒ¨åˆ†éƒ½æ˜¯åˆšæ¯•ä¸šæ²¡å¤šä¹…ï¼Œæˆ–è€…åˆšå¼€å§‹å·¥ä½œçš„ç å†œï¼Œæ¯•ç«Ÿç»éªŒä¸è¶³ç»å†ä¸å¤šï¼Œå†™å‡ºä¸€äº›ä¸å¤ªå¥½ç»´æŠ¤çš„ä»£ç ä¹Ÿæƒ…æœ‰å¯åŸã€‚è€Œé‚£äº›ç»å¤§å¤šæ•°é”»ç‚¼å‡ºæ¥çš„è€ç å†œï¼Œå…¶å®ä»£ç çš„ç¨³å®šç¨‹åº¦ã€è®¾è®¡ç»éªŒã€ç¼œå¯†é€»è¾‘ï¼Œéƒ½æ˜¯ç›¸å¯¹æ¥è¯´è¦å¥½å¾ˆå¤šçš„ã€‚*å½“ç„¶ä¸€éƒ¨åˆ†è€ç å†œï¼Œåªæ˜¯è€äº†è€Œå·²ï¼Œä»£ç è¿˜æ˜¯é‚£ä¸ªä»£ç ï¼*

æ‰€ä»¥ä¼ä¸šæ‹›è˜äº›å¹´è½»äººï¼Œéœ€è¦å¹´è½»çš„æ€æƒ³ã€‚ä½†æ²¡å¿…è¦åš¯åš¯åªæ˜¯å¤´å‘æ²¡å¤šå°‘çš„è€ç å†œï¼Œå¦åˆ™è°æ¥ç»™ä½ å¹³ç¨³è½åœ°ä½ é‚£äº›å¤©é©¬è¡Œç©ºçš„æƒ³æ³•å‘¢ï¼éš¾é“ä½“éªŒã€ç¨³å®šã€æµç•…ï¼Œä¸åº”è¯¥æ˜¯æ›´å€¼å¾—è¿½æ±‚çš„ï¼Œéå¾—å–œæ¬¢å…¨æ˜¯æ„£å¤´é’ä¼¼çš„ä»£ç ï¼Œå†™å‡ºå‡ ç™¾ä¸ªbugï¼Œé€ æˆå¤§é‡èµ„æŸå’Œå®¢è¯‰ï¼Œè®©è€æ¿è§‰å¾—å¾ˆçˆ½ï¼Ÿ

## äºŒã€ç›®æ ‡

ä¸Šä¸€ç« èŠ‚ï¼Œå°å‚…å“¥å¸¦ç€å¤§å®¶ç»†åŒ–çš„ XML è¯­å¥æ„å»ºå™¨ï¼Œè§£è€¦åœ¨è§£æ XML ä¸­çš„æ‰€éœ€è¦å¤„ç†çš„ Mapper ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼›SQLã€å…¥å‚ã€å‡ºå‚ã€ç±»å‹ï¼Œå¹¶å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œè®°å½•åˆ° ParameterMapping å‚æ•°æ˜ å°„å¤„ç†ç±»ä¸­ã€‚é‚£ä¹ˆè¿™ä¸ªä¸€ç« èŠ‚æˆ‘ä»¬å°†ç»“åˆè¿™éƒ¨åˆ†å‚æ•°çš„æå–ï¼Œå¯¹æ‰§è¡Œçš„ SQL è¿›è¡Œå‚æ•°çš„è‡ªåŠ¨åŒ–è®¾ç½®ï¼Œè€Œä¸æ˜¯åƒæˆ‘ä»¬ä¹‹å‰é‚£æ ·æŠŠå‚æ•°å†™æˆå›ºå®šçš„ï¼Œå¦‚å›¾ 10-1 æ‰€ç¤º

![å›¾ 10-1 ç¡¬ç¼–ç å‚æ•°è®¾ç½®](https://bugstack.cn/images/article/spring/mybatis-220526-10-01.png)

- åœ¨æµç¨‹ä¸Šï¼Œé€šè¿‡ DefaultSqlSession#selectOne æ–¹æ³•è°ƒç”¨æ‰§è¡Œå™¨ï¼Œå¹¶é€šè¿‡é¢„å¤„ç†è¯­å¥å¤„ç†å™¨ PreparedStatementHandler æ‰§è¡Œå‚æ•°è®¾ç½®å’Œç»“æœæŸ¥è¯¢ã€‚
- é‚£ä¹ˆè¿™ä¸ªæµç¨‹ä¸­æˆ‘ä»¬æ‰€å¤„ç†çš„å‚æ•°ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª SQL æ‰§è¡Œæ—¶ï¼Œé‚£äº›`?å·` éœ€è¦è¢«æ›¿æ¢çš„åœ°æ–¹ï¼Œç›®å‰æ˜¯é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼è¿›è¡Œå¤„ç†çš„ã€‚è€Œè¿™å°±æ˜¯æœ¬ç« èŠ‚éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œå¦‚æœåªæ˜¯ç¡¬ç¼–ç å®Œæˆå‚æ•°è®¾ç½®ï¼Œé‚£ä¹ˆå¯¹äºæ‰€æœ‰å“ªäº›ä¸åŒç±»å‹çš„å‚æ•°å°±æ²¡æ³•è¿›è¡Œæ“ä½œäº†ã€‚
- æ‰€ä»¥æœ¬ç« èŠ‚éœ€è¦ç»“åˆç»“åˆä¸Šä¸€ç« èŠ‚æ‰€å®Œæˆçš„è¯­å¥æ„å»ºå™¨å¯¹ SQL å‚æ•°ä¿¡æ¯çš„æ‹†è§£ï¼Œæœ¬ç« å°†ä¼šæŒ‰ç…§è¿™äº›å‚æ•°çš„è§£æï¼Œå¤„ç†è¿™é‡Œç¡¬ç¼–ç ä¸ºè‡ªåŠ¨åŒ–ç±»å‹è®¾ç½®ã€‚*é’ˆå¯¹ä¸åŒç±»å‹çš„å‚æ•°è®¾ç½®ï¼Œè¿™éƒ¨åˆ†ä½¿ç”¨äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼å‘¢ï¼Ÿ*

## ä¸‰ã€è®¾è®¡

è¿™é‡Œå¯ä»¥æ€è€ƒğŸ¤”ä¸‹ï¼Œå‚æ•°çš„å¤„ç†ä¹Ÿå°±æ˜¯é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ JDBC ç›´æ¥æ“ä½œæ•°æ®åº“æ—¶ï¼Œæ‰€ä½¿ç”¨ `ps.setXxx(i, parameter);` è®¾ç½®çš„å„ç±»å‚æ•°ã€‚é‚£ä¹ˆåœ¨è‡ªåŠ¨åŒ–è§£æ XML ä¸­ SQL æ‹†åˆ†å‡ºæ‰€æœ‰çš„å‚æ•°ç±»å‹åï¼Œåˆ™åº”è¯¥æ ¹æ®ä¸åŒçš„å‚æ•°è¿›è¡Œä¸åŒçš„ç±»å‹è®¾ç½®ï¼Œä¹Ÿå°±ï¼›`Long è°ƒç”¨ ps.setLong`ã€`String è°ƒç”¨ ps.setString` æ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**ï¼Œåœ¨è§£æ SQL æ—¶æŒ‰ç…§ä¸åŒçš„æ‰§è¡Œç­–ç•¥ï¼Œå°è£…è¿›å»ç±»å‹å¤„ç†å™¨ï¼ˆ*ä¹Ÿå°±æ˜¯æ˜¯å®ç° TypeHandler<T> æ¥å£çš„è¿‡ç¨‹*ï¼‰ã€‚æ•´ä½“è®¾è®¡å¦‚å›¾ 10-2 æ‰€ç¤º

![å›¾ 10-2 ç­–ç•¥æ¨¡å¼å¤„ç†å‚æ•°å¤„ç†å™¨](https://bugstack.cn/images/article/spring/mybatis-220526-10-02.png)

- å…¶å®å…³äºå‚æ•°çš„å¤„ç†ï¼Œå› ä¸ºæœ‰å¾ˆå¤šçš„ç±»å‹(`Long\String\Object\...`)ï¼Œæ‰€ä»¥è¿™é‡Œæœ€é‡è¦çš„ä½“ç°åˆ™æ˜¯ç­–ç•¥æ¨¡å¼çš„ä½¿ç”¨ã€‚
- è¿™é‡ŒåŒ…æ‹¬äº†æ„å»ºå‚æ•°æ—¶æ ¹æ®ç±»å‹ï¼Œé€‰æ‹©å¯¹åº”çš„ç­–ç•¥ç±»å‹å¤„ç†å™¨ï¼Œå¡«å……åˆ°å‚æ•°æ˜ å°„é›†åˆä¸­ã€‚å¦å¤–ä¸€æ–¹é¢æ˜¯å‚æ•°çš„ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œ DefaultSqlSession#selectOne çš„é“¾è·¯ä¸­ï¼ŒåŒ…æ‹¬äº†å‚æ•°çš„è®¾ç½®ï¼ŒæŒ‰ç…§å‚æ•°çš„ä¸åŒç±»å‹ï¼Œè·å–å‡ºå¯¹åº”çš„å¤„ç†å™¨ï¼Œä»¥åŠå…¥å‚å€¼ã€‚*æ³¨æ„ï¼šç”±äºå…¥å‚å€¼å¯èƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ä¸­çš„å±æ€§ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†å‰é¢ç« èŠ‚å®ç°çš„åå°„ç±»å·¥å…· MetaObject è¿›è¡Œå€¼çš„è·å–ï¼Œé¿å…ç”±äºåŠ¨æ€çš„å¯¹è±¡ï¼Œæ²¡æ³•ç¡¬ç¼–ç è·å–å±æ€§å€¼ã€‚*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
mybatis-step-09
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”‚   â”œâ”€â”€ MapperMethod.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java
    â”‚           â”‚   â””â”€â”€ MapperRegistry.java
    â”‚           â”œâ”€â”€ builder
    â”‚           â”‚   â”œâ”€â”€ xml
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLConfigBuilder.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLMapperBuilder.java
    â”‚           â”‚   â”‚   â””â”€â”€ XMLStatementBuilder.java
    â”‚           â”‚   â”œâ”€â”€ BaseBuilder.java
    â”‚           â”‚   â”œâ”€â”€ ParameterExpression.java
    â”‚           â”‚   â”œâ”€â”€ SqlSourceBuilder.java
    â”‚           â”‚   â””â”€â”€ StaticSqlSource.java
    â”‚           â”œâ”€â”€ datasource
    â”‚           â”œâ”€â”€ executor
    â”‚           â”‚   â”œâ”€â”€ resultset
    â”‚           â”‚   â”‚   â””â”€â”€ ParameterHandler.java
    â”‚           â”‚   â”œâ”€â”€ resultset
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultResultSetHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ ResultSetHandler.java
    â”‚           â”‚   â”œâ”€â”€ statement
    â”‚           â”‚   â”‚   â”œâ”€â”€ BaseStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ PreparedStatementHandler.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ SimpleStatementHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ StatementHandler.java
    â”‚           â”‚   â”œâ”€â”€ BaseExecutor.java
    â”‚           â”‚   â”œâ”€â”€ Executor.java
    â”‚           â”‚   â””â”€â”€ SimpleExecutor.java
    â”‚           â”œâ”€â”€ io
    â”‚           â”œâ”€â”€ mapping
    â”‚           â”‚   â”œâ”€â”€ BoundSql.java
    â”‚           â”‚   â”œâ”€â”€ Environment.java
    â”‚           â”‚   â”œâ”€â”€ MappedStatement.java
    â”‚           â”‚   â”œâ”€â”€ ParameterMapping.java
    â”‚           â”‚   â”œâ”€â”€ SqlCommandType.java
    â”‚           â”‚   â””â”€â”€ SqlSource.java
    â”‚           â”œâ”€â”€ parsing
    â”‚           â”œâ”€â”€ reflection
    â”‚           â”œâ”€â”€ scripting
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultParameterHandler.java
    â”‚           â”‚   â”‚   â””â”€â”€ RawSqlSource.java
    â”‚           â”‚   â”œâ”€â”€ xmltags
    â”‚           â”‚   â”‚   â”œâ”€â”€ DynamicContext.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ MixedSqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ SqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ StaticTextSqlNode.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ XMLLanguageDriver.java
    â”‚           â”‚   â”‚   â””â”€â”€ XMLScriptBuilder.java
    â”‚           â”‚   â”œâ”€â”€ LanguageDriver.java
    â”‚           â”‚   â””â”€â”€ LanguageDriverRegistry.java
    â”‚           â”œâ”€â”€ session
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSqlSession.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Configuration.java
    â”‚           â”‚   â”œâ”€â”€ ResultHandler.java
    â”‚           â”‚   â”œâ”€â”€ SqlSession.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactoryBuilder.java
    â”‚           â”‚   â””â”€â”€ TransactionIsolationLevel.java
    â”‚           â”œâ”€â”€ transaction
    â”‚           â””â”€â”€ type
    â”‚               â”œâ”€â”€ BaseTypeHandler.java
    â”‚               â”œâ”€â”€ JdbcType.java
    â”‚               â”œâ”€â”€ LongTypeHandler.java
    â”‚               â”œâ”€â”€ StringTypeHandler.java
    â”‚               â”œâ”€â”€ TypeAliasRegistry.java
    â”‚               â”œâ”€â”€ TypeHandler.java
    â”‚               â””â”€â”€ TypeHandlerRegistry.java
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ cn.bugstack.mybatis.test.dao
        â”‚       â”œâ”€â”€ dao
        â”‚       â”‚   â””â”€â”€ IUserDao.java
        â”‚       â”œâ”€â”€ po
        â”‚       â”‚   â””â”€â”€ User.java
        â”‚       â””â”€â”€ ApiTest.java
        â””â”€â”€ resources
            â”œâ”€â”€ mapper
            â”‚   â””â”€â”€User_Mapper.xml
            â””â”€â”€ mybatis-config-datasource.xml
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šæ‰‹å†™Mybatisï¼Œè·å–å®Œæ•´æºç `

ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œå¤„ç†å‚æ•°å¤„ç†å™¨æ ¸å¿ƒç±»å…³ç³»ï¼Œå¦‚å›¾ 10-3 æ‰€ç¤º

![å›¾ 10-3 ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œå¤„ç†å‚æ•°å¤„ç†å™¨æ ¸å¿ƒç±»å…³ç³»](https://bugstack.cn/images/article/spring/mybatis-220526-10-03.png)

æ ¸å¿ƒå¤„ç†ä¸»è¦åˆ†ä¸ºä¸‰å—ï¼›ç±»å‹å¤„ç†ã€å‚æ•°è®¾ç½®ã€å‚æ•°ä½¿ç”¨ï¼›
- ä»¥å®šä¹‰ TypeHandler ç±»å‹å¤„ç†å™¨ç­–ç•¥æ¥å£ï¼Œå®ç°ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼›Longã€Stringã€Integer ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆåªå®ç°2ç§ç±»å‹ï¼Œè¯»è€…åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æŒ‰ç…§è¿™ä¸ªç»“æ„æ¥æ·»åŠ å…¶ä»–ç±»å‹ã€‚
- ç±»å‹ç­–ç•¥å¤„ç†å™¨å®ç°å®Œæˆåï¼Œéœ€è¦æ³¨å†Œåˆ°å¤„ç†å™¨æ³¨å†Œæœºä¸­ï¼Œåç»­å…¶ä»–æ¨¡å—å‚æ•°çš„è®¾ç½®è¿˜æ˜¯ä½¿ç”¨éƒ½æ˜¯ä» Configuration ä¸­è·å–åˆ° TypeHandlerRegistry è¿›è¡Œä½¿ç”¨ã€‚
- é‚£ä¹ˆæœ‰äº†è¿™æ ·çš„ç­–ç•¥å¤„ç†å™¨ä»¥åï¼Œåœ¨è¿›è¡Œæ“ä½œè§£æ SQL çš„æ—¶å€™ï¼Œå°±å¯ä»¥æŒ‰ç…§ä¸åŒçš„ç±»å‹æŠŠå¯¹åº”çš„ç­–ç•¥å¤„ç†å™¨è®¾ç½®åˆ° BoundSql#parameterMappings å‚æ•°é‡Œï¼Œåç»­ä½¿ç”¨ä¹Ÿæ˜¯ä»è¿™é‡Œè¿›è¡Œè·å–ã€‚

### 2. å…¥å‚æ•°æ ¡å‡†

è¿™é‡Œæˆ‘ä»¬è¦å…ˆè§£å†³ä¸€ä¸ªå°é—®é¢˜ï¼Œä¸çŸ¥é“è¯»è€…åœ¨æˆ‘ä»¬æ‰€å®ç°çš„æºç ä¸­ï¼Œæ˜¯å¦æ³¨æ„åˆ°è¿™æ ·ä¸€ä¸ªå‚æ•°çš„ä¼ é€’ï¼Œå¦‚å›¾ 10-4 

![å›¾ 10-4 å‚æ•°è®¾ç½®æ—¶å…¥å‚è·å–](https://bugstack.cn/images/article/spring/mybatis-220526-10-04.png)

- è¿™é‡Œçš„å‚æ•°ä¼ é€’åï¼Œéœ€è¦è·å–ç¬¬0ä¸ªå‚æ•°ï¼Œè€Œä¸”æ˜¯ç¡¬ç¼–ç å›ºå®šçš„ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªç¬¬0ä¸ªå‚æ•°æ˜¯å“ªæ¥çš„ï¼Œæˆ‘ä»¬æ¥å£é‡Œé¢è°ƒç”¨çš„æ–¹æ³•ï¼Œå‚æ•°ä¸æ˜¯ä¸€ä¸ªå—ï¼Ÿå°±åƒï¼š`User queryUserInfoById(Long id);`
- å…¶å®è¿™ä¸ªå‚æ•°æ¥è‡ªäºæ˜ å°„å™¨ä»£ç†ç±» MapperProxy#invoke ä¸­ï¼Œå› ä¸º invoke åå°„è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¥å‚ä¸­æ˜¯ Object[] argsï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°è¢«ä¼ é€’åˆ°åç»­çš„å‚æ•°è®¾ç½®ä¸­ã€‚è€Œæˆ‘ä»¬çš„ DAO æµ‹è¯•ç±»æ˜¯ä¸€ä¸ªå·²çŸ¥çš„å›ºå®šå‚æ•°ï¼Œæ‰€ä»¥åé¢ç¡¬ç¼–ç äº†è·å–äº†ç¬¬0ä¸ªå‚æ•°ã€‚
  ![](https://bugstack.cn/images/article/spring/mybatis-220526-10-05.png)
  - JDK åå°„è°ƒç”¨æ–¹æ³•æ“ä½œå›ºå®šæ–¹æ³•å…¥å‚
- é‚£ä¹ˆç»“åˆè¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬åˆ™éœ€è¦æ ¹æ®æ–¹æ³•çš„ä¿¡æ¯ï¼Œç»™æ–¹æ³•åšç­¾åæ“ä½œï¼Œä»¥ä¾¿äºè½¬æ¢å…¥å‚ä¿¡æ¯ä¸ºæ–¹æ³•çš„ä¿¡æ¯ã€‚æ¯”å¦‚æ•°ç»„è½¬æ¢ä¸ºå¯¹åº”çš„å¯¹è±¡ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.binding.MapperMethod`

```java
public class MapperMethod {

    public Object execute(SqlSession sqlSession, Object[] args) {
        Object result = null;
        switch (command.getType()) {
            case SELECT:
                Object param = method.convertArgsToSqlCommandParam(args);
                result = sqlSession.selectOne(command.getName(), param);
                break;
            default:
                throw new RuntimeException("Unknown execution method for: " + command.getName());
        }
        return result;
    }

    /**
     * æ–¹æ³•ç­¾å
     */
    public static class MethodSignature {

        public Object convertArgsToSqlCommandParam(Object[] args) {
            final int paramCount = params.size();
            if (args == null || paramCount == 0) {
                // å¦‚æœæ²¡å‚æ•°
                return null;
            } else if (paramCount == 1) {
                return args[params.keySet().iterator().next().intValue()];
            } else {
                // å¦åˆ™ï¼Œè¿”å›ä¸€ä¸ªParamMapï¼Œä¿®æ”¹å‚æ•°åï¼Œå‚æ•°åå°±æ˜¯å…¶ä½ç½®
                final Map<String, Object> param = new ParamMap<Object>();
                int i = 0;
                for (Map.Entry<Integer, String> entry : params.entrySet()) {
                    // 1.å…ˆåŠ ä¸€ä¸ª#{0},#{1},#{2}...å‚æ•°
                    param.put(entry.getValue(), args[entry.getKey().intValue()]);
                    // ...
                }
                return param;
            }
        }

    }
}
```

- åœ¨æ˜ å°„å™¨æ–¹æ³•ä¸­ MapperMethod#execute å°†åŸæ¥çš„ç›´æ¥å°†å‚æ•° args ä¼ é€’ç»™ SqlSession#selectOne æ–¹æ³•ï¼Œè°ƒæ•´ä¸ºè½¬æ¢åå†ä¼ é€’å¯¹è±¡ã€‚
- å…¶å®è¿™é‡Œçš„è½¬æ¢æ“ä½œå°±æ˜¯æ¥è‡ªäº Method#getParameterTypes å¯¹å‚æ•°çš„è·å–å’Œå¤„ç†ï¼Œä¸ args è¿›è¡Œæ¯”å¯¹ã€‚å¦‚æœæ˜¯å•ä¸ªå‚æ•°ï¼Œåˆ™ç›´æ¥è¿”å›å‚æ•° Tree æ ‘ç»“æ„ä¸‹çš„å¯¹åº”èŠ‚ç‚¹å€¼ã€‚éå•ä¸ªç±»å‹ï¼Œåˆ™éœ€è¦è¿›è¡Œå¾ªç¯å¤„ç†ï¼Œè¿™æ ·è½¬æ¢åçš„å‚æ•°æ‰èƒ½è¢«ç›´æ¥ä½¿ç”¨ã€‚

### 3. å‚æ•°ç­–ç•¥å¤„ç†å™¨

åœ¨ Mybatis çš„æºç åŒ…ä¸­ï¼Œæœ‰ä¸€ä¸ª type åŒ…ï¼Œè¿™ä¸ªåŒ…ä¸‹æ‰€æä¾›çš„å°±æ˜¯ä¸€å¥—å‚æ•°çš„å¤„ç†ç­–ç•¥é›†åˆã€‚å®ƒé€šè¿‡å®šä¹‰ç±»å‹å¤„ç†å™¨æ¥å£ã€ç”±æŠ½è±¡æ¨¡æ¿å®ç°å¹¶å®šä¹‰æ ‡å‡†æµç¨‹ï¼Œå®šæå–æŠ½è±¡æ–¹æ³•äº¤ç»™å­ç±»å®ç°ï¼Œè¿™äº›å­ç±»å°±æ˜¯å„ä¸ªç±»å‹å¤„ç†å™¨çš„å…·ä½“å®ç°ã€‚

#### 3.1 ç­–ç•¥æ¥å£

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.TypeHandler`

```java
public interface TypeHandler<T> {

    /**
     * è®¾ç½®å‚æ•°
     */
    void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;

}
```

- é¦–å…ˆå®šä¹‰ä¸€ä¸ªç±»å‹å¤„ç†å™¨çš„æ¥å£ï¼Œè¿™å’Œæˆ‘ä»¬åœ¨æ—¥å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­æ˜¯ç±»ä¼¼çš„ï¼Œå°±åƒå¦‚æœæ˜¯å‘è´§å•†å“ï¼Œåˆ™å®šä¹‰ä¸€ä¸ªç»Ÿä¸€æ ‡å‡†æ¥å£ï¼Œä¹‹åæ ¹æ®è¿™ä¸ªæ¥å£å®ç°å‡ºä¸åŒçš„å‘è´§ç­–ç•¥ã€‚
- è¿™é‡Œè®¾ç½®å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ‰€æœ‰ä¸åŒç±»å‹çš„å‚æ•°ï¼Œéƒ½å¯ä»¥è¢«æå–å‡ºæ¥è¿™äº›æ ‡å‡†çš„å‚æ•°å­—æ®µå’Œå¼‚å¸¸ï¼Œåç»­çš„å­ç±»æŒ‰ç…§è¿™ä¸ªæ ‡å‡†å®ç°å³å¯ã€‚*Mybatis æºç ä¸­æœ‰30+ä¸ªç±»å‹å¤„ç†*

#### 3.2 æ¨¡æ¿æ¨¡å¼

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.BaseTypeHandler`

```java
public abstract class BaseTypeHandler<T> implements TypeHandler<T> {

    @Override
    public void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException {
        // å®šä¹‰æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ä¸åŒç±»å‹çš„å±æ€§è®¾ç½®
        setNonNullParameter(ps, i, parameter, jdbcType);
    }

    protected abstract void setNonNullParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;

}
```

- é€šè¿‡æŠ½è±¡åŸºç±»çš„æµç¨‹æ¨¡æ¿å®šä¹‰ï¼Œä¾¿äºä¸€äº›å‚æ•°çš„åˆ¤æ–­å’Œå¤„ç†ã€‚ä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜ä¸éœ€è¦é‚£ä¹ˆå¤šçš„æµç¨‹æ ¡éªŒï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯å®šä¹‰å’Œè°ƒç”¨äº†ä¸€ä¸ªæœ€åŸºæœ¬çš„æŠ½è±¡æ–¹æ³• setNonNullParameterã€‚
- ä¸è¿‡æœ‰ä¸€ä¸ªè¿™æ ·çš„ç»“æ„ï¼Œå¯ä»¥è®©å¤§å®¶æ›´åŠ æ¸…æ¥šæ•´ä¸ª Mybatis æºç çš„æ¡†æ¶ï¼Œä¾¿äºåç»­é˜…è¯»æˆ–è€…æ‰©å±•æ­¤éƒ¨åˆ†æºç çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªæ¡†æ¶ç»“æ„çš„è®¤çŸ¥ã€‚

#### 3.3 å­ç±»å®ç°

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.*`

```java
/**
 * @description Longç±»å‹å¤„ç†å™¨
 */
public class LongTypeHandler extends BaseTypeHandler<Long> {

    @Override
    protected void setNonNullParameter(PreparedStatement ps, int i, Long parameter, JdbcType jdbcType) throws SQLException {
        ps.setLong(i, parameter);
    }

}

/**
 * @description Stringç±»å‹å¤„ç†å™¨
 */
public class StringTypeHandler extends BaseTypeHandler<String>{

    @Override
    protected void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException {
        ps.setString(i, parameter);
    }

}
```

- è¿™é‡Œçš„æ¥å£å®ç°ä¸¾äº†ä¸ªä¾‹å­ï¼Œåˆ†åˆ«æ˜¯ï¼›LongTypeHandlerã€StringTypeHandlerï¼Œåœ¨ Mybatis æºç ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦å®ç°é‚£ä¹ˆå¤šï¼Œåªè¦æ¸…æ¥šè¿™ä¸ªå¤„ç†è¿‡ç¨‹å’Œç¼–ç æ–¹å¼å³å¯ã€‚*å¤§å®¶åœ¨å­¦ä¹ ä¸­ï¼Œå¯ä»¥å°è¯•å†æ·»åŠ å‡ ä¸ªå…¶ä»–ç±»å‹ï¼Œç”¨äºå­¦ä¹ éªŒè¯*

#### 3.4 ç±»å‹æ³¨å†Œæœº

ç±»å‹å¤„ç†å™¨æ³¨å†Œæœº TypeHandlerRegistry æ˜¯æˆ‘ä»¬å‰é¢ç« èŠ‚å®ç°çš„ï¼Œè¿™é‡Œåªéœ€è¦åœ¨è¿™ä¸ªç±»ç»“æ„ä¸‹ï¼Œæ³¨å†Œæ–°çš„ç±»å‹å°±å¯ä»¥äº†ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.type.TypeHandlerRegistry`

```java
public final class TypeHandlerRegistry {

    private final Map<JdbcType, TypeHandler<?>> JDBC_TYPE_HANDLER_MAP = new EnumMap<>(JdbcType.class);
    private final Map<Type, Map<JdbcType, TypeHandler<?>>> TYPE_HANDLER_MAP = new HashMap<>();
    private final Map<Class<?>, TypeHandler<?>> ALL_TYPE_HANDLERS_MAP = new HashMap<>();

    public TypeHandlerRegistry() {
        register(Long.class, new LongTypeHandler());
        register(long.class, new LongTypeHandler());

        register(String.class, new StringTypeHandler());
        register(String.class, JdbcType.CHAR, new StringTypeHandler());
        register(String.class, JdbcType.VARCHAR, new StringTypeHandler());
    }
 
    //...
}    
```

- è¿™é‡Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ–°å¢åŠ äº† LongTypeHandlerã€StringTypeHandler ä¸¤ç§ç±»å‹çš„æ³¨å†Œå™¨ã€‚
- åŒæ—¶å¯ä»¥æ³¨æ„åˆ°ï¼Œæ— è®ºæ˜¯å¯¹è±¡ç±»å‹ï¼Œè¿˜æ˜¯åŸºæœ¬ç±»å‹ï¼Œéƒ½æ˜¯ä¸€ä¸ªç±»å‹å¤„ç†å™¨ã€‚åªä¸è¿‡åœ¨æ³¨å†Œçš„æ—¶å€™å¤šæ³¨å†Œäº†ä¸€ä¸ªã€‚*è¿™ç§æ“ä½œæ–¹å¼å’Œæˆ‘ä»¬å¹³å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä¸€ç§æ˜¯å¤šæ³¨å†Œï¼Œå¦å¤–ä¸€ç§æ˜¯åˆ¤æ–­å¤„ç†ã€‚*

### 4. å‚æ•°æ„å»º

ç›¸å¯¹äºå‰é¢ç« èŠ‚æ‰€å®Œæˆçš„å†…å®¹ï¼Œè¿™ä¸ªç« èŠ‚éœ€è¦å¯¹ SqlSourceBuilder æºç æ„å»ºå™¨ä¸­ï¼Œåˆ›å»ºå‚æ•°æ˜ å°„ ParameterMapping éœ€è¦æ·»åŠ å‚æ•°å¤„ç†å™¨çš„å†…å®¹ã€‚å› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½æ–¹ä¾¿çš„ä»å‚æ•°æ˜ å°„ä¸­è·å–åˆ°å¯¹åº”ç±»å‹çš„å¤„ç†å™¨è¿›è¡Œä½¿ç”¨ã€‚

é‚£ä¹ˆå°±éœ€è¦å®Œå–„ ParameterMapping æ·»åŠ  TypeHandler å±æ€§ä¿¡æ¯ï¼Œä»¥åŠåœ¨ ParameterMappingTokenHandler#buildParameterMapping å¤„ç†å‚æ•°æ˜ å°„æ—¶ï¼Œæ„å»ºå‡ºå‚æ•°çš„æ˜ å°„ã€‚è¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨ä¸Šä¸€ç« èŠ‚çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œç»†åŒ–çš„å®Œå–„éƒ¨åˆ†ï¼Œå¦‚å›¾ 10-6

![å›¾ 10-6 æ„å»ºå‚æ•°æ˜ å°„](https://bugstack.cn/images/article/spring/mybatis-220526-10-06.png)

é‚£ä¹ˆç»“åˆä¸Šä¸€ç« èŠ‚ï¼Œè¿™é‡Œæˆ‘ä»¬å¼€å§‹æ‰©å±•å‡ºç±»å‹çš„è®¾ç½®ã€‚*åŒæ—¶æ³¨æ„ MetaClass åå°„å·¥å…·ç±»çš„ä½¿ç”¨*

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.builder.SqlSourceBuilder`

```java
// æ„å»ºå‚æ•°æ˜ å°„
private ParameterMapping buildParameterMapping(String content) {
    // å…ˆè§£æå‚æ•°æ˜ å°„,å°±æ˜¯è½¬åŒ–æˆä¸€ä¸ª HashMap | #{favouriteSection,jdbcType=VARCHAR}
    Map<String, String> propertiesMap = new ParameterExpression(content);
    String property = propertiesMap.get("property");
    Class<?> propertyType;
    if (typeHandlerRegistry.hasTypeHandler(parameterType)) {
        propertyType = parameterType;
    } else if (property != null) {
        MetaClass metaClass = MetaClass.forClass(parameterType);
        if (metaClass.hasGetter(property)) {
            propertyType = metaClass.getGetterType(property);
        } else {
            propertyType = Object.class;
        }
    } else {
        propertyType = Object.class;
    }
    logger.info("æ„å»ºå‚æ•°æ˜ å°„ propertyï¼š{} propertyTypeï¼š{}", property, propertyType);
    ParameterMapping.Builder builder = new ParameterMapping.Builder(configuration, property, propertyType);
    return builder.build();
}
```

- è¿™ä¸€éƒ¨åˆ†å°±æ˜¯å¯¹å‚æ•°çš„ç»†åŒ–å¤„ç†ï¼Œæ„å»ºå‡ºå‚æ•°çš„æ˜ å°„å…³ç³»ï¼Œé¦–å…ˆæ˜¯ if åˆ¤æ–­å¯¹åº”çš„å‚æ•°ç±»å‹æ˜¯å¦åœ¨ TypeHandlerRegistry æ³¨å†Œå™¨ä¸­ï¼Œå¦‚æœä¸åœ¨åˆ™æ‹†è§£å¯¹è±¡ï¼ŒæŒ‰å±æ€§è¿›è¡Œè·å– propertyType çš„æ“ä½œã€‚
- è¿™ä¸€å—ä¹Ÿç”¨åˆ°äº† MetaClass åå°„å·¥å…·ç±»çš„ä½¿ç”¨ï¼Œå®ƒçš„å­˜åœ¨å¯ä»¥è®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„å¤„ç†ï¼Œå¦åˆ™è¿˜éœ€è¦è¦å†å†™åå°„ç±»è¿›è¡Œè·å–å¯¹è±¡å±æ€§æ“ä½œã€‚

### 5. å‚æ•°ä½¿ç”¨

å‚æ•°æ„å»ºå®Œæˆåï¼Œå°±å¯ä»¥åœ¨ DefaultSqlSession#selectOne è°ƒç”¨æ—¶è®¾ç½®å‚æ•°ä½¿ç”¨äº†ã€‚é‚£ä¹ˆè¿™é‡Œçš„é“¾è·¯å…³ç³»ï¼›`Executor#query - > SimpleExecutor#doQuery -> StatementHandler#parameterize -> PreparedStatementHandler#parameterize -> ParameterHandler#setParameters` åˆ°äº† ParameterHandler#setParameters å°±å¯ä»¥çœ‹åˆ°äº†æ ¹æ®å‚æ•°çš„ä¸åŒå¤„ç†å™¨å¾ªç¯è®¾ç½®å‚æ•°ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.scripting.defaults.DefaultParameterHandler`

```java
public class DefaultParameterHandler implements ParameterHandler {

    @Override
    public void setParameters(PreparedStatement ps) throws SQLException {
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        if (null != parameterMappings) {
            for (int i = 0; i < parameterMappings.size(); i++) {
                ParameterMapping parameterMapping = parameterMappings.get(i);
                String propertyName = parameterMapping.getProperty();
                Object value;
                if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                    value = parameterObject;
                } else {
                    // é€šè¿‡ MetaObject.getValue åå°„å–å¾—å€¼è®¾è¿›å»
                    MetaObject metaObject = configuration.newMetaObject(parameterObject);
                    value = metaObject.getValue(propertyName);
                }
                JdbcType jdbcType = parameterMapping.getJdbcType();

                // è®¾ç½®å‚æ•°
                logger.info("æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š{}", JSON.toJSONString(value));
                TypeHandler typeHandler = parameterMapping.getTypeHandler();
                typeHandler.setParameter(ps, i + 1, value, jdbcType);
            }
        }
    }

}
```

- æ¯ä¸€ä¸ªå¾ªç¯çš„å‚æ•°è®¾ç½®ï¼Œéƒ½æ˜¯ä» BoundSql ä¸­è·å– ParameterMapping é›†åˆè¿›è¡Œå¾ªç¯æ“ä½œï¼Œè€Œè¿™ä¸ªé›†åˆå‚æ•°å°±æ˜¯æˆ‘ä»¬å‰é¢ ParameterMappingTokenHandler#buildParameterMapping æ„å»ºå‚æ•°æ˜ å°„æ—¶å¤„ç†çš„ã€‚
- è®¾ç½®å‚æ•°æ—¶æ ¹æ®å‚æ•°çš„ parameterObject å…¥å‚çš„ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦åŸºæœ¬ç±»å‹ï¼Œå¦‚æœä¸æ˜¯åˆ™ä»å¯¹è±¡ä¸­è¿›è¡Œæ‹†è§£è·å–ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªå¯¹è±¡Aä¸­åŒ…æ‹¬å±æ€§bï¼‰ï¼Œå¤„ç†å®Œæˆåå°±å¯ä»¥å‡†ç¡®æ‹¿åˆ°å¯¹åº”çš„å…¥å‚å€¼äº†ã€‚*å› ä¸ºåœ¨æ˜ å°„å™¨æ–¹æ³• MapperMethod ä¸­å·²ç»å¤„ç†äº†ä¸€éæ–¹æ³•ç­¾åï¼Œæ‰€ä»¥è¿™é‡Œçš„å…¥å‚å°±æ›´æ–¹ä¾¿ä½¿ç”¨äº†*
- åŸºæœ¬ä¿¡æ¯è·å–å®Œæˆåï¼Œåˆ™æ ¹æ®å‚æ•°ç±»å‹è·å–åˆ°å¯¹åº”çš„ TypeHandler ç±»å‹å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯æ‰¾åˆ° LongTypeHandlerã€StringTypeHandler ç­‰ï¼Œç¡®å®šæ‰¾åˆ°ä»¥åï¼Œåˆ™å¯ä»¥è¿›è¡Œå¯¹åº”çš„å‚æ•°è®¾ç½®äº† typeHandler.setParameter(ps, i + 1, value, jdbcType) é€šè¿‡è¿™æ ·çš„æ–¹å¼æŠŠæˆ‘ä»¬ä¹‹å‰ç¡¬ç¼–ç çš„æ“ä½œè¿›è¡Œè§£è€¦ã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

#### 1.1 åˆ›å»ºåº“è¡¨

åˆ›å»ºä¸€ä¸ªæ•°æ®åº“åç§°ä¸º mybatis å¹¶åœ¨åº“ä¸­åˆ›å»ºè¡¨ user ä»¥åŠæ·»åŠ æµ‹è¯•æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
CREATE TABLE
    USER
    (
        id bigint NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
        userId VARCHAR(9) COMMENT 'ç”¨æˆ·ID',
        userHead VARCHAR(16) COMMENT 'ç”¨æˆ·å¤´åƒ',
        createTime TIMESTAMP NULL COMMENT 'åˆ›å»ºæ—¶é—´',
        updateTime TIMESTAMP NULL COMMENT 'æ›´æ–°æ—¶é—´',
        userName VARCHAR(64),
        PRIMARY KEY (id)
    )
    ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
insert into user (id, userId, userHead, createTime, updateTime, userName) values (1, '10001', '1_04', '2022-04-13 00:00:00', '2022-04-13 00:00:00', 'å°å‚…å“¥');    
```

#### 1.2 é…ç½®æ•°æ®æº

```xml
<environments default="development">
    <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="POOLED">
            <property name="driver" value="com.mysql.jdbc.Driver"/>
            <property name="url" value="jdbc:mysql://127.0.0.1:3306/mybatis?useUnicode=true"/>
            <property name="username" value="root"/>
            <property name="password" value="123456"/>
        </dataSource>
    </environment>
</environments>
```

- é€šè¿‡ `mybatis-config-datasource.xml` é…ç½®æ•°æ®æºä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šdriverã€urlã€usernameã€password
- åœ¨è¿™é‡Œ dataSource å¯ä»¥æŒ‰éœ€é…ç½®æˆ DRUIDã€UNPOOLED å’Œ POOLED è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚

#### 1.3 é…ç½®Mapper

```xml
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>

<select id="queryUserInfo" parameterType="cn.bugstack.mybatis.test.po.User" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id} and userId = #{userId}
</select>
```

- è¿™éƒ¨åˆ†æš‚æ—¶ä¸éœ€è¦è°ƒæ•´ï¼Œç›®å‰è¿˜åªæ˜¯ä¸€ä¸ªå…¥å‚çš„ç±»å‹çš„å‚æ•°ï¼Œåç»­æˆ‘ä»¬å…¨éƒ¨å®Œå–„è¿™éƒ¨åˆ†å†…å®¹ä»¥åï¼Œåˆ™å†æä¾›æ›´å¤šçš„å…¶ä»–å‚æ•°è¿›è¡ŒéªŒè¯ã€‚

### 2. å•å…ƒæµ‹è¯•

**æºç è¯¦è§**ï¼š`cn.bugstack.mybatis.test.ApiTest`

```java
@Before
public void init() throws IOException {
    // 1. ä»SqlSessionFactoryä¸­è·å–SqlSession
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(Resources.getResourceAsReader("mybatis-config-datasource.xml"));
    sqlSession = sqlSessionFactory.openSession();
}
```

- å› ä¸ºæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦éªŒè¯ä¸¤ç§ä¸åŒå…¥å‚çš„å•å…ƒæµ‹è¯•ï¼Œåˆ†åˆ«æ¥æµ‹è¯•åŸºæœ¬ç±»å‹å‚æ•°å’Œå¯¹è±¡ç±»å‹å‚æ•°ã€‚

#### 2.1 åŸºæœ¬ç±»å‹å‚æ•°

```java
@Test
public void test_queryUserInfoById() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    // 2. æµ‹è¯•éªŒè¯ï¼šåŸºæœ¬å‚æ•°
    User user = userDao.queryUserInfoById(1L);
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(user));
}
```

![](https://bugstack.cn/images/article/spring/mybatis-220526-10-07.png)

```java
07:40:08.531 [main] INFO  c.b.mybatis.builder.SqlSourceBuilder - æ„å»ºå‚æ•°æ˜ å°„ propertyï¼šid propertyTypeï¼šclass java.lang.Long
07:40:08.598 [main] INFO  c.b.m.s.defaults.DefaultSqlSession - æ‰§è¡ŒæŸ¥è¯¢ statementï¼šcn.bugstack.mybatis.test.dao.IUserDao.queryUserInfoById parameterï¼š1
07:40:08.875 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 183284570.
07:40:08.894 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š1
07:40:08.961 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
```

- æµ‹è¯•è¿‡ç¨‹ä¸­å¯ä»¥åœ¨ DefaultParameterHandler#setParameters ä¸­æ‰“æ–­ç‚¹ï¼ŒéªŒè¯æ–¹æ³•å‚æ•°ä»¥åŠè·å¾—åˆ°çš„ç±»å‹å¤„ç†å™¨ï¼Œè¿™é‡Œæµ‹è¯•éªŒè¯é€šè¿‡ï¼Œå¯ä»¥æ»¡è¶³åŸºæœ¬ç±»å‹å¯¹è±¡çš„å…¥å‚ä¿¡æ¯ã€‚

#### 2.2 å¯¹è±¡ç±»å‹å‚æ•°

```java
@Test
public void test_queryUserInfo() {
    // 1. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    // 2. æµ‹è¯•éªŒè¯ï¼šå¯¹è±¡å‚æ•°
    User user = userDao.queryUserInfo(new User(1L, "10001"));
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(user));
}
```

![](https://bugstack.cn/images/article/spring/mybatis-220526-10-08.png)

```java
07:41:11.025 [main] INFO  c.b.mybatis.builder.SqlSourceBuilder - æ„å»ºå‚æ•°æ˜ å°„ propertyï¼šuserId propertyTypeï¼šclass java.lang.String
07:41:11.232 [main] INFO  c.b.m.s.defaults.DefaultSqlSession - æ‰§è¡ŒæŸ¥è¯¢ statementï¼šcn.bugstack.mybatis.test.dao.IUserDao.queryUserInfo parameterï¼š{"id":1,"userId":"10001"}
07:41:11.638 [main] INFO  c.b.m.d.pooled.PooledDataSource - Created connection 402405659.
07:41:11.661 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š1
07:43:28.516 [main] INFO  c.b.m.s.d.DefaultParameterHandler - æ ¹æ®æ¯ä¸ªParameterMappingä¸­çš„TypeHandlerè®¾ç½®å¯¹åº”çš„å‚æ•°ä¿¡æ¯ valueï¼š"10001"
07:43:30.820 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}
```

- æ­¤æ¡ˆä¾‹ä¸»è¦éªŒè¯å¯¹è±¡å‚æ•° User ä¸­åŒ…å«ä¸¤ä¸ªå±æ€§æ—¶ï¼Œæ£€æŸ¥æˆ‘ä»¬çš„ä»£ç å¤„ç†è¿‡ç¨‹ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥æ­£ç¡®è·å–åˆ°ä¸¤ä¸ªç±»å‹å¤„ç†å™¨ï¼Œåˆ†åˆ«è®¾ç½®å‚æ•°çš„è¿‡ç¨‹ã€‚
- ä»æµ‹è¯•ç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•é€šè¿‡ï¼Œå¹¶æ‰“å°äº†ç›¸å…³å‚æ•°çš„æ„å»ºå’Œä½¿ç”¨ã€‚

## å…­ã€æ€»ç»“

- åˆ°æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ç®—æ˜¯æŠŠä¸€ä¸ª ORM æ¡†æ¶çš„åŸºæœ¬æµç¨‹ä¸²è”èµ·æ¥äº†ï¼Œä¸è¦ç¡¬ç¼–ç ä¹Ÿèƒ½å®Œæˆç®€å• SQL çš„å¤„ç†ã€‚è¯»è€…ä¼™ä¼´å¯ä»¥ä»”ç»†é˜…è¯»ä¸‹å½“å‰æ¡†æ¶ä¸­ï¼Œæ‰€åŒ…å«çš„åˆ†åŒ…ç»“æ„ã€‚æ¯”å¦‚ï¼šæ„å»ºã€ç»‘å®šã€æ˜ å°„ã€åå°„ã€æ‰§è¡Œã€ç±»å‹ã€äº‹åŠ¡ã€æ•°æ®æºç­‰ç­‰ï¼Œå°è¯•ç”»ä¸€ç”»ä»–ä»¬çš„é“¾æ¥å…³ç³»ï¼Œè¿™æ ·ä¼šè®©ä½ æ›´åŠ æ¸…æ™°ç°åœ¨çš„ä»£ç è§£è€¦ç»“æ„ã€‚
- æ­¤ç« èŠ‚ä¸­æ¯”è¾ƒé‡è¦çš„ä½“ç°æ˜¯å…³äºå‚æ•°ç±»å‹çš„ç­–ç•¥åŒ–è®¾è®¡ï¼Œé€šè¿‡ç­–ç•¥è§£è€¦ï¼Œæ¨¡æ¿å®šä¹‰æµç¨‹ï¼Œè®©æˆ‘ä»¬æ•´ä¸ªå‚æ•°è®¾ç½®å˜å¾—æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿå°±ä¸éœ€è¦ç¡¬ç¼–ç äº†ã€‚
- é™¤æ­¤ä¹‹å¤–ä¹Ÿæœ‰ä¸€äº›ç»†èŠ‚çš„åŠŸèƒ½ç‚¹ï¼Œå¦‚ï¼›MapperMethod ä¸­æ·»åŠ æ–¹æ³•ç­¾åã€ç±»å‹å¤„ç†å™¨åˆ›å»ºå’Œä½¿ç”¨æ—¶å€™ï¼Œéƒ½ä½¿ç”¨äº† MetaObject è¿™æ ·çš„åå°„å™¨å·¥å…·ç±»è¿›è¡Œå¤„ç†ã€‚è¿™äº›ç»†èŠ‚çš„åŠŸèƒ½ç‚¹ï¼Œè¯»è€…éœ€è¦åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œè°ƒè¯•éªŒè¯æ‰èƒ½æ›´å¥½çš„å¸æ”¶æ­¤ç±»ç¼–ç è®¾è®¡çš„æŠ€å·§å’Œç»éªŒã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [é’ˆå¯¹ä¸åŒç±»å‹çš„å‚æ•°ï¼Œä½¿ç”¨äº†å¯¹åº”çš„ç±»å‹å¤„ç†å™¨å®Œæˆå‚æ•°å€¼çš„æ³¨å…¥ @liuc](https://t.zsxq.com/09DAtfS4T)