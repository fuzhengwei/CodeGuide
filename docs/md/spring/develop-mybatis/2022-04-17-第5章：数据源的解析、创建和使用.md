---
title: ç¬¬5ç« ï¼šæ•°æ®æºçš„è§£æã€åˆ›å»ºå’Œä½¿ç”¨
lock: need
---

# ã€ŠMybatis æ‰‹æ’¸ä¸“æ ã€‹ç¬¬5ç« ï¼šæ•°æ®æºçš„è§£æã€åˆ›å»ºå’Œä½¿ç”¨

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`ç®¡ä½ åƒå‡ ç¢—ç²‰ï¼Œæœ‰æµé‡å°±è¡Œï¼`

ç°åœ¨æˆ‘ä»¬æ¯å¤©æ‰€æ¥æ”¶çš„ä¿¡æ¯é‡è¶Šæ¥è¶Šå¤šï¼Œä½†å¾ˆå¤šçš„ä¸ªäººå´æ²¡æœ‰å¤šå°‘åˆ†è¾¨çŸ¥è¯†çš„èƒ½åŠ›ã€‚å¾ˆå¤šçŸ¥è¯†ä¿¡æ¯ä¹Ÿåªæ˜¯è¹­çƒ­ç‚¹çš„æ³›çŸ¥è¯†ï¼Œä½†æ³›çŸ¥è¯†åªæ˜¯ä¸€ç§ç©ºæ³›ã€ä¸æˆç³»ç»Ÿã€ç”šè‡³å¯èƒ½æ˜¯é”™è¯¯çš„ä¿¡æ¯ç¾¤ï¼Œä¸è¿‡å°±æ˜¯è¿™æ ·çš„ä¿¡æ¯å´ç»™å†…å®¹æ¶ˆè´¹è€…ä¸€ç§â€œæˆåŠŸè·å–äº†çŸ¥è¯†â€åƒé¥±çš„å¹»è§‰ï¼Œå´ä¸§å¤±äº†å¯¹çŸ¥è¯†å±‚æ¬¡çš„æŠŠæ§ã€‚

è€Œä½œä¸ºä¸€ä¸ªæœ¬èº«å°±å¾ˆç†ç§‘çš„ç¨‹åºå‘˜æ¥è¯´ï¼Œå¦‚æœéƒ½æ˜¯è¢«æ³›çŸ¥è¯†å……æ–¥ï¼ŒèŠ±è´¹ç€è‡ªå·±çš„ç²¾åŠ›å’Œæ—¶é—´ï¼Œæ²¡æœ‰ç»è¿‡è¶³å¤Ÿçš„è„‘åŠ›æ€è€ƒæ‰€å¸æ”¶çš„æ³›æŠ€æœ¯å†…å®¹ï¼Œé•¿æœŸä»¥å¾€æ˜¯å¾ˆéš¾æœ‰æ‰€æˆé•¿çš„ã€‚

ä»¥ä¸ºæˆ‘ä¸ªäººçš„æˆé•¿ç»å†æ¥çœ‹ï¼Œæˆ‘æ›´æ„¿æ„èŠ±å¾ˆå¤šçš„å®é™…æ¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œè€Œä¸æ˜¯ä¸€ç‰‡é—®é¢˜ã€‚å½“ä¸€ä¸ªé—®é¢˜è§£å†³çš„è¶³å¤Ÿé€å½»ã€æ¸…æ™°ã€æ˜ç¡®ä»¥åï¼Œå†ç»“åˆç€è¿™ä¸ªçŸ¥è¯†ç‚¹æ‰€éœ€è¦çš„å†…å®¹ç»§ç»­æ‰©å±•å’Œæ·±æŒ–ã€‚å¾ˆåº†å¹¸å½“å¹´æ²¡æœ‰é‚£ä¹ˆå¤šçš„æ³›çŸ¥è¯†å†…å®¹æ¨é€ï¼Œå¦åˆ™å¯èƒ½æˆ‘ä¹Ÿä¼šè¢«å¼„çš„å¾ˆç„¦è™‘ï¼

## äºŒã€ç›®æ ‡

åœ¨ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬è§£æ XML ä¸­çš„ SQL é…ç½®ä¿¡æ¯ï¼Œå¹¶åœ¨ä»£ç†å¯¹è±¡è°ƒç”¨ DefaultSqlSession ä¸­è¿›è¡Œè·å–å’Œæ‰“å°æ“ä½œï¼Œä»æ•´ä¸ªæ¡†æ¶ç»“æ„æ¥çœ‹æˆ‘ä»¬è§£å†³äº†å¯¹è±¡çš„ä»£ç†ã€Mapperçš„æ˜ å°„ã€SQLçš„åˆæ­¥è§£æï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±åº”è¯¥æ˜¯è¿åº“å’Œæ‰§è¡ŒSQLè¯­å¥å¹¶è¿”å›ç»“æœäº†ã€‚

é‚£ä¹ˆè¿™éƒ¨åˆ†å†…å®¹å°±ä¼šæ¶‰åŠåˆ°è§£æ XML ä¸­å…³äº dataSource æ•°æ®æºä¿¡æ¯é…ç½®ï¼Œå¹¶ç®€å†äº‹åŠ¡ç®¡ç†å’Œè¿æ¥æ± çš„å¯åŠ¨å’Œä½¿ç”¨ã€‚å¹¶å°†è¿™éƒ¨åˆ†èƒ½åŠ›åœ¨ DefaultSqlSession æ‰§è¡Œ SQL è¯­å¥æ—¶è¿›è¡Œè°ƒç”¨ã€‚ä½†ä¸ºäº†ä¸è‡³äºåœ¨ä¸€ä¸ªç« èŠ‚æŠŠæ•´ä¸ªå·¥ç¨‹æ’‘å¤§ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šæŠŠé‡ç‚¹æ”¾åˆ°è§£æé…ç½®ã€ç®€å†äº‹åŠ¡æ¡†æ¶å’Œå¼•å…¥ DRUID è¿æ¥æ± ï¼Œä»¥åŠåˆæ­¥å®Œæˆ SQL çš„æ‰§è¡Œå’Œç»“æœç®€å•åŒ…è£…ä¸Šã€‚ä¾¿äºè¯»è€…å…ˆç†Ÿæ‚‰æ•´ä¸ªæ¡†æ¶ç»“æ„ï¼Œåœ¨åç»­ç« èŠ‚å†é™†ç»­è¿­ä»£å’Œå®Œå–„æ¡†æ¶ç»†èŠ‚ã€‚

## ä¸‰ã€è®¾è®¡

å»ºç«‹æ•°æ®æºè¿æ¥æ± å’Œ JDBC äº‹åŠ¡å·¥å‚æ“ä½œï¼Œå¹¶ä»¥ xml é…ç½®æ•°æ®æºä¿¡æ¯ä¸ºå…¥å£ï¼Œåœ¨ XMLConfigBuilder ä¸­æ·»åŠ æ•°æ®æºè§£æå’Œæ„å»ºæ“ä½œï¼Œå‘é…ç½®ç±»configurationæ·»åŠ  JDBC æ“ä½œç¯å¢ƒä¿¡æ¯ã€‚ä»¥ä¾¿åœ¨ DefaultSqlSession å®Œæˆå¯¹ JDBC æ‰§è¡Œ SQL çš„æ“ä½œã€‚

![å›¾ 5-1 æ•°æ®æºçš„è§£æå’Œä½¿ç”¨](https://bugstack.cn/images/article/spring/mybatis-220414-01.png)

- åœ¨ parse ä¸­è§£æ XML DB é“¾æ¥é…ç½®ä¿¡æ¯ï¼Œå¹¶å®Œæˆäº‹åŠ¡å·¥å‚å’Œè¿æ¥æ± çš„æ³¨å†Œç¯å¢ƒåˆ°é…ç½®ç±»çš„æ“ä½œã€‚
- ä¸ä¸Šä¸€ç« èŠ‚æ”¹é€  selectOne æ–¹æ³•çš„å¤„ç†ï¼Œä¸å†æ˜¯æ‰“å° SQL è¯­å¥ï¼Œè€Œæ˜¯æŠŠ SQL è¯­å¥æ”¾åˆ° DB è¿æ¥æ± ä¸­è¿›è¡Œæ‰§è¡Œï¼Œä»¥åŠå®Œæˆç®€å•çš„ç»“æœå°è£…ã€‚

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
mybatis-step-04
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”‚   â”œâ”€â”€ MapperMethod.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java
    â”‚           â”‚   â””â”€â”€ MapperRegistry.java
    â”‚           â”œâ”€â”€ builder
    â”‚           â”‚   â”œâ”€â”€ xml
    â”‚           â”‚   â”‚   â””â”€â”€ XMLConfigBuilder.java
    â”‚           â”‚   â””â”€â”€ BaseBuilder.java
    â”‚           â”œâ”€â”€ datasource
    â”‚           â”‚   â”œâ”€â”€ druid
    â”‚           â”‚   â”‚   â””â”€â”€ DruidDataSourceFactory.java
    â”‚           â”‚   â””â”€â”€ DataSourceFactory.java
    â”‚           â”œâ”€â”€ io
    â”‚           â”‚   â””â”€â”€ Resources.java
    â”‚           â”œâ”€â”€ mapping
    â”‚           â”‚   â”œâ”€â”€ BoundSql.java
    â”‚           â”‚   â”œâ”€â”€ Environment.java
    â”‚           â”‚   â”œâ”€â”€ MappedStatement.java
    â”‚           â”‚   â”œâ”€â”€ ParameterMapping.java
    â”‚           â”‚   â””â”€â”€ SqlCommandType.java
    â”‚           â”œâ”€â”€ session
    â”‚           â”‚   â”œâ”€â”€ defaults
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSqlSession.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Configuration.java
    â”‚           â”‚   â”œâ”€â”€ SqlSession.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactory.java
    â”‚           â”‚   â”œâ”€â”€ SqlSessionFactoryBuilder.java
    â”‚           â”‚   â””â”€â”€ TransactionIsolationLevel.java  
    â”‚           â”œâ”€â”€ transaction
    â”‚           â”‚   â”œâ”€â”€ jdbc
    â”‚           â”‚   â”‚   â”œâ”€â”€ JdbcTransaction.java
    â”‚           â”‚   â”‚   â””â”€â”€ JdbcTransactionFactory.java
    â”‚           â”‚   â”œâ”€â”€ Transaction.java
    â”‚           â”‚   â””â”€â”€ TransactionFactory.java
    â”‚           â””â”€â”€ type
    â”‚               â”œâ”€â”€ JdbcType.java
    â”‚               â””â”€â”€ TypeAliasRegistry.java
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ cn.bugstack.mybatis.test.dao
        â”‚       â”œâ”€â”€ dao
        â”‚       â”‚   â””â”€â”€ IUserDao.java
        â”‚       â”œâ”€â”€ po
        â”‚       â”‚   â””â”€â”€ User.java
        â”‚       â””â”€â”€ ApiTest.java
        â””â”€â”€ resources
            â”œâ”€â”€ mapper
            â”‚   â””â”€â”€User_Mapper.xml
            â””â”€â”€ mybatis-config-datasource.xml
```

æ•°æ®æºçš„è§£æå’Œä½¿ç”¨æ ¸å¿ƒç±»å…³ç³»ï¼Œå¦‚å›¾ 5-2 æ‰€ç¤º

![å›¾ 5-2 æ•°æ®æºçš„è§£æå’Œä½¿ç”¨æ ¸å¿ƒç±»å…³ç³»](https://bugstack.cn/images/article/spring/mybatis-220414-02.png)

- ä»¥äº‹åŠ¡æ¥å£ Transaction  å’Œäº‹åŠ¡å·¥å‚ TransactionFactory çš„å®ç°ï¼ŒåŒ…è£…æ•°æ®æº DruidDataSourceFactory çš„åŠŸèƒ½ã€‚è¿™é‡Œçš„æ•°æ®æºè¿æ¥æ± æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯é˜¿é‡Œçš„ Druidï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å®ç° Mybatis çš„ JNDI å’Œ Pooled è¿æ¥æ± ï¼Œè¿™éƒ¨åˆ†å¯ä»¥åç»­ä¸“é—¨ä»¥æ•°æ®æºè¿æ¥æ± çš„ä¸“é¡¹æ¥å¼€å‘ã€‚
- å½“æ‰€æœ‰çš„æ•°æ®æºç›¸å…³åŠŸèƒ½å‡†å¤‡å¥½åï¼Œå°±æ˜¯åœ¨ XMLConfigBuilder è§£æ XML é…ç½®æ“ä½œä¸­ï¼Œå¯¹æ•°æ®æºçš„é…ç½®è¿›è¡Œè§£æä»¥åŠåˆ›å»ºå‡ºç›¸åº”çš„æœåŠ¡ï¼Œå­˜æ”¾åˆ° Configuration çš„ç¯å¢ƒé…ç½®ä¸­ã€‚
- æœ€ååœ¨ DefaultSqlSession#selectOne æ–¹æ³•ä¸­å®Œæˆ SQL çš„æ‰§è¡Œå’Œç»“æœå°è£…ï¼Œæœ€ç»ˆå°±æŠŠæ•´ä¸ª Mybatis æ ¸å¿ƒè„‰ç»œä¸²è”å‡ºæ¥äº†ã€‚

### 2. äº‹åŠ¡ç®¡ç†

ä¸€æ¬¡æ•°æ®åº“çš„æ“ä½œåº”è¯¥å…·æœ‰äº‹åŠ¡ç®¡ç†èƒ½åŠ›ï¼Œè€Œä¸æ˜¯é€šè¿‡ JDBC è·å–é“¾æ¥åç›´æ¥æ‰§è¡Œå³å¯ã€‚è¿˜åº”è¯¥æŠŠæ§é“¾æ¥ã€æäº¤ã€å›æ»šå’Œå…³é—­çš„æ“ä½œå¤„ç†ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç»“åˆ JDBC çš„èƒ½åŠ›å°è£…äº‹åŠ¡ç®¡ç†ã€‚

#### 2.1 äº‹åŠ¡æ¥å£

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.transaction.Transaction`

```java
public interface Transaction {

    Connection getConnection() throws SQLException;

    void commit() throws SQLException;

    void rollback() throws SQLException;

    void close() throws SQLException;

}
```

- å®šä¹‰æ ‡å‡†çš„äº‹åŠ¡æ¥å£ï¼Œé“¾æ¥ã€æäº¤ã€å›æ»šã€å…³é—­ï¼Œå…·ä½“å¯ä»¥ç”±ä¸åŒçš„äº‹åŠ¡æ–¹å¼è¿›è¡Œå®ç°ï¼ŒåŒ…æ‹¬ï¼šJDBCå’Œæ‰˜ç®¡äº‹åŠ¡ï¼Œæ‰˜ç®¡äº‹åŠ¡æ˜¯äº¤ç»™ Spring è¿™æ ·çš„å®¹å™¨æ¥ç®¡ç†ã€‚

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.transaction.jdbc.JdbcTransaction`

```java
public class JdbcTransaction implements Transaction {

    protected Connection connection;
    protected DataSource dataSource;
    protected TransactionIsolationLevel level = TransactionIsolationLevel.NONE;
    protected boolean autoCommit;

    public JdbcTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit) {
        this.dataSource = dataSource;
        this.level = level;
        this.autoCommit = autoCommit;
    }

    @Override
    public Connection getConnection() throws SQLException {
        connection = dataSource.getConnection();
        connection.setTransactionIsolation(level.getLevel());
        connection.setAutoCommit(autoCommit);
        return connection;
    }

    @Override
    public void commit() throws SQLException {
        if (connection != null && !connection.getAutoCommit()) {
            connection.commit();
        }
    }
    
    //...

}
```

- åœ¨ JDBC äº‹åŠ¡å®ç°ç±»ä¸­ï¼Œå°è£…äº†è·å–é“¾æ¥ã€æäº¤äº‹åŠ¡ç­‰æ“ä½œï¼Œå…¶å®ä½¿ç”¨çš„ä¹Ÿå°±æ˜¯ JDBC æœ¬èº«æä¾›çš„èƒ½åŠ›ã€‚

#### 2.2 äº‹åŠ¡å·¥å‚

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.transaction.TransactionFactory`

```java
public interface TransactionFactory {

    /**
     * æ ¹æ® Connection åˆ›å»º Transaction
     * @param conn Existing database connection
     * @return Transaction
     */
    Transaction newTransaction(Connection conn);

    /**
     * æ ¹æ®æ•°æ®æºå’Œäº‹åŠ¡éš”ç¦»çº§åˆ«åˆ›å»º Transaction
     * @param dataSource DataSource to take the connection from
     * @param level Desired isolation level
     * @param autoCommit Desired autocommit
     * @return Transaction
     */
    Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit);

}
```

- ä»¥å·¥å‚æ–¹æ³•æ¨¡å¼åŒ…è£… JDBC äº‹åŠ¡å®ç°ï¼Œä¸ºæ¯ä¸€ä¸ªäº‹åŠ¡å®ç°éƒ½æä¾›ä¸€ä¸ªå¯¹åº”çš„å·¥å‚ã€‚ä¸ç®€å•å·¥å‚çš„æ¥å£åŒ…è£…ä¸åŒã€‚

### 3. ç±»å‹åˆ«åæ³¨å†Œå™¨

åœ¨ Mybatis æ¡†æ¶ä¸­æˆ‘ä»¬æ‰€éœ€è¦çš„åŸºæœ¬ç±»å‹ã€æ•°ç»„ç±»å‹ä»¥åŠè‡ªå·±å®šä¹‰çš„äº‹åŠ¡å®ç°å’Œäº‹åŠ¡å·¥å‚éƒ½éœ€è¦æ³¨å†Œåˆ°ç±»å‹åˆ«åçš„æ³¨å†Œå™¨ä¸­è¿›è¡Œç®¡ç†ï¼Œåœ¨æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ—¶å€™å¯ä»¥ä»æ³¨å†Œå™¨ä¸­è·å–åˆ°å…·ä½“çš„å¯¹è±¡ç±»å‹ï¼Œä¹‹ååœ¨è¿›è¡Œå®ä¾‹åŒ–çš„æ–¹å¼è¿›è¡Œä½¿ç”¨ã€‚

#### 3.1 åŸºç¡€æ³¨å†Œå™¨

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.type.TypeAliasRegistry`

```java
public class TypeAliasRegistry {

    private final Map<String, Class<?>> TYPE_ALIASES = new HashMap<>();

    public TypeAliasRegistry() {
        // æ„é€ å‡½æ•°é‡Œæ³¨å†Œç³»ç»Ÿå†…ç½®çš„ç±»å‹åˆ«å
        registerAlias("string", String.class);

        // åŸºæœ¬åŒ…è£…ç±»å‹
        registerAlias("byte", Byte.class);
        registerAlias("long", Long.class);
        registerAlias("short", Short.class);
        registerAlias("int", Integer.class);
        registerAlias("integer", Integer.class);
        registerAlias("double", Double.class);
        registerAlias("float", Float.class);
        registerAlias("boolean", Boolean.class);
    }

    public void registerAlias(String alias, Class<?> value) {
        String key = alias.toLowerCase(Locale.ENGLISH);
        TYPE_ALIASES.put(key, value);
    }

    public <T> Class<T> resolveAlias(String string) {
        String key = string.toLowerCase(Locale.ENGLISH);
        return (Class<T>) TYPE_ALIASES.get(key);
    }

}
```

- åœ¨ TypeAliasRegistry ç±»å‹åˆ«åæ³¨å†Œå™¨ä¸­å…ˆåšäº†ä¸€äº›åŸºæœ¬çš„ç±»å‹æ³¨å†Œï¼Œä»¥åŠæä¾› registerAlias æ³¨å†Œæ–¹æ³•å’Œ resolveAlias è·å–æ–¹æ³•ã€‚

#### 3.2 æ³¨å†Œäº‹åŠ¡

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.session.Configuration`

```java
public class Configuration {

    //ç¯å¢ƒ
    protected Environment environment;

    // æ˜ å°„æ³¨å†Œæœº
    protected MapperRegistry mapperRegistry = new MapperRegistry(this);

    // æ˜ å°„çš„è¯­å¥ï¼Œå­˜åœ¨Mapé‡Œ
    protected final Map<String, MappedStatement> mappedStatements = new HashMap<>();

    // ç±»å‹åˆ«åæ³¨å†Œæœº
    protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry();

    public Configuration() {
        typeAliasRegistry.registerAlias("JDBC", JdbcTransactionFactory.class);
        typeAliasRegistry.registerAlias("DRUID", DruidDataSourceFactory.class);
    }
    
    //...
}
```

- åœ¨ Configuration é…ç½®é€‰é¡¹ç±»ä¸­ï¼Œæ·»åŠ ç±»å‹åˆ«åæ³¨å†Œæœºï¼Œé€šè¿‡æ„é€ å‡½æ•°æ·»åŠ  JDBCã€DRUID æ³¨å†Œæ“ä½œã€‚
- è¯»è€…åº”è¯¥æ³¨æ„åˆ°ï¼Œæ•´ä¸ª Mybatis çš„æ“ä½œéƒ½æ˜¯ä½¿ç”¨ Configuration é…ç½®é¡¹è¿›è¡Œä¸²è”æµç¨‹ï¼Œæ‰€ä»¥æ‰€æœ‰å†…å®¹éƒ½ä¼šåœ¨ Configuration ä¸­è¿›è¡Œé“¾æ¥ã€‚

### 4. è§£ææ•°æ®æºé…ç½®

é€šè¿‡åœ¨ XML è§£æå™¨ XMLConfigBuilder ä¸­ï¼Œæ‰©å±•å¯¹ç¯å¢ƒä¿¡æ¯çš„è§£æï¼Œæˆ‘ä»¬è¿™é‡ŒæŠŠæ•°æ®æºã€äº‹åŠ¡ç±»å†…å®¹ç§°ä¸ºæ“ä½œ SQL çš„ç¯å¢ƒã€‚è§£æåæŠŠé…ç½®ä¿¡æ¯å†™å…¥åˆ° Configuration é…ç½®é¡¹ä¸­ï¼Œä¾¿äºåç»­ä½¿ç”¨ã€‚

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.builder.xml.XMLConfigBuilder`

```java 
public class XMLConfigBuilder extends BaseBuilder {
         
  public Configuration parse() {
      try {
          // ç¯å¢ƒ
          environmentsElement(root.element("environments"));
          // è§£ææ˜ å°„å™¨
          mapperElement(root.element("mappers"));
      } catch (Exception e) {
          throw new RuntimeException("Error parsing SQL Mapper Configuration. Cause: " + e, e);
      }
      return configuration;
  }
    
  private void environmentsElement(Element context) throws Exception {
      String environment = context.attributeValue("default");
      List<Element> environmentList = context.elements("environment");
      for (Element e : environmentList) {
          String id = e.attributeValue("id");
          if (environment.equals(id)) {
              // äº‹åŠ¡ç®¡ç†å™¨
              TransactionFactory txFactory = (TransactionFactory) typeAliasRegistry.resolveAlias(e.element("transactionManager").attributeValue("type")).newInstance();
              // æ•°æ®æº
              Element dataSourceElement = e.element("dataSource");
              DataSourceFactory dataSourceFactory = (DataSourceFactory) typeAliasRegistry.resolveAlias(dataSourceElement.attributeValue("type")).newInstance();
              List<Element> propertyList = dataSourceElement.elements("property");
              Properties props = new Properties();
              for (Element property : propertyList) {
                  props.setProperty(property.attributeValue("name"), property.attributeValue("value"));
              }
              dataSourceFactory.setProperties(props);
              DataSource dataSource = dataSourceFactory.getDataSource();
              // æ„å»ºç¯å¢ƒ
              Environment.Builder environmentBuilder = new Environment.Builder(id)
                      .transactionFactory(txFactory)
                      .dataSource(dataSource);
              configuration.setEnvironment(environmentBuilder.build());
          }
      }
  }

}
```

- ä»¥ XMLConfigBuilder#parse è§£ææ‰©å±•å¯¹æ•°æ®æºè§£ææ“ä½œï¼Œåœ¨ environmentsElement æ–¹æ³•ä¸­åŒ…æ‹¬äº‹åŠ¡ç®¡ç†å™¨è§£æå’Œä»ç±»å‹æ³¨å†Œå™¨ä¸­è¯»å–åˆ°äº‹åŠ¡å·¥ç¨‹çš„å®ç°ç±»ï¼ŒåŒç†æ•°æ®æºä¹Ÿæ˜¯ä»ç±»å‹æ³¨å†Œå™¨ä¸­è·å–ã€‚
- æœ€åæŠŠäº‹åŠ¡ç®¡ç†å™¨å’Œæ•°æ®æºçš„å¤„ç†ï¼Œé€šè¿‡ç¯å¢ƒæ„å»º Environment.Builder å­˜æ”¾åˆ° Configuration é…ç½®é¡¹ä¸­ï¼Œä¹Ÿå°±å¯ä»¥é€šè¿‡ Configuration å­˜åœ¨çš„åœ°æ–¹éƒ½å¯ä»¥è·å–åˆ°æ•°æ®æºäº†ã€‚

### 5. SQLæ‰§è¡Œå’Œç»“æœå°è£…

åœ¨ä¸Šä¸€ç« èŠ‚ä¸­åœ¨ DefaultSqlSession#selectOne åªæ˜¯æ‰“å°äº† XML ä¸­é…ç½®çš„ SQL è¯­å¥ï¼Œç°åœ¨æŠŠæ•°æ®æºçš„é…ç½®åŠ è½½è¿›æ¥ä»¥åï¼Œå°±å¯ä»¥æŠŠ SQL è¯­å¥æ”¾åˆ°æ•°æ®æºä¸­è¿›è¡Œæ‰§è¡Œä»¥åŠç»“æœå°è£…ã€‚

**è¯¦è§æºç **ï¼š`cn.bugstack.mybatis.session.defaults.DefaultSqlSession` 

```java
public class DefaultSqlSession implements SqlSession {

    private Configuration configuration;

    public DefaultSqlSession(Configuration configuration) {
        this.configuration = configuration;
    }

    @Override
    public <T> T selectOne(String statement, Object parameter) {
        try {
            MappedStatement mappedStatement = configuration.getMappedStatement(statement);
            Environment environment = configuration.getEnvironment();

            Connection connection = environment.getDataSource().getConnection();

            BoundSql boundSql = mappedStatement.getBoundSql();
            PreparedStatement preparedStatement = connection.prepareStatement(boundSql.getSql());
            preparedStatement.setLong(1, Long.parseLong(((Object[]) parameter)[0].toString()));
            ResultSet resultSet = preparedStatement.executeQuery();

            List<T> objList = resultSet2Obj(resultSet, Class.forName(boundSql.getResultType()));
            return objList.get(0);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
    
    // ...

}
```

- åœ¨ selectOne æ–¹æ³•ä¸­è·å– Connection æ•°æ®æºé“¾æ¥ï¼Œå¹¶ç®€å•çš„æ‰§è¡Œ SQL è¯­å¥ï¼Œå¹¶å¯¹æ‰§è¡Œçš„ç»“æœè¿›è¡Œå°è£…å¤„ç†ã€‚ 
- å› ä¸ºç›®å‰è¿™éƒ¨åˆ†ä¸»è¦æ˜¯ä¸ºäº†å¤§å®¶ä¸²è”å‡ºæ•´ä¸ªåŠŸèƒ½ç»“æ„ï¼Œæ‰€ä»¥å…³äº SQL çš„æ‰§è¡Œã€å‚æ•°ä¼ é€’å’Œç»“æœå°è£…éƒ½æ˜¯å†™æ­»çš„ï¼Œåç»­æˆ‘ä»¬è¿›è¡Œæ‰©å±•ã€‚

## å…­ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

#### 1.1 åˆ›å»ºåº“è¡¨

åˆ›å»ºä¸€ä¸ªæ•°æ®åº“åç§°ä¸º mybatis å¹¶åœ¨åº“ä¸­åˆ›å»ºè¡¨ user ä»¥åŠæ·»åŠ æµ‹è¯•æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
CREATE TABLE
    USER
    (
        id bigint NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
        userId VARCHAR(9) COMMENT 'ç”¨æˆ·ID',
        userHead VARCHAR(16) COMMENT 'ç”¨æˆ·å¤´åƒ',
        createTime TIMESTAMP NULL COMMENT 'åˆ›å»ºæ—¶é—´',
        updateTime TIMESTAMP NULL COMMENT 'æ›´æ–°æ—¶é—´',
        userName VARCHAR(64),
        PRIMARY KEY (id)
    )
    ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
insert into user (id, userId, userHead, createTime, updateTime, userName) values (1, '10001', '1_04', '2022-04-13 00:00:00', '2022-04-13 00:00:00', 'å°å‚…å“¥');    
```

#### 2. é…ç½®æ•°æ®æº

```xml
<environments default="development">
    <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="DRUID">
            <property name="driver" value="com.mysql.jdbc.Driver"/>
            <property name="url" value="jdbc:mysql://127.0.0.1:3306/mybatis?useUnicode=true"/>
            <property name="username" value="root"/>
            <property name="password" value="123456"/>
        </dataSource>
    </environment>
</environments>
```

- é€šè¿‡ `mybatis-config-datasource.xml` é…ç½®æ•°æ®æºä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šdriverã€urlã€usernameã€password
- å¦å¤–è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼ŒDataSource é…ç½®çš„æ˜¯ DRUIDï¼Œå› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯è¿™ä¸ªæ•°æ®æºçš„å¤„ç†æ–¹å¼ã€‚

#### 3. é…ç½®Mapper

```xml
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>
```

- Mapper çš„é…ç½®å†…å®¹åœ¨ä¸Šä¸€ç« èŠ‚çš„è§£æå­¦ä¹ ä¸­å·²ç»åšäº†é…ç½®ï¼Œæœ¬ç« èŠ‚åšäº†ç®€å•çš„è°ƒæ•´ã€‚

### 2. å•å…ƒæµ‹è¯•

```java
@Test
public void test_SqlSessionFactory() throws IOException {
    // 1. ä»SqlSessionFactoryä¸­è·å–SqlSession
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(Resources.getResourceAsReader("mybatis-config-datasource.xml"));
    SqlSession sqlSession = sqlSessionFactory.openSession();
    
    // 2. è·å–æ˜ å°„å™¨å¯¹è±¡
    IUserDao userDao = sqlSession.getMapper(IUserDao.class);
    
    // 3. æµ‹è¯•éªŒè¯
    User user = userDao.queryUserInfoById(1L);
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(user));
}
```

- å•å…ƒæµ‹è¯•æ²¡æœ‰ä»€ä¹ˆæ”¹å˜ï¼Œä»æ˜¯é€šè¿‡ SqlSessionFactory ä¸­è·å– SqlSession å¹¶è·å¾—æ˜ å°„å¯¹è±¡å’Œæ‰§è¡Œæ–¹æ³•è°ƒç”¨ã€‚

**æµ‹è¯•ç»“æœ**

```java
22:34:18.676 [main] INFO  c.alibaba.druid.pool.DruidDataSource - {dataSource-1} inited
22:34:19.286 [main] INFO  cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":1,"userHead":"1_04","userId":"10001","userName":"å°å‚…å“¥"}

Process finished with exit code 0
```

- ä»ç°åœ¨çš„æµ‹è¯•ç»“æœå·²ç»å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡æˆ‘ä»¬å¯¹æ•°æ®æºçš„è§£æã€åŒ…è£…å’Œä½¿ç”¨ï¼Œå·²ç»å¯ä»¥å¯¹ SQL è¯­å¥è¿›è¡Œæ‰§è¡Œå’ŒåŒ…è£…è¿”å›çš„ç»“æœä¿¡æ¯äº†ã€‚
- è¯»è€…åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å¯ä»¥è°ƒè¯•ä¸‹ä»£ç ï¼Œçœ‹çœ‹æ¯ä¸€æ­¥éƒ½æ˜¯å¦‚ä½•å®Œæˆæ‰§è¡Œæ­¥éª¤çš„ï¼Œä¹Ÿåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¿›è¡Œå­¦ä¹  Mybatis æ¡†æ¶çš„è®¾è®¡æŠ€å·§ã€‚

## ä¸ƒã€æ€»ç»“

- ä»¥è§£æ XML é…ç½®è§£æä¸ºå…¥å£ï¼Œæ·»åŠ æ•°æ®æºçš„æ•´åˆå’ŒåŒ…è£…ï¼Œå¼•å‡ºäº‹åŠ¡å·¥å‚å¯¹ JDBC äº‹åŠ¡çš„å¤„ç†ï¼Œå¹¶åŠ è½½åˆ°ç¯å¢ƒé…ç½®ä¸­è¿›è¡Œä½¿ç”¨ã€‚
- é‚£ä¹ˆé€šè¿‡æ•°æ®æºçš„å¼•å…¥å°±å¯ä»¥åœ¨ DefaultSqlSession ä¸­ä» Configuration é…ç½®å¼•å…¥ç¯å¢ƒä¿¡æ¯ï¼ŒæŠŠå¯¹åº”çš„ SQL è¯­å¥æäº¤ç»™ JDBC è¿›è¡Œå¤„ç†å¹¶ç®€å•å°è£…ç»“æœæ•°æ®ã€‚
- ç»“åˆæœ¬ç« èŠ‚å»ºç«‹èµ·æ¥çš„æ¡†æ¶ç»“æ„ï¼Œæ•°æ®æºã€äº‹åŠ¡ã€ç®€å•çš„SQLè°ƒç”¨ï¼Œä¸‹ä¸ªç« èŠ‚å°†ç»§ç»­è¿™éƒ¨åˆ†å†…å®¹çš„æ‰©å±•å¤„ç†ï¼Œè®©æ•´ä¸ªåŠŸèƒ½æ¨¡å—é€æ¸å®Œå–„ã€‚