---
layout: post
category: spring
title: ç¬¬04ç« ï¼šåŸºäºCglibå®ç°å«æ„é€ å‡½æ•°çš„ç±»å®ä¾‹åŒ–ç­–ç•¥
tagline: by å°å‚…å“¥
tag: [java]
excerpt: è¿™ä¸€ç« èŠ‚çš„ç›®æ ‡ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬`åŸ‹ä¸‹çš„å‘`ï¼Œé‚£æ˜¯ä»€ä¹ˆå‘å‘¢ï¼Ÿå…¶å®å°±æ˜¯ä¸€ä¸ªå…³äº Bean å¯¹è±¡åœ¨å«æœ‰æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–çš„å‘ã€‚ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬å»å®ä¾‹åŒ–ä¸€ä¸ªå«æœ‰æ„é€ å‡½æ•°çš„å¯¹è±¡é‚£ä¹ˆå°±è¦æŠ›å¼‚å¸¸äº†ã€‚
lock: need
---

# ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 4 ç« ï¼šå´­éœ²å¤´è§’ï¼ŒåŸºäºCglibå®ç°å«æ„é€ å‡½æ•°çš„ç±»å®ä¾‹åŒ–ç­–ç•¥

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/olrwapkSTQMyIGpR10ZDzA](https://mp.weixin.qq.com/s/olrwapkSTQMyIGpR10ZDzA)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`æŠ€æœ¯æˆé•¿ï¼Œæ˜¯å¯¹åœºæ™¯è®¾è®¡ç»†èŠ‚ä¸æ–­çš„é›•åˆ»ï¼`

ä½ è§‰å¾—è‡ªå·±çš„æŠ€æœ¯ä»€ä¹ˆæ—¶å€™å¾—åˆ°äº†å¿«é€Ÿçš„æé«˜ï¼Œæ˜¯CRUDå†™çš„å¤šäº†ä»¥åå—ï¼Ÿæƒ³éƒ½ä¸è¦æƒ³ï¼Œç»å¯¹ä¸å¯èƒ½ï¼CRUDå†™çš„å†å¤šä¹Ÿåªæ˜¯èƒ½æ»¡è¶³ä½ ä½œä¸ºä¸€ä¸ªæ¬ç –å·¥å…·äººï¼Œæ•²å‡»å°‘é€»è¾‘æµæ°´ä»£ç çš„é€Ÿåº¦è€Œå·²ï¼Œè€Œç¼–ç¨‹èƒ½åŠ›è¿™ä¸€å—ï¼Œé™¤äº†æœ€å¼€å§‹çš„ä»ä¸ç†Ÿç»ƒåˆ°ç†Ÿç»ƒä»¥å¤–ï¼Œå°±å¾ˆå°‘å†æœ‰å…¶ä»–æå‡äº†ã€‚

é‚£ä½ å¯èƒ½ä¼šæƒ³ä»€ä¹ˆæ‰æ˜¯ç¼–ç¨‹èƒ½åŠ›æå‡ï¼Ÿå…¶å®æ›´å¤šçš„ç¼–ç¨‹èƒ½åŠ›çš„æå‡æ˜¯ä½ å¯¹å¤æ‚åœºæ™¯çš„æ¶æ„æŠŠæ§ä»¥åŠå¯¹æ¯ä¸€ä¸ªæŠ€æœ¯å®ç°ç»†èŠ‚ç‚¹çš„ä¸æ–­ç”¨å…·æœ‰è§„æ¨¡ä½“é‡çš„æµé‡å†²å‡»éªŒè¯æ—¶ï¼Œæ˜¯å¦èƒ½ä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œä»è€Œå†³å®šä½ è§è¯†äº†å¤šå°‘ã€å­¦åˆ°äº†å¤šå°‘ã€æå‡äº†å¤šå°‘ï¼

æœ€ç»ˆå½“ä½ åœ¨æ¥ä¸€ä¸ªäº§å“éœ€æ±‚æ—¶ï¼Œå¼€å§‹æ€è€ƒ`ç¨‹åºæ•°æ®ç»“æ„çš„è®¾è®¡`ã€`æ ¸å¿ƒåŠŸèƒ½çš„ç®—æ³•é€»è¾‘å®ç°`ã€`æ•´ä½“æœåŠ¡çš„è®¾è®¡æ¨¡å¼ä½¿ç”¨`ã€`ç³»ç»Ÿæ¶æ„çš„æ­å»ºæ–¹å¼`ã€`åº”ç”¨é›†ç¾¤çš„éƒ¨ç½²ç»“æ„`ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯çš„ç¼–ç¨‹èƒ½åŠ›çœŸæ­£æå‡çš„æ—¶å€™ï¼

## äºŒã€ç›®æ ‡

è¿™ä¸€ç« èŠ‚çš„ç›®æ ‡ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬`åŸ‹ä¸‹çš„å‘`ï¼Œé‚£æ˜¯ä»€ä¹ˆå‘å‘¢ï¼Ÿå…¶å®å°±æ˜¯ä¸€ä¸ªå…³äº Bean å¯¹è±¡åœ¨å«æœ‰æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–çš„å‘ã€‚

åœ¨ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬æ‰©å……äº† Bean å®¹å™¨çš„åŠŸèƒ½ï¼ŒæŠŠå®ä¾‹åŒ–å¯¹è±¡äº¤ç»™å®¹å™¨æ¥ç»Ÿä¸€å¤„ç†ï¼Œä½†åœ¨æˆ‘ä»¬å®ä¾‹åŒ–å¯¹è±¡çš„ä»£ç é‡Œå¹¶æ²¡æœ‰è€ƒè™‘å¯¹è±¡ç±»æ˜¯å¦å«æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬å»å®ä¾‹åŒ–ä¸€ä¸ªå«æœ‰æ„é€ å‡½æ•°çš„å¯¹è±¡é‚£ä¹ˆå°±è¦æŠ›å¼‚å¸¸äº†ã€‚

æ€ä¹ˆéªŒè¯ï¼Ÿå…¶å®å°±æ˜¯æŠŠ UserService æ·»åŠ ä¸€ä¸ªå«å…¥å‚ä¿¡æ¯çš„æ„é€ å‡½æ•°å°±å¯ä»¥ï¼Œå¦‚ä¸‹ï¼š

```java
public class UserService {

    private String name;

    public UserService(String name) {
        this.name = name;
    }  

    // ...
}
```

æŠ¥é”™å¦‚ä¸‹ï¼š

```java
java.lang.InstantiationException: cn.bugstack.springframework.test.bean.UserService

	at java.lang.Class.newInstance(Class.java:427)
	at cn.bugstack.springframework.test.ApiTest.test_newInstance(ApiTest.java:51)
	...
```

å‘ç”Ÿè¿™ä¸€ç°è±¡çš„ä¸»è¦åŸå› å°±æ˜¯å› ä¸º `beanDefinition.getBeanClass().newInstance();` å®ä¾‹åŒ–æ–¹å¼å¹¶æ²¡æœ‰è€ƒè™‘æ„é€ å‡½æ•°çš„å…¥å‚ï¼Œæ‰€ä»¥å°±è¿™ä¸ªå‘å°±åœ¨è¿™ç­‰ç€ä½ äº†ï¼**é‚£ä¹ˆæˆ‘ä»¬çš„ç›®æ ‡å°±å¾ˆæ˜æ˜¾äº†ï¼Œæ¥æŠŠè¿™ä¸ªå‘å¡«å¹³ï¼**

## ä¸‰ã€è®¾è®¡

å¡«å¹³è¿™ä¸ªå‘çš„æŠ€æœ¯è®¾è®¡ä¸»è¦è€ƒè™‘ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä¸²æµç¨‹ä»å“ªåˆç†çš„æŠŠæ„é€ å‡½æ•°çš„å…¥å‚ä¿¡æ¯ä¼ é€’åˆ°å®ä¾‹åŒ–æ“ä½œé‡Œï¼Œå¦å¤–ä¸€ä¸ªæ˜¯æ€ä¹ˆå»å®ä¾‹åŒ–å«æœ‰æ„é€ å‡½æ•°çš„å¯¹è±¡ã€‚

![å›¾ 4-1](https://bugstack.cn/assets/images/spring/spring-4-01.png)

- å‚è€ƒ Spring Bean å®¹å™¨æºç çš„å®ç°æ–¹å¼ï¼Œåœ¨ BeanFactory ä¸­æ·»åŠ  `Object getBean(String name, Object... args)` æ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è·å– Bean æ—¶æŠŠæ„é€ å‡½æ•°çš„å…¥å‚ä¿¡æ¯ä¼ é€’è¿›å»äº†ã€‚
- å¦å¤–ä¸€ä¸ªæ ¸å¿ƒçš„å†…å®¹æ˜¯ä½¿ç”¨ä»€ä¹ˆæ–¹å¼æ¥åˆ›å»ºå«æœ‰æ„é€ å‡½æ•°çš„ Bean å¯¹è±¡å‘¢ï¼Ÿè¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€‰æ‹©ï¼Œä¸€ä¸ªæ˜¯åŸºäº Java æœ¬èº«è‡ªå¸¦çš„æ–¹æ³• `DeclaredConstructor`ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä½¿ç”¨ Cglib æ¥åŠ¨æ€åˆ›å»º Bean å¯¹è±¡ã€‚*Cglib æ˜¯åŸºäºå­—èŠ‚ç æ¡†æ¶ ASM å®ç°ï¼Œæ‰€ä»¥ä½ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ ASM æ“ä½œæŒ‡ä»¤ç æ¥åˆ›å»ºå¯¹è±¡*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-03
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework.beans
    â”‚           â”œâ”€â”€ factory
    â”‚           â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java
    â”‚           â”‚   â””â”€â”€ BeanFactory.java
    â”‚           â””â”€â”€ BeansException.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â””â”€â”€ UserService.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

Spring Bean å®¹å™¨ç±»å…³ç³»ï¼Œå¦‚å›¾ 4-2

![å›¾ 4-2](https://bugstack.cn/assets/images/spring/spring-4-02.png)

æœ¬ç« èŠ‚`â€œå¡«å‘â€`ä¸»è¦æ˜¯åœ¨ç°æœ‰å·¥ç¨‹ä¸­æ·»åŠ  InstantiationStrategy å®ä¾‹åŒ–ç­–ç•¥æ¥å£ï¼Œä»¥åŠè¡¥å……ç›¸åº”çš„ getBean å…¥å‚ä¿¡æ¯ï¼Œè®©å¤–éƒ¨è°ƒç”¨æ—¶å¯ä»¥ä¼ é€’æ„é€ å‡½æ•°çš„å…¥å‚å¹¶é¡ºåˆ©å®ä¾‹åŒ–ã€‚

### 2. æ–°å¢ getBean æ¥å£

**cn.bugstack.springframework.beans.factory.BeanFactory**

```java
public interface BeanFactory {

    Object getBean(String name) throws BeansException;

    Object getBean(String name, Object... args) throws BeansException;

}
```

- BeanFactory ä¸­æˆ‘ä»¬é‡è½½äº†ä¸€ä¸ªå«æœ‰å…¥å‚ä¿¡æ¯ args çš„ getBean æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿çš„ä¼ é€’å…¥å‚ç»™æ„é€ å‡½æ•°å®ä¾‹åŒ–äº†ã€‚

### 3. å®šä¹‰å®ä¾‹åŒ–ç­–ç•¥æ¥å£

**cn.bugstack.springframework.beans.factory.support.InstantiationStrategy**

```java
public interface InstantiationStrategy {

    Object instantiate(BeanDefinition beanDefinition, String beanName, Constructor ctor, Object[] args) throws BeansException;

}
```

- åœ¨å®ä¾‹åŒ–æ¥å£ instantiate æ–¹æ³•ä¸­æ·»åŠ å¿…è¦çš„å…¥å‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šbeanDefinitionã€ beanNameã€ctorã€args
- å…¶ä¸­ Constructor ä½ å¯èƒ½ä¼šæœ‰ä¸€ç‚¹é™Œç”Ÿï¼Œå®ƒæ˜¯ java.lang.reflect åŒ…ä¸‹çš„ Constructor ç±»ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›å¿…è¦çš„ç±»ä¿¡æ¯ï¼Œæœ‰è¿™ä¸ªå‚æ•°çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ‹¿åˆ°ç¬¦åˆå…¥å‚ä¿¡æ¯ç›¸å¯¹åº”çš„æ„é€ å‡½æ•°ã€‚ 
- è€Œ args å°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å…¥å‚ä¿¡æ¯äº†ï¼Œæœ€ç»ˆå®ä¾‹åŒ–æ—¶å€™ä¼šç”¨åˆ°ã€‚

### 4. JDK å®ä¾‹åŒ–

**cn.bugstack.springframework.beans.factory.support.SimpleInstantiationStrategy**

```java
public class SimpleInstantiationStrategy implements InstantiationStrategy {

    @Override
    public Object instantiate(BeanDefinition beanDefinition, String beanName, Constructor ctor, Object[] args) throws BeansException {
        Class clazz = beanDefinition.getBeanClass();
        try {
            if (null != ctor) {
                return clazz.getDeclaredConstructor(ctor.getParameterTypes()).newInstance(args);
            } else {
                return clazz.getDeclaredConstructor().newInstance();
            }
        } catch (NoSuchMethodException | InstantiationException | IllegalAccessException | InvocationTargetException e) {
            throw new BeansException("Failed to instantiate [" + clazz.getName() + "]", e);
        }
    }

}
```

- é¦–å…ˆé€šè¿‡ beanDefinition è·å– Class ä¿¡æ¯ï¼Œè¿™ä¸ª Class ä¿¡æ¯æ˜¯åœ¨ Bean å®šä¹‰çš„æ—¶å€™ä¼ é€’è¿›å»çš„ã€‚
- æ¥ä¸‹æ¥åˆ¤æ–­ ctor æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¯æ— æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œå¦åˆ™å°±æ˜¯éœ€è¦æœ‰æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–ã€‚
- è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨æœ‰æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–æ–¹å¼ä¸º `clazz.getDeclaredConstructor(ctor.getParameterTypes()).newInstance(args);`ï¼ŒæŠŠå…¥å‚ä¿¡æ¯ä¼ é€’ç»™ newInstance è¿›è¡Œå®ä¾‹åŒ–ã€‚

### 5. Cglib å®ä¾‹åŒ–

**cn.bugstack.springframework.beans.factory.support.CglibSubclassingInstantiationStrategy**

```java
public class CglibSubclassingInstantiationStrategy implements InstantiationStrategy {

    @Override
    public Object instantiate(BeanDefinition beanDefinition, String beanName, Constructor ctor, Object[] args) throws BeansException {
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(beanDefinition.getBeanClass());
        enhancer.setCallback(new NoOp() {
            @Override
            public int hashCode() {
                return super.hashCode();
            }
        });
        if (null == ctor) return enhancer.create();
        return enhancer.create(ctor.getParameterTypes(), args);
    }

}
```

- å…¶å® Cglib åˆ›å»ºæœ‰æ„é€ å‡½æ•°çš„ Bean ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ›´åŠ ç®€åŒ–çš„å¤„ç†äº†ï¼Œå¦‚æœä½ é˜…è¯» Spring æºç è¿˜ä¼šçœ‹åˆ° CallbackFilter ç­‰å®ç°ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰çš„æ–¹å¼å¹¶ä¸ä¼šå½±å“åˆ›å»ºã€‚

### 6. åˆ›å»ºç­–ç•¥è°ƒç”¨

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        addSingleton(beanName, bean);
        return bean;
    }

    protected Object createBeanInstance(BeanDefinition beanDefinition, String beanName, Object[] args) {
        Constructor constructorToUse = null;
        Class<?> beanClass = beanDefinition.getBeanClass();
        Constructor<?>[] declaredConstructors = beanClass.getDeclaredConstructors();
        for (Constructor ctor : declaredConstructors) {
            if (null != args && ctor.getParameterTypes().length == args.length) {
                constructorToUse = ctor;
                break;
            }
        }
        return getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);
    }

}
```

- é¦–å…ˆåœ¨ AbstractAutowireCapableBeanFactory æŠ½è±¡ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„å®ä¾‹åŒ–ç­–ç•¥å±æ€§ç±» `InstantiationStrategy instantiationStrategy`ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©äº† Cglib çš„å®ç°ç±»ã€‚
- æ¥ä¸‹æ¥æŠ½å– `createBeanInstance` æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­éœ€è¦æ³¨æ„ Constructor ä»£è¡¨äº†ä½ æœ‰å¤šå°‘ä¸ªæ„é€ å‡½æ•°ï¼Œé€šè¿‡ beanClass.getDeclaredConstructors() æ–¹å¼å¯ä»¥è·å–åˆ°ä½ æ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªé›†åˆã€‚
- æ¥ä¸‹æ¥å°±éœ€è¦å¾ªç¯æ¯”å¯¹å‡ºæ„é€ å‡½æ•°é›†åˆä¸å…¥å‚ä¿¡æ¯ `args` çš„åŒ¹é…æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬å¯¹æ¯”çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ä¸€ä¸ªæ•°é‡å¯¹æ¯”ï¼Œè€Œå®é™… Spring
æºç ä¸­è¿˜éœ€è¦æ¯”å¯¹å…¥å‚ç±»å‹ï¼Œå¦åˆ™ç›¸åŒæ•°é‡ä¸åŒå…¥å‚ç±»å‹çš„æƒ…å†µï¼Œå°±ä¼šæŠ›å¼‚å¸¸äº†ã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**cn.bugstack.springframework.test.bean.UserService**

```java
public class UserService {

    private String name;

    public UserService(String name) {
        this.name = name;
    }

    public void queryUserInfo() {
        System.out.println("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š" + name);
    }

    @Override
    public String toString() {
        final StringBuilder sb = new StringBuilder("");
        sb.append("").append(name);
        return sb.toString();
    }
}
```

- è¿™é‡Œå”¯ä¸€å¤šåœ¨ UserService ä¸­æ·»åŠ çš„å°±æ˜¯ä¸€ä¸ªæœ‰ name å…¥å‚çš„æ„é€ å‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬éªŒè¯è¿™æ ·çš„å¯¹è±¡æ˜¯å¦èƒ½è¢«å®ä¾‹åŒ–ã€‚

### 2. æµ‹è¯•ç”¨ä¾‹

**cn.bugstack.springframework.test.ApiTest**

```java
@Test
public void test_BeanFactory() {
    // 1.åˆå§‹åŒ– BeanFactory
    DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();

    // 2. æ³¨å…¥bean
    BeanDefinition beanDefinition = new BeanDefinition(UserService.class);
    beanFactory.registerBeanDefinition("userService", beanDefinition);

    // 3.è·å–bean
    UserService userService = (UserService) beanFactory.getBean("userService", "å°å‚…å“¥");
    userService.queryUserInfo();
}
```

- åœ¨æ­¤æ¬¡çš„å•å…ƒæµ‹è¯•ä¸­åŒ…æ‹¬ï¼šBean å·¥å‚ã€æ³¨å†Œ Beanã€è·å– Beanï¼Œä¸‰ä¸ªæ­¥éª¤ã€‚
- æ­¤å¤–ä¸ä¸Šä¸€ç« èŠ‚æµ‹è¯•è¿‡ç¨‹ä¸­ä¸åŒçš„æ˜¯ï¼Œåœ¨è°ƒç”¨ getBean æ–¹æ³•æ—¶ï¼Œé™¤äº†ä¼ é€’ `userService`ï¼Œæˆ‘ä»¬è¿˜ä¼ é€’äº†`å°å‚…å“¥`ä½œä¸º UserService æ„é€ å‡½æ•°çš„å…¥å‚ã€‚

### 3. æµ‹è¯•ç»“æœ

```java
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šå°å‚…å“¥

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œæœ€å¤§çš„å˜åŒ–å°±æ˜¯å¯ä»¥æ»¡è¶³å¸¦æœ‰æ„é€ å‡½æ•°çš„å¯¹è±¡ï¼Œå¯ä»¥è¢«å®ä¾‹åŒ–äº†ã€‚
- ä½ å¯ä»¥å°è¯•åˆ†åˆ«ä½¿ç”¨ä¸¤ç§ä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œæ¥è¿›è¡Œå®ä¾‹åŒ–ã€‚`SimpleInstantiationStrategy`ã€`CglibSubclassingInstantiationStrategy`

### 4. æ“ä½œæ¡ˆä¾‹

è¿™é‡Œæˆ‘ä»¬å†æŠŠå‡ ç§ä¸åŒæ–¹å¼çš„å®ä¾‹åŒ–æ“ä½œï¼Œæ”¾åˆ°å•å…ƒæµ‹è¯•ä¸­ï¼Œæ–¹ä¾¿å¤§å®¶æ¯”å¯¹å­¦ä¹ ã€‚

#### 4.1 æ— æ„é€ å‡½æ•°

```java
@Test
public void test_newInstance() throws IllegalAccessException, InstantiationException {
    UserService userService = UserService.class.newInstance();
    System.out.println(userService);
}
```

- è¿™ç§æ–¹å¼çš„å®ä¾‹åŒ–ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€ç« èŠ‚å®ç° Spring Bean å®¹å™¨æ—¶ç›´æ¥ä½¿ç”¨çš„æ–¹å¼

#### 4.2 éªŒè¯æœ‰æ„é€ å‡½æ•°å®ä¾‹åŒ–

```java
@Test
public void test_constructor() throws Exception {
    Class<UserService> userServiceClass = UserService.class;
    Constructor<UserService> declaredConstructor = userServiceClass.getDeclaredConstructor(String.class);
    UserService userService = declaredConstructor.newInstance("å°å‚…å“¥");
    System.out.println(userService);
}
```

- ä»æœ€ç®€å•çš„æ“ä½œæ¥çœ‹ï¼Œå¦‚æœæœ‰æ„é€ å‡½æ•°çš„ç±»éœ€è¦å®ä¾‹åŒ–æ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `getDeclaredConstructor` è·å–æ„é€ å‡½æ•°ï¼Œä¹‹ååœ¨é€šè¿‡ä¼ é€’å‚æ•°è¿›è¡Œå®ä¾‹åŒ–ã€‚

#### 4.3 è·å–æ„é€ å‡½æ•°ä¿¡æ¯

```java
@Test
public void test_parameterTypes() throws Exception {
    Class<UserService> beanClass = UserService.class;
    Constructor<?>[] declaredConstructors = beanClass.getDeclaredConstructors();
    Constructor<?> constructor = declaredConstructors[0];
    Constructor<UserService> declaredConstructor = beanClass.getDeclaredConstructor(constructor.getParameterTypes());
    UserService userService = declaredConstructor.newInstance("å°å‚…å“¥");
    System.out.println(userService);
```

- è¿™ä¸ªæ¡ˆä¾‹ä¸­å…¶å®æœ€æ ¸å¿ƒçš„ç‚¹åœ¨äºè·å–ä¸€ä¸ªç±»ä¸­æ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•çš„ä½¿ç”¨ `beanClass.getDeclaredConstructors()`

#### 4.4 Cglib å®ä¾‹åŒ–

```java
@Test
public void test_cglib() {
    Enhancer enhancer = new Enhancer();
    enhancer.setSuperclass(UserService.class);
    enhancer.setCallback(new NoOp() {
        @Override
        public int hashCode() {
            return super.hashCode();
        }
    });
    Object obj = enhancer.create(new Class[]{String.class}, new Object[]{"å°å‚…å“¥"});
    System.out.println(obj);
}
```

- æ­¤æ¡ˆä¾‹æ¼”ç¤ºä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†å…³äº Cglib åœ¨ Spring å®¹å™¨ä¸­çš„ä½¿ç”¨éå¸¸å¤šï¼Œä¹Ÿå¯ä»¥æ·±å…¥çš„å­¦ä¹ ä¸€ä¸‹ Cglib çš„æ‰©å±•çŸ¥è¯†ã€‚

## å…­ã€æ€»ç»“

- æœ¬ç« èŠ‚çš„ä¸»è¦ä»¥å®Œå–„å®ä¾‹åŒ–æ“ä½œï¼Œå¢åŠ  InstantiationStrategy å®ä¾‹åŒ–ç­–ç•¥æ¥å£ï¼Œå¹¶æ–°å¢äº†ä¸¤ä¸ªå®ä¾‹åŒ–ç±»ã€‚è¿™éƒ¨åˆ†ç±»çš„åç§°ä¸å®ç°æ–¹å¼åŸºæœ¬æ˜¯ Spring æ¡†æ¶çš„ä¸€ä¸ªç¼©å°ç‰ˆï¼Œå¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥ä» Spring æºç æ‰¾åˆ°å¯¹åº”çš„ä»£ç ã€‚
- ä»æˆ‘ä»¬ä¸æ–­çš„å®Œå–„å¢åŠ éœ€æ±‚å¯ä»¥çœ‹åˆ°çš„ï¼Œå½“ä½ çš„ä»£ç ç»“æ„è®¾è®¡çš„è¾ƒä¸ºåˆç†çš„æ—¶å€™ï¼Œå°±å¯ä»¥éå¸¸å®¹æ˜“ä¸”æ–¹ä¾¿çš„è¿›è¡Œæ‰©å±•ä¸åŒå±æ€§çš„ç±»èŒè´£ï¼Œè€Œä¸ä¼šå› ä¸ºéœ€æ±‚çš„å¢åŠ å¯¼è‡´ç±»ç»“æ„æ··ä¹±ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬è‡ªå·±ä¸šåŠ¡éœ€æ±‚å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¦å°½å¯èƒ½çš„å»è€ƒè™‘ä¸€ä¸ªè‰¯å¥½çš„æ‰©å±•æ€§ä»¥åŠæ‹†åˆ†å¥½ç±»çš„èŒè´£ã€‚
- åŠ¨æ‰‹æ˜¯å­¦ä¹ èµ·æ¥æœ€å¿«çš„æ–¹å¼ï¼Œä¸è¦è®©çœ¼ç›æ˜¯æ„Ÿè§‰çœ‹ä¼šäº†ï¼Œä½†ä¸Šæ‰‹æ“ä½œå°±åºŸäº†ã€‚ä¹Ÿå¸Œæœ›æœ‰éœ€è¦çš„è¯»è€…å¯ä»¥äº²æ‰‹æ“ä½œä¸€ä¸‹ï¼ŒæŠŠä½ çš„æƒ³æ³•ä¹Ÿèå…¥åˆ°å¯è½åœ°å®ç°çš„ä»£ç é‡Œï¼Œçœ‹çœ‹æƒ³çš„å’Œåšçš„æ˜¯å¦ä¸€è‡´ã€‚
