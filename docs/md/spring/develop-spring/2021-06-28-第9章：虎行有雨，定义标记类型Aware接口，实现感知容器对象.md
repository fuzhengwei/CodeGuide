---
layout: post
category: spring
title: ç¬¬09ç« ï¼šAwareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡
tagline: by å°å‚…å“¥
tag: [java]
excerpt: åŒäº‹å†™çš„ä»£ç ï¼Œæˆ‘ç«Ÿä¸æ¯«çœ‹ä¸æ‡‚ï¼å¤§ä½¬çš„ä»£ç ï¼Œå°±åƒèµ–è›¤èŸ†æ³¡é’è›™ï¼Œé•¿çš„ä¸‘ç©çš„èŠ±ï¼šä¸€ä¸ªç±»å®ç°äº†å¤šä¸ªæ¥å£ã€ç»§æ‰¿çš„ç±»åˆç»§æ‰¿äº†å…¶ä»–ç±»ã€æ¥å£è¿˜å¯ä»¥å’Œæ¥å£ç»§æ‰¿ã€å®ç°æ¥å£çš„æŠ½è±¡ç±»å†ç”±ç±»å®ç°æŠ½è±¡ç±»æ–¹æ³•ã€ç±»Aç»§æ‰¿çš„ç±»Bå®ç°äº†ç±»Aå®ç°çš„æ¥å£Cï¼Œç­‰ç­‰ã€‚
lock: need
---

# ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 9 ç« ï¼šè™è¡Œæœ‰é›¨ï¼Œå®šä¹‰æ ‡è®°ç±»å‹Awareæ¥å£ï¼Œå®ç°æ„ŸçŸ¥å®¹å™¨å¯¹è±¡

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/KP_4IQ2MZ-Pzq80WrJpCOA](https://mp.weixin.qq.com/s/KP_4IQ2MZ-Pzq80WrJpCOA)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`åŒäº‹å†™çš„ä»£ç ï¼Œæˆ‘ç«Ÿä¸æ¯«çœ‹ä¸æ‡‚ï¼`

å¤§ä½¬çš„ä»£ç ï¼Œå°±åƒ **â€œèµ–è›¤èŸ†æ³¡é’è›™ï¼Œé•¿çš„ä¸‘ç©çš„èŠ±â€**ï¼šä¸€ä¸ªç±»å®ç°äº†å¤šä¸ªæ¥å£ã€ç»§æ‰¿çš„ç±»åˆç»§æ‰¿äº†å…¶ä»–ç±»ã€æ¥å£è¿˜å¯ä»¥å’Œæ¥å£ç»§æ‰¿ã€å®ç°æ¥å£çš„æŠ½è±¡ç±»å†ç”±ç±»å®ç°æŠ½è±¡ç±»æ–¹æ³•ã€ç±»Aç»§æ‰¿çš„ç±»Bå®ç°äº†ç±»Aå®ç°çš„æ¥å£Cï¼Œç­‰ç­‰ã€‚

çœ‹ä¸Šå»`å¤æ‚åˆéš¾æ‡‚`çš„ä»£ç ï¼Œå´åˆèƒ½ä¸€æ¬¡æ¬¡æ»¡è¶³éœ€æ±‚çš„é«˜æ•ˆè¿­ä»£å’Œé¡ºåˆ©æ‰©å±•ï¼Œè€Œåƒèºä¸é’‰ä¸€æ ·æ¬ç –çš„ä½ ï¼Œåªæ˜¯åœ¨`å¤§ä½¬`å†™çš„ä»£ç é‡Œï¼Œå®ŒæˆæŸä¸ªæ¥å£ä¸‹çš„ä¸€å°å—åŠŸèƒ½ï¼Œç”šè‡³å†™å®Œäº†ä¹Ÿä¸çŸ¥é“æ€ä¹ˆå°±è¢«è°ƒç”¨è¿è¡Œäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹åƒçœ‹ Spring æºç ä¸€æ ·ç¥å¥‡ï¼Œè·³æ¥è·³å»çš„æ‘¸ä¸ç€å¤´ç»ªï¼

å…¶å®è¿™ä¸»è¦æ˜¯å› ä¸ºä½ çš„ä»£ç æ˜¯å¦è¿ç”¨äº†è®¾è®¡æ¨¡å¼ï¼Œå½“ç„¶è®¾è®¡æ¨¡å¼ä¹Ÿæ²¡é‚£ä¹ˆç¥å¥‡ï¼Œå°±åƒä½ ä»¬ä¸¤å®¶éƒ½æ˜¯120å¹³ç±³çš„æˆ¿å­ï¼Œä»–å®¶æœ‰ä¸‰å®¤ä¸¤å…ä¸€å¨ä¸€å«ï¼Œå—åŒ—é€šé€ï¼Œå…¨é˜³é‡‡å…‰ã€‚ä½†ä½ å®¶å°±ä¸ä¸€æ ·äº†ï¼Œä½ å®¶æ˜¯é”…ç¢—ç“¢ç›†ã€å«æµ´é©¬æ¡¶ã€æ²™å‘èŒ¶å‡ è¿˜æœ‰é‚£1.8çš„åŒäººåºŠï¼Œåœ¨120å¹³ç±³çš„æˆ¿å­é‡Œæ•å¼€äº†æ”¾ï¼Œæ²¡æœ‰åŠ¨é™éš”ç¦»ï¼Œä¹Ÿæ²¡æœ‰å¹²æ¹¿åˆ†ç¦»ï¼Œçº¯è‡ªç”±å‘æŒ¥ã€‚*æ‰€ä»¥ä½ çš„ä»£ç çœ‹ä¸Šå»å°±ä¹±çš„å¾ˆï¼*

## äºŒã€ç›®æ ‡

ç›®å‰å·²å®ç°çš„ Spring æ¡†æ¶ï¼Œåœ¨ Bean æ“ä½œä¸Šèƒ½æä¾›å‡ºçš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼šBean å¯¹è±¡çš„å®šä¹‰å’Œæ³¨å†Œï¼Œä»¥åŠåœ¨æ“ä½œ Bean å¯¹è±¡è¿‡ç¨‹ä¸­æ‰§è¡Œçš„ï¼ŒBeanFactoryPostProcessorã€BeanPostProcessorã€InitializingBeanã€DisposableBeanï¼Œä»¥åŠåœ¨ XML æ–°å¢çš„ä¸€äº›é…ç½®å¤„ç†ï¼Œè®©æˆ‘ä»¬å¯ä»¥ Bean å¯¹è±¡æœ‰æ›´å¼ºçš„æ“ä½œæ€§ã€‚

é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æƒ³è·å¾— Spring æ¡†æ¶æä¾›çš„ BeanFactoryã€ApplicationContextã€BeanClassLoaderç­‰è¿™äº›èƒ½åŠ›åšä¸€äº›æ‰©å±•æ¡†æ¶çš„ä½¿ç”¨æ—¶è¯¥æ€ä¹ˆæ“ä½œå‘¢ã€‚æ‰€ä»¥æˆ‘ä»¬æœ¬ç« èŠ‚å¸Œæœ›åœ¨ Spring æ¡†æ¶ä¸­æä¾›ä¸€ç§èƒ½æ„ŸçŸ¥å®¹å™¨æ“ä½œçš„æ¥å£ï¼Œå¦‚æœè°å®ç°äº†è¿™æ ·çš„ä¸€ä¸ªæ¥å£ï¼Œå°±å¯ä»¥è·å–æ¥å£å…¥å‚ä¸­çš„å„ç±»èƒ½åŠ›ã€‚

## ä¸‰ã€è®¾è®¡

å¦‚æœè¯´æˆ‘å¸Œæœ›æ‹¿åˆ° Spring æ¡†æ¶ä¸­ä¸€äº›æä¾›çš„èµ„æºï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦è€ƒè™‘ä»¥ä¸€ä¸ªä»€ä¹ˆæ–¹å¼å»è·å–ï¼Œä¹‹åä½ å®šä¹‰å‡ºæ¥çš„è·å–æ–¹å¼ï¼Œåœ¨ Spring æ¡†æ¶ä¸­è¯¥æ€ä¹ˆå»æ‰¿æ¥ï¼Œå®ç°äº†è¿™ä¸¤é¡¹å†…å®¹ï¼Œå°±å¯ä»¥æ‰©å±•å‡ºä½ éœ€è¦çš„ä¸€äº›å±äº Spring æ¡†æ¶æœ¬èº«çš„èƒ½åŠ›äº†ã€‚

åœ¨å…³äº Bean å¯¹è±¡å®ä¾‹åŒ–é˜¶æ®µæˆ‘ä»¬æ“ä½œè¿‡ä¸€äº›é¢å¤–å®šä¹‰ã€å±æ€§ã€åˆå§‹åŒ–å’Œé”€æ¯çš„æ“ä½œï¼Œå…¶å®æˆ‘ä»¬å¦‚æœåƒè·å– Spring ä¸€äº›å¦‚ BeanFactoryã€ApplicationContext æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤ç±»æ–¹å¼è¿›è¡Œå®ç°ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ ‡è®°æ€§çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¸éœ€è¦æœ‰æ–¹æ³•ï¼Œå®ƒåªèµ·åˆ°æ ‡è®°ä½œç”¨å°±å¯ä»¥ï¼Œè€Œå…·ä½“çš„åŠŸèƒ½ç”±ç»§æ‰¿æ­¤æ¥å£çš„å…¶ä»–åŠŸèƒ½æ€§æ¥å£å®šä¹‰å…·ä½“æ–¹æ³•ï¼Œæœ€ç»ˆè¿™ä¸ªæ¥å£å°±å¯ä»¥é€šè¿‡ `instanceof` è¿›è¡Œåˆ¤æ–­å’Œè°ƒç”¨äº†ã€‚æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š

![](https://bugstack.cn/assets/images/spring/spring-9-01.png)

- å®šä¹‰æ¥å£ Awareï¼Œåœ¨ Spring æ¡†æ¶ä¸­å®ƒæ˜¯ä¸€ç§æ„ŸçŸ¥æ ‡è®°æ€§æ¥å£ï¼Œå…·ä½“çš„å­ç±»å®šä¹‰å’Œå®ç°èƒ½æ„ŸçŸ¥å®¹å™¨ä¸­çš„ç›¸å…³å¯¹è±¡ã€‚*ä¹Ÿå°±æ˜¯é€šè¿‡è¿™ä¸ªæ¡¥æ¢ï¼Œå‘å…·ä½“çš„å®ç°ç±»ä¸­æä¾›å®¹å™¨æœåŠ¡*
- ç»§æ‰¿ Aware çš„æ¥å£åŒ…æ‹¬ï¼šBeanFactoryAwareã€BeanClassLoaderAwareã€BeanNameAwareå’ŒApplicationContextAwareï¼Œå½“ç„¶åœ¨ Spring æºç ä¸­è¿˜æœ‰ä¸€äº›å…¶ä»–å…³äºæ³¨è§£çš„ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸åˆ°ã€‚
- åœ¨å…·ä½“çš„æ¥å£å®ç°è¿‡ç¨‹ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸€éƒ¨åˆ†(*BeanFactoryAwareã€BeanClassLoaderAwareã€BeanNameAware*)åœ¨ factory çš„ support æ–‡ä»¶å¤¹ä¸‹ï¼Œå¦å¤– ApplicationContextAware æ˜¯åœ¨ context çš„ support ä¸­ï¼Œè¿™æ˜¯å› ä¸ºä¸åŒçš„å†…å®¹è·å–éœ€è¦åœ¨ä¸åŒçš„åŒ…ä¸‹æä¾›ã€‚æ‰€ä»¥ï¼Œåœ¨ AbstractApplicationContext çš„å…·ä½“å®ç°ä¸­ä¼šç”¨åˆ°å‘ beanFactory æ·»åŠ  BeanPostProcessor å†…å®¹çš„ `ApplicationContextAwareProcessor` æ“ä½œï¼Œæœ€åç”± AbstractAutowireCapableBeanFactory åˆ›å»º createBean æ—¶å¤„ç†ç›¸åº”çš„è°ƒç”¨æ“ä½œã€‚*å…³äº applyBeanPostProcessorsBeforeInitialization å·²ç»åœ¨å‰é¢ç« èŠ‚ä¸­å®ç°è¿‡ï¼Œå¦‚æœå¿˜è®°å¯ä»¥å¾€å‰ç¿»ç¿»*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-08
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanFactoryPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanReference.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigurableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DisposableBeanAdapter.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ XmlBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ Aware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanClassLoaderAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactoryAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanNameAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ConfigurableListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DisposableBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ HierarchicalBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ InitializingBean.java
    â”‚           â”‚   â”‚   â””â”€â”€ ListableBeanFactory.java
    â”‚           â”‚   â”œâ”€â”€ BeansException.java
    â”‚           â”‚   â”œâ”€â”€ PropertyValue.java
    â”‚           â”‚   â””â”€â”€ PropertyValues.java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractRefreshableApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractXmlApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationContextAwareProcessor.java 
    â”‚           â”‚   â”‚   â””â”€â”€ ClassPathXmlApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContextAware.java 
    â”‚           â”‚   â””â”€â”€ ConfigurableApplicationContext.java
    â”‚           â”œâ”€â”€ core.io
    â”‚           â”‚   â”œâ”€â”€ ClassPathResource.java 
    â”‚           â”‚   â”œâ”€â”€ DefaultResourceLoader.java 
    â”‚           â”‚   â”œâ”€â”€ FileSystemResource.java 
    â”‚           â”‚   â”œâ”€â”€ Resource.java 
    â”‚           â”‚   â”œâ”€â”€ ResourceLoader.java 
    â”‚           â”‚   â””â”€â”€ UrlResource.java
    â”‚           â””â”€â”€ utils
    â”‚               â””â”€â”€ ClassUtils.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ UserDao.java
                â”‚   â””â”€â”€ UserService.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

Spring æ„ŸçŸ¥æ¥å£çš„è®¾è®¡å’Œå®ç°ç±»å…³ç³»ï¼Œå¦‚å›¾ 9-2

![å›¾ 9-2](https://bugstack.cn/assets/images/spring/spring-9-02.png)

- ä»¥ä¸Šæ•´ä¸ªç±»å…³ç³»å°±æ˜¯å…³äº Aware æ„ŸçŸ¥çš„å®šä¹‰å’Œå¯¹å®¹å™¨æ„ŸçŸ¥çš„å®ç°ã€‚
- Aware æœ‰å››ä¸ªç»§æ‰¿çš„æ¥å£ï¼Œå…¶ä»–è¿™äº›æ¥å£çš„ç»§æ‰¿éƒ½æ˜¯ä¸ºäº†ç»§æ‰¿ä¸€ä¸ªæ ‡è®°ï¼Œæœ‰äº†æ ‡è®°çš„å­˜åœ¨æ›´æ–¹ä¾¿ç±»çš„æ“ä½œå’Œå…·ä½“åˆ¤æ–­å®ç°ã€‚
- å¦å¤–ç”±äº ApplicationContext å¹¶ä¸æ˜¯åœ¨ AbstractAutowireCapableBeanFactory ä¸­ createBean æ–¹æ³•ä¸‹çš„å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦åƒå®¹å™¨ä¸­æ³¨å†Œ `addBeanPostProcessor` ï¼Œå†ç”±  createBean  ç»Ÿä¸€è°ƒç”¨ applyBeanPostProcessorsBeforeInitialization æ—¶è¿›è¡Œæ“ä½œã€‚

### 2. å®šä¹‰æ ‡è®°æ¥å£

**cn.bugstack.springframework.beans.factory.Aware**

```java
/**
 * Marker superinterface indicating that a bean is eligible to be
 * notified by the Spring container of a particular framework object
 * through a callback-style method.  Actual method signature is
 * determined by individual subinterfaces, but should typically
 * consist of just one void-returning method that accepts a single
 * argument.
 *
 * æ ‡è®°ç±»æ¥å£ï¼Œå®ç°è¯¥æ¥å£å¯ä»¥è¢«Springå®¹å™¨æ„ŸçŸ¥
 *
 */
public interface Aware {
}
```

- åœ¨ Spring ä¸­æœ‰ç‰¹åˆ«å¤šç±»ä¼¼è¿™æ ·çš„æ ‡è®°æ¥å£çš„è®¾è®¡æ–¹å¼ï¼Œå®ƒä»¬çš„å­˜åœ¨å°±åƒæ˜¯ä¸€ç§æ ‡ç­¾ä¸€æ ·ï¼Œå¯ä»¥æ–¹ä¾¿ç»Ÿä¸€æ‘˜å–å‡ºå±äºæ­¤ç±»æ¥å£çš„å®ç°ç±»ï¼Œé€šå¸¸ä¼šæœ‰ instanceof ä¸€èµ·åˆ¤æ–­ä½¿ç”¨ã€‚

### 3. å®¹å™¨æ„ŸçŸ¥ç±»

#### 3.1 BeanFactoryAware

**cn.bugstack.springframework.beans.factory.BeanFactoryAware**

```java
public interface BeanFactoryAware extends Aware {

   void setBeanFactory(BeanFactory beanFactory) throws BeansException;

}
```

- Interface to be implemented by beans that wish to be aware of their owning {@link BeanFactory}. 
- å®ç°æ­¤æ¥å£ï¼Œæ—¢èƒ½æ„ŸçŸ¥åˆ°æ‰€å±çš„ BeanFactory

#### 3.2 BeanClassLoaderAware

**cn.bugstack.springframework.beans.factory.BeanClassLoaderAware**

```java
public interface BeanClassLoaderAware extends Aware{

    void setBeanClassLoader(ClassLoader classLoader);

}
```

- Callback that allows a bean to be aware of the bean{@link ClassLoader class loader}; that is, the class loader used by the present bean factory to load bean classes.
- å®ç°æ­¤æ¥å£ï¼Œæ—¢èƒ½æ„ŸçŸ¥åˆ°æ‰€å±çš„ ClassLoader

#### 3.3 BeanNameAware

**cn.bugstack.springframework.beans.factory.BeanNameAware**

```java
public interface BeanNameAware extends Aware {

    void setBeanName(String name);

}
```

- Interface to be implemented by beans that want to be aware of their bean name in a bean factory. 
- å®ç°æ­¤æ¥å£ï¼Œæ—¢èƒ½æ„ŸçŸ¥åˆ°æ‰€å±çš„ BeanName

#### 3.4 ApplicationContextAware

**cn.bugstack.springframework.context.ApplicationContextAware**

```java
public interface ApplicationContextAware extends Aware {

    void setApplicationContext(ApplicationContext applicationContext) throws BeansException;

}
```

- Interface to be implemented by any object that wishes to be notifiedof the {@link ApplicationContext} that it runs in.
- å®ç°æ­¤æ¥å£ï¼Œæ—¢èƒ½æ„ŸçŸ¥åˆ°æ‰€å±çš„ ApplicationContext

### 4. åŒ…è£…å¤„ç†å™¨(ApplicationContextAwareProcessor)

**cn.bugstack.springframework.context.support.ApplicationContextAwareProcessor**

```java
public class ApplicationContextAwareProcessor implements BeanPostProcessor {

    private final ApplicationContext applicationContext;

    public ApplicationContextAwareProcessor(ApplicationContext applicationContext) {
        this.applicationContext = applicationContext;
    }

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (bean instanceof ApplicationContextAware){
            ((ApplicationContextAware) bean).setApplicationContext(applicationContext);
        }
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }

}
```

- ç”±äº ApplicationContext çš„è·å–å¹¶ä¸èƒ½ç›´æ¥åœ¨åˆ›å»º Bean æ—¶å€™å°±å¯ä»¥æ‹¿åˆ°ï¼Œæ‰€ä»¥éœ€è¦åœ¨ refresh æ“ä½œæ—¶ï¼ŒæŠŠ ApplicationContext å†™å…¥åˆ°ä¸€ä¸ªåŒ…è£…çš„ BeanPostProcessor ä¸­å»ï¼Œå†ç”± AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization æ–¹æ³•è°ƒç”¨ã€‚

### 5. æ³¨å†Œ BeanPostProcessor 

**cn.bugstack.springframework.context.support.AbstractApplicationContext**

```java
public abstract class AbstractApplicationContext extends DefaultResourceLoader implements ConfigurableApplicationContext {

    @Override
    public void refresh() throws BeansException {
        // 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition
        refreshBeanFactory();

        // 2. è·å– BeanFactory
        ConfigurableListableBeanFactory beanFactory = getBeanFactory();

        // 3. æ·»åŠ  ApplicationContextAwareProcessorï¼Œè®©ç»§æ‰¿è‡ª ApplicationContextAware çš„ Bean å¯¹è±¡éƒ½èƒ½æ„ŸçŸ¥æ‰€å±çš„ ApplicationContext
        beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));

        // 4. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)
        invokeBeanFactoryPostProcessors(beanFactory);

        // 5. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ
        registerBeanPostProcessors(beanFactory);

        // 6. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡
        beanFactory.preInstantiateSingletons();
    }
    
 	// ...   
}    
```

- refresh() æ–¹æ³•å°±æ˜¯æ•´ä¸ª Spring å®¹å™¨çš„æ“ä½œè¿‡ç¨‹ï¼Œä¸ä¸Šä¸€ç« èŠ‚å¯¹æ¯”ï¼Œæœ¬æ¬¡æ–°å¢åŠ äº†å…³äº addBeanPostProcessor çš„æ“ä½œã€‚
- æ·»åŠ  ApplicationContextAwareProcessorï¼Œè®©ç»§æ‰¿è‡ª ApplicationContextAware çš„ Bean å¯¹è±¡éƒ½èƒ½æ„ŸçŸ¥æ‰€å±çš„ ApplicationContextã€‚

### 6. æ„ŸçŸ¥è°ƒç”¨æ“ä½œ

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        // æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡
        registerDisposableBeanIfNecessary(beanName, bean, beanDefinition);

        addSingleton(beanName, bean);
        return bean;
    }

    private Object initializeBean(String beanName, Object bean, BeanDefinition beanDefinition) {

        // invokeAwareMethods
        if (bean instanceof Aware) {
            if (bean instanceof BeanFactoryAware) {
                ((BeanFactoryAware) bean).setBeanFactory(this);
            }
            if (bean instanceof BeanClassLoaderAware){
                ((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());
            }
            if (bean instanceof BeanNameAware) {
                ((BeanNameAware) bean).setBeanName(beanName);
            }
        }

        // 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†
        Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName);

        // æ‰§è¡Œ Bean å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•
        try {
            invokeInitMethods(beanName, wrappedBean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Invocation of init method of bean[" + beanName + "] failed", e);
        }

        // 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†
        wrappedBean = applyBeanPostProcessorsAfterInitialization(bean, beanName);
        return wrappedBean;
    }



    @Override
    public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException {
        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessBeforeInitialization(result, beanName);
            if (null == current) return result;
            result = current;
        }
        return result;
    }

    @Override
    public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException {
        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessAfterInitialization(result, beanName);
            if (null == current) return result;
            result = current;
        }
        return result;
    }

}
```
**cn.bugstack.springframework.beans.factory.support.AbstractBeanFactory**

```java
public abstract class AbstractBeanFactory extends DefaultSingletonBeanRegistry implements ConfigurableBeanFactory {

    /**
     * ClassLoader to resolve bean class names with, if necessary
     */
    private ClassLoader beanClassLoader = ClassUtils.getDefaultClassLoader();

    //...

    public ClassLoader getBeanClassLoader() {
        return this.beanClassLoader;
    }
}
```


- è¿™é‡Œæˆ‘ä»¬å»æ‰äº†ä¸€äº›ç±»çš„å†…å®¹ï¼Œåªä¿ç•™å…³äºæœ¬æ¬¡ Aware æ„ŸçŸ¥æ¥å£çš„æ“ä½œã€‚
- é¦–å…ˆåœ¨ initializeBean ä¸­ï¼Œé€šè¿‡åˆ¤æ–­ `bean instanceof Aware`ï¼Œè°ƒç”¨äº†ä¸‰ä¸ªæ¥å£æ–¹æ³•ï¼Œ`BeanFactoryAware.setBeanFactory(this)`ã€`BeanClassLoaderAware.setBeanClassLoader(getBeanClassLoader())`ã€`BeanNameAware.setBeanName(beanName)`ï¼Œè¿™æ ·å°±èƒ½é€šçŸ¥åˆ°å·²ç»å®ç°äº†æ­¤æ¥å£çš„ç±»ã€‚
- å¦å¤–æˆ‘ä»¬è¿˜å‘ BeanPostProcessor ä¸­æ·»åŠ äº† `ApplicationContextAwareProcessor`ï¼Œæ­¤æ—¶åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¹Ÿä¼šè¢«è°ƒç”¨åˆ°å…·ä½“çš„ç±»å®ç°ï¼Œå¾—åˆ°ä¸€ä¸ª ApplicationContex å±æ€§ã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**cn.bugstack.springframework.test.bean.UserDao**

```java
public class UserDao {

    private static Map<String, String> hashMap = new HashMap<>();

    public void initDataMethod(){
        System.out.println("æ‰§è¡Œï¼šinit-method");
        hashMap.put("10001", "å°å‚…å“¥");
        hashMap.put("10002", "å…«æ¯æ°´");
        hashMap.put("10003", "é˜¿æ¯›");
    }

    public void destroyDataMethod(){
        System.out.println("æ‰§è¡Œï¼šdestroy-method");
        hashMap.clear();
    }

    public String queryUserName(String uId) {
        return hashMap.get(uId);
    }

}
```

**cn.bugstack.springframework.test.bean.UserService**

```java
public class UserService implements BeanNameAware, BeanClassLoaderAware, ApplicationContextAware, BeanFactoryAware {

    private ApplicationContext applicationContext;
    private BeanFactory beanFactory;

    private String uId;
    private String company;
    private String location;
    private UserDao userDao;

    @Override
    public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
        this.beanFactory = beanFactory;
    }

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }

    @Override
    public void setBeanName(String name) {
        System.out.println("Bean Name isï¼š" + name);
    }

    @Override
    public void setBeanClassLoader(ClassLoader classLoader) {
        System.out.println("ClassLoaderï¼š" + classLoader);
    }

    // ...get/set
}
```

- UserDao æœ¬æ¬¡å¹¶æ²¡æœ‰ä»€ä¹ˆæ”¹å˜ï¼Œè¿˜æ˜¯æä¾›äº†å…³äºåˆå§‹åŒ–çš„æ–¹æ³•ï¼Œå¹¶åœ¨ Spring.xml ä¸­æä¾› init-methodã€destroy-method é…ç½®ä¿¡æ¯ã€‚
- UserService æ–°å¢åŠ ï¼ŒBeanNameAware, BeanClassLoaderAware, ApplicationContextAware, BeanFactoryAwareï¼Œå››ä¸ªæ„ŸçŸ¥çš„å®ç°ç±»ï¼Œå¹¶åœ¨ç±»ä¸­å®ç°ç›¸åº”çš„æ¥å£æ–¹æ³•ã€‚

### 2. é…ç½®æ–‡ä»¶

**åŸºç¡€é…ç½®ï¼Œæ— BeanFactoryPostProcessorã€BeanPostProcessorï¼Œå®ç°ç±»**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans>

    <bean id="userDao" class="cn.bugstack.springframework.test.bean.UserDao" init-method="initDataMethod" destroy-method="destroyDataMethod"/>

    <bean id="userService" class="cn.bugstack.springframework.test.bean.UserService">
        <property name="uId" value="10001"/>
        <property name="company" value="è…¾è®¯"/>
        <property name="location" value="æ·±åœ³"/>
        <property name="userDao" ref="userDao"/>
    </bean>

</beans>
```

- æœ¬ç« èŠ‚ä¸­å¹¶æ²¡æœ‰é¢å¤–æ–°å¢åŠ é…ç½®ä¿¡æ¯ï¼Œä¸ä¸Šä¸€ç« èŠ‚å†…å®¹ç›¸åŒã€‚

### 3. å•å…ƒæµ‹è¯•

```java
@Test
public void test_xml() {
    // 1.åˆå§‹åŒ– BeanFactory
    ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("classpath:spring.xml");
    applicationContext.registerShutdownHook();      

    // 2. è·å–Beanå¯¹è±¡è°ƒç”¨æ–¹æ³•
    UserService userService = applicationContext.getBean("userService", UserService.class);
    String result = userService.queryUserInfo();
    System.out.println("æµ‹è¯•ç»“æœï¼š" + result);
    System.out.println("ApplicationContextAwareï¼š"+userService.getApplicationContext());
    System.out.println("BeanFactoryAwareï¼š"+userService.getBeanFactory());
}
```

- æµ‹è¯•æ–¹æ³•ä¸­ä¸»è¦æ˜¯æ·»åŠ äº†ä¸€å†™å…³äºæ–°å¢ Aware å®ç°çš„è°ƒç”¨ï¼Œå…¶ä»–ä¸éœ€è¦è°ƒç”¨çš„ä¹Ÿæ‰“å°äº†ç›¸åº”çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥åœ¨æµ‹è¯•ç»“æœä¸­çœ‹åˆ°ã€‚

**æµ‹è¯•ç»“æœ**

```java
æ‰§è¡Œï¼šinit-method
ClassLoaderï¼šsun.misc.Launcher$AppClassLoader@14dad5dc
Bean Name isï¼šuserService
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥,è…¾è®¯,æ·±åœ³
ApplicationContextAwareï¼šcn.bugstack.springframework.context.support.ClassPathXmlApplicationContext@5ba23b66
BeanFactoryAwareï¼šcn.bugstack.springframework.beans.factory.support.DefaultListableBeanFactory@2ff4f00f
æ‰§è¡Œï¼šdestroy-method



Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæœ¬ç« èŠ‚æ–°å¢åŠ çš„æ„ŸçŸ¥æ¥å£å¯¹åº”çš„å…·ä½“å®ç°(BeanNameAware, BeanClassLoaderAware, ApplicationContextAware, BeanFactoryAware)ï¼Œå·²ç»å¯ä»¥å¦‚æœŸè¾“å‡ºç»“æœäº†ã€‚

## å…­ã€æ€»ç»“

- ç›®å‰å…³äº Spring æ¡†æ¶çš„å®ç°ä¸­ï¼ŒæŸäº›åŠŸèƒ½ç‚¹å·²ç»è¶Šæ¥è¶‹å‘äºå®Œæ•´ï¼Œå°¤å…¶æ˜¯ Bean å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå·²ç»æœ‰äº†å¾ˆå¤šçš„ä½“ç°ã€‚æ•´ä½“æ€»ç»“å¦‚å›¾ 9-3 

	![å›¾ 9-3](https://bugstack.cn/assets/images/spring/spring-9-03.png)
	
- æœ¬ç« èŠ‚å…³äº Aware çš„æ„ŸçŸ¥æ¥å£çš„å››ä¸ªç»§æ‰¿æ¥å£ BeanNameAware, BeanClassLoaderAware, ApplicationContextAware, BeanFactoryAware çš„å®ç°ï¼Œåˆæ‰©å±•äº† Spring çš„åŠŸèƒ½ã€‚å¦‚æœä½ æœ‰åšè¿‡å…³äº Spring ä¸­é—´ä»¶çš„å¼€å‘é‚£ä¹ˆä¸€å®šä¼šå¤§é‡ç”¨åˆ°è¿™äº›ç±»ï¼Œç°åœ¨ä½ ä¸åªæ˜¯ç”¨è¿‡ï¼Œè€Œä¸”è¿˜çŸ¥é“ä»–ä»¬éƒ½æ˜¯ä»€ä¹ˆæ—¶å€™è§¦è¾¾çš„ï¼Œåœ¨ä»¥åæƒ³æ’æŸ¥ç±»çš„å®ä¾‹åŒ–é¡ºåºä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ€è·¯äº†ã€‚
- æ¯ä¸€ç« èŠ‚å†…å®¹çš„å®ç°éƒ½æ˜¯åœ¨ä»¥è®¾è®¡æ¨¡å¼ä¸ºæ ¸å¿ƒçš„ç»“æ„ä¸Šå¡«å……å„é¡¹æ¨¡å—çš„åŠŸèƒ½ï¼Œå•çº¯çš„æ“ä½œç¼–å†™ä»£ç å¹¶ä¸ä¼šæœ‰å¤ªå¤šæ”¶è·ï¼Œä¸€å®šæ˜¯è¦ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œè¿™ä¹ˆè®¾è®¡çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆå°±é‚£ä¹ˆå¤šæ¥å£å’ŒæŠ½è±¡ç±»çš„åº”ç”¨ï¼Œè¿™äº›æ‰æ˜¯ Spring æ¡†æ¶å­¦ä¹ çš„æ ¸å¿ƒæ‰€åœ¨ã€‚	

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [Awareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•æ¡†æ¶ @Ray](https://t.zsxq.com/05vZ76aYr)
- [Awareæ„ŸçŸ¥å®¹å™¨å¯¹è±¡ @liuc](https://t.zsxq.com/07D3i4lRJ)