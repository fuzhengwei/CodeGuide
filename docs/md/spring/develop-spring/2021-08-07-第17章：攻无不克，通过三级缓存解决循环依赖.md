---
title: ç¬¬17ç« ï¼šé€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–
lock: need
---

# ç¬¬ 17 ç« ï¼šæ”»æ— ä¸å…‹ï¼Œé€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>æ˜Ÿçƒï¼š[https://articles.zsxq.com/id_w629m13v0hni.html](https://articles.zsxq.com/id_w629m13v0hni.html)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## é›¶ã€ä¼˜ç§€ä½œä¸š

- [ä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ– @Rechie](https://t.zsxq.com/06jEynIE2)
- [æ‰‹æ’•Spring-è§£å†³å¾ªç¯ä¾èµ–åŠ å±æ€§ç±»å‹è½¬åŒ– @Chin](https://t.zsxq.com/06AyBeiYN)
- [ä¸‰çº§ç¼“å­˜å¾ªç¯ä¾èµ–æ¢³ç† @èµ›åšä¸çœŸ](https://t.zsxq.com/08x6okqWE)
- [å¾ªç¯ä¾èµ–ä¸»è¦åˆ†ä¸ºä¸‰ç§ï¼šè‡ªèº«ä¾èµ–è‡ªèº«ã€äº’ç›¸å¾ªç¯ä¾èµ–ã€å¤šç»„å¾ªç¯ä¾èµ–ã€‚@æ°´ä¸­ææœˆ](https://t.zsxq.com/08USMN0DG)
- [åœ¨å®ä¾‹åŒ–å…¶ä»–beanå¯¹è±¡ä¹‹å‰å¯¹ConversionServiceFactoryBeanå¯¹è±¡æå‰æ³¨å†Œ @Liuliuliu](https://t.zsxq.com/0aifC9zGU)
- [å¾ªç¯ä¾èµ–æ˜¯ Spring é‡Œé¢å¾ˆé‡è¦çš„ä¸€ä¸ªè®¾è®¡ï¼Œå› ä¸ºå®ƒç”¨åˆ°äº†ä¸‰çº§ç¼“å­˜ @lucien](https://t.zsxq.com/0bRmz6qty)
- [éœ€è¦å®ç°ä¸€ä¸ª ConversionServiceFactoryBean æ¥å¯¹ç±»å‹è½¬æ¢æœåŠ¡è¿›è¡Œæ“ä½œ @lucien](https://t.zsxq.com/0bukMhjB7)
- [é€šè¿‡ä»£ç†å¯¹è±¡åˆ¤æ–­ï¼ŒClassUtils.isCglibProxyClass(aClass)? aClass.getSuperclass():aClass; å¤„ç†Cglibä»£ç†ä½¿ç”¨](https://t.zsxq.com/0bf6vuTJS)

## ä¸€ã€å‰è¨€

`å˜å“ˆå‘€ï¼Œåˆä¸æ˜¯ä¸èƒ½ç”¨ï¼`

æˆ‘ç»å¸¸è¯´ä¸šåŠ¡é€»è¾‘çš„ä»£ç å®ç°ï¼Œå°±åƒæ“¦å±å±çš„çº¸ï¼Œ`80%`çš„é¢ç§¯éƒ½æ˜¯ä¿æŠ¤æ‰‹çš„ã€‚è€Œé‚£`20%`çš„æ ¸å¿ƒæµç¨‹ä¹Ÿå°±ä»…ä»…æ˜¯ä½ è¯´çš„èƒ½ç”¨å°±è¡Œï¼Œåæ­£æ¯æ¬¡éƒ½æ´—æ‰‹å‘—ã€‚

å…¶å®æƒ³æŠŠç¨‹åºä»**èƒ½ç”¨**å®ç°åˆ°**å¥½ç”¨**å¹¶ä¸å®¹æ˜“ï¼Œè¿™åŒ…æ‹¬ä½ å¯¹ä¸šåŠ¡çš„ç†è§£ã€ä½ å¯¹æ¶æ„çš„æŠŠæ§ã€ä½ å¯¹ç»†èŠ‚çš„å®ç°ç­‰ç­‰ï¼Œä¹ŸåŒ…æ‹¬ä½ æ˜¯å¦èƒ½åšä¸€äº›åˆ—çš„æŠ½è±¡å®ç°ï¼Œä¸è‡³äºæ•´ä¸ªç¨‹åºéšç€å¼€å‘çš„è¶Šå¤šå°±å˜çš„è¶Šè‡ƒè‚¿ä¸å ªã€‚

é‚£ä¹ˆå¯¹äºç¼–ç¨‹ä¸Šçš„å†™`å¥½ç¨‹åºçš„ç†è§£`ï¼Œæˆ‘é€šå¸¸å–œæ¬¢ç”¨ç”Ÿæ´»ä¸­å®é™…çš„ä¾‹å­æ¥è¡¨è¾¾ï¼Œå› ä¸ºæœ‰ä¸å°‘å‰è¾ˆçš„ç ”å‘å¤§ç‰›éƒ½è¯´ï¼šâ€œä½ è¦é¢å¯¹å¯¹è±¡ç¼–ç¨‹â€ã€‚æ‰€ä»¥å˜ï¼Œæˆ‘å¯èƒ½ä¼šç”¨ç”Ÿæ´»ä¸­çš„è¶…å¸‚ã€å±•å°ã€è´§æ¶ã€å®˜æ¸¡ç­‰æ¥å¯¹æˆ‘çš„ç¨‹åºå¼€å‘ä¸­çš„ç±»æˆ–è€…é¢†åŸŸæœåŠ¡è¿›è¡Œå‘½åå’Œå®ç°ï¼Œè¿™æ ·æŠ½è±¡åŒ–å‡ºæ¥çš„ä»£ç é€»è¾‘æ›´å…·æœ‰æ‰©å±•æ€§ï¼Œä¹Ÿèƒ½è®©æ–°æ¥æ‰‹çš„äººå¿«é€Ÿç†è§£å¹¶ä¸”ä¸è‡³äºæ…Œä¹±çš„å¼€å‘ã€‚

## äºŒã€ç›®æ ‡

æŒ‰ç…§ç›®å‰æˆ‘ä»¬å®ç°çš„ Spring æ¡†æ¶ï¼Œæ˜¯å¯ä»¥æ»¡è¶³ä¸€ä¸ªåŸºæœ¬éœ€æ±‚çš„ï¼Œä½†å¦‚æœä½ é…ç½®äº†Aã€Bä¸¤ä¸ªBeanå¯¹è±¡äº’ç›¸ä¾èµ–ï¼Œé‚£ä¹ˆç«‹é©¬ä¼šæŠ›å‡º `java.lang.StackOverflowError`ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º`Aåˆ›å»º`æ—¶éœ€è¦ä¾èµ–`Båˆ›å»º`ï¼Œè€ŒBçš„åˆ›å»ºåˆä¾èµ–äºAåˆ›å»ºï¼Œå°±è¿™æ ·æ­»å¾ªç¯äº†ã€‚

è€Œè¿™ä¸ªå¾ªç¯ä¾èµ–åŸºæœ¬ä¹Ÿå¯ä»¥è¯´æ˜¯ Spring ä¸­éå¸¸ç»å…¸çš„å®ç°äº†ï¼Œæ‰€è¦è§£å†³çš„åœºæ™¯ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

![](https://bugstack.cn/assets/images/2020/interview/interview-31-1.png)

- å¾ªç¯ä¾èµ–ä¸»è¦åˆ†ä¸ºè¿™ä¸‰ç§ï¼Œè‡ªèº«ä¾èµ–äºè‡ªèº«ã€äº’ç›¸å¾ªç¯ä¾èµ–ã€å¤šç»„å¾ªç¯ä¾èµ–ã€‚
- ä½†æ— è®ºå¾ªç¯ä¾èµ–çš„æ•°é‡æœ‰å¤šå°‘ï¼Œå¾ªç¯ä¾èµ–çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚å°±æ˜¯ä½ çš„å®Œæ•´åˆ›å»ºä¾èµ–äºæˆ‘ï¼Œè€Œæˆ‘çš„å®Œæ•´åˆ›å»ºä¹Ÿä¾èµ–äºä½ ï¼Œä½†æˆ‘ä»¬äº’ç›¸æ²¡æ³•è§£è€¦ï¼Œæœ€ç»ˆå¯¼è‡´ä¾èµ–åˆ›å»ºå¤±è´¥ã€‚
- æ‰€ä»¥éœ€è¦ Spring æä¾›äº†é™¤äº†æ„é€ å‡½æ•°æ³¨å…¥å’ŒåŸå‹æ³¨å…¥å¤–çš„ï¼Œsetter å¾ªç¯ä¾èµ–æ³¨å…¥è§£å†³æ–¹æ¡ˆã€‚

## ä¸‰ã€è®¾è®¡

æŒ‰ç…§ Spring æ¡†æ¶çš„è®¾è®¡ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ–éœ€è¦ç”¨åˆ°ä¸‰ä¸ªç¼“å­˜ï¼Œè¿™ä¸‰ä¸ªç¼“å­˜åˆ†åˆ«å­˜æ”¾äº†`æˆå“å¯¹è±¡`ã€`åŠæˆå“å¯¹è±¡(æœªå¡«å……å±æ€§å€¼)`ã€`ä»£ç†å¯¹è±¡`ï¼Œåˆ†é˜¶æ®µå­˜æ”¾å¯¹è±¡å†…å®¹ï¼Œæ¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

**é‚£ä¹ˆ**ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªæ ¸å¿ƒçš„åŸç†ï¼Œå°±æ˜¯ç”¨äºè§£å†³å¾ªç¯ä¾èµ–å°±å¿…é¡»æ˜¯ä¸‰çº§ç¼“å­˜å‘¢ï¼ŒäºŒçº§è¡Œå—ï¼Ÿä¸€çº§å¯ä»¥ä¸ï¼Ÿå…¶å®éƒ½èƒ½è§£å†³ï¼Œåªä¸è¿‡ Spring æ¡†æ¶çš„å®ç°è¦ä¿è¯å‡ ä¸ªäº‹æƒ…ï¼Œå¦‚åªæœ‰ä¸€çº§ç¼“å­˜å¤„ç†æµç¨‹æ²¡æ³•æ‹†åˆ†ï¼Œå¤æ‚åº¦ä¹Ÿä¼šå¢åŠ ï¼ŒåŒæ—¶åŠæˆå“å¯¹è±¡å¯èƒ½ä¼šæœ‰ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚è€Œå°†åŠæˆå“ä¸æˆå“å¯¹è±¡åˆ†å¼€ï¼Œå¤„ç†èµ·æ¥ä¹Ÿæ›´åŠ ä¼˜é›…ã€ç®€å•ã€æ˜“æ‰©å±•ã€‚å¦å¤– Spring çš„ä¸¤å¤§ç‰¹æ€§ä¸­ä¸ä»…æœ‰ IOC è¿˜æœ‰ AOPï¼Œä¹Ÿå°±æ˜¯åŸºäºå­—èŠ‚ç å¢å¼ºåçš„æ–¹æ³•ï¼Œè¯¥å­˜æ”¾åˆ°å“ªï¼Œè€Œä¸‰çº§ç¼“å­˜æœ€ä¸»è¦ï¼Œè¦è§£å†³çš„å¾ªç¯ä¾èµ–å°±æ˜¯å¯¹ AOP çš„å¤„ç†ï¼Œä½†å¦‚æœæŠŠ AOP ä»£ç†å¯¹è±¡çš„åˆ›å»ºæå‰ï¼Œé‚£ä¹ˆäºŒçº§ç¼“å­˜ä¹Ÿä¸€æ ·å¯ä»¥è§£å†³ã€‚ä½†æ˜¯ï¼Œè¿™å°±è¿èƒŒäº† Spring åˆ›å»ºå¯¹è±¡çš„åŸåˆ™ï¼ŒSpring æ›´å–œæ¬¢æŠŠæ‰€æœ‰çš„æ™®é€š Bean éƒ½åˆå§‹åŒ–å®Œæˆï¼Œåœ¨å¤„ç†ä»£ç†å¯¹è±¡çš„åˆå§‹åŒ–ã€‚

**ä¸è¿‡**ï¼Œæ²¡å…³ç³»æˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ä»…é€‚ç”¨ä¸€çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ä»ä¸­å­¦ä¹ åˆ°å¤„ç†å¾ªç¯ä¾èµ–çš„æœ€æ ¸å¿ƒåŸæ¥ï¼Œä¹Ÿå°±æ˜¯é‚£20%çš„åœ°æ–¹ã€‚

![](https://bugstack.cn/assets/images/spring/spring-17-02.png)

- å¦‚æœä»…ä»¥ä¸€çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œé‚£ä¹ˆåœ¨å®ç°ä¸Šå¯ä»¥é€šè¿‡åœ¨Aå¯¹è±¡ newInstance åˆ›å»ºä¸”æœªå¡«å……å±æ€§åï¼Œç›´æ¥æ”¾å…¥ç¼“å­˜ä¸­ã€‚
- åœ¨`Aå¯¹è±¡`çš„å±æ€§å¡«å……`Bå¯¹è±¡`æ—¶ï¼Œå¦‚æœç¼“å­˜ä¸­ä¸èƒ½è·å–åˆ°`Bå¯¹è±¡`ï¼Œåˆ™å¼€å§‹åˆ›å»º`Bå¯¹è±¡`ï¼ŒåŒæ ·åˆ›å»ºå®Œæˆåï¼ŒæŠŠ`Bå¯¹è±¡`å¡«å……åˆ°ç¼“å­˜ä¸­å»ã€‚
- æ¥ä¸‹æ¥å°±å¼€å§‹å¯¹`Bå¯¹è±¡`çš„å±æ€§è¿›è¡Œå¡«å……ï¼Œæ°å¥½è¿™ä¼šå¯ä»¥ä»ç¼“å­˜ä¸­æ‹¿åˆ°`åŠæˆå“çš„Aå¯¹è±¡`ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™`Bå¯¹è±¡`çš„å±æ€§å°±å¡«å……å®Œäº†ã€‚
- æœ€åè¿”å›æ¥ç»§ç»­å®Œæˆ`Aå¯¹è±¡`çš„å±æ€§å¡«å……ï¼ŒæŠŠå®ä¾‹åŒ–åå¹¶å¡«å……äº†å±æ€§çš„`Bå¯¹è±¡`èµ‹å€¼ç»™Aå¯¹è±¡çš„`bå±æ€§`ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªå¾ªç¯ä¾èµ–æ“ä½œã€‚

**ä»£ç å®ç°**

```java
private final static Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);

private static <T> T getBean(Class<T> beanClass) throws Exception {
    String beanName = beanClass.getSimpleName().toLowerCase();
    if (singletonObjects.containsKey(beanName)) {
        return (T) singletonObjects.get(beanName);
    }
    // å®ä¾‹åŒ–å¯¹è±¡å…¥ç¼“å­˜
    Object obj = beanClass.newInstance();
    singletonObjects.put(beanName, obj);
    // å±æ€§å¡«å……è¡¥å…¨å¯¹è±¡
    Field[] fields = obj.getClass().getDeclaredFields();
    for (Field field : fields) {
        field.setAccessible(true);
        Class<?> fieldClass = field.getType();
        String fieldBeanName = fieldClass.getSimpleName().toLowerCase();
        field.set(obj, singletonObjects.containsKey(fieldBeanName) ? singletonObjects.get(fieldBeanName) : getBean(fieldClass));
        field.setAccessible(false);
    }
    return (T) obj;
}
```

- ä½¿ç”¨ä¸€çº§ç¼“å­˜å­˜æ”¾å¯¹è±¡çš„æ–¹å¼ï¼Œå°±æ˜¯è¿™æ ·ç®€å•çš„å®ç°è¿‡ç¨‹ï¼Œåªè¦æ˜¯åˆ›å»ºå®Œå¯¹è±¡ï¼Œç«‹é©¬å¡åˆ°ç¼“å­˜é‡Œå»ã€‚è¿™æ ·å°±å¯ä»¥åœ¨å…¶ä»–å¯¹è±¡åˆ›å»ºæ—¶å€™è·å–åˆ°å±æ€§éœ€è¦å¡«å……çš„å¯¹è±¡äº†ã€‚

**æµ‹è¯•ç»“æœ**

```java
public static void main(String[] args) throws Exception {
    System.out.println(getBean(B.class).getA());
    System.out.println(getBean(A.class).getB());
}

cn.bugstack.springframework.test.A@49476842
cn.bugstack.springframework.test.B@78308db1

Process finished with exit code 0
```

![](https://bugstack.cn/assets/images/spring/spring-17-03.png)

- ä»æµ‹è¯•æ•ˆæœå’Œæˆªå›¾ä¾èµ–è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸€çº§ç¼“å­˜ä¹Ÿå¯ä»¥è§£å†³ç®€å•åœºæ™¯çš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚
- å…¶å® `getBean`ï¼Œæ˜¯æ•´ä¸ªè§£å†³å¾ªç¯ä¾èµ–çš„æ ¸å¿ƒå†…å®¹ï¼ŒA åˆ›å»ºåå¡«å……å±æ€§æ—¶ä¾èµ– Bï¼Œé‚£ä¹ˆå°±å»åˆ›å»º Bï¼Œåœ¨åˆ›å»º B å¼€å§‹å¡«å……æ—¶å‘ç°ä¾èµ–äº Aï¼Œä½†æ­¤æ—¶ A è¿™ä¸ªåŠæˆå“å¯¹è±¡å·²ç»å­˜æ”¾åœ¨ç¼“å­˜åˆ°`singletonObjects` ä¸­äº†ï¼Œæ‰€ä»¥ B å¯ä»¥æ­£å¸¸åˆ›å»ºï¼Œåœ¨é€šè¿‡é€’å½’æŠŠ A ä¹Ÿåˆ›å»ºå®Œæ•´äº†ã€‚

---

æœ‰äº†ä»¥ä¸Šè¿™éƒ¨åˆ†å…³äºå¾ªç¯ä¾èµ–çš„å¤„ç†å†…å®¹ï¼Œåœ¨ç†è§£å¾ªç¯ä¾èµ–å°±æ²¡é‚£ä¹ˆå¤æ‚äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¸¦ç€è¿™ä¸ª`æ„Ÿè§‰`å»æ€è€ƒå¦‚æœæœ‰å¯¹è±¡ä¸åªæ˜¯ç®€å•çš„å¯¹è±¡ï¼Œè¿˜æœ‰ä»£ç†å¯¹è±¡ï¼Œè¿˜æœ‰AOPåº”ç”¨ï¼Œè¦æ€ä¹ˆå¤„ç†è¿™æ ·çš„ä¾èµ–é—®é¢˜ã€‚æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š

![](https://bugstack.cn/assets/images/spring/spring-17-04.png)

- å…³äºå¾ªç¯ä¾èµ–åœ¨æˆ‘ä»¬ç›®å‰çš„ Spring æ¡†æ¶ä¸­æ‰©å±•èµ·æ¥ä¹Ÿå¹¶ä¸ä¼šå¤ªå¤æ‚ï¼Œä¸»è¦å°±æ˜¯å¯¹äºåˆ›å»ºå¯¹è±¡çš„`æå‰æš´éœ²`ï¼Œå¦‚æœæ˜¯å·¥å‚å¯¹è±¡åˆ™ä¼šä½¿ç”¨ getEarlyBeanReference é€»è¾‘æå‰å°†å·¥å‚ğŸ­å¯¹è±¡å­˜æ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­ã€‚ç­‰åˆ°åç»­è·å–å¯¹è±¡çš„æ—¶å€™å®é™…æ‹¿åˆ°çš„æ˜¯å·¥å‚å¯¹è±¡ä¸­ getObjectï¼Œè¿™ä¸ªæ‰æ˜¯æœ€ç»ˆçš„å®é™…å¯¹è±¡ã€‚
- åœ¨åˆ›å»ºå¯¹è±¡çš„ `AbstractAutowireCapableBeanFactory#doCreateBean` æ–¹æ³•ä¸­ï¼Œæå‰æš´éœ²å¯¹è±¡ä»¥åï¼Œå°±å¯ä»¥é€šè¿‡æ¥ä¸‹æ¥çš„æµç¨‹ï¼ŒgetSingleton ä»ä¸‰ä¸ªç¼“å­˜ä¸­ä»¥æ­¤å¯»æ‰¾å¯¹è±¡ï¼Œä¸€çº§ã€äºŒçº§å¦‚æœæœ‰åˆ™ç›´æ¥å–èµ°ï¼Œå¦‚æœå¯¹è±¡æ˜¯ä¸‰çº§ç¼“å­˜ä¸­åˆ™ä¼šä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åå¹¶åˆ æ‰å·¥å‚å¯¹è±¡ï¼ŒæŠŠå®é™…å¯¹è±¡æ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚
- æœ€åæ˜¯å…³äºå•ä¾‹çš„å¯¹è±¡çš„æ³¨å†Œæ“ä½œï¼Œè¿™ä¸ªæ³¨å†Œæ“ä½œå°±æ˜¯æŠŠçœŸå®çš„å®é™…å¯¹è±¡æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œå› ä¸ºæ­¤æ—¶å®ƒå·²ç»æ˜¯ä¸€ä¸ªæˆå“å¯¹è±¡äº†ã€‚

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-16
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework
    â”‚           â”œâ”€â”€ aop
    â”‚           â”‚   â”œâ”€â”€ aspectj
    â”‚           â”‚   â”‚   â””â”€â”€ AspectJExpressionPointcut.java
    â”‚           â”‚   â”‚   â””â”€â”€ AspectJExpressionPointcutAdvisor.java
    â”‚           â”‚   â”œâ”€â”€ framework 
    â”‚           â”‚   â”‚   â”œâ”€â”€ adapter
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ MethodBeforeAdviceInterceptor.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ autoproxy
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ MethodBeforeAdviceInterceptor.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ AopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ Cglib2AopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ JdkDynamicAopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ProxyFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ ReflectiveMethodInvocation.java
    â”‚           â”‚   â”œâ”€â”€ AdvisedSupport.java
    â”‚           â”‚   â”œâ”€â”€ Advisor.java
    â”‚           â”‚   â”œâ”€â”€ BeforeAdvice.java
    â”‚           â”‚   â”œâ”€â”€ ClassFilter.java
    â”‚           â”‚   â”œâ”€â”€ MethodBeforeAdvice.java
    â”‚           â”‚   â”œâ”€â”€ MethodMatcher.java
    â”‚           â”‚   â”œâ”€â”€ Pointcut.java
    â”‚           â”‚   â”œâ”€â”€ PointcutAdvisor.java
    â”‚           â”‚   â””â”€â”€ TargetSource.java
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory  
    â”‚           â”‚   â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Autowired.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowiredAnnotationBeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Qualifier.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ Value.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanFactoryPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanReference.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigurableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationAwareBeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DisposableBeanAdapter.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ FactoryBeanRegistrySupport.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ XmlBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ Aware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanClassLoaderAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactoryAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanNameAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ConfigurableListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DisposableBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ FactoryBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ HierarchicalBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ InitializingBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ObjectFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ PropertyPlaceholderConfigurer.java
    â”‚           â”‚   â”œâ”€â”€ BeansException.java
    â”‚           â”‚   â”œâ”€â”€ PropertyValue.java
    â”‚           â”‚   â””â”€â”€ PropertyValues.java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”œâ”€â”€ ClassPathBeanDefinitionScanner.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ClassPathScanningCandidateComponentProvider.java 
    â”‚           â”‚   â”‚   â””â”€â”€ Scope.java 
    â”‚           â”‚   â”œâ”€â”€ event
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationEventMulticaster.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationContextEvent.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationEventMulticaster.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ContextClosedEvent.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ContextRefreshedEvent.java 
    â”‚           â”‚   â”‚   â””â”€â”€ SimpleApplicationEventMulticaster.java 
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractRefreshableApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractXmlApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationContextAwareProcessor.java 
    â”‚           â”‚   â”‚   â””â”€â”€ ClassPathXmlApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContextAware.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationEvent.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationEventPublisher.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationListener.java 
    â”‚           â”‚   â””â”€â”€ ConfigurableApplicationContext.java
    â”‚           â”œâ”€â”€ core.io
    â”‚           â”‚   â”œâ”€â”€ ClassPathResource.java 
    â”‚           â”‚   â”œâ”€â”€ DefaultResourceLoader.java 
    â”‚           â”‚   â”œâ”€â”€ FileSystemResource.java 
    â”‚           â”‚   â”œâ”€â”€ Resource.java 
    â”‚           â”‚   â”œâ”€â”€ ResourceLoader.java
    â”‚           â”‚   â””â”€â”€ UrlResource.java
    â”‚           â”œâ”€â”€ stereotype
    â”‚           â”‚   â””â”€â”€ Component.java
    â”‚           â””â”€â”€ utils
    â”‚               â”œâ”€â”€ ClassUtils.java
    â”‚               â””â”€â”€ StringValueResolver.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ Husband.java
                â”‚   â”œâ”€â”€ HusbandMother.java
                â”‚   â”œâ”€â”€ IMother.java
                â”‚   â”œâ”€â”€ SpouseAdvice.java  
                â”‚   â””â”€â”€ Wife.java
                â”œâ”€â”€ ApiTest.java
                â””â”€â”€ CircleTest.java  
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

å¤„ç†å¾ªç¯ä¾èµ–æ ¸å¿ƒæµç¨‹çš„ç±»å…³ç³»çš„æ“ä½œè¿‡ç¨‹åŒ…æ‹¬ï¼š
- å¾ªç¯ä¾èµ–çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ä¸»è¦åŒ…æ‹¬ DefaultSingletonBeanRegistry æä¾›ä¸‰çº§ç¼“å­˜ï¼š`singletonObjects`ã€`earlySingletonObjects`ã€`singletonFactories`ï¼Œåˆ†åˆ«å­˜æ”¾æˆå“å¯¹è±¡ã€åŠæˆå“å¯¹è±¡å’Œå·¥å‚å¯¹è±¡ã€‚åŒæ—¶åŒ…è£…ä¸‰ä¸ªç¼“å­˜æä¾›æ–¹æ³•ï¼šgetSingletonã€registerSingletonã€addSingletonFactoryï¼Œè¿™æ ·ä½¿ç”¨æ–¹å°±å¯ä»¥åˆ†åˆ«åœ¨ä¸åŒæ—¶é—´æ®µå­˜æ”¾å’Œè·å–å¯¹åº”çš„å¯¹è±¡äº†ã€‚
- åœ¨ AbstractAutowireCapableBeanFactory çš„ doCreateBean æ–¹æ³•ä¸­ï¼Œæä¾›äº†å…³äºæå‰æš´éœ²å¯¹è±¡çš„æ“ä½œï¼Œ`addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, beanDefinition, finalBean));`ï¼Œä»¥åŠåç»­è·å–å¯¹è±¡å’Œæ³¨å†Œå¯¹è±¡çš„æ“ä½œï¼Œ` exposedObject = getSingleton(beanName);`ã€`registerSingleton(beanName, exposedObject);`ï¼Œç»è¿‡è¿™æ ·çš„å¤„ç†å°±å¯ä»¥å®Œæˆå¯¹å¤æ‚åœºæ™¯å¾ªç¯ä¾èµ–çš„æ“ä½œã€‚
- å¦å¤–åœ¨ DefaultAdvisorAutoProxyCreator æä¾›çš„åˆ‡é¢æœåŠ¡ä¸­ï¼Œä¹Ÿéœ€è¦å®ç°æ¥å£ InstantiationAwareBeanPostProcessor æ–°å¢çš„ getEarlyBeanReference æ–¹æ³•ï¼Œä¾¿äºæŠŠä¾èµ–çš„åˆ‡é¢å¯¹è±¡ä¹Ÿèƒ½å­˜æ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œå¤„ç†å¯¹åº”çš„å¾ªç¯ä¾èµ–ã€‚

### 2. è®¾ç½®ä¸‰çº§ç¼“å­˜

**cn.bugstack.springframework.beans.factory.support.DefaultSingletonBeanRegistry**

```java
public class DefaultSingletonBeanRegistry implements SingletonBeanRegistry {

    // ä¸€çº§ç¼“å­˜ï¼Œæ™®é€šå¯¹è±¡
    private Map<String, Object> singletonObjects = new ConcurrentHashMap<>();

    // äºŒçº§ç¼“å­˜ï¼Œæå‰æš´æ¼å¯¹è±¡ï¼Œæ²¡æœ‰å®Œå…¨å®ä¾‹åŒ–çš„å¯¹è±¡
    protected final Map<String, Object> earlySingletonObjects = new HashMap<String, Object>();

    // ä¸‰çº§ç¼“å­˜ï¼Œå­˜æ”¾ä»£ç†å¯¹è±¡
    private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<String, ObjectFactory<?>>();

    private final Map<String, DisposableBean> disposableBeans = new LinkedHashMap<>();

    @Override
    public Object getSingleton(String beanName) {
        Object singletonObject = singletonObjects.get(beanName);
        if (null == singletonObject) {
            singletonObject = earlySingletonObjects.get(beanName);
            // åˆ¤æ–­äºŒçº§ç¼“å­˜ä¸­æ˜¯å¦æœ‰å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œå› ä¸ºåªæœ‰ä»£ç†å¯¹è±¡æ‰ä¼šæ”¾åˆ°ä¸‰çº§ç¼“å­˜ä¸­
            if (null == singletonObject) {
                ObjectFactory<?> singletonFactory = singletonFactories.get(beanName);
                if (singletonFactory != null) {
                    singletonObject = singletonFactory.getObject();
                    // æŠŠä¸‰çº§ç¼“å­˜ä¸­çš„ä»£ç†å¯¹è±¡ä¸­çš„çœŸå®å¯¹è±¡è·å–å‡ºæ¥ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ä¸­
                    earlySingletonObjects.put(beanName, singletonObject);
                    singletonFactories.remove(beanName);
                }
            }
        }
        return singletonObject;
    }

    public void registerSingleton(String beanName, Object singletonObject) {
        singletonObjects.put(beanName, singletonObject);
        earlySingletonObjects.remove(beanName);
        singletonFactories.remove(beanName);
    }

    protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory){
        if (!this.singletonObjects.containsKey(beanName)) {
            this.singletonFactories.put(beanName, singletonFactory);
            this.earlySingletonObjects.remove(beanName);
        }
    }

    public void registerDisposableBean(String beanName, DisposableBean bean) {
        disposableBeans.put(beanName, bean);
    }

}
```

- åœ¨ç”¨äºæä¾›å•ä¾‹å¯¹è±¡æ³¨å†Œçš„æ“ä½œçš„ DefaultSingletonBeanRegistry ç±»ä¸­ï¼Œå…±æœ‰ä¸‰ä¸ªç¼“å­˜å¯¹è±¡çš„å±æ€§ï¼›singletonObjectsã€earlySingletonObjectsã€singletonFactoriesï¼Œå¦‚å®ƒä»¬çš„åå­—ä¸€æ ·ï¼Œç”¨äºå­˜æ”¾ä¸åŒç±»å‹çš„å¯¹è±¡ï¼ˆå•ä¾‹å¯¹è±¡ã€æ—©æœŸçš„åŠæˆå“å•ä¾‹å¯¹è±¡ã€å•ä¾‹å·¥å‚å¯¹è±¡ï¼‰ã€‚
- ç´§æ¥ç€åœ¨è¿™ä¸‰ä¸ªç¼“å­˜å¯¹è±¡ä¸‹æä¾›äº†è·å–ã€æ·»åŠ å’Œæ³¨å†Œä¸åŒå¯¹è±¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼šgetSingletonã€registerSingletonã€addSingletonFactoryï¼Œå…¶å®åé¢è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ getSingleton çš„æ“ä½œï¼Œå®ƒæ˜¯åœ¨ä¸€å±‚å±‚å¤„ç†ä¸åŒæ—¶æœŸçš„å•ä¾‹å¯¹è±¡ï¼Œç›´è‡³æ‹¿åˆ°æœ‰æ•ˆçš„å¯¹è±¡ã€‚

### 3. æå‰æš´éœ²å¯¹è±¡

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    protected Object doCreateBean(String beanName, BeanDefinition beanDefinition, Object[] args) {
        Object bean = null;
        try {
            // å®ä¾‹åŒ– Bean
            bean = createBeanInstance(beanDefinition, beanName, args);

            // å¤„ç†å¾ªç¯ä¾èµ–ï¼Œå°†å®ä¾‹åŒ–åçš„Beanå¯¹è±¡æå‰æ”¾å…¥ç¼“å­˜ä¸­æš´éœ²å‡ºæ¥
            if (beanDefinition.isSingleton()) {
                Object finalBean = bean;
                addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, beanDefinition, finalBean));
            }

            // å®ä¾‹åŒ–ååˆ¤æ–­
            boolean continueWithPropertyPopulation = applyBeanPostProcessorsAfterInstantiation(beanName, bean);
            if (!continueWithPropertyPopulation) {
                return bean;
            }
            // åœ¨è®¾ç½® Bean å±æ€§ä¹‹å‰ï¼Œå…è®¸ BeanPostProcessor ä¿®æ”¹å±æ€§å€¼
            applyBeanPostProcessorsBeforeApplyingPropertyValues(beanName, bean, beanDefinition);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        // æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡
        registerDisposableBeanIfNecessary(beanName, bean, beanDefinition);

        // åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE
        Object exposedObject = bean;
        if (beanDefinition.isSingleton()) {
            // è·å–ä»£ç†å¯¹è±¡
            exposedObject = getSingleton(beanName);
            registerSingleton(beanName, exposedObject);
        }
        return exposedObject;

    }

    protected Object getEarlyBeanReference(String beanName, BeanDefinition beanDefinition, Object bean) {
        Object exposedObject = bean;
        for (BeanPostProcessor beanPostProcessor : getBeanPostProcessors()) {
            if (beanPostProcessor instanceof InstantiationAwareBeanPostProcessor) {
                exposedObject = ((InstantiationAwareBeanPostProcessor) beanPostProcessor).getEarlyBeanReference(exposedObject, beanName);
                if (null == exposedObject) return exposedObject;
            }
        }

        return exposedObject;
    }

   // ...
}
```

- åœ¨ AbstractAutowireCapableBeanFactory#doCreateBean çš„æ–¹æ³•ä¸­ä¸»è¦æ˜¯æ‰©å±•äº†å¯¹è±¡çš„æå‰æš´éœ²`addSingletonFactory`äº†ï¼Œå’Œå•ä¾‹å¯¹è±¡çš„è·å–`getSingleton`ä»¥åŠæ³¨å†Œæ“ä½œ`registerSingleton`ã€‚
- è¿™é‡Œæåˆ°ä¸€ç‚¹ getEarlyBeanReference å°±æ˜¯å®šä¹‰åœ¨å¦‚ AOP åˆ‡é¢ä¸­è¿™æ ·çš„ä»£ç†å¯¹è±¡ï¼Œå¯ä»¥å‚è€ƒæºç ä¸­æ¥å£ InstantiationAwareBeanPostProcessor#getEarlyBeanReference æ–¹æ³•çš„å®ç°ã€‚

## äº”ã€æµ‹è¯•

å› ä¸ºæ˜¯è¦æµ‹è¯•å¾ªç¯ä¾èµ–ï¼Œæˆ‘ä»¬æ‰¾ä¸€ä¸ªæ¯”è¾ƒè´´è¿‘çš„åœºæ™¯æ¥åšæµ‹è¯•ï¼Œ*æˆ‘è¯´è¿‡æˆ‘æ˜¯ä¸€ä¸ªå–œæ¬¢ä»ç”Ÿæ´»ä¸­å‘ç°é¢å‘å¯¹è±¡ç¼–ç¨‹çš„äºº* æˆ‘ä»¬çš„æ¡ˆä¾‹åœºæ™¯äººç‰©åŒ…æ‹¬ï¼šè€å…¬å’Œåª³å¦‡äº’ç›¸ä¾èµ–ã€å©†å©†æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿæˆä»£ç†å¦ˆå¦ˆèŒè´£ã€åœ¨åŠ ä¸Šä¸€ä¸ªåˆ‡é¢æ¥å…³å¿ƒå®¶åº­ç”Ÿæ´»ğŸ‘ª

### 1. äº‹å…ˆå‡†å¤‡

**è€å…¬ï¼Œç±»**

```java
public class Husband {

    private Wife wife;

    public String queryWife(){
        return "Husband.wife";
    }

}
```

**åª³å¦‡ï¼Œç±»**

```java
public class Wife {

    private Husband husband;
    private IMother mother; // å©†å©†

    public String queryHusband() {
        return "Wife.husbandã€Mother.callMotherï¼š" + mother.callMother();
    }

}
```

**å©†å©†ï¼Œä»£ç†äº†åª³å¦‡åŸæ¥å¦ˆå¦ˆçš„èŒè´£çš„ç±»**


```java
public class HusbandMother implements FactoryBean<IMother> {

    @Override
    public IMother getObject() throws Exception {
        return (IMother) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), new Class[]{IMother.class}, (proxy, method, args) -> "å©šååª³å¦‡å¦ˆå¦ˆçš„èŒè´£è¢«å©†å©†ä»£ç†äº†ï¼" + method.getName());
    }

}
```

**åˆ‡é¢ï¼Œç±»**

```java
public class SpouseAdvice implements MethodBeforeAdvice {

    @Override
    public void before(Method method, Object[] args, Object target) throws Throwable {
        System.out.println("å…³æ€€å°ä¸¤å£(åˆ‡é¢)ï¼š" + method);
    }

}
```

### 2. å±æ€§é…ç½®æ–‡ä»¶

**spring.xml**

```java
<bean id="husband" class="cn.bugstack.springframework.test.bean.Husband">
    <property name="wife" ref="wife"/>
</bean>
  
<bean id="wife" class="cn.bugstack.springframework.test.bean.Wife">
    <property name="husband" ref="husband"/>
    <property name="mother" ref="husbandMother"/>
</bean>
  
<bean id="husbandMother" class="cn.bugstack.springframework.test.bean.HusbandMother"/>

<!-- AOP é…ç½®ï¼ŒéªŒè¯ä¸‰çº§ç¼“å­˜ -->
<bean class="cn.bugstack.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"/>

<bean id="beforeAdvice" class="cn.bugstack.springframework.test.bean.SpouseAdvice"/>

<bean id="methodInterceptor" class="cn.bugstack.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor">
    <property name="advice" ref="beforeAdvice"/>
</bean>
  
<bean id="pointcutAdvisor" class="cn.bugstack.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor">
    <property name="expression" value="execution(* cn.bugstack.springframework.test.bean.Wife.*(..))"/>
    <property name="advice" ref="methodInterceptor"/>
</bean>
```

- è¿™ä¸ªé‡Œçš„é…ç½®å°±å¾ˆç®€å•äº†ï¼Œé…ç½®husbandä¾èµ–wifeï¼Œé…ç½®wifeä¾èµ–husbandå’Œmotherï¼Œæœ€åæ˜¯å…³äºAOPåˆ‡é¢çš„ä¾èµ–ä½¿ç”¨ã€‚

### 3. å•å…ƒæµ‹è¯•

```java
@Test
public void test_circular() {
    ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("classpath:spring.xml");
    Husband husband = applicationContext.getBean("husband", Husband.class);
    Wife wife = applicationContext.getBean("wife", Wife.class);
    System.out.println("è€å…¬çš„åª³å¦‡ï¼š" + husband.queryWife());
    System.out.println("åª³å¦‡çš„è€å…¬ï¼š" + wife.queryHusband());
}
```

**æµ‹è¯•ç»“æœ**

![](https://bugstack.cn/assets/images/spring/spring-17-06.png)

```java
è€å…¬çš„åª³å¦‡ï¼šHusband.wife
å…³æ€€å°ä¸¤å£(åˆ‡é¢)ï¼špublic java.lang.String cn.bugstack.springframework.test.bean.Wife.queryHusband()
åª³å¦‡çš„è€å…¬ï¼šWife.husbandã€Mother.callMotherï¼šå©šååª³å¦‡å¦ˆå¦ˆçš„èŒè´£è¢«å©†å©†ä»£ç†äº†ï¼callMother

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç®€å•å¯¹è±¡ä¾èµ– *è€å…¬ä¾èµ–åª³å¦‡ã€åª³å¦‡ä¾èµ–è€å…¬*ï¼Œè¿˜æ˜¯ä»£ç†å·¥ç¨‹å¯¹è±¡æˆ–è€… AOP åˆ‡é¢å¯¹è±¡éƒ½å¯ä»¥åœ¨ä¸‰çº§ç¼“å­˜ä¸‹è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜äº†ã€‚
- æ­¤å¤–ä»è¿è¡Œæˆªå›¾ `DefaultSingletonBeanRegistry#getSingleton` ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å‡¡äº‹éœ€è¦ä¸‰çº§ç¼“å­˜å­˜æ”¾å·¥å‚å¯¹è±¡çš„ç±»ï¼Œéƒ½ä¼šä½¿ç”¨åˆ° getObject è·å–çœŸå®å¯¹è±¡ï¼Œå¹¶éšåå­˜å…¥åŠæˆå“å¯¹è±¡ earlySingletonObjects ä¸­ä»¥åŠç§»é™¤å·¥å‚å¯¹è±¡ã€‚

## å…­ã€æ€»ç»“

- Spring ä¸­æ‰€æœ‰çš„åŠŸèƒ½éƒ½æ˜¯ä»¥è§£å†³ Java ç¼–ç¨‹ä¸­çš„ç‰¹æ€§è€Œå­˜åœ¨çš„ï¼Œå°±åƒæˆ‘ä»¬æœ¬ç« èŠ‚å¤„ç†çš„å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæ²¡æœ‰ Spring æ¡†æ¶çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½æˆ‘ä»¬ä¹Ÿä¼šå°½å¯èƒ½é¿å…å†™å‡ºå¾ªç¯ä¾èµ–çš„æ“ä½œï¼Œå› ä¸ºåœ¨æ²¡æœ‰ç»è¿‡åŠ å·¥å¤„ç†åï¼Œè¿™æ ·çš„ä¾èµ–å…³ç³»è‚¯å®šä¼šæŠ¥é”™çš„ã€‚*é‚£ä¹ˆè¿™ä¹Ÿå°±æ˜¯ç¨‹åºä»èƒ½ç”¨åˆ°å¥½ç”¨çš„å‡çº§*
- åœ¨è§£å†³å¾ªç¯ä¾èµ–çš„æ ¸å¿ƒæµç¨‹ä¸­ï¼Œä¸»è¦æ˜¯æå‰æš´éœ²å¯¹è±¡çš„è®¾è®¡ï¼Œä»¥åŠå»ºç«‹ä¸‰çº§ç¼“å­˜çš„æ•°æ®ç»“æ„æ¥å­˜æ”¾ä¸åŒæ—¶æœŸçš„å¯¹è±¡ï¼Œå¦‚æœè¯´æ²¡æœ‰å¦‚åˆ‡é¢å’Œå·¥å‚ä¸­çš„ä»£ç†å¯¹è±¡ï¼Œé‚£ä¹ˆäºŒçº§ç¼“å­˜ä¹Ÿå°±å¯ä»¥è§£å†³äº†ï¼Œå“ªæ€•æ˜¯åªæœ‰ä¸€çº§ç¼“å­˜ã€‚ä½†ä¸ºäº†è®¾è®¡ä¸Šçš„åˆç†å’Œå¯æ‰©å±•æ€§ï¼Œæ‰€ä»¥åˆ›å»ºäº†ä¸‰çº§ç¼“å­˜æ¥æ”¾ç½®ä¸åŒæ—¶æœŸçš„å¯¹è±¡ã€‚
- é€šè¿‡è¿™æ ·çš„å­¦ä¹ ä¹Ÿå¯ä»¥æ€è€ƒğŸ¤”æˆ‘ä»¬åœ¨åšç¨‹åºè®¾è®¡æ—¶ï¼Œå°†è¦ä¸Šçº¿çš„åŠŸèƒ½æ˜¯å¦èƒ½å…¨é¢æ”¯æ’‘èµ·ä¸šåŠ¡çš„æ‹“å±•å’Œé¢‘ç¹å˜åŒ–çš„ç‰¹æ€§ï¼Œæœ‰æ—¶å€™è¿™äº›è®¾è®¡æ€è·¯æ˜¯å¯ä»¥å¸®æˆ‘ä»¬æ‹“å®½æ›´å¤šçš„æŠ€æœ¯è®¾è®¡è§†é‡ã€‚*è®°å¾—è¦å¤šåŠ ç»ƒä¹ ï¼*