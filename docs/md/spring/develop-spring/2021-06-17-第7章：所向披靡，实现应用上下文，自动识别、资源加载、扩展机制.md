---
layout: post
category: spring
title: ç¬¬07ç« ï¼šå®ç°åº”ç”¨ä¸Šä¸‹æ–‡
tagline: by å°å‚…å“¥
tag: [java]
excerpt: ä½ è¿™ä»£ç ï¼Œå¯ä¸èƒ½å†™æ­»äº†å‘€ï¼è¯´åˆ°ä¸æŠŠä»£ç å†™æ­»ï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ç»§ç»­åœ¨æ‰‹å†™ Spring æ¡†æ¶ä¸­ç»§ç»­æ‰©å±•æ–°çš„åŠŸèƒ½ï¼Œå¦‚ä¸€ä¸ªBeançš„å®šä¹‰å’Œå®ä¾‹åŒ–çš„è¿‡ç¨‹å‰åï¼Œæ˜¯å¦å¯ä»¥æ»¡è¶³æˆ‘ä»¬è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼Œå¯¹Beanå¯¹è±¡æ‰§è¡Œä¸€äº›ä¿®æ”¹ã€å¢å¼ºã€è®°å½•ç­‰æ“ä½œå‘¢ï¼Ÿ è¿™ä¸ªè¿‡ç¨‹åŸºæœ¬å°±æ˜¯ä½ åœ¨ä½¿ç”¨ Spring å®¹å™¨æ¡†æ¶æ—¶å€™åšçš„ä¸€äº›ä¸­é—´ä»¶æ‰©å±•å¼€å‘ã€‚
lock: need
---

# ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 7 ç« ï¼šæ‰€å‘æŠ«é¡ï¼Œå®ç°åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œè‡ªåŠ¨è¯†åˆ«ã€èµ„æºåŠ è½½ã€æ‰©å±•æœºåˆ¶

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/sv0H1NAuO3s90HC6QpjP5g](https://mp.weixin.qq.com/s/sv0H1NAuO3s90HC6QpjP5g)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`ä½ è¿™ä»£ç ï¼Œå¯ä¸èƒ½å†™æ­»äº†å‘€ï¼`

ä¾ç…§é¡¹ç›®è½åœ°ç»éªŒæ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨æ‰¿æ¥ç´§æ€¥çš„äº§å“éœ€æ±‚æ—¶å€™ï¼Œé€šå¸¸ä¼šé€‰æ‹©åœ¨åŸæœ‰åŒç±»é¡¹ç›®ä¸­è¿›è¡Œæ‰©å±•ï¼Œå¦‚æœæ²¡æœ‰ç›¸å…³ç±»å‹é¡¹ç›®çš„å‚¨å¤‡ï¼Œä¹Ÿå¯èƒ½ä¼šé€‰æ‹©ä¸´æ—¶æ­å»ºå‡ºä¸€ä¸ªå·¥ç¨‹æ¥å®ç°äº§å“çš„éœ€æ±‚ã€‚ä½†è¿™ä¸ªæ—¶å€™å°±ä¼šé‡åˆ°éå¸¸ç°å®çš„é—®é¢˜ï¼Œé€‰æ‹©å®Œæ•´çš„è®¾è®¡å’Œå¼€å‘å°±å¯èƒ½æ»¡è¶³ä¸äº†ä¸Šçº¿æ—¶é—´ï¼Œä¸´æ—¶æ‹¼å‡‘å¼çš„å®Œæˆéœ€æ±‚åˆå¯èƒ½ä¸å…·å¤‡ä¸Šçº¿åå“åº”äº§å“çš„ä¸´æ—¶è°ƒæ•´ã€‚

ä¸Šçº¿åçš„è°ƒæ•´æœ‰å“ªäº›å‘¢ï¼Ÿé¡¹ç›®åˆšä¸€ä¸Šçº¿ï¼Œè¿è¥äº†è¿˜ä¸åˆ°åŠå¤©ï¼Œè€æ¿å‘ç°è‡ªå·±çš„é…ç½®çš„æ´»åŠ¨å¥½åƒé‡‘é¢é…ç½®çš„å¤ªå°äº†ï¼Œç”¨æˆ·éƒ½ä¸æ¥ï¼Œå‰²ä¸åˆ°éŸ­èœå‘€ã€‚`èµ¶ç´§åŠå¤œè”ç³»äº§å“ï¼Œæ¥æ¥æ¥ï¼Œä½ ç»™æˆ‘è¿™æ”¹æ”¹ï¼Œé‚£ä¿®ä¿®ï¼ŒæŠŠäººå‡ä¼˜æƒ 1ä¸‡å…ƒæ”¾å¤§å¤§çš„ï¼ŒæŠŠå¯èƒ½ä¸¤å­—ç¼©å°æ”¾åœ¨åé¢ã€‚å†æŠŠä¼˜æƒ çš„å¥–é‡‘æ± é…ç½®ä»10å…ƒè°ƒæ•´11å…ƒï¼Œå¿«å¿«å¿«ï¼Œèµ¶ç´§ä¿®æ”¹ï¼Œä½ ä¿®æ”¹äº†å’±ä»¬èƒ½èµš1ä¸ªäº¿ï¼ï¼ï¼`

å¥½å®¶ä¼™ï¼Œé¡¹ç›®æ˜¯ä¸´æ—¶å¼€å‘å †å‡ºæ¥çš„ï¼Œæ²¡æœ‰åå°ç³»ç»Ÿã€æ²¡æœ‰é…ç½®ä¸­å¿ƒã€æ²¡æœ‰æ¨¡å—æ‹†åˆ†ï¼Œè€æ¿ä¸€å¥å¥æ”¹æ”¹æ”¹ï¼Œäº§å“æ¥ä¼ è¾¾å‚¬ä¿ƒï¼Œæœ€åèƒŒé”…çš„å¯å°±æ˜¯ç ”å‘äº†ã€‚*ä½ è¿™ä¸èƒ½å†™æ­»ï¼Œè¿™ä¼˜æƒ é…ç½®å¾—æŠ½å‡ºæ¥ï¼Œè¿™æ–‡æ¡ˆä¹Ÿåå°ä¸‹å‘å§ï¼Œè¿™æ¥å£å…¥å‚ä¹Ÿå†™æ­»äº†ï¼Œå†å†™ä¸€ä¸ªæ–°æ¥å£å§ï¼* ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œç ”å‘æ¬ç –ä¿®æ¥å£ï¼Œè¿è¥æŠ˜è…¾å¥½å‡ å®¿ï¼Œæœ€åPV150ï¼

æ— è®ºä¸šåŠ¡ã€äº§å“ã€è¿è¥å¦‚ä½•ï¼Œä½†å°±ç ”å‘è‡ªèº«æ¥è®²ï¼Œå°½å¯èƒ½çš„è¦ä¸é¿å…ä¸´æ—¶å †å‡ºä¸€ä¸ªæœåŠ¡æ¥ï¼Œå°¤å…¶æ˜¯åœ¨å›¢é˜Ÿå»ºè®¾åˆæœŸæˆ–è€…è¿è¥æ€è·¯ç»å¸¸è°ƒæ•´çš„æƒ…å†µä¸‹ï¼Œæ›´è¦æ³¨é‡è®¾è®¡ç»†èŠ‚å’Œå®ç°æ–¹æ¡ˆã€‚å“ªæ€•å»æŠ¥é£é™©å»¶æœŸï¼Œä¹Ÿä¸è¦è®©è‡ªå·±èƒŒä¸Šä¸€ä¸ªæ˜çŸ¥æ˜¯çƒ‚å‘è¿˜è¦æ¥çš„æ´»ã€‚

è€Œæœ¬ç« èŠ‚è¯´åˆ°`ä¸æŠŠä»£ç å†™æ­»`ï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ç»§ç»­åœ¨æ‰‹å†™ Spring æ¡†æ¶ä¸­ç»§ç»­æ‰©å±•æ–°çš„åŠŸèƒ½ï¼Œå¦‚ä¸€ä¸ªBeançš„å®šä¹‰å’Œå®ä¾‹åŒ–çš„è¿‡ç¨‹å‰åï¼Œæ˜¯å¦å¯ä»¥æ»¡è¶³æˆ‘ä»¬è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼Œå¯¹Beanå¯¹è±¡æ‰§è¡Œä¸€äº›ä¿®æ”¹ã€å¢å¼ºã€è®°å½•ç­‰æ“ä½œå‘¢ï¼Ÿ *è¿™ä¸ªè¿‡ç¨‹åŸºæœ¬å°±æ˜¯ä½ åœ¨ä½¿ç”¨ Spring å®¹å™¨æ¡†æ¶æ—¶å€™åšçš„ä¸€äº›ä¸­é—´ä»¶æ‰©å±•å¼€å‘ã€‚* 

## äºŒã€ç›®æ ‡

å¦‚æœä½ åœ¨è‡ªå·±çš„å®é™…å·¥ä½œä¸­å¼€å‘è¿‡åŸºäº Spring çš„æŠ€æœ¯ç»„ä»¶ï¼Œæˆ–è€…å­¦ä¹ è¿‡å…³äº [SpringBoot ä¸­é—´ä»¶è®¾è®¡å’Œå¼€å‘](https://juejin.cn/book/6940996508632219689) ç­‰å†…å®¹ã€‚é‚£ä¹ˆä½ ä¸€å®šä¼šç»§æ‰¿æˆ–è€…å®ç°äº† Spring å¯¹å¤–æš´éœ²çš„ç±»æˆ–æ¥å£ï¼Œåœ¨æ¥å£çš„å®ç°ä¸­è·å–äº† BeanFactory ä»¥åŠ Bean å¯¹è±¡çš„è·å–ç­‰å†…å®¹ï¼Œå¹¶å¯¹è¿™äº›å†…å®¹åšä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ï¼šä¿®æ”¹ Bean çš„ä¿¡æ¯ï¼Œæ·»åŠ æ—¥å¿—æ‰“å°ã€å¤„ç†æ•°æ®åº“è·¯ç”±å¯¹æ•°æ®æºçš„åˆ‡æ¢ã€ç»™ RPC æœåŠ¡è¿æ¥æ³¨å†Œä¸­å¿ƒç­‰ã€‚

åœ¨å¯¹å®¹å™¨ä¸­ Bean çš„å®ä¾‹åŒ–è¿‡ç¨‹æ·»åŠ æ‰©å±•æœºåˆ¶çš„åŒæ—¶ï¼Œè¿˜éœ€è¦æŠŠç›®å‰å…³äº Spring.xml åˆå§‹åŒ–å’ŒåŠ è½½ç­–ç•¥è¿›è¡Œä¼˜åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¤ªå¯èƒ½è®©é¢å‘ Spring æœ¬èº«å¼€å‘çš„ `DefaultListableBeanFactory` æœåŠ¡ï¼Œç›´æ¥ç»™äºˆç”¨æˆ·ä½¿ç”¨ã€‚ä¿®æ”¹ç‚¹å¦‚ä¸‹ï¼š

![](https://bugstack.cn/assets/images/spring/spring-7-01.png)

- DefaultListableBeanFactoryã€XmlBeanDefinitionReaderï¼Œæ˜¯æˆ‘ä»¬åœ¨ç›®å‰ Spring æ¡†æ¶ä¸­å¯¹äºæœåŠ¡åŠŸèƒ½æµ‹è¯•çš„ä½¿ç”¨æ–¹å¼ï¼Œå®ƒèƒ½å¾ˆå¥½çš„ä½“ç°å‡º Spring æ˜¯å¦‚ä½•å¯¹ xml åŠ è½½ä»¥åŠæ³¨å†ŒBeanå¯¹è±¡çš„æ“ä½œè¿‡ç¨‹ï¼Œä½†è¿™ç§æ–¹å¼æ˜¯é¢å‘ Spring æœ¬èº«çš„ï¼Œè¿˜ä¸å…·å¤‡ä¸€å®šçš„æ‰©å±•æ€§ã€‚
- å°±åƒæˆ‘ä»¬ç°åœ¨éœ€è¦æä¾›å‡ºä¸€ä¸ªå¯ä»¥åœ¨ Bean åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå®Œæˆå¯¹ Bean å¯¹è±¡çš„æ‰©å±•æ—¶ï¼Œå°±å¾ˆéš¾åšåˆ°è‡ªåŠ¨åŒ–å¤„ç†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æŠŠ Bean å¯¹è±¡æ‰©å±•æœºåˆ¶åŠŸèƒ½å’Œå¯¹ Spring æ¡†æ¶ä¸Šä¸‹æ–‡çš„åŒ…è£…èåˆèµ·æ¥ï¼Œå¯¹å¤–æä¾›å®Œæ•´çš„æœåŠ¡ã€‚

## ä¸‰ã€è®¾è®¡

ä¸ºäº†èƒ½æ»¡è¶³äºåœ¨ Bean å¯¹è±¡ä»æ³¨å†Œåˆ°å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­æ‰§è¡Œç”¨æˆ·çš„è‡ªå®šä¹‰æ“ä½œï¼Œå°±éœ€è¦åœ¨ Bean çš„å®šä¹‰å’Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­æ’å…¥æ¥å£ç±»ï¼Œè¿™ä¸ªæ¥å£å†æœ‰å¤–éƒ¨å»å®ç°è‡ªå·±éœ€è¦çš„æœåŠ¡ã€‚é‚£ä¹ˆåœ¨ç»“åˆå¯¹ Spring æ¡†æ¶ä¸Šä¸‹æ–‡çš„å¤„ç†èƒ½åŠ›ï¼Œå°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„ç›®æ ‡éœ€æ±‚äº†ã€‚æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š

![](https://bugstack.cn/assets/images/spring/spring-7-02.png)

- æ»¡è¶³äºå¯¹ Bean å¯¹è±¡æ‰©å±•çš„ä¸¤ä¸ªæ¥å£ï¼Œå…¶å®ä¹Ÿæ˜¯ Spring æ¡†æ¶ä¸­éå¸¸å…·æœ‰é‡é‡çº§çš„ä¸¤ä¸ªæ¥å£ï¼š`BeanFactoryPostProcessor` å’Œ `BeanPostProcessor`ï¼Œä¹Ÿå‡ ä¹æ˜¯å¤§å®¶åœ¨ä½¿ç”¨ Spring æ¡†æ¶é¢å¤–æ–°å¢å¼€å‘è‡ªå·±ç»„å»ºéœ€æ±‚çš„ä¸¤ä¸ªå¿…å¤‡æ¥å£ã€‚
- BeanFactoryPostProcessorï¼Œæ˜¯ç”± Spring æ¡†æ¶ç»„å»ºæä¾›çš„å®¹å™¨æ‰©å±•æœºåˆ¶ï¼Œå…è®¸åœ¨ Bean å¯¹è±¡æ³¨å†Œåä½†æœªå®ä¾‹åŒ–ä¹‹å‰ï¼Œå¯¹ Bean çš„å®šä¹‰ä¿¡æ¯ `BeanDefinition` æ‰§è¡Œä¿®æ”¹æ“ä½œã€‚
- BeanPostProcessorï¼Œä¹Ÿæ˜¯ Spring æä¾›çš„æ‰©å±•æœºåˆ¶ï¼Œä¸è¿‡ BeanPostProcessor æ˜¯åœ¨ Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹åä¿®æ”¹ Bean å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ Bean å¯¹è±¡ã€‚è¿™éƒ¨åˆ†ä¸åé¢è¦å®ç°çš„ AOP æœ‰ç€å¯†åˆ‡çš„å…³ç³»ã€‚
- åŒæ—¶å¦‚æœåªæ˜¯æ·»åŠ è¿™ä¸¤ä¸ªæ¥å£ï¼Œä¸åšä»»ä½•åŒ…è£…ï¼Œé‚£ä¹ˆå¯¹äºä½¿ç”¨è€…æ¥è¯´è¿˜æ˜¯éå¸¸éº»çƒ¦çš„ã€‚æˆ‘ä»¬å¸Œæœ›äºå¼€å‘ Spring çš„ä¸Šä¸‹æ–‡æ“ä½œç±»ï¼ŒæŠŠç›¸åº”çš„ XML åŠ è½½ ã€æ³¨å†Œã€å®ä¾‹åŒ–ä»¥åŠæ–°å¢çš„ä¿®æ”¹å’Œæ‰©å±•éƒ½èåˆè¿›å»ï¼Œè®© Spring å¯ä»¥è‡ªåŠ¨æ‰«æåˆ°æˆ‘ä»¬çš„æ–°å¢æœåŠ¡ï¼Œä¾¿äºç”¨æˆ·ä½¿ç”¨ã€‚

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-06
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanFactoryPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanReference.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigurableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ XmlBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ConfigurableListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ HierarchicalBeanFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ ListableBeanFactory.java
    â”‚           â”‚   â”œâ”€â”€ BeansException.java
    â”‚           â”‚   â”œâ”€â”€ PropertyValue.java
    â”‚           â”‚   â””â”€â”€ PropertyValues.java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractRefreshableApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractXmlApplicationContext.java 
    â”‚           â”‚   â”‚   â””â”€â”€ ClassPathXmlApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContext.java 
    â”‚           â”‚   â””â”€â”€ ConfigurableApplicationContext.java
    â”‚           â”œâ”€â”€ core.io
    â”‚           â”‚   â”œâ”€â”€ ClassPathResource.java 
    â”‚           â”‚   â”œâ”€â”€ DefaultResourceLoader.java 
    â”‚           â”‚   â”œâ”€â”€ FileSystemResource.java 
    â”‚           â”‚   â”œâ”€â”€ Resource.java 
    â”‚           â”‚   â”œâ”€â”€ ResourceLoader.java 
    â”‚           â”‚   â””â”€â”€ UrlResource.java
    â”‚           â””â”€â”€ utils
    â”‚               â””â”€â”€ ClassUtils.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ UserDao.java
                â”‚   â””â”€â”€ UserService.java  
                â”œâ”€â”€ common
                â”‚   â”œâ”€â”€ MyBeanFactoryPostProcessor.java
                â”‚   â””â”€â”€ MyBeanPostProcessor.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

Spring åº”ç”¨ä¸Šä¸‹æ–‡å’Œå¯¹Beanå¯¹è±¡æ‰©å±•æœºåˆ¶çš„ç±»å…³ç³»ï¼Œå¦‚å›¾ 7-3

![å›¾ 7-3](https://bugstack.cn/assets/images/spring/spring-7-03.png)

- åœ¨æ•´ä¸ªç±»å›¾ä¸­ä¸»è¦ä½“ç°å‡ºæ¥çš„æ˜¯å…³äº Spring åº”ç”¨ä¸Šä¸‹æ–‡ä»¥åŠå¯¹ Bean å¯¹è±¡æ‰©å±•æœºåˆ¶çš„å®ç°ã€‚
- ä»¥ç»§æ‰¿äº† ListableBeanFactory æ¥å£çš„ ApplicationContext æ¥å£å¼€å§‹ï¼Œæ‰©å±•å‡ºä¸€ç³»åˆ—åº”ç”¨ä¸Šä¸‹æ–‡çš„æŠ½è±¡å®ç°ç±»ï¼Œå¹¶æœ€ç»ˆå®Œæˆ `ClassPathXmlApplicationContext` ç±»çš„å®ç°ã€‚è€Œè¿™ä¸ªç±»å°±æ˜¯æœ€åäº¤ç»™ç”¨æˆ·ä½¿ç”¨çš„ç±»ã€‚
- åŒæ—¶åœ¨å®ç°åº”ç”¨ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å®šä¹‰æ¥å£ï¼š`BeanFactoryPostProcessor`ã€`BeanPostProcessor` ä¸¤ä¸ªæ¥å£ï¼ŒæŠŠå…³äºå¯¹ Bean çš„æ‰©å±•æœºåˆ¶ä¸²è”è¿›å»äº†ã€‚

### 2. å®šä¹‰ BeanFactoryPostProcessor

**cn.bugstack.springframework.beans.factory.config.BeanFactoryPostProcessor**

```java
public interface BeanFactoryPostProcessor {

    /**
     * åœ¨æ‰€æœ‰çš„ BeanDefinition åŠ è½½å®Œæˆåï¼Œå®ä¾‹åŒ– Bean å¯¹è±¡ä¹‹å‰ï¼Œæä¾›ä¿®æ”¹ BeanDefinition å±æ€§çš„æœºåˆ¶
     *
     * @param beanFactory
     * @throws BeansException
     */
    void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException;

}
```

- åœ¨ Spring æºç ä¸­æœ‰è¿™æ ·ä¸€æ®µæè¿° `Allows for custom modification of an application context's bean definitions,adapting the bean property values of the context's underlying bean factory.` å…¶å®ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ¥å£æ˜¯æ»¡è¶³äºåœ¨æ‰€æœ‰çš„ BeanDefinition åŠ è½½å®Œæˆåï¼Œå®ä¾‹åŒ– Bean å¯¹è±¡ä¹‹å‰ï¼Œæä¾›ä¿®æ”¹ BeanDefinition å±æ€§çš„æœºåˆ¶ã€‚

### 3. å®šä¹‰ BeanPostProcessor 

**cn.bugstack.springframework.beans.factory.config.BeanPostProcessor**

```java
public interface BeanPostProcessor {

    /**
     * åœ¨ Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹å‰ï¼Œæ‰§è¡Œæ­¤æ–¹æ³•
     *
     * @param bean
     * @param beanName
     * @return
     * @throws BeansException
     */
    Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException;

    /**
     * åœ¨ Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹åï¼Œæ‰§è¡Œæ­¤æ–¹æ³•
     *
     * @param bean
     * @param beanName
     * @return
     * @throws BeansException
     */
    Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;

}
```

- åœ¨ Spring æºç ä¸­æœ‰è¿™æ ·ä¸€æ®µæè¿° `Factory hook that allows for custom modification of new bean instances,e.g. checking for marker interfaces or wrapping them with proxies.`ä¹Ÿå°±æ˜¯æä¾›äº†ä¿®æ”¹æ–°å®ä¾‹åŒ– Bean å¯¹è±¡çš„æ‰©å±•ç‚¹ã€‚ 
- å¦å¤–æ­¤æ¥å£æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼š`postProcessBeforeInitialization` ç”¨äºåœ¨ Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹å‰ï¼Œæ‰§è¡Œæ­¤æ–¹æ³•ã€`postProcessAfterInitialization`ç”¨äºåœ¨ Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹åï¼Œæ‰§è¡Œæ­¤æ–¹æ³•ã€‚ 

### 4. å®šä¹‰ä¸Šä¸‹æ–‡æ¥å£

**cn.bugstack.springframework.context.ApplicationContext** 

```java
public interface ApplicationContext extends ListableBeanFactory {
}
```

- context æ˜¯æœ¬æ¬¡å®ç°åº”ç”¨ä¸Šä¸‹æ–‡åŠŸèƒ½æ–°å¢çš„æœåŠ¡åŒ…
- ApplicationContextï¼Œç»§æ‰¿äº ListableBeanFactoryï¼Œä¹Ÿå°±ç»§æ‰¿äº†å…³äº BeanFactory æ–¹æ³•ï¼Œæ¯”å¦‚ä¸€äº› getBean çš„æ–¹æ³•ã€‚å¦å¤– ApplicationContext æœ¬èº«æ˜¯ Central æ¥å£ï¼Œä½†ç›®å‰è¿˜ä¸éœ€è¦æ·»åŠ ä¸€äº›è·å–IDå’Œçˆ¶ç±»ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰æ¥å£æ–¹æ³•çš„å®šä¹‰ã€‚

**cn.bugstack.springframework.context.ConfigurableApplicationContext**

```java
public interface ConfigurableApplicationContext extends ApplicationContext {

    /**
     * åˆ·æ–°å®¹å™¨
     *
     * @throws BeansException
     */
    void refresh() throws BeansException;

}
```

- ConfigurableApplicationContext ç»§æ‰¿è‡ª ApplicationContextï¼Œå¹¶æä¾›äº† refresh è¿™ä¸ªæ ¸å¿ƒæ–¹æ³•ã€‚*å¦‚æœä½ æœ‰çœ‹è¿‡ä¸€äº› Spring æºç ï¼Œé‚£ä¹ˆä¸€å®šä¼šçœ‹åˆ°è¿™ä¸ªæ–¹æ³•ã€‚* æ¥ä¸‹æ¥ä¹Ÿæ˜¯éœ€è¦åœ¨ä¸Šä¸‹æ–‡çš„å®ç°ä¸­å®Œæˆåˆ·æ–°å®¹å™¨çš„æ“ä½œè¿‡ç¨‹ã€‚

### 5. åº”ç”¨ä¸Šä¸‹æ–‡æŠ½è±¡ç±»å®ç°

**cn.bugstack.springframework.context.support.AbstractApplicationContext**

```java
public abstract class AbstractApplicationContext extends DefaultResourceLoader implements ConfigurableApplicationContext {

    @Override
    public void refresh() throws BeansException {
        // 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition
        refreshBeanFactory();

        // 2. è·å– BeanFactory
        ConfigurableListableBeanFactory beanFactory = getBeanFactory();

        // 3. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)
        invokeBeanFactoryPostProcessors(beanFactory);

        // 4. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ
        registerBeanPostProcessors(beanFactory);

        // 5. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡
        beanFactory.preInstantiateSingletons();
    }

    protected abstract void refreshBeanFactory() throws BeansException;

    protected abstract ConfigurableListableBeanFactory getBeanFactory();

    private void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {
        Map<String, BeanFactoryPostProcessor> beanFactoryPostProcessorMap = beanFactory.getBeansOfType(BeanFactoryPostProcessor.class);
        for (BeanFactoryPostProcessor beanFactoryPostProcessor : beanFactoryPostProcessorMap.values()) {
            beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);
        }
    }

    private void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) {
        Map<String, BeanPostProcessor> beanPostProcessorMap = beanFactory.getBeansOfType(BeanPostProcessor.class);
        for (BeanPostProcessor beanPostProcessor : beanPostProcessorMap.values()) {
            beanFactory.addBeanPostProcessor(beanPostProcessor);
        }
    }
    
    //... getBeanã€getBeansOfTypeã€getBeanDefinitionNames æ–¹æ³•

}
```

- AbstractApplicationContext ç»§æ‰¿ DefaultResourceLoader æ˜¯ä¸ºäº†å¤„ç† `spring.xml` é…ç½®èµ„æºçš„åŠ è½½ã€‚
- ä¹‹åæ˜¯åœ¨ refresh() å®šä¹‰å®ç°è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
    - 1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition
    - 2. è·å– BeanFactory  
    - 3. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the context.)
    - 4. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ
    - 5. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡
- å¦å¤–æŠŠå®šä¹‰å‡ºæ¥çš„æŠ½è±¡æ–¹æ³•ï¼ŒrefreshBeanFactory()ã€getBeanFactory() ç”±åé¢çš„ç»§æ‰¿æ­¤æŠ½è±¡ç±»çš„å…¶ä»–æŠ½è±¡ç±»å®ç°ã€‚

### 6. è·å–Beanå·¥å‚å’ŒåŠ è½½èµ„æº

**cn.bugstack.springframework.context.support.AbstractRefreshableApplicationContext**       

```java
public abstract class AbstractRefreshableApplicationContext extends AbstractApplicationContext {

    private DefaultListableBeanFactory beanFactory;

    @Override
    protected void refreshBeanFactory() throws BeansException {
        DefaultListableBeanFactory beanFactory = createBeanFactory();
        loadBeanDefinitions(beanFactory);
        this.beanFactory = beanFactory;
    }

    private DefaultListableBeanFactory createBeanFactory() {
        return new DefaultListableBeanFactory();
    }

    protected abstract void loadBeanDefinitions(DefaultListableBeanFactory beanFactory);

    @Override
    protected ConfigurableListableBeanFactory getBeanFactory() {
        return beanFactory;
    }

}
```

- åœ¨ refreshBeanFactory() ä¸­ä¸»è¦æ˜¯è·å–äº† `DefaultListableBeanFactory` çš„å®ä¾‹åŒ–ä»¥åŠå¯¹èµ„æºé…ç½®çš„åŠ è½½æ“ä½œ `loadBeanDefinitions(beanFactory)`ï¼Œåœ¨åŠ è½½å®Œæˆåå³å¯å®Œæˆå¯¹ spring.xml é…ç½®æ–‡ä»¶ä¸­ Bean å¯¹è±¡çš„å®šä¹‰å’Œæ³¨å†Œï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬å®ç°äº†æ¥å£ BeanFactoryPostProcessorã€BeanPostProcessor çš„é…ç½® Bean ä¿¡æ¯ã€‚ 
- ä½†æ­¤æ—¶èµ„æºåŠ è½½è¿˜åªæ˜¯å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡ç±»æ–¹æ³• `loadBeanDefinitions(DefaultListableBeanFactory beanFactory)`ï¼Œç»§ç»­ç”±å…¶ä»–æŠ½è±¡ç±»ç»§æ‰¿å®ç°ã€‚
  
### 7. ä¸Šä¸‹æ–‡ä¸­å¯¹é…ç½®ä¿¡æ¯çš„åŠ è½½

**cn.bugstack.springframework.context.support.AbstractXmlApplicationContext**

```java 
public abstract class AbstractXmlApplicationContext extends AbstractRefreshableApplicationContext {

    @Override
    protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) {
        XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory, this);
        String[] configLocations = getConfigLocations();
        if (null != configLocations){
            beanDefinitionReader.loadBeanDefinitions(configLocations);
        }
    }

    protected abstract String[] getConfigLocations();

}
```

- åœ¨ AbstractXmlApplicationContext æŠ½è±¡ç±»çš„ loadBeanDefinitions æ–¹æ³•å®ç°ä¸­ï¼Œä½¿ç”¨ XmlBeanDefinitionReader ç±»ï¼Œå¤„ç†äº†å…³äº XML æ–‡ä»¶é…ç½®ä¿¡æ¯çš„æ“ä½œã€‚
- åŒæ—¶è¿™é‡Œåˆç•™ä¸‹äº†ä¸€ä¸ªæŠ½è±¡ç±»æ–¹æ³•ï¼ŒgetConfigLocations()ï¼Œæ­¤æ–¹æ³•æ˜¯ä¸ºäº†ä»å…¥å£ä¸Šä¸‹æ–‡ç±»ï¼Œæ‹¿åˆ°é…ç½®ä¿¡æ¯çš„åœ°å€æè¿°ã€‚

### 8. åº”ç”¨ä¸Šä¸‹æ–‡å®ç°ç±»(ClassPathXmlApplicationContext)

**cn.bugstack.springframework.context.support.ClassPathXmlApplicationContext**

```java
public class ClassPathXmlApplicationContext extends AbstractXmlApplicationContext {

    private String[] configLocations;

    public ClassPathXmlApplicationContext() {
    }

    /**
     * ä» XML ä¸­åŠ è½½ BeanDefinitionï¼Œå¹¶åˆ·æ–°ä¸Šä¸‹æ–‡
     *
     * @param configLocations
     * @throws BeansException
     */
    public ClassPathXmlApplicationContext(String configLocations) throws BeansException {
        this(new String[]{configLocations});
    }

    /**
     * ä» XML ä¸­åŠ è½½ BeanDefinitionï¼Œå¹¶åˆ·æ–°ä¸Šä¸‹æ–‡
     * @param configLocations
     * @throws BeansException
     */
    public ClassPathXmlApplicationContext(String[] configLocations) throws BeansException {
        this.configLocations = configLocations;
        refresh();
    }

    @Override
    protected String[] getConfigLocations() {
        return configLocations;
    }

}
```

- ClassPathXmlApplicationContextï¼Œæ˜¯å…·ä½“å¯¹å¤–ç»™ç”¨æˆ·æä¾›çš„åº”ç”¨ä¸Šä¸‹æ–‡æ–¹æ³•ã€‚
- åœ¨ç»§æ‰¿äº† AbstractXmlApplicationContext ä»¥åŠå±‚å±‚æŠ½è±¡ç±»çš„åŠŸèƒ½åˆ†ç¦»å®ç°åï¼Œåœ¨æ­¤ç±» ClassPathXmlApplicationContext çš„å®ç°ä¸­å°±ç®€å•å¤šäº†ï¼Œä¸»è¦æ˜¯å¯¹ç»§æ‰¿æŠ½è±¡ç±»ä¸­æ–¹æ³•çš„è°ƒç”¨å’Œæä¾›äº†é…ç½®æ–‡ä»¶åœ°å€ä¿¡æ¯ã€‚

### 9. åœ¨Beanåˆ›å»ºæ—¶å®Œæˆå‰ç½®å’Œåç½®å¤„ç†

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        addSingleton(beanName, bean);
        return bean;
    }

    public InstantiationStrategy getInstantiationStrategy() {
        return instantiationStrategy;
    }

    public void setInstantiationStrategy(InstantiationStrategy instantiationStrategy) {
        this.instantiationStrategy = instantiationStrategy;
    }

    private Object initializeBean(String beanName, Object bean, BeanDefinition beanDefinition) {
        // 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†
        Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName);

        // å¾…å®Œæˆå†…å®¹ï¼šinvokeInitMethods(beanName, wrappedBean, beanDefinition);
        invokeInitMethods(beanName, wrappedBean, beanDefinition);

        // 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†
        wrappedBean = applyBeanPostProcessorsAfterInitialization(bean, beanName);
        return wrappedBean;
    }

    private void invokeInitMethods(String beanName, Object wrappedBean, BeanDefinition beanDefinition) {

    }

    @Override
    public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException {
        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessBeforeInitialization(result, beanName);
            if (null == current) return result;
            result = current;
        }
        return result;
    }

    @Override
    public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException {
        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessAfterInitialization(result, beanName);
            if (null == current) return result;
            result = current;
        }
        return result;
    }

}
```

- å®ç° BeanPostProcessor æ¥å£åï¼Œä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼Œ`postProcessBeforeInitialization`ã€`postProcessAfterInitialization`ï¼Œåˆ†åˆ«ä½œç”¨äº Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–å‰åçš„é¢å¤–å¤„ç†ã€‚
- ä¹Ÿå°±æ˜¯éœ€è¦åœ¨åˆ›å»º Bean å¯¹è±¡æ—¶ï¼Œåœ¨ createBean æ–¹æ³•ä¸­æ·»åŠ  `initializeBean(beanName, bean, beanDefinition);` æ“ä½œã€‚è€Œè¿™ä¸ªæ“ä½œä¸»è¦ä¸»è¦æ˜¯å¯¹äºæ–¹æ³• `applyBeanPostProcessorsBeforeInitialization`ã€`applyBeanPostProcessorsAfterInitialization` çš„ä½¿ç”¨ã€‚
- å¦å¤–éœ€è¦æä¸€ä¸‹ï¼ŒapplyBeanPostProcessorsBeforeInitializationã€applyBeanPostProcessorsAfterInitialization ä¸¤ä¸ªæ–¹æ³•æ˜¯åœ¨æ¥å£ç±» `AutowireCapableBeanFactory` ä¸­æ–°å¢åŠ çš„ã€‚
  
## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**cn.bugstack.springframework.test.bean.UserDao**

```java
public class UserDao {

    private static Map<String, String> hashMap = new HashMap<>();

    static {
        hashMap.put("10001", "å°å‚…å“¥");
        hashMap.put("10002", "å…«æ¯æ°´");
        hashMap.put("10003", "é˜¿æ¯›");
    }

    public String queryUserName(String uId) {
        return hashMap.get(uId);
    }

}
```

**cn.bugstack.springframework.test.bean.UserService**

```java
public class UserService {

    private String uId;
    private String company;
    private String location;
    private UserDao userDao;

    public String queryUserInfo() {
        return userDao.queryUserName(uId)+", å…¬å¸ï¼š"+company+", åœ°ç‚¹"+location;
    }

    // ...get/set
}
```

- Daoã€Serviceï¼Œæ˜¯æˆ‘ä»¬å¹³å¸¸å¼€å‘ç»å¸¸ä½¿ç”¨çš„åœºæ™¯ã€‚åœ¨ UserService ä¸­æ³¨å…¥ UserDaoï¼Œè¿™æ ·å°±èƒ½ä½“ç°å‡ºBeanå±æ€§çš„ä¾èµ–äº†ã€‚
- å¦å¤–è¿™é‡Œæ–°å¢åŠ äº† companyã€locationï¼Œä¸¤ä¸ªå±æ€§ä¿¡æ¯ï¼Œä¾¿äºæµ‹è¯• BeanPostProcessorã€BeanFactoryPostProcessor ä¸¤ä¸ªæ¥å£å¯¹ Bean å±æ€§ä¿¡æ¯æ‰©å±•çš„ä½œç”¨ã€‚

### 2. å®ç° BeanPostProcessor å’Œ BeanFactoryPostProcessor

**cn.bugstack.springframework.test.common.MyBeanFactoryPostProcessor**

```java
public class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor {

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {

        BeanDefinition beanDefinition = beanFactory.getBeanDefinition("userService");
        PropertyValues propertyValues = beanDefinition.getPropertyValues();

        propertyValues.addPropertyValue(new PropertyValue("company", "æ”¹ä¸ºï¼šå­—èŠ‚è·³åŠ¨"));
    }

}
```

**cn.bugstack.springframework.test.common.MyBeanPostProcessor**

```java
public class MyBeanPostProcessor implements BeanPostProcessor {

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if ("userService".equals(beanName)) {
            UserService userService = (UserService) bean;
            userService.setLocation("æ”¹ä¸ºï¼šåŒ—äº¬");
        }
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }

}
```

- å¦‚æœä½ åœ¨ Spring ä¸­åšè¿‡ä¸€äº›ç»„ä»¶çš„å¼€å‘é‚£ä¹ˆä¸€å®šéå¸¸ç†Ÿæ‚‰è¿™ä¸¤ä¸ªç±»ï¼Œæœ¬æ–‡çš„æµ‹è¯•ä¹Ÿæ˜¯å®ç°äº†è¿™ä¸¤ä¸ªç±»ï¼Œå¯¹å®ä¾‹åŒ–è¿‡ç¨‹ä¸­çš„ Bean å¯¹è±¡åšä¸€äº›æ“ä½œã€‚

### 3. é…ç½®æ–‡ä»¶

**åŸºç¡€é…ç½®ï¼Œæ— BeanFactoryPostProcessorã€BeanPostProcessorï¼Œå®ç°ç±»**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans>

    <bean id="userDao" class="cn.bugstack.springframework.test.bean.UserDao"/>

    <bean id="userService" class="cn.bugstack.springframework.test.bean.UserService">
        <property name="uId" value="10001"/>
        <property name="company" value="è…¾è®¯"/>
        <property name="location" value="æ·±åœ³"/>
        <property name="userDao" ref="userDao"/>
    </bean>

</beans>
```

**å¢å¼ºé…ç½®ï¼Œæœ‰BeanFactoryPostProcessorã€BeanPostProcessorï¼Œå®ç°ç±»**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans>

    <bean id="userDao" class="cn.bugstack.springframework.test.bean.UserDao"/>

    <bean id="userService" class="cn.bugstack.springframework.test.bean.UserService">
        <property name="uId" value="10001"/>
        <property name="company" value="è…¾è®¯"/>
        <property name="location" value="æ·±åœ³"/>
        <property name="userDao" ref="userDao"/>
    </bean>

    <bean class="cn.bugstack.springframework.test.common.MyBeanPostProcessor"/>
    <bean class="cn.bugstack.springframework.test.common.MyBeanFactoryPostProcessor"/>

</beans>
```

- è¿™é‡Œæä¾›äº†ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ä¸åŒ…å«BeanFactoryPostProcessorã€BeanPostProcessorï¼Œå¦å¤–ä¸€ä¸ªæ˜¯åŒ…å«çš„ã€‚ä¹‹æ‰€ä»¥è¿™æ ·é…ç½®ä¸»è¦å¯¹ç…§éªŒè¯ï¼Œåœ¨è¿ç”¨ Spring æ–°å¢åŠ çš„åº”ç”¨ä¸Šä¸‹æ–‡å’Œä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œéƒ½æ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚

### 4. ä¸ç”¨åº”ç”¨ä¸Šä¸‹æ–‡

```java
@Test
public void test_BeanFactoryPostProcessorAndBeanPostProcessor(){
    // 1.åˆå§‹åŒ– BeanFactory
    DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();

    // 2. è¯»å–é…ç½®æ–‡ä»¶&æ³¨å†ŒBean
    XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(beanFactory);
    reader.loadBeanDefinitions("classpath:spring.xml");

    // 3. BeanDefinition åŠ è½½å®Œæˆ & Beanå®ä¾‹åŒ–ä¹‹å‰ï¼Œä¿®æ”¹ BeanDefinition çš„å±æ€§å€¼
    MyBeanFactoryPostProcessor beanFactoryPostProcessor = new MyBeanFactoryPostProcessor();
    beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);

    // 4. Beanå®ä¾‹åŒ–ä¹‹åï¼Œä¿®æ”¹ Bean å±æ€§ä¿¡æ¯
    MyBeanPostProcessor beanPostProcessor = new MyBeanPostProcessor();
    beanFactory.addBeanPostProcessor(beanPostProcessor);

    // 5. è·å–Beanå¯¹è±¡è°ƒç”¨æ–¹æ³•
    UserService userService = beanFactory.getBean("userService", UserService.class);
    String result = userService.queryUserInfo();
    System.out.println("æµ‹è¯•ç»“æœï¼š" + result);
}
```

- DefaultListableBeanFactory åˆ›å»º beanFactory å¹¶ä½¿ç”¨ XmlBeanDefinitionReader åŠ è½½é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿˜æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ã€‚
- æ¥ä¸‹æ¥å°±æ˜¯å¯¹ MyBeanFactoryPostProcessor å’Œ MyBeanPostProcessor çš„å¤„ç†ï¼Œä¸€ä¸ªæ˜¯åœ¨BeanDefinition åŠ è½½å®Œæˆ & Beanå®ä¾‹åŒ–ä¹‹å‰ï¼Œä¿®æ”¹ BeanDefinition çš„å±æ€§å€¼ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯åœ¨Beanå®ä¾‹åŒ–ä¹‹åï¼Œä¿®æ”¹ Bean å±æ€§ä¿¡æ¯ã€‚

**æµ‹è¯•ç»“æœ**

```java
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥,æ”¹ä¸ºï¼šå­—èŠ‚è·³åŠ¨,æ”¹ä¸ºï¼šåŒ—äº¬

Process finished with exit code 0
```

- é€šè¿‡æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é…ç½®çš„å±æ€§ä¿¡æ¯å·²ç»ä¸ spring.xml é…ç½®æ–‡ä»¶ä¸­ä¸ä¸€æ ·äº†ã€‚

### 5. ä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡

```java
@Test
public void test_xml() {
    // 1.åˆå§‹åŒ– BeanFactory
    ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("classpath:springPostProcessor.xml");

    // 2. è·å–Beanå¯¹è±¡è°ƒç”¨æ–¹æ³•
    UserService userService = applicationContext.getBean("userService", UserService.class);
    String result = userService.queryUserInfo();
    System.out.println("æµ‹è¯•ç»“æœï¼š" + result);
}
```

- å¦å¤–ä½¿ç”¨æ–°å¢åŠ çš„ ClassPathXmlApplicationContext åº”ç”¨ä¸Šä¸‹æ–‡ç±»ï¼Œå†æ“ä½œèµ·æ¥å°±æ–¹ä¾¿å¤šäº†ï¼Œ*è¿™æ‰æ˜¯é¢å‘ç”¨æˆ·ä½¿ç”¨çš„ç±»*ï¼Œåœ¨è¿™é‡Œå¯ä»¥ä¸€æ­¥æŠŠé…ç½®æ–‡ä»¶äº¤ç»™ ClassPathXmlApplicationContextï¼Œä¹Ÿä¸éœ€è¦ç®¡ç†ä¸€äº›è‡ªå®šä¹‰å®ç°çš„ Spring æ¥å£çš„ç±»ã€‚

**æµ‹è¯•ç»“æœ**

```java
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥,æ”¹ä¸ºï¼šå­—èŠ‚è·³åŠ¨,æ”¹ä¸ºï¼šåŒ—äº¬

Process finished with exit code 0
```

- è¿™ä¸ä¸ç”¨åº”ç”¨ä¸Šä¸‹æ–‡çš„æµ‹è¯•ç»“æœæ˜¯ä¸€æ ·ï¼Œä¸è¿‡ç°åœ¨çš„æ–¹å¼æ›´åŠ æ–¹ä¾¿äº†ã€‚

## å…­ã€æ€»ç»“

- æœ¬æ–‡ä¸»è¦æ–°å¢äº† Spring æ¡†æ¶ä¸­ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¥å£ BeanFactoryPostProcessã€BeanPostProcessor åŒæ—¶è¿˜æ·»åŠ äº†å…³äºåº”ç”¨ä¸Šä¸‹æ–‡çš„å®ç°ï¼ŒApplicationContext æ¥å£çš„å®šä¹‰æ˜¯ç»§æ‰¿ BeanFactory å¤–æ–°å¢åŠ åŠŸèƒ½çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ»¡è¶³äºè‡ªåŠ¨è¯†åˆ«ã€èµ„æºåŠ è½½ã€å®¹å™¨äº‹ä»¶ã€ç›‘å¬å™¨ç­‰åŠŸèƒ½ï¼ŒåŒæ—¶ä¾‹å¦‚ä¸€äº›å›½é™…åŒ–æ”¯æŒã€å•ä¾‹Beanè‡ªåŠ¨åˆå§‹åŒ–ç­‰ï¼Œä¹Ÿæ˜¯å¯ä»¥åœ¨è¿™ä¸ªç±»é‡Œå®ç°å’Œæ‰©å……çš„ã€‚
- é€šè¿‡æœ¬æ–‡çš„å®ç°ä¸€å®šä¼šéå¸¸äº†è§£ BeanFactoryPostProcessã€BeanPostProcessorï¼Œä»¥åå†åšä¸€äº›å…³äº Spring ä¸­é—´ä»¶çš„å¼€å‘æ—¶ï¼Œå¦‚æœéœ€è¦ç”¨åˆ° Bean å¯¹è±¡çš„è·å–ä»¥åŠä¿®æ”¹ä¸€äº›å±æ€§ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ¥å£äº†ã€‚åŒæ—¶ BeanPostProcessor ä¹Ÿæ˜¯å®ç° AOP åˆ‡é¢æŠ€æœ¯çš„å…³é”®æ‰€åœ¨ã€‚
- æœ‰äººé—®ï¼š`é¢è¯•é—®é‚£ä¹ˆå¤šï¼Œå¯æ˜¯å·¥ä½œåˆç”¨ä¸åˆ°ï¼Œæ˜¯å˜å“ˆä¹ˆå‘¢ï¼Ÿ`ï¼Œå˜å“ˆä¹ˆï¼Œé‚£ä½ è¯´ä½ å¼€è½¦ä¸Šæ¡¥çš„æ—¶å€™ï¼Œä¼šæ¯æ¬¡éƒ½æ’ä¸¤è¾¹çš„æŠ¤æ å—ï¼Œä¸æ’æ˜¯å§ï¼Œé‚£ä¸è¦ä¿®äº†å“‡ï¼Œç›´æ¥å°±é“ºä¸€ä¸ªå¹³æ¿ï¼Œè¿˜çœææ–™äº†ã€‚å…¶å®æ ¸å¿ƒæŠ€æœ¯çš„åŸç†å­¦ä¹ ï¼Œæ˜¯æ›´æœ‰åŠ©äºä½ å®Œæˆæ›´å¤æ‚çš„æ¶æ„è®¾è®¡ï¼Œå½“ä½ çš„çŸ¥è¯†èƒ½æ›´å…¨é¢è¦†ç›–æ‰€æ‰¿æ¥çš„éœ€æ±‚æ—¶ï¼Œä¹Ÿå°±èƒ½æ›´å¥½çš„åšå‡ºåˆç†çš„æ¶æ„å’Œè½åœ°ã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [åº”ç”¨ä¸Šä¸‹æ–‡å…¨è²Œå›¾ @W](https://t.zsxq.com/0537UNFuj)
- [å­¦è¿™ç« ä¹‹å‰æˆ‘å¯¹ä¸Šä¸‹æ–‡ä¸€ç‚¹éƒ½ä¸çŸ¥é“ï¼Œå­¦å®Œä¹‹åæ„Ÿè§‰è±ç„¶å¼€æœ—ï¼ŒBeanFactoryæ˜¯å†…éƒ¨çš„ä¸œè¥¿æ˜¯IOCå®¹å™¨åŒ–çš„åŸºç¡€ï¼Œè€Œè¿™äº›æ˜¯è¦ç»™äººç”¨çš„ @Chin](https://t.zsxq.com/053vN3r3V)
- [åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œä¸å¾—ä¸è¯´ Spring çš„ç±»çš„è®¾è®¡å’Œè®¾è®¡æ¨¡å¼çš„ä½¿ç”¨éƒ½æ˜¯æ•™ç§‘ä¹¦çº§åˆ«çš„ @Weido](https://t.zsxq.com/06VJ6YNJU)
- [å®ç°åº”ç”¨ä¸Šä¸‹æ–‡ï¼ŒæŠŠå¯¹Classç±»ã€Beanå¯¹è±¡çš„æ‰©å±•æœºåˆ¶åŠŸèƒ½å’Œå¯¹Springæ¡†æ¶ä¸Šä¸‹æ–‡çš„åŒ…è£…èåˆèµ·æ¥ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€å®Œæ•´çš„æœåŠ¡ @liuc](https://t.zsxq.com/07EMFubmA)
- [æœ¬èŠ‚è§£å¯†äº†ClassPathXmlApplicationContext @èµ›åšä¸çœŸ](https://t.zsxq.com/07FcGEAPe)
- [éœ€è¦ç†è§£ä¸Šä¸‹æ–‡refreshçš„æµç¨‹ã€BeanDefinitionä¿®æ”¹æ—¶æœºã€Beanå®ä¾‹ä¿®æ”¹æ—¶æœº @å‚…å“¥åæ´ä¼šä¼šé•¿](https://t.zsxq.com/073XQ9isg)
- [Situation æœ¬ç« å°†ç»§ç»­é’ˆå¯¹æµ‹è¯•ç”¨ä¾‹ä¸­çš„BeanFactoryåŠ è½½spring.xmlè¿™ä¸ªåœ°æ–¹æ¥åšè¿›ä¸€æ­¥çš„æ•´åˆã€‚@åˆ˜å°ç™½](https://t.zsxq.com/08WokFbXV)
- [åŸºäº Spring çš„ç»„ä»¶è®¾è®¡æ—¶ï¼Œéœ€è¦ç»§æ‰¿æˆ–å®ç° Spring å¯¹å¤–æš´éœ²çš„ç±»æˆ–æ¥å£ @æ°´ä¸­ææœˆ](https://t.zsxq.com/082fgaWPw)
- [åœ¨æ£€æµ‹æ˜¯å¦é…ç½®äº†init-methodæ–¹æ³•ï¼Œå¦‚æœè¿›è¡Œäº†é…ç½®è¿›è¡Œå¤„ç†è¿›è¡Œåç½®å¤„ç† @Liuliuliu](https://t.zsxq.com/09P5Yiykq)