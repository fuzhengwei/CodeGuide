---
layout: post
category: spring
title: ç¬¬03ç« ï¼šå®ç° Bean çš„å®šä¹‰ã€æ³¨å†Œã€è·å–
tagline: by å°å‚…å“¥
tag: [java]
excerpt: æœ¬ç« èŠ‚ç»§ç»­å®Œå–„ Spring Bean å®¹å™¨æ¡†æ¶çš„åŠŸèƒ½å¼€å‘ï¼Œåœ¨è¿™ä¸ªå¼€å‘è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°è¾ƒå¤šçš„æ¥å£ã€ç±»ã€æŠ½è±¡ç±»ï¼Œå®ƒä»¬ä¹‹é—´ä¼šæœ‰ç±»çš„å®ç°ã€ç±»çš„ç»§æ‰¿ã€‚å¯ä»¥ä»”ç»†å‚è€ƒè¿™éƒ¨åˆ†å†…å®¹çš„å¼€å‘å®ç°ï¼Œè™½ç„¶å¹¶ä¸ä¼šå¾ˆå¤æ‚ï¼Œä½†è¿™ç§è®¾è®¡æ€è·¯æ˜¯å®Œå…¨å¯ä»¥å¤ç”¨åˆ°æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­çš„ã€‚
lock: need
---

# ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 3 ç« ï¼šåˆæ˜¾èº«æ‰‹ï¼Œè¿ç”¨è®¾è®¡æ¨¡å¼ï¼Œå®ç° Bean çš„å®šä¹‰ã€æ³¨å†Œã€è·å–

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/CgvQzm8B-CvQvXdxONC-lA](https://mp.weixin.qq.com/s/CgvQzm8B-CvQvXdxONC-lA)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`ä½ æ˜¯å¦èƒ½é¢„è§å¤æ‚å†…å®¹çš„è®¾è®¡é—®é¢˜ï¼Ÿ`

è®²é“ç†ï¼Œæ— è®ºäº§å“åŠŸèƒ½æ˜¯å¦å¤æ‚ï¼Œéƒ½æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ç¨‹åºå‘˜ä¼šå†™å‡ºä¸€å † if...else æ¥å®Œæˆå¼€å‘å¹¶`é¡ºåˆ©`ä¸Šçº¿ã€‚è¿™ä¸»è¦æ˜¯åŸå› æ²¡æ³•é¢„è§å½“å‰çš„éœ€æ±‚ï¼Œå‘å±•æ˜¯å¦é•¿è¿œã€æµé‡æ˜¯å¦åºå¤§ã€è¿­ä»£æ˜¯å¦è¿…é€Ÿï¼Œæ‰€ä»¥åœ¨è¢«å‚¬ä¿ƒä¸Šçº¿çš„æƒ…å†µï¼Œä¸å†™ if...else æ˜¯ä¸å¯èƒ½çš„ï¼

é‚£ä½ è¯´ï¼Œæ—¢ç„¶ if...else å®ç°çš„è¿™ä¹ˆå¿«ï¼Œè¿˜è€ƒè™‘æ•°æ®ç»“æ„ã€ç®—æ³•é€»è¾‘ã€è®¾è®¡æ¨¡å¼ã€ç³»ç»Ÿæ¶æ„å—ï¼Ÿå½“ç„¶è¿™åŸºæœ¬è¦çœ‹ä½ çš„é¡¹ç›®åœ¨å¯é¢„è§ä¸‹èƒ½æ´»å¤šä¹…ï¼Œå¦‚æœä¸€ä¸ªé¡¹ç›®è‡³å°‘å­˜æ´»ä¸€å¹´ï¼Œå¹¶ä¸”åœ¨è¿™ä¸€å¹´ä¸­åˆä¼šä¸æ–­çš„çš„è¿­ä»£ã€‚å°±åƒï¼›ä½ åšäº†ä¸€ä¸ªè¥é”€ä¼˜æƒ åˆ¸ç³»ç»Ÿï¼Œåœ¨å„ç§æ¡ä»¶ä¸‹å‘æ”¾å„ç§ç±»å‹çš„åˆ¸ï¼Œå¦‚æœåœ¨æœ€å¼€å§‹æ²¡æœ‰è€ƒè™‘å¥½ç³»ç»Ÿè®¾è®¡å’Œæ¶æ„æ¨¡å¼ï¼Œé‚£ä¹ˆå½“`æ´»åŠ¨é¢‘å‘`ã€`æµé‡æš´å¢`ã€`éœ€æ±‚è¿­ä»£`ä¸‹ã€æœ€åä½ å¯èƒ½ä¼šæŒ‚åœ¨ç³»ç»Ÿäº‹æ•…ä¸Šï¼

æˆ‘ä»¬åœ¨æŠŠç³»ç»Ÿè®¾è®¡çš„è§†è§’èšç„¦åˆ°å…·ä½“ä»£ç å®ç°ä¸Šï¼Œä½ ä¼šæœ‰ä»€ä¹ˆæ‰‹æ®µæ¥å®ç°ä½ æƒ³è¦çš„è®¾è®¡æ¨¡å¼å‘¢ï¼Ÿå…¶å®ç¼–ç æ–¹å¼ä¸»è¦ä¾æ‰˜äºï¼šæ¥å£å®šä¹‰ã€ç±»å®ç°æ¥å£ã€æŠ½è±¡ç±»å®ç°æ¥å£ã€ç»§æ‰¿ç±»ã€ç»§æ‰¿æŠ½è±¡ç±»ï¼Œè€Œè¿™äº›æ“ä½œæ–¹å¼å¯ä»¥å¾ˆå¥½çš„éš”ç¦»å¼€æ¯ä¸ªç±»çš„åŸºç¡€åŠŸèƒ½ã€é€šç”¨åŠŸèƒ½å’Œä¸šåŠ¡åŠŸèƒ½ï¼Œå½“ç±»çš„èŒè´£æ¸…æ™°åï¼Œä½ çš„æ•´ä¸ªè®¾è®¡ä¹Ÿä¼šå˜å¾—å®¹æ˜“æ‰©å±•å’Œè¿­ä»£ã€‚

æ¥ä¸‹æ¥åœ¨æœ¬ç« èŠ‚ç»§ç»­å®Œå–„ Spring Bean å®¹å™¨æ¡†æ¶çš„åŠŸèƒ½å¼€å‘ï¼Œåœ¨è¿™ä¸ªå¼€å‘è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°è¾ƒå¤šçš„æ¥å£ã€ç±»ã€æŠ½è±¡ç±»ï¼Œå®ƒä»¬ä¹‹é—´ä¼šæœ‰ç±»çš„å®ç°ã€ç±»çš„ç»§æ‰¿ã€‚å¯ä»¥ä»”ç»†å‚è€ƒè¿™éƒ¨åˆ†å†…å®¹çš„å¼€å‘å®ç°ï¼Œè™½ç„¶å¹¶ä¸ä¼šå¾ˆå¤æ‚ï¼Œä½†è¿™ç§è®¾è®¡æ€è·¯æ˜¯å®Œå…¨å¯ä»¥å¤ç”¨åˆ°æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­çš„ã€‚

## äºŒã€ç›®æ ‡

åœ¨ä¸Šä¸€ç« èŠ‚ [ã€Šå°è¯•ç‰›åˆ€ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„Beanå®¹å™¨ã€‹](https://bugstack.cn/md/spring/develop-spring/2021-05-20-%E7%AC%AC2%E7%AB%A0%EF%BC%9A%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Bean%E5%AE%B9%E5%99%A8.html) æˆ‘ä»¬åˆæ­¥ä¾ç…§ Spring Bean å®¹å™¨çš„æ¦‚å¿µï¼Œå®ç°äº†ä¸€ä¸ªç²—ç³™ç‰ˆæœ¬çš„ä»£ç å®ç°ã€‚é‚£ä¹ˆæœ¬ç« èŠ‚æˆ‘ä»¬éœ€è¦ç»“åˆå·²å®ç°çš„ Spring Bean å®¹å™¨è¿›è¡ŒåŠŸèƒ½å®Œå–„ï¼Œå®ç° Bean å®¹å™¨å…³äº Bean å¯¹è±¡çš„æ³¨å†Œå’Œè·å–ã€‚

è¿™ä¸€æ¬¡æˆ‘ä»¬æŠŠ Bean çš„åˆ›å»ºäº¤ç»™å®¹å™¨ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨æ—¶å€™ä¼ é€’ä¸€ä¸ªå®ä¾‹åŒ–å¥½çš„ Bean å¯¹è±¡ï¼Œå¦å¤–è¿˜éœ€è¦è€ƒè™‘å•ä¾‹å¯¹è±¡ï¼Œåœ¨å¯¹è±¡çš„äºŒæ¬¡è·å–æ—¶æ˜¯å¯ä»¥ä»å†…å­˜ä¸­è·å–å¯¹è±¡çš„ã€‚æ­¤å¤–ä¸ä»…è¦å®ç°åŠŸèƒ½è¿˜éœ€è¦å®Œå–„åŸºç¡€å®¹å™¨æ¡†æ¶çš„ç±»ç»“æ„ä½“ï¼Œå¦åˆ™å°†æ¥å°±å¾ˆéš¾æ‰©å®¹è¿›å»å…¶ä»–çš„åŠŸèƒ½äº†ã€‚

## ä¸‰ã€è®¾è®¡

é‰´äºæœ¬ç« èŠ‚çš„æ¡ˆä¾‹ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦å°† Spring Bean å®¹å™¨å®Œå–„èµ·æ¥ï¼Œé¦–å…ˆéå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯åœ¨ Bean æ³¨å†Œçš„æ—¶å€™åªæ³¨å†Œä¸€ä¸ªç±»ä¿¡æ¯ï¼Œè€Œä¸ä¼šç›´æ¥æŠŠå®ä¾‹åŒ–ä¿¡æ¯æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚é‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹ BeanDefinition ä¸­çš„å±æ€§ Object ä¸º Classï¼Œæ¥ä¸‹æ¥åœ¨éœ€è¦åšçš„å°±æ˜¯åœ¨è·å– Bean å¯¹è±¡æ—¶éœ€è¦å¤„ç† Bean å¯¹è±¡çš„å®ä¾‹åŒ–æ“ä½œä»¥åŠåˆ¤æ–­å½“å‰å•ä¾‹å¯¹è±¡åœ¨å®¹å™¨ä¸­æ˜¯å¦å·²ç»ç¼“å­˜èµ·æ¥äº†ã€‚æ•´ä½“è®¾è®¡å¦‚å›¾ 3-1

![](https://bugstack.cn/assets/images/spring/spring-3-01.png)

- é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ BeanFactory è¿™æ ·ä¸€ä¸ª Bean å·¥å‚ï¼Œæä¾› Bean çš„è·å–æ–¹æ³• `getBean(String name)`ï¼Œä¹‹åè¿™ä¸ª Bean å·¥å‚æ¥å£ç”±æŠ½è±¡ç±» AbstractBeanFactory å®ç°ã€‚è¿™æ ·ä½¿ç”¨[æ¨¡æ¿æ¨¡å¼](https://bugstack.cn/itstack-demo-design/2020/07/07/%E9%87%8D%E5%AD%A6-Java-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%AE%9E%E6%88%98%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F.html)çš„è®¾è®¡æ–¹å¼ï¼Œå¯ä»¥ç»Ÿä¸€æ”¶å£é€šç”¨æ ¸å¿ƒæ–¹æ³•çš„è°ƒç”¨é€»è¾‘å’Œæ ‡å‡†å®šä¹‰ï¼Œä¹Ÿå°±å¾ˆå¥½çš„æ§åˆ¶äº†åç»­çš„å®ç°è€…ä¸ç”¨å…³å¿ƒè°ƒç”¨é€»è¾‘ï¼ŒæŒ‰ç…§ç»Ÿä¸€æ–¹å¼æ‰§è¡Œã€‚é‚£ä¹ˆç±»çš„ç»§æ‰¿è€…åªéœ€è¦å…³å¿ƒå…·ä½“æ–¹æ³•çš„é€»è¾‘å®ç°å³å¯ã€‚
- é‚£ä¹ˆåœ¨ç»§æ‰¿æŠ½è±¡ç±» AbstractBeanFactory åçš„ AbstractAutowireCapableBeanFactory å°±å¯ä»¥å®ç°ç›¸åº”çš„æŠ½è±¡æ–¹æ³•äº†ï¼Œå› ä¸º AbstractAutowireCapableBeanFactory æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥å®ƒåªä¼šå®ç°å±äºè‡ªå·±çš„æŠ½è±¡æ–¹æ³•ï¼Œå…¶ä»–æŠ½è±¡æ–¹æ³•ç”±ç»§æ‰¿ AbstractAutowireCapableBeanFactory çš„ç±»å®ç°ã€‚è¿™é‡Œå°±ä½“ç°äº†ç±»å®ç°è¿‡ç¨‹ä¸­çš„å„å¸å…¶èŒï¼Œä½ åªéœ€è¦å…³å¿ƒå±äºä½ çš„å†…å®¹ï¼Œä¸æ˜¯ä½ çš„å†…å®¹ï¼Œä¸è¦å‚ä¸ã€‚*è¿™ä¸€éƒ¨åˆ†å†…å®¹æˆ‘ä»¬ä¼šåœ¨ä»£ç é‡Œæœ‰å…·ä½“çš„ä½“ç°*
- å¦å¤–è¿™é‡Œè¿˜æœ‰å—éå¸¸é‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯å…³äºå•ä¾‹ SingletonBeanRegistry çš„æ¥å£å®šä¹‰å®ç°ï¼Œè€Œ DefaultSingletonBeanRegistry å¯¹æ¥å£å®ç°åï¼Œä¼šè¢«æŠ½è±¡ç±» AbstractBeanFactory ç»§æ‰¿ã€‚ç°åœ¨ AbstractBeanFactory å°±æ˜¯ä¸€ä¸ªéå¸¸å®Œæ•´ä¸”å¼ºå¤§çš„æŠ½è±¡ç±»äº†ï¼Œä¹Ÿèƒ½éå¸¸å¥½çš„ä½“ç°å‡ºå®ƒå¯¹æ¨¡æ¿æ¨¡å¼çš„æŠ½è±¡å®šä¹‰ã€‚*æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¸¦ç€è¿™äº›è®¾è®¡å±‚é¢çš„æ€è€ƒï¼Œå»çœ‹ä»£ç çš„å…·ä½“å®ç°ç»“æœ*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-02
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework.beans
    â”‚           â”œâ”€â”€ factory
    â”‚           â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â””â”€â”€ BeanFactory.java
    â”‚           â””â”€â”€ BeansException.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â””â”€â”€ UserService.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–æºç `

Spring Bean å®¹å™¨ç±»å…³ç³»ï¼Œå¦‚å›¾ 3-2

![å›¾ 3-2](https://bugstack.cn/assets/images/spring/spring-3-02.png)

è™½ç„¶è¿™ä¸€ç« èŠ‚å…³äº Spring Bean å®¹å™¨çš„åŠŸèƒ½å®ç°ä¸ `Spring æºç `ä¸­è¿˜æœ‰ä¸å°‘çš„å·®è·ï¼Œä½†ä»¥ç›®å‰å®ç°ç»“æœçš„ç±»å…³ç³»å›¾æ¥çœ‹ï¼Œå…¶å®å·²ç»å…·å¤‡äº†ä¸€å®šçš„è®¾è®¡å¤æ‚æ€§ï¼Œè¿™äº›å¤æ‚çš„ç±»å…³ç³»è®¾è®¡åœ¨å„ä¸ªæ¥å£å®šä¹‰å’Œå®ç°ä»¥åŠåœ¨æŠ½è±¡ç±»ç»§æ‰¿ä¸­éƒ½æœ‰æ‰€ä½“ç°ï¼Œä¾‹å¦‚ï¼š

- BeanFactory çš„å®šä¹‰ç”± AbstractBeanFactory æŠ½è±¡ç±»å®ç°æ¥å£çš„ getBean æ–¹æ³•
- è€Œ AbstractBeanFactory åˆç»§æ‰¿äº†å®ç°äº† SingletonBeanRegistry çš„DefaultSingletonBeanRegistry ç±»ã€‚è¿™æ · AbstractBeanFactory æŠ½è±¡ç±»å°±å…·å¤‡äº†å•ä¾‹ Bean çš„æ³¨å†ŒåŠŸèƒ½ã€‚
- AbstractBeanFactory ä¸­åˆå®šä¹‰äº†ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼šgetBeanDefinition(String beanName)ã€createBean(String beanName, BeanDefinition beanDefinition) ï¼Œè€Œè¿™ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•åˆ†åˆ«ç”± DefaultListableBeanFactoryã€AbstractAutowireCapableBeanFactory å®ç°ã€‚
- æœ€ç»ˆ DefaultListableBeanFactory è¿˜ä¼šç»§æ‰¿æŠ½è±¡ç±» AbstractAutowireCapableBeanFactory ä¹Ÿå°±å¯ä»¥è°ƒç”¨æŠ½è±¡ç±»ä¸­çš„ createBean æ–¹æ³•äº†ã€‚

ç»¼ä¸Šè¿™ä¸€éƒ¨åˆ†çš„ç±»å…³ç³»å’Œå®ç°è¿‡ç¨‹è¿˜æ˜¯ä¼šæœ‰ä¸€äº›å¤æ‚çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„å®ç°éƒ½ä»¥èŒè´£åˆ’åˆ†ã€å…±æ€§åˆ†ç¦»ä»¥åŠè°ƒç”¨å…³ç³»å®šä¹‰ä¸ºæ ‡å‡†æ­å»ºçš„ç±»å…³ç³»ã€‚*è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ ï¼Œå¯èƒ½ä¼šä¸°å¯Œä½ åœ¨å¤æ‚ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­çš„è®¾è®¡æ€è·¯ã€‚*

### 2. BeanDefinition å®šä¹‰

**cn.bugstack.springframework.beans.factory.config.BeanDefinition**

```java
public class BeanDefinition {

    private Class beanClass;

    public BeanDefinition(Class beanClass) {
        this.beanClass = beanClass;
    }
		// ...get/set
}
```

- åœ¨ Bean å®šä¹‰ç±»ä¸­å·²ç»æŠŠä¸Šä¸€ç« èŠ‚ä¸­çš„ Object bean æ›¿æ¢ä¸º Classï¼Œè¿™æ ·å°±å¯ä»¥æŠŠ Bean çš„å®ä¾‹åŒ–æ“ä½œæ”¾åˆ°å®¹å™¨ä¸­å¤„ç†äº†ã€‚*å¦‚æœä½ æœ‰ä»”ç»†é˜…è¯»è¿‡ä¸Šä¸€ç« å¹¶åšäº†ç›¸åº”çš„æµ‹è¯•ï¼Œé‚£ä¹ˆä½ ä¼šå‘ç° Bean çš„å®ä¾‹åŒ–æ“ä½œæ˜¯æ”¾åœ¨åˆå§‹åŒ–è°ƒç”¨é˜¶æ®µä¼ é€’ç»™ BeanDefinition æ„é€ å‡½æ•°çš„ã€‚*

### 3. å•ä¾‹æ³¨å†Œæ¥å£å®šä¹‰å’Œå®ç°

**cn.bugstack.springframework.beans.factory.config.SingletonBeanRegistry**

```java
public interface SingletonBeanRegistry {

    Object getSingleton(String beanName);

}
```

- è¿™ä¸ªç±»æ¯”è¾ƒç®€å•ä¸»è¦æ˜¯å®šä¹‰äº†ä¸€ä¸ªè·å–å•ä¾‹å¯¹è±¡çš„æ¥å£ã€‚

**cn.bugstack.springframework.beans.factory.config.DefaultSingletonBeanRegistry**

```java
public class DefaultSingletonBeanRegistry implements SingletonBeanRegistry {

    private Map<String, Object> singletonObjects = new HashMap<>();

    @Override
    public Object getSingleton(String beanName) {
        return singletonObjects.get(beanName);
    }

    protected void addSingleton(String beanName, Object singletonObject) {
        singletonObjects.put(beanName, singletonObject);
    }

}
```

- åœ¨ DefaultSingletonBeanRegistry ä¸­ä¸»è¦å®ç° getSingleton æ–¹æ³•ï¼ŒåŒæ—¶å®ç°äº†ä¸€ä¸ªå—ä¿æŠ¤çš„ addSingleton æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥è¢«ç»§æ‰¿æ­¤ç±»çš„å…¶ä»–ç±»è°ƒç”¨ã€‚åŒ…æ‹¬ï¼šAbstractBeanFactory ä»¥åŠç»§æ‰¿çš„ DefaultListableBeanFactory è°ƒç”¨ã€‚

### 4. æŠ½è±¡ç±»å®šä¹‰æ¨¡æ¿æ–¹æ³•(AbstractBeanFactory)

**cn.bugstack.springframework.beans.factory.support.AbstractBeanFactory**

```java
public abstract class AbstractBeanFactory extends DefaultSingletonBeanRegistry implements BeanFactory {

    @Override
    public Object getBean(String name) throws BeansException {
        Object bean = getSingleton(name);
        if (bean != null) {
            return bean;
        }

        BeanDefinition beanDefinition = getBeanDefinition(name);
        return createBean(name, beanDefinition);
    }

    protected abstract BeanDefinition getBeanDefinition(String beanName) throws BeansException;

    protected abstract Object createBean(String beanName, BeanDefinition beanDefinition) throws BeansException;

}
```

- AbstractBeanFactory é¦–å…ˆç»§æ‰¿äº† DefaultSingletonBeanRegistryï¼Œä¹Ÿå°±å…·å¤‡äº†ä½¿ç”¨å•ä¾‹æ³¨å†Œç±»æ–¹æ³•ã€‚
- æ¥ä¸‹æ¥å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å…³äºæ¥å£ BeanFactory çš„å®ç°ï¼Œåœ¨æ–¹æ³• getBean çš„å®ç°è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æ˜¯å¯¹å•ä¾‹ Bean å¯¹è±¡çš„è·å–ä»¥åŠåœ¨è·å–ä¸åˆ°æ—¶éœ€è¦æ‹¿åˆ° Bean çš„å®šä¹‰åšç›¸åº” 
Bean å®ä¾‹åŒ–æ“ä½œã€‚é‚£ä¹ˆ getBean å¹¶æ²¡æœ‰è‡ªèº«çš„å»å®ç°è¿™äº›æ–¹æ³•ï¼Œè€Œæ˜¯åªå®šä¹‰äº†è°ƒç”¨è¿‡ç¨‹ä»¥åŠæä¾›äº†æŠ½è±¡æ–¹æ³•ï¼Œç”±å®ç°æ­¤æŠ½è±¡ç±»çš„å…¶ä»–ç±»åšç›¸åº”å®ç°ã€‚
- åç»­ç»§æ‰¿æŠ½è±¡ç±» AbstractBeanFactory çš„ç±»æœ‰ä¸¤ä¸ªï¼ŒåŒ…æ‹¬ï¼šAbstractAutowireCapableBeanFactoryã€DefaultListableBeanFactoryï¼Œè¿™ä¸¤ä¸ªç±»åˆ†åˆ«åšäº†ç›¸åº”çš„å®ç°å¤„ç†ï¼Œæ¥ç€å¾€ä¸‹çœ‹ã€‚

### 5. å®ä¾‹åŒ–Beanç±»(AbstractAutowireCapableBeanFactory)

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory {

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition) throws BeansException {
        Object bean = null;
        try {
            bean = beanDefinition.getBeanClass().newInstance();
        } catch (InstantiationException | IllegalAccessException e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        addSingleton(beanName, bean);
        return bean;
    }

}
```

- åœ¨ AbstractAutowireCapableBeanFactory ç±»ä¸­å®ç°äº† Bean çš„å®ä¾‹åŒ–æ“ä½œ `newInstance`ï¼Œå…¶å®è¿™å—ä¼šåŸ‹ä¸‹ä¸€ä¸ªå‘ï¼Œæœ‰æ„é€ å‡½æ•°å…¥å‚çš„å¯¹è±¡æ€ä¹ˆå¤„ç†ï¼Ÿ*å¯ä»¥æå‰æ€è€ƒ*
- åœ¨å¤„ç†å®Œ Bean å¯¹è±¡çš„å®ä¾‹åŒ–åï¼Œç›´æ¥è°ƒç”¨ `addSingleton` æ–¹æ³•å­˜æ”¾åˆ°å•ä¾‹å¯¹è±¡çš„ç¼“å­˜ä¸­å»ã€‚

### 6. æ ¸å¿ƒç±»å®ç°(DefaultListableBeanFactory)

**cn.bugstack.springframework.beans.factory.support.DefaultListableBeanFactory**

```java
public class DefaultListableBeanFactory extends AbstractAutowireCapableBeanFactory implements BeanDefinitionRegistry {

    private Map<String, BeanDefinition> beanDefinitionMap = new HashMap<>();

    @Override
    public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) {
        beanDefinitionMap.put(beanName, beanDefinition);
    }

    @Override
    public BeanDefinition getBeanDefinition(String beanName) throws BeansException {
        BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
        if (beanDefinition == null) throw new BeansException("No bean named '" + beanName + "' is defined");
        return beanDefinition;
    }

}
```

- DefaultListableBeanFactory åœ¨ Spring æºç ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„ç±»ï¼Œåœ¨æˆ‘ä»¬ç›®å‰çš„å®ç°ä¸­ä¹Ÿæ˜¯é€æ­¥è´´è¿‘äºæºç ï¼Œä¸æºç ç±»åä¿æŒä¸€è‡´ã€‚
- DefaultListableBeanFactory ç»§æ‰¿äº† AbstractAutowireCapableBeanFactory ç±»ï¼Œä¹Ÿå°±å…·å¤‡äº†æ¥å£ BeanFactory å’Œ AbstractBeanFactory ç­‰ä¸€è¿ä¸²çš„åŠŸèƒ½å®ç°ã€‚*æ‰€ä»¥æœ‰æ—¶å€™ä½ ä¼šçœ‹åˆ°ä¸€äº›ç±»çš„å¼ºè½¬ï¼Œè°ƒç”¨æŸäº›æ–¹æ³•ï¼Œä¹Ÿæ˜¯å› ä¸ºä½ å¼ºè½¬çš„ç±»å®ç°æ¥å£æˆ–ç»§æ‰¿äº†æŸäº›ç±»ã€‚*
- é™¤æ­¤ä¹‹å¤–è¿™ä¸ªç±»è¿˜å®ç°äº†æ¥å£ BeanDefinitionRegistry ä¸­çš„ registerBeanDefinition(String beanName, BeanDefinition beanDefinition) æ–¹æ³•ï¼Œå½“ç„¶ä½ è¿˜ä¼šçœ‹åˆ°ä¸€ä¸ª getBeanDefinition çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬æ–‡ä¸­æåˆ°è¿‡å®ƒæ˜¯æŠ½è±¡ç±» AbstractBeanFactory ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ã€‚*ç°åœ¨æ³¨å†ŒBeanå®šä¹‰ä¸è·å–Beanå®šä¹‰å°±å¯ä»¥åŒæ—¶ä½¿ç”¨äº†ï¼Œæ˜¯ä¸æ„Ÿè§‰è¿™ä¸ªå¥—è·¯è¿˜è›®æ·±çš„ã€‚æ¥å£å®šä¹‰äº†æ³¨å†Œï¼ŒæŠ½è±¡ç±»å®šä¹‰äº†è·å–ï¼Œéƒ½é›†ä¸­åœ¨ DefaultListableBeanFactory ä¸­çš„ beanDefinitionMap é‡Œ*

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**cn.bugstack.springframework.test.bean.UserService**

```java
public class UserService {

    public void queryUserInfo(){
        System.out.println("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯");
    }

}
```

- è¿™é‡Œç®€å•å®šä¹‰äº†ä¸€ä¸ª UserService  å¯¹è±¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­å¯¹ Spring å®¹å™¨æµ‹è¯•ã€‚

### 2. æµ‹è¯•ç”¨ä¾‹

**cn.bugstack.springframework.test.ApiTest**

```java
@Test
public void test_BeanFactory(){
    // 1.åˆå§‹åŒ– BeanFactory
    DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
    // 2.æ³¨å†Œ bean
    BeanDefinition beanDefinition = new BeanDefinition(UserService.class);
    beanFactory.registerBeanDefinition("userService", beanDefinition);
    // 3.ç¬¬ä¸€æ¬¡è·å– bean
    UserService userService = (UserService) beanFactory.getBean("userService");
    userService.queryUserInfo();
    // 4.ç¬¬äºŒæ¬¡è·å– bean from Singleton
    UserService userService_singleton = (UserService) beanFactory.getBean("userService");
    userService_singleton.queryUserInfo();
}
```

- åœ¨æ­¤æ¬¡çš„å•å…ƒæµ‹è¯•ä¸­é™¤äº†åŒ…æ‹¬ï¼›Bean å·¥å‚ã€æ³¨å†Œ Beanã€è·å– Beanï¼Œä¸‰ä¸ªæ­¥éª¤ï¼Œè¿˜é¢å¤–å¢åŠ äº†ä¸€æ¬¡å¯¹è±¡çš„è·å–å’Œè°ƒç”¨ã€‚è¿™é‡Œä¸»è¦æµ‹è¯•éªŒè¯å•ä¾‹å¯¹è±¡çš„æ˜¯å¦æ­£ç¡®çš„å­˜æ”¾åˆ°äº†ç¼“å­˜ä¸­ã€‚
- æ­¤å¤–ä¸ä¸Šä¸€ç« èŠ‚æµ‹è¯•è¿‡ç¨‹ä¸­ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬æŠŠ UserService.class ä¼ é€’ç»™äº† BeanDefinition è€Œä¸æ˜¯åƒä¸Šä¸€ç« èŠ‚é‚£æ ·ç›´æ¥ new UserService() æ“ä½œã€‚

### 3. æµ‹è¯•ç»“æœ

```java
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

Process finished with exit code 0
```

- è¿™é‡Œä¼šæœ‰ä¸¤æ¬¡æµ‹è¯•ä¿¡æ¯ï¼Œä¸€æ¬¡æ˜¯è·å– Bean æ—¶ç›´æ¥åˆ›å»ºçš„å¯¹è±¡ï¼Œå¦å¤–ä¸€æ¬¡æ˜¯ä»ç¼“å­˜ä¸­è·å–çš„å®ä¾‹åŒ–å¯¹è±¡ã€‚
- æ­¤å¤–ä»è°ƒè¯•çš„æˆªå›¾ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç¬¬äºŒæ¬¡è·å–å•ä¾‹å¯¹è±¡ï¼Œå·²ç»å¯ä»¥ä»å†…å­˜ä¸­è·å–äº†ï¼Œå¦‚å›¾ 3-3
	![å›¾ 3-3](https://bugstack.cn/assets/images/spring/spring-3-03.png)
- åˆ°è¿™æœ¬ç« èŠ‚çš„åŠŸèƒ½å®ç°å’Œæµ‹è¯•éªŒè¯å°±å®Œæˆäº†ï¼Œå…³äºæµ‹è¯•è¿‡ç¨‹ä¸­å¯ä»¥å†å»æ–­ç‚¹è°ƒè¯•ä¸‹å„ä¸ªé˜¶æ®µç±»çš„è°ƒç”¨ï¼Œç†Ÿæ‚‰è°ƒç”¨å…³ç³»ã€‚	

## å…­ã€æ€»ç»“

- ç›¸å¯¹äºå‰ä¸€ç« èŠ‚å¯¹ Spring Bean å®¹å™¨çš„ç®€å•æ¦‚å¿µå®ç°ï¼Œæœ¬ç« èŠ‚ä¸­åŠ å¼ºäº†åŠŸèƒ½çš„å®Œå–„ã€‚åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç±»çš„å…³ç³»å˜å¾—è¶Šæ¥è¶Šå¤šäº†ï¼Œå¦‚æœæ²¡æœ‰åšè¿‡ä¸€äº›ç¨å¾®å¤æ‚çš„ç³»ç»Ÿç±»ç³»ç»Ÿï¼Œé‚£ä¹ˆå³ä½¿ç°åœ¨è¿™æ ·9ä¸ªç±»æ­å‡ºæ¥çš„å®¹å™¨å·¥å‚ä¹Ÿå¯ä»¥ç»™ä½ ç»•æ™•ã€‚
- åœ¨ Spring Bean å®¹å™¨çš„å®ç°ç±»ä¸­è¦é‡ç‚¹å…³æ³¨ç±»ä¹‹é—´çš„èŒè´£å’Œå…³ç³»ï¼Œå‡ ä¹æ‰€æœ‰çš„ç¨‹åºåŠŸèƒ½è®¾è®¡éƒ½ç¦»ä¸å¼€æ¥å£ã€æŠ½è±¡ç±»ã€å®ç°ã€ç»§æ‰¿ï¼Œè€Œè¿™äº›ä¸åŒç‰¹æ€§ç±»çš„ä½¿ç”¨å°±å¯ä»¥éå¸¸å¥½çš„éš”ç¦»å¼€ç±»çš„åŠŸèƒ½èŒè´£å’Œä½œç”¨èŒƒå›´ã€‚è€Œè¿™æ ·çš„çŸ¥è¯†ç‚¹ä¹Ÿæ˜¯åœ¨å­¦ä¹ æ‰‹å†™ Spring Bean å®¹å™¨æ¡†æ¶è¿‡ç¨‹éå¸¸é‡è¦çš„çŸ¥è¯†ã€‚
- æœ€åè¦å¼ºè°ƒä¸€ä¸‹å…³äºæ•´ä¸ªç³»åˆ—å†…å®¹çš„å­¦ä¹ ï¼Œå¯èƒ½åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°åƒç¬¬äºŒç« èŠ‚é‚£æ ·éå¸¸ç®€å•çš„ä»£ç å®ç°ï¼Œä½†è¦åšä¸€ä¸ªæœ‰æˆé•¿çš„ç¨‹åºå‘˜è¦è®°ä½ä»£ç å®ç°åªæ˜¯æœ€åçš„è½åœ°ç»“æœï¼Œè€Œé‚£äº›è®¾è®¡ä¸Šçš„æ€è€ƒæ‰æ˜¯æœ€æœ‰ä»·å€¼çš„åœ°æ–¹ã€‚*å°±åƒä½ æ˜¯å¦é‡åˆ°è¿‡ï¼Œæœ‰äººè®©ä½ ç»™ä¸€ä¸ªå†…å®¹åšä¸ªæè¿°ã€æ–‡æ¡£ã€è¯´æ˜ï¼Œä½ æ€»è§‰å¾—å¤ªç®€å•äº†æ²¡ä»€ä¹ˆå¯å†™çš„ï¼Œå³ä½¿è¦åŠ¨ç¬”å†™äº†ä¹Ÿä¸çŸ¥é“è¦ä»å“ªå¼€å§‹ï¼å…¶å®è¿™äº›çŸ¥è¯†å†…å®¹éƒ½æ¥æºä½ å¯¹æ•´ä½“åŠŸèƒ½çš„ç†è§£ï¼Œè¿™å°±ä¸åªæ˜¯ä»£ç å¼€å‘è¿˜åŒ…æ‹¬äº†éœ€æ±‚ç›®æ ‡ã€æ–¹æ¡ˆè®¾è®¡ã€æŠ€æœ¯å®ç°ã€é€»è¾‘éªŒè¯ç­‰ç­‰è¿‡ç¨‹æ€§çš„å†…å®¹ã€‚æ‰€ä»¥ï¼Œä¸è¦åªæ˜¯è¢«çœ‹ä¼¼ç®€å•çš„å†…å®¹å¿½ç•¥äº†æ•´ä½“å…¨å±€è§‚ï¼Œè¦å­¦ä¼šæ”¾å¼€è§†é‡ï¼Œå¼€æ”¾å­¦ä¹ è§†è§’ã€‚*
