---
layout: post
category: spring
title: ç¬¬05ç« ï¼šæ³¨å…¥å±æ€§å’Œä¾èµ–å¯¹è±¡
tagline: by å°å‚…å“¥
tag: [java]
excerpt: è¶…å–ã€æ‰å•ã€å¹‚ç­‰ï¼Œä½ çš„ç¨‹åºæ€»æ˜¯ä¸æŠ—æï¼å¦‚æœä½ æƒ³è®©ä½ çš„ç¨‹åºå¾ˆæŠ—æï¼Œæ¥çš„ä½å†œå¤«ä¸‰æ‹³ï¼Œé‚£ä¹ˆä½ è¦åšçš„å°±ä¸åªæ˜¯ä¸€ä¸ªå•çº¯çš„æ¬ç –ç å†œï¼Œè¿˜éœ€è¦ä¾ç…§åŠŸèƒ½éœ€æ±‚ä¸æ–­çš„å¾ªåºæ¸è¿›çš„å®Œå–„æ¯ä¸€ä¸ªåŠŸèƒ½é€»è¾‘ï¼Œå°±åƒæˆ‘ä»¬åœ¨å®ç°è¿™ä¸ªè¿·ä½ ç‰ˆçš„ Spring æ¡†æ¶ä¸€æ ·ã€‚
lock: need
---

# ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 5 ç« ï¼šä¸€é¸£æƒŠäººï¼Œä¸ºBeanå¯¹è±¡æ³¨å…¥å±æ€§å’Œä¾èµ–Beançš„åŠŸèƒ½å®ç°

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/EKoMDpa4q8TMikRM2wBIzw](https://mp.weixin.qq.com/s/EKoMDpa4q8TMikRM2wBIzw)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`è¶…å–ã€æ‰å•ã€å¹‚ç­‰ï¼Œä½ çš„ç¨‹åºæ€»æ˜¯ä¸æŠ—æï¼`

æƒ³æƒ³ï¼Œè¿è¥å·²ç»å¯¹å¤–å®£ä¼ äº†ä¸ƒå…«å¤©çš„æ´»åŠ¨ï¼Œæ»¡å¿ƒæ¬¢å–œçš„ç­‰ç€æœ€åä¸€å¤©é¡µé¢ä¸Šçº¿å¯¹å¤–äº†ï¼Œçªç„¶å‡ºç°äº†ä¸€å †å¼‚å¸¸ã€èµ„æŸã€é—ªé€€ï¼Œè€Œç”¨æˆ·æµé‡ç¨çºµå³é€ï¼Œæœ€åæƒ³æ­»çš„å¿ƒéƒ½æœ‰ï¼

å°±ç¼–ç¨‹å¼€å‘æ¥è®²ï¼Œä¸¢ä¸‰è½å››ã€ä¹±ç ä¸ƒç³Ÿï¼Œå¯èƒ½è¿™å°±æ˜¯å¤§éƒ¨åˆ†åˆçº§ç¨‹åºå‘˜æ—¥å¸¸å¼€å‘çš„çœŸå®å†™ç…§ï¼Œåœ¨å³ä½¿æœ‰æµ‹è¯•äººå‘˜éªŒè¯çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šå‡ºç°å¸¦Bugä¸Šçº¿çš„ç°è±¡ï¼Œåªä¸è¿‡æ˜¯å½“æ—¶æ²¡æœ‰å‘ç°è€Œå·²ï¼*å› ä¸ºæ˜¯äººå†™ä»£ç ï¼Œå°±ä¸€å®šä¼šæœ‰é”™è¯¯ï¼Œå³ä½¿æ˜¯è€ç å†œ*

å°±ç¨‹åºBugæ¥è®²ï¼Œä¼šåŒ…æ‹¬äº§å“PRDæµç¨‹ä¸Šçš„Bugã€è¿è¥é…ç½®æ´»åŠ¨æ—¶å€™çš„Bugã€ç ”å‘å¼€å‘æ—¶åŠŸèƒ½å®ç°çš„Bugã€æµ‹è¯•éªŒè¯æ—¶æ¼æ‰æµç¨‹çš„Bugã€ä¸Šçº¿è¿‡ç¨‹ä¸­è¿ç»´æœåŠ¡ç›¸å…³é…ç½®çš„Bugï¼Œè€Œè¿™äº›å…¶å®éƒ½å¯ä»¥é€šè¿‡åˆ¶å®šçš„æµç¨‹è§„èŒƒå’Œä¸€å®šçš„ç ”å‘ç»éªŒç§¯ç´¯ï¼Œæ…¢æ…¢å°½å¯èƒ½å‡å°‘ã€‚

è€Œå¦å¤–ä¸€ç±»æ˜¯æ²Ÿé€šç•™ä¸‹çš„Bugï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸šåŠ¡æéœ€æ±‚ã€äº§å“å®šæ–¹æ¡ˆã€ç ”å‘åšå®ç°ï¼Œæœ€ç»ˆè¿˜è¦æœ‰UIã€æµ‹è¯•ã€è¿è¥ã€æ¶æ„ç­‰ç­‰å„ä¸ªç¯èŠ‚çš„äººå‘˜å‚ä¸åˆ°ä¸€ä¸ªé¡¹ç›®çš„æ‰¿æ¥ã€å¼€å‘åˆ°ä¸Šçº¿è¿è¡Œï¼Œè€Œåœ¨è¿™ä¸€ç¾¤äººéœ€è¦ä¿æŒä¸€ä¸ªç»Ÿä¸€çš„ä¿¡æ¯ä¼ æ’­å…¶å®æ˜¯å¾ˆéš¾çš„ã€‚æ¯”å¦‚åœ¨é¡¹ç›®å¼€å‘ä¸­æœŸï¼Œè¿è¥ç»™äº§å“è¯´äº†ä¸€ä¸ªæ–°å¢çš„éœ€æ±‚ï¼Œäº§å“è§‰å¾—åŠŸèƒ½ä¹Ÿä¸å¤§ï¼Œéšå³æ‰¾åˆ°å¯¹åº”çš„å‰ç«¯ç ”å‘åŠ ä¸ªé€»è¾‘ï¼Œä½†æ²¡æƒ³åˆ°å¯èƒ½ä¹Ÿå½±å“åˆ°äº†åç«¯çš„å¼€å‘å’Œæµ‹è¯•çš„ç”¨ä¾‹ã€‚æœ€ååŠŸèƒ½è™½ç„¶æ˜¯ä¸Šçº¿äº†ï¼Œå¯å¹¶ä¸åœ¨æ•´ä¸ªäº§ç ”æµ‹çš„éœ€æ±‚è¦†ç›–åº¦èŒƒå›´é‡Œï¼Œä¹Ÿå°±éšå½¢çš„åŸ‹ä¸‹äº†ä¸€ä¸ªå‘ã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³è®©ä½ çš„ç¨‹åºå¾ˆæŠ—æï¼Œæ¥çš„ä½å†œå¤«ä¸‰æ‹³ï¼Œé‚£ä¹ˆä½ è¦åšçš„å°±ä¸åªæ˜¯ä¸€ä¸ªå•çº¯çš„æ¬ç –ç å†œï¼

## äºŒã€ç›®æ ‡

é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸‹è¿™å‡ ç« èŠ‚éƒ½å®Œæˆäº†ä»€ä¹ˆï¼ŒåŒ…æ‹¬ï¼š[å®ç°ä¸€ä¸ªå®¹å™¨](https://bugstack.cn/spring/2021/05/20/%E7%AC%AC2%E7%AB%A0-%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Bean%E5%AE%B9%E5%99%A8.html)ã€[å®šä¹‰å’Œæ³¨å†ŒBean](https://bugstack.cn/spring/2021/05/23/%E7%AC%AC3%E7%AB%A0-%E5%88%9D%E6%98%BE%E8%BA%AB%E6%89%8B-%E8%BF%90%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%AE%9E%E7%8E%B0-Bean-%E7%9A%84%E5%AE%9A%E4%B9%89-%E6%B3%A8%E5%86%8C-%E8%8E%B7%E5%8F%96.html)ã€[å®ä¾‹åŒ–Bean](https://bugstack.cn/spring/2021/05/23/%E7%AC%AC3%E7%AB%A0-%E5%88%9D%E6%98%BE%E8%BA%AB%E6%89%8B-%E8%BF%90%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%AE%9E%E7%8E%B0-Bean-%E7%9A%84%E5%AE%9A%E4%B9%89-%E6%B3%A8%E5%86%8C-%E8%8E%B7%E5%8F%96.html)ï¼Œ[æŒ‰ç…§æ˜¯å¦åŒ…å«æ„é€ å‡½æ•°å®ç°ä¸åŒçš„å®ä¾‹åŒ–ç­–ç•¥](https://bugstack.cn/spring/2021/05/30/%E7%AC%AC4%E7%AB%A0-%E5%B4%AD%E9%9C%B2%E5%A4%B4%E8%A7%92-%E5%9F%BA%E4%BA%8ECglib%E5%AE%9E%E7%8E%B0%E5%90%AB%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E7%B1%BB%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%AD%96%E7%95%A5.html)ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºå¯¹è±¡å®ä¾‹åŒ–è¿™æˆ‘ä»¬è¿˜ç¼ºå°‘ä»€ä¹ˆï¼Ÿå…¶å®è¿˜ç¼ºå°‘ä¸€ä¸ªå…³äº`ç±»ä¸­æ˜¯å¦æœ‰å±æ€§çš„é—®é¢˜`ï¼Œå¦‚æœæœ‰ç±»ä¸­åŒ…å«å±æ€§é‚£ä¹ˆåœ¨å®ä¾‹åŒ–çš„æ—¶å€™å°±éœ€è¦æŠŠå±æ€§ä¿¡æ¯å¡«å……ä¸Šï¼Œè¿™æ ·æ‰æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡åˆ›å»ºã€‚

å¯¹äºå±æ€§çš„å¡«å……ä¸åªæ˜¯ intã€Longã€Stringï¼Œè¿˜åŒ…æ‹¬è¿˜æ²¡æœ‰å®ä¾‹åŒ–çš„å¯¹è±¡å±æ€§ï¼Œéƒ½éœ€è¦åœ¨ Bean åˆ›å»ºæ—¶è¿›è¡Œå¡«å……æ“ä½œã€‚*ä¸è¿‡è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ä¼šè€ƒè™‘ Bean çš„å¾ªç¯ä¾èµ–ï¼Œå¦åˆ™ä¼šæŠŠæ•´ä¸ªåŠŸèƒ½å®ç°æ’‘å¤§ï¼Œè¿™æ ·æ–°äººå­¦ä¹ æ—¶å°±æŠŠæ¡ä¸ä½äº†ï¼Œå¾…åç»­é™†ç»­å…ˆæŠŠæ ¸å¿ƒåŠŸèƒ½å®ç°åï¼Œå†é€æ­¥å®Œå–„*

## ä¸‰ã€è®¾è®¡

é‰´äºå±æ€§å¡«å……æ˜¯åœ¨ Bean ä½¿ç”¨ `newInstance` æˆ–è€… `Cglib` åˆ›å»ºåï¼Œå¼€å§‹è¡¥å…¨å±æ€§ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨ç±» `AbstractAutowireCapableBeanFactory` çš„ createBean æ–¹æ³•ä¸­æ·»åŠ è¡¥å…¨å±æ€§æ–¹æ³•ã€‚*è¿™éƒ¨åˆ†å¤§å®¶åœ¨å®ä¹ çš„è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥å¯¹ç…§Springæºç å­¦ä¹ ï¼Œè¿™é‡Œçš„å®ç°ä¹Ÿæ˜¯Springçš„ç®€åŒ–ç‰ˆï¼Œåç»­å¯¹ç…§å­¦ä¹ ä¼šæ›´åŠ æ˜“äºç†è§£*

![](https://bugstack.cn/assets/images/spring/spring-5-01.png)

- å±æ€§å¡«å……è¦åœ¨ç±»å®ä¾‹åŒ–åˆ›å»ºä¹‹åï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨ `AbstractAutowireCapableBeanFactory` çš„ createBean æ–¹æ³•ä¸­æ·»åŠ  `applyPropertyValues` æ“ä½œã€‚
- ç”±äºæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºBeanæ—¶å€™å¡«å……å±æ€§æ“ä½œï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ bean å®šä¹‰ BeanDefinition ç±»ä¸­ï¼Œæ·»åŠ  PropertyValues ä¿¡æ¯ã€‚
- å¦å¤–æ˜¯å¡«å……å±æ€§ä¿¡æ¯è¿˜åŒ…æ‹¬äº† Bean çš„å¯¹è±¡ç±»å‹ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å†å®šä¹‰ä¸€ä¸ª BeanReferenceï¼Œé‡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ Bean åç§°ï¼Œåœ¨å…·ä½“çš„å®ä¾‹åŒ–æ“ä½œæ—¶è¿›è¡Œé€’å½’åˆ›å»ºå’Œå¡«å……ï¼Œä¸ Spring æºç å®ç°ä¸€æ ·ã€‚*Spring æºç ä¸­ BeanReference æ˜¯ä¸€ä¸ªæ¥å£*

## å››ã€å®ç°

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-04
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework.beans
    â”‚           â”œâ”€â”€ factory
    â”‚           â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanReference.java
    â”‚           â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java
    â”‚           â”‚   â””â”€â”€ BeanFactory.java
    â”‚           â”œâ”€â”€ BeansException.java
    â”‚           â”œâ”€â”€ PropertyValue.java
    â”‚           â””â”€â”€ PropertyValues.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ UserDao.java
                â”‚   â””â”€â”€ UserService.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

Spring Bean å®¹å™¨ç±»å…³ç³»ï¼Œå¦‚å›¾ 5-2

![å›¾ 5-2](https://bugstack.cn/assets/images/spring/spring-5-02.png)

- æœ¬ç« èŠ‚ä¸­éœ€è¦æ–°å¢åŠ 3ä¸ªç±»ï¼Œ`BeanReference`(ç±»å¼•ç”¨)ã€`PropertyValue`(å±æ€§å€¼)ã€`PropertyValues`(å±æ€§é›†åˆ)ï¼Œåˆ†åˆ«ç”¨äºç±»å’Œå…¶ä»–ç±»å‹å±æ€§å¡«å……æ“ä½œã€‚
- å¦å¤–æ”¹åŠ¨çš„ç±»ä¸»è¦æ˜¯ `AbstractAutowireCapableBeanFactory`ï¼Œåœ¨ createBean ä¸­è¡¥å…¨å±æ€§å¡«å……éƒ¨åˆ†ã€‚

### 2. å®šä¹‰å±æ€§

**cn.bugstack.springframework.beans.PropertyValue** 

```java
public class PropertyValue {

    private final String name;

    private final Object value;

    public PropertyValue(String name, Object value) {
        this.name = name;
        this.value = value;
    }
    
    // ...get/set
}
```

**cn.bugstack.springframework.beans.PropertyValues** 

```java
public class PropertyValues {

    private final List<PropertyValue> propertyValueList = new ArrayList<>();

    public void addPropertyValue(PropertyValue pv) {
        this.propertyValueList.add(pv);
    }

    public PropertyValue[] getPropertyValues() {
        return this.propertyValueList.toArray(new PropertyValue[0]);
    }

    public PropertyValue getPropertyValue(String propertyName) {
        for (PropertyValue pv : this.propertyValueList) {
            if (pv.getName().equals(propertyName)) {
                return pv;
            }
        }
        return null;
    }

}
```

- è¿™ä¸¤ä¸ªç±»çš„ä½œç”¨å°±æ˜¯åˆ›å»ºå‡ºä¸€ä¸ªç”¨äºä¼ é€’ç±»ä¸­å±æ€§ä¿¡æ¯çš„ç±»ï¼Œå› ä¸ºå±æ€§å¯èƒ½ä¼šæœ‰å¾ˆå¤šï¼Œæ‰€ä»¥è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªé›†åˆåŒ…è£…ä¸‹ã€‚

### 3. Beanå®šä¹‰è¡¥å…¨

**cn.bugstack.springframework.beans.factory.config.BeanDefinition**

```java
public class BeanDefinition {

    private Class beanClass;

    private PropertyValues propertyValues;

    public BeanDefinition(Class beanClass) {
        this.beanClass = beanClass;
        this.propertyValues = new PropertyValues();
    }

    public BeanDefinition(Class beanClass, PropertyValues propertyValues) {
        this.beanClass = beanClass;
        this.propertyValues = propertyValues != null ? propertyValues : new PropertyValues();
    }
    
    // ...get/set
}
```

- åœ¨ Bean æ³¨å†Œçš„è¿‡ç¨‹ä¸­æ˜¯éœ€è¦ä¼ é€’ Bean çš„ä¿¡æ¯ï¼Œåœ¨å‡ ä¸ªå‰é¢ç« èŠ‚çš„æµ‹è¯•ä¸­éƒ½æœ‰æ‰€ä½“ç° `new BeanDefinition(UserService.class, propertyValues);`
- æ‰€ä»¥ä¸ºäº†æŠŠå±æ€§ä¸€å®šäº¤ç»™ Bean å®šä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œå¡«å……äº† PropertyValues å±æ€§ï¼ŒåŒæ—¶æŠŠä¸¤ä¸ªæ„é€ å‡½æ•°åšäº†ä¸€äº›ç®€å•çš„ä¼˜åŒ–ï¼Œé¿å…åé¢ for å¾ªç¯æ—¶è¿˜å¾—åˆ¤æ–­å±æ€§å¡«å……æ˜¯å¦ä¸ºç©ºã€‚

### 4. Bean å±æ€§å¡«å……

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        addSingleton(beanName, bean);
        return bean;
    }

    protected Object createBeanInstance(BeanDefinition beanDefinition, String beanName, Object[] args) {
        Constructor constructorToUse = null;
        Class<?> beanClass = beanDefinition.getBeanClass();
        Constructor<?>[] declaredConstructors = beanClass.getDeclaredConstructors();
        for (Constructor ctor : declaredConstructors) {
            if (null != args && ctor.getParameterTypes().length == args.length) {
                constructorToUse = ctor;
                break;
            }
        }
        return getInstantiationStrategy().instantiate(beanDefinition, beanName, constructorToUse, args);
    }

    /**
     * Bean å±æ€§å¡«å……
     */
    protected void applyPropertyValues(String beanName, Object bean, BeanDefinition beanDefinition) {
        try {
            PropertyValues propertyValues = beanDefinition.getPropertyValues();
            for (PropertyValue propertyValue : propertyValues.getPropertyValues()) {

                String name = propertyValue.getName();
                Object value = propertyValue.getValue();

                if (value instanceof BeanReference) {
                    // A ä¾èµ– Bï¼Œè·å– B çš„å®ä¾‹åŒ–
                    BeanReference beanReference = (BeanReference) value;
                    value = getBean(beanReference.getBeanName());
                }
                // å±æ€§å¡«å……
                BeanUtil.setFieldValue(bean, name, value);
            }
        } catch (Exception e) {
            throw new BeansException("Error setting property valuesï¼š" + beanName);
        }
    }

    public InstantiationStrategy getInstantiationStrategy() {
        return instantiationStrategy;
    }

    public void setInstantiationStrategy(InstantiationStrategy instantiationStrategy) {
        this.instantiationStrategy = instantiationStrategy;
    }

}
```

- è¿™ä¸ªç±»çš„å†…å®¹ç¨å¾®æœ‰ç‚¹é•¿ï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•ï¼šcreateBeanã€createBeanInstanceã€applyPropertyValuesï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ createBean çš„æ–¹æ³•ä¸­è°ƒç”¨çš„ applyPropertyValues æ–¹æ³•ã€‚
- åœ¨ applyPropertyValues ä¸­ï¼Œé€šè¿‡è·å– `beanDefinition.getPropertyValues()` å¾ªç¯è¿›è¡Œå±æ€§å¡«å……æ“ä½œï¼Œå¦‚æœé‡åˆ°çš„æ˜¯ BeanReferenceï¼Œé‚£ä¹ˆå°±éœ€è¦é€’å½’è·å– Bean å®ä¾‹ï¼Œè°ƒç”¨ getBean æ–¹æ³•ã€‚
- å½“æŠŠä¾èµ–çš„ Bean å¯¹è±¡åˆ›å»ºå®Œæˆåï¼Œä¼šé€’å½’å›ç°åœ¨å±æ€§å¡«å……ä¸­ã€‚è¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬å¹¶æ²¡æœ‰å»å¤„ç†å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¾ƒå¤§ï¼Œåç»­è¡¥å……ã€‚*BeanUtil.setFieldValue(bean, name, value) æ˜¯ hutool-all å·¥å…·ç±»ä¸­çš„æ–¹æ³•ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±å®ç°*

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**cn.bugstack.springframework.test.bean.UserDao**

```java
public class UserDao {

    private static Map<String, String> hashMap = new HashMap<>();

    static {
        hashMap.put("10001", "å°å‚…å“¥");
        hashMap.put("10002", "å…«æ¯æ°´");
        hashMap.put("10003", "é˜¿æ¯›");
    }

    public String queryUserName(String uId) {
        return hashMap.get(uId);
    }

}
```

**cn.bugstack.springframework.test.bean.UserService**

```java
public class UserService {

    private String uId;

    private UserDao userDao;

    public void queryUserInfo() {
        System.out.println("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š" + userDao.queryUserName(uId));
    }

    // ...get/set
}
```

- Daoã€Serviceï¼Œæ˜¯æˆ‘ä»¬å¹³å¸¸å¼€å‘ç»å¸¸ä½¿ç”¨çš„åœºæ™¯ã€‚åœ¨ UserService ä¸­æ³¨å…¥ UserDaoï¼Œè¿™æ ·å°±èƒ½ä½“ç°å‡ºBeanå±æ€§çš„ä¾èµ–äº†ã€‚

### 2. æµ‹è¯•ç”¨ä¾‹

```java
@Test
public void test_BeanFactory() {
    // 1.åˆå§‹åŒ– BeanFactory
    DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();  

    // 2. UserDao æ³¨å†Œ
    beanFactory.registerBeanDefinition("userDao", new BeanDefinition(UserDao.class));   

    // 3. UserService è®¾ç½®å±æ€§[uIdã€userDao]
    PropertyValues propertyValues = new PropertyValues();
    propertyValues.addPropertyValue(new PropertyValue("uId", "10001"));
    propertyValues.addPropertyValue(new PropertyValue("userDao",new BeanReference("userDao")));  

    // 4. UserService æ³¨å…¥bean
    BeanDefinition beanDefinition = new BeanDefinition(UserService.class, propertyValues);
    beanFactory.registerBeanDefinition("userService", beanDefinition);    

    // 5. UserService è·å–bean
    UserService userService = (UserService) beanFactory.getBean("userService");
    userService.queryUserInfo();
}
```

- ä¸ç›´æ¥è·å– Bean å¯¹è±¡ä¸åŒï¼Œè¿™æ¬¡æˆ‘ä»¬è¿˜éœ€è¦å…ˆæŠŠ userDao æ³¨å…¥åˆ° Bean å®¹å™¨ä¸­ã€‚`beanFactory.registerBeanDefinition("userDao", new BeanDefinition(UserDao.class)); `
- æ¥ä¸‹æ¥å°±æ˜¯å±æ€§å¡«å……çš„æ“ä½œäº†ï¼Œä¸€ç§æ˜¯æ™®é€šå±æ€§ `new PropertyValue("uId", "10001")`ï¼Œå¦å¤–ä¸€ç§æ˜¯å¯¹è±¡å±æ€§ `new PropertyValue("userDao",new BeanReference("userDao"))`
- æ¥ä¸‹æ¥çš„æ“ä½œå°±ç®€å•äº†ï¼Œåªä¸è¿‡æ˜¯æ­£å¸¸è·å– userService å¯¹è±¡ï¼Œè°ƒç”¨æ–¹æ³•å³å¯ã€‚

### 3. æµ‹è¯•ç»“æœ

```java
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šå°å‚…å“¥

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœçœ‹æˆ‘ä»¬çš„å±æ€§å¡«å……å·²ç»èµ·ä½œç”¨äº†ï¼Œå› ä¸ºåªæœ‰å±æ€§å¡«å……åï¼Œæ‰èƒ½è°ƒç”¨åˆ°Daoæ–¹æ³•ï¼Œå¦‚ï¼š`userDao.queryUserName(uId)`
- é‚£ä¹ˆæˆ‘ä»¬åœ¨çœ‹çœ‹Debugè°ƒè¯•çš„æƒ…å†µä¸‹ï¼Œæœ‰æ²¡æœ‰è¿›å…¥åˆ°å®ç°çš„ Bean å±æ€§å¡«å……ä¸­ï¼Œå¦‚ä¸‹ï¼š
  
  ![](https://bugstack.cn/assets/images/spring/spring-5-03.png)

   - å¥½ï¼Œå°±æ˜¯æˆªå›¾è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°å·²ç»å¼€å§‹è¿›è¡Œå±æ€§å¡«å……æ“ä½œäº†ï¼Œå½“å‘ç°å±æ€§æ˜¯ BeanReference æ—¶ï¼Œåˆ™éœ€è¦è·å–åˆ›å»º Bean å®ä¾‹ã€‚ 

## å…­ã€æ€»ç»“

- åœ¨æœ¬ç« èŠ‚ä¸­æˆ‘ä»¬æŠŠ AbstractAutowireCapableBeanFactory ç±»ä¸­çš„åˆ›å»ºå¯¹è±¡åŠŸèƒ½åˆåšäº†æ‰©å……ï¼Œä¾èµ–äºæ˜¯å¦æœ‰æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–ç­–ç•¥å®Œæˆåï¼Œå¼€å§‹è¡¥å…… Bean å±æ€§ä¿¡æ¯ã€‚å½“é‡åˆ° Bean å±æ€§ä¸º Bean å¯¹è±¡æ—¶ï¼Œéœ€è¦é€’å½’å¤„ç†ã€‚æœ€ååœ¨å±æ€§å¡«å……æ—¶éœ€è¦ç”¨åˆ°åå°„æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›å·¥å…·ç±»å¤„ç†ã€‚
- æ¯ä¸€ä¸ªç« èŠ‚çš„åŠŸèƒ½ç‚¹æˆ‘ä»¬éƒ½åœ¨å¾ªåºæ¸è¿›çš„å®ç°ï¼Œè¿™æ ·å¯ä»¥è®©æ–°äººæ›´å¥½çš„æ¥å—å…³äº Spring ä¸­çš„è®¾è®¡æ€è·¯ã€‚å°¤å…¶æ˜¯åœ¨ä¸€äº›å·²ç»å¼€å‘å¥½çš„ç±»ä¸Šï¼Œæ€ä¹ˆæ‰©å……æ–°çš„åŠŸèƒ½æ—¶å€™çš„è®¾è®¡æ›´ä¸ºé‡è¦ã€‚å­¦ä¹ ç¼–ç¨‹æœ‰çš„æ—¶å€™å­¦ä¹ æ€è·¯è®¾è®¡è¦æ¯”ä»…ä»…æ˜¯åšç®€å•å®ç°ï¼Œæ›´èƒ½æå‡ç¼–ç¨‹æ€ç»´ã€‚
- åˆ°è¿™ä¸€ç« èŠ‚å…³äº Bean çš„åˆ›å»ºæ“ä½œå°±å¼€å‘å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥éœ€è¦æ•´ä¸ªæ¡†æ¶çš„åŸºç¡€ä¸Šå®Œæˆèµ„æºå±æ€§çš„åŠ è½½ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦å»åŠ¨ Xml é…ç½®äº†ï¼Œè®©æˆ‘ä»¬è¿™å°æ¡†æ¶è¶Šæ¥è¶Šåƒ Springã€‚å¦å¤–åœ¨æ¡†æ¶å®ç°çš„è¿‡ç¨‹ä¸­æ‰€æœ‰çš„ç±»åéƒ½ä¼šå‚è€ƒ Spring æºç ï¼Œä»¥åŠç›¸åº”çš„è®¾è®¡å®ç°æ­¥éª¤ä¹Ÿæ˜¯ä¸ Spring æºç ä¸­å¯¹åº”ï¼Œåªä¸è¿‡ä¼šç®€åŒ–ä¸€äº›æµç¨‹ï¼Œä½†ä½ å¯ä»¥æ‹¿ç›¸åŒçš„ç±»åï¼Œå»æœåˆ°æ¯ä¸€ä¸ªåŠŸèƒ½åœ¨ Spring æºç ä¸­çš„å®ç°ã€‚

## ä¸ƒã€ä¼˜ç§€ä½œä¸š

- [å­¦ä¹ ç¬”è®° By Chin](https://t.zsxq.com/05AiaUJuV)
- [ç»™beanæ³¨å…¥å±æ€§å’Œä¾èµ–å¯¹è±¡ï¼ˆä¾‹ï¼šç»™UserServiceæ³¨å…¥uIdå’ŒUserDaoï¼‰@liuc](https://t.zsxq.com/06nUNZJIA)