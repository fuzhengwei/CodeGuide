---
title: ç¬¬16ç« ï¼šç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼
lock: need
---

# ç¬¬ 16 ç« ï¼šæˆ˜æ— ä¸èƒœï¼Œç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>æ˜Ÿçƒï¼š[https://articles.zsxq.com/id_w629m13v0hni.html](https://articles.zsxq.com/id_w629m13v0hni.html)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## é›¶ã€ä¼˜ç§€ä½œä¸š

- [è°ƒæ•´ AOP ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº å®ç°å…¶å±æ€§æ³¨å…¥ @Rechie](https://t.zsxq.com/06v7aIQRV)
- [è§£å†³ä»£ç†å¯¹è±¡çš„å±æ€§æ³¨å…¥ï¼ŒæŠŠä»£ç†å¯¹è±¡åŠ å…¥ç”Ÿå‘½å‘¨æœŸ @Chin](https://t.zsxq.com/06niaEAYz)
- [ç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼ @liuc](https://t.zsxq.com/084lgJpDk)
- [MyBatis å°±æ˜¯ä¸»è¦ä½¿ç”¨ä»£ç†ç±»ï¼Œå› æ­¤ Spring å°±éœ€è¦æ”¯æŒä»£ç†ç±»çš„åˆå§‹åŒ–ã€‚@æ°´ä¸­ææœˆ](https://t.zsxq.com/08X7yWOw4)
- [è°ƒæ•´AOPä»£ç†å¯¹è±¡çš„ç»“æ„ï¼Œä½¿ä¹‹å¯ä»¥è¢«æ³¨å…¥å±æ€§ @åœ¨ä¹æœˆ](https://t.zsxq.com/0a8bAchto)

## ä¸€ã€å‰è¨€

`æ€ä¹ˆäº†ï¼Œè¿è¡Œçš„å¥½å¥½çš„æ”¾åœ¨åˆ«äººç”µè„‘ä¸Šå°±å‡ºé”™ï¼Ÿ`

æ˜¯ä¸æ˜¯æœ‰æ—¶å€™ä½ è§‰å¾—æäº¤çš„ä»£ç ï¼ŒåŠŸèƒ½å®Œå–„ã€é€»è¾‘æ­£ç¡®ã€æ ¼å¼æ¼‚äº®ï¼Œä½†ä¸ç®¡æ˜¯å°å“¥å“¥è¿˜æ˜¯å°å§å§ï¼Œåªè¦æµ‹è¯•äººå‘˜ä¸€ä¸Šæ‰‹ï¼Œå°±ä¼šå‘ç° **è¿™æœ‰Bugã€é‚£æœ‰Bugã€ä½ å›å»æ”¹æ”¹åˆ«è€½è¯¯æˆ‘æ—¶é—´ï¼** è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?

å› ä¸ºæµ‹è¯•äººå‘˜çš„è¾“å…¥çš„æ•°æ®å¯ä¸æ˜¯ä½ å·²ç»è·‘äº†å‡ åéèƒ½é€šè¿‡è¿è¡Œçš„ç®€å•æ•°æ®ï¼Œä»–ä»¬çš„æ•°æ®æ›´åå‘äºç”¨æˆ·çœŸå®ä½¿ç”¨æ—¶å€™çš„è¾“å…¥æ•ˆæœã€‚å°±åƒæˆ‘ä»¬åœ¨ä½¿ç”¨ Spring çš„æ—¶å€™ï¼Œè°è§„å®šç”¨æˆ·ä¸€å®šä¼šä½¿ç”¨æ™®é€šçš„ç±»å¯¹è±¡å‘¢ï¼Œåªè¦æ˜¯ Java çš„ JDK ä¸­èƒ½æä¾›çš„`éªšæ“ä½œ`å°±éƒ½æœ‰å¯èƒ½åœ¨ Spring æ¡†æ¶ä¸‹ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šMyBatis ç”¨äº†ä»£ç†ç±»ã€RPC é“¾æ¥äº†æ³¨å†Œä¸­å¿ƒã€åˆ†åº“åˆ†è¡¨åˆ‡æ¢äº†æ•°æ®æºï¼Œé‚£è¿™äº›å°±éƒ½éœ€è¦ Spring æ¥æ”¯æŒã€‚è€Œå¦‚æœä½ åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­æ²¡æœ‰è€ƒè™‘åˆ°è¿™äº›ï¼Œå¯èƒ½ä¹Ÿå°±å¿½ç•¥äº†æ­¤ç±»åŠŸèƒ½çš„å®ç°ï¼Œ**è¿™å¥½äº†**ï¼Œæµ‹è¯•é‚£ä¸Šæ‰‹è‚¯å®šå°±å‡º Bug äº†ï¼

## äºŒã€ç›®æ ‡

å…¶å®æœ¬ç« èŠ‚è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å…³äºå¦‚ä½•ç»™ä»£ç†å¯¹è±¡ä¸­çš„å±æ€§å¡«å……ç›¸åº”çš„å€¼ï¼Œå› ä¸ºåœ¨ä¹‹å‰æŠŠ`AOPåŠ¨æ€ä»£ç†ï¼Œèå…¥åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ`æ—¶ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡æ˜¯åœ¨æ•´ä¸ªåˆ›å»º Bean å¯¹è±¡ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä»£ç†å¯¹è±¡çš„åˆ›å»ºå¹¶ä¸æ˜¯åœ¨ Bean ç”Ÿå‘½å‘¨æœŸä¸­ã€‚

æ‰€ä»¥æœ¬ç« èŠ‚ä¸­æˆ‘ä»¬è¦æŠŠä»£ç†å¯¹è±¡çš„åˆ›å»ºèå…¥åˆ° Bean çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æŠŠåˆ›å»ºä»£ç†å¯¹è±¡çš„é€»è¾‘è¿ç§»åˆ°  Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹åï¼Œåœ¨æ‰§è¡Œä»£ç†å¯¹è±¡çš„åˆ›å»ºã€‚

## ä¸‰ã€æ–¹æ¡ˆ

æŒ‰ç…§åˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œ `DefaultAdvisorAutoProxyCreator` å®ç°çš„ `InstantiationAwareBeanPostProcessor` æ¥å£ï¼Œé‚£ä¹ˆåŸæœ¬åœ¨ Before ä¸­çš„æ“ä½œï¼Œåˆ™éœ€è¦æ”¾åˆ° After ä¸­å¤„ç†ã€‚æ•´ä½“è®¾è®¡å¦‚ä¸‹ï¼š

![](https://bugstack.cn/assets/images/spring/spring-16-01.png)

- åœ¨åˆ›å»º Bean å¯¹è±¡ `createBean` çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ‰ä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨ Bean å¯¹è±¡å±æ€§å¡«å……å®Œæˆä»¥åï¼Œæ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†ï¼Œä¾‹å¦‚ï¼šæ„ŸçŸ¥ Aware å¯¹è±¡ã€å¤„ç† init-method æ–¹æ³•ç­‰ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªé˜¶æ®µçš„ `BeanPostProcessor After` å°±å¯ä»¥ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡æ“ä½œã€‚
- åœ¨ DefaultAdvisorAutoProxyCreator ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œä¸­ï¼Œéœ€è¦æŠŠåˆ›å»ºæ“ä½œä» postProcessBeforeInstantiation æ–¹æ³•ä¸­è¿ç§»åˆ° postProcessAfterInitializationï¼Œè¿™æ ·æ‰èƒ½æ»¡è¶³ Bean å±æ€§å¡«å……åçš„åˆ›å»ºæ“ä½œã€‚

## å››ã€å®ç° 

### 1. å·¥ç¨‹ç»“æ„

```java
small-spring-step-15
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.bugstack.springframework
    â”‚           â”œâ”€â”€ aop
    â”‚           â”‚   â”œâ”€â”€ aspectj
    â”‚           â”‚   â”‚   â””â”€â”€ AspectJExpressionPointcut.java
    â”‚           â”‚   â”‚   â””â”€â”€ AspectJExpressionPointcutAdvisor.java
    â”‚           â”‚   â”œâ”€â”€ framework 
    â”‚           â”‚   â”‚   â”œâ”€â”€ adapter
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ MethodBeforeAdviceInterceptor.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ autoproxy
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ MethodBeforeAdviceInterceptor.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ AopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ Cglib2AopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ JdkDynamicAopProxy.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ProxyFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ ReflectiveMethodInvocation.java
    â”‚           â”‚   â”œâ”€â”€ AdvisedSupport.java
    â”‚           â”‚   â”œâ”€â”€ Advisor.java
    â”‚           â”‚   â”œâ”€â”€ BeforeAdvice.java
    â”‚           â”‚   â”œâ”€â”€ ClassFilter.java
    â”‚           â”‚   â”œâ”€â”€ MethodBeforeAdvice.java
    â”‚           â”‚   â”œâ”€â”€ MethodMatcher.java
    â”‚           â”‚   â”œâ”€â”€ Pointcut.java
    â”‚           â”‚   â”œâ”€â”€ PointcutAdvisor.java
    â”‚           â”‚   â””â”€â”€ TargetSource.java
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory  
    â”‚           â”‚   â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Autowired.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowiredAnnotationBeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Qualifier.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ Value.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinition.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanFactoryPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanReference.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigurableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationAwareBeanPostProcessor.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractAutowireCapableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ AbstractBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ BeanDefinitionRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ CglibSubclassingInstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultListableBeanFactory.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DefaultSingletonBeanRegistry.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ DisposableBeanAdapter.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ FactoryBeanRegistrySupport.java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ InstantiationStrategy.java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ SimpleInstantiationStrategy.java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ XmlBeanDefinitionReader.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ Aware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanClassLoaderAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanFactoryAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ BeanNameAware.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ConfigurableListableBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ DisposableBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ FactoryBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ HierarchicalBeanFactory.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ InitializingBean.java
    â”‚           â”‚   â”‚   â”œâ”€â”€ ListableBeanFactory.java
    â”‚           â”‚   â”‚   â””â”€â”€ PropertyPlaceholderConfigurer.java
    â”‚           â”‚   â”œâ”€â”€ BeansException.java
    â”‚           â”‚   â”œâ”€â”€ PropertyValue.java
    â”‚           â”‚   â””â”€â”€ PropertyValues.java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”œâ”€â”€ ClassPathBeanDefinitionScanner.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ClassPathScanningCandidateComponentProvider.java 
    â”‚           â”‚   â”‚   â””â”€â”€ Scope.java 
    â”‚           â”‚   â”œâ”€â”€ event
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationEventMulticaster.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationContextEvent.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationEventMulticaster.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ContextClosedEvent.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ContextRefreshedEvent.java 
    â”‚           â”‚   â”‚   â””â”€â”€ SimpleApplicationEventMulticaster.java 
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractRefreshableApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ AbstractXmlApplicationContext.java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ ApplicationContextAwareProcessor.java 
    â”‚           â”‚   â”‚   â””â”€â”€ ClassPathXmlApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContext.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationContextAware.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationEvent.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationEventPublisher.java 
    â”‚           â”‚   â”œâ”€â”€ ApplicationListener.java 
    â”‚           â”‚   â””â”€â”€ ConfigurableApplicationContext.java
    â”‚           â”œâ”€â”€ core.io
    â”‚           â”‚   â”œâ”€â”€ ClassPathResource.java 
    â”‚           â”‚   â”œâ”€â”€ DefaultResourceLoader.java 
    â”‚           â”‚   â”œâ”€â”€ FileSystemResource.java 
    â”‚           â”‚   â”œâ”€â”€ Resource.java 
    â”‚           â”‚   â”œâ”€â”€ ResourceLoader.java
    â”‚           â”‚   â””â”€â”€ UrlResource.java
    â”‚           â”œâ”€â”€ stereotype
    â”‚           â”‚   â””â”€â”€ Component.java
    â”‚           â””â”€â”€ utils
    â”‚               â”œâ”€â”€ ClassUtils.java
    â”‚               â””â”€â”€ StringValueResolver.java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.springframework.test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ IUserService.java
                â”‚   â””â”€â”€ UserService.java
                â””â”€â”€ ApiTest.java
```

**å·¥ç¨‹æºç **ï¼š`å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç `

åœ¨Beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆ›å»ºä»£ç†å¯¹è±¡çš„ç±»å…³ç³»ï¼Œå¦‚å›¾ 16-2

![å›¾ 16-2](https://bugstack.cn/assets/images/spring/spring-16-02.png)

- è™½ç„¶æœ¬ç« èŠ‚è¦å®Œæˆçš„æ˜¯å…³äºä»£ç†å¯¹è±¡ä¸­å±æ€§çš„å¡«å……é—®é¢˜ï¼Œä½†å®é™…è§£å†³çš„æ€è·¯æ˜¯å¤„ç†åœ¨ Bean çš„ç”Ÿå‘½å‘¨æœŸä¸­åˆé€‚çš„ä½ç½®ï¼ˆ`åˆå§‹åŒ– initializeBean`ï¼‰ä¸­å¤„ç†ä»£ç†ç±»çš„åˆ›å»ºã€‚
- æ‰€ä»¥ä»¥ä¸Šçš„æ”¹åŠ¨å¹¶ä¸ä¼šæ¶‰åŠå¤ªå¤šå†…å®¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼šDefaultAdvisorAutoProxyCreator ç±»åˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œæ”¾ç½®åœ¨ postProcessAfterInitialization æ–¹æ³•ä¸­ä»¥åŠå¯¹åº”åœ¨ AbstractAutowireCapableBeanFactory å®Œæˆåˆå§‹åŒ–æ–¹æ³•çš„è°ƒç”¨æ“ä½œã€‚
- å¦å¤–è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå°±æ˜¯ç›®å‰æˆ‘ä»¬åœ¨ Spring æ¡†æ¶ä¸­ï¼ŒAbstractAutowireCapableBeanFactory ç±»é‡Œä½¿ç”¨çš„æ˜¯ CglibSubclassingInstantiationStrategy åˆ›å»ºå¯¹è±¡ï¼Œæ‰€ä»¥æœ‰éœ€è¦åˆ¤æ–­å¯¹è±¡è·å–æ¥å£çš„æ–¹æ³•ä¸­ï¼Œä¹Ÿéƒ½éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸º CGlibåˆ›å»ºï¼Œå¦åˆ™æ˜¯ä¸èƒ½æ­£ç¡®è·å–åˆ°æ¥å£çš„ã€‚å¦‚ï¼š`ClassUtils.isCglibProxyClass(clazz) ? clazz.getSuperclass() : clazz;`

### 2. åˆ¤æ–­CGlibå¯¹è±¡

**cn.bugstack.springframework.aop.TargetSource**

```java
public class TargetSource {

    private final Object target;

    /**
     * Return the type of targets returned by this {@link TargetSource}.
     * <p>Can return <code>null</code>, although certain usages of a
     * <code>TargetSource</code> might just work with a predetermined
     * target class.
     *
     * @return the type of targets returned by this {@link TargetSource}
     */
    public Class<?>[] getTargetClass() {
        Class<?> clazz = this.target.getClass();
        clazz = ClassUtils.isCglibProxyClass(clazz) ? clazz.getSuperclass() : clazz;
        return clazz.getInterfaces();
    }

}
```

- åœ¨ TargetSource#getTargetClass æ˜¯ç”¨äºè·å– target å¯¹è±¡çš„æ¥å£ä¿¡æ¯çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª target å¯èƒ½æ˜¯ `JDKä»£ç†` åˆ›å»ºä¹Ÿå¯èƒ½æ˜¯ `CGlibåˆ›å»º`ï¼Œä¸ºäº†ä¿è¯éƒ½èƒ½æ­£ç¡®çš„è·å–åˆ°ç»“æœï¼Œè¿™é‡Œéœ€è¦å¢åŠ åˆ¤è¯» `ClassUtils.isCglibProxyClass(clazz)`

### 3. è¿ç§»åˆ›å»ºAOPä»£ç†æ–¹æ³•

**cn.bugstack.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator**

```java
public class DefaultAdvisorAutoProxyCreator implements InstantiationAwareBeanPostProcessor, BeanFactoryAware {

    private DefaultListableBeanFactory beanFactory;

    @Override
    public Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
        return null;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {

        if (isInfrastructureClass(bean.getClass())) return bean;

        Collection<AspectJExpressionPointcutAdvisor> advisors = beanFactory.getBeansOfType(AspectJExpressionPointcutAdvisor.class).values();

        for (AspectJExpressionPointcutAdvisor advisor : advisors) {
            ClassFilter classFilter = advisor.getPointcut().getClassFilter();
            // è¿‡æ»¤åŒ¹é…ç±»
            if (!classFilter.matches(bean.getClass())) continue;

            AdvisedSupport advisedSupport = new AdvisedSupport();

            TargetSource targetSource = new TargetSource(bean);
            advisedSupport.setTargetSource(targetSource);
            advisedSupport.setMethodInterceptor((MethodInterceptor) advisor.getAdvice());
            advisedSupport.setMethodMatcher(advisor.getPointcut().getMethodMatcher());
            advisedSupport.setProxyTargetClass(false);

            // è¿”å›ä»£ç†å¯¹è±¡
            return new ProxyFactory(advisedSupport).getProxy();
        }

        return bean;
    }  

}
```

- å…³äº DefaultAdvisorAutoProxyCreator ç±»çš„æ“ä½œä¸»è¦å°±æ˜¯æŠŠåˆ›å»º AOP ä»£ç†çš„æ“ä½œä» postProcessBeforeInstantiation ç§»åŠ¨åˆ° postProcessAfterInitialization ä¸­å»ã€‚
- é€šè¿‡è®¾ç½®ä¸€äº› AOP çš„å¿…å¤‡å‚æ•°åï¼Œè¿”å›ä»£ç†å¯¹è±¡ `new ProxyFactory(advisedSupport).getProxy()` è¿™ä¸ªä»£ç†å¯¹è±¡ä¸­å°±åŒ…æ‹¬é—´æ¥è°ƒç”¨äº† TargetSource ä¸­å¯¹ getTargetClass() çš„è·å–ã€‚   

### 4. åœ¨Beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆå§‹åŒ–æ‰§è¡Œ

**cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            // ...

            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }
        // ...
        return bean;
    }

    private Object initializeBean(String beanName, Object bean, BeanDefinition beanDefinition) {

        // ...

        wrappedBean = applyBeanPostProcessorsAfterInitialization(bean, beanName);
        return wrappedBean;
    }

    @Override
    public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException {
        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessAfterInitialization(result, beanName);
            if (null == current) return result;
            result = current;
        }
        return result;
    }

}
```

- åœ¨ AbstractAutowireCapableBeanFactory#createBean æ–¹æ³•ä¸­ï¼Œå…¶å®å…³æ³¨ç‚¹å°±åœ¨äº initializeBean -> applyBeanPostProcessorsAfterInitialization è¿™ä¸€å—é€»è¾‘çš„è°ƒç”¨ï¼Œæœ€ç»ˆå®Œæˆ AOP ä»£ç†å¯¹è±¡çš„åˆ›å»ºæ“ä½œã€‚

## äº”ã€æµ‹è¯•

### 1. äº‹å…ˆå‡†å¤‡

**UserService æ·»åŠ å±æ€§å­—æ®µ**

```java
public class UserService implements IUserService {

    private String token;

    public String queryUserInfo() {
        try {
            Thread.sleep(new Random(1).nextInt(100));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return "å°å‚…å“¥ï¼Œ100001ï¼Œæ·±åœ³ï¼Œ" + token;
    }

}
```

- token æ˜¯åœ¨ UserService ä¸­æ–°å¢çš„å±æ€§ä¿¡æ¯ï¼Œç”¨äºæµ‹è¯•ä»£ç†å¯¹è±¡çš„å±æ€§å¡«å……æ“ä½œã€‚

### 2. å±æ€§é…ç½®æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
	         http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="userService" class="cn.bugstack.springframework.test.bean.UserService">
        <property name="token" value="RejDlI78hu223Opo983Ds"/>
    </bean>

    <bean class="cn.bugstack.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"/>

    <bean id="beforeAdvice" class="cn.bugstack.springframework.test.bean.UserServiceBeforeAdvice"/>

    <bean id="methodInterceptor" class="cn.bugstack.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor">
        <property name="advice" ref="beforeAdvice"/>
    </bean>

    <bean id="pointcutAdvisor" class="cn.bugstack.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor">
        <property name="expression" value="execution(* cn.bugstack.springframework.test.bean.IUserService.*(..))"/>
        <property name="advice" ref="methodInterceptor"/>
    </bean>

</beans>
```

- ä¸æˆ‘ä»¬å¯¹ AOP çš„æµ‹è¯•æ¥è¯´ï¼Œå”¯ä¸€æ–°å¢åŠ çš„å°±æ˜¯ property çš„é…ç½®ï¼š`<property name="token" value="RejDlI78hu223Opo983Ds"/>`

### 3. å•å…ƒæµ‹è¯•

```java
@Test
public void test_autoProxy() {
    ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("classpath:spring.xml");
    IUserService userService = applicationContext.getBean("userService", IUserService.class);
    System.out.println("æµ‹è¯•ç»“æœï¼š" + userService.queryUserInfo());
}
```

![](https://bugstack.cn/assets/images/spring/spring-16-03.png)

**æµ‹è¯•ç»“æœ**

```java
æ‹¦æˆªæ–¹æ³•ï¼šqueryUserInfo
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œ100001ï¼Œæ·±åœ³ï¼ŒRejDlI78hu223Opo983Ds

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¯¹ Bean ç”Ÿå‘½å‘¨æœŸçš„è°ƒæ•´ï¼Œåœ¨åˆ›å»º AOP ä»£ç†å¯¹è±¡å°±å¯ä»¥æŠŠä»£ç†å¯¹è±¡çš„å±æ€§ä¿¡æ¯å¡«å……è¿›å»äº†ã€‚
- å¦å¤–è¿™é‡Œè¿˜æœ‰ä¸€å—æ˜¯å…³äºåœ¨ TargetSource#getTargetClass ä¸­å…³äºæ˜¯å¦ä¸º CGlib çš„æ–¹æ³•åˆ¤æ–­ï¼Œåªæœ‰è¿™æ ·æ“ä½œæ‰å¯ä»¥è·å–åˆ°äº‰å–çš„ç±»ä¿¡æ¯ã€‚

## å…­ã€æ€»ç»“

- æœ¬ç« èŠ‚çš„æ ¸å¿ƒçŸ¥è¯†å†…å®¹ä¸»è¦æ˜¯å®Œå–„äº† Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨åˆ›å»ºç±»çš„æ“ä½œä¸­å®Œæˆä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼å°±å¯ä»¥è®©ä»£ç†å¯¹è±¡ä¸­çš„å±æ€§ä¹Ÿå¯ä»¥éšç€åˆ›å»ºè¿‡ç¨‹è¢«å¡«å……è¿›å»ã€‚
- é™¤äº†æ ¸å¿ƒåŠŸèƒ½çš„å®ç°å¤–ä¹Ÿè¦å…³æ³¨åˆ°å¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œæ˜¯ CglibSubclassingInstantiationStrategyã€SimpleInstantiationStrategyï¼Œè¿™ä¸¤ç§æ–¹å¼ä¸­çš„ CGlib åˆ›å»ºå¯¹è±¡ï¼Œä¼šå½±å“åˆ°å¾ˆå¤šåœ°æ–¹ç”¨äºæ¥å£è·å–çš„æ“ä½œï¼Œå› ä¸º CGlib åˆ›å»ºå¯¹è±¡èµ°çš„æ˜¯ ASM å­—èŠ‚ç ç”Ÿæˆçš„æ“ä½œï¼Œæ‰€ä»¥å’Œæ™®é€šçš„ JDK ä»£ç†ç”Ÿæˆå¯¹è±¡æ˜¯ä¸ä¸€æ ·ï¼Œéœ€è¦æ³¨æ„ã€‚
- ç¨‹åºçš„Bugå¾€å¾€æ˜¯å¯¹éœ€æ±‚çš„ä½¿ç”¨åœºæ™¯ç†è§£ä¸è¶³ï¼ŒåŠŸèƒ½çš„å®Œå–„æ˜¯å¯¹ä¸€ä¸ªç»†åŒ–åœºæ™¯çš„ç¨‹åºç²¾é›•ï¼Œå¼€å‘ç¨‹åºçš„è¿‡ç¨‹è¿œè¿œä¸åªæ˜¯å†™ä»£ç é‚£ä¹ˆå›äº‹ï¼Œæ›´é‡è¦çš„æ˜¯æ€è€ƒ`è¿™æ˜¯ä»€ä¹ˆåœºæ™¯`ã€`é‡åˆ°äº†å“ªäº›é—®é¢˜`ã€`è¦æ€ä¹ˆè§£å†³`ã€`å¯ä»¥å­¦åˆ°ä»€ä¹ˆ`ä¸­ä¸æ–­çš„é”¤ç‚¼è‡ªå·±çš„ç¨‹åºé€»è¾‘ã€‚