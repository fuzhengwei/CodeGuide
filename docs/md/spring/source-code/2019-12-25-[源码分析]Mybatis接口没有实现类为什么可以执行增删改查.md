---
layout: post
category: itstack-demo-any
title: æºç åˆ†æ | Mybatisæ¥å£æ²¡æœ‰å®ç°ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥
tagline: by ä»˜æ”¿å§”
tag: [itstack-demo-code,itstack-demo-any]
excerpt: MyBatis æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œç›¸å¯¹äºIBatisæ›´æ˜¯ç²¾è¿›äº†ä¸å°‘ã€‚ä¸æ­¤åŒæ—¶å®ƒè¿˜æä¾›äº†å¾ˆå¤šçš„æ‰©å±•ç‚¹ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„æ’ä»¶ï¼›è¯­è¨€é©±åŠ¨å™¨ï¼Œæ‰§è¡Œå™¨ï¼Œå¯¹è±¡å·¥å‚ï¼Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚ç­‰ç­‰éƒ½å¯ä»¥æ‰©å±•ã€‚é‚£ä¹ˆï¼Œå¦‚æœæƒ³æˆä¸ºä¸€ä¸ªæœ‰æ·±åº¦çš„ç”·äºº(ç¨‹åºçŒ¿)ï¼Œè¿˜æ˜¯åº”è¯¥å¥½å¥½çš„å­¦ä¹ ä¸€ä¸‹è¿™æ¬¾å¼€æºæ¡†æ¶çš„æºç ï¼Œä»¥æ­¤å¯ä»¥æ›´å¥½çš„é¢†ä¼šè®¾è®¡æ¨¡å¼çš„ç²¾é«“(é¢è¯•ï¼Ÿ)ã€‚å…¶å®å¯èƒ½å¹³å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¹¶ä¸ä¼šå»æ·±ç©¶å„ä¸ªæ¡†æ¶çš„æºä»£ç ï¼Œä¹Ÿå¸¸å¸¸ä¼šå¬åˆ°å³ä½¿ä¸ä¼šä¹Ÿå¯ä»¥å¼€å‘ä»£ç ã€‚ä½†ï¼æ¯ä¸ªäººçš„ç›®æ ‡ä¸åŒï¼Œå°±åƒï¼›ä»£ç å†™çš„å¥½å·¥èµ„åŠ çš„å°‘(æ²¡æœ‰bugæ€ä¹ˆçœ‹å‡ºä½ å·¥ä½œå˜ï¼)ï¼Œå¥½ï¼ä¸ºäº†æ”¹å˜ä¸–ç•Œï¼Œå¼€å§‹åˆ†æå–½ï¼
lock: need
---

# æºç åˆ†æ | Mybatisæ¥å£æ²¡æœ‰å®ç°ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

- æ¡ˆä¾‹æºç ï¼š[https://github.com/fuzhengwei/itstack-demo-code-mybatis](https://github.com/fuzhengwei/itstack-demo-code-mybatis)

## ä¸€ã€å‰è¨€ä»‹ç»
MyBatis æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œç›¸å¯¹äºIBatisæ›´æ˜¯ç²¾è¿›äº†ä¸å°‘ã€‚ä¸æ­¤åŒæ—¶å®ƒè¿˜æä¾›äº†å¾ˆå¤šçš„æ‰©å±•ç‚¹ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„æ’ä»¶ï¼›è¯­è¨€é©±åŠ¨å™¨ï¼Œæ‰§è¡Œå™¨ï¼Œå¯¹è±¡å·¥å‚ï¼Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚ç­‰ç­‰éƒ½å¯ä»¥æ‰©å±•ã€‚é‚£ä¹ˆï¼Œå¦‚æœæƒ³æˆä¸ºä¸€ä¸ªæœ‰æ·±åº¦çš„ç”·äºº(ç¨‹åºçŒ¿)ï¼Œè¿˜æ˜¯åº”è¯¥å¥½å¥½çš„å­¦ä¹ ä¸€ä¸‹è¿™æ¬¾å¼€æºæ¡†æ¶çš„æºç ï¼Œä»¥æ­¤å¯ä»¥æ›´å¥½çš„é¢†ä¼šè®¾è®¡æ¨¡å¼çš„ç²¾é«“(é¢è¯•ï¼Ÿ)ã€‚å…¶å®å¯èƒ½å¹³å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¹¶ä¸ä¼šå»æ·±ç©¶å„ä¸ªæ¡†æ¶çš„æºä»£ç ï¼Œä¹Ÿå¸¸å¸¸ä¼šå¬åˆ°å³ä½¿ä¸ä¼šä¹Ÿå¯ä»¥å¼€å‘ä»£ç ã€‚ä½†ï¼æ¯ä¸ªäººçš„ç›®æ ‡ä¸åŒï¼Œå°±åƒï¼›ä»£ç å†™çš„å¥½å·¥èµ„åŠ çš„å°‘(æ²¡æœ‰bugæ€ä¹ˆçœ‹å‡ºä½ å·¥ä½œå˜ï¼)ï¼Œå¥½ï¼ä¸ºäº†æ”¹å˜ä¸–ç•Œï¼Œå¼€å§‹åˆ†æå–½ï¼

åœ¨åˆ†æä¹‹å‰å…ˆå‡ºä¸€ä¸ªé¢˜ï¼Œçœ‹çœ‹ä½ é€‚åˆçœ‹æºç ä¸ï¼›

```java
@Test
public void test(){
    B b = new B();
    b.scan();  //æˆ‘çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
}
static class A {
    public void scan(){
        doScan();
    }
    protected void doScan(){
        System.out.println("A.doScan");
    }
}
static class B extends A {
    @Override
    protected void doScan() {
        System.out.println("B.doScan");
    }
}
```

å…¶å®æ— è®ºä½ çš„ç­”æ¡ˆå¯¹é”™ï¼Œéƒ½ä¸å½±å“ä½ å¯¹æºç çš„åˆ†æã€‚åªä¸è¿‡ï¼Œå¾€å¾€åœ¨ä¸€äº›æ¡†æ¶ä¸­ä¼šæœ‰å¾ˆå¤šçš„è®¾è®¡æ¨¡å¼å’Œå¼€å‘æŠ€å·§ï¼Œå¦‚æœä¸Šé¢çš„ä»£ç åœ¨ä½ å¹³æ—¶çš„å¼€å‘ä¸­å‡ ä¹æ²¡ç”¨è¿‡ï¼Œé‚£ä¹ˆå¯èƒ½ä½ æš‚æ—¶æ›´å¤šçš„è¿˜æ˜¯å¼€å‘ç€CRUDçš„åŠŸèƒ½(è«æ…Œï¼Œæˆ‘è¿˜å†™è¿‡PHPå‘¢)ã€‚

æ¥ä¸‹æ¥å…ˆåˆ†æ Mybatis å•ç‹¬ä½¿ç”¨æ—¶çš„æºç æ‰§è¡Œè¿‡ç¨‹ï¼Œå†åˆ†æ Mybatis+Spring æ•´åˆæºç ï¼Œå¥½ï¼å¼€å§‹ã€‚

## äºŒã€æ¡ˆä¾‹å·¥ç¨‹

ä¸ºäº†æ›´å¥½çš„åˆ†æï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Mybatis çš„æ¡ˆä¾‹å·¥ç¨‹ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼›Mybatis å•ç‹¬ä½¿ç”¨ã€Mybatis+Spring æ•´åˆä½¿ç”¨

```java
itstack-demo-mybatis
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ org.itstack.demo
    â”‚   â”‚       â”œâ”€â”€ dao
    â”‚   â”‚       â”‚	â”œâ”€â”€ ISchool.java		
    â”‚   â”‚       â”‚	â””â”€â”€ IUserDao.java	
    â”‚   â”‚       â””â”€â”€ interfaces     
    â”‚   â”‚         	â”œâ”€â”€ School.java	
    â”‚   â”‚        	â””â”€â”€ User.java
    â”‚   â”œâ”€â”€ resources	
    â”‚   â”‚   â”œâ”€â”€ mapper
    â”‚   â”‚   â”‚   â”œâ”€â”€ School_Mapper.xml
    â”‚   â”‚   â”‚   â””â”€â”€ User_Mapper.xml
    â”‚   â”‚   â”œâ”€â”€ props	
    â”‚   â”‚   â”‚   â””â”€â”€ jdbc.properties
    â”‚   â”‚   â”œâ”€â”€ spring
    â”‚   â”‚   â”‚   â”œâ”€â”€ mybatis-config-datasource.xml
    â”‚   â”‚   â”‚   â””â”€â”€ spring-config-datasource.xml
    â”‚   â”‚   â”œâ”€â”€ logback.xml
    â”‚   â”‚   â”œâ”€â”€ mybatis-config.xml
    â”‚   â”‚   â””â”€â”€ spring-config.xml
    â”‚   â””â”€â”€ webapp
    â”‚       â””â”€â”€ WEB-INF
    â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org.itstack.demo.test
                 â”œâ”€â”€ MybatisApiTest.java
                 â””â”€â”€ SpringApiTest.java
```

## ä¸‰ã€ç¯å¢ƒé…ç½®
1. JDK1.8
2. IDEA 2019.3.1
3. mybatis 3.4.6 {ä¸åŒç‰ˆæœ¬æºç ç•¥æœ‰å·®å¼‚å’Œbugä¿®å¤}
4. mybatis-spring 1.3.2 ï½›ä»¥ä¸‹æºç åˆ†æä¼šè¯´ä»£ç è¡Œå·ï¼Œæ³¨æ„ä¸åŒç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å·®å¼‚ï½

## å››ã€(mybatis)æºç åˆ†æ

```xml 
<dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis</artifactId>
    <version>3.4.6</version>
</dependency>
```

Mybatisçš„æ•´ä¸ªæºç è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œä»¥ä¸‹ä¸»è¦å°†éƒ¨åˆ†æ ¸å¿ƒå†…å®¹è¿›è¡Œæ•´ç†åˆ†æï¼Œä»¥ä¾¿äºåç»­åˆ†æMybatisä¸Springæ•´åˆçš„æºç éƒ¨åˆ†ã€‚ç®€è¦åŒ…æ‹¬ï¼›å®¹å™¨åˆå§‹åŒ–ã€é…ç½®æ–‡ä»¶è§£æã€MapperåŠ è½½ä¸åŠ¨æ€ä»£ç†ã€‚

### 1. ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹

è¦å­¦ä¹ Mybatisæºç ï¼Œæœ€å¥½çš„æ–¹å¼ä¸€å®šæ˜¯ä»ä¸€ä¸ªç®€å•çš„ç‚¹è¿›å…¥ï¼Œè€Œä¸æ˜¯ä»Springæ•´åˆå¼€å§‹åˆ†æã€‚SqlSessionFactoryæ˜¯æ•´ä¸ªMybatisçš„æ ¸å¿ƒå®ä¾‹å¯¹è±¡ï¼ŒSqlSessionFactoryå¯¹è±¡çš„å®ä¾‹åˆé€šè¿‡SqlSessionFactoryBuilderå¯¹è±¡æ¥è·å¾—ã€‚SqlSessionFactoryBuilderå¯¹è±¡å¯ä»¥ä»XMLé…ç½®æ–‡ä»¶åŠ è½½é…ç½®ä¿¡æ¯ï¼Œç„¶ååˆ›å»ºSqlSessionFactoryã€‚å¦‚ä¸‹ä¾‹å­ï¼š

>MybatisApiTest.java

```java
public class MybatisApiTest {

    @Test
    public void test_queryUserInfoById() {
        String resource = "spring/mybatis-config-datasource.xml";
        Reader reader;
        try {
            reader = Resources.getResourceAsReader(resource);
            SqlSessionFactory sqlMapper = new SqlSessionFactoryBuilder().build(reader);

            SqlSession session = sqlMapper.openSession();
            try {
                User user = session.selectOne("org.itstack.demo.dao.IUserDao.queryUserInfoById", 1L);
                System.out.println(JSON.toJSONString(user));
            } finally {
                session.close();
                reader.close();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}
```  

>dao/IUserDao.java

```java
public interface IUserDao {

     User queryUserInfoById(Long id);

}
```

>spring/mybatis-config-datasource.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">

<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://127.0.0.1:3306/itstack?useUnicode=true"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>

    <mappers>
        <mapper resource="mapper/User_Mapper.xml"/>
    </mappers>

</configuration>
```

**å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š**

```java
{"age":18,"createTime":1571376957000,"id":1,"name":"èŠ±èŠ±","updateTime":1571376957000}
```

ä»ä¸Šé¢çš„ä»£ç å—å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒä»£ç ï¼›`SqlSessionFactoryBuilder().build(reader)`ï¼Œè´Ÿè´£Mybatisé…ç½®æ–‡ä»¶çš„åŠ è½½ã€è§£æã€æ„å»ºç­‰èŒè´£ï¼Œç›´åˆ°æœ€ç»ˆå¯ä»¥é€šè¿‡SqlSessionæ¥æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚

### 2. å®¹å™¨åˆå§‹åŒ–

ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒSqlSessionFactoryæ˜¯é€šè¿‡SqlSessionFactoryBuilderå·¥å‚ç±»åˆ›å»ºçš„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æ„é€ å™¨ã€‚å®¹å™¨çš„é…ç½®æ–‡ä»¶åŠ è½½å’Œåˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š
                   
![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & åˆå§‹åŒ–æµç¨‹](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-01.png)

- æµç¨‹æ ¸å¿ƒç±»
  - SqlSessionFactoryBuilder
  - XMLConfigBuilder
  - XPathParser
  - Configuration

>SqlSessionFactoryBuilder.java 

```java
public class SqlSessionFactoryBuilder {

  public SqlSessionFactory build(Reader reader) {
    return build(reader, null, null);
  }

  public SqlSessionFactory build(Reader reader, String environment) {
    return build(reader, environment, null);
  }

  public SqlSessionFactory build(Reader reader, Properties properties) {
    return build(reader, null, properties);
  }

  public SqlSessionFactory build(Reader reader, String environment, Properties properties) {
    try {
      XMLConfigBuilder parser = new XMLConfigBuilder(reader, environment, properties);
      return build(parser.parse());
    } catch (Exception e) {
      throw ExceptionFactory.wrapException("Error building SqlSession.", e);
    } finally {
      ErrorContext.instance().reset();
      try {
        reader.close();
      } catch (IOException e) {
        // Intentionally ignore. Prefer previous error.
      }
    }
  }

  public SqlSessionFactory build(InputStream inputStream) {
    return build(inputStream, null, null);
  }

  public SqlSessionFactory build(InputStream inputStream, String environment) {
    return build(inputStream, environment, null);
  }

  public SqlSessionFactory build(InputStream inputStream, Properties properties) {
    return build(inputStream, null, properties);
  }

  public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {
    try {
      XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
      return build(parser.parse());
    } catch (Exception e) {
      throw ExceptionFactory.wrapException("Error building SqlSession.", e);
    } finally {
      ErrorContext.instance().reset();
      try {
        inputStream.close();
      } catch (IOException e) {
        // Intentionally ignore. Prefer previous error.
      }
    }
  }
    
  public SqlSessionFactory build(Configuration config) {
    return new DefaultSqlSessionFactory(config);
  }

}
```

ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼ŒSqlSessionFactoryæä¾›ä¸‰ç§æ–¹å¼buildæ„å»ºå¯¹è±¡ï¼›
- å­—èŠ‚æµï¼šjava.io.InputStream
- å­—ç¬¦æµï¼šjava.io.Reader
- é…ç½®ç±»ï¼šorg.apache.ibatis.session.Configuration

é‚£ä¹ˆï¼Œå­—èŠ‚æµã€å­—ç¬¦æµéƒ½ä¼šåˆ›å»ºé…ç½®æ–‡ä»¶è§£æç±»ï¼šXMLConfigBuilderï¼Œå¹¶é€šè¿‡parser.parse()ç”ŸæˆConfigurationï¼Œæœ€åè°ƒç”¨é…ç½®ç±»æ„å»ºæ–¹æ³•ç”ŸæˆSqlSessionFactoryã€‚

>XMLConfigBuilder.java

```java
public class XMLConfigBuilder extends BaseBuilder {

  private boolean parsed;
  private final XPathParser parser;
  private String environment;
  private final ReflectorFactory localReflectorFactory = new DefaultReflectorFactory();

  ...
  public XMLConfigBuilder(Reader reader, String environment, Properties props) {
    this(new XPathParser(reader, true, props, new XMLMapperEntityResolver()), environment, props);
  }
  ...
}  
```

1. XMLConfigBuilderå¯¹äºXMLæ–‡ä»¶çš„åŠ è½½å’Œè§£æéƒ½å§”æ‰˜äºXPathParserï¼Œæœ€ç»ˆä½¿ç”¨JDKè‡ªå¸¦çš„javax.xmlè¿›è¡ŒXMLè§£æ(XPath)
2. XPathParser(Reader reader, boolean validation, Properties variables, EntityResolver entityResolver)
   1. readerï¼šä½¿ç”¨å­—ç¬¦æµåˆ›å»ºæ–°çš„è¾“å…¥æºï¼Œç”¨äºå¯¹XMLæ–‡ä»¶çš„è¯»å–
   2. validationï¼šæ˜¯å¦è¿›è¡ŒDTDæ ¡éªŒ
   3. variablesï¼šå±æ€§é…ç½®ä¿¡æ¯
   4. entityResolverï¼šMybatisç¡¬ç¼–ç äº†new XMLMapperEntityResolver()æä¾›XMLé»˜è®¤è§£æå™¨

>XMLMapperEntityResolver.java

```java
public class XMLMapperEntityResolver implements EntityResolver {

  private static final String IBATIS_CONFIG_SYSTEM = "ibatis-3-config.dtd";
  private static final String IBATIS_MAPPER_SYSTEM = "ibatis-3-mapper.dtd";
  private static final String MYBATIS_CONFIG_SYSTEM = "mybatis-3-config.dtd";
  private static final String MYBATIS_MAPPER_SYSTEM = "mybatis-3-mapper.dtd";

  private static final String MYBATIS_CONFIG_DTD = "org/apache/ibatis/builder/xml/mybatis-3-config.dtd";
  private static final String MYBATIS_MAPPER_DTD = "org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd";

  /*
   * Converts a public DTD into a local one
   * 
   * @param publicId The public id that is what comes after "PUBLIC"
   * @param systemId The system id that is what comes after the public id.
   * @return The InputSource for the DTD
   * 
   * @throws org.xml.sax.SAXException If anything goes wrong
   */
  @Override
  public InputSource resolveEntity(String publicId, String systemId) throws SAXException {
    try {
      if (systemId != null) {
        String lowerCaseSystemId = systemId.toLowerCase(Locale.ENGLISH);
        if (lowerCaseSystemId.contains(MYBATIS_CONFIG_SYSTEM) || lowerCaseSystemId.contains(IBATIS_CONFIG_SYSTEM)) {
          return getInputSource(MYBATIS_CONFIG_DTD, publicId, systemId);
        } else if (lowerCaseSystemId.contains(MYBATIS_MAPPER_SYSTEM) || lowerCaseSystemId.contains(IBATIS_MAPPER_SYSTEM)) {
          return getInputSource(MYBATIS_MAPPER_DTD, publicId, systemId);
        }
      }
      return null;
    } catch (Exception e) {
      throw new SAXException(e.toString());
    }
  }

  private InputSource getInputSource(String path, String publicId, String systemId) {
    InputSource source = null;
    if (path != null) {
      try {
        InputStream in = Resources.getResourceAsStream(path);
        source = new InputSource(in);
        source.setPublicId(publicId);
        source.setSystemId(systemId);        
      } catch (IOException e) {
        // ignore, null is ok
      }
    }
    return source;
  }

}
```

1. Mybatisä¾èµ–äºdtdæ–‡ä»¶è¿›è¡Œè¿›è¡Œè§£æï¼Œå…¶ä¸­çš„ibatis-3-config.dtdä¸»è¦æ˜¯ç”¨äºå…¼å®¹ç”¨é€”
2. getInputSource(String path, String publicId, String systemId)çš„è°ƒç”¨é‡Œé¢æœ‰ä¸¤ä¸ªå‚æ•°publicIdï¼ˆå…¬å…±æ ‡è¯†ç¬¦ï¼‰å’ŒsystemIdï¼ˆç³»ç»Ÿæ ‡ç¤ºç¬¦ï¼‰

>XPathParser.java

```java
public XPathParser(Reader reader, boolean validation, Properties variables, EntityResolver entityResolver) {
  commonConstructor(validation, variables, entityResolver);
  this.document = createDocument(new InputSource(reader));
}

private void commonConstructor(boolean validation, Properties variables, EntityResolver entityResolver) {
  this.validation = validation;
  this.entityResolver = entityResolver;
  this.variables = variables;
  XPathFactory factory = XPathFactory.newInstance();
  this.xpath = factory.newXPath();
}

private Document createDocument(InputSource inputSource) {
  // important: this must only be called AFTER common constructor
  try {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    factory.setValidating(validation);
    factory.setNamespaceAware(false);
    factory.setIgnoringComments(true);
    factory.setIgnoringElementContentWhitespace(false);
    factory.setCoalescing(false);
    factory.setExpandEntityReferences(true);
    DocumentBuilder builder = factory.newDocumentBuilder();
    builder.setEntityResolver(entityResolver);
    builder.setErrorHandler(new ErrorHandler() {
      @Override
      public void error(SAXParseException exception) throws SAXException {
        throw exception;
      }
      @Override
      public void fatalError(SAXParseException exception) throws SAXException {
        throw exception;
      }
      @Override
      public void warning(SAXParseException exception) throws SAXException {
      }
    });
    return builder.parse(inputSource);
  } catch (Exception e) {
    throw new BuilderException("Error creating document instance.  Cause: " + e, e);
  }
  
}    
```

1. ä»ä¸Šåˆ°ä¸‹å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªMybatisçš„æ–‡æ¡£è§£æå™¨ï¼Œæœ€åæ ¹æ®builder.parse(inputSource)è¿”å›Document
2. å¾—åˆ°XPathParserå®ä¾‹åï¼Œæ¥ä¸‹æ¥åœ¨è°ƒç”¨æ–¹æ³•ï¼š**this**(new XPathParser(reader, true, props, new XMLMapperEntityResolver()), environment, props);
   
   ```java
    XMLConfigBuilder.this(new XPathParser(reader, true, props, new XMLMapperEntityResolver()), environment, props);
   
    private XMLConfigBuilder(XPathParser parser, String environment, Properties props) {
      super(new Configuration());
      ErrorContext.instance().resource("SQL Mapper Configuration");
      this.configuration.setVariables(props);
      this.parsed = false;
      this.environment = environment;
      this.parser = parser;
    }
   ```
3. å…¶ä¸­è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°
   
   ```java
   public abstract class BaseBuilder {
     protected final Configuration configuration;
     protected final TypeAliasRegistry typeAliasRegistry;
     protected final TypeHandlerRegistry typeHandlerRegistry;
   
     public BaseBuilder(Configuration configuration) {
       this.configuration = configuration;
       this.typeAliasRegistry = this.configuration.getTypeAliasRegistry();
       this.typeHandlerRegistry = this.configuration.getTypeHandlerRegistry();
     }
   }
   ```
4. XMLConfigBuilderåˆ›å»ºå®Œæˆåï¼ŒsqlSessionFactoryBuildè°ƒç”¨parser.parse()åˆ›å»ºConfiguration

   ```java
   public class XMLConfigBuilder extends BaseBuilder {    
        public Configuration parse() {
          if (parsed) {
            throw new BuilderException("Each XMLConfigBuilder can only be used once.");
          }
          parsed = true;
          parseConfiguration(parser.evalNode("/configuration"));
          return configuration;
        }
   }
   ```

### 3. é…ç½®æ–‡ä»¶è§£æ

è¿™ä¸€éƒ¨åˆ†æ˜¯æ•´ä¸ªXMLæ–‡ä»¶è§£æå’Œè£…è½½çš„æ ¸å¿ƒå†…å®¹ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼›
1. å±æ€§è§£æpropertiesElement
2. åŠ è½½settingsèŠ‚ç‚¹settingsAsProperties
3. è½½è‡ªå®šä¹‰VFS loadCustomVfs
4. è§£æç±»å‹åˆ«åtypeAliasesElement
5. åŠ è½½æ’ä»¶pluginElement
6. åŠ è½½å¯¹è±¡å·¥å‚objectFactoryElement
7. åˆ›å»ºå¯¹è±¡åŒ…è£…å™¨å·¥å‚objectWrapperFactoryElement
8. åŠ è½½åå°„å·¥å‚reflectorFactoryElement
9. å…ƒç´ è®¾ç½®settingsElement
10. åŠ è½½ç¯å¢ƒé…ç½®environmentsElement
11. æ•°æ®åº“å‚å•†æ ‡è¯†åŠ è½½databaseIdProviderElement
12. åŠ è½½ç±»å‹å¤„ç†å™¨typeHandlerElement
13. (**æ ¸å¿ƒ**)åŠ è½½mapperæ–‡ä»¶mapperElement  

```java
parseConfiguration(parser.evalNode("/configuration"));

private void parseConfiguration(XNode root) {
    try {
      //issue #117 read properties first
      //å±æ€§è§£æpropertiesElement
      propertiesElement(root.evalNode("properties"));
      //åŠ è½½settingsèŠ‚ç‚¹settingsAsProperties
      Properties settings = settingsAsProperties(root.evalNode("settings"));
      //åŠ è½½è‡ªå®šä¹‰VFS loadCustomVfs
      loadCustomVfs(settings);
      //è§£æç±»å‹åˆ«åtypeAliasesElement
      typeAliasesElement(root.evalNode("typeAliases"));
      //åŠ è½½æ’ä»¶pluginElement
      pluginElement(root.evalNode("plugins"));
      //åŠ è½½å¯¹è±¡å·¥å‚objectFactoryElement
      objectFactoryElement(root.evalNode("objectFactory"));
      //åˆ›å»ºå¯¹è±¡åŒ…è£…å™¨å·¥å‚objectWrapperFactoryElement
      objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));
      //åŠ è½½åå°„å·¥å‚reflectorFactoryElement
      reflectorFactoryElement(root.evalNode("reflectorFactory"));
      //å…ƒç´ è®¾ç½®
      settingsElement(settings);
      // read it after objectFactory and objectWrapperFactory issue #631
      //åŠ è½½ç¯å¢ƒé…ç½®environmentsElement
      environmentsElement(root.evalNode("environments"));
      //æ•°æ®åº“å‚å•†æ ‡è¯†åŠ è½½databaseIdProviderElement
      databaseIdProviderElement(root.evalNode("databaseIdProvider"));
      //åŠ è½½ç±»å‹å¤„ç†å™¨typeHandlerElement
      typeHandlerElement(root.evalNode("typeHandlers"));
      //åŠ è½½mapperæ–‡ä»¶mapperElement
      mapperElement(root.evalNode("mappers"));
    } catch (Exception e) {
      throw new BuilderException("Error parsing SQL Mapper Configuration. Cause: " + e, e);
    }
} 
```

æ‰€æœ‰çš„root.evalNode()åº•å±‚éƒ½æ˜¯è°ƒç”¨XML DOMæ–¹æ³•ï¼šObject evaluate(String expression, Object item, QName returnType)ï¼Œè¡¨è¾¾å¼å‚æ•°expressionï¼Œé€šè¿‡XObject resultObject = eval( expression, item )è¿”å›æœ€ç»ˆèŠ‚ç‚¹å†…å®¹ï¼Œå¯ä»¥å‚è€ƒhttp://mybatis.org/dtd/mybatis-3-config.dtdï¼Œå¦‚ä¸‹ï¼›

```xml
<!ELEMENT configuration (properties?, settings?, typeAliases?, typeHandlers?, objectFactory?, objectWrapperFactory?, reflectorFactory?, plugins?, environments?, databaseIdProvider?, mappers?)>
 
<!ELEMENT databaseIdProvider (property*)>
<!ATTLIST databaseIdProvider
type CDATA #REQUIRED
>
 
<!ELEMENT properties (property*)>
<!ATTLIST properties
resource CDATA #IMPLIED
url CDATA #IMPLIED
>
 
<!ELEMENT property EMPTY>
<!ATTLIST property
name CDATA #REQUIRED
value CDATA #REQUIRED
>
 
<!ELEMENT settings (setting+)>
 
<!ELEMENT setting EMPTY>
<!ATTLIST setting
name CDATA #REQUIRED
value CDATA #REQUIRED
>
 
<!ELEMENT typeAliases (typeAlias*,package*)>
 
<!ELEMENT typeAlias EMPTY>
<!ATTLIST typeAlias
type CDATA #REQUIRED
alias CDATA #IMPLIED
>
 
<!ELEMENT typeHandlers (typeHandler*,package*)>
 
<!ELEMENT typeHandler EMPTY>
<!ATTLIST typeHandler
javaType CDATA #IMPLIED
jdbcType CDATA #IMPLIED
handler CDATA #REQUIRED
>
 
<!ELEMENT objectFactory (property*)>
<!ATTLIST objectFactory
type CDATA #REQUIRED
>
 
<!ELEMENT objectWrapperFactory EMPTY>
<!ATTLIST objectWrapperFactory
type CDATA #REQUIRED
>
 
<!ELEMENT reflectorFactory EMPTY>
<!ATTLIST reflectorFactory
type CDATA #REQUIRED
>
 
<!ELEMENT plugins (plugin+)>
 
<!ELEMENT plugin (property*)>
<!ATTLIST plugin
interceptor CDATA #REQUIRED
>
 
<!ELEMENT environments (environment+)>
<!ATTLIST environments
default CDATA #REQUIRED
>
 
<!ELEMENT environment (transactionManager,dataSource)>
<!ATTLIST environment
id CDATA #REQUIRED
>
 
<!ELEMENT transactionManager (property*)>
<!ATTLIST transactionManager
type CDATA #REQUIRED
>
 
<!ELEMENT dataSource (property*)>
<!ATTLIST dataSource
type CDATA #REQUIRED
>
 
<!ELEMENT mappers (mapper*,package*)>
 
<!ELEMENT mapper EMPTY>
<!ATTLIST mapper
resource CDATA #IMPLIED
url CDATA #IMPLIED
class CDATA #IMPLIED
>
 
<!ELEMENT package EMPTY>
<!ATTLIST package
name CDATA #REQUIRED
>
```

mybatis-3-config.dtd å®šä¹‰æ–‡ä»¶ä¸­æœ‰11ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼›
1. properties?, 
2. settings?, 
3. typeAliases?, 
4. typeHandlers?, 
5. objectFactory?, 
6. objectWrapperFactory?, 
7. reflectorFactory?, 
8. plugins?, 
9. environments?, 
10. databaseIdProvider?, 
11. mappers?

ä»¥ä¸Šæ¯ä¸ªé…ç½®éƒ½æ˜¯å¯é€‰ã€‚æœ€ç»ˆé…ç½®å†…å®¹ä¼šä¿å­˜åˆ°org.apache.ibatis.session.Configurationï¼Œå¦‚ä¸‹ï¼›

```java
public class Configuration {

  protected Environment environment;
  // å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆRowBoundsï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸ºfalseã€‚é»˜è®¤ä¸ºfalse
  protected boolean safeRowBoundsEnabled;
  // å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆResultHandlerï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸ºfalseã€‚
  protected boolean safeResultHandlerEnabled = true;
  // æ˜¯å¦å¼€å¯è‡ªåŠ¨é©¼å³°å‘½åè§„åˆ™ï¼ˆcamel caseï¼‰æ˜ å°„ï¼Œå³ä»ç»å…¸æ•°æ®åº“åˆ—å A_COLUMN åˆ°ç»å…¸ Java å±æ€§å aColumn çš„ç±»ä¼¼æ˜ å°„ã€‚é»˜è®¤false
  protected boolean mapUnderscoreToCamelCase;
  // å½“å¼€å¯æ—¶ï¼Œä»»ä½•æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚å¦åˆ™ï¼Œæ¯ä¸ªå±æ€§ä¼šæŒ‰éœ€åŠ è½½ã€‚é»˜è®¤å€¼false (true in â‰¤3.4.1)
  protected boolean aggressiveLazyLoading;
  // æ˜¯å¦å…è®¸å•ä¸€è¯­å¥è¿”å›å¤šç»“æœé›†ï¼ˆéœ€è¦å…¼å®¹é©±åŠ¨ï¼‰ã€‚
  protected boolean multipleResultSetsEnabled = true;
  // å…è®¸ JDBC æ”¯æŒè‡ªåŠ¨ç”Ÿæˆä¸»é”®ï¼Œéœ€è¦é©±åŠ¨å…¼å®¹ã€‚è¿™å°±æ˜¯insertæ—¶è·å–mysqlè‡ªå¢ä¸»é”®/oracle sequenceçš„å¼€å…³ã€‚æ³¨ï¼šä¸€èˆ¬æ¥è¯´,è¿™æ˜¯å¸Œæœ›çš„ç»“æœ,åº”è¯¥é»˜è®¤å€¼ä¸ºtrueæ¯”è¾ƒåˆé€‚ã€‚
  protected boolean useGeneratedKeys;
  // ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—å,ä¸€èˆ¬æ¥è¯´,è¿™æ˜¯å¸Œæœ›çš„ç»“æœ
  protected boolean useColumnLabel = true;
  // æ˜¯å¦å¯ç”¨ç¼“å­˜ {é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯ä½ çš„é¢è¯•é¢˜}
  protected boolean cacheEnabled = true;
  // æŒ‡å®šå½“ç»“æœé›†ä¸­å€¼ä¸º null çš„æ—¶å€™æ˜¯å¦è°ƒç”¨æ˜ å°„å¯¹è±¡çš„ setterï¼ˆmap å¯¹è±¡æ—¶ä¸º putï¼‰æ–¹æ³•ï¼Œè¿™å¯¹äºæœ‰ Map.keySet() ä¾èµ–æˆ– null å€¼åˆå§‹åŒ–çš„æ—¶å€™æ˜¯æœ‰ç”¨çš„ã€‚
  protected boolean callSettersOnNulls;
  // å…è®¸ä½¿ç”¨æ–¹æ³•ç­¾åä¸­çš„åç§°ä½œä¸ºè¯­å¥å‚æ•°åç§°ã€‚ ä¸ºäº†ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œä½ çš„å·¥ç¨‹å¿…é¡»é‡‡ç”¨Java 8ç¼–è¯‘ï¼Œå¹¶ä¸”åŠ ä¸Š-parametersé€‰é¡¹ã€‚ï¼ˆä»3.4.1å¼€å§‹ï¼‰
  protected boolean useActualParamName = true;
  //å½“è¿”å›è¡Œçš„æ‰€æœ‰åˆ—éƒ½æ˜¯ç©ºæ—¶ï¼ŒMyBatisé»˜è®¤è¿”å›nullã€‚ å½“å¼€å¯è¿™ä¸ªè®¾ç½®æ—¶ï¼ŒMyBatisä¼šè¿”å›ä¸€ä¸ªç©ºå®ä¾‹ã€‚ è¯·æ³¨æ„ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåµŒå¥—çš„ç»“æœé›† (i.e. collectioin and association)ã€‚ï¼ˆä»3.4.2å¼€å§‹ï¼‰ æ³¨ï¼šè¿™é‡Œåº”è¯¥æ‹†åˆ†ä¸ºä¸¤ä¸ªå‚æ•°æ¯”è¾ƒåˆé€‚, ä¸€ä¸ªç”¨äºç»“æœé›†ï¼Œä¸€ä¸ªç”¨äºå•è®°å½•ã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›ç»“æœé›†ä¸æ˜¯nullï¼Œå•è®°å½•ä»ç„¶æ˜¯null
  protected boolean returnInstanceForEmptyRow;
  // æŒ‡å®š MyBatis å¢åŠ åˆ°æ—¥å¿—åç§°çš„å‰ç¼€ã€‚
  protected String logPrefix;
  // æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾ã€‚ä¸€èˆ¬å»ºè®®æŒ‡å®šä¸ºslf4jæˆ–log4j
  protected Class <? extends Log> logImpl;
   // æŒ‡å®šVFSçš„å®ç°, VFSæ˜¯mybatisæä¾›çš„ç”¨äºè®¿é—®ASå†…èµ„æºçš„ä¸€ä¸ªç®€ä¾¿æ¥å£
  protected Class <? extends VFS> vfsImpl;
  // MyBatis åˆ©ç”¨æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocal Cacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircular referencesï¼‰å’ŒåŠ é€Ÿé‡å¤åµŒå¥—æŸ¥è¯¢ã€‚ é»˜è®¤å€¼ä¸º SESSIONï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šç¼“å­˜ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰æŸ¥è¯¢ã€‚ è‹¥è®¾ç½®å€¼ä¸º STATEMENTï¼Œæœ¬åœ°ä¼šè¯ä»…ç”¨åœ¨è¯­å¥æ‰§è¡Œä¸Šï¼Œå¯¹ç›¸åŒ SqlSession çš„ä¸åŒè°ƒç”¨å°†ä¸ä¼šå…±äº«æ•°æ®ã€‚
  protected LocalCacheScope localCacheScope = LocalCacheScope.SESSION;
  // å½“æ²¡æœ‰ä¸ºå‚æ•°æä¾›ç‰¹å®šçš„ JDBC ç±»å‹æ—¶ï¼Œä¸ºç©ºå€¼æŒ‡å®š JDBC ç±»å‹ã€‚ æŸäº›é©±åŠ¨éœ€è¦æŒ‡å®šåˆ—çš„ JDBC ç±»å‹ï¼Œå¤šæ•°æƒ…å†µç›´æ¥ç”¨ä¸€èˆ¬ç±»å‹å³å¯ï¼Œæ¯”å¦‚ NULLã€VARCHAR æˆ– OTHERã€‚
  protected JdbcType jdbcTypeForNull = JdbcType.OTHER;
  // æŒ‡å®šå¯¹è±¡çš„å“ªä¸ªæ–¹æ³•è§¦å‘ä¸€æ¬¡å»¶è¿ŸåŠ è½½ã€‚
  protected Set<String> lazyLoadTriggerMethods = new HashSet<String>(Arrays.asList(new String[] { "equals", "clone", "hashCode", "toString" }));
  // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå®ƒå†³å®šé©±åŠ¨ç­‰å¾…æ•°æ®åº“å“åº”çš„ç§’æ•°ã€‚é»˜è®¤ä¸è¶…æ—¶
  protected Integer defaultStatementTimeout;
  // ä¸ºé©±åŠ¨çš„ç»“æœé›†è®¾ç½®é»˜è®¤è·å–æ•°é‡ã€‚
  protected Integer defaultFetchSize;
  // SIMPLE å°±æ˜¯æ™®é€šçš„æ‰§è¡Œå™¨ï¼›REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆprepared statementsï¼‰ï¼› BATCH æ‰§è¡Œå™¨å°†é‡ç”¨è¯­å¥å¹¶æ‰§è¡Œæ‰¹é‡æ›´æ–°ã€‚
  protected ExecutorType defaultExecutorType = ExecutorType.SIMPLE;
  // æŒ‡å®š MyBatis åº”å¦‚ä½•è‡ªåŠ¨æ˜ å°„åˆ—åˆ°å­—æ®µæˆ–å±æ€§ã€‚ NONE è¡¨ç¤ºå–æ¶ˆè‡ªåŠ¨æ˜ å°„ï¼›PARTIAL åªä¼šè‡ªåŠ¨æ˜ å°„æ²¡æœ‰å®šä¹‰åµŒå¥—ç»“æœé›†æ˜ å°„çš„ç»“æœé›†ã€‚ FULL ä¼šè‡ªåŠ¨æ˜ å°„ä»»æ„å¤æ‚çš„ç»“æœé›†ï¼ˆæ— è®ºæ˜¯å¦åµŒå¥—ï¼‰ã€‚
  protected AutoMappingBehavior autoMappingBehavior = AutoMappingBehavior.PARTIAL;
  // æŒ‡å®šå‘ç°è‡ªåŠ¨æ˜ å°„ç›®æ ‡æœªçŸ¥åˆ—ï¼ˆæˆ–è€…æœªçŸ¥å±æ€§ç±»å‹ï¼‰çš„è¡Œä¸ºã€‚è¿™ä¸ªå€¼åº”è¯¥è®¾ç½®ä¸ºWARNINGæ¯”è¾ƒåˆé€‚
  protected AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior = AutoMappingUnknownColumnBehavior.NONE;
  // settingsä¸‹çš„propertieså±æ€§
  protected Properties variables = new Properties();
  // é»˜è®¤çš„åå°„å™¨å·¥å‚,ç”¨äºæ“ä½œå±æ€§ã€æ„é€ å™¨æ–¹ä¾¿
  protected ReflectorFactory reflectorFactory = new DefaultReflectorFactory();
  // å¯¹è±¡å·¥å‚, æ‰€æœ‰çš„ç±»resultMapç±»éƒ½éœ€è¦ä¾èµ–äºå¯¹è±¡å·¥å‚æ¥å®ä¾‹åŒ–
  protected ObjectFactory objectFactory = new DefaultObjectFactory();
  // å¯¹è±¡åŒ…è£…å™¨å·¥å‚,ä¸»è¦ç”¨æ¥åœ¨åˆ›å»ºéåŸç”Ÿå¯¹è±¡,æ¯”å¦‚å¢åŠ äº†æŸäº›ç›‘æ§æˆ–è€…ç‰¹æ®Šå±æ€§çš„ä»£ç†ç±»
  protected ObjectWrapperFactory objectWrapperFactory = new DefaultObjectWrapperFactory();
  // å»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ã€‚ç‰¹å®šå…³è”å…³ç³»ä¸­å¯é€šè¿‡è®¾ç½®fetchTypeå±æ€§æ¥è¦†ç›–è¯¥é¡¹çš„å¼€å…³çŠ¶æ€ã€‚
  protected boolean lazyLoadingEnabled = false;
  // æŒ‡å®š Mybatis åˆ›å»ºå…·æœ‰å»¶è¿ŸåŠ è½½èƒ½åŠ›çš„å¯¹è±¡æ‰€ç”¨åˆ°çš„ä»£ç†å·¥å…·ã€‚MyBatis 3.3+ä½¿ç”¨JAVASSIST
  protected ProxyFactory proxyFactory = new JavassistProxyFactory(); // #224 Using internal Javassist instead of OGNL
  // MyBatis å¯ä»¥æ ¹æ®ä¸åŒçš„æ•°æ®åº“å‚å•†æ‰§è¡Œä¸åŒçš„è¯­å¥ï¼Œè¿™ç§å¤šå‚å•†çš„æ”¯æŒæ˜¯åŸºäºæ˜ å°„è¯­å¥ä¸­çš„ databaseId å±æ€§ã€‚
  protected String databaseId;
  ...
}
```

ä»¥ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒMybatisæŠŠæ‰€æœ‰çš„é…ç½®ï¼›resultMapã€Sqlè¯­å¥ã€æ’ä»¶ã€ç¼“å­˜ç­‰éƒ½ç»´æŠ¤åœ¨Configurationä¸­ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œåœ¨Configurationè¿˜æœ‰ä¸€ä¸ªStrictMapå†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿äºHashMapå®Œå–„äº†putæ—¶é˜²é‡ã€getæ—¶å–ä¸åˆ°å€¼çš„å¼‚å¸¸å¤„ç†ï¼Œå¦‚ä¸‹ï¼›

```java
protected static class StrictMap<V> extends HashMap<String, V> {

    private static final long serialVersionUID = -4950446264854982944L;
    private final String name;

    public StrictMap(String name, int initialCapacity, float loadFactor) {
      super(initialCapacity, loadFactor);
      this.name = name;
    }

    public StrictMap(String name, int initialCapacity) {
      super(initialCapacity);
      this.name = name;
    }

    public StrictMap(String name) {
      super();
      this.name = name;
    }

    public StrictMap(String name, Map<String, ? extends V> m) {
      super(m);
      this.name = name;
    }
}    
```

**(æ ¸å¿ƒ)åŠ è½½mapperæ–‡ä»¶mapperElement**

Mapperæ–‡ä»¶å¤„ç†æ˜¯Mybatisæ¡†æ¶çš„æ ¸å¿ƒæœåŠ¡ï¼Œæ‰€æœ‰çš„SQLè¯­å¥éƒ½ç¼–å†™åœ¨Mapperä¸­ï¼Œè¿™å—ä¹Ÿæ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œå…¶ä»–æ¨¡å—å¯ä»¥åç»­è®²è§£ã€‚

>XMLConfigBuilder.parseConfiguration()->mapperElement(root.evalNode("mappers"));

```java
private void mapperElement(XNode parent) throws Exception {
   if (parent != null) {
     for (XNode child : parent.getChildren()) {
       // å¦‚æœè¦åŒæ—¶ä½¿ç”¨packageè‡ªåŠ¨æ‰«æå’Œé€šè¿‡mapperæ˜ç¡®æŒ‡å®šè¦åŠ è½½çš„mapperï¼Œä¸€å®šè¦ç¡®ä¿packageè‡ªåŠ¨æ‰«æçš„èŒƒå›´ä¸åŒ…å«æ˜ç¡®æŒ‡å®šçš„mapperï¼Œå¦åˆ™åœ¨é€šè¿‡packageæ‰«æçš„interfaceçš„æ—¶å€™ï¼Œå°è¯•åŠ è½½å¯¹åº”xmlæ–‡ä»¶çš„loadXmlResource()çš„é€»è¾‘ä¸­å‡ºç°åˆ¤é‡å‡ºé”™ï¼ŒæŠ¥org.apache.ibatis.binding.BindingExceptionå¼‚å¸¸ï¼Œå³ä½¿xmlæ–‡ä»¶ä¸­åŒ…å«çš„å†…å®¹å’Œmapperæ¥å£ä¸­åŒ…å«çš„è¯­å¥ä¸é‡å¤ä¹Ÿä¼šå‡ºé”™ï¼ŒåŒ…æ‹¬åŠ è½½mapperæ¥å£æ—¶è‡ªåŠ¨åŠ è½½çš„xml mapperä¹Ÿä¸€æ ·ä¼šå‡ºé”™ã€‚
       if ("package".equals(child.getName())) {
         String mapperPackage = child.getStringAttribute("name");
         configuration.addMappers(mapperPackage);
       } else {
         String resource = child.getStringAttribute("resource");
         String url = child.getStringAttribute("url");
         String mapperClass = child.getStringAttribute("class");
         if (resource != null && url == null && mapperClass == null) {
           ErrorContext.instance().resource(resource);
           InputStream inputStream = Resources.getResourceAsStream(resource);
           XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());
           mapperParser.parse();
         } else if (resource == null && url != null && mapperClass == null) {
           ErrorContext.instance().resource(url);
           InputStream inputStream = Resources.getUrlAsStream(url);
           XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());
           mapperParser.parse();
         } else if (resource == null && url == null && mapperClass != null) {
           Class<?> mapperInterface = Resources.classForName(mapperClass);
           configuration.addMapper(mapperInterface);
         } else {
           throw new BuilderException("A mapper element may only specify a url, resource or class, but not more than one.");
         }
       }
     }
   }
}
```

- Mybatisæä¾›äº†ä¸¤ç±»é…ç½®Mapperçš„æ–¹æ³•ï¼Œç¬¬ä¸€ç±»æ˜¯ä½¿ç”¨packageè‡ªåŠ¨æœç´¢çš„æ¨¡å¼ï¼Œè¿™æ ·æŒ‡å®špackageä¸‹æ‰€æœ‰æ¥å£éƒ½ä¼šè¢«æ³¨å†Œä¸ºmapperï¼Œä¹Ÿæ˜¯åœ¨Springä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š

  ```java
  <mappers>
    <package name="org.itstack.demo"/>
  </mappers>
  ```

- å¦å¤–ä¸€ç±»æ˜¯æ˜ç¡®æŒ‡å®šMapperï¼Œè¿™åˆå¯ä»¥é€šè¿‡resourceã€urlæˆ–è€…classè¿›è¡Œç»†åˆ†ï¼Œä¾‹å¦‚ï¼›

  ```java
  <mappers>
      <mapper resource="mapper/User_Mapper.xml"/>
      <mapper class=""/>
      <mapper url=""/>
  </mappers>
  ```

### 4. MapperåŠ è½½ä¸åŠ¨æ€ä»£ç†

é€šè¿‡packageæ–¹å¼è‡ªåŠ¨æœç´¢åŠ è½½ï¼Œç”Ÿæˆå¯¹åº”çš„mapperä»£ç†ç±»ï¼Œä»£ç å—å’Œæµç¨‹ï¼Œå¦‚ä¸‹ï¼›

```java 
private void mapperElement(XNode parent) throws Exception {
  if (parent != null) {
    for (XNode child : parent.getChildren()) {
      if ("package".equals(child.getName())) {
        String mapperPackage = child.getStringAttribute("name");
        configuration.addMappers(mapperPackage);
      } else {
        ...
      }
    }
  }
}
```

![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & åŠ¨æ€ä»£ç†è¿‡ç¨‹](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-02.png)

MapperåŠ è½½åˆ°ç”Ÿæˆä»£ç†å¯¹è±¡çš„æµç¨‹ä¸­ï¼Œä¸»è¦çš„æ ¸å¿ƒç±»åŒ…æ‹¬ï¼›
1. XMLConfigBuilder
2. Configuration
3. MapperRegistry
4. MapperAnnotationBuilder
5. MapperProxyFactory

>MapperRegistry.java

**è§£æåŠ è½½Mapper**

```java 
public void addMappers(String packageName, Class<?> superType) {
  // mybatisæ¡†æ¶æä¾›çš„æœç´¢classpathä¸‹æŒ‡å®špackageä»¥åŠå­packageä¸­ç¬¦åˆæ¡ä»¶(æ³¨è§£æˆ–è€…ç»§æ‰¿äºæŸä¸ªç±»/æ¥å£)çš„ç±»ï¼Œé»˜è®¤ä½¿ç”¨Thread.currentThread().getContextClassLoader()è¿”å›çš„åŠ è½½å™¨,å’Œspringçš„å·¥å…·ç±»æ®Šé€”åŒå½’ã€‚
  ResolverUtil<Class<?>> resolverUtil = new ResolverUtil<Class<?>>();   
  // æ— æ¡ä»¶çš„åŠ è½½æ‰€æœ‰çš„ç±»,å› ä¸ºè°ƒç”¨æ–¹ä¼ é€’äº†Object.classä½œä¸ºçˆ¶ç±»,è¿™ä¹Ÿç»™ä»¥åçš„æŒ‡å®šmapperæ¥å£é¢„ç•™äº†ä½™åœ°
  resolverUtil.find(new ResolverUtil.IsA(superType), packageName); 
 // æ‰€æœ‰åŒ¹é…çš„calsséƒ½è¢«å­˜å‚¨åœ¨ResolverUtil.matcheså­—æ®µä¸­
  Set<Class<? extends Class<?>>> mapperSet = resolverUtil.getClasses();
  for (Class<?> mapperClass : mapperSet) {   
    //è°ƒç”¨addMapperæ–¹æ³•è¿›è¡Œå…·ä½“çš„mapperç±»/æ¥å£è§£æ
    addMapper(mapperClass);
  }
}
```

**ç”Ÿæˆä»£ç†ç±»ï¼šMapperProxyFactory**

```java 
public <T> void addMapper(Class<T> type) {    
  // å¯¹äºmybatis mapperæ¥å£æ–‡ä»¶ï¼Œå¿…é¡»æ˜¯interfaceï¼Œä¸èƒ½æ˜¯class
  if (type.isInterface()) {
    if (hasMapper(type)) {
      throw new BindingException("Type " + type + " is already known to the MapperRegistry.");
    }
    boolean loadCompleted = false;
    try {      
      // ä¸ºmapperæ¥å£åˆ›å»ºä¸€ä¸ªMapperProxyFactoryä»£ç†
      knownMappers.put(type, new MapperProxyFactory<T>(type));
      // It's important that the type is added before the parser is run
      // otherwise the binding may automatically be attempted by the
      // mapper parser. If the type is already known, it won't try.
      MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type);
      parser.parse();
      loadCompleted = true;
    } finally {
      if (!loadCompleted) {
        knownMappers.remove(type);
      }
    }
  }
}
```

åœ¨MapperRegistryä¸­ç»´æŠ¤äº†æ¥å£ç±»ä¸ä»£ç†å·¥ç¨‹çš„æ˜ å°„å…³ç³»ï¼ŒknownMappersï¼›

```java 
private final Map<Class<?>, MapperProxyFactory<?>> knownMappers = new HashMap<Class<?>, MapperProxyFactory<?>>();
```

>MapperProxyFactory.java

```java 
public class MapperProxyFactory<T> {
  private final Class<T> mapperInterface;
  private final Map<Method, MapperMethod> methodCache = new ConcurrentHashMap<Method, MapperMethod>();
  public MapperProxyFactory(Class<T> mapperInterface) {
    this.mapperInterface = mapperInterface;
  }
  public Class<T> getMapperInterface() {
    return mapperInterface;
  }
  public Map<Method, MapperMethod> getMethodCache() {
    return methodCache;
  }
  @SuppressWarnings("unchecked")
  protected T newInstance(MapperProxy<T> mapperProxy) {
    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);
  }
  public T newInstance(SqlSession sqlSession) {
    final MapperProxy<T> mapperProxy = new MapperProxy<T>(sqlSession, mapperInterface, methodCache);
    return newInstance(mapperProxy);
  }
}
```  

å¦‚ä¸Šæ˜¯Mapperçš„ä»£ç†ç±»å·¥ç¨‹ï¼Œæ„é€ å‡½æ•°ä¸­çš„mapperInterfaceå°±æ˜¯å¯¹åº”çš„æ¥å£ç±»ï¼Œå½“å®ä¾‹åŒ–æ—¶å€™ä¼šè·å¾—å…·ä½“çš„MapperProxyä»£ç†ï¼Œé‡Œé¢ä¸»è¦åŒ…å«äº†SqlSessionã€‚

## äº”ã€(mybatis-spring)æºç åˆ†æ

```xml 
<dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis-spring</artifactId>
    <version>1.3.2</version>
</dependency>
```

ä½œä¸ºä¸€æ¬¾å¥½ç”¨çš„ORMæ¡†æ¶ï¼Œä¸€å®šæ˜¯èè‰è„¸(**å•çº¯**)ã€å¾¡å§å¿ƒ(**å¼ºå¤§**)ï¼Œé“ºçš„äº†åºŠ(**å±è”½ä¸JDBCç›´æ¥æ‰“äº¤é“**)ã€æš–çš„äº†æˆ¿(**é€Ÿåº¦æ€§èƒ½å¥½**)ï¼é‰´äºè¿™äº›ä¼˜ç‚¹å‡ ä¹åœ¨å›½å†…äº’è”ç½‘å¤§éƒ¨åˆ†å¼€å‘æ¡†æ¶éƒ½ä¼šä½¿ç”¨åˆ°Mybatisï¼Œå°¤å…¶åœ¨ä¸€äº›éœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ä¸‹éœ€è¦ä¼˜åŒ–sqlé‚£ä¹ˆä¸€å®šéœ€è¦æ‰‹å†™sqlåœ¨xmlä¸­ã€‚é‚£ä¹ˆï¼Œå‡†å¤‡å¥½äº†å—ï¼å¼€å§‹åˆ†æåˆ†æå®ƒçš„æºç ï¼›

### 1. ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹

ä¸åˆ†æmybatisæºç ä¸€æ ·ï¼Œå…ˆåšä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼›å®šä¹‰daoã€ç¼–å†™é…ç½®æ–‡ä»¶ã€junitå•å…ƒæµ‹è¯•ï¼›

>SpringApiTest.java

```java 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration("classpath:spring-config.xml")
public class SpringApiTest {

    private Logger logger = LoggerFactory.getLogger(SpringApiTest.class);

    @Resource
    private ISchoolDao schoolDao;
    @Resource
    private IUserDao userDao;

    @Test
    public void test_queryRuleTreeByTreeId(){
        School ruleTree = schoolDao.querySchoolInfoById(1L);
        logger.info(JSON.toJSONString(ruleTree));

        User user = userDao.queryUserInfoById(1L);
        logger.info(JSON.toJSONString(user));
    }

}
```     

>spring-config-datasource.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- 1.æ•°æ®åº“è¿æ¥æ± ï¼š DriverManagerDataSource ä¹Ÿå¯ä»¥ä½¿ç”¨DBCP2-->
    <bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="${db.jdbc.driverClassName}"/>
        <property name="url" value="${db.jdbc.url}"/>
        <property name="username" value="${db.jdbc.username}"/>
        <property name="password" value="${db.jdbc.password}"/>
    </bean>

    <!-- 2.é…ç½®SqlSessionFactoryå¯¹è±¡ -->
    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
        <!-- æ³¨å…¥æ•°æ®åº“è¿æ¥æ±  -->
        <property name="dataSource" ref="dataSource"/>
        <!-- é…ç½®MyBatieså…¨å±€é…ç½®æ–‡ä»¶:mybatis-config.xml -->
        <property name="configLocation" value="classpath:mybatis-config.xml"/>
        <!-- æ‰«æentityåŒ… ä½¿ç”¨åˆ«å -->
        <property name="typeAliasesPackage" value="org.itstack.demo.po"/>
        <!-- æ‰«æsqlé…ç½®æ–‡ä»¶:mapperéœ€è¦çš„xmlæ–‡ä»¶ -->
        <property name="mapperLocations" value="classpath:mapper/*.xml"/>
    </bean>

    <!-- 3.é…ç½®æ‰«æDaoæ¥å£åŒ…ï¼ŒåŠ¨æ€å®ç°Daoæ¥å£ï¼Œæ³¨å…¥åˆ°springå®¹å™¨ä¸­ -->
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <!-- æ³¨å…¥sqlSessionFactory -->
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"/>
        <!-- ç»™å‡ºéœ€è¦æ‰«æDaoæ¥å£åŒ…ï¼Œå¤šä¸ªé€—å·éš”å¼€ -->
        <property name="basePackage" value="org.itstack.demo.dao"/>
    </bean>
              
</beans>
```

**å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š**

```java
{"address":"åŒ—äº¬å¸‚æµ·æ·€åŒºé¢å’Œå›­è·¯5å·","createTime":1571376957000,"id":1,"name":"åŒ—äº¬å¤§å­¦","updateTime":1571376957000}
{"age":18,"createTime":1571376957000,"id":1,"name":"èŠ±èŠ±","updateTime":1571376957000}
```

ä»ä¸Šé¢å•å…ƒæµ‹è¯•çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæ²¡æœ‰æ–¹æ³•ä½“çš„æ³¨è§£å°±è¿™ä¹ˆç¥å¥‡çš„æ‰§è¡Œäº†æˆ‘ä»¬çš„xmlä¸­çš„é…ç½®è¯­å¥å¹¶è¾“å‡ºäº†ç»“æœã€‚å…¶å®ä¸»è¦å¾—ç›Šäºä»¥ä¸‹ä¸¤ä¸ªç±»ï¼›
- org.mybatis.spring.SqlSessionFactoryBean
- org.mybatis.spring.mapper.MapperScannerConfigurer

### 2. æ‰«æè£…é…æ³¨å†Œ(MapperScannerConfigurer)

MapperScannerConfigurerä¸ºæ•´ä¸ªDaoæ¥å£å±‚ç”ŸæˆåŠ¨æ€ä»£ç†ç±»æ³¨å†Œï¼Œå¯åŠ¨åˆ°äº†æ ¸å¿ƒä½œç”¨ã€‚è¿™ä¸ªç±»å®ç°äº†å¦‚ä¸‹æ¥å£ï¼Œç”¨æ¥å¯¹æ‰«æçš„Mapperè¿›è¡Œå¤„ç†ï¼š
- BeanDefinitionRegistryPostProcessor
- InitializingBean
- ApplicationContextAware
- BeanNameAware

æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼›

![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & MapperScannerConfigurerç±»å›¾](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-03.png)

æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼›

![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & æ‰§è¡Œæµç¨‹å›¾](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-04.png)

ä¸Šé¢çš„ç±»å›¾+æµç¨‹å›¾ï¼Œå…¶å®å·²ç»å¾ˆæ¸…æ¥šçš„æè¿°äº†MapperScannerConfigureråˆå§‹åŒ–è¿‡ç¨‹ï¼Œä½†å¯¹äºå¤´ä¸€æ¬¡çœ‹çš„æ–°äººæ¥è¯´ä¾æ—§æ˜¯æˆ‘å¤ªéš¾äº†ï¼Œå¥½ç»§ç»­ï¼

>MapperScannerConfigurer.java & éƒ¨åˆ†æˆªå–

```java 
@Override
public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {
  if (this.processPropertyPlaceHolders) {
    processPropertyPlaceHolders();
  }
  ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);
  scanner.setAddToConfig(this.addToConfig);
  scanner.setAnnotationClass(this.annotationClass);
  scanner.setMarkerInterface(this.markerInterface);
  scanner.setSqlSessionFactory(this.sqlSessionFactory);
  scanner.setSqlSessionTemplate(this.sqlSessionTemplate);
  scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);
  scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);
  scanner.setResourceLoader(this.applicationContext);
  scanner.setBeanNameGenerator(this.nameGenerator);
  scanner.registerFilters();
  scanner.scan(StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));
}
```

- å®ç°äº†BeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistryç”¨äºæ³¨å†ŒBeanåˆ°Springå®¹å™¨ä¸­
- **306è¡Œ**ï¼šnew ClassPathMapperScanner(registry); ç¡¬ç¼–ç ç±»è·¯å¾„æ‰«æå™¨ï¼Œç”¨äºè§£æMybatisçš„Mapperæ–‡ä»¶
- **317è¡Œ**ï¼šscanner.scan å¯¹Mapperè¿›è¡Œæ‰«æã€‚è¿™é‡ŒåŒ…å«äº†ä¸€ä¸ªç»§æ‰¿ç±»å®ç°å…³ç³»çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡å¼€å¤´çš„æµ‹è¯•é¢˜ã€‚

>ClassPathMapperScanner.java & éƒ¨åˆ†æˆªå–

```java 
@Override
public Set<BeanDefinitionHolder> doScan(String... basePackages) {
  Set<BeanDefinitionHolder> beanDefinitions = super.doScan(basePackages);
  if (beanDefinitions.isEmpty()) {
    logger.warn("No MyBatis mapper was found in '" + Arrays.toString(basePackages) + "' package. Please check your configuration.");
  } else {
    processBeanDefinitions(beanDefinitions);
  }
  return beanDefinitions;
}
```   

- ä¼˜å…ˆè°ƒç”¨çˆ¶ç±»çš„super.doScan(basePackages);è¿›è¡Œæ³¨å†ŒBeanä¿¡æ¯

>ClassPathBeanDefinitionScanner.java & éƒ¨åˆ†æˆªå–

```java 
protected Set<BeanDefinitionHolder> doScan(String... basePackages) {
	Assert.notEmpty(basePackages, "At least one base package must be specified");
	Set<BeanDefinitionHolder> beanDefinitions = new LinkedHashSet<BeanDefinitionHolder>();
	for (String basePackage : basePackages) {
		Set<BeanDefinition> candidates = findCandidateComponents(basePackage);
		for (BeanDefinition candidate : candidates) {
			ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);
			candidate.setScope(scopeMetadata.getScopeName());
			String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);
			if (candidate instanceof AbstractBeanDefinition) {
				postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);
			}
			if (candidate instanceof AnnotatedBeanDefinition) {
				AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate)
			}
			if (checkCandidate(beanName, candidate)) {
				BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);
				definitionHolder =
						AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.regi
				beanDefinitions.add(definitionHolder);
				registerBeanDefinition(definitionHolder, this.registry);
			}
		}
	}
	return beanDefinitions;
}
```

- ä¼˜å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„doScanæ–¹æ³•ï¼Œç”¨äºMapperæ‰«æå’ŒBeançš„å®šä¹‰ä»¥åŠæ³¨å†Œåˆ°DefaultListableBeanFactoryã€‚ï½›DefaultListableBeanFactoryæ˜¯Springä¸­IOCå®¹å™¨çš„å§‹ç¥–ï¼Œæ‰€æœ‰éœ€è¦å®ä¾‹åŒ–çš„ç±»éƒ½éœ€è¦æ³¨å†Œè¿›æ¥ï¼Œä¹‹ååœ¨åˆå§‹åŒ–ï½
- **272è¡Œ**ï¼šfindCandidateComponents(basePackage)ï¼Œæ‰«æpackageåŒ…è·¯å¾„ï¼Œå¯¹äºæ³¨è§£ç±»çš„æœ‰å¦å¤–çš„æ–¹å¼ï¼Œå¤§åŒå°å¼‚
- **288è¡Œ**ï¼šregisterBeanDefinition(definitionHolder, this.registry);æ³¨å†ŒBeanä¿¡æ¯çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°ï¼šorg.springframework.beans.factory.support.DefaultListableBeanFactory

>ClassPathMapperScanner.java & éƒ¨åˆ†æˆªå–

```java 
**processBeanDefinitions(beanDefinitions);**

private void processBeanDefinitions(Set<BeanDefinitionHolder> beanDefinitions) {
  GenericBeanDefinition definition;
  for (BeanDefinitionHolder holder : beanDefinitions) {
    definition = (GenericBeanDefinition) holder.getBeanDefinition();
    if (logger.isDebugEnabled()) {
      logger.debug("Creating MapperFactoryBean with name '" + holder.getBeanName() 
        + "' and '" + definition.getBeanClassName() + "' mapperInterface");
    }
    // the mapper interface is the original class of the bean
    // but, the actual class of the bean is MapperFactoryBean
    definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); // issue #59
    definition.setBeanClass(this.mapperFactoryBean.getClass());
    definition.getPropertyValues().add("addToConfig", this.addToConfig);
    boolean explicitFactoryUsed = false;
    if (StringUtils.hasText(this.sqlSessionFactoryBeanName)) {
      definition.getPropertyValues().add("sqlSessionFactory", new RuntimeBeanReference(this.sqlSessionFactoryBeanName));
      explicitFactoryUsed = true;
    } else if (this.sqlSessionFactory != null) {
      definition.getPropertyValues().add("sqlSessionFactory", this.sqlSessionFactory);
      explicitFactoryUsed = true;
    }
    if (StringUtils.hasText(this.sqlSessionTemplateBeanName)) {
      if (explicitFactoryUsed) {
        logger.warn("Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.");
      }
      definition.getPropertyValues().add("sqlSessionTemplate", new RuntimeBeanReference(this.sqlSessionTemplateBeanName));
      explicitFactoryUsed = true;
    } else if (this.sqlSessionTemplate != null) {
      if (explicitFactoryUsed) {
        logger.warn("Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.");
      }
      definition.getPropertyValues().add("sqlSessionTemplate", this.sqlSessionTemplate);
      explicitFactoryUsed = true;
    }
    if (!explicitFactoryUsed) {
      if (logger.isDebugEnabled()) {
        logger.debug("Enabling autowire by type for MapperFactoryBean with name '" + holder.getBeanName() + "'.");
      }
      definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);
    }
  }
}
```

- **163è¡Œ**ï¼šsuper.doScan(basePackages);ï¼Œè°ƒç”¨å®Œçˆ¶ç±»æ–¹æ³•åå¼€å§‹æ‰§è¡Œå†…éƒ¨æ–¹æ³•ï¼šprocessBeanDefinitions(beanDefinitions)
- **186è¡Œ**ï¼šdefinition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); è®¾ç½®BeanNameå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ï¼šISchoolDaoã€IUserDao
- **187è¡Œ**ï¼šdefinition.setBeanClass(this.mapperFactoryBean.getClass());ï¼Œè®¾ç½®BeanClassï¼Œæ¥å£æœ¬èº«æ˜¯æ²¡æœ‰ç±»çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°†**MapperFactoryBean**ç±»è®¾ç½®è¿›æ¥ï¼Œæœ€ç»ˆæ‰€æœ‰çš„daoå±‚æ¥å£ç±»éƒ½æ˜¯è¿™ä¸ª**MapperFactoryBean**

>MapperFactoryBean.java & éƒ¨åˆ†æˆªå– 

è¿™ä¸ªç±»æœ‰ç»§æ‰¿ä¹Ÿæœ‰æ¥å£å®ç°ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹æ•´ä½“ç±»å›¾ï¼Œå¦‚ä¸‹ï¼›

![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & MapperFactoryBeanç±»å›¾](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-05.png)

è¿™ä¸ªç±»å°±éå¸¸é‡è¦äº†ï¼Œæœ€ç»ˆæ‰€æœ‰çš„sqlä¿¡æ¯æ‰§è¡Œéƒ½ä¼šé€šè¿‡è¿™ä¸ªç±»è·å–getObject()ï¼Œä¹Ÿå°±æ˜¯SqlSessionè·å–mapperçš„ä»£ç†ç±»ï¼š`MapperProxyFactory->MapperProxy`

```java    
public class MapperFactoryBean<T> extends SqlSessionDaoSupport implements FactoryBean<T> {

  private Class<T> mapperInterface;

  private boolean addToConfig = true;

  public MapperFactoryBean() {
    //intentionally empty 
  }
  
  public MapperFactoryBean(Class<T> mapperInterface) {
    this.mapperInterface = mapperInterface;
  }

  /**  
   * å½“SpringBeanå®¹å™¨åˆå§‹åŒ–æ—¶å€™ä¼šè°ƒç”¨åˆ°checkDaoConfig()ï¼Œä»–æ˜¯ç»§æ‰¿ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•
   * {@inheritDoc}
   */
  @Override
  protected void checkDaoConfig() {
    super.checkDaoConfig();

    notNull(this.mapperInterface, "Property 'mapperInterface' is required");

    Configuration configuration = getSqlSession().getConfiguration();
    if (this.addToConfig && !configuration.hasMapper(this.mapperInterface)) {
      try {
        configuration.addMapper(this.mapperInterface);
      } catch (Exception e) {
        logger.error("Error while adding the mapper '" + this.mapperInterface + "' to configuration.", e);
        throw new IllegalArgumentException(e);
      } finally {
        ErrorContext.instance().reset();
      }
    }
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public T getObject() throws Exception {
    return getSqlSession().getMapper(this.mapperInterface);
  }

  ...
}
```   

- **72è¡Œ**ï¼šcheckDaoConfig()ï¼Œå½“SpringBeanå®¹å™¨åˆå§‹åŒ–æ—¶å€™ä¼šè°ƒç”¨åˆ°checkDaoConfig()ï¼Œä»–æ˜¯ç»§æ‰¿ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•
- **95è¡Œ**ï¼šgetSqlSession().getMapper(this.mapperInterface);ï¼Œé€šè¿‡æ¥å£è·å–Mapper(ä»£ç†ç±»)ï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼›
  - `DefaultSqlSession.getMapper(Class<T> type)`ï¼Œè·å–Mapper
  - `Configuration.getMapper(Class<T> type, SqlSession sqlSession)`ï¼Œä»é…ç½®ä¸­è·å–
  - `MapperRegistry.getMapper(Class<T> type, SqlSession sqlSession)`ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å–åˆ°å®ä¾‹åŒ–ç”Ÿæˆ
    
    ```java 
    public <T> T getMapper(Class<T> type, SqlSession sqlSession) {
      final MapperProxyFactory<T> mapperProxyFactory = (MapperProxyFactory<T>) knownMappers.get(type);
      if (mapperProxyFactory == null) {
        throw new BindingException("Type " + type + " is not known to the MapperRegistry.");
      }
      try {
        return mapperProxyFactory.newInstance(sqlSession);
      } catch (Exception e) {
        throw new BindingException("Error getting mapper instance. Cause: " + e, e);
      }
    }

    ```
  - mapperProxyFactory.newInstance(sqlSession);ï¼Œé€šè¿‡åå°„å·¥ç¨‹ç”ŸæˆMapperProxy
 
    ```java 
    @SuppressWarnings("unchecked")
    protected T newInstance(MapperProxy<T> mapperProxy) {
      return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);
    }
    public T newInstance(SqlSession sqlSession) {
      final MapperProxy<T> mapperProxy = new MapperProxy<T>(sqlSession, mapperInterface, methodCache);
      return newInstance(mapperProxy);
    }
    ```

>MapperProxy.java & éƒ¨åˆ†æˆªå–

```java 
public class MapperProxy<T> implements InvocationHandler, Serializable {

  private static final long serialVersionUID = -6424540398559729838L;
  private final SqlSession sqlSession;
  private final Class<T> mapperInterface;
  private final Map<Method, MapperMethod> methodCache;

  public MapperProxy(SqlSession sqlSession, Class<T> mapperInterface, Map<Method, MapperMethod> methodCache) {
    this.sqlSession = sqlSession;
    this.mapperInterface = mapperInterface;
    this.methodCache = methodCache;
  }

  @Override
  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    try {
      if (Object.class.equals(method.getDeclaringClass())) {
        return method.invoke(this, args);
      } else if (isDefaultMethod(method)) {
        return invokeDefaultMethod(proxy, method, args);
      }
    } catch (Throwable t) {
      throw ExceptionUtil.unwrapThrowable(t);
    }
    final MapperMethod mapperMethod = cachedMapperMethod(method);
    return mapperMethod.execute(sqlSession, args);
  }

  private MapperMethod cachedMapperMethod(Method method) {
    MapperMethod mapperMethod = methodCache.get(method);
    if (mapperMethod == null) {
      mapperMethod = new MapperMethod(mapperInterface, method, sqlSession.getConfiguration());
      methodCache.put(method, mapperMethod);
    }
    return mapperMethod;
  }

  @UsesJava7
  private Object invokeDefaultMethod(Object proxy, Method method, Object[] args)
      throws Throwable {
    final Constructor<MethodHandles.Lookup> constructor = MethodHandles.Lookup.class
        .getDeclaredConstructor(Class.class, int.class);
    if (!constructor.isAccessible()) {
      constructor.setAccessible(true);
    }
    final Class<?> declaringClass = method.getDeclaringClass();
    return constructor
        .newInstance(declaringClass,
            MethodHandles.Lookup.PRIVATE | MethodHandles.Lookup.PROTECTED
                | MethodHandles.Lookup.PACKAGE | MethodHandles.Lookup.PUBLIC)
        .unreflectSpecial(method, declaringClass).bindTo(proxy).invokeWithArguments(args);
  }

  ...
}
```

- **58è¡Œ**ï¼šfinal MapperMethod mapperMethod = cachedMapperMethod(method);ï¼Œä»ç¼“å­˜ä¸­è·å–MapperMethod
- **59è¡Œ**ï¼šmapperMethod.execute(sqlSession, args);ï¼Œæ‰§è¡ŒSQLè¯­å¥ï¼Œå¹¶è¿”å›ç»“æœ(åˆ°è¿™å…³äºæŸ¥è¯¢è·å–ç»“æœå°±åˆ°éª¨å¤´(å¹²)å±‚äº†)ï¼›INSERTã€UPDATEã€DELETEã€SELECT
  
  ```java 
  public Object execute(SqlSession sqlSession, Object[] args) {
    Object result;
    switch (command.getType()) {
      case INSERT: {
      Object param = method.convertArgsToSqlCommandParam(args);
        result = rowCountResult(sqlSession.insert(command.getName(), param));
        break;
      }
      case UPDATE: {
        Object param = method.convertArgsToSqlCommandParam(args);
        result = rowCountResult(sqlSession.update(command.getName(), param));
        break;
      }
      case DELETE: {
        Object param = method.convertArgsToSqlCommandParam(args);
        result = rowCountResult(sqlSession.delete(command.getName(), param));
        break;
      }
      case SELECT:
        if (method.returnsVoid() && method.hasResultHandler()) {
          executeWithResultHandler(sqlSession, args);
          result = null;
        } else if (method.returnsMany()) {
          result = executeForMany(sqlSession, args);
        } else if (method.returnsMap()) {
          result = executeForMap(sqlSession, args);
        } else if (method.returnsCursor()) {
          result = executeForCursor(sqlSession, args);
        } else {
          Object param = method.convertArgsToSqlCommandParam(args);
          result = sqlSession.selectOne(command.getName(), param);
        }
        break;
      case FLUSH:
        result = sqlSession.flushStatements();
        break;
      default:
        throw new BindingException("Unknown execution method for: " + command.getName());
    }
    if (result == null && method.getReturnType().isPrimitive() && !method.returnsVoid()) {
      throw new BindingException("Mapper method '" + command.getName() 
          + " attempted to return null from a method with a primitive return type (" + method.getReturnType() + ").");
    }
    return result;
  }
  ```

ä»¥ä¸Šå¯¹äºMapperScannerConfigurerè¿™ä¸€å±‚å°±åˆ†æå®Œäº†ï¼Œä»æ‰«æå®šä¹‰æ³¨å…¥åˆ°ä¸ºSpringå®¹å™¨å‡†å¤‡Beançš„ä¿¡æ¯ï¼Œä»£ç†ã€åå°„ã€SQLæ‰§è¡Œï¼ŒåŸºæœ¬å°±åŒ…æ‹¬å…¨éƒ¨æ ¸å¿ƒå†…å®¹äº†ï¼Œæ¥ä¸‹æ¥åœ¨åˆ†æä¸‹SqlSessionFactoryBean

### 3. SqlSessionå®¹å™¨å·¥å‚åˆå§‹åŒ–(SqlSessionFactoryBean)

SqlSessionFactoryBeanåˆå§‹åŒ–è¿‡ç¨‹ä¸­éœ€è¦å¯¹ä¸€äº›è‡ªèº«å†…å®¹è¿›è¡Œå¤„ç†ï¼Œå› æ­¤ä¹Ÿéœ€è¦å®ç°å¦‚ä¸‹æ¥å£ï¼›
- `FactoryBean<SqlSessionFactory>`
- `InitializingBean -> void afterPropertiesSet() throws Exception`
- `ApplicationListener<ApplicationEvent>`

![å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ & SqlSessionFactoryBeanåˆå§‹åŒ–æµç¨‹](https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-06.png)

ä»¥ä¸Šçš„æµç¨‹å…¶å®å·²ç»å¾ˆæ¸…æ™°çš„æè¿°æ•´ä¸ªæ ¸å¿ƒæµç¨‹ï¼Œä½†åŒæ ·å¯¹äºæ–°æ‰‹ä¸Šè·¯ä¼šæœ‰éšœç¢ï¼Œé‚£ä¹ˆï¼å¥½ï¼Œç»§ç»­ï¼

>SqlSessionFactoryBean.java & éƒ¨åˆ†æˆªå–

```java 
public void afterPropertiesSet() throws Exception {
  notNull(dataSource, "Property 'dataSource' is required");
  notNull(sqlSessionFactoryBuilder, "Property 'sqlSessionFactoryBuilder' is required");
  state((configuration == null && configLocation == null) || !(configuration != null && configLocation != null),
            "Property 'configuration' and 'configLocation' can not specified with together");
  this.sqlSessionFactory = buildSqlSessionFactory();
}
```  

- afterPropertiesSet()ï¼ŒInitializingBeanæ¥å£ä¸ºbeanæä¾›äº†åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒåªåŒ…æ‹¬afterPropertiesSetæ–¹æ³•ï¼Œå‡¡æ˜¯ç»§æ‰¿è¯¥æ¥å£çš„ç±»ï¼Œåœ¨åˆå§‹åŒ–beançš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ã€‚
- **380è¡Œ**ï¼šbuildSqlSessionFactory();å†…éƒ¨æ–¹æ³•æ„å»ºï¼Œæ ¸å¿ƒåŠŸèƒ½ç»§ç»­å¾€ä¸‹çœ‹ã€‚

>SqlSessionFactoryBean.java & éƒ¨åˆ†æˆªå–

```java 
protected SqlSessionFactory buildSqlSessionFactory() throws IOException {
  Configuration configuration;
  XMLConfigBuilder xmlConfigBuilder = null;
  
  ...

  if (!isEmpty(this.mapperLocations)) {
    for (Resource mapperLocation : this.mapperLocations) {
      if (mapperLocation == null) {
        continue;
      }
      try {
        XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),
            configuration, mapperLocation.toString(), configuration.getSqlFragments());
        xmlMapperBuilder.parse();
      } catch (Exception e) {
        throw new NestedIOException("Failed to parse mapping resource: '" + mapperLocation + "'", e);
      } finally {
        ErrorContext.instance().reset();
      }
      if (LOGGER.isDebugEnabled()) {
        LOGGER.debug("Parsed mapper file: '" + mapperLocation + "'");
      }
    }
  } else {
    if (LOGGER.isDebugEnabled()) {
      LOGGER.debug("Property 'mapperLocations' was not specified or no matching resources found");
    }
  }
  return this.sqlSessionFactoryBuilder.build(configuration);
}

```

- **513è¡Œ**ï¼šfor (Resource mapperLocation : this.mapperLocations)  å¾ªç¯è§£æMapperå†…å®¹
- **519è¡Œ**ï¼šXMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(...) è§£æXMLMapperBuilder
- **521è¡Œ**ï¼šxmlMapperBuilder.parse() æ‰§è¡Œè§£æï¼Œå…·ä½“å¦‚ä¸‹ï¼›

>XMLMapperBuilder.java & éƒ¨åˆ†æˆªå–

```java 
public class XMLMapperBuilder extends BaseBuilder {
   private final XPathParser parser;
   private final MapperBuilderAssistant builderAssistant;
   private final Map<String, XNode> sqlFragments;
   private final String resource;

   private void bindMapperForNamespace() {
     String namespace = builderAssistant.getCurrentNamespace();
     if (namespace != null) {
       Class<?> boundType = null;
       try {
         boundType = Resources.classForName(namespace);
       } catch (ClassNotFoundException e) {
         //ignore, bound type is not required
       }
       if (boundType != null) {
         if (!configuration.hasMapper(boundType)) {
           // Spring may not know the real resource name so we set a flag
           // to prevent loading again this resource from the mapper interface
           // look at MapperAnnotationBuilder#loadXmlResource
           configuration.addLoadedResource("namespace:" + namespace);
           configuration.addMapper(boundType);
         }
       }
     }
   }
}
```   

- è¿™é‡Œ**413è¡Œ**éå¸¸é‡è¦ï¼Œconfiguration.addMapper(boundType);ï¼ŒçœŸæ­£åˆ°äº†æ·»åŠ Mapperåˆ°é…ç½®ä¸­å¿ƒ

>MapperRegistry.java & éƒ¨åˆ†æˆªå–

```java 
public class MapperRegistry {

  public <T> void addMapper(Class<T> type) {
    if (type.isInterface()) {
      if (hasMapper(type)) {
        throw new BindingException("Type " + type + " is already known to the MapperRegistry.");
      }
      boolean loadCompleted = false;
      try {
        knownMappers.put(type, new MapperProxyFactory<T>(type));
        // It's important that the type is added before the parser is run
        // otherwise the binding may automatically be attempted by the
        // mapper parser. If the type is already known, it won't try.
        MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type);
        parser.parse();
        loadCompleted = true;
      } finally {
        if (!loadCompleted) {
          knownMappers.remove(type);
        }
      }
    }
  }
  
}
```

- **67è¡Œ**ï¼šåˆ›å»ºä»£ç†å·¥ç¨‹ `knownMappers.put(type, new MapperProxyFactory<T>(type));`

æˆªè‡³åˆ°è¿™ï¼ŒMapperScannerConfigurerã€SqlSessionFactoryBeanï¼Œä¸¤ä¸ªç±»å¹²çš„äº‹æƒ…å°±ç›¸èåˆäº†ï¼›
- ç¬¬ä¸€ä¸ªç”¨äºæ‰«æDaoæ¥å£è®¾ç½®ä»£ç†ç±»æ³¨å†Œåˆ°IOCä¸­ï¼Œç”¨äºåç»­ç”ŸæˆBeanå®ä½“ç±»ï¼ŒMapperFactoryBeanï¼Œå¹¶å¯ä»¥é€šè¿‡mapperInterfaceä»Configurationè·å–Mapper
- å¦ä¸€ä¸ªç”¨äºç”ŸæˆSqlSessionå·¥å‚åˆå§‹åŒ–ï¼Œè§£æMapperé‡Œçš„XMLé…ç½®è¿›è¡ŒåŠ¨æ€ä»£ç†MapperProxyFactory->MapperProxyæ³¨å…¥åˆ°Configurationçš„Mapper
- æœ€ç»ˆåœ¨æ³¨è§£ç±»çš„å¸®åŠ©ä¸‹è¿›è¡Œæ–¹æ³•æ³¨å…¥ï¼Œç­‰æ‰§è¡Œæ“ä½œæ—¶å€™å³å¯è·å¾—åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„CRUDæ“ä½œ 
  
  ```java 
  @Resource
  private ISchoolDao schoolDao;
  
  schoolDao.querySchoolInfoById(1L);
  ```

## å…­ã€ç»¼ä¸Šæ€»ç»“
- åˆ†æè¿‡ç¨‹è¾ƒé•¿ç¯‡å¹…ä¹Ÿå¾ˆå¤§ï¼Œä¸ä¸€å®šä¸€å¤©å°±èƒ½çœ‹æ‡‚æ•´ä¸ªæµç¨‹ï¼Œä½†å½“è€ä¸‹å¿ƒæ¥ä¸€ç‚¹ç‚¹ç ”ç©¶ï¼Œè¿˜æ˜¯å¯ä»¥è·å¾—å¾ˆå¤šçš„æ”¶è·çš„ã€‚ä»¥ååœ¨é‡åˆ°è¿™ç±»çš„å¼‚å¸¸å°±å¯ä»¥è¿åˆƒè€Œè§£äº†ï¼ŒåŒæ—¶ä¹Ÿæœ‰åŠ©äºé¢è¯•ã€æ‹›è˜ï¼
- ä¹‹æ‰€ä»¥åˆ†æMybatisæœ€å¼€å§‹æ˜¯æƒ³åœ¨Daoä¸ŠåŠ è‡ªå®šä¹‰æ³¨è§£ï¼Œå‘ç°åˆ‡é¢æ‹¦æˆªä¸åˆ°ã€‚æƒ³åˆ°è¿™æ˜¯è¢«åŠ¨æ€ä»£ç†çš„ç±»ï¼Œä¹‹åå±‚å±‚å¾€å¾€ä¸‹æ‰’ç›´åˆ°MapperProxy.invokeï¼å½“ç„¶ï¼ŒMybatisæä¾›äº†è‡ªå®šä¹‰æ’ä»¶å¼€å‘ã€‚
- ä»¥ä¸Šçš„æºç åˆ†æåªæ˜¯å¯¹éƒ¨åˆ†æ ¸å¿ƒå†…å®¹è¿›è¡Œåˆ†æï¼Œå¦‚æœå¸Œæœ›äº†è§£å…¨éƒ¨å¯ä»¥å‚è€ƒèµ„æ–™ï¼›MyBatis 3æºç æ·±åº¦è§£æï¼Œå¹¶è°ƒè¯•ä»£ç ã€‚IDEAä¸­è¿˜æ˜¯å¾ˆæ–¹ä¾¿çœ‹æºç çš„ï¼ŒåŒ…æ‹¬å¯ä»¥æŸ¥çœ‹ç±»å›¾ã€è°ƒç”¨é¡ºåºç­‰ã€‚
- mybatisã€mybatis-springä¸­å…¶å®æœ€é‡è¦çš„æ˜¯å°†Mapperé…ç½®æ–‡ä»¶è§£æä¸æ¥å£ç±»ç»„è£…æˆä»£ç†ç±»è¿›è¡Œæ˜ å°„ï¼Œä»¥æ­¤æ¥æ–¹ä¾¿å¯¹æ•°æ®åº“çš„CRUDæ“ä½œã€‚ä»æºç åˆ†æåï¼Œå¯ä»¥è·å¾—æ›´å¤šçš„ç¼–ç¨‹ç»éªŒ(å¥—è·¯)ã€‚
- Mybatisç›¸å…³é“¾æ¥ï¼›
  - [https://github.com/mybatis/mybatis-3](https://github.com/mybatis/mybatis-3)
  - [https://mybatis.org/mybatis-3/zh/index.html](https://mybatis.org/mybatis-3/zh/index.html)