---
layout: post
category: framework
title: è°ƒç ”å­—èŠ‚ç æ’æ¡©æŠ€æœ¯ï¼Œç”¨äºç³»ç»Ÿç›‘æ§è®¾è®¡å’Œå®ç°
tagline: by å°å‚…å“¥
tag: [java,framework]
excerpt: å’‹æ»´ï¼Œä½ é‚£ä¸Šçº¿çš„ç³»ç»Ÿæ˜¯è£¸å¥”å‘¢ï¼Ÿä¸€å¥—çº¿ä¸Šç³»ç»Ÿæ˜¯å¦ç¨³å®šè¿è¡Œï¼Œå–å†³äºå®ƒçš„è¿è¡Œå¥åº·åº¦ï¼Œè€Œè¿™åŒ…æ‹¬ï¼›è°ƒç”¨é‡ã€å¯ç”¨ç‡ã€å½±å“æ—¶é•¿ä»¥åŠæœåŠ¡å™¨æ€§èƒ½ç­‰å„é¡¹æŒ‡æ ‡çš„ä¸€ä¸ªç»¼åˆå€¼ã€‚å¹¶ä¸”åœ¨ç³»ç»Ÿå‡ºç°å¼‚å¸¸é—®é¢˜æ—¶ï¼Œå¯ä»¥æŠ“å–æ•´ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œé“¾è·¯å¹¶è¾“å‡ºï¼›å½“æ—¶çš„å…¥å‚ã€å‡ºå‚ã€å¼‚å¸¸ä¿¡æ¯ç­‰ç­‰ã€‚å½“ç„¶è¿˜åŒ…æ‹¬ä¸€äº›JVMã€Redisã€Mysqlçš„å„é¡¹æ€§èƒ½æŒ‡æ ‡ï¼Œä»¥ç”¨äºå¿«é€Ÿå®šä½å¹¶è§£å†³é—®é¢˜ã€‚
lock: need
---

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/9g7O3MSxh5q3F6z-Mxalzg](https://mp.weixin.qq.com/s/9g7O3MSxh5q3F6z-Mxalzg)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€æ¥è‡ªæ·±å¤œçš„ç”µè¯ï¼

`å’‹æ»´ï¼Œä½ é‚£ä¸Šçº¿çš„ç³»ç»Ÿæ˜¯è£¸å¥”å‘¢ï¼Ÿ`

![](https://bugstack.cn/assets/images/framework/framework-6-1.png)

å‘¨æœ«ç†Ÿç¡çš„æ·±å¤œï¼Œçªç„¶æ¥åˆ°è€æ¿ç”µè¯â˜çš„å‚¬ä¿ƒã€‚â€œèµ¶ç´§çœ‹å¾®ä¿¡ã€çœ‹å¾®ä¿¡ï¼Œå’‹ç³»ç»Ÿå‡ºé—®é¢˜äº†ï¼Œæˆ‘ä»¬éƒ½ä¸çŸ¥é“ï¼Œè¿˜å¾—ç”¨æˆ·åé¦ˆæ‰çŸ¥é“çš„ï¼ï¼ï¼â€æ·±å¤œçˆ¬èµ·æ¥ï¼Œæ‰“å¼€ç”µè„‘è¿ä¸Š VPN ï¼Œæ‰“ç€å“ˆæ¬ ã€çå¼€æœ¦èƒ§çš„çœ¼ç›ï¼ŒæŸ¥æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼ŒåŸæ¥æ˜¯ç³»ç»ŸæŒ‚äº†ï¼Œèµ¶ç´§é‡å¯æ¢å¤ï¼

è™½ç„¶é‡å¯æ¢å¤äº†ç³»ç»Ÿï¼Œä¹Ÿé‡ç½®äº†è€æ¿æ‰­æ›²çš„è¡¨æƒ…ã€‚ä½†ç³»ç»Ÿæ˜¯æ€ä¹ˆæŒ‚çš„å‘¢ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œä¹Ÿä¸çŸ¥é“æ˜¯æµé‡å¤ªå¤§å¯¼è‡´ï¼Œè¿˜æ˜¯å› ä¸ºç¨‹åºé—®é¢˜å¼•èµ·ï¼Œé€šè¿‡ä¸€ç‰‡ç‰‡çš„æ—¥å¿—ï¼Œä¹Ÿä»…èƒ½ç²—ç•¥ä¼°è®¡å‡ºä¸€äº›æ‰“ç€`å¥½åƒçš„æ ‡ç­¾`ç»™è€æ¿æ±‡æŠ¥ã€‚ä¸è¿‡è€æ¿*ä¹Ÿä¸å‚»*ï¼ŒèŠæ¥èŠå»ï¼Œè®©æŠŠæ‰€æœ‰çš„ç³»ç»Ÿè¿è¡ŒçŠ¶å†µéƒ½ç›‘æ§å‡ºæ¥ã€‚

åŒæ‰‹æ‹–ç€å›°å€¦çš„è„‘è¢‹ï¼Œä¸€æ—¶åŠä¼šä¹Ÿæƒ³ä¸å‡ºä»€ä¹ˆå¥½æ–¹æ³•ï¼Œ**éš¾é“åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šéƒ½ç¡¬ç¼–ç ä¸Šæ‰§è¡Œè€—æ—¶è®¡ç®—**ã€‚ä¹‹åæŠŠä¿¡æ¯åœ¨ç»Ÿä¸€æ”¶é›†èµ·æ¥ï¼Œå±•ç¤ºåˆ°ä¸€ä¸ªç›‘æ§é¡µé¢å‘¢ï¼Œç›‘æ§é¡µé¢ä½¿ç”¨é˜¿å¸•å¥‡çš„ [echarts](https://echarts.apache.org/zh/index.html)ï¼Œåˆ«è¯´è¦æ˜¯è¿™æ ·æ˜¾ç¤ºäº†ï¼Œè¿˜çœŸèƒ½æŒºå¥½çœ‹è¿˜å¥½ç”¨ã€‚

![](https://bugstack.cn/assets/images/framework/framework-6-2.png)

- ä½†è¿™ä¹ˆç¡¬ç¼–ç ä¹Ÿä¸å«ç©æ„å‘€ï¼Œè¿™ä¸æŠŠæˆ‘ä»¬éƒ¨é—¨æ¬ç –çš„ç å†œç´¯å²”æ°”å‘€ï¼å†è¯´äº†ï¼Œè¿™ä¹ˆå¹²ä»–ä»¬è‚¯å®šç§ä¸èµ·æˆ‘ã€‚*å•¥æ¶æ„å¸ˆï¼Œè¦ç›‘æ§ç³»ç»Ÿï¼Œè¿˜å¾—ç¡¬ç¼–ç ï¼Œå‚»äº†ä¸æ˜¯ï¼ï¼ï¼*
- è¿™ä¹ˆä¸€æƒ³æ•´çš„æ²¡æ³•ç¡è§‰ï¼Œå¾—æ‰¾æ‰¾èµ„æ–™ï¼Œæ˜å¤©ç»™è€æ¿æ±‡æŠ¥ï¼

---

å…¶å®ä¸€å¥—çº¿ä¸Šç³»ç»Ÿæ˜¯å¦ç¨³å®šè¿è¡Œï¼Œå–å†³äºå®ƒçš„è¿è¡Œå¥åº·åº¦ï¼Œè€Œè¿™åŒ…æ‹¬ï¼›è°ƒç”¨é‡ã€å¯ç”¨ç‡ã€å½±å“æ—¶é•¿ä»¥åŠæœåŠ¡å™¨æ€§èƒ½ç­‰å„é¡¹æŒ‡æ ‡çš„ä¸€ä¸ªç»¼åˆå€¼ã€‚å¹¶ä¸”åœ¨ç³»ç»Ÿå‡ºç°å¼‚å¸¸é—®é¢˜æ—¶ï¼Œå¯ä»¥æŠ“å–æ•´ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œé“¾è·¯å¹¶è¾“å‡ºï¼›å½“æ—¶çš„å…¥å‚ã€å‡ºå‚ã€å¼‚å¸¸ä¿¡æ¯ç­‰ç­‰ã€‚å½“ç„¶è¿˜åŒ…æ‹¬ä¸€äº›JVMã€Redisã€Mysqlçš„å„é¡¹æ€§èƒ½æŒ‡æ ‡ï¼Œä»¥ç”¨äºå¿«é€Ÿå®šä½å¹¶è§£å†³é—®é¢˜ã€‚

é‚£ä¹ˆè¦åšåˆ°è¿™æ ·çš„äº‹æƒ…æœ‰ä»€ä¹ˆå¤„ç†æ–¹æ¡ˆå‘¢ï¼Œå…¶å®åšæ³•è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæ¯”å¦‚ï¼›

1. æœ€ç®€å•ç²—æš´çš„å°±æ˜¯ç¡¬ç¼–ç åœ¨æ–¹æ³•ä¸­ï¼Œæ”¶å–æ‰§è¡Œè€—æ—¶ä»¥åŠå‡ºå…¥å‚å’Œå¼‚å¸¸ä¿¡æ¯ã€‚ä½†è¿™æ ·çš„ç¼–ç æˆæœ¬å®åœ¨å¤ªå¤§ï¼Œè€Œä¸”ç¡¬ç¼–ç å®Œè¿˜éœ€è¦å¤§é‡å›å½’æµ‹è¯•ï¼Œå¯èƒ½ç»™ç³»ç»Ÿå¸¦æ¥ä¸€å®šçš„é£é™©ã€‚*ä¸‡ä¸€è°æ‰‹æŠ–ç»™å¤åˆ¶ç²˜è´´é”™äº†å‘¢ï¼*
2. å¯ä»¥é€‰æ‹©åˆ‡é¢æ–¹å¼åšä¸€å¥—ç»Ÿä¸€ç›‘æ§çš„ç»„ä»¶ï¼Œç›¸å¯¹æ¥è¯´è¿˜æ˜¯å¥½ä¸€äº›çš„ã€‚ä½†ä¹Ÿéœ€è¦ç¡¬ç¼–ç ï¼Œæ¯”å¦‚å†™å…¥æ³¨è§£ï¼ŒåŒæ—¶ç»´æŠ¤æˆæœ¬ä¹Ÿä¸ä½ã€‚
3. å…¶å®å¸‚é¢ä¸Šå¯¹äºè¿™æ ·çš„ç›‘æ§å…¶å®æ˜¯æœ‰æ•´å¥—çš„éå…¥ä¾µç›‘æ§æ–¹æ¡ˆçš„ï¼Œæ¯”å¦‚ï¼›Google Dapperã€Zipkinç­‰éƒ½å¯ä»¥å®ç°ç›‘æ§ç³»ç»Ÿéœ€æ±‚ï¼Œä»–ä»¬éƒ½æ˜¯åŸºäºæ¢é’ˆæŠ€æœ¯éå…¥ä¾µçš„é‡‡ç”¨å­—èŠ‚ç å¢å¼ºçš„æ–¹å¼é‡‡é›†ç³»ç»Ÿè¿è¡Œä¿¡æ¯è¿›è¡Œåˆ†æå’Œç›‘æ§è¿è¡ŒçŠ¶æ€ã€‚

å¥½ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±æ¥å¸¦ç€å¤§å®¶æ¥å°è¯•ä¸‹å‡ ç§ä¸åŒæ–¹å¼ï¼Œç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„å®ç°æ€è·¯ã€‚

## äºŒã€å‡†å¤‡å·¥ä½œ

æœ¬æ–‡ä¼šåŸºäº `AOP`ã€å­—èŠ‚ç æ¡†æ¶(`ASM`ã€`Javassist`ã€`Byte-Buddy`)ï¼Œåˆ†åˆ«å®ç°ä¸åŒçš„ç›‘æ§å®ç°ä»£ç ã€‚æ•´ä¸ªå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š

```java
MonitorDesign
â”œâ”€â”€ cn-bugstack-middleware-aop
â”œâ”€â”€ cn-bugstack-middleware-asm
â”œâ”€â”€ cn-bugstack-middleware-bytebuddy
â”œâ”€â”€ cn-bugstack-middleware-javassist
â”œâ”€â”€ cn-bugstack-middleware-test
â””â”€â”€	pom.xml
```

- æºç åœ°å€ï¼š[https://github.com/fuzhengwei/MonitorDesign](https://github.com/fuzhengwei/MonitorDesign)
- ç®€å•ä»‹ç»ï¼šaopã€asmã€bytebuddyã€javassistï¼Œåˆ†åˆ«æ˜¯å››ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚test æ˜¯ä¸€ä¸ªåŸºäº SpringBoot çš„ç®€å•æµ‹è¯•å·¥ç¨‹ã€‚
- æŠ€æœ¯ä½¿ç”¨ï¼šSpringBootã€asmã€byte-buddyã€javassist

**cn-bugstack-middleware-test**

```java
@RestController
public class UserController {

    private Logger logger = LoggerFactory.getLogger(UserController.class);

    /**
     * æµ‹è¯•ï¼šhttp://localhost:8081/api/queryUserInfo?userId=aaa
     */
    @RequestMapping(path = "/api/queryUserInfo", method = RequestMethod.GET)
    public UserInfo queryUserInfo(@RequestParam String userId) {
        logger.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}", userId);
        return new UserInfo("è™«è™«:" + userId, 19, "å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000");
    }

}
```

- æ¥ä¸‹æ¥çš„å„ç±»ç›‘æ§ä»£ç å®ç°ï¼Œéƒ½ä¼šä»¥ç›‘æ§ `UserController#queryUserInfo` çš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ä¸ºä¸»ï¼Œçœ‹çœ‹å„ç±»æŠ€æœ¯éƒ½æ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚

## ä¸‰ã€ä½¿ç”¨ AOP åšä¸ªåˆ‡é¢ç›‘æ§

### 1. å·¥ç¨‹ç»“æ„

```java
cn-bugstack-middleware-aop
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â”œâ”€â”€ cn.bugstack.middleware.monitor
    â”‚       â”‚   â”œâ”€â”€ annotation
    â”‚       â”‚   â”‚   â””â”€â”€ DoMonitor.java
    â”‚       â”‚   â”œâ”€â”€ config
    â”‚       â”‚   â”‚   â””â”€â”€ MonitorAutoConfigure.java
    â”‚       â”‚   â””â”€â”€ DoJoinPoint.java
    â”‚       â””â”€â”€ resources
    â”‚           â””â”€â”€ META-INF 
    â”‚               â””â”€â”€ spring.factories
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.middleware.monitor.test
                â””â”€â”€ ApiTest.java
```

åŸºäº AOP å®ç°çš„ç›‘æ§ç³»ç»Ÿï¼Œæ ¸å¿ƒé€»è¾‘çš„ä»¥ä¸Šå·¥ç¨‹å¹¶ä¸å¤æ‚ï¼Œå…¶æ ¸å¿ƒç‚¹åœ¨äºå¯¹åˆ‡é¢çš„ç†è§£å’Œè¿ç”¨ï¼Œä»¥åŠä¸€äº›é…ç½®é¡¹éœ€è¦æŒ‰ç…§ SpringBoot ä¸­çš„å®ç°æ–¹å¼è¿›è¡Œå¼€å‘ã€‚

- DoMonitorï¼Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ã€‚å®ƒä½œç”¨å°±æ˜¯åœ¨éœ€è¦ä½¿ç”¨åˆ°çš„æ–¹æ³•ç›‘æ§æ¥å£ä¸Šï¼Œæ·»åŠ æ­¤æ³¨è§£å¹¶é…ç½®å¿…è¦çš„ä¿¡æ¯ã€‚
- MonitorAutoConfigureï¼Œé…ç½®ä¸‹æ˜¯å¯ä»¥å¯¹ SpringBoot yml æ–‡ä»¶çš„ä½¿ç”¨ï¼Œå¯ä»¥å¤„ç†ä¸€äº› Bean çš„åˆå§‹åŒ–æ“ä½œã€‚
- DoJoinPointï¼Œæ˜¯æ•´ä¸ªä¸­é—´ä»¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£å¯¹æ‰€æœ‰æ·»åŠ è‡ªå®šä¹‰æ³¨è§£çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆªå’Œé€»è¾‘å¤„ç†ã€‚

### 2. å®šä¹‰ç›‘æ§æ³¨è§£

**cn.bugstack.middleware.monitor.annotation.DoMonitor**

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface DoMonitor {

   String key() default "";
   String desc() default "";

}
```

- @Retention(RetentionPolicy.RUNTIME)ï¼Œ`Annotations are to be recorded in the class file by the compiler and retained by the VM at run time, so they may be read reflectively.`
- @Retention æ˜¯æ³¨è§£çš„æ³¨è§£ï¼Œä¹Ÿç§°ä½œå…ƒæ³¨è§£ã€‚è¿™ä¸ªæ³¨è§£é‡Œé¢æœ‰ä¸€ä¸ªå…¥å‚ä¿¡æ¯ `RetentionPolicy.RUNTIME` åœ¨å®ƒçš„æ³¨é‡Šä¸­æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š`Annotations are to be recorded in the class file by the compiler and retained by the VM at run time, so they may be read reflectively.` å…¶å®è¯´çš„å°±æ˜¯åŠ äº†è¿™ä¸ªæ³¨è§£ï¼Œå®ƒçš„ä¿¡æ¯ä¼šè¢«å¸¦åˆ°JVMè¿è¡Œæ—¶ï¼Œå½“ä½ åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°æ³¨è§£ä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRetentionPolicy è¿˜æœ‰ä¸¤ä¸ªå±æ€§ `SOURCE`ã€`CLASS`ï¼Œå…¶å®è¿™ä¸‰ä¸ªæšä¸¾æ­£å¼å¯¹åº”äº†Javaä»£ç çš„åŠ è½½å’Œè¿è¡Œé¡ºåºï¼ŒJavaæºç æ–‡ä»¶ -> .classæ–‡ä»¶ -> å†…å­˜å­—èŠ‚ç ã€‚å¹¶ä¸”åè€…èŒƒå›´å¤§äºå‰è€…ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦ä½¿ç”¨ RetentionPolicy.RUNTIME å³å¯ã€‚
- @Target ä¹Ÿæ˜¯å…ƒæ³¨è§£èµ·åˆ°æ ‡è®°ä½œç”¨ï¼Œå®ƒçš„æ³¨è§£åç§°å°±æ˜¯å®ƒçš„å«ä¹‰ï¼Œ**ç›®æ ‡**ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™ä¸ªè‡ªå®šä¹‰æ³¨è§£ DoWhiteList è¦æ”¾åœ¨ç±»ã€æ¥å£è¿˜æ˜¯æ–¹æ³•ä¸Šã€‚*åœ¨ JDK1.8 ä¸­ ElementType ä¸€å…±æä¾›äº†10ä¸­ç›®æ ‡æšä¸¾ï¼ŒTYPEã€FIELDã€METHODã€PARAMETERã€CONSTRUCTORã€LOCAL_VARIABLEã€ANNOTATION_TYPEã€PACKAGEã€TYPE_PARAMETERã€TYPE_USEï¼Œå¯ä»¥å‚è€ƒè‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£ä½œç”¨åŸŸè¿›è¡Œè®¾ç½®*
- è‡ªå®šä¹‰æ³¨è§£ @DoMonitor æä¾›äº†ç›‘æ§çš„ key å’Œ descæè¿°ï¼Œè¿™ä¸ªä¸»è¦è®°å½•ä½ ç›‘æ§æ–¹æ³•çš„ä¸ºå”¯ä¸€å€¼é…ç½®å’Œå¯¹ç›‘æ§æ–¹æ³•çš„æ–‡å­—æè¿°ã€‚

### 3. å®šä¹‰åˆ‡é¢æ‹¦æˆª

**cn.bugstack.middleware.monitor.DoJoinPoint**

```java
@Aspect
public class DoJoinPoint {

    @Pointcut("@annotation(cn.bugstack.middleware.monitor.annotation.DoMonitor)")
    public void aopPoint() {
    }

    @Around("aopPoint() && @annotation(doMonitor)")
    public Object doRouter(ProceedingJoinPoint jp, DoMonitor doMonitor) throws Throwable {
        long start = System.currentTimeMillis();
        Method method = getMethod(jp);
        try {
            return jp.proceed();
        } finally {
            System.out.println("ç›‘æ§ - Begin By AOP");
            System.out.println("ç›‘æ§ç´¢å¼•ï¼š" + doMonitor.key());
            System.out.println("ç›‘æ§æè¿°ï¼š" + doMonitor.desc());
            System.out.println("æ–¹æ³•åç§°ï¼š" + method.getName());
            System.out.println("æ–¹æ³•è€—æ—¶ï¼š" + (System.currentTimeMillis() - start) + "ms");
            System.out.println("ç›‘æ§ - End\r\n");
        }
    }

    private Method getMethod(JoinPoint jp) throws NoSuchMethodException {
        Signature sig = jp.getSignature();
        MethodSignature methodSignature = (MethodSignature) sig;
        return jp.getTarget().getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());
    }

}
```

- ä½¿ç”¨æ³¨è§£ @Aspectï¼Œå®šä¹‰åˆ‡é¢ç±»ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„åˆ‡é¢å®šä¹‰æ–¹å¼ã€‚
- `@Pointcut("@annotation(cn.bugstack.middleware.monitor.annotation.DoMonitor)")`ï¼Œå®šä¹‰åˆ‡ç‚¹ã€‚åœ¨ Pointcut ä¸­æä¾›äº†å¾ˆå¤šçš„åˆ‡ç‚¹å¯»æ‰¾æ–¹å¼ï¼Œæœ‰æŒ‡å®šæ–¹æ³•åç§°çš„ã€æœ‰èŒƒå›´ç­›é€‰è¡¨è¾¾å¼çš„ï¼Œä¹Ÿæœ‰æˆ‘ä»¬ç°åœ¨é€šè¿‡è‡ªå®šä¹‰æ³¨è§£æ–¹å¼çš„ã€‚ä¸€èˆ¬åœ¨ä¸­é—´ä»¶å¼€å‘ä¸­ï¼Œè‡ªå®šä¹‰æ³¨è§£æ–¹å¼ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºå®ƒå¯ä»¥æ›´åŠ çµæ´»çš„è¿ç”¨åˆ°å„ä¸ªä¸šåŠ¡ç³»ç»Ÿä¸­ã€‚
- `@Around("aopPoint() && @annotation(doMonitor)")`ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹æ–¹æ³•å¢å¼ºçš„ç»‡å…¥åŠ¨ä½œï¼Œæœ‰äº†è¿™ä¸ªæ³¨è§£çš„æ•ˆæœå°±æ˜¯åœ¨ä½ è°ƒç”¨å·²ç»åŠ äº†è‡ªå®šä¹‰æ³¨è§£ @DoMonitor çš„æ–¹æ³•æ—¶ï¼Œä¼šå…ˆè¿›å…¥åˆ°æ­¤åˆ‡ç‚¹å¢å¼ºçš„æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä½ å¯ä»¥åšä¸€äº›å¯¹æ–¹æ³•çš„æ“ä½œåŠ¨ä½œäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åšä¸€äº›æ–¹æ³•ç›‘æ§å’Œæ—¥å¿—æ‰“å°ç­‰ã€‚
- æœ€ååœ¨ `doRouter` æ–¹æ³•ä½“ä¸­è·å–æŠŠæ–¹æ³•æ‰§è¡Œ `jp.proceed();` ä½¿ç”¨ `try finally` åŒ…è£…èµ·æ¥ï¼Œå¹¶æ‰“å°ç›¸å…³çš„ç›‘æ§ä¿¡æ¯ã€‚è¿™äº›ç›‘æ§ä¿¡æ¯çš„è·å–æœ€åéƒ½æ˜¯å¯ä»¥é€šè¿‡å¼‚æ­¥æ¶ˆæ¯çš„æ–¹å¼å‘é€ç»™æœåŠ¡ç«¯ï¼Œå†ç”±æœåŠ¡å™¨è¿›è¡Œå¤„ç†ç›‘æ§æ•°æ®å’Œå¤„ç†å±•ç¤ºåˆ°ç›‘æ§é¡µé¢ã€‚

### 4. åˆå§‹åŒ–åˆ‡é¢ç±»

**cn.bugstack.middleware.monitor.config.MonitorAutoConfigure**

```java
@Configuration
public class MonitorAutoConfigure {

    @Bean
    @ConditionalOnMissingBean
    public DoJoinPoint point(){
        return new DoJoinPoint();
    }

}
```

- @Configurationï¼Œå¯ä»¥ç®—ä½œæ˜¯ä¸€ä¸ªç»„ä»¶æ³¨è§£ï¼Œåœ¨ SpringBoot å¯åŠ¨æ—¶å¯ä»¥è¿›è¡ŒåŠ è½½åˆ›å»ºå‡º Bean æ–‡ä»¶ã€‚*å› ä¸º @Configuration æ³¨è§£æœ‰ä¸€ä¸ª @Component æ³¨è§£*
- MonitorAutoConfigure å¯ä»¥å¤„ç†è‡ªå®šä¹‰åœ¨ yml ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºåˆå§‹åŒ– Bean å¯¹è±¡ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œæˆ‘ä»¬å®ä¾‹åŒ–äº† DoJoinPoint åˆ‡é¢å¯¹è±¡ã€‚

### 5. è¿è¡Œæµ‹è¯•

#### 5.1 å¼•å…¥ POM é…ç½®

```java
<!-- ç›‘æ§æ–¹å¼ï¼šAOP -->
<dependency>
    <groupId>cn.bugstack.middleware</groupId>
    <artifactId>cn-bugstack-middleware-aop</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

#### 5.2 æ–¹æ³•ä¸Šé…ç½®ç›‘æ§æ³¨å†Œ

```java
@DoMonitor(key = "cn.bugstack.middleware.UserController.queryUserInfo", desc = "æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯")
@RequestMapping(path = "/api/queryUserInfo", method = RequestMethod.GET)
public UserInfo queryUserInfo(@RequestParam String userId) {
    logger.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}", userId);
    return new UserInfo("è™«è™«:" + userId, 19, "å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000");
}
```

- åœ¨é€šè¿‡ POM å¼•å…¥è‡ªå·±çš„å¼€å‘çš„ç»„ä»¶åï¼Œå°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„æ³¨è§£ï¼Œæ‹¦æˆªæ–¹æ³•è·å–ç›‘æ§ä¿¡æ¯ã€‚

#### 5.3 æµ‹è¯•ç»“æœ

```java
2021-07-04 23:21:10.710  INFO 19376 --- [nio-8081-exec-1] c.b.m.test.interfaces.UserController     : æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼šaaa
ç›‘æ§ - Begin By AOP
ç›‘æ§ç´¢å¼•ï¼šcn.bugstack.middleware.UserController.queryUserInfo
ç›‘æ§æè¿°ï¼šæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
æ–¹æ³•åç§°ï¼šqueryUserInfo
æ–¹æ³•è€—æ—¶ï¼š6ms
ç›‘æ§ - End
```

- é€šè¿‡å¯åŠ¨ SpringBoot ç¨‹åºï¼Œåœ¨ç½‘é¡µä¸­æ‰“å¼€ URL åœ°å€ï¼š`http://localhost:8081/api/queryUserInfo?userId=aaa`ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æŠŠç›‘æ§ä¿¡æ¯æ‰“å°åˆ°æ§åˆ¶å°äº†ã€‚
- æ­¤ç§é€šè¿‡è‡ªå®šä¹‰æ³¨è§£çš„é…ç½®æ–¹å¼ï¼Œèƒ½è§£å†³ä¸€å®šçš„ç¡¬ç¼–ç å·¥ä½œï¼Œä½†å¦‚æœåœ¨æ–¹æ³•ä¸Šå¤§é‡çš„æ·»åŠ æ³¨è§£ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸€å®šçš„å¼€å‘å·¥ä½œçš„ã€‚

---

**æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»‹ç»å…³äºä½¿ç”¨å­—èŠ‚ç æ’æ¡©éå…¥ä¾µçš„æ–¹å¼è¿›è¡Œç³»ç»Ÿç›‘æ§ï¼Œå…³äºå­—èŠ‚ç æ’æ¡©å¸¸ç”¨çš„æœ‰ä¸‰ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼šASMã€Javassitã€Byte-Buddyï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»å®ƒä»¬æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚**

## å››ã€ASM

>ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½è¢«ç”¨æ¥åŠ¨æ€ç”Ÿæˆç±»æˆ–è€…å¢å¼ºæ—¢æœ‰ç±»çš„åŠŸèƒ½ã€‚ASM å¯ä»¥ç›´æ¥äº§ç”ŸäºŒè¿›åˆ¶ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ Java è™šæ‹Ÿæœºä¹‹å‰åŠ¨æ€æ”¹å˜ç±»è¡Œä¸ºã€‚Java class è¢«å­˜å‚¨åœ¨ä¸¥æ ¼æ ¼å¼å®šä¹‰çš„ .class æ–‡ä»¶é‡Œï¼Œè¿™äº›ç±»æ–‡ä»¶æ‹¥æœ‰è¶³å¤Ÿçš„å…ƒæ•°æ®æ¥è§£æç±»ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼šç±»åç§°ã€æ–¹æ³•ã€å±æ€§ä»¥åŠ Java å­—èŠ‚ç ï¼ˆæŒ‡ä»¤ï¼‰ã€‚ASM ä»ç±»æ–‡ä»¶ä¸­è¯»å…¥ä¿¡æ¯åï¼Œèƒ½å¤Ÿæ”¹å˜ç±»è¡Œä¸ºï¼Œåˆ†æç±»ä¿¡æ¯ï¼Œç”šè‡³èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¦æ±‚ç”Ÿæˆæ–°ç±»ã€‚

### 1. å…ˆæ¥ä¸ªæµ‹è¯•

**cn.bugstack.middleware.monitor.test.ApiTest**

```java
private static byte[] generate() {
    ClassWriter classWriter = new ClassWriter(0);
    // å®šä¹‰å¯¹è±¡å¤´ï¼›ç‰ˆæœ¬å·ã€ä¿®é¥°ç¬¦ã€å…¨ç±»åã€ç­¾åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£
    classWriter.visit(Opcodes.V1_7, Opcodes.ACC_PUBLIC, "cn/bugstack/demo/asm/AsmHelloWorld", null, "java/lang/Object", null);
    // æ·»åŠ æ–¹æ³•ï¼›ä¿®é¥°ç¬¦ã€æ–¹æ³•åã€æè¿°ç¬¦ã€ç­¾åã€å¼‚å¸¸
    MethodVisitor methodVisitor = classWriter.visitMethod(Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC, "main", "([Ljava/lang/String;)V", null, null);
    // æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§
    methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
    // åŠ è½½å¸¸é‡ load constant
    methodVisitor.visitLdcInsn("Hello World ASM!");
    // è°ƒç”¨æ–¹æ³•
    methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);
    // è¿”å›
    methodVisitor.visitInsn(Opcodes.RETURN);
    // è®¾ç½®æ“ä½œæ•°æ ˆçš„æ·±åº¦å’Œå±€éƒ¨å˜é‡çš„å¤§å°
    methodVisitor.visitMaxs(2, 1);
    // æ–¹æ³•ç»“æŸ
    methodVisitor.visitEnd();
    // ç±»å®Œæˆ
    classWriter.visitEnd();
    // ç”Ÿæˆå­—èŠ‚æ•°ç»„
    return classWriter.toByteArray();
}
```

- ä»¥ä¸Šè¿™æ®µä»£ç å°±æ˜¯åŸºäº ASM ç¼–å†™çš„ HelloWorldï¼Œæ•´ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼šå®šä¹‰ä¸€ä¸ªç±»çš„ç”Ÿæˆ ClassWriterã€è®¾å®šç‰ˆæœ¬ã€ä¿®é¥°ç¬¦ã€å…¨ç±»åã€ç­¾åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ï¼Œå…¶å®ä¹Ÿå°±æ˜¯é‚£å¥ï¼›`public class HelloWorld`

- ç±»å‹æè¿°ç¬¦ï¼š

    | Java ç±»å‹  | ç±»å‹æè¿°ç¬¦           |
    | :--------- | :------------------- |
    | boolean    | Z                    |
    | char       | C                    |
    | byte       | B                    |
    | short      | S                    |
    | int        | I                    |
    | float      | F                    |
    | long       | J                    |
    | double     | D                    |
    | Object     | Ljava/lang/Object;   |
    | int[]      | [I                   |
    | Object[][] | [[Ljava/lang/Object; |

- æ–¹æ³•æè¿°ç¬¦ï¼š

    | æºæ–‡ä»¶ä¸­çš„æ–¹æ³•å£°æ˜       | æ–¹æ³•æè¿°ç¬¦              |
    | :----------------------- | :---------------------- |
    | void m(int i, float f)   | (IF)V                   |
    | int m(Object o)          | (Ljava/lang/Object;)I   |
    | int[] m(int i, String s) | (ILjava/lang/String;)[I |
    | Object m(int[] i)        | ([I)Ljava/lang/Object;  |

- æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§ã€‚ä¸»è¦æ˜¯è·å¾— System.out
- åŠ è½½å¸¸é‡ load constantï¼Œè¾“å‡ºæˆ‘ä»¬çš„HelloWorld `methodVisitor.visitLdcInsn("Hello World");`
- æœ€åæ˜¯è°ƒç”¨è¾“å‡ºæ–¹æ³•å¹¶è®¾ç½®ç©ºè¿”å›ï¼ŒåŒæ—¶åœ¨ç»“å°¾è¦è®¾ç½®æ“ä½œæ•°æ ˆçš„æ·±åº¦å’Œå±€éƒ¨å˜é‡çš„å¤§å°ã€‚
- è¿™æ ·è¾“å‡ºä¸€ä¸ª `HelloWorld` æ˜¯ä¸è¿˜æ˜¯è›®æœ‰æ„æ€çš„ï¼Œè™½ç„¶ä½ å¯èƒ½è§‰å¾—è¿™ç¼–ç èµ·æ¥å®åœ¨å¤ªéš¾äº†å§ï¼Œä¹Ÿéå¸¸éš¾ç†è§£ã€‚ä¸è¿‡ä½ å¯ä»¥å®‰è£…ä¸€ä¸ª ASM åœ¨ IDEA ä¸­çš„æ’ä»¶ ASM Bytecode Outlineï¼Œèƒ½æ›´åŠ æ–¹ä¾¿çš„æŸ¥çœ‹ä¸€ä¸ªæ™®é€šçš„ä»£ç åœ¨ä½¿ç”¨ ASM çš„æ–¹å¼è¯¥å¦‚ä½•å¤„ç†ã€‚
- å¦å¤–ä»¥ä¸Šè¿™æ®µä»£ç çš„æµ‹è¯•ç»“æœï¼Œä¸»è¦æ˜¯ç”Ÿæˆä¸€ä¸ª class æ–‡ä»¶å’Œè¾“å‡º `Hello World ASM!` ç»“æœã€‚

### 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„

```java
cn-bugstack-middleware-asm
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn.bugstack.middleware.monitor
    â”‚   â”‚       â”œâ”€â”€ config
    â”‚   â”‚       â”‚   â”œâ”€â”€ MethodInfo.java
    â”‚   â”‚       â”‚   â””â”€â”€ ProfilingFilter.java
    â”‚   â”‚       â”œâ”€â”€ probe
    â”‚   â”‚       â”‚   â”œâ”€â”€ ProfilingAspect.java
    â”‚   â”‚       â”‚   â”œâ”€â”€ ProfilingClassAdapter.java
    â”‚   â”‚       â”‚   â”œâ”€â”€ ProfilingMethodVisitor.java
    â”‚   â”‚       â”‚   â””â”€â”€ ProfilingTransformer.java
    â”‚   â”‚       â””â”€â”€ PreMain.java
    â”‚   â””â”€â”€ resources	
    â”‚       â””â”€â”€ META_INF
    â”‚           â””â”€â”€ MANIFEST.MF
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.middleware.monitor.test
                â””â”€â”€ ApiTest.java
```

ä»¥ä¸Šå·¥ç¨‹ç»“æ„æ˜¯ä½¿ç”¨ ASM æ¡†æ¶ç»™ç³»ç»Ÿæ–¹æ³•åšå¢å¼ºæ“ä½œï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºé€šè¿‡æ¡†æ¶å®Œæˆç¡¬ç¼–ç å†™å…¥æ–¹æ³•å‰åçš„ç›‘æ§ä¿¡æ¯ã€‚ä¸è¿‡è¿™ä¸ªè¿‡ç¨‹è½¬ç§»åˆ°äº† Java ç¨‹åºå¯åŠ¨æ—¶åœ¨ Javaagent#premain è¿›è¡Œå¤„ç†ã€‚
- MethodInfo æ˜¯æ–¹æ³•çš„å®šä¹‰ï¼Œä¸»è¦æ˜¯æè¿°ç±»åã€æ–¹æ³•åã€æè¿°ã€å…¥å‚ã€å‡ºå‚ä¿¡æ¯ã€‚
- ProfilingFilter æ˜¯ç›‘æ§çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯è¿‡æ»¤ä¸€äº›ä¸éœ€è¦å­—èŠ‚ç å¢å¼ºæ“ä½œçš„æ–¹æ³•ï¼Œæ¯”å¦‚mainã€hashCodeã€javax/ç­‰
- ProfilingAspectã€ProfilingClassAdapterã€ProfilingMethodVisitorã€ProfilingTransformerï¼Œè¿™å››ä¸ªç±»ä¸»è¦æ˜¯å®Œæˆå­—èŠ‚ç æ’è£…æ“ä½œå’Œè¾“å‡ºç›‘æ§ç»“æœçš„ç±»ã€‚
- PreMain æä¾›äº† Javaagent çš„å…¥å£ï¼ŒJVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ premain æ–¹æ³•ã€‚
- MANIFEST.MF æ˜¯é…ç½®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æ‰¾åˆ° Premain-Class `Premain-Class: cn.bugstack.middleware.monitor.PreMain`

### 3. ç›‘æ§ç±»å…¥å£ 

**cn.bugstack.middleware.monitor.PreMain**

```java
public class PreMain {

    //JVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•
    public static void premain(String agentArgs, Instrumentation inst) {
        inst.addTransformer(new ProfilingTransformer());
    }

    //å¦‚æœä»£ç†ç±»æ²¡æœ‰å®ç°ä¸Šé¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ JVM å°†å°è¯•è°ƒç”¨è¯¥æ–¹æ³•
    public static void premain(String agentArgs) {
    }

}
```

- è¿™ä¸ªæ˜¯ Javaagent æŠ€æœ¯çš„å›ºå®šå…¥å£æ–¹æ³•ç±»ï¼ŒåŒæ—¶è¿˜éœ€è¦æŠŠè¿™ä¸ªç±»çš„è·¯å¾„é…ç½®åˆ° MANIFEST.MF ä¸­ã€‚

### 4. å­—èŠ‚ç æ–¹æ³•å¤„ç†

**cn.bugstack.middleware.monitor.probe.ProfilingTransformer**

```java
public class ProfilingTransformer implements ClassFileTransformer {

    @Override
    public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
        try {
            if (ProfilingFilter.isNotNeedInject(className)) {
                return classfileBuffer;
            }
            return getBytes(loader, className, classfileBuffer);
        } catch (Throwable e) {
            System.out.println(e.getMessage());
        }
        return classfileBuffer;
    }

    private byte[] getBytes(ClassLoader loader, String className, byte[] classfileBuffer) {
        ClassReader cr = new ClassReader(classfileBuffer);
        ClassWriter cw = new ClassWriter(cr, ClassWriter.COMPUTE_MAXS);
        ClassVisitor cv = new ProfilingClassAdapter(cw, className);
        cr.accept(cv, ClassReader.EXPAND_FRAMES);
        return cw.toByteArray();
    }

}
```

- ä½¿ç”¨ ASM æ ¸å¿ƒç±» ClassReaderã€ClassWriterã€ClassVisitorï¼Œå¤„ç†ä¼ å…¥è¿›è¡Œçš„ç±»åŠ è½½å™¨ã€ç±»åã€å­—èŠ‚ç ç­‰ï¼Œè´Ÿè´£å­—èŠ‚ç çš„å¢å¼ºæ“ä½œã€‚
- æ­¤å¤„ä¸»è¦æ˜¯å…³äº ASM çš„æ“ä½œç±»ï¼ŒClassReaderã€ClassWriterã€ClassVisitorï¼Œå…³äºå­—èŠ‚ç ç¼–ç¨‹çš„æ–‡ç« ï¼š[ASMã€Javassistã€Byte-bu ç³»åˆ—æ–‡ç« ](https://bugstack.cn/itstack/itstack-demo-bytecode.html)

### 5.å­—èŠ‚ç æ–¹æ³•è§£æ

**cn.bugstack.middleware.monitor.probe.ProfilingMethodVisitor**

```java
public class ProfilingMethodVisitor extends AdviceAdapter {

    private List<String> parameterTypeList = new ArrayList<>();
    private int parameterTypeCount = 0;     // å‚æ•°ä¸ªæ•°
    private int startTimeIdentifier;        // å¯åŠ¨æ—¶é—´æ ‡è®°
    private int parameterIdentifier;        // å…¥å‚å†…å®¹æ ‡è®°
    private int methodId = -1;              // æ–¹æ³•å…¨å±€å”¯ä¸€æ ‡è®°
    private int currentLocal = 0;           // å½“å‰å±€éƒ¨å˜é‡å€¼
    private final boolean isStaticMethod;   // trueï¼›é™æ€æ–¹æ³•ï¼Œfalseï¼›éé™æ€æ–¹æ³•
    private final String className;

    protected ProfilingMethodVisitor(int access, String methodName, String desc, MethodVisitor mv, String className, String fullClassName, String simpleClassName) {
        super(ASM5, mv, access, methodName, desc);
        this.className = className;
        // åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•ä¸­å±€éƒ¨å˜é‡ç¬¬ä¸€ä¸ªå€¼æ˜¯thisï¼Œé™æ€æ–¹æ³•æ˜¯ç¬¬ä¸€ä¸ªå…¥å‚å‚æ•°
        isStaticMethod = 0 != (access & ACC_STATIC);
        //(String var1,Object var2,String var3,int var4,long var5,int[] var6,Object[][] var7,Req var8)=="(Ljava/lang/String;Ljava/lang/Object;Ljava/lang/String;IJ[I[[Ljava/lang/Object;Lorg/itstack/test/Req;)V"
        Matcher matcher = Pattern.compile("(L.*?;|\\[{0,2}L.*?;|[ZCBSIFJD]|\\[{0,2}[ZCBSIFJD]{1})").matcher(desc.substring(0, desc.lastIndexOf(')') + 1));
        while (matcher.find()) {
            parameterTypeList.add(matcher.group(1));
        }
        parameterTypeCount = parameterTypeList.size();
        methodId = ProfilingAspect.generateMethodId(new MethodInfo(fullClassName, simpleClassName, methodName, desc, parameterTypeList, desc.substring(desc.lastIndexOf(')') + 1)));
    }     

    //... ä¸€äº›å­—èŠ‚ç æ’æ¡©æ“ä½œ 
}
```

- å½“ç¨‹åºå¯åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œæ¯ä¸ªç±»çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè¢«ç›‘æ§åˆ°ã€‚ç±»çš„åç§°ã€æ–¹æ³•çš„åç§°ã€æ–¹æ³•å…¥å‚å‡ºå‚çš„æè¿°ç­‰ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œè·å–ã€‚
- ä¸ºäº†å¯ä»¥åœ¨åç»­ç›‘æ§å¤„ç†ä¸è‡³äºæ¯ä¸€æ¬¡éƒ½å»ä¼ å‚ï¼ˆæ–¹æ³•ä¿¡æ¯ï¼‰æµªè´¹æ¶ˆè€—æ€§èƒ½ï¼Œä¸€èˆ¬è¿™é‡Œéƒ½ä¼šç»™æ¯ä¸ªæ–¹æ³•ç”Ÿäº§ä¸€ä¸ªå…¨å±€é˜²é‡çš„ `id` ï¼Œé€šè¿‡è¿™ä¸ª `id` å°±å¯ä»¥æŸ¥è¯¢åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚
- å¦å¤–ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ–¹æ³•çš„å…¥å‚å’Œå‡ºå‚è¢«æè¿°æˆä¸€æ®µæŒ‡å®šçš„ç ï¼Œ`(II)Ljava/lang/String;` ï¼Œä¸ºäº†æˆ‘ä»¬åç»­å¯¹å‚æ•°è¿›è¡Œè§£æï¼Œé‚£ä¹ˆéœ€è¦å°†è¿™æ®µå­—ç¬¦ä¸²è¿›è¡Œæ‹†è§£ã€‚

### 6. è¿è¡Œæµ‹è¯•

#### 6.1 é…ç½® VM å‚æ•° Javaagent

```java
-javaagent:E:\itstack\git\github.com\MonitorDesign\cn-bugstack-middleware-asm\target\cn-bugstack-middleware-asm.jar
```

- IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° `VM options` ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚                     

#### 6.2 æµ‹è¯•ç»“æœ

```java
ç›‘æ§ - Begin By ASM
æ–¹æ³•ï¼šcn.bugstack.middleware.test.interfaces.UserController$$EnhancerBySpringCGLIB$$8f5a18ca.queryUserInfo
å…¥å‚ï¼šnull å…¥å‚ç±»å‹ï¼š["Ljava/lang/String;"] å…¥æ•°[å€¼]ï¼š["aaa"]
å‡ºå‚ï¼šLcn/bugstack/middleware/test/interfaces/dto/UserInfo; å‡ºå‚[å€¼]ï¼š{"address":"å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000","age":19,"code":"0000","info":"success","name":"è™«è™«:aaa"}
è€—æ—¶ï¼š54(s)
ç›‘æ§ - End
```

- ä»è¿è¡Œæµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä½¿ç”¨ ASM ç›‘æ§åï¼Œå°±ä¸éœ€è¦ç¡¬ç¼–ç ä¹Ÿä¸éœ€è¦ AOP çš„æ–¹å¼åœ¨ä»£ç ä¸­æ“ä½œäº†ã€‚åŒæ—¶è¿˜å¯ä»¥ç›‘æ§åˆ°æ›´å®Œæ•´çš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¥å‚ç±»å‹ã€å…¥å‚å€¼å’Œå‡ºå‚ä¿¡æ¯ã€å‡ºå‚å€¼ã€‚
- ä½†å¯èƒ½å¤§å®¶ä¼šå‘ç° ASM æ“ä½œèµ·æ¥è¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›å¾ˆå¤æ‚çš„ç¼–ç é€»è¾‘ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§å„æ ·é—®é¢˜ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜ä¼šä»‹ç»ä¸€äº›åŸºäº ASM å¼€å‘çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¹Ÿå¯ä»¥å®ç°åŒæ ·çš„åŠŸèƒ½ã€‚

## äº”ã€Javassist

>Javassistæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“ã€‚æ˜¯ç”±ä¸œäº¬å·¥ä¸šå¤§å­¦çš„æ•°å­¦å’Œè®¡ç®—æœºç§‘å­¦ç³»çš„ Shigeru Chiba ï¼ˆåƒå¶ æ»‹ï¼‰æ‰€åˆ›å»ºçš„ã€‚å®ƒå·²åŠ å…¥äº†å¼€æ”¾æºä»£ç JBoss åº”ç”¨æœåŠ¡å™¨é¡¹ç›®ï¼Œé€šè¿‡ä½¿ç”¨Javassistå¯¹å­—èŠ‚ç æ“ä½œä¸ºJBosså®ç°åŠ¨æ€"AOP"æ¡†æ¶ã€‚

### 1. å…ˆæ¥ä¸ªæµ‹è¯•

**cn.bugstack.middleware.monitor.test.ApiTest**

```java
public class ApiTest {

    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();

        CtClass ctClass = pool.makeClass("cn.bugstack.middleware.javassist.MathUtil");

        // å±æ€§å­—æ®µ
        CtField ctField = new CtField(CtClass.doubleType, "Ï€", ctClass);
        ctField.setModifiers(Modifier.PRIVATE + Modifier.STATIC + Modifier.FINAL);
        ctClass.addField(ctField, "3.14");

        // æ–¹æ³•ï¼šæ±‚åœ†é¢ç§¯
        CtMethod calculateCircularArea = new CtMethod(CtClass.doubleType, "calculateCircularArea", new CtClass[]{CtClass.doubleType}, ctClass);
        calculateCircularArea.setModifiers(Modifier.PUBLIC);
        calculateCircularArea.setBody("{return Ï€ * $1 * $1;}");
        ctClass.addMethod(calculateCircularArea);

        // æ–¹æ³•ï¼›ä¸¤æ•°ä¹‹å’Œ
        CtMethod sumOfTwoNumbers = new CtMethod(pool.get(Double.class.getName()), "sumOfTwoNumbers", new CtClass[]{CtClass.doubleType, CtClass.doubleType}, ctClass);
        sumOfTwoNumbers.setModifiers(Modifier.PUBLIC);
        sumOfTwoNumbers.setBody("{return Double.valueOf($1 + $2);}");
        ctClass.addMethod(sumOfTwoNumbers);
        // è¾“å‡ºç±»çš„å†…å®¹
        ctClass.writeFile();

        // æµ‹è¯•è°ƒç”¨
        Class clazz = ctClass.toClass();
        Object obj = clazz.newInstance();

        Method method_calculateCircularArea = clazz.getDeclaredMethod("calculateCircularArea", double.class);
        Object obj_01 = method_calculateCircularArea.invoke(obj, 1.23);
        System.out.println("åœ†é¢ç§¯ï¼š" + obj_01);

        Method method_sumOfTwoNumbers = clazz.getDeclaredMethod("sumOfTwoNumbers", double.class, double.class);
        Object obj_02 = method_sumOfTwoNumbers.invoke(obj, 1, 2);
        System.out.println("ä¸¤æ•°å’Œï¼š" + obj_02);
    }

}
```

- è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Javassist ç”Ÿæˆçš„æ±‚åœ†é¢ç§¯å’ŒæŠ½è±¡çš„ç±»å’Œæ–¹æ³•å¹¶è¿è¡Œç»“æœçš„è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ° Javassist ä¸»è¦æ˜¯ ClassPoolã€CtClassã€CtFieldã€CtMethod ç­‰æ–¹æ³•çš„ä½¿ç”¨ã€‚
- æµ‹è¯•ç»“æœä¸»è¦åŒ…æ‹¬ä¼šç”Ÿæˆä¸€ä¸ªæŒ‡å®šè·¯å¾„ä¸‹çš„ç±» `cn.bugstack.middleware.javassist.MathUtil`ï¼ŒåŒæ—¶è¿˜ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºç»“æœã€‚
  

**ç”Ÿæˆçš„ç±»**  

```java
public class MathUtil {
  private static final double Ï€ = 3.14D;

  public double calculateCircularArea(double var1) {
      return 3.14D * var1 * var1;
  }

  public Double sumOfTwoNumbers(double var1, double var3) {
      return var1 + var3;
  }

  public MathUtil() {
  }
}
```

**æµ‹è¯•ç»“æœ**

```java
åœ†é¢ç§¯ï¼š4.750506
ä¸¤æ•°å’Œï¼š3.0

Process finished with exit code 0
```

### 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„

```java
cn-bugstack-middleware-javassist
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn.bugstack.middleware.monitor
    â”‚   â”‚       â”œâ”€â”€ config
    â”‚   â”‚       â”‚   â””â”€â”€ MethodDescription.java
    â”‚   â”‚       â”œâ”€â”€ probe
    â”‚   â”‚       â”‚   â”œâ”€â”€ Monitor.java
    â”‚   â”‚       â”‚   â””â”€â”€ MyMonitorTransformer.java
    â”‚   â”‚       â””â”€â”€ PreMain.java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ META_INF
    â”‚           â””â”€â”€ MANIFEST.MF
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.middleware.monitor.test
                â””â”€â”€ ApiTest.java
```

- æ•´ä¸ªä½¿ç”¨ javassist å®ç°çš„ç›‘æ§æ¡†æ¶æ¥çœ‹ï¼Œä¸ ASM çš„ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œä½†å¤§éƒ¨åˆ†æ“ä½œå­—èŠ‚ç çš„å·¥ä½œéƒ½äº¤ç»™äº† javassist æ¡†æ¶æ¥å¤„ç†ï¼Œæ‰€ä»¥æ•´ä¸ªä»£ç ç»“æ„çœ‹ä¸Šå»æ›´ç®€å•äº†ã€‚

### 3. ç›‘æ§æ–¹æ³•æ’æ¡©

**cn.bugstack.middleware.monitor.probe.MyMonitorTransformer** 

```java
public class MyMonitorTransformer implements ClassFileTransformer {

    private static final Set<String> classNameSet = new HashSet<>();

    static {
        classNameSet.add("cn.bugstack.middleware.test.interfaces.UserController");
    }

    @Override
    public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) {
        try {
            String currentClassName = className.replaceAll("/", ".");
            if (!classNameSet.contains(currentClassName)) { // æå‡classNameSetä¸­å«æœ‰çš„ç±»
                return null;
            }

            // è·å–ç±»
            CtClass ctClass = ClassPool.getDefault().get(currentClassName);
            String clazzName = ctClass.getName();

            // è·å–æ–¹æ³•
            CtMethod ctMethod = ctClass.getDeclaredMethod("queryUserInfo");
            String methodName = ctMethod.getName();

            // æ–¹æ³•ä¿¡æ¯ï¼šmethodInfo.getDescriptor();
            MethodInfo methodInfo = ctMethod.getMethodInfo();

            // æ–¹æ³•ï¼šå…¥å‚ä¿¡æ¯
            CodeAttribute codeAttribute = methodInfo.getCodeAttribute();
            LocalVariableAttribute attr = (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);
            CtClass[] parameterTypes = ctMethod.getParameterTypes();

            boolean isStatic = (methodInfo.getAccessFlags() & AccessFlag.STATIC) != 0;  // åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€æ–¹æ³•
            int parameterSize = isStatic ? attr.tableLength() : attr.tableLength() - 1; // é™æ€ç±»å‹å–å€¼
            List<String> parameterNameList = new ArrayList<>(parameterSize);            // å…¥å‚åç§°
            List<String> parameterTypeList = new ArrayList<>(parameterSize);            // å…¥å‚ç±»å‹
            StringBuilder parameters = new StringBuilder();                             // å‚æ•°ç»„è£…ï¼›$1ã€$2...ï¼Œ$$å¯ä»¥è·å–å…¨éƒ¨ï¼Œä½†æ˜¯ä¸èƒ½æ”¾åˆ°æ•°ç»„åˆå§‹åŒ–

            for (int i = 0; i < parameterSize; i++) {
                parameterNameList.add(attr.variableName(i + (isStatic ? 0 : 1))); // é™æ€ç±»å‹å»æ‰ç¬¬ä¸€ä¸ªthiså‚æ•°
                parameterTypeList.add(parameterTypes[i].getName());
                if (i + 1 == parameterSize) {
                    parameters.append("$").append(i + 1);
                } else {
                    parameters.append("$").append(i + 1).append(",");
                }
            }

            // æ–¹æ³•ï¼šå‡ºå‚ä¿¡æ¯
            CtClass returnType = ctMethod.getReturnType();
            String returnTypeName = returnType.getName();

            // æ–¹æ³•ï¼šç”Ÿæˆæ–¹æ³•å”¯ä¸€æ ‡è¯†ID
            int idx = Monitor.generateMethodId(clazzName, methodName, parameterNameList, parameterTypeList, returnTypeName);

            // å®šä¹‰å±æ€§
            ctMethod.addLocalVariable("startNanos", CtClass.longType);
            ctMethod.addLocalVariable("parameterValues", ClassPool.getDefault().get(Object[].class.getName()));

            // æ–¹æ³•å‰åŠ å¼º
            ctMethod.insertBefore("{ startNanos = System.nanoTime(); parameterValues = new Object[]{" + parameters.toString() + "}; }");

            // æ–¹æ³•ååŠ å¼º
            ctMethod.insertAfter("{ cn.bugstack.middleware.monitor.probe.Monitor.point(" + idx + ", startNanos, parameterValues, $_);}", false); // å¦‚æœè¿”å›ç±»å‹éå¯¹è±¡ç±»å‹ï¼Œ$_ éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢

            // æ–¹æ³•ï¼›æ·»åŠ TryCatch
            ctMethod.addCatch("{ cn.bugstack.middleware.monitor.probe.Monitor.point(" + idx + ", $e); throw $e; }", ClassPool.getDefault().get("java.lang.Exception"));   // æ·»åŠ å¼‚å¸¸æ•è·

            return ctClass.toBytecode();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

}
```

- ä¸ ASM å®ç°ç›¸æ¯”ï¼Œæ•´ä½“çš„ç›‘æ§æ–¹æ³•éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªå±•ç¤ºä¸‹ä¸åŒçš„åœ°æ–¹ã€‚
- é€šè¿‡ Javassist çš„æ“ä½œï¼Œä¸»è¦æ˜¯å®ç°ä¸€ä¸ª `ClassFileTransformer` æ¥å£çš„ transform æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è·å–å­—èŠ‚ç å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚
- å¤„ç†è¿‡ç¨‹åŒ…æ‹¬ï¼šè·å–ç±»ã€è·å–æ–¹æ³•ã€è·å–å…¥å‚ä¿¡æ¯ã€è·å–å‡ºå‚ä¿¡æ¯ã€ç»™æ–¹æ³•ç”Ÿæˆå”¯ä¸€IDã€ä¹‹åå¼€å§‹è¿›è¡Œæ–¹æ³•çš„å‰åå¢å¼ºæ“ä½œï¼Œè¿™ä¸ªå¢å¼ºä¹Ÿå°±æ˜¯åœ¨æ–¹æ³•å—ä¸­æ·»åŠ ç›‘æ§ä»£ç ã€‚
- æœ€åè¿”å›å­—èŠ‚ç ä¿¡æ¯ `return ctClass.toBytecode();` ç°åœ¨ä½ æ–°åŠ å…¥çš„å­—èŠ‚ç å°±å·²ç»å¯ä»¥è¢«ç¨‹åºåŠ è½½å¤„ç†äº†ã€‚

### 4. è¿è¡Œæµ‹è¯•

#### 4.1 é…ç½® VM å‚æ•° Javaagent

```java
-javaagent:E:\itstack\git\github.com\MonitorDesign\cn-bugstack-middleware-javassist\target\cn-bugstack-middleware-javassist.jar
```

- IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° `VM options` ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚                     

#### 4.2 æµ‹è¯•ç»“æœ

```java
ç›‘æ§ -  Begin By Javassist
æ–¹æ³•ï¼šcn.bugstack.middleware.test.interfaces.UserController$$EnhancerBySpringCGLIB$$8f5a18ca.queryUserInfo
å…¥å‚ï¼šnull å…¥å‚ç±»å‹ï¼š["Ljava/lang/String;"] å…¥æ•°[å€¼]ï¼š["aaa"]
å‡ºå‚ï¼šLcn/bugstack/middleware/test/interfaces/dto/UserInfo; å‡ºå‚[å€¼]ï¼š{"address":"å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000","age":19,"code":"0000","info":"success","name":"è™«è™«:aaa"}
è€—æ—¶ï¼š46(s)
ç›‘æ§ - End
```

- ä»æµ‹è¯•ç»“æœæ¥çœ‹ä¸ ASM åšå­—èŠ‚ç æ’æ¡©çš„æ•ˆæœæ˜¯ä¸€æ ·ï¼Œéƒ½å¯ä»¥åšåˆ°ç›‘æ§ç³»ç»Ÿæ‰§è¡Œä¿¡æ¯ã€‚ä½†æ˜¯è¿™æ ·çš„æ¡†æ¶ä¼šä½¿å¼€å‘æµç¨‹æ›´ç®€å•ï¼Œä¹Ÿæ›´å®¹æ˜“æ§åˆ¶ã€‚

## å…­ã€Byte-Buddy

>2015å¹´10æœˆï¼ŒByte Buddyè¢« Oracle æˆäºˆäº† Duke's Choiceå¤§å¥–ã€‚è¯¥å¥–é¡¹å¯¹Byte Buddyçš„â€œ JavaæŠ€æœ¯æ–¹é¢çš„å·¨å¤§åˆ›æ–° â€è¡¨ç¤ºèµèµã€‚æˆ‘ä»¬ä¸ºè·å¾—æ­¤å¥–é¡¹æ„Ÿåˆ°éå¸¸è£å¹¸ï¼Œå¹¶æ„Ÿè°¢æ‰€æœ‰å¸®åŠ©Byte Buddyå–å¾—æˆåŠŸçš„ç”¨æˆ·ä»¥åŠå…¶ä»–æ‰€æœ‰äººã€‚æˆ‘ä»¬çœŸçš„å¾ˆæ„Ÿæ¿€ï¼

`Byte Buddy` æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå’Œæ“ä½œåº“ï¼Œç”¨äºåœ¨ `Java` åº”ç”¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºå’Œä¿®æ”¹ `Java` ç±»ï¼Œè€Œæ— éœ€ç¼–è¯‘å™¨çš„å¸®åŠ©ã€‚é™¤äº† `Java` ç±»åº“é™„å¸¦çš„ä»£ç ç”Ÿæˆå®ç”¨ç¨‹åºå¤–ï¼Œ`Byte Buddy` è¿˜å…è®¸åˆ›å»ºä»»æ„ç±»ï¼Œå¹¶ä¸”ä¸é™äºå®ç°ç”¨äºåˆ›å»ºè¿è¡Œæ—¶ä»£ç†çš„æ¥å£ã€‚æ­¤å¤–ï¼Œ`Byte Buddy` æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„ APIï¼Œå¯ä»¥ä½¿ç”¨ `Java` ä»£ç†æˆ–åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ‰‹åŠ¨æ›´æ”¹ç±»ã€‚

- æ— éœ€ç†è§£å­—èŠ‚ç æŒ‡ä»¤ï¼Œå³å¯ä½¿ç”¨ç®€å•çš„ API å°±èƒ½å¾ˆå®¹æ˜“æ“ä½œå­—èŠ‚ç ï¼Œæ§åˆ¶ç±»å’Œæ–¹æ³•ã€‚
- å·²æ”¯æŒJava 11ï¼Œåº“è½»é‡ï¼Œä»…å–å†³äºJavaå­—èŠ‚ä»£ç è§£æå™¨åº“ASMçš„è®¿é—®è€…APIï¼Œå®ƒæœ¬èº«ä¸éœ€è¦ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚
- æ¯”èµ·JDKåŠ¨æ€ä»£ç†ã€cglibã€Javassistï¼ŒByte Buddyåœ¨æ€§èƒ½ä¸Šå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚

### 1. å…ˆæ¥ä¸ªæµ‹è¯•

**cn.bugstack.middleware.monitor.test.ApiTest**

```java
public class ApiTest {

    public static void main(String[] args) throws IllegalAccessException, InstantiationException {
        String helloWorld = new ByteBuddy()
                .subclass(Object.class)
                .method(named("toString"))
                .intercept(FixedValue.value("Hello World!"))
                .make()
                .load(ApiTest.class.getClassLoader())
                .getLoaded()
                .newInstance()
                .toString();

        System.out.println(helloWorld);
    }

}
```

- è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ ByteBuddy è¯­æ³•ç”Ÿæˆçš„ "Hello World!" æ¡ˆä¾‹ï¼Œä»–çš„è¿è¡Œç»“æœå°±æ˜¯ä¸€è¡Œï¼Œ`Hello World!`ï¼Œæ•´ä¸ªä»£ç å—æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯é€šè¿‡ `method(named("toString"))`ï¼Œæ‰¾åˆ° *toString* æ–¹æ³•ï¼Œå†é€šè¿‡æ‹¦æˆª `intercept`ï¼Œè®¾å®šæ­¤æ–¹æ³•çš„è¿”å›å€¼ã€‚`FixedValue.value("Hello World!")`ã€‚åˆ°è¿™é‡Œå…¶å®ä¸€ä¸ªåŸºæœ¬çš„æ–¹æ³•å°±é€šè¿‡ `Byte-buddy` ï¼Œæœ€ååŠ è½½ã€åˆå§‹åŒ–å’Œè°ƒç”¨è¾“å‡ºã€‚

**æµ‹è¯•ç»“æœ**

```java
Hello World!

Process finished with exit code 0
```

### 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„

```java
cn-bugstack-middleware-bytebuddy
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn.bugstack.middleware.monitor
    â”‚   â”‚       â”œâ”€â”€ MonitorMethod
    â”‚   â”‚       â””â”€â”€ PreMain.java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ META_INF
    â”‚           â””â”€â”€ MANIFEST.MF
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn.bugstack.middleware.monitor.test
                â””â”€â”€ ApiTest.java
```

- è¿™æ˜¯æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå› ä¸ºå®ƒæ“ä½œçš„æ–¹ä¾¿æ€§ï¼Œå¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ä¸šåŠ¡ä»£ç ä¸€æ ·ä½¿ç”¨å­—èŠ‚ç å¢å¼ºçš„æ“ä½œã€‚ä»ç°åœ¨çš„å·¥ç¨‹ç»“æ„ä½ èƒ½çœ‹å¾—å‡ºæ¥ï¼Œä»£ç ç±»æ•°é‡è¶Šæ¥è¶Šå°‘äº†ã€‚

### 3. ç›‘æ§æ–¹æ³•æ’æ¡©

**cn.bugstack.middleware.monitor.MonitorMethod** 

```java
public class MonitorMethod {

    @RuntimeType
    public static Object intercept(@Origin Method method, @SuperCall Callable<?> callable, @AllArguments Object[] args) throws Exception {
        long start = System.currentTimeMillis();
        Object resObj = null;
        try {
            resObj = callable.call();
            return resObj;
        } finally {
            System.out.println("ç›‘æ§ - Begin By Byte-buddy");
            System.out.println("æ–¹æ³•åç§°ï¼š" + method.getName());
            System.out.println("å…¥å‚ä¸ªæ•°ï¼š" + method.getParameterCount());
            for (int i = 0; i < method.getParameterCount(); i++) {
                System.out.println("å…¥å‚ Idxï¼š" + (i + 1) + " ç±»å‹ï¼š" + method.getParameterTypes()[i].getTypeName() + " å†…å®¹ï¼š" + args[i]);
            }
            System.out.println("å‡ºå‚ç±»å‹ï¼š" + method.getReturnType().getName());
            System.out.println("å‡ºå‚ç»“æœï¼š" + resObj);
            System.out.println("æ–¹æ³•è€—æ—¶ï¼š" + (System.currentTimeMillis() - start) + "ms");
            System.out.println("ç›‘æ§ - End\r\n");
        }
    }

}
```

- `@Origin`ï¼Œç”¨äºæ‹¦æˆªåŸæœ‰æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥è·å–åˆ°æ–¹æ³•ä¸­çš„ç›¸å…³ä¿¡æ¯ã€‚
- è¿™ä¸€éƒ¨åˆ†çš„ä¿¡æ¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå…¨ï¼Œå°¤å…¶ä¹Ÿè·å–åˆ°äº†å‚æ•°çš„ä¸ªæ•°å’Œç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åç»­çš„å¤„ç†å‚æ•°æ—¶è¿›è¡Œå¾ªç¯è¾“å‡ºã€‚

**å¸¸ç”¨æ³¨è§£è¯´æ˜**

é™¤äº†ä»¥ä¸Šä¸ºäº†è·å–æ–¹æ³•çš„æ‰§è¡Œä¿¡æ¯ä½¿ç”¨åˆ°çš„æ³¨è§£å¤–ï¼ŒByte Buddy è¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–çš„æ³¨è§£ã€‚å¦‚ä¸‹ï¼›

| æ³¨è§£          | è¯´æ˜                                                         |
| :------------ | :----------------------------------------------------------- |
| @Argument     | ç»‘å®šå•ä¸ªå‚æ•°                                                 |
| @AllArguments | ç»‘å®šæ‰€æœ‰å‚æ•°çš„æ•°ç»„                                           |
| @This         | å½“å‰è¢«æ‹¦æˆªçš„ã€åŠ¨æ€ç”Ÿæˆçš„é‚£ä¸ªå¯¹è±¡                             |
| @Super        | å½“å‰è¢«æ‹¦æˆªçš„ã€åŠ¨æ€ç”Ÿæˆçš„é‚£ä¸ªå¯¹è±¡çš„çˆ¶ç±»å¯¹è±¡                   |
| @Origin       | å¯ä»¥ç»‘å®šåˆ°ä»¥ä¸‹ç±»å‹çš„å‚æ•°ï¼šMethod è¢«è°ƒç”¨çš„åŸå§‹æ–¹æ³• Constructor è¢«è°ƒç”¨çš„åŸå§‹æ„é€ å™¨ Class å½“å‰åŠ¨æ€åˆ›å»ºçš„ç±» MethodHandle MethodType String åŠ¨æ€ç±»çš„toString()çš„è¿”å›å€¼ int åŠ¨æ€æ–¹æ³•çš„ä¿®é¥°ç¬¦ |
| @DefaultCall  | è°ƒç”¨é»˜è®¤æ–¹æ³•è€Œésuperçš„æ–¹æ³•                                  |
| @SuperCall    | ç”¨äºè°ƒç”¨çˆ¶ç±»ç‰ˆæœ¬çš„æ–¹æ³•                                       |
| @Super        | æ³¨å…¥çˆ¶ç±»å‹å¯¹è±¡ï¼Œå¯ä»¥æ˜¯æ¥å£ï¼Œä»è€Œè°ƒç”¨å®ƒçš„ä»»ä½•æ–¹æ³•             |
| @RuntimeType  | å¯ä»¥ç”¨åœ¨è¿”å›å€¼ã€å‚æ•°ä¸Šï¼Œæç¤ºByteBuddyç¦ç”¨ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥      |
| @Empty        | æ³¨å…¥å‚æ•°çš„ç±»å‹çš„é»˜è®¤å€¼                                       |
| @StubValue    | æ³¨å…¥ä¸€ä¸ªå­˜æ ¹å€¼ã€‚å¯¹äºè¿”å›å¼•ç”¨ã€voidçš„æ–¹æ³•ï¼Œæ³¨å…¥nullï¼›å¯¹äºè¿”å›åŸå§‹ç±»å‹çš„æ–¹æ³•ï¼Œæ³¨å…¥0 |
| @FieldValue   | æ³¨å…¥è¢«æ‹¦æˆªå¯¹è±¡çš„ä¸€ä¸ªå­—æ®µçš„å€¼                                 |
| @Morph        | ç±»ä¼¼äº@SuperCallï¼Œä½†æ˜¯å…è®¸æŒ‡å®šè°ƒç”¨å‚æ•°                       |

**å¸¸ç”¨æ ¸å¿ƒAPI**

1. ByteBuddy

   - æµå¼APIæ–¹å¼çš„å…¥å£ç±»
   - æä¾›Subclassing/Redefining/Rebasingæ–¹å¼æ”¹å†™å­—èŠ‚ç 
   - æ‰€æœ‰çš„æ“ä½œä¾èµ–DynamicType.Builderè¿›è¡Œ,åˆ›å»ºä¸å¯å˜çš„å¯¹è±¡

2. ElementMatchers(ElementMatcher)

   - æä¾›ä¸€ç³»åˆ—çš„å…ƒç´ åŒ¹é…çš„å·¥å…·ç±»(named/any/nameEndsWithç­‰ç­‰)
   - ElementMatcher(æä¾›å¯¹ç±»å‹ã€æ–¹æ³•ã€å­—æ®µã€æ³¨è§£è¿›è¡Œmatchesçš„æ–¹å¼,ç±»ä¼¼äºPredicate)
   - Junctionå¯¹å¤šä¸ªElementMatcherè¿›è¡Œäº†and/oræ“ä½œ

3. DynamicType

   (åŠ¨æ€ç±»å‹,æ‰€æœ‰å­—èŠ‚ç æ“ä½œçš„å¼€å§‹,éå¸¸å€¼å¾—å…³æ³¨)

   - Unloaded(åŠ¨æ€åˆ›å»ºçš„å­—èŠ‚ç è¿˜æœªåŠ è½½è¿›å…¥åˆ°è™šæ‹Ÿæœº,éœ€è¦ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½)
   - Loaded(å·²åŠ è½½åˆ°jvmä¸­å,è§£æå‡ºClassè¡¨ç¤º)
   - Default(DynamicTypeçš„é»˜è®¤å®ç°,å®Œæˆç›¸å…³å®é™…æ“ä½œ)

4. `Implementation

   (ç”¨äºæä¾›åŠ¨æ€æ–¹æ³•çš„å®ç°)

   - FixedValue(æ–¹æ³•è°ƒç”¨è¿”å›å›ºå®šå€¼)
   - MethodDelegation(æ–¹æ³•è°ƒç”¨å§”æ‰˜,æ”¯æŒä¸¤ç§æ–¹å¼: Classçš„staticæ–¹æ³•è°ƒç”¨ã€objectçš„instance methodæ–¹æ³•è°ƒç”¨)

5. Builder

   (ç”¨äºåˆ›å»ºDynamicType,ç›¸å…³æ¥å£ä»¥åŠå®ç°åç»­å¾…è¯¦è§£)

   - MethodDefinition
   - FieldDefinition
   - AbstractBase

### 4. é…ç½®å…¥å£æ–¹æ³•

**cn.bugstack.middleware.monitor.PreMain**

```java
public class PreMain {

    //JVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•
    public static void premain(String agentArgs, Instrumentation inst) {
        AgentBuilder.Transformer transformer = (builder, typeDescription, classLoader, javaModule) -> {
            return builder
                    .method(ElementMatchers.named("queryUserInfo")) // æ‹¦æˆªä»»æ„æ–¹æ³•
                    .intercept(MethodDelegation.to(MonitorMethod.class)); // å§”æ‰˜
        };

        new AgentBuilder
                .Default()
                .type(ElementMatchers.nameStartsWith(agentArgs))  // æŒ‡å®šéœ€è¦æ‹¦æˆªçš„ç±» "cn.bugstack.demo.test"
                .transform(transformer)
                .installOn(inst);
    }

    //å¦‚æœä»£ç†ç±»æ²¡æœ‰å®ç°ä¸Šé¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ JVM å°†å°è¯•è°ƒç”¨è¯¥æ–¹æ³•
    public static void premain(String agentArgs) {
    }

}
```

- premain æ–¹æ³•ä¸­ä¸»è¦æ˜¯å¯¹å®ç°çš„ MonitorMethod è¿›è¡Œå§”æ‰˜ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜åœ¨ method è®¾ç½®äº†æ‹¦æˆªçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ‹¦æˆªæ–¹æ³•è¿˜å¯ä»¥åˆ°ç±»è·¯å¾„ç­‰ã€‚

### 5. è¿è¡Œæµ‹è¯•

#### 5.1 é…ç½® VM å‚æ•° Javaagent

```java
-javaagent:E:\itstack\git\github.com\MonitorDesign\cn-bugstack-middleware-bytebuddy\target\cn-bugstack-middleware-bytebuddy.jar
```

- IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° `VM options` ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚                     

#### 5.2 æµ‹è¯•ç»“æœ

```java
ç›‘æ§ - Begin By Byte-buddy
æ–¹æ³•åç§°ï¼šqueryUserInfo
å…¥å‚ä¸ªæ•°ï¼š1
å…¥å‚ Idxï¼š1 ç±»å‹ï¼šjava.lang.String å†…å®¹ï¼šaaa
å‡ºå‚ç±»å‹ï¼šcn.bugstack.middleware.test.interfaces.dto.UserInfo
å‡ºå‚ç»“æœï¼šcn.bugstack.middleware.test.interfaces.dto.@214b199c
æ–¹æ³•è€—æ—¶ï¼š1ms
ç›‘æ§ - End
```

- Byte-buddy æ˜¯æˆ‘ä»¬æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹çš„å‡ ä¸ªå­—èŠ‚ç æ¡†æ¶ä¸­ï¼Œæ“ä½œèµ·æ¥æœ€ç®€å•ï¼Œæœ€æ–¹ä¾¿çš„ï¼Œä¹Ÿéå¸¸å®¹æ˜“æ‰©å®¹ä¿¡æ¯ã€‚æ•´ä¸ªè¿‡ç¨‹å°±åƒæœ€åˆä½¿ç”¨ AOP ä¸€æ ·ç®€å•ï¼Œä½†å´æ»¡è¶³äº†éå…¥ä¾µçš„ç›‘æ§éœ€æ±‚ã€‚
- æ‰€ä»¥åœ¨ä½¿ç”¨å­—èŠ‚ç æ¡†æ¶çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘é€‰æ‹©ä½¿ç”¨ Byte-buddy è¿™ä¸ªéå¸¸å¥½ç”¨çš„å­—èŠ‚ç æ¡†æ¶ã€‚

## ä¸ƒã€æ€»ç»“

- ASM è¿™ç§å­—èŠ‚ç ç¼–ç¨‹çš„åº”ç”¨æ˜¯éå¸¸å¹¿çš„ï¼Œä½†å¯èƒ½ç¡®å®å¹³æ—¶çœ‹ä¸åˆ°çš„ï¼Œå› ä¸ºä»–éƒ½æ˜¯ä¸å…¶ä»–æ¡†æ¶ç»“åˆä¸€èµ·ä½œä¸ºæ”¯æ’‘æœåŠ¡ä½¿ç”¨ã€‚åƒè¿™æ ·çš„æŠ€æœ¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ javassitã€Cglibã€jacocoç­‰ç­‰ã€‚
- åœ¨ä¸€äº›å…¨é“¾è·¯ç›‘æ§ä¸­çš„ç»„ä»¶ä¸­ Javassist çš„ä½¿ç”¨éå¸¸å¤šï¼Œå®ƒå³å¯ä½¿ç”¨ç¼–ç çš„æ–¹å¼æ“ä½œå­—èŠ‚ç å¢å¼ºï¼Œä¹Ÿå¯ä»¥åƒ ASM é‚£æ ·è¿›è¡Œå¤„ç†ã€‚
- Byte-buddy æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„æ¡†æ¶ï¼Œç›®å‰ä½¿ç”¨ä¹Ÿè¶Šæ¥è¶Šå¹¿æ³›ï¼Œå¹¶ä¸”ä¸Šæ‰‹ä½¿ç”¨çš„å­¦ä¹ éš¾åº¦ä¹Ÿæ˜¯å‡ ä¸ªæ¡†æ¶ä¸­æœ€ä½çš„ã€‚é™¤äº†æœ¬ç« èŠ‚çš„æ¡ˆä¾‹ä½¿ç”¨ä»‹ç»å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å®˜ç½‘ï¼š[`https://bytebuddy.net`](https://bytebuddy.net/#/)ï¼Œå»äº†è§£æ›´å¤šå…³äº `Byte Buddy` çš„å†…å®¹ã€‚
- æœ¬ç« èŠ‚æ‰€æœ‰çš„æºç å·²ç»ä¸Šä¼ åˆ°GitHubï¼š[https://github.com/fuzhengwei/MonitorDesign](https://github.com/fuzhengwei/MonitorDesign)

## å…«ã€ç³»åˆ—æ¨è

- [æ¯•ä¸šå‰å†™äº†20ä¸‡è¡Œä»£ç ï¼Œè®©æˆ‘ä»æˆä¸ºåŒå­¦çœ¼é‡Œçš„é¢éœ¸ï¼](https://bugstack.cn/itstack-code-life/2021/05/09/%E5%A4%A7%E5%AD%A6%E6%AF%95%E4%B8%9A%E8%A6%81%E5%86%99%E5%A4%9A%E5%B0%91%E8%A1%8C%E4%BB%A3%E7%A0%81-%E6%89%8D%E8%83%BD%E4%B8%8D%E7%94%A8%E8%8A%B1%E9%92%B1%E5%9F%B9%E8%AE%AD%E5%B0%B1%E6%89%BE%E5%88%B0%E4%B8%80%E4%BB%BD%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C.html)
- [ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹å¼€ç¯‡ä»‹ç»ï¼Œæˆ‘è¦å¸¦ä½ æ’¸ Spring å•¦ï¼](https://bugstack.cn/spring/2021/05/16/%E7%AC%AC1%E7%AB%A0-%E5%BC%80%E7%AF%87%E4%BB%8B%E7%BB%8D-%E6%89%8B%E5%86%99Spring%E8%83%BD%E7%BB%99%E4%BD%A0%E5%B8%A6%E6%9D%A5%E4%BB%80%E4%B9%88.html)
- [ã€ŠSpringBoot ä¸­é—´ä»¶è®¾è®¡å’Œå¼€å‘ã€‹ï¼Œè¿™æ¬¡æ•™ä½ é€ ç«ç®­ï¼](https://bugstack.cn/itstack-ark-middleware/2021/03/31/SpringBoot-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%BC%80%E5%8F%91-%E4%B8%93%E6%A0%8F%E5%B0%8F%E5%86%8C%E4%B8%8A%E7%BA%BF%E5%95%A6.html)
- [ä¸€æœ¬äº’è”ç½‘å®æˆ˜æ¡ˆä¾‹çš„æŠ€æœ¯ä¹¦ç±ã€Šé‡å­¦Javaè®¾è®¡æ¨¡å¼ã€‹](https://bugstack.cn/itstack-code-life/2021/04/22/%E4%B9%85%E7%AD%89%E4%BA%86-%E5%B0%8F%E5%82%85%E5%93%A5%E7%9A%84-%E9%87%8D%E5%AD%A6Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%88%E4%BA%8E%E5%87%BA%E7%89%88%E4%BA%86-%E5%BD%A9%E5%8D%B0&%E7%BA%B8%E8%B4%A8.html)
- [ã€ŠJava é¢ç»æ‰‹å†Œã€‹PDFï¼Œå…¨ä¹¦ 417 é¡µ 11.5 ä¸‡å­—ï¼Œå®Œç¨¿&å‘ç‰ˆï¼](https://bugstack.cn/interview/2021/01/26/Java%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8CPDF%E4%B8%8B%E8%BD%BD.html)