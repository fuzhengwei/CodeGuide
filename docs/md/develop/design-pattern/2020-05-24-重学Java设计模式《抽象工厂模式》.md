---
layout: post
category: itstack-demo-design
title: é‡å­¦ Java è®¾è®¡æ¨¡å¼ï¼šå®æˆ˜æŠ½è±¡å·¥å‚æ¨¡å¼ã€Œæ›¿æ¢RedisåŒé›†ç¾¤å‡çº§ï¼Œä»£ç†ç±»æŠ½è±¡åœºæ™¯ã€
tagline: by å°å‚…å“¥
tag: [itstack-demo-design]
excerpt: æŠ€æœ¯å¥½å°±ä¸€å®šèƒ½å†™å‡ºå¥½ä»£ç å—ï¼Ÿä¸èƒ½ï¼å†æ¼‚äº®çš„é©¬æ¡¶æ”¾åˆ°å¨æˆ¿éƒ½ç•¥æ˜¾å°´å°¬ï¼æƒ³è®©å®ƒä»¬åˆç†çš„å‡ºç°åœ¨è¯¥æœ‰çš„ä½ç½®ä¸Šï¼Œä¸€å®šè¦å®æˆ˜ã€‚
lock: need
---

# é‡å­¦ Java è®¾è®¡æ¨¡å¼ï¼šå®æˆ˜æŠ½è±¡å·¥å‚æ¨¡å¼ã€Œæ›¿æ¢RedisåŒé›†ç¾¤å‡çº§ï¼Œä»£ç†ç±»æŠ½è±¡åœºæ™¯ã€

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=767337308&bvid=BV1ir4y1i7uf&cid=551397526&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`ä»£ç ä¸€æŠŠæ¢­ï¼Œå…„å¼Ÿæ¥èƒŒé”…ã€‚`

å¤§éƒ¨åˆ†åšå¼€å‘çš„å°ä¼™ä¼´åˆå¿ƒéƒ½å¸Œæœ›æŠŠä»£ç å†™å¥½ï¼Œé™¤äº†æŠŠç¼–ç¨‹å½“ä½œå·¥ä½œä»¥å¤–ä»–ä»¬è¿˜æ˜¯å…·å¤‡å·¥åŒ ç²¾ç¥çš„ä»ä¸šè€…ã€‚ä½†å¾ˆå¤šæ—¶å€™åˆå¾ˆéš¾è®©ä½ æŠŠåˆå¿ƒåšæŒä¸‹å»ï¼Œå°±åƒï¼›æ¥äº†ä¸ªçƒ‚æ‰‹çš„é¡¹ç›®ã€äº§å“åŠŸèƒ½è¦çš„æ€¥ã€ä¸ªäººèƒ½åŠ›ä¸è¶³ï¼Œç­‰ç­‰åŸå› å¯¼è‡´å·¥ç¨‹ä»£ç è‡ƒè‚¿ä¸å ªï¼Œçº¿ä¸Šé¢‘å‡ºäº‹æ•…ï¼Œæœ€ç»ˆç¦»èŒèµ°äººã€‚

`çœ‹äº†å¾ˆå¤šä¹¦ã€å­¦äº†å¾ˆå¤šçŸ¥è¯†ï¼Œå¤šçº¿ç¨‹èƒ½ç©å‡ºèŠ±ï¼Œå¯æœ€åæˆ‘è¿˜æ˜¯å†™ä¸å¥½ä»£ç ï¼`

è¿™å°±æœ‰ç‚¹åƒå®¶é‡Œè£…ä¿®å®Œäº†ä¹°ç‰©ä»¶ï¼Œæˆ‘å‡ åä¸‡çš„å®æœ¨æ²™å‘ï¼Œæ€ä¹ˆæ”¾è¿™é‡Œå°±ä¸å¥½çœ‹ã€‚åŒæ ·ä»£ç å†™çš„ä¸å¥½å¹¶ä¸ä¸€å®šæ˜¯åŸºç¡€æŠ€æœ¯ä¸è¶³ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯äº§å“è¦å¾—æ€¥ `æ€ä¹ˆå®ç°æˆ‘ä¸ç®¡æ˜å¤©ä¸Šçº¿`ã€‚è€Œå¾ˆå¤šæ—¶å€™æ˜¯æˆ‘ä»¬å¯¹ç¼–ç çš„ç»éªŒçš„ä¸è¶³å’Œå¯¹æ¶æ„çš„æŠŠæ§èƒ½åŠ›ä¸åˆ°ä½ï¼Œæˆ‘ç›¸ä¿¡äº§å“çš„ç¬¬ä¸€ä¸ªéœ€æ±‚å¾€å¾€éƒ½ä¸å¤æ‚ï¼Œç”šè‡³æ‰€è§æ‰€å¾—ã€‚ä½†å¦‚æœä½ ä¸è€ƒè™‘åç»­çš„æ˜¯å¦ä¼šæ‹“å±•ï¼Œå°†æ¥ä¼šåœ¨å“ªäº›æ¨¡å—ç»§ç»­æ·»åŠ åŠŸèƒ½ï¼Œé‚£ä¹ˆåç»­çš„ä»£ç å°±ä¼šéšç€ä½ ç§ä¸‹çš„ç¬¬ä¸€é¢—æ¶æ€§çš„ç§å­å¼€å§‹è”“å»¶ã€‚

`å­¦ä¹ è®¾è®¡æ¨¡å¼çš„å¿ƒå¾—æœ‰å“ªäº›ï¼Œæ€ä¹ˆå­¦æ‰ä¼šç”¨ï¼`

è®¾è®¡æ¨¡å¼ä¹¦ç±ï¼Œæœ‰ç‚¹åƒè€ƒé©¾é©¶è¯çš„ç§‘ä¸€ã€å®¶é‡Œè£…ä¿®æ—¶çš„æ‰‹å†Œã€æˆ–è€…å•èº«ç‹—çš„æ‹çˆ±å®å…¸ã€‚ä½†ï¼ä½ åªè¦ä¸å®æ“ï¼Œä¸€å®šèƒ½æçš„**ä¹±`ç `ä¸ƒç³Ÿ**ã€‚å› ä¸ºè¿™äº›æŒ‡å¯¼æ€æƒ³éƒ½æ˜¯ä»å®é™…ç»éªŒä¸­æç‚¼çš„ï¼Œæ²¡æœ‰ç»è¿‡æç‚¼çš„å°ç™½ï¼Œå¾ˆéš¾é©¾é©­è¿™æ ·çš„çŸ¥è¯†ã€‚æ‰€ä»¥åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­é¦–å…ˆè¦æœ‰æ¡ˆä¾‹ï¼Œä¹‹åå†ç»“åˆæ¡ˆä¾‹ä¸è‡ªå·±å®é™…çš„ä¸šåŠ¡ï¼Œå°è¯•é‡æ„æ”¹é€ ï¼Œæ…¢æ…¢ä½“ä¼šå…¶ä¸­çš„æ„Ÿå—ï¼Œä»è€Œä¹Ÿå°±å­¦ä¼šäº†å¦‚ä½•æ­å»ºå‡ºä¼˜ç§€çš„ä»£ç ã€‚

## äºŒã€å¼€å‘ç¯å¢ƒ

1. JDK 1.8
2. Idea + Maven
3. æ¶‰åŠå·¥ç¨‹ä¸‰ä¸ªï¼Œå¯ä»¥é€šè¿‡å…³æ³¨**å…¬ä¼—å·**ï¼š[`bugstackè™«æ´æ ˆ`](https://bugstack.cn/assets/images/qrcode.png)ï¼Œå›å¤`æºç ä¸‹è½½`è·å–

| å·¥ç¨‹                     | æè¿°                                         |
| ------------------------ | -------------------------------------------- |
| itstack-demo-design-2-00 | åœºæ™¯æ¨¡æ‹Ÿå·¥ç¨‹ï¼Œæ¨¡æ‹Ÿå‡ºä½¿ç”¨Rediså‡çº§ä¸ºé›†ç¾¤æ—¶ç±»æ”¹é€  |
| itstack-demo-design-2-01 | ä½¿ç”¨ä¸€å¨ä»£ç å®ç°ä¸šåŠ¡éœ€æ±‚ï¼Œä¹Ÿæ˜¯å¯¹ifelseçš„ä½¿ç”¨ |
| itstack-demo-design-2-02 | é€šè¿‡è®¾è®¡æ¨¡å¼ä¼˜åŒ–æ”¹é€ ä»£ç ï¼Œäº§ç”Ÿå¯¹æ¯”æ€§ä»è€Œå­¦ä¹  |

## ä¸‰ã€æŠ½è±¡å·¥å‚æ¨¡å¼ä»‹ç»

![æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œå›¾ç‰‡æ¥è‡ª refactoringguru.cn](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-01.png)

- å›¾ç‰‡æ¥è‡ªï¼š[https://refactoringguru.cn/design-patterns/abstract-factory](https://refactoringguru.cn/design-patterns/abstract-factory)

æŠ½è±¡å·¥å‚æ¨¡å¼ä¸å·¥å‚æ–¹æ³•æ¨¡å¼è™½ç„¶ä¸»è¦æ„å›¾éƒ½æ˜¯ä¸ºäº†è§£å†³ï¼Œ**æ¥å£é€‰æ‹©**é—®é¢˜ã€‚ä½†åœ¨å®ç°ä¸Šï¼ŒæŠ½è±¡å·¥å‚æ˜¯ä¸€ä¸ªä¸­å¿ƒå·¥å‚ï¼Œåˆ›å»ºå…¶ä»–å·¥å‚çš„æ¨¡å¼ã€‚

å¯èƒ½åœ¨å¹³å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­å¾ˆå°‘å…³æ³¨è¿™æ ·çš„è®¾è®¡æ¨¡å¼æˆ–è€…ç±»ä¼¼çš„ä»£ç ç»“æ„ï¼Œä½†æ˜¯è¿™ç§åœºæ™¯ç¡®ä¸€ç›´åœ¨æˆ‘ä»¬èº«è¾¹ï¼Œä¾‹å¦‚ï¼›

1. ä¸åŒç³»ç»Ÿå†…çš„å›è½¦æ¢è¡Œ
	1. Unixç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾åªæœ‰ **<æ¢è¡Œ>**ï¼Œå³ `\n`ï¼›
	2. Windowsç³»ç»Ÿé‡Œé¢ï¼Œæ¯è¡Œç»“å°¾æ˜¯ **<æ¢è¡Œ><å›è½¦>**ï¼Œå³ `\n\r`ï¼›
	3. Macç³»ç»Ÿé‡Œï¼Œæ¯è¡Œç»“å°¾æ˜¯ **<å›è½¦>**

2. IDEA å¼€å‘å·¥å…·çš„å·®å¼‚å±•ç¤º(Win\Mac)

   ![ä¸åŒç³»ç»Ÿä¸‹ï¼ŒIDEA å¼€å‘å·¥å…·çš„å±•ç¤ºå·®å¼‚ç‚¹](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-02.png)

**é™¤äº†è¿™æ ·æ˜¾è€Œæ˜“è§çš„ä¾‹å­å¤–ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡å¼€å‘ä¸­æ—¶å¸¸ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œéœ€è¦å…¼å®¹åšå¤„ç†ã€‚**ä½†å¤§éƒ¨åˆ†ç»éªŒä¸è¶³çš„å¼€å‘äººå‘˜ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡æ·»åŠ `ifelse`æ–¹å¼è¿›è¡Œå¤„ç†äº†ã€‚

## å››ã€æ¡ˆä¾‹åœºæ™¯æ¨¡æ‹Ÿ

![æ¨¡æ‹Ÿä¼ä¸šçº§åŒå¥—Redisé›†ç¾¤å‡çº§](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-03.png)

`å¾ˆå¤šæ—¶å€™åˆæœŸä¸šåŠ¡çš„è›®è’å‘å±•ï¼Œä¹Ÿä¼šç‰µåŠ¨ç€ç ”å‘å¯¹ç³»ç»Ÿçš„å»ºè®¾ã€‚`

é¢„ä¼°`QPSè¾ƒä½`ã€`ç³»ç»Ÿå‹åŠ›è¾ƒå°`ã€`å¹¶å‘è®¿é—®ä¸å¤§`ã€`è¿‘ä¸€å¹´æ²¡æœ‰å¤§åŠ¨ä½œ`ç­‰ç­‰ï¼Œåœ¨è€ƒè™‘æ—¶é—´æŠ•å…¥æˆæœ¬çš„å‰æå‰ï¼Œå¹¶ä¸ä¼šæŠ•å…¥ç‰¹åˆ«å¤šçš„äººåŠ›å»æ„å»ºéå¸¸å®Œå–„çš„ç³»ç»Ÿã€‚å°±åƒå¯¹ `Redis` çš„ä½¿ç”¨ï¼Œå¾€å¾€å¯èƒ½åªè¦æ˜¯å•æœºçš„å°±å¯ä»¥æ»¡è¶³ç°çŠ¶ã€‚

`ä¸å¹ç‰›çš„è®²ç™¾åº¦é¦–é¡µæˆ‘ä¸Šå­¦æ—¶å€™ä¸€å¤©å°±èƒ½å†™å®Œï¼Œç­‰æ¯•ä¸šå·¥ä½œäº†å°±ç®—ç»™æˆ‘ä¸€å¹´éƒ½å®Œæˆä¸äº†ï¼`

ä½†éšç€ä¸šåŠ¡è¶…è¿‡é¢„æœŸçš„å¿«é€Ÿå‘å±•ï¼Œç³»ç»Ÿçš„è´Ÿè½½èƒ½åŠ›ä¹Ÿè¦éšç€è·Ÿä¸Šã€‚åŸæœ‰çš„å•æœº `Redis` å·²ç»æ»¡è¶³ä¸äº†ç³»ç»Ÿéœ€æ±‚ã€‚è¿™æ—¶å€™å°±éœ€è¦æ›´æ¢ä¸ºæ›´ä¸ºå¥å£®çš„Redisé›†ç¾¤æœåŠ¡ï¼Œè™½ç„¶éœ€è¦ä¿®æ”¹ä½†æ˜¯ä¸èƒ½å½±å“ç›®å‰ç³»ç»Ÿçš„è¿è¡Œï¼Œè¿˜è¦å¹³æ»‘è¿‡æ¸¡è¿‡å»ã€‚

éšç€è¿™æ¬¡çš„å‡çº§ï¼Œå¯ä»¥é¢„è§çš„é—®é¢˜ä¼šæœ‰ï¼›

1. å¾ˆå¤šæœåŠ¡ç”¨åˆ°äº†Rediséœ€è¦ä¸€èµ·å‡çº§åˆ°é›†ç¾¤ã€‚
2. éœ€è¦å…¼å®¹é›†ç¾¤Aå’Œé›†ç¾¤Bï¼Œä¾¿äºåç»­çš„ç¾å¤‡ã€‚
3. ä¸¤å¥—é›†ç¾¤æä¾›çš„æ¥å£å’Œæ–¹æ³•å„æœ‰å·®å¼‚ï¼Œéœ€è¦åšé€‚é…ã€‚
4. ä¸èƒ½å½±å“åˆ°ç›®å‰æ­£å¸¸è¿è¡Œçš„ç³»ç»Ÿã€‚

### 1. åœºæ™¯æ¨¡æ‹Ÿå·¥ç¨‹

```java
itstack-demo-design-2-00
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ matter
                â”‚   â”œâ”€â”€ EGM.java
                â”‚   â””â”€â”€ IIR.java
                â””â”€â”€ RedisUtils.java
```

*å·¥ç¨‹ä¸­çš„æ‰€æœ‰ä»£ç å¯ä»¥é€šè¿‡å…³æ³¨å…¬ä¼—å·ï¼š`bugstackè™«æ´æ ˆ`ï¼Œå›å¤`æºç ä¸‹è½½`è¿›è¡Œè·å–ã€‚*

### 2. åœºæ™¯ç®€è¿°

#### 2.1 æ¨¡æ‹Ÿå•æœºæœåŠ¡ RedisUtils

![Rediså•æœºæœåŠ¡](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-04.png)

- æ¨¡æ‹ŸRedisåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å‡å®šç›®å‰æ‰€æœ‰çš„ç³»ç»Ÿéƒ½åœ¨ä½¿ç”¨çš„æœåŠ¡
- ç±»å’Œæ–¹æ³•åç§°éƒ½å›ºå®šå†™æ­»åˆ°å„ä¸ªä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œæ”¹åŠ¨ç•¥å¾®éº»çƒ¦

#### 2.2 æ¨¡æ‹Ÿé›†ç¾¤ EGM

![æ¨¡æ‹Ÿé›†ç¾¤ EGM](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-05.png)

- æ¨¡æ‹Ÿä¸€ä¸ªé›†ç¾¤æœåŠ¡ï¼Œä½†æ˜¯æ–¹æ³•åä¸å„ä¸šåŠ¡ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ–¹æ³•åä¸åŒã€‚æœ‰ç‚¹åƒä½ macï¼Œæˆ‘ç”¨winã€‚åšä¸€æ ·çš„äº‹ï¼Œä½†æœ‰ä¸åŒçš„æ“ä½œã€‚

#### 2.3 æ¨¡æ‹Ÿé›†ç¾¤ IIR

![æ¨¡æ‹Ÿé›†ç¾¤ IIR](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-06.png)

- è¿™æ˜¯å¦å¤–ä¸€å¥—é›†ç¾¤æœåŠ¡ï¼Œæœ‰æ—¶å€™åœ¨ä¼ä¸šå¼€å‘ä¸­å°±å¾ˆæœ‰å¯èƒ½å‡ºç°ä¸¤å¥—æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæ˜¯ä¸ºäº†åšæ¨¡æ‹Ÿæ¡ˆä¾‹ï¼Œæ‰€ä»¥æ·»åŠ ä¸¤å¥—å®ç°åŒæ ·åŠŸèƒ½çš„ä¸åŒæœåŠ¡ï¼Œæ¥å­¦ä¹ æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚

ç»¼ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç›®å‰çš„ç³»ç»Ÿä¸­å·²ç»åœ¨å¤§é‡çš„ä½¿ç”¨redisæœåŠ¡ï¼Œä½†æ˜¯å› ä¸ºç³»ç»Ÿä¸èƒ½æ»¡è¶³ä¸šåŠ¡çš„å¿«é€Ÿå‘å±•ï¼Œå› æ­¤éœ€è¦è¿ç§»åˆ°é›†ç¾¤æœåŠ¡ä¸­ã€‚è€Œè¿™æ—¶æœ‰ä¸¤å¥—é›†ç¾¤æœåŠ¡éœ€è¦å…¼å®¹ä½¿ç”¨ï¼Œåˆè¦æ»¡è¶³æ‰€æœ‰çš„ä¸šåŠ¡ç³»ç»Ÿæ”¹é€ çš„åŒæ—¶ä¸å½±å“çº¿ä¸Šä½¿ç”¨ã€‚

### 3. å•é›†ç¾¤ä»£ç ä½¿ç”¨

ä»¥ä¸‹æ˜¯æ¡ˆä¾‹æ¨¡æ‹Ÿä¸­åŸæœ‰çš„å•é›†ç¾¤Redisä½¿ç”¨æ–¹å¼ï¼Œåç»­ä¼šé€šè¿‡å¯¹è¿™é‡Œçš„ä»£ç è¿›è¡Œæ”¹é€ ã€‚

![å½“å‰åŠŸèƒ½çš„ç±»å›¾ç»“æ„](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-07.png)

### 3.1 å®šä¹‰ä½¿ç”¨æ¥å£

```java
public interface CacheService {

    String get(final String key);

    void set(String key, String value);

    void set(String key, String value, long timeout, TimeUnit timeUnit);

    void del(String key);

}
```

### 3.2 å®ç°è°ƒç”¨ä»£ç 

```java
public class CacheServiceImpl implements CacheService {

    private RedisUtils redisUtils = new RedisUtils();

    public String get(String key) {
        return redisUtils.get(key);
    }

    public void set(String key, String value) {
        redisUtils.set(key, value);
    }

    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        redisUtils.set(key, value, timeout, timeUnit);
    }

    public void del(String key) {
        redisUtils.del(key);
    }

}
```

- ç›®å‰çš„ä»£ç å¯¹äºå½“å‰åœºæ™¯ä¸‹çš„ä½¿ç”¨æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä½†æ˜¯æ‰€æœ‰çš„ä¸šåŠ¡ç³»ç»Ÿéƒ½åœ¨ä½¿ç”¨åŒæ—¶ï¼Œéœ€è¦æ”¹é€ å°±ä¸é‚£ä¹ˆå®¹æ˜“äº†ã€‚è¿™é‡Œå¯ä»¥æ€è€ƒä¸‹ï¼Œçœ‹å¦‚ä½•æ”¹é€ æ‰æ˜¯åˆç†çš„ã€‚

## äº”ã€ç”¨ä¸€å¨å¨ä»£ç å®ç°

`è®²é“ç†æ²¡æœ‰ifelseè§£å†³ä¸äº†çš„é€»è¾‘ï¼Œä¸è¡Œå°±å†åŠ ä¸€è¡Œï¼`

æ­¤æ—¶çš„å®ç°æ–¹å¼å¹¶ä¸ä¼šä¿®æ”¹ç±»ç»“æ„å›¾ï¼Œä¹Ÿå°±æ˜¯ä¸ä¸Šé¢ç»™å‡ºçš„ç±»å±‚çº§å…³ç³»ä¸€è‡´ã€‚é€šè¿‡åœ¨æ¥å£ä¸­æ·»åŠ ç±»å‹å­—æ®µåŒºåˆ†å½“å‰ä½¿ç”¨çš„æ˜¯å“ªä¸ªé›†ç¾¤ï¼Œæ¥ä½œä¸ºä½¿ç”¨çš„åˆ¤æ–­ã€‚å¯ä»¥è¯´ç›®å‰çš„æ–¹å¼éå¸¸éš¾ç”¨ï¼Œå…¶ä»–ä½¿ç”¨æ–¹æ”¹åŠ¨é¢‡å¤šï¼Œè¿™é‡Œåªæ˜¯ä½œä¸ºä¾‹å­ã€‚

### 1. å·¥ç¨‹ç»“æ„

```java
itstack-demo-design-2-01
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ impl
                â”‚   â””â”€â”€ CacheServiceImpl.java
                â””â”€â”€ CacheService.java
```

- æ­¤æ—¶çš„åªæœ‰ä¸¤ä¸ªç±»ï¼Œç±»ç»“æ„éå¸¸ç®€å•ã€‚è€Œæˆ‘ä»¬éœ€è¦çš„è¡¥å……æ‰©å±•åŠŸèƒ½ä¹Ÿåªæ˜¯åœ¨ `CacheServiceImpl` ä¸­å®ç°ã€‚

### 2. ifelseå®ç°éœ€æ±‚

```java
public class CacheServiceImpl implements CacheService {

    private RedisUtils redisUtils = new RedisUtils();

    private EGM egm = new EGM();

    private IIR iir = new IIR();

    public String get(String key, int redisType) {

        if (1 == redisType) {
            return egm.gain(key);
        }

        if (2 == redisType) {
            return iir.get(key);
        }

        return redisUtils.get(key);
    }

    public void set(String key, String value, int redisType) {

        if (1 == redisType) {
            egm.set(key, value);
            return;
        }

        if (2 == redisType) {
            iir.set(key, value);
            return;
        }

        redisUtils.set(key, value);
    }

    //... åŒç±»ä¸åšå¤ªå¤šå±•ç¤ºï¼Œå¯ä»¥ä¸‹è½½æºç è¿›è¡Œå‚è€ƒ

}
```

- è¿™é‡Œçš„å®ç°è¿‡ç¨‹éå¸¸ç®€å•ï¼Œä¸»è¦æ ¹æ®ç±»å‹åˆ¤æ–­æ˜¯å“ªä¸ªRedisé›†ç¾¤ã€‚
- è™½ç„¶å®ç°æ˜¯ç®€å•äº†ï¼Œä½†æ˜¯å¯¹ä½¿ç”¨è€…æ¥è¯´å°±éº»çƒ¦äº†ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆéš¾åº”å¯¹åæœŸçš„æ‹“å±•å’Œä¸åœçš„ç»´æŠ¤ã€‚

### 3. æµ‹è¯•éªŒè¯

æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡junitå•å…ƒæµ‹è¯•çš„æ–¹å¼éªŒè¯æ¥å£æœåŠ¡ï¼Œå¼ºè°ƒæ—¥å¸¸ç¼–å†™å¥½å•æµ‹å¯ä»¥æ›´å¥½çš„æé«˜ç³»ç»Ÿçš„å¥å£®åº¦ã€‚

**ç¼–å†™æµ‹è¯•ç±»ï¼š**

```java
@Test
public void test_CacheService() {
    CacheService cacheService = new CacheServiceImpl();
    cacheService.set("user_name_01", "å°å‚…å“¥", 1);
    String val01 = cacheService.get("user_name_01",1);
    System.out.println(val01);
}
```

**ç»“æœï¼š**

```java
22:26:24.591 [main] INFO  org.itstack.demo.design.matter.EGM - EGMå†™å…¥æ•°æ® keyï¼šuser_name_01 valï¼šå°å‚…å“¥
22:26:24.593 [main] INFO  org.itstack.demo.design.matter.EGM - EGMè·å–æ•°æ® keyï¼šuser_name_01
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥

Process finished with exit code 0
```

- ä»ç»“æœä¸Šçœ‹è¿è¡Œæ­£å¸¸ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†è¿™æ ·çš„ä»£ç åªè¦åˆ°ç”Ÿæˆè¿è¡Œèµ·æ¥ä»¥åï¼Œæƒ³å†æ”¹å°±çœŸçš„éš¾äº†ï¼

## å…­ã€æŠ½è±¡å·¥å‚æ¨¡å¼é‡æ„ä»£ç 

`æ¥ä¸‹æ¥ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼æ¥è¿›è¡Œä»£ç ä¼˜åŒ–ï¼Œä¹Ÿç®—æ˜¯ä¸€æ¬¡å¾ˆå°çš„é‡æ„ã€‚`

è¿™é‡Œçš„æŠ½è±¡å·¥å‚çš„åˆ›å»ºå’Œè·å–æ–¹å¼ï¼Œä¼šé‡‡ç”¨ä»£ç†ç±»çš„æ–¹å¼è¿›è¡Œå®ç°ã€‚æ‰€è¢«ä»£ç†çš„ç±»å°±æ˜¯ç›®å‰çš„Redisæ“ä½œæ–¹æ³•ç±»ï¼Œè®©è¿™ä¸ªç±»åœ¨ä¸éœ€è¦ä»»ä½•ä¿®æ”¹ä¸‹ï¼Œå°±å¯ä»¥å®ç°è°ƒç”¨é›†ç¾¤Aå’Œé›†ç¾¤Bçš„æ•°æ®æœåŠ¡ã€‚

å¹¶ä¸”è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹éå¸¸é‡è¦ï¼Œç”±äºé›†ç¾¤Aå’Œé›†ç¾¤Båœ¨éƒ¨åˆ†æ–¹æ³•æä¾›ä¸Šæ˜¯ä¸åŒçš„ï¼Œå› æ­¤éœ€è¦åšä¸€ä¸ªæ¥å£é€‚é…ï¼Œè€Œè¿™ä¸ªé€‚é…ç±»å°±ç›¸å½“äºå·¥å‚ä¸­çš„å·¥å‚ï¼Œç”¨äºåˆ›å»ºæŠŠä¸åŒçš„æœåŠ¡æŠ½è±¡ä¸ºç»Ÿä¸€çš„æ¥å£åšç›¸åŒçš„ä¸šåŠ¡ã€‚è¿™ä¸€å—ä¸æˆ‘ä»¬ä¸Šä¸€ç« èŠ‚ä¸­çš„`å·¥å‚æ–¹æ³•æ¨¡å‹`ç±»å‹ï¼Œå¯ä»¥ç¿»é˜…å‚è€ƒã€‚

### 1. å·¥ç¨‹ç»“æ„

```java
itstack-demo-design-2-02
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ org.itstack.demo.design
    â”‚           â”œâ”€â”€ factory    
    â”‚           â”‚   â”œâ”€â”€ impl
    â”‚           â”‚   â”‚   â”œâ”€â”€ EGMCacheAdapter.java 
    â”‚           â”‚   â”‚   â””â”€â”€ IIRCacheAdapter.java
    â”‚           â”‚   â”œâ”€â”€ ICacheAdapter.java
    â”‚           â”‚   â”œâ”€â”€ JDKInvocationHandler.java
    â”‚           â”‚   â””â”€â”€ JDKProxy.java
    â”‚           â”œâ”€â”€ impl
    â”‚           â”‚   â””â”€â”€ CacheServiceImpl.java    
    â”‚           â””â”€â”€ CacheService.java 
    â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org.itstack.demo.design.test
                 â””â”€â”€ ApiTest.java
```

**æŠ½è±¡å·¥å‚æ¨¡å‹ç»“æ„**

![æŠ½è±¡å·¥å‚æ¨¡å‹ç»“æ„](https://bugstack.cn/assets/images/2020/itstack-demo-design-2-08.png)

- å·¥ç¨‹ä¸­æ¶‰åŠçš„éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œå¦‚ä¸‹ï¼›
	- `ICacheAdapter`ï¼Œå®šä¹‰äº†é€‚é…æ¥å£ï¼Œåˆ†åˆ«åŒ…è£…ä¸¤ä¸ªé›†ç¾¤ä¸­å·®å¼‚åŒ–çš„æ¥å£åç§°ã€‚`EGMCacheAdapter`ã€`IIRCacheAdapter`
	- `JDKProxy`ã€`JDKInvocationHandler`ï¼Œæ˜¯ä»£ç†ç±»çš„å®šä¹‰å’Œå®ç°ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå°±æ˜¯æŠ½è±¡å·¥å‚çš„å¦å¤–ä¸€ç§å®ç°æ–¹å¼ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼å¯ä»¥å¾ˆå¥½çš„æŠŠåŸæœ‰æ“ä½œRedisçš„æ–¹æ³•è¿›è¡Œä»£ç†æ“ä½œï¼Œé€šè¿‡æ§åˆ¶ä¸åŒçš„å…¥å‚å¯¹è±¡ï¼Œæ§åˆ¶ç¼“å­˜çš„ä½¿ç”¨ã€‚

**å¥½**ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šåˆ†åˆ«è®²è§£å‡ ä¸ªç±»çš„å…·ä½“å®ç°ã€‚

### 2. ä»£ç å®ç°

#### 2.1 å®šä¹‰é€‚é…æ¥å£

```java
public interface ICacheAdapter {

    String get(String key);

    void set(String key, String value);

    void set(String key, String value, long timeout, TimeUnit timeUnit);

    void del(String key);

}
```

- è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯è®©æ‰€æœ‰é›†ç¾¤çš„æä¾›æ–¹ï¼Œèƒ½åœ¨ç»Ÿä¸€çš„æ–¹æ³•åç§°ä¸‹è¿›è¡Œæ“ä½œã€‚ä¹Ÿæ–¹é¢åç»­çš„æ‹“å±•ã€‚

#### 2.2 å®ç°é›†ç¾¤ä½¿ç”¨æœåŠ¡

**EGMCacheAdapter**

```java
public class EGMCacheAdapter implements ICacheAdapter {

    private EGM egm = new EGM();

    public String get(String key) {
        return egm.gain(key);
    }

    public void set(String key, String value) {
        egm.set(key, value);
    }

    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        egm.setEx(key, value, timeout, timeUnit);
    }

    public void del(String key) {
        egm.delete(key);
    }
}
```

**IIRCacheAdapter**

```java
public class IIRCacheAdapter implements ICacheAdapter {

    private IIR iir = new IIR();

    public String get(String key) {
        return iir.get(key);
    }

    public void set(String key, String value) {
        iir.set(key, value);
    }

    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        iir.setExpire(key, value, timeout, timeUnit);
    }

    public void del(String key) {
        iir.del(key);
    }

}
```

- ä»¥ä¸Šä¸¤ä¸ªå®ç°éƒ½éå¸¸å®¹æ˜“ï¼Œåœ¨ç»Ÿä¸€æ–¹æ³•åä¸‹è¿›è¡ŒåŒ…è£…ã€‚

#### 2.3 å®šä¹‰æŠ½è±¡å·¥ç¨‹ä»£ç†ç±»å’Œå®ç°

**JDKProxy**

```java
public static <T> T getProxy(Class<T> interfaceClass, ICacheAdapter cacheAdapter) throws Exception {
    InvocationHandler handler = new JDKInvocationHandler(cacheAdapter);
    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
    Class<?>[] classes = interfaceClass.getInterfaces();
    return (T) Proxy.newProxyInstance(classLoader, new Class[]{classes[0]}, handler);
}
```

- è¿™é‡Œä¸»è¦çš„ä½œç”¨å°±æ˜¯å®Œæˆä»£ç†ç±»ï¼ŒåŒæ—¶å¯¹äºä½¿ç”¨å“ªä¸ªé›†ç¾¤ç”±å¤–éƒ¨é€šè¿‡å…¥å‚è¿›è¡Œä¼ é€’ã€‚

**JDKInvocationHandler**

```java
public class JDKInvocationHandler implements InvocationHandler {

    private ICacheAdapter cacheAdapter;

    public JDKInvocationHandler(ICacheAdapter cacheAdapter) {
        this.cacheAdapter = cacheAdapter;
    }

    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        return ICacheAdapter.class.getMethod(method.getName(), ClassLoaderUtils.getClazzByArgs(args)).invoke(cacheAdapter, args);
    }

}
```

- åœ¨ä»£ç†ç±»çš„å®ç°ä¸­å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œé€šè¿‡ç©¿é€è¿›æ¥çš„é›†ç¾¤æœåŠ¡è¿›è¡Œæ–¹æ³•æ“ä½œã€‚
- å¦å¤–åœ¨`invoke`ä¸­é€šè¿‡ä½¿ç”¨è·å–æ–¹æ³•åç§°åå°„æ–¹å¼ï¼Œè°ƒç”¨å¯¹åº”çš„æ–¹æ³•åŠŸèƒ½ï¼Œä¹Ÿå°±ç®€åŒ–äº†æ•´ä½“çš„ä½¿ç”¨ã€‚
- åˆ°è¿™æˆ‘ä»¬å°±å·²ç»å°†æ•´ä½“çš„åŠŸèƒ½å®ç°å®Œæˆäº†ï¼Œå…³äºæŠ½è±¡å·¥å‚è¿™éƒ¨åˆ†ä¹Ÿå¯ä»¥ä½¿ç”¨éä»£ç†çš„æ–¹å¼è¿›è¡Œå®ç°ã€‚

### 3. æµ‹è¯•éªŒè¯

**ç¼–å†™æµ‹è¯•ç±»ï¼š**

```java
@Test
public void test_CacheService() throws Exception {
    CacheService proxy_EGM = JDKProxy.getProxy(CacheServiceImpl.class, new EGMCacheAdapter());
    proxy_EGM.set("user_name_01","å°å‚…å“¥");
    String val01 = proxy_EGM.get("user_name_01");
    System.out.println(val01);
    
    CacheService proxy_IIR = JDKProxy.getProxy(CacheServiceImpl.class, new IIRCacheAdapter());
    proxy_IIR.set("user_name_01","å°å‚…å“¥");
    String val02 = proxy_IIR.get("user_name_01");
    System.out.println(val02);
}
```

- åœ¨æµ‹è¯•çš„ä»£ç ä¸­é€šè¿‡ä¼ å…¥ä¸åŒçš„é›†ç¾¤ç±»å‹ï¼Œå°±å¯ä»¥è°ƒç”¨ä¸åŒçš„é›†ç¾¤ä¸‹çš„æ–¹æ³•ã€‚`JDKProxy.getProxy(CacheServiceImpl.class, new EGMCacheAdapter());`
- å¦‚æœåç»­æœ‰æ‰©å±•çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§è¿™æ ·çš„ç±»å‹æ–¹å¼è¿›è¡Œè¡¥å……ï¼ŒåŒæ—¶å¯¹äºæ”¹é€ ä¸Šæ¥è¯´å¹¶æ²¡æœ‰æ”¹åŠ¨åŸæ¥çš„æ–¹æ³•ï¼Œé™ä½äº†ä¿®æ”¹æˆæœ¬ã€‚

**ç»“æœï¼š**

```java
23:07:06.953 [main] INFO  org.itstack.demo.design.matter.EGM - EGMå†™å…¥æ•°æ® keyï¼šuser_name_01 valï¼šå°å‚…å“¥
23:07:06.956 [main] INFO  org.itstack.demo.design.matter.EGM - EGMè·å–æ•°æ® keyï¼šuser_name_01
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥
23:07:06.957 [main] INFO  org.itstack.demo.design.matter.IIR - IIRå†™å…¥æ•°æ® keyï¼šuser_name_01 valï¼šå°å‚…å“¥
23:07:06.957 [main] INFO  org.itstack.demo.design.matter.IIR - IIRè·å–æ•°æ® keyï¼šuser_name_01
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥

Process finished with exit code 0
```

- è¿è¡Œç»“æœæ­£å¸¸ï¼Œè¿™æ ·çš„ä»£ç æ»¡è¶³äº†è¿™æ¬¡æ‹“å±•çš„éœ€æ±‚ï¼ŒåŒæ—¶ä½ çš„æŠ€æœ¯èƒ½åŠ›ä¹Ÿç»™è€æ¿ç•™ä¸‹äº†æ·±åˆ»çš„å°è±¡ã€‚
- ç ”å‘è‡ªæˆ‘èƒ½åŠ›çš„æå‡è¿œä¸æ˜¯å¤–æ¥çš„å‹åŠ›å°±æ˜¯ç¼–å†™ä¸€å¨å¨ä»£ç çš„æ¥å£ï¼Œå¦‚æœä½ å·²ç»ç†Ÿç»ƒäº†å¾ˆå¤šæŠ€èƒ½ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨å³ä½¿ç´§æ€¥çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½åšå‡ºå®Œå–„çš„æ–¹æ¡ˆã€‚

## ä¸ƒã€æ€»ç»“

- æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œæ‰€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨ä¸€ä¸ªäº§å“æ—ï¼Œå­˜åœ¨å¤šä¸ªä¸åŒç±»å‹çš„äº§å“(Redisé›†ç¾¤ã€æ“ä½œç³»ç»Ÿ)æƒ…å†µä¸‹ï¼Œæ¥å£é€‰æ‹©çš„é—®é¢˜ã€‚è€Œè¿™ç§åœºæ™¯åœ¨ä¸šåŠ¡å¼€å‘ä¸­ä¹Ÿæ˜¯éå¸¸å¤šè§çš„ï¼Œåªä¸è¿‡å¯èƒ½æœ‰æ—¶å€™æ²¡æœ‰å°†å®ƒä»¬æŠ½è±¡åŒ–å‡ºæ¥ã€‚
- `ä½ çš„ä»£ç åªæ˜¯è¢«ifelseåŸ‹ä¸Šäº†ï¼`å½“ä½ çŸ¥é“ä»€ä¹ˆåœºæ™¯ä¸‹ä½•æ—¶å¯ä»¥è¢«æŠ½è±¡å·¥ç¨‹ä¼˜åŒ–ä»£ç ï¼Œé‚£ä¹ˆä½ çš„ä»£ç å±‚çº§ç»“æ„ä»¥åŠæ»¡è¶³ä¸šåŠ¡éœ€æ±‚ä¸Šï¼Œéƒ½å¯ä»¥å¾—åˆ°å¾ˆå¥½çš„å®ŒæˆåŠŸèƒ½å®ç°å¹¶æå‡æ‰©å±•æ€§å’Œä¼˜é›…åº¦ã€‚
- é‚£ä¹ˆè¿™ä¸ªè®¾è®¡æ¨¡å¼æ»¡è¶³äº†ï¼›å•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ã€è§£è€¦ç­‰ä¼˜ç‚¹ï¼Œä½†å¦‚æœè¯´éšç€ä¸šåŠ¡çš„ä¸æ–­æ‹“å±•ï¼Œå¯èƒ½ä¼šé€ æˆç±»å®ç°ä¸Šçš„å¤æ‚åº¦ã€‚ä½†ä¹Ÿå¯ä»¥è¯´ç®—ä¸ä¸Šç¼ºç‚¹ï¼Œå› ä¸ºå¯ä»¥éšç€å…¶ä»–è®¾è®¡æ–¹å¼çš„å¼•å…¥å’Œä»£ç†ç±»ä»¥åŠè‡ªåŠ¨ç”ŸæˆåŠ è½½çš„æ–¹å¼é™ä½æ­¤é¡¹ç¼ºç‚¹ã€‚
