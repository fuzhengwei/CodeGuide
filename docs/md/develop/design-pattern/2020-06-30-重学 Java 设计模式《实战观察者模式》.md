---
layout: post
category: itstack-demo-design
title: é‡å­¦ Java è®¾è®¡æ¨¡å¼ï¼šå®æˆ˜è§‚å¯Ÿè€…æ¨¡å¼ã€Œæ¨¡æ‹Ÿç±»ä¼¼å°å®¢è½¦æŒ‡æ ‡æ‘‡å·è¿‡ç¨‹ï¼Œç›‘å¬æ¶ˆæ¯é€šçŸ¥ç”¨æˆ·ä¸­ç­¾åœºæ™¯ã€
tagline: by å°å‚…å“¥
tag: [itstack-demo-design]
excerpt: çŸ¥é“çš„è¶Šå¤šä¸çŸ¥é“çš„å°±è¶Šå¤šğŸ˜„ï¼ç¼–ç¨‹å¼€å‘è¿™æ¡è·¯ä¸Šçš„çŸ¥è¯†æ˜¯æ— ç©·æ— å°½çš„ï¼Œå°±åƒä»¥å‰ä½ æ•¢è¯´ç²¾é€šJavaï¼Œåˆ°åæ¥å­¦åˆ°è¶Šæ¥è¶Šå¤šåªæƒ³å†™äº†è§£Javaï¼Œè¿‡äº†å‡ å¹´ç°åœ¨å¯èƒ½æƒ³è¯´æ‡‚ä¸€ç‚¹ç‚¹Javaã€‚ä½†ä¹Ÿæ­£å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“çš„è¶Šå¤šï¼Œæ‰æ›´å¥½çš„ä¸æ–­è®©è‡ªå·±çš„æŠ€æœ¯æ ˆæŠ€èƒ½ä¸æ–­æˆé•¿ï¼ŒæŒç»­åŠ å¼ºã€‚
lock: need
---

# é‡å­¦ Java è®¾è®¡æ¨¡å¼ï¼šå®æˆ˜è§‚å¯Ÿè€…æ¨¡å¼ã€Œæ¨¡æ‹Ÿç±»ä¼¼å°å®¢è½¦æŒ‡æ ‡æ‘‡å·è¿‡ç¨‹ï¼Œç›‘å¬æ¶ˆæ¯é€šçŸ¥ç”¨æˆ·ä¸­ç­¾åœºæ™¯ã€

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=596495360&bvid=BV13B4y1y7HB&cid=716068865&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

## ä¸€ã€å‰è¨€

`çŸ¥é“çš„è¶Šå¤šä¸çŸ¥é“çš„å°±è¶Šå¤š`

ç¼–ç¨‹å¼€å‘è¿™æ¡è·¯ä¸Šçš„çŸ¥è¯†æ˜¯æ— ç©·æ— å°½çš„ï¼Œå°±åƒä»¥å‰ä½ æ•¢è¯´ç²¾é€šJavaï¼Œåˆ°åæ¥å­¦åˆ°è¶Šæ¥è¶Šå¤šåªæƒ³å†™äº†è§£Javaï¼Œè¿‡äº†å‡ å¹´ç°åœ¨å¯èƒ½æƒ³è¯´æ‡‚ä¸€ç‚¹ç‚¹Javaã€‚å½“è§†é‡å’Œæ ¼å±€çš„æ‰©å¤§ï¼Œä¼šè®©æˆ‘ä»¬è¶Šæ¥è¶Šå‘ç°åŸæ¥çš„çœ‹æ³•æ˜¯å¤šä¹ˆæµ…æ˜¾ï¼Œè¿™å°±åƒç«™åœ¨åœ°çƒçœ‹åœ°çƒå’Œç«™åœ¨å®‡å®™çœ‹åœ°çƒä¸€æ ·ã€‚ä½†æ­£å› ä¸ºèƒ¸æ€€å’Œçœ¼ç•Œçš„æå‡è®©æˆ‘ä»¬æœ‰äº†æ›´å¤šçš„è®¤è¯†ï¼Œä¹Ÿé€æ¸å­¦ä¼šäº†æ›´å¤šçš„æŠ€èƒ½ã€‚è™½ç„¶ä¸çŸ¥é“çš„è¶Šæ¥è¶Šå¤šï¼Œä½†ä¹Ÿå› æ­¤ç»™è‡ªå·±å¡«å……äº†æ›´å¤šçš„æŠ€æœ¯æ ˆï¼Œè®©è‡ªå·±è¶Šæ¥è¶Šå¼ºå¤§ã€‚

`æ‹’ç»å­¦ä¹ çš„æƒ°æ€§å¾ˆå¯æ€•`

ç°åœ¨ä¸ä»¥å‰ä¸ä¸€æ ·ï¼Œèµ„æ–™å¤šã€é€”å¾„å¹¿ï¼Œåœ¨è¿™ä¸­é—´å¤¹æ‚çš„å¹¿å‘Šä¹Ÿéå¸¸å¤šã€‚è¿™å°±è®©å¾ˆå¤šåˆå­¦è€…å¾ˆéš¾æ‰¾åˆ°è‡ªå·±è¦çš„çŸ¥è¯†ï¼Œæœ€åçœ‹åˆ°æœ‰äººæ¨èç›¸å…³å­¦ä¹ èµ„æ–™ç«‹åˆ»å±è”½ã€åˆ é™¤ï¼Œä½†åŒæ—¶æŠ€æœ¯ä¼˜ç§€çš„èµ„æ–™ä¹Ÿä¸èƒ½è®©éœ€è¦çš„äººçœ‹è§äº†ã€‚ä¹…è€Œä¹…ä¹‹æŠŠæ›´å¤šçš„æ—¶é—´ç²¾åŠ›éƒ½æ”¾åœ¨æ¸¸æˆã€å¨±ä¹ã€å½±éŸ³ä¸Šï¼Œé€‚å½“çš„æ”¾æ¾æ˜¯å¯ä»¥çš„ï¼Œä½†å¾€å¾€æ²‰è¿·ä»¥åå°±å¾ˆéš¾å‡ºæ¥ï¼Œå› æ­¤éœ€è¦åšå¥½ä¸€äº›å¯ä»¥è®©è‡ªå·±æˆé•¿çš„è®¡åˆ’ï¼Œç¨æœ‰å…‹åˆ¶ã€‚

`å¹³è¡¡å¥½è½¯ä»¶è®¾è®¡å’Œå®ç°æˆæœ¬çš„åº¦Â°`

æœ‰æ—¶å€™ä¸€ä¸ªè½¯ä»¶çš„æ¶æ„è®¾è®¡éœ€è¦ç¬¦åˆå½“å‰æ¡ä»¶ä¸‹çš„å„é¡¹å› ç´ ï¼Œå¾€å¾€ä¸èƒ½å› ä¸ºå¿ƒä¸­æƒ³å½“ç„¶çš„æœ‰æŸä¸ªè“å›¾ï¼Œå°±å»å¼€å§‹æ‰§è¡Œã€‚ä¹Ÿè®¸è™½ç„¶ä½ çš„è®¾è®¡æ˜¯éå¸¸ä¼˜ç§€çš„ï¼Œä½†æ˜¯æ”¾åœ¨å½“å‰ç¯å¢ƒä¸‹å¾ˆéš¾æ»¡è¶³ä¸šåŠ¡çš„æ—¶é—´è¦æ±‚ï¼Œå½“ä¸€ä¸ªä¸šåŠ¡çš„åŸºæœ¬è¯‰æ±‚ä¸èƒ½æ»¡è¶³åï¼Œå°±å¾ˆéš¾æ‹‰åŠ¨å¸‚åœºã€‚æ²¡æœ‰äº§å“çš„DAUæ”¯æ’‘ï¼Œæœ€åæ•´ä¸ªç ”å‘çš„é¡¹ç›®ä¹Ÿä¼šå› æ­¤åœæ»ã€‚ä½†ç ”å‘åˆä¸èƒ½ä¸€å›¢ä¹±éº»çš„å†™ä»£ç ï¼Œå› æ­¤éœ€è¦æ‰¾å¥½ä¸€ä¸ªé€‚åˆçš„åº¦ï¼Œæ¯”å¦‚å¯ä»¥æ­å»ºè‰¯å¥½çš„åœ°åŸºï¼Œå®ç°ä¸Šå¯æ‰©å±•ã€‚ä½†åœ¨å…·ä½“çš„åŠŸèƒ½ä¸Šå¯ä»¥å…ˆç®€åŒ–å®ç°ï¼Œéšç€æ´»ä¸‹æ¥äº†å†ç»§ç»­å®Œå–„è¿­ä»£ã€‚

## äºŒã€å¼€å‘ç¯å¢ƒ

1. JDK 1.8
2. Idea + Maven
3. æ¶‰åŠå·¥ç¨‹ä¸‰ä¸ªï¼Œå¯ä»¥é€šè¿‡å…³æ³¨**å…¬ä¼—å·**ï¼š[`bugstackè™«æ´æ ˆ`](https://bugstack.cn/assets/images/qrcode.png)ï¼Œå›å¤`æºç ä¸‹è½½`è·å–(æ‰“å¼€è·å–çš„é“¾æ¥ï¼Œæ‰¾åˆ°åºå·18)

| å·¥ç¨‹                     | æè¿°                                         |
| ------------------------ | --------------------------------- |
| itstack-demo-design-18-00 | åœºæ™¯æ¨¡æ‹Ÿå·¥ç¨‹ï¼›æ¨¡æ‹Ÿä¸€ä¸ªå°å®¢è½¦æ‘‡å·æ¥å£ |
| itstack-demo-design-18-01 | ä½¿ç”¨ä¸€å¨ä»£ç å®ç°ä¸šåŠ¡éœ€æ±‚ |
| itstack-demo-design-18-02 | é€šè¿‡è®¾è®¡æ¨¡å¼ä¼˜åŒ–æ”¹é€ ä»£ç ï¼Œäº§ç”Ÿå¯¹æ¯”æ€§ä»è€Œå­¦ä¹  |

## ä¸‰ã€è§‚å¯Ÿè€…æ¨¡å¼ä»‹ç»

![è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå›¾ç‰‡æ¥è‡ª refactoringguru.cn](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-01.png)

- å›¾ç‰‡æ¥è‡ªï¼š[https://refactoringguru.cn/design-patterns/observer](https://refactoringguru.cn/design-patterns/observer)

ç®€å•æ¥è®²è§‚å¯Ÿè€…ğŸ•µæ¨¡å¼ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¡Œä¸ºå‘ç”Ÿæ—¶ä¼ é€’ä¿¡æ¯ç»™å¦å¤–ä¸€ä¸ªç”¨æˆ·æ¥æ”¶åšå‡ºç›¸åº”çš„å¤„ç†ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„è€¦åˆå…³è”ã€‚ä¾‹å¦‚ï¼›ç‹™å‡»æ‰‹ã€æäº‘é¾™ã€‚

![æäº‘é¾™ç»™ä½ ç«–å¤§æ‹‡æŒ‡](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-02.png)

é™¤äº†ç”Ÿæ´»ä¸­çš„åœºæ™¯å¤–ï¼Œåœ¨æˆ‘ä»¬ç¼–ç¨‹å¼€å‘ä¸­ä¹Ÿä¼šå¸¸ç”¨åˆ°ä¸€äº›è§‚å¯Ÿè€…çš„æ¨¡å¼æˆ–è€…ç»„ä»¶ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„MQæœåŠ¡ï¼Œè™½ç„¶MQæœåŠ¡æ˜¯æœ‰ä¸€ä¸ªé€šçŸ¥ä¸­å¿ƒå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªç±»æœåŠ¡è¿›è¡Œé€šçŸ¥ï¼Œä½†æ•´ä½“ä¸Šä¹Ÿå¯ä»¥ç®—ä½œæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„æ€è·¯è®¾è®¡ã€‚å†æ¯”å¦‚å¯èƒ½æœ‰åšè¿‡çš„ä¸€äº›ç±»ä¼¼äº‹ä»¶ç›‘å¬æ€»çº¿ï¼Œè®©ä¸»çº¿æœåŠ¡ä¸å…¶ä»–è¾…çº¿ä¸šåŠ¡æœåŠ¡åˆ†ç¦»ï¼Œä¸ºäº†ä½¿ç³»ç»Ÿé™ä½è€¦åˆå’Œå¢å¼ºæ‰©å±•æ€§ï¼Œä¹Ÿä¼šä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è¿›è¡Œå¤„ç†ã€‚

## å››ã€æ¡ˆä¾‹åœºæ™¯æ¨¡æ‹Ÿ

![åœºæ™¯æ¨¡æ‹Ÿï¼›å°å®¢è½¦æŒ‡æ ‡æ‘‡å·é€šçŸ¥åœºæ™¯](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-03.png)

**åœ¨æœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬æ¨¡æ‹Ÿæ¯æ¬¡å°å®¢è½¦æŒ‡æ ‡æ‘‡å·äº‹ä»¶é€šçŸ¥åœºæ™¯(çœŸå®çš„ä¸ä¼šç”±å®˜ç½‘ç»™ä½ å‘æ¶ˆæ¯)**

å¯èƒ½å¤§éƒ¨åˆ†äººçœ‹åˆ°è¿™ä¸ªæ¡ˆä¾‹ä¸€å®šä¼šæƒ³åˆ°è‡ªå·±æ¯æ¬¡æ‘‡å·éƒ½ä¸ä¸­çš„åœºæ™¯ï¼Œæ”¶åˆ°ä¸€ä¸ªé—æ†¾çš„çŸ­ä¿¡é€šçŸ¥ã€‚å½“ç„¶ç›®å‰çš„æ‘‡å·ç³»ç»Ÿå¹¶ä¸ä¼šç»™ä½ å‘çŸ­ä¿¡ï¼Œè€Œæ˜¯ç”±ç™¾åº¦æˆ–è€…ä¸€äº›å…¶ä»–æ’ä»¶å‘çš„çŸ­ä¿¡ã€‚é‚£ä¹ˆå‡å¦‚è¿™ä¸ªç±»ä¼¼çš„æ‘‡å·åŠŸèƒ½å¦‚æœç”±ä½ æ¥å¼€å‘ï¼Œå¹¶ä¸”éœ€è¦å¯¹å¤–éƒ¨çš„ç”¨æˆ·åšä¸€äº›äº‹ä»¶é€šçŸ¥ä»¥åŠéœ€è¦åœ¨ä¸»æµç¨‹å¤–å†æ·»åŠ ä¸€äº›é¢å¤–çš„è¾…åŠ©æµç¨‹æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

åŸºæœ¬å¾ˆå¤šäººå¯¹äºè¿™æ ·çš„é€šçŸ¥äº‹ä»¶ç±»çš„å®ç°å¾€å¾€æ¯”è¾ƒç²—çŠ·ï¼Œç›´æ¥åœ¨ç±»é‡Œé¢å°±æ·»åŠ äº†ã€‚1æ˜¯è€ƒè™‘ğŸ¤”è¿™å¯èƒ½ä¸ä¼šæ€ä¹ˆæ‰©å±•ï¼Œ2æ˜¯å‹æ ¹å°±æ²¡è€ƒè™‘ğŸ˜„è¿‡ã€‚ä½†å¦‚æœä½ æœ‰ä»”ç»†æ€è€ƒè¿‡ä½ çš„æ ¸å¿ƒç±»åŠŸèƒ½ä¼šå‘ç°ï¼Œè¿™é‡Œé¢æœ‰ä¸€äº›æ ¸å¿ƒä¸»é“¾è·¯ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯è¾…åŠ©åŠŸèƒ½ã€‚æ¯”å¦‚å®Œæˆäº†æŸä¸ªè¡Œä¸ºåéœ€è¦è§¦å‘MQç»™å¤–éƒ¨ï¼Œä»¥åŠåšä¸€äº›æ¶ˆæ¯PUSHç»™ç”¨æˆ·ç­‰ï¼Œè¿™äº›éƒ½ä¸ç®—åšæ˜¯æ ¸å¿ƒæµç¨‹é“¾è·¯ï¼Œæ˜¯å¯ä»¥é€šè¿‡äº‹ä»¶é€šçŸ¥çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨è¿™æ ·çš„è®¾è®¡æ¨¡å¼æ¥ä¼˜åŒ–é‡æ„æ­¤åœºæ™¯ä¸‹çš„ä»£ç ã€‚

### 1. åœºæ™¯æ¨¡æ‹Ÿå·¥ç¨‹

```java
itstack-demo-design-18-00
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â””â”€â”€ MinibusTargetService.java
```

- è¿™é‡Œæä¾›çš„æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå°å®¢è½¦æ‘‡å·çš„æœåŠ¡æ¥å£ã€‚

### 2. åœºæ™¯ç®€è¿°

#### 2.1 æ‘‡å·æœåŠ¡æ¥å£

```java
public class MinibusTargetService {

    /**
     * æ¨¡æ‹Ÿæ‘‡å·ï¼Œä½†ä¸æ˜¯æ‘‡å·ç®—æ³•
     *
     * @param uId ç”¨æˆ·ç¼–å·
     * @return ç»“æœ
     */
    public String lottery(String uId) {
        return Math.abs(uId.hashCode()) % 2 == 0 ? "æ­å–œä½ ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·ä¸­ç­¾") : "å¾ˆé—æ†¾ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ");
    }

}
```

- éå¸¸ç®€å•çš„ä¸€ä¸ªæ¨¡æ‹Ÿæ‘‡å·æ¥å£ï¼Œä¸çœŸå®å…¬å¹³çš„æ‘‡å·æ˜¯æœ‰å·®åˆ«çš„ã€‚

## äº”ã€ç”¨ä¸€å¨å¨ä»£ç å®ç°

`è¿™é‡Œæˆ‘ä»¬å…ˆä½¿ç”¨æœ€ç²—æš´çš„æ–¹å¼æ¥å®ç°åŠŸèƒ½`

æŒ‰ç…§éœ€æ±‚éœ€è¦åœ¨åŸæœ‰çš„æ‘‡å·æ¥å£ä¸­æ·»åŠ MQæ¶ˆæ¯å‘é€ä»¥åŠçŸ­æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ï¼Œå¦‚æœæ˜¯æœ€ç›´æ¥çš„æ–¹å¼é‚£ä¹ˆå¯ä»¥ç›´æ¥åœ¨æ–¹æ³•ä¸­è¡¥å……åŠŸèƒ½å³å¯ã€‚

### 1. å·¥ç¨‹ç»“æ„

```java
itstack-demo-design-18-01
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java
```

- è¿™æ®µä»£ç æ¥å£ä¸­åŒ…æ‹¬äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼›è¿”å›å¯¹è±¡(`LotteryResult`)ã€å®šä¹‰æ¥å£(`LotteryService`)ã€å…·ä½“å®ç°(`LotteryServiceImpl`)ã€‚

### 2. ä»£ç å®ç°

```java
public class LotteryServiceImpl implements LotteryService {

    private Logger logger = LoggerFactory.getLogger(LotteryServiceImpl.class);

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    public LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // å‘çŸ­ä¿¡
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", uId, lottery);
        // å‘MQæ¶ˆæ¯
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", uId, lottery);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}
```

- ä»ä»¥ä¸Šçš„æ–¹æ³•å®ç°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä½“è¿‡ç¨‹åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼›æ‘‡å·ã€å‘çŸ­ä¿¡ã€å‘MQæ¶ˆæ¯ï¼Œè€Œè¿™éƒ¨åˆ†éƒ½æ˜¯é¡ºåºè°ƒç”¨çš„ã€‚
- é™¤äº†`æ‘‡å·`æ¥å£è°ƒç”¨å¤–ï¼Œåé¢çš„ä¸¤éƒ¨åˆ†éƒ½æ˜¯éæ ¸å¿ƒä¸»é“¾è·¯åŠŸèƒ½ï¼Œè€Œä¸”ä¼šéšç€åç»­çš„ä¸šåŠ¡éœ€æ±‚å‘å±•è€Œä¸æ–­çš„è°ƒæ•´å’Œæ‰©å……ï¼Œåœ¨è¿™æ ·çš„å¼€å‘æ–¹å¼ä¸‹å°±éå¸¸ä¸åˆ©äºç»´æŠ¤ã€‚

### 3. æµ‹è¯•éªŒè¯

#### 3.1 ç¼–å†™æµ‹è¯•ç±»

```java
@Test
public void test() {
    LotteryService lotteryService = new LotteryServiceImpl();
    LotteryResult result = lotteryService.doDraw("2765789109876");
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(result));
}
```

- æµ‹è¯•è¿‡ç¨‹ä¸­æä¾›å¯¹æ‘‡å·æœåŠ¡æ¥å£çš„è°ƒç”¨ã€‚

#### 3.2 æµ‹è¯•ç»“æœ

```java
22:02:24.520 [main] INFO  o.i.demo.design.LotteryServiceImpl - ç»™ç”¨æˆ· 2765789109876 å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼šå¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ
22:02:24.523 [main] INFO  o.i.demo.design.LotteryServiceImpl - è®°å½•ç”¨æˆ· 2765789109876 æ‘‡å·ç»“æœ(MQ)ï¼šå¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ
22:02:24.606 [main] INFO  org.itstack.demo.design.ApiTest - æµ‹è¯•ç»“æœï¼š{"dateTime":1598764144524,"msg":"å¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ","uId":"2765789109876"}

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœä¸Šæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œä¹Ÿæ˜¯å¹³å¸¸å¼€å‘ä»£ç çš„æ–¹å¼ï¼Œè¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚

## å…­ã€è§‚å¯Ÿè€…æ¨¡å¼é‡æ„ä»£ç 

`æ¥ä¸‹æ¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥è¿›è¡Œä»£ç ä¼˜åŒ–ï¼Œä¹Ÿç®—æ˜¯ä¸€æ¬¡å¾ˆå°çš„é‡æ„ã€‚`

### 1. å·¥ç¨‹ç»“æ„ 

```java
itstack-demo-design-18-02
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ event
                â”‚    â”œâ”€â”€ listener
                â”‚    â”‚    â”œâ”€â”€ EventListener.java
                â”‚    â”‚    â”œâ”€â”€ MessageEventListener.java
                â”‚    â”‚    â””â”€â”€ MQEventListener.java
                â”‚    â””â”€â”€ EventManager.java
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java
```

**è§‚å¯Ÿè€…æ¨¡å¼æ¨¡å‹ç»“æ„**  

![è§‚å¯Ÿè€…æ¨¡å¼æ¨¡å‹ç»“æ„](https://bugstack.cn/assets/images/2020/itstack-demo-design-18-04.png)

- ä»ä¸Šå›¾å¯ä»¥åˆ†ä¸ºä¸‰å¤§å—çœ‹ï¼›`äº‹ä»¶ç›‘å¬`ã€`äº‹ä»¶å¤„ç†`ã€`å…·ä½“çš„ä¸šåŠ¡æµç¨‹`ï¼Œå¦å¤–åœ¨ä¸šåŠ¡æµç¨‹ä¸­ `LotteryService` å®šä¹‰çš„æ˜¯æŠ½è±¡ç±»ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é€šè¿‡æŠ½è±¡ç±»å°†äº‹ä»¶åŠŸèƒ½å±è”½ï¼Œå¤–éƒ¨ä¸šåŠ¡æµç¨‹å¼€å‘è€…ä¸éœ€è¦çŸ¥é“å…·ä½“çš„é€šçŸ¥æ“ä½œã€‚
- å³ä¸‹è§’åœ†åœˆå›¾è¡¨ç¤ºçš„æ˜¯æ ¸å¿ƒæµç¨‹ä¸éæ ¸å¿ƒæµç¨‹çš„ç»“æ„ï¼Œä¸€èˆ¬åœ¨å¼€å‘ä¸­ä¼šæŠŠä¸»çº¿æµç¨‹å¼€å‘å®Œæˆåï¼Œå†ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼å¤„ç†è¾…åŠ©æµç¨‹ã€‚ä»–ä»¬å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨MQä»¥åŠå®šæ—¶ä»»åŠ¡çš„å¤„ç†ä¸‹ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

### 2. ä»£ç å®ç°

#### 2.1 äº‹ä»¶ç›‘å¬æ¥å£å®šä¹‰

```java
public interface EventListener {

    void doEvent(LotteryResult result);

}
```

- æ¥å£ä¸­å®šä¹‰äº†åŸºæœ¬çš„äº‹ä»¶ç±»ï¼Œè¿™é‡Œå¦‚æœæ–¹æ³•çš„å…¥å‚ä¿¡æ¯ç±»å‹æ˜¯å˜åŒ–çš„å¯ä»¥ä½¿ç”¨æ³›å‹`<T>`

#### 2.2 ä¸¤ä¸ªç›‘å¬äº‹ä»¶çš„å®ç°

**çŸ­æ¶ˆæ¯äº‹ä»¶**

```java
public class MessageEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MessageEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", result.getuId(), result.getMsg());
    }

}
```

**MQå‘é€äº‹ä»¶**

```java
public class MQEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MQEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", result.getuId(), result.getMsg());
    }

}
```

- ä»¥ä¸Šæ˜¯ä¸¤ä¸ªäº‹ä»¶çš„å…·ä½“å®ç°ï¼Œç›¸å¯¹æ¥è¯´éƒ½æ¯”è¾ƒç®€å•ã€‚å¦‚æœæ˜¯å®é™…çš„ä¸šåŠ¡å¼€å‘é‚£ä¹ˆä¼šéœ€è¦è°ƒç”¨å¤–éƒ¨æ¥å£ä»¥åŠæ§åˆ¶å¼‚å¸¸çš„å¤„ç†ã€‚
- åŒæ—¶æˆ‘ä»¬ä¸Šé¢æåˆ°äº‹ä»¶æ¥å£æ·»åŠ æ³›å‹ï¼Œå¦‚æœæœ‰éœ€è¦é‚£ä¹ˆåœ¨äº‹ä»¶çš„å®ç°ä¸­å°±å¯ä»¥æŒ‰ç…§ä¸åŒçš„ç±»å‹è¿›è¡ŒåŒ…è£…äº‹ä»¶å†…å®¹ã€‚

#### 2.3 äº‹ä»¶å¤„ç†ç±»

```java
public class EventManager {

    Map<Enum<EventType>, List<EventListener>> listeners = new HashMap<>();

    public EventManager(Enum<EventType>... operations) {
        for (Enum<EventType> operation : operations) {
            this.listeners.put(operation, new ArrayList<>());
        }
    }

    public enum EventType {
        MQ, Message
    }

    /**
     * è®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void subscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.add(listener);
    }

    /**
     * å–æ¶ˆè®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void unsubscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.remove(listener);
    }

    /**
     * é€šçŸ¥
     * @param eventType äº‹ä»¶ç±»å‹
     * @param result    ç»“æœ
     */
    public void notify(Enum<EventType> eventType, LotteryResult result) {
        List<EventListener> users = listeners.get(eventType);
        for (EventListener listener : users) {
            listener.doEvent(result);
        }
    }

}
```

- æ•´ä¸ªå¤„ç†çš„å®ç°ä¸Šæä¾›äº†ä¸‰ä¸ªä¸»è¦æ–¹æ³•ï¼›è®¢é˜…(`subscribe`)ã€å–æ¶ˆè®¢é˜…(`unsubscribe`)ã€é€šçŸ¥(`notify`)ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºå¯¹ç›‘å¬æ—¶é—´çš„æ·»åŠ å’Œä½¿ç”¨ã€‚
- å¦å¤–å› ä¸ºäº‹ä»¶æœ‰ä¸åŒçš„ç±»å‹ï¼Œè¿™é‡Œä½¿ç”¨äº†æšä¸¾çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä¹Ÿæ–¹ä¾¿è®©å¤–éƒ¨åœ¨è§„å®šä¸‹ä½¿ç”¨äº‹ä»¶ï¼Œè€Œä¸è‡³äºä¹±ä¼ ä¿¡æ¯(`EventType.MQ`ã€`EventType.Message`)ã€‚

#### 2.4 ä¸šåŠ¡æŠ½è±¡ç±»æ¥å£

```java
public abstract class LotteryService {

    private EventManager eventManager;

    public LotteryService() {
        eventManager = new EventManager(EventManager.EventType.MQ, EventManager.EventType.Message);
        eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener());
        eventManager.subscribe(EventManager.EventType.Message, new MessageEventListener());
    }

    public LotteryResult draw(String uId) {
        LotteryResult lotteryResult = doDraw(uId);
        // éœ€è¦ä»€ä¹ˆé€šçŸ¥å°±ç»™è°ƒç”¨ä»€ä¹ˆæ–¹æ³•
        eventManager.notify(EventManager.EventType.MQ, lotteryResult);
        eventManager.notify(EventManager.EventType.Message, lotteryResult);
        return lotteryResult;
    }

    protected abstract LotteryResult doDraw(String uId);

}
```

- è¿™ç§ä½¿ç”¨æŠ½è±¡ç±»çš„æ–¹å¼å®šä¹‰å®ç°æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ–¹æ³•ä¸­æ‰©å±•éœ€è¦çš„é¢å¤–è°ƒç”¨ã€‚å¹¶æä¾›æŠ½è±¡ç±»`abstract LotteryResult doDraw(String uId)`ï¼Œè®©ç±»çš„ç»§æ‰¿è€…å®ç°ã€‚
- åŒæ—¶æ–¹æ³•çš„å®šä¹‰ä½¿ç”¨çš„æ˜¯`protected`ï¼Œä¹Ÿå°±æ˜¯ä¿è¯å°†æ¥å¤–éƒ¨çš„è°ƒç”¨æ–¹ä¸ä¼šè°ƒç”¨åˆ°æ­¤æ–¹æ³•ï¼Œåªæœ‰è°ƒç”¨åˆ°`draw(String uId)`ï¼Œæ‰èƒ½è®©æˆ‘ä»¬å®Œæˆäº‹ä»¶é€šçŸ¥ã€‚
- æ­¤ç§æ–¹å¼çš„å®ç°å°±æ˜¯åœ¨æŠ½è±¡ç±»ä¸­å†™å¥½ä¸€ä¸ªåŸºæœ¬çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­å®Œæˆæ–°å¢é€»è¾‘çš„åŒæ—¶ï¼Œå†å¢åŠ æŠ½è±¡ç±»çš„ä½¿ç”¨ã€‚è€Œè¿™ä¸ªæŠ½è±¡ç±»çš„å®šä¹‰ä¼šæœ‰ç»§æ‰¿è€…å®ç°ã€‚
- å¦å¤–åœ¨æ„é€ å‡½æ•°ä¸­æä¾›äº†å¯¹äº‹ä»¶çš„å®šä¹‰ï¼›`eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener())`ã€‚
- åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨æšä¸¾çš„æ–¹å¼è¿›è¡Œé€šçŸ¥ä½¿ç”¨ï¼Œä¼ äº†ä»€ä¹ˆç±»å‹`EventManager.EventType.MQ`ï¼Œå°±ä¼šæ‰§è¡Œä»€ä¹ˆäº‹ä»¶é€šçŸ¥ï¼ŒæŒ‰éœ€æ·»åŠ ã€‚

#### 2.5 ä¸šåŠ¡æ¥å£å®ç°ç±»

```java
public class LotteryServiceImpl extends LotteryService {

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    @Override
    protected LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}
```

- ç°åœ¨å†çœ‹ä¸šåŠ¡æµç¨‹çš„å®ç°ä¸­å¯ä»¥çœ‹åˆ°å·²ç»éå¸¸ç®€å•äº†ï¼Œæ²¡æœ‰é¢å¤–çš„è¾…åŠ©æµç¨‹ï¼Œåªæœ‰æ ¸å¿ƒæµç¨‹çš„å¤„ç†ã€‚

### 3. æµ‹è¯•éªŒè¯

#### 3.1 ç¼–å†™æµ‹è¯•ç±»

```java
@Test
public void test() {
    LotteryService lotteryService = new LotteryServiceImpl();
    LotteryResult result = lotteryService.draw("2765789109876");
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(result));
}
```

- ä»è°ƒç”¨ä¸Šæ¥çœ‹å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯è¿™æ ·çš„å®ç°æ–¹å¼å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„ç»´æŠ¤ä»£ç ä»¥åŠæ‰©å±•æ–°çš„éœ€æ±‚ã€‚

#### 3.2 æµ‹è¯•ç»“æœ

```java
23:56:07.597 [main] INFO  o.i.d.d.e.listener.MQEventListener - è®°å½•ç”¨æˆ· 2765789109876 æ‘‡å·ç»“æœ(MQ)ï¼šå¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ
23:56:07.600 [main] INFO  o.i.d.d.e.l.MessageEventListener - ç»™ç”¨æˆ· 2765789109876 å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼šå¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ
23:56:07.698 [main] INFO  org.itstack.demo.design.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"dateTime":1599737367591,"msg":"å¾ˆé—æ†¾ï¼Œç¼–ç 2765789109876åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ","uId":"2765789109876"}

Process finished with exit code 0
```

- ä»æµ‹è¯•ç»“æœä¸Šçœ‹æ»¡è¶³ğŸ˜Œæˆ‘ä»¬çš„é¢„æœŸï¼Œè™½ç„¶ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†åªæœ‰æˆ‘ä»¬çŸ¥é“äº†è®¾è®¡æ¨¡å¼çš„é­…åŠ›æ‰€åœ¨ã€‚

## ä¸ƒã€æ€»ç»“

- ä»æˆ‘ä»¬æœ€åŸºæœ¬çš„è¿‡ç¨‹å¼å¼€å‘ä»¥åŠåæ¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼é¢å‘å¯¹è±¡å¼€å‘ï¼Œå¯ä»¥çœ‹åˆ°è®¾è®¡æ¨¡å¼æ”¹é€ åï¼Œæ‹†åˆ†å‡ºäº†æ ¸å¿ƒæµç¨‹ä¸è¾…åŠ©æµç¨‹çš„ä»£ç ã€‚ä¸€èˆ¬ä»£ç ä¸­çš„æ ¸å¿ƒæµç¨‹ä¸ä¼šç»å¸¸å˜åŒ–ã€‚ä½†è¾…åŠ©æµç¨‹ä¼šéšç€ä¸šåŠ¡çš„å„ç§å˜åŒ–è€Œå˜åŒ–ï¼ŒåŒ…æ‹¬ï¼›`è¥é”€`ã€`è£‚å˜`ã€`ä¿ƒæ´»`ç­‰ç­‰ï¼Œå› æ­¤ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¶è®¾ä»£ç å°±æ˜¾å¾—éå¸¸æœ‰å¿…è¦ã€‚
- æ­¤ç§è®¾è®¡æ¨¡å¼ä»ç»“æ„ä¸Šæ˜¯æ»¡è¶³å¼€é—­åŸåˆ™çš„ï¼Œå½“ä½ éœ€è¦æ–°å¢å…¶ä»–çš„ç›‘å¬äº‹ä»¶æˆ–è€…ä¿®æ”¹ç›‘å¬é€»è¾‘ï¼Œæ˜¯ä¸éœ€è¦æ”¹åŠ¨äº‹ä»¶å¤„ç†ç±»çš„ã€‚ä½†æ˜¯å¯èƒ½ä½ ä¸èƒ½æ§åˆ¶è°ƒç”¨é¡ºåºä»¥åŠéœ€è¦åšä¸€äº›äº‹ä»¶ç»“æœçš„è¿”å›ç»§ç»­æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨çš„è¿‡ç¨‹æ—¶éœ€è¦è€ƒè™‘åœºæ™¯çš„åˆç†æ€§ã€‚
- ä»»ä½•ä¸€ç§è®¾è®¡æ¨¡å¼æœ‰æ—¶å€™éƒ½ä¸æ˜¯å•ç‹¬ä½¿ç”¨çš„ï¼Œéœ€è¦ç»“åˆå…¶ä»–æ¨¡å¼å…±åŒå»ºè®¾ã€‚å¦å¤–è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨æ˜¯ä¸ºäº†è®©ä»£ç æ›´åŠ æ˜“äºæ‰©å±•å’Œç»´æŠ¤ï¼Œä¸èƒ½å› ä¸ºæ·»åŠ è®¾è®¡æ¨¡å¼è€ŒæŠŠç»“æ„å¤„ç†æ›´åŠ å¤æ‚ä»¥åŠéš¾ä»¥ç»´æŠ¤ã€‚è¿™æ ·çš„åˆç†ä½¿ç”¨çš„ç»éªŒéœ€è¦å¤§é‡çš„å®é™…æ“ä½œç»ƒä¹ è€Œæ¥ã€‚







