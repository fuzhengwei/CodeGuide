---
title: Mock
lock: need
---

# Mock å•å…ƒæµ‹è¯•&æ’ä»¶ç”Ÿæˆæµ‹è¯•ä»£ç 

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=492503304&bvid=BV1mN411x7rJ&cid=1311297417&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

æœ¬æ–‡çš„å®—æ—¨åœ¨äºé€šè¿‡ç®€å•å¹²å‡€å®è·µçš„æ–¹å¼æ•™ä¼šè¯»è€…ï¼Œå¦‚ä½•ä½¿ç”¨ [Mock](https://zh.wikipedia.org/wiki/%E6%A8%A1%E6%8B%9F%E5%AF%B9%E8%B1%A1) è¿›è¡Œå·¥ç¨‹çš„å•å…ƒæµ‹è¯•ï¼Œä»¥ä¾¿äºéªŒè¯ç³»ç»Ÿä¸­çš„ç‹¬ç«‹æ¨¡å—åŠŸèƒ½çš„å¥å£®æ€§ã€‚

ä»æ•´ä¸ªå·¥ç¨‹æ‰€å¤„ä¸åŒé˜¶æ®µçš„æµ‹è¯•æ‰‹æ®µåŒ…æ‹¬ï¼›å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç³»ç»Ÿæµ‹è¯•ã€éªŒæ”¶æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å®‰å…¨æµ‹è¯•ã€å›å½’æµ‹è¯•ï¼Œä»¥åŠå…¼å®¹ã€å¯é ã€å¯ç”¨æ€§æµ‹è¯•ã€‚

è€Œå•å…ƒæµ‹è¯•çš„é‡ç‚¹åœ¨äºï¼Œå¯¹å·¥ç¨‹å¼€å‘ä¸­çš„ä»£ç ï¼Œè¿›è¡Œæµç¨‹ä¸­çš„å•å…ƒåŒ–æµ‹è¯•ã€‚å¦‚ä¸€æ•´ä¸ªä¸‹å•æµç¨‹ä¸­ï¼Œéœ€è¦è°ƒç”¨å„é¡¹å¤–éƒ¨çš„æ¥å£(é£æ§ã€è´¦æˆ·ã€è¥é”€ã€è¯•ç®—ã€æ”¯ä»˜)ï¼Œæ‰èƒ½å®Œæˆæ•´ä¸ªä¸‹å•æµç¨‹ã€‚ä½†åœ¨æœ¬åœ°å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸å¤ªèƒ½å°†æ‰€æœ‰çš„å¤–éƒ¨æ¥å£éƒ½è°ƒè¯•ä¸ºå¼€å‘ç¯å¢ƒå¯ç”¨çŠ¶æ€ï¼Œæ‰€æœ‰è¿™ä¸ªæ—¶å€™è¦åšå•å…ƒåŒ–æµ‹è¯•ï¼Œå¯¹äºä¸€äº›ä¸èƒ½éšæ—¶æä¾›æœåŠ¡çš„æ¥å£è¿›è¡Œ [Mock](https://zh.wikipedia.org/wiki/%E6%A8%A1%E6%8B%9F%E5%AF%B9%E8%B1%A1) å¤„ç†ã€‚

æœ¬æ–‡æ¶‰åŠçš„å·¥ç¨‹ï¼š

- xfg-dev-tech-mockï¼š[https://gitcode.net/KnowledgePlanet/road-map/xfg-dev-tech-mock](https://gitcode.net/KnowledgePlanet/road-map/xfg-dev-tech-mock)
- chatglm-sdk-javaï¼š[https://gitcode.net/KnowledgePlanet/road-map/chatglm-sdk-java](https://gitcode.net/KnowledgePlanet/road-map/chatglm-sdk-java)

## ä¸€ã€æ¡ˆä¾‹èƒŒæ™¯

å› ä¸º Mock å•å…ƒæµ‹è¯•çš„é‡ç‚¹ï¼Œä¸»è¦ä½“ç°åœ¨ï¼›åŠŸèƒ½æµç¨‹è¾ƒé•¿ã€è°ƒç”¨å¤–éƒ¨æ¥å£ç¨³å®šæ€§è¾ƒå·®ã€æµ‹è¯•è¿‡ç¨‹ä¸­å¸Œæœ›å¯ä»¥ä¸å¯åŠ¨ SpringBoot åº”ç”¨å°±èƒ½å¯¹å•ä¸ªåŠŸèƒ½æ¨¡å—è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚

æ‰€ä»¥æœ¬ç« èŠ‚å¸¦ç€è¿™æ ·ä¸€ä¸ªæ¡ˆä¾‹èƒŒæ™¯çš„æƒ…å†µï¼Œå°å‚…å“¥å¸¦ç€å¤§å®¶æŠŠ [ã€ŠHTTP æ¡†æ¶ä½¿ç”¨å’Œåœºæ™¯å®æˆ˜ - ç»“åˆChatGLMè‡ªåŠ¨å›å¸–ï¼ã€‹](https://bugstack.cn/md/road-map/http.html) åšä¸€ä¸ªå°é‡æ„ã€‚æ¥å¯¹ Mock æ¡†æ¶è¿›è¡ŒéªŒè¯ä½¿ç”¨ã€‚

<div align="center">
    <img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-mock-01.png" width="650px">
</div>

- é¦–å…ˆï¼Œè¿™é‡Œä½¿ç”¨ DDD å·¥ç¨‹æ¨¡å‹ç»“æ„ï¼Œæ­å»ºå‡ºæµ‹è¯•å·¥ç¨‹ã€‚â€”â€” DDD æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•ï¼Œè€Œè½¯ä»¶çš„è®¾è®¡æ–¹æ³•æ¶µç›–äº†ï¼›èŒƒå¼ã€æ¨¡å‹ã€æ¡†æ¶ã€æ–¹æ³•è®ºã€‚æ‰€ä»¥é€šå¸¸ä¸‹ MVC ä¸ DDD çš„å¯¹æ¯”å…ˆä»æ¨¡å‹ã€æ¡†æ¶åœ¨åˆ°æ€æƒ³è®¾è®¡å’Œæ–¹æ³•è®ºã€‚
- ä¹‹åï¼Œæˆ‘ä»¬åœ¨è¿™æ ·çš„ä¸€ä¸ªæ¨¡å‹ç»“æ„ä¸‹ï¼Œå®ç°å‡ºè‡ªåŠ¨å›å¸–çš„é¢†åŸŸåŠŸèƒ½ã€‚è€Œè¿™ä¸ªæ¨¡å‹çš„å®ç°æ°å¥½éœ€è¦è°ƒç”¨å¤–éƒ¨çš„æ¥å£å’Œ ChatGLM SDKï¼Œè¿™ä¸æˆ‘ä»¬è¦åšçš„ Mock æµ‹è¯•æ­£å¥½ç¬¦åˆï¼Œå› ä¸ºåœ¨å¤§éƒ¨åˆ†å¼€å‘åœºæ™¯ä¸‹ï¼Œè¿œç¨‹çš„ HTTP è°ƒç”¨å¯èƒ½ä¸ä¸ä¼šä¸€ç›´å¯ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ Mock æ–¹å¼è¿›è¡Œæ¨¡æ‹Ÿã€‚

## äºŒã€åŠŸèƒ½å®ç°

### 1. å·¥ç¨‹ç»“æ„

<div align="center">
    <img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-mock-02.png" width="450px">
</div>

- åœ¨ domain ä¸­å®ç°ä¸€ä¸ªzsxqçš„è‡ªåŠ¨å›å¸–é¢†åŸŸï¼Œè€Œå®ƒæ‰€éœ€çš„è¦è°ƒç”¨çš„æ¥å£åˆ™ç”±åŸºç¡€è®¾æ–½å±‚æä¾›ã€‚
- å¦å¤–åœ¨ app ä¸­è¿˜æœ‰ ChatGLM SDK çš„é…ç½®å¯åŠ¨ï¼Œä¹Ÿä¼šè¢«æ³¨å…¥åˆ° AiReply å®ç°ç±»ä¸­ã€‚

### 2. Aiæ¨¡å—å¯åŠ¨

```yml
# ChatGLM SDK Config
chatglm:
  sdk:
    config:
      # çŠ¶æ€ï¼›true = å¼€å¯ã€false å…³é—­
      enabled: false
      # å®˜ç½‘åœ°å€
      api-host: https://open.bigmodel.cn/
      # å®˜ç½‘ç”³è¯· https://open.bigmodel.cn/usercenter/apikeys
      api-secret-key: d570f7c5d289cdac2abdfdc562e39f3f.trqz1dH8ZK6ED7Pg
```

```java
@Bean
@ConditionalOnProperty(value = "chatglm.sdk.config.enabled", havingValue = "true", matchIfMissing = false)
public OpenAiSession openAiSession(ChatGLMSDKConfigProperties properties) {
    // 1. é…ç½®æ–‡ä»¶
    cn.bugstack.chatglm.session.Configuration configuration = new cn.bugstack.chatglm.session.Configuration();
    configuration.setApiHost(properties.getApiHost());
    configuration.setApiSecretKey(properties.getApiSecretKey());
    // 2. ä¼šè¯å·¥å‚
    OpenAiSessionFactory factory = new DefaultOpenAiSessionFactory(configuration);
    // 3. å¼€å¯ä¼šè¯
    return factory.openSession();
}
```

- æ‰€æœ‰çš„è¿™äº›é…ç½®ç±»çš„æœåŠ¡ï¼Œéƒ½å¯ä»¥æ”¾åˆ° appä¸‹çš„ config æ¨¡å—ä¸­ã€‚
- ChatGLM å¯ä»¥ç›´æ¥åœ¨å®˜ç½‘ç”³è¯·ï¼Œé»˜è®¤ä¼šèµ é€18å…ƒçš„é¢åº¦ï¼Œå¯¹äºå®ƒæ‰€æä¾›çš„æ¨¡å‹ï¼Œè¿˜æ˜¯éå¸¸å¤Ÿæµ‹è¯•ä½¿ç”¨çš„ã€‚

### 3. åŸºç¡€è®¾ç½® - æ¥å£è°ƒç”¨

#### 3.1 æ¥å£ - é˜²è…å¯¹æ¥

**æºç **ï¼š`cn.bugstack.xfg.dev.tech.infrastructure.gateway.api.IZSXQApi`

```java
public interface IZSXQApi {

    /**
     * æŸ¥è¯¢çŸ¥è¯†æ˜Ÿçƒå¸–å­å†…å®¹
     *
     * @return å¸–å­æ•°æ®
     * @throws IOException å¼‚å¸¸
     */
    ResponseDTO topics() throws IOException;

    /**
     * å›å¤å¸–å­
     *
     * @param topicId å¸–å­ID
     * @param content å›å¤å†…å®¹
     */
    void comment(long topicId, String content);

}
```

- åœ¨åŸºç¡€è®¾ç½®å±‚ä¸­å®šä¹‰ gateway ç½‘å…³æ¥å£è°ƒç”¨ï¼Œå¯¹äºå¤–éƒ¨çš„æ¥å£ä½¿ç”¨ï¼Œä¸­é—´è¦åšä¸€å±‚é˜²è…ï¼Œä¸è¦ç›´æ¥æŠŠå¤–éƒ¨çš„æ¥å£æš´éœ²å‡ºå»ä½¿ç”¨ã€‚

#### 3.2 ä½¿ç”¨ - ä¾èµ–å€’ç½®

**æºç **ï¼š`cn.bugstack.xfg.dev.tech.infrastructure.gateway.adapter.ZSXQAdapter`

```java
public class ZSXQAdapter implements IZSXQAdapter {

    @Resource
    private IZSXQApi zsxqApi;

    @Override
    public List<TopicsItemVO> queryTopics() {
        try {
            ResponseDTO responseDTO = zsxqApi.topics();
            RespData respData = responseDTO.getRespData();
            List<TopicsItem> topics = respData.getTopics();
            List<TopicsItemVO> topicsItemVOList = new ArrayList<>();

            for (TopicsItem topicsItem : topics) {
                TopicsItemVO topicsItemVO = TopicsItemVO.builder()
                        .topicId(topicsItem.getTopicId())
                        .talk(topicsItem.getTalk().getText())
                        .showCommentsItems(topicsItem.getShowComments() != null ? topicsItem.getShowComments().stream()
                                .map(showCommentsItem -> {
                                    TopicsItemVO.ShowCommentsItem item = new TopicsItemVO.ShowCommentsItem();
                                    item.setUserId(showCommentsItem.getOwner().getUserId());
                                    return item;
                                })
                                .collect(Collectors.toList()) : new ArrayList<>())
                        .build();

                topicsItemVOList.add(topicsItemVO);
            }

            return topicsItemVOList;
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public boolean comment(long topicId, String content) {
        zsxqApi.comment(topicId, content);
        return true;
    }

}
```

- æ³¨æ„ï¼ŒTopicsItemVO å¯¹è±¡æ¥è‡ªäº domain ä¸‹é¢†åŸŸä¸­æ¨¡å‹ä¸‹çš„ VO å¯¹è±¡ã€‚å› ä¸ºæ˜¯ä¾èµ–å€’ç½®çš„ï¼Œæ‰€ä»¥ infrastructure å¼•ç”¨çš„æ˜¯ domain å¹¶å¯¹å…¶æ¥å£åšå®ç°å¤„ç†ã€‚
- å¹¶ä¸”ï¼ŒTopicsItemVO åªæ˜¯éœ€è¦è·å–è‡ªå·±éœ€è¦çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥åšç®€å•çš„å°è£…å¤„ç†ã€‚è¿™æ ·å¯ä»¥è¡”æ¥å¤–éƒ¨æ¥å£å’Œå†…éƒ¨é€»è¾‘ä¸­é—´çš„æ¡¥æ¢ï¼Œä¸åšå¼ºå…³è”ã€‚

### 4. ä»»åŠ¡è°ƒåº¦

**æºç **ï¼š`cn.bugstack.xfg.dev.tech.job.ReplyJob`

```java
public class ReplyJob {

    @Resource
    private IAiReply aiReply;

    @Scheduled(cron = "0/10 * * * * ?")
    public void exec() throws Exception {
        log.info("è‡ªåŠ¨å›å¸–ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...");
        aiReply.doAiReply();
    }

}
```

- ç°åœ¨åœ¨ trigger è§¦å‘å™¨å±‚ä¸­çš„ job ä¸‹ï¼Œå°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬å·²ç»å®ç°å¥½çš„ AiReply è‡ªåŠ¨å›å¸–åŠŸèƒ½äº†ã€‚
- æ­¤å¤–ï¼Œæ³¨æ„ Application ä¸­ `@EnableScheduling` æ³¨è§£æ˜¯å¼€å¯çš„ï¼Œå¦åˆ™ä»»åŠ¡ä¸èƒ½æ‰§è¡Œã€‚

## ä¸‰ã€ç³»ç»Ÿæµ‹è¯•

### 1. é›†æˆæµ‹è¯•

```java
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class ApiTest {

    @Resource
    private IAiReply aiReply;

    @Test
    public void test_IAiReply() {
        aiReply.doAiReply();
    }

}
```

- é€šå¸¸æƒ…å†µä¸‹è¿™ç§æµ‹è¯•æ˜¯æœ€å¤šçš„ï¼Œå†™å¤šå°‘åŠŸèƒ½ï¼Œå°±ç›´æ¥æµ‹è¯•è°ƒç”¨ã€‚å¦‚åŠŸèƒ½ä¸­æ‰€ç”¨åˆ°çš„ï¼›HTTPæ¥å£ã€RPCæ¥å£ã€æ•°æ®åº“ã€Redisç­‰èµ„æºï¼Œéƒ½ä¼šéœ€è¦ä½¿ç”¨åˆ°ã€‚æœ‰æ—¶å€™ä¹Ÿå› ä¸ºè¿™æ ·ï¼Œæ‰€ä»¥ä¸å¥½æµ‹è¯•ã€‚é‚£ä¹ˆå•å…ƒæµ‹è¯•å°±å‡ºç°äº†ã€‚

### 2. å•å…ƒæµ‹è¯•

```java
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class MockTest {

    @Resource
    private IAiReply aiReply;

    @MockBean
    private IZSXQAdapter izsxqAdapter;

    @Test
    public void test_doAiReply() throws InterruptedException, JsonProcessingException {
        Mockito.when(izsxqAdapter.queryTopics()).thenReturn(new ArrayList<TopicsItemVO>() {{
            TopicsItemVO topicsItemVO = new TopicsItemVO();
            topicsItemVO.setTopicId(10001L);
            topicsItemVO.setTalk("<e type=\"mention\" uid=\"241858242255511\" title=\"%40%E5%B0%8F%E5%82%85%E5%93%A5\" /> æé—® java å†’æ³¡æ’åº");
            add(topicsItemVO);
        }});

        Mockito.when(izsxqAdapter.comment(Mockito.anyLong(), Mockito.anyString())).thenReturn(true);

        aiReply.doAiReply();

        // ç­‰å¾…ï¼›ChatGLM å¼‚æ­¥å›å¤
        new CountDownLatch(1).await();
    }

}
```

<div align="center">
    <img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-mock-03.png" width="550px">
</div>

- åœ¨åŸºäºä½¿ç”¨ SpringBoot çš„å¯åŠ¨ï¼Œä»¥åŠä¸€éƒ¨åˆ†åŠŸèƒ½éœ€è¦èµ°çœŸå®è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åŠŸèƒ½çš„æ¥å£å¯èƒ½æ²¡æ³•è°ƒç”¨æ—¶ã€‚å¯ä»¥ä½¿ç”¨è¿™æ ·çš„ä¸€ç§ MockBean çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå¹¶å¯¹æ•´æ¡é“¾è·¯ä¸Šè°ƒç”¨åˆ°çš„æ¥å£æ–¹æ³•è¿›è¡Œ Mock å¤„ç†ã€‚`Mockito.when(è°ƒç”¨åˆ°çš„æ¥å£).thenReturn(è¿”å›çš„ç»“æœ);
- é‚£ä¹ˆç°åœ¨åœ¨æµ‹è¯•æ–¹æ³•ä¸­ï¼Œåšäº†2ä¸ªMockæ“ä½œï¼ŒæŠŠæŸ¥è¯¢å¸–å­å’Œå›å¤å¸–å­ï¼Œéƒ½ç»™å¤„ç†æ‰ã€‚ä¹Ÿå°±æ˜¯æœ‰äº† Mock ä»¥åï¼Œç¨‹åºè°ƒç”¨åˆ°è¿™é‡Œï¼Œå°±ç›´æ¥èµ° Mock é‡Œè®¾ç½®çš„ç»“æœä¿¡æ¯äº†ã€‚

### 3. åŠŸèƒ½æµ‹è¯•

```java
@Slf4j
@RunWith(MockitoJUnitRunner.class)
public class ZSXQAdapterTest {

    @Mock
    private IZSXQApi mockZsxqApi;

    @InjectMocks
    private ZSXQAdapter zsxqAdapterUnderTest;

    @Test
    public void testQueryTopics() throws Exception {
        // Setup
        final List<TopicsItemVO> expectedResult = Arrays.asList(TopicsItemVO.builder()
                .topicId(0L)
                .talk("talk")
                .showCommentsItems(Arrays.asList(TopicsItemVO.ShowCommentsItem.builder()
                        .userId(0L)
                        .build()))
                .build());

        // Configure IZSXQApi.topics(...).
        final ResponseDTO responseDTO = new ResponseDTO();
        final RespData respData = new RespData();
        final TopicsItem topicsItem = new TopicsItem();
        final ShowCommentsItem showCommentsItem = new ShowCommentsItem();
        final Owner owner = new Owner();
        owner.setUserId(0L);
        showCommentsItem.setOwner(owner);
        topicsItem.setShowComments(Arrays.asList(showCommentsItem));
        final Talk talk = new Talk();
        talk.setText("talk");
        topicsItem.setTalk(talk);
        topicsItem.setTopicId(0L);
        respData.setTopics(Arrays.asList(topicsItem));
        responseDTO.setRespData(respData);
        when(mockZsxqApi.topics()).thenReturn(responseDTO);

        // Run the test
        final List<TopicsItemVO> result = zsxqAdapterUnderTest.queryTopics();

        // Verify the results
        assertEquals(expectedResult, result);

        log.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(result));
    }
    
}
```

<div align="center">
    <img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-mock-04.png" width="550px">
</div>

- é™¤äº†å‰é¢ä¸¤ç§æµ‹è¯•ï¼Œæˆ‘ä»¬åœ¨å¼€å‘åŠŸèƒ½çš„æ—¶å€™ï¼Œè¿˜æœ‰åœºæ™¯æµ‹è¯•ï¼›ä¸å¯åŠ¨ SpringBoot ä½†å¸Œæœ›å¯¹å®ç°çš„åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚
- é‚£ä¹ˆè¿™é‡Œæ‰€ä½“ç°çš„å°±æ˜¯è¿™æ ·çš„æµ‹è¯•ï¼Œä¸»è¦ä½¿ç”¨ï¼›`@RunWith(MockitoJUnitRunner.class)`ã€`@Mock`ã€`@InjectMocks` ç›¸å½“äºæ¨¡æ‹Ÿäº†ä¸€ä¸ªå¯åŠ¨çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡éƒ½æ˜¯ Mock çš„ä¿¡æ¯ã€‚ä½†ä½ å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯æ¥è°ƒè¯•ä½ çš„æ¥å£ã€‚
- æç¤ºï¼šä½ å¯ä»¥å®‰è£… `IDEA Plugin Squaretest` å®ƒèƒ½è‡ªåŠ¨çš„å¸®ä½ ç”ŸæˆMockå•å…ƒæµ‹è¯•ã€‚`è¿™ä¸ªæ’ä»¶æ˜¯æ”¶è´¹çš„ï¼Œä½†è¿˜å¥½ä¸è´µã€‚`
