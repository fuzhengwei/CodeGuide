---
title: ç¬¬16ç« ï¼šç½‘ç»œé€šä¿¡é…ç½®æå–
pay: https://articles.zsxq.com/id_j0o8mnm7up5j.html
---

# ç¬¬16ç« ï¼šç½‘ç»œé€šä¿¡é…ç½®æå–

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

- **æœ¬ç« éš¾åº¦**ï¼šâ˜…â˜…â˜†â˜†â˜†
- **æœ¬ç« é‡ç‚¹**ï¼šæå– Netty é€šä¿¡æœåŠ¡é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šIPã€ç«¯å£ã€çº¿ç¨‹ç­‰ï¼Œåˆ°ä¼šè¯çš„ Configuration é…ç½®ç±»ä¸­è¿›è¡Œç»Ÿä¸€çš„ç»´æŠ¤å’Œç®¡ç†ï¼Œä¾¿äºå¤–éƒ¨è°ƒç”¨æ–¹å‘å†…éƒ¨ä¼ é€’ä¿¡æ¯ã€‚
- **è¯¾ç¨‹è§†é¢‘**ï¼š[https://t.zsxq.com/080SvY1Gg](https://t.zsxq.com/080SvY1Gg)

## ä¸€ã€å­¦ä¹ æŒ‡å¼•

`æŠ€èƒ½ + æ€æƒ³ + ç†Ÿç»ƒ = ç‰›é€¼çš„ç ”å‘ï¼`

å½“æˆ‘çœ‹åˆ°è¶Šæ¥è¶Šå¤šçš„ç¨‹åºå‘˜ğŸ‘¨ğŸ»â€ğŸ’»è½¬å‘æ¶æ„å¸ˆä»¥åï¼Œå¼€å§‹é€æ­¥è„±ç¦»ç¼–ç¨‹å¼€å‘ã€‚**æˆ‘çŸ¥é“ï¼Œä»–å®Œäº†ã€‚** ä¸€ä¸ªPPTæ¶æ„å¸ˆæ˜¯ä¸èƒ½ç»™å‡ºç¬¦åˆçœŸå®åœºæ™¯çš„ä¼˜ç§€è®¾è®¡çš„ï¼Œå½“ä½ è„±ç¦»ç»†èŠ‚ä»¥åä½ æ‰€ç»™å‡ºçš„å†…å®¹éƒ½æ˜¯åªæ˜¯è‡ªæˆ‘ä¸»è§‚åˆ¤æ–­ä¸‹çš„æ€æƒ³å±‚é¢å†…å®¹ã€‚ä½†è¿™ä»½æ²¡æœ‰ç»è¿‡è‡ªå·±è½åœ°çš„æ€æƒ³ï¼Œå…¶å®æ€ä¹ˆè¡¨è¾¾éƒ½æ˜¯è™šçš„ï¼Œå› ä¸ºç¼–ç¨‹ä¸­é‚£äº›çç¢çš„ç»†èŠ‚æ‰æ˜¯çœŸæ­£çš„é—®é¢˜æ‰€åœ¨ã€‚

## äºŒã€é…ç½®æå–

å¯¹äºç¬¬16ç« å†…å®¹çš„å¤„ç†ï¼Œä¸»è¦æ¥è‡ªäºåœ¨ç¬¬17ç« å¼€å‘çš„ api-gateway-assist-03 ç½‘å…³é€šä¿¡åŠ©æ‰‹ç»„ä»¶ï¼Œå¯¹äºç½‘å…³é€šä¿¡æœåŠ¡çš„å¯åŠ¨ï¼Œå¯ä»¥æŒ‡å®šé…ç½®ä¸‹ Netty æœåŠ¡çš„IPåœ°å€å’Œç«¯å£ä¿¡æ¯ã€‚

ç›®å‰è¿™éƒ¨åˆ†é…ç½®åœ¨ api-gateway-core-08 ä¸­æ˜¯å†™æ­»åœ¨ GatewaySocketServer ç±»ä¸­çš„ï¼Œæ‰€ä»¥è¦å¯¹è¿™éƒ¨åˆ†å†…å®¹è¿›è¡Œå¤„ç†ã€‚æ­¤å¤–ç”±äºæˆ‘ä»¬éœ€è¦å¯¹ api-gateway-core è¿›è¡Œç»„ä»¶æ‰“åŒ… Jar ç»™ api-gateway-assist å¼•å…¥ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ä¼˜åŒ–ä¸‹ POM é…ç½®ï¼Œé¿å…æ¯æ¬¡æ‰“åŒ…éƒ½åšå¯¹ test è¿›è¡Œæ“ä½œï¼ˆè¿™éƒ¨åˆ†è¯»è€…å¯ä»¥éªŒè¯æ‰“åŒ…æ—¥å¿—è¾“å‡ºå†…å®¹ install æ‰“åŒ…ï¼‰ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼Œapi-gateway-assist å¼•å…¥ api-gateway-core ä»¥åï¼Œå¦‚æœå¸Œæœ›æŠŠè¿™ä¸ª Jar åŒ…å°±æ‰“å…¥åˆ° api-gateway-assist ä¸­ã€‚é‚£ä¹ˆ api-gateway-core çš„åŒ…ç»“æ„æœ€å¥½æ˜¯æœ‰ä¸€ä¸ªåŒºåˆ†çš„ã€‚ä½†ç›®å‰æ˜¯ **cn.bugstack.gateway** ä¹‹åå°±æ˜¯å„ä¸ªåˆ†å±‚åŠŸèƒ½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒæ•´ä¸º **cn.bugstack.gateway.core** çš„ç»“æ„æ¥å¤„ç†ã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-01.png?raw=true" width="500px">
</div>

- å¦‚å›¾æ‰€ç¤ºï¼Œä¿®æ”¹åˆ†å±‚ç»“æ„ã€‚ä¹‹åå¯¹ socket é€šä¿¡æå–é…ç½®ï¼Œæ”¾åˆ° session ä¼šè¯çš„ Configuration ç±»ä¸­ç»´æŠ¤å³å¯ã€‚

## ä¸‰ã€åŠŸèƒ½å®ç°

### 1. å·¥ç¨‹ç»“æ„

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-02.png?raw=true" width="500px">
</div>

- æºç ï¼š[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-core/-/tree/master/api-gateway-core-09](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-core/-/tree/master/api-gateway-core-09) â€”â€” ç”³è¯·è®¿é—®æƒé™(åŠ å…¥ä»“åº“)ï¼š[https://t.zsxq.com/04VB66uzz](https://t.zsxq.com/04VB66uzz)
- åœ¨å·¥ç¨‹ä¸­æ–°æ·»åŠ ä¸€ä¸ª core åŒ…ï¼ŒæŠŠä»£ç è¿ç§»è¿‡å»å°±å¯ä»¥äº†ã€‚

### 2. æå–é…ç½®

è¿™é‡Œæˆ‘ä»¬è¦æŠŠ ewaySocketServer ç±»ä¸­çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼›æœåŠ¡å¯åŠ¨IPã€æœåŠ¡ç«¯å£ã€çº¿ç¨‹æ•°ï¼Œè¿›è¡Œæå–ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.gateway.core.socket.GatewaySocketServer`

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-03.png?raw=true" width="800px">
</div>

é…ç½®å†…å®¹æå–åï¼Œå°±æ˜¯æ”¾åˆ° Configuration ä¸­è¿›è¡Œç»Ÿä¸€ç»´æŠ¤ã€‚è¿™é‡Œä¸è¦å†å¢åŠ å…¶ä»–çš„é…ç½®æ–‡ä»¶æˆ–è€…è¯´é€šè¿‡æ„é€ å…¥å‚çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºè¿™æ ·ä½ ä¼šå¤±å»å¯¹ä¸€ä¸ªé…ç½®çš„ç»Ÿä¸€ç®¡ç†ã€‚

**æºç è¯¦è§**ï¼š`cn.bugstack.gateway.core.session.Configuration`

```java
public class Configuration {

    // ç½‘å…³ Netty æœåŠ¡åœ°å€
    private String hostName = "127.0.0.1";
    // ç½‘å…³ Netty æœåŠ¡ç«¯å£
    private int port = 7397;
    // ç½‘å…³ Netty æœåŠ¡çº¿ç¨‹æ•°é…ç½®
    private int bossNThreads = 1;
    private int workNThreads = 4;
    
    // ... çœç•¥éƒ¨åˆ†ä»£ç 
}    
```

- åœ¨ Configuration ç±»ä¸­ç»Ÿä¸€ç»´æŠ¤ç½‘å…³çš„ä¸€äº›é…ç½®ä¿¡æ¯ã€‚

### 3. ç¦æ­¢æ‰“åŒ…æµ‹è¯•å†…å®¹

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <skipTests>true</skipTests>
    </configuration>
</plugin>
```

- è¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ªé…ç½®é—®é¢˜ï¼Œé¿å…æˆ‘ä»¬æ‰“åŒ…çš„æ—¶å€™æŠŠ test å•æµ‹å†…å®¹å¯åŠ¨å–½ã€‚

## å››ã€åŠŸèƒ½æµ‹è¯•

### 1. å‰ç½®æ¡ä»¶

æœ¬ç« èŠ‚æ¶‰åŠäº† RPC æœåŠ¡çš„ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦æŠŠ RPC æµ‹è¯•å·¥ç¨‹ä¸‹è½½åˆ°å¯åŠ¨ï¼›
- åœ°å€ï¼š[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-test-provider](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-test-provider)
- é…ç½®ï¼šzookeeper 3.4.13 â€”â€” å¿…é¡»æœ‰æ³¨å†Œä¸­å¿ƒï¼Œä¸”ä½ çš„ zookeeper ç‰ˆæœ¬è¦ä¸å·¥ç¨‹çš„ POM ä¸­é…ç½®çš„ zookeeper åŒ¹é…ï¼Œå¦åˆ™ä¼šå¯åŠ¨å¤±è´¥
- æ“ä½œï¼šæµ‹è¯•å‰å…ˆç¡®ä¿ api-gateway-test-provider å¯åŠ¨å®Œæˆ
- è¿™éƒ¨åˆ†å†…å®¹å·²ç»åœ¨ api-gateway-core ä¸­è®²è§£è¿‡ï¼Œå¯ä»¥å¯¹ç…§å­¦ä¹ ã€‚

### 2. å•å…ƒæµ‹è¯•

```java
@Test
public void test_gateway() throws InterruptedException, ExecutionException {
    // 1. åˆ›å»ºé…ç½®ä¿¡æ¯åŠ è½½æ³¨å†Œ
    Configuration configuration = new Configuration();
    configuration.setHostName("127.0.0.1");
    configuration.setPort(7397);
    // 2. åŸºäºé…ç½®æ„å»ºä¼šè¯å·¥å‚
    DefaultGatewaySessionFactory gatewaySessionFactory = new DefaultGatewaySessionFactory(configuration);
    // 3. åˆ›å»ºå¯åŠ¨ç½‘å…³ç½‘ç»œæœåŠ¡
    GatewaySocketServer server = new GatewaySocketServer(configuration, gatewaySessionFactory);
    Future<Channel> future = Executors.newFixedThreadPool(2).submit(server);
    Channel channel = future.get();
    if (null == channel) throw new RuntimeException("netty server start error channel is null");
    while (!channel.isActive()) {
        logger.info("netty server gateway start Ing ...");
        Thread.sleep(500);
    }
    logger.info("netty server gateway start Done! {}", channel.localAddress());
    // 4. æ³¨å†Œæ¥å£
    configuration.registryConfig("api-gateway-test", "zookeeper://127.0.0.1:2181", "cn.bugstack.gateway.rpc.IActivityBooth", "1.0.0");
    HttpStatement httpStatement01 = new HttpStatement(
            "api-gateway-test",
            "cn.bugstack.gateway.rpc.IActivityBooth",
            "sayHi",
            "java.lang.String",
            "/wg/activity/sayHi",
            HttpCommandType.GET,
            false);
    HttpStatement httpStatement02 = new HttpStatement(
            "api-gateway-test",
            "cn.bugstack.gateway.rpc.IActivityBooth",
            "insert",
            "cn.bugstack.gateway.rpc.dto.XReq",
            "/wg/activity/insert",
            HttpCommandType.POST,
            true);
    configuration.addMapper(httpStatement01);
    configuration.addMapper(httpStatement02);
    Thread.sleep(Long.MAX_VALUE);
}
```

- å°å‚…å“¥è¿™é‡Œæœ‰æ„æŠŠæ³¨å†Œæ¥å£æ˜ å°„çš„åŠ¨ä½œæ”¾åˆ°æœåŠ¡å¯åŠ¨ä¹‹åï¼Œå…¶å®æ˜ å°„ä½ å¯ä»¥æ”¾åˆ°ä»»ä½•æ—¶å€™ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ç½‘å…³é€šä¿¡ç»„ä»¶å¯åŠ¨å®Œæˆå‰åä½ éƒ½å¯ä»¥æ·»åŠ æ˜ å°„æ¥å£ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰æ–°çš„æ¥å£æ³¨å†Œä¸Šæ¥ä»¥åï¼Œä¹Ÿå¯ä»¥éšæ—¶æ˜ å°„åˆ°ç½‘å…³ä¸­ã€‚
- å¥½å•¦ï¼Œå…¶ä½™å†…å®¹å°±ä¸€è‡´äº†ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„æ¼”ç¤ºäº†ã€‚ä½ åªè¦ç¡®ä¿ä½ çš„ä»£ç è°ƒæ•´æ˜¯å¯ä»¥é¡ºåˆ©æµ‹è¯•çš„å³å¯ã€‚

## äº”ã€æœ¬ç« å°ç»“

- æœ¬ç« éƒ½æ˜¯ä¸ºäº†æ»¡è¶³ä¸‹ä¸€ä¸ªç« èŠ‚æ‰€åšçš„å®Œå–„è¡¥å……ï¼Œè¿™äº›è¡¥å……å…¶å®éƒ½æ˜¯ç•™å‡ºä¸€äº›æ‰©å±•çš„å£å­ç»™å¤–éƒ¨å»æ“ä½œã€‚
- ç±»ä¼¼çš„åœºæ™¯åç»­æˆ‘ä»¬è¿˜éœ€è¦ç•™å‡ºç±»ä¼¼ MyBatis æ¡†æ¶ä¸­å¯¹å¤–çš„æ’ä»¶æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥è®©å¤–éƒ¨åšæ›´å¤šçš„æ‰©å±•å¤„ç†ã€‚

## å…­ã€å¸¸è§é—®é¢˜

**é¢„ç•™ï¼›è¿™é‡Œæ±‡æ€»è¯»è€…åœ¨å­¦ä¹ æœ¬ç« ä¸­é‡åˆ°çš„å…±æ€§é—®é¢˜ï¼Œè§£ç­”åå­˜æ”¾åˆ°è¿™é‡Œä¾›å¤§å®¶å‚è€ƒ**

## ä¸ƒã€ç”¨æˆ·ä½œä¸š

**é¢„ç•™ï¼›è¿™é‡Œæ±‡æ€»è¯»è€…åœ¨å­¦ä¹ ç»“æŸåæäº¤çš„è¯¾ç¨‹ä½œä¸šï¼Œå¤§å®¶å¯ä»¥äº’ç›¸åˆ†äº«ä¸€èµ·æ¥å­¦ä¹ **



