---
title: ç¬¬17ç« ï¼šæ ¸å¿ƒé€šä¿¡ç»„ä»¶ç®¡ç†å’Œå¤„ç†æœåŠ¡æ˜ å°„
pay: https://articles.zsxq.com/id_r00wui6wm1fw.html
---

# ç¬¬17ç« ï¼šæ ¸å¿ƒé€šä¿¡ç»„ä»¶ç®¡ç†å’Œå¤„ç†æœåŠ¡æ˜ å°„

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

- **æœ¬ç« éš¾åº¦**ï¼šâ˜…â˜…â˜…â˜†â˜†
- **æœ¬ç« é‡ç‚¹**ï¼šå¼•å…¥é€šä¿¡ api-gateway-core åˆ° api-gateway-assist ä¸­è¿›è¡Œåˆ›å»ºå’Œä½¿ç”¨ï¼Œå¹¶æ‹‰å–è‡ªæ³¨å†Œä¸­å¿ƒçš„æ˜ å°„ä¿¡æ¯æ³¨å†Œåˆ°æœ¬åœ°çš„ç½‘å…³é€šä¿¡ç»„ä»¶ä¸­ã€‚
- **è¯¾ç¨‹è§†é¢‘**ï¼š[https://t.zsxq.com/080SvY1Gg](https://t.zsxq.com/080SvY1Gg)


## ä¸€ã€å­¦ä¹ æŒ‡å¼•

`ä¸ºä»€ä¹ˆä½ æ­å»ºä¸å‡ºé‚£äº›ä¼˜ç§€çš„æ¶æ„ï¼Ÿ`

MVC æ˜¯æˆ‘ä»¬é€šå¸¸çš„ä¸šåŠ¡ç±»å¼€å‘æ¶æ„ï¼Œä½†å½“ä½ é€æ­¥çš„æ¥è§¦åˆ°ä¸€äº›æºç æ—¶ï¼Œä¼šå‘ç°è¿™äº›æºç å¹¶ä¸æ˜¯ MVC æ¶æ„ï¼Œç”šè‡³å¾ˆå¤šæ—¶å€™è¿™äº›åˆ†å±‚ä¼šæ„Ÿè§‰å¾ˆé™Œç”Ÿã€‚ä½†è¦å»åˆ†ææ¢³ç†åˆå‘ç°ï¼Œè¿™äº›åˆ†å±‚ç»“æ„çœŸçš„åšçš„å¾ˆä¼˜ç§€ã€‚

å¯ä¸ºä»€ä¹ˆè®©ä½ å¼€å‘ä¸€ä¸ªé€šç”¨çš„æŠ€æœ¯ç±»é¡¹ç›®çš„æ—¶å€™ï¼Œä½ è„‘è¢‹é‡Œå¹¶æ²¡æœ‰è¿™æ ·çš„æ€ç»´ç»“æ„å‘¢ã€‚æ€»æ„Ÿè§‰è‡ªå·±è¦ä¸‹æ‰‹å†™ä»£ç å°±æ˜¯åˆ›å»ºä¸€ä¸ª service åŒ…ï¼Œä¹‹åä¸æ–­åœ°ç´¯åŠ é€»è¾‘ã€‚è¿™æ˜¯å› ä¸ºå¸æ”¶ä¼˜ç§€æ¡†æ¶æºç çš„æ¶æ„å¤ªå°‘äº†ï¼Œè„‘è¢‹é‡Œçš„å°è±¡åªæœ‰MVCï¼Œè‡ªå·±çš„ç¼–ç¨‹å¼€å‘è§†é‡æ ¹æœ¬æ²¡æ‰“å¼€ï¼Œæ‰€ä»¥æ‰æ²¡æœ‰å¯ä»¥æ¨¡ä»¿çš„åˆ†å±‚ç»“æ„ã€‚

æ‰€ä»¥ä¸ºäº†æå‡è¿™æ–¹é¢çš„æŠ€èƒ½ï¼Œä¸€å®šè¦å¤šå­¦ä¹ ä¸åŒç±»å‹çš„æºç æ¶æ„å¹¶ä¸æ–­çš„è¿ç”¨å’Œå®è·µï¼Œæ‰èƒ½æå‡ä½ çš„èƒ½åŠ›ã€‚

## äºŒã€ç»„ä»¶ç®¡ç†

ç¬¬17ç« æ˜¯åœ¨ç¬¬15ç« çš„åŸºç¡€ä¸Šç»§ç»­å®Œå–„æœåŠ¡å‘ç°çš„ç›¸å…³åŠŸèƒ½ï¼ŒæŠŠä»æ³¨å†Œä¸­å¿ƒæ‹‰å–çš„ç½‘å…³æ˜ å°„ä¿¡æ¯ã€ç³»ç»Ÿã€æ¥å£ã€æ–¹æ³•ã€‘æ˜ å°„åˆ°æœ¬åœ°é€šä¿¡ç»„ä»¶ä¸­ã€‚è¿™æ ·å°±ç®—å®Œæˆäº†æ³¨å†Œä¸­å¿ƒåˆ°æœ¬åœ°æœåŠ¡çš„ä¸€ä¸ªæ‰“é€šå¤„ç†ï¼Œæ˜ å°„å®Œæˆåå°±å¯ä»¥é€šè¿‡HTTPè¯·æ±‚åˆ°ç½‘å…³é€šä¿¡å±‚ï¼Œå®Œæˆå¯¹RPCçš„æ³›åŒ–è°ƒç”¨ã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-01.png?raw=true" width="500px">
</div>

- é¦–å…ˆåœ¨å®ç°ä¸­è¦å¼•å…¥ api-gateway-core-09ã€æœ¬ç« æ­¢æœ€æ–°ç‰ˆæœ¬ã€‘åˆ° api-gateway-assist ä¸­ï¼Œé€šè¿‡ GatewayAutoConfig é…ç½®ç±»å¯¹ç½‘å…³é€šä¿¡ç»„ä»¶è¿›è¡Œ Bean å¯¹è±¡çš„åˆ›å»ºå’Œå¯åŠ¨ã€‚
- ä¹‹åå°±å¯ä»¥åœ¨ GatewayApplication ä¸­å¤„ç†ä»ç½‘å…³æ³¨å†Œä¸­å¿ƒæ‹‰å–åˆ°çš„æ¥å£ä¿¡æ¯è¿›è¡Œæ³¨å†Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯æŠŠæ¥å£å‘ api-gateway-core å®Œæˆæ³¨å†Œæ˜ å°„æ“ä½œã€‚**å¯å‚è€ƒ api-gateway-core-09 ApiTest æµ‹è¯•ç±»**

## ä¸‰ã€åŠŸèƒ½å®ç°

### 1. å·¥ç¨‹ç»“æ„

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-02.png?raw=true" width="500px">
</div>

- æºç ï¼š[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-assist/-/tree/master/api-gateway-assist-03](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-assist/-/tree/master/api-gateway-assist-03) â€”â€” ç”³è¯·è®¿é—®æƒé™(åŠ å…¥ä»“åº“)ï¼š[https://t.zsxq.com/04VB66uzz](https://t.zsxq.com/04VB66uzz)

### 2. å¼•å…¥æœåŠ¡

```xml
<!-- å¼•å…¥ç½‘å…³é€šä¿¡ç»„ä»¶ -->
<dependency>
    <groupId>cn.bugstack.gateway</groupId>
    <artifactId>api-gateway-core-09</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

- åœ¨ api-gateway-core-09 ä¸­è¿›è¡Œ install æ‰“åŒ…ï¼Œä¹‹åå¼•å…¥åˆ° api-gateway-assist-03 ä¸­è¿›è¡Œä½¿ç”¨ã€‚

å¦å¤–è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé…ç½®æ˜¯è®© api-gateway-core-09 å¯ä»¥æ‰“åŒ…åˆ° api-gateway-assist ä¸­çš„é…ç½®ã€‚å¦‚ä¸‹ï¼›

```xml
<configuration>
    <artifactSet>
        <includes>
            <include>cn.bugstack.gateway:api-gateway-core-09:jar:</include>
        </includes>
    </artifactSet>
</configuration>
```

- è¿™ä¸ªæ“ä½œä¸»è¦æ˜¯å› ä¸ºå°†æ¥æŠŠ api-gateway-assist ç»™å¤–éƒ¨ä½¿ç”¨æ—¶ï¼Œä¸ç”¨åœ¨é¢å¤–å¼•ç”¨ api-gateway-core äº†ã€‚

### 3. æœåŠ¡åˆ›å»º

**æºç è¯¦è§**ï¼š`cn.bugstack.gateway.assist.config.GatewayAutoConfig`

```java
@Bean
public cn.bugstack.gateway.core.session.Configuration gatewayCoreConfiguration(GatewayServiceProperties properties) {
    cn.bugstack.gateway.core.session.Configuration configuration = new cn.bugstack.gateway.core.session.Configuration();
    String[] split = properties.getAddress().split(":");
    configuration.setHostName(split[0].trim());
    configuration.setPort(Integer.parseInt(split[1].trim()));
    return configuration;
}

@Bean
public Channel initGateway(cn.bugstack.gateway.core.session.Configuration configuration) throws ExecutionException, InterruptedException {
    // 1. åŸºäºé…ç½®æ„å»ºä¼šè¯å·¥å‚
    DefaultGatewaySessionFactory gatewaySessionFactory = new DefaultGatewaySessionFactory(configuration);
    // 2. åˆ›å»ºå¯åŠ¨ç½‘å…³ç½‘ç»œæœåŠ¡
    GatewaySocketServer server = new GatewaySocketServer(configuration, gatewaySessionFactory);
    Future<Channel> future = Executors.newFixedThreadPool(2).submit(server);
    Channel channel = future.get();
    if (null == channel) throw new RuntimeException("api gateway core netty server start error channel is null");
    while (!channel.isActive()) {
        logger.info("api gateway core netty server gateway start Ing ...");
        Thread.sleep(500);
    }
    logger.info("api gateway core netty server gateway start Done! {}", channel.localAddress());
    return channel;
}
```

- åœ¨ GatewayAutoConfig è‡ªåŠ¨åˆ›å»º Bean å¯¹è±¡ç±»ä¸­ï¼Œåˆ›å»º **cn.bugstack.gateway.core.session.Configuration** é…ç½®ï¼Œä»¥åŠå¯åŠ¨ç½‘å…³æœåŠ¡ã€‚å¯åŠ¨åå°±å¯ä»¥æ¥æ”¶æœåŠ¡æ¥å£çš„æ³¨å†Œæ“ä½œäº†ã€‚

### 4. æ³¨å†Œæ¥å£

**æºç è¯¦è§**ï¼š`cn.bugstack.gateway.assist.application.GatewayApplication`

```java
@Override
public void onApplicationEvent(ContextRefreshedEvent event) {
    // 1. æ³¨å†Œç½‘å…³æœåŠ¡ï¼›æ¯ä¸€ä¸ªç”¨äºè½¬æ¢ HTTP åè®®æ³›åŒ–è°ƒç”¨åˆ° RPC æ¥å£çš„ç½‘å…³éƒ½æ˜¯ä¸€ä¸ªç®—åŠ›ï¼Œè¿™äº›ç®—åŠ›éœ€è¦æ³¨å†Œç½‘å…³é…ç½®ä¸­å¿ƒ
    gatewayCenterService.doRegister(properties.getAddress(),
            properties.getGroupId(),
            properties.getGatewayId(),
            properties.getGatewayName(),
            properties.getGatewayAddress());
    
    // 2. æ‹‰å–ç½‘å…³é…ç½®ï¼›æ¯ä¸ªç½‘å…³ç®—åŠ›éƒ½ä¼šåœ¨æ³¨å†Œä¸­å¿ƒåˆ†é…ä¸Šéœ€è¦æ˜ å°„çš„RPCæœåŠ¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼›ç³»ç»Ÿã€æ¥å£ã€æ–¹æ³•
    ApplicationSystemRichInfo applicationSystemRichInfo = gatewayCenterService.pullApplicationSystemRichInfo(properties.getAddress(), properties.getGatewayId());
    List<ApplicationSystemVO> applicationSystemVOList = applicationSystemRichInfo.getApplicationSystemVOList();
    for (ApplicationSystemVO system : applicationSystemVOList) {
        List<ApplicationInterfaceVO> interfaceList = system.getInterfaceList();
        for (ApplicationInterfaceVO itf : interfaceList) {
            // 2.1 åˆ›å»ºé…ç½®ä¿¡æ¯åŠ è½½æ³¨å†Œ
            configuration.registryConfig(system.getSystemId(), system.getSystemRegistry(), itf.getInterfaceId(), itf.getInterfaceVersion());
            List<ApplicationInterfaceMethodVO> methodList = itf.getMethodList();
            // 2.2 æ³¨å†Œç³»ç»ŸæœåŠ¡æ¥å£ä¿¡æ¯
            for (ApplicationInterfaceMethodVO method : methodList) {
                HttpStatement httpStatement = new HttpStatement(
                        system.getSystemId(),
                        itf.getInterfaceId(),
                        method.getMethodId(),
                        method.getParameterType(),
                        method.getUri(),
                        HttpCommandType.valueOf(method.getHttpCommandType()),
                        method.isAuth());
                configuration.addMapper(httpStatement);
                logger.info("ç½‘å…³æœåŠ¡æ³¨å†Œæ˜ å°„ ç³»ç»Ÿï¼š{} æ¥å£ï¼š{} æ–¹æ³•ï¼š{}", system.getSystemId(), itf.getInterfaceId(), method.getMethodId());
            }
        }
    }
}
```

- onApplicationEvent æ–¹æ³•ä¸­çš„ç¬¬2æ­¥ï¼Œå°±æ˜¯ä»æ³¨å†Œä¸­å¿ƒè·å–çš„å±äºå½“å‰ç½‘å…³éœ€è¦å®Œæˆæ˜ å°„æ“ä½œçš„ç³»ç»Ÿä¿¡æ¯ã€‚åŒ…æ‹¬è¿™ä¸ªç³»ç»Ÿçš„æ¥å£å’Œæ–¹æ³•ã€‚é€šè¿‡å¾ªç¯éå†æŸ¥è¯¢åˆ°çš„ä¿¡æ¯è¿›è¡Œæ³¨å†Œå¤„ç†ã€‚
- åœ¨è¿™é‡Œå¤§å®¶ä¹Ÿå¯ä»¥æå‰æ€è€ƒğŸ¤”ä¸‹ï¼Œå¦‚æœç½‘å…³æœåŠ¡å·²ç»å¯åŠ¨åï¼Œæ–°å¢çš„æ¥å£æ€ä¹ˆæ·»åŠ åˆ°æ³¨å†Œé‡Œã€‚

## å››ã€æµ‹è¯•éªŒè¯

### 1. å‰ç½®æ¡ä»¶

1. ä½ éœ€è¦å…ˆå¯¹ api-gateway-core-09 è¿›è¡Œæ„å»ºï¼Œå¦åˆ™ api-gateway-assist-03 ä¼šç¼ºå¤±åŒ…æŠ¥é”™ã€‚
2. å¯åŠ¨ Docker å’Œ ZKï¼Œä¹Ÿå°±æ˜¯ Dubbo çš„æ³¨å†Œä¸­å¿ƒã€‚
3. åœ¨2çš„æ­¥éª¤ä¸Šï¼Œå¯åŠ¨ api-gateway-test-provider è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®ä¿ RPC æœåŠ¡å¯åŠ¨æˆåŠŸã€‚
4. å¯åŠ¨ api-gateway-center æ³¨å†Œä¸­å¿ƒï¼Œè¿™æ · api-gateway-assist-03 æ‰èƒ½ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æ¥å£ã€‚
5. ä¿®æ”¹ api-gateway-assist-00 pom å¼•å…¥ api-gateway-assist-03
6. ä½¿ç”¨ api-gateway-core-09 çš„ ShiroTest ç”Ÿæˆ token ç”¨äºæµ‹è¯•æ¥å£ï¼š[http://localhost:7397/wg/activity/insert](http://localhost:7397/wg/activity/insert)  æ‰€éœ€çš„å‚æ•°
7. **è¿™é‡Œæˆ‘é¢„ç•™äº†ä¸€ä¸ªå°bugï¼Œå¦‚æœä½ ä¸èƒ½å‘ç°ï¼Œé‚£ä¹ˆå°†ä¸èƒ½æµ‹è¯•åˆ°æ­£ç¡®çš„ç»“æœã€‚**

### 2. ç½‘å…³åŠ©æ‰‹

å¯åŠ¨å·¥ç¨‹ï¼šapi-gateway-assist-00 ç¡®ä¿ pom å¼•å…¥çš„æ˜¯æœ€æ–°çš„ api-gateway-assist-03 

```java
2022-12-03 18:48:52.356  INFO 42011 --- [*cketServer    : socket server start done.
2022-12-03 18:48:52.356  INFO 42011 --- [*AutoConfig    : api gateway core netty server gateway start Done! /127.0.0.1:7397
2022-12-03 18:48:52.475  INFO 42011 --- [*catWebServer  : Tomcat started on port(s): 8002 (http) with context path ''
2022-12-03 18:48:52.765  INFO 42011 --- [*nterService   : å‘ç½‘å…³ä¸­å¿ƒæ³¨å†Œç½‘å…³ç®—åŠ›æœåŠ¡ gatewayIdï¼šapi-gateway-g4 gatewayNameï¼šç”µå•†é…é€ç½‘å…³ gatewayAddressï¼š127.0.0.1:7397 æ³¨å†Œç»“æœï¼š{"code":"0000","info":"æˆåŠŸ","data":true}
2022-12-03 18:48:52.806  INFO 42011 --- [*nterService   : ä»ç½‘å…³ä¸­å¿ƒæ‹‰å–åº”ç”¨æœåŠ¡å’Œæ¥å£çš„é…ç½®ä¿¡æ¯åˆ°æœ¬åœ°å®Œæˆæ³¨å†Œã€‚gatewayIdï¼šapi-gateway-g4
log4j:WARN No appenders could be found fo*gerFactory).
log4j:WARN Please initialize the log4j sy*
log4j:WARN See http://logging.apache.org/*
2022-12-03 18:48:52.994  INFO 42011 --- [*Application   : ç½‘å…³æœåŠ¡æ³¨å†Œæ˜ å°„ ç³»ç»Ÿï¼šapi-gateway-test æ¥å£ï¼šcn.bugstack.gateway.rpc.IActivityBooth æ–¹æ³•ï¼šinsert
2022-12-03 18:48:52.994  INFO 42011 --- [*Application   : ç½‘å…³æœåŠ¡æ³¨å†Œæ˜ å°„ ç³»ç»Ÿï¼šapi-gateway-test æ¥å£ï¼šcn.bugstack.gateway.rpc.IActivityBooth æ–¹æ³•ï¼šsayHi
2022-12-03 18:48:52.997  INFO 42011 --- [*Application   : Started Application in 3.211 seconds (JVM running for 3.75)
```

- å¯åŠ¨çš„è¿‡ç¨‹åŒ…æ‹¬å¯åŠ¨ç½‘å…³æœåŠ¡ï¼Œæ³¨å†Œç½‘å…³ä¿¡æ¯ï¼Œæ‹‰å–æ¥å£æ˜ å°„é…ç½®ç­‰æ“ä½œã€‚
- æ¥ä¸‹æ¥æˆ‘ä»¬è®¿é—®ä¸‹ç½‘å…³æä¾›çš„æ¥å£ä¿¡æ¯ã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-03.png?raw=true" width="700px">
</div>

- è®¿é—®æ¥å£ï¼š[http://localhost:7397/wg/activity/insert](http://localhost:7397/wg/activity/insert) - è®°å¾—ç”Ÿæˆ Token ä½ ä¹‹å‰çš„å¯èƒ½å·²ç»è¿‡æœŸäº†ã€‚

## äº”ã€æœ¬ç« å°ç»“

- æœ¬ç« å†…å®¹ä¸»è¦åœ¨ç½‘å…³åŠ©æ‰‹ä¸­æ‰©å±•äº†å¯¹æœåŠ¡çš„åˆ›å»ºã€å¯åŠ¨å’Œæ³¨å†Œæ“ä½œã€‚åœ¨è¿™æ ·çš„ä¸€ä¸ªç±»ä¸­å®Œæˆäº†æ³¨å†Œä¸­å¿ƒã€é€šä¿¡æœåŠ¡ã€æ¥å£è°ƒç”¨ç­‰å†…å®¹çš„é“¾æ¥å¤„ç†ã€‚
- å…¶å®è¿™å°±æ˜¯ç½‘å…³æœ€æ ¸å¿ƒçš„ä¸»å¹²æµç¨‹çš„å†…å®¹ï¼Œåªè¦ä½ æŠŠåˆ°è¿™ç« èŠ‚çš„å†…å®¹ææ¸…æ¥šï¼ŒåŸºæœ¬å°±æ¸…æ¥šäº†ç½‘å…³æ˜¯å¦‚ä½•å·¥ä½œçš„`1/2`æ ¸å¿ƒå†…å®¹ã€‚
- è·¯è¿˜å¾ˆé•¿ï¼Œæˆ‘ä»¬ä¸€èµ·åˆšåˆšçœ‹åˆ°äº†ä¸€äº›ç…§è¿›æ¥çš„æ›™å…‰ï¼Œä¸€èµ·åŠ æ²¹ï¼

## å…­ã€å¸¸è§é—®é¢˜

**é¢„ç•™ï¼›è¿™é‡Œæ±‡æ€»è¯»è€…åœ¨å­¦ä¹ æœ¬ç« ä¸­é‡åˆ°çš„å…±æ€§é—®é¢˜ï¼Œè§£ç­”åå­˜æ”¾åˆ°è¿™é‡Œä¾›å¤§å®¶å‚è€ƒ**

## ä¸ƒã€ç”¨æˆ·ä½œä¸š

**é¢„ç•™ï¼›è¿™é‡Œæ±‡æ€»è¯»è€…åœ¨å­¦ä¹ ç»“æŸåæäº¤çš„è¯¾ç¨‹ä½œä¸šï¼Œå¤§å®¶å¯ä»¥äº’ç›¸åˆ†äº«ä¸€èµ·æ¥å­¦ä¹ **
