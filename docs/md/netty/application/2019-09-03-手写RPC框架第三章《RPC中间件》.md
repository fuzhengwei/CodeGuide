---
layout: post
category: itstack-demo-netty-3
title: æ‰‹å†™RPCæ¡†æ¶ç¬¬ä¸‰ç« ã€ŠRPCä¸­é—´ä»¶ã€‹
tagline: by ä»˜æ”¿å§”
tag: [netty,itstack-demo-netty-3] 
lock: need
---

# æ‰‹å†™RPCæ¡†æ¶ç¬¬ä¸‰ç« ã€ŠRPCä¸­é—´ä»¶ã€‹

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## æ¡ˆä¾‹ä»‹ç»
ç»“åˆä¸Šé¢ä¸¤ç« èŠ‚ï¼Œæœ¬ç« å°†å®ç°rpcçš„åŸºç¡€åŠŸèƒ½ï¼›æä¾›ä¸€ç»™rpcä¸­é—´ä»¶jarç»™ç”Ÿäº§ç«¯å’ŒæœåŠ¡ç«¯ã€‚
æŠ€æœ¯ç‚¹ï¼›
1. æ³¨å†Œä¸­å¿ƒï¼Œç”Ÿäº§è€…åœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦å°†æœ¬åœ°æ¥å£å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨redisä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œéšæœºå–æ•°æ¨¡æ‹Ÿæƒé‡ã€‚
2. å®¢æˆ·ç«¯åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œè¿æ¥åˆ°æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„redisã€‚è¿æ¥æˆåŠŸåå°†é…ç½®çš„ç”Ÿäº§è€…æ–¹æ³•å‘å¸ƒåˆ°æ³¨å†Œä¸­å¿ƒ{æ¥å£+åˆ«å}ã€‚
3. æœåŠ¡ç«¯é…ç½®ç”Ÿäº§è€…çš„ä¿¡æ¯åï¼Œåœ¨åŠ è½½xmlæ—¶å€™ç”±ä¸­é—´ä»¶ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ï¼Œå½“å‘ç”Ÿå‘æ”¾è°ƒç”¨æ—¶å®é™…åˆ™è°ƒç”¨äº†æˆ‘ä»¬ä»£ç†ç±»çš„æ–¹æ³•ï¼Œä»£ç†é‡Œä¼šé€šè¿‡nettyçš„futueré€šä¿¡æ–¹å¼è¿›è¡Œæ•°æ®äº¤äº’ã€‚

## ç¯å¢ƒå‡†å¤‡
1. jdk 1.8.0
2. IntelliJ IDEA Community Edition 2018.3.1 x64
3. windows redis

## ä»£ç ç¤ºä¾‹
```
itstack-demo-rpc-03
â””â”€â”€ src
    â””â”€â”€ main
    â”‚    â”œâ”€â”€ java
    â”‚    â”‚    â””â”€â”€ org.itstack.demo.rpc
    â”‚    â”‚        â”œâ”€â”€ config
    â”‚    â”‚        â”œâ”€â”€ domain
    â”‚    â”‚        â”œâ”€â”€ network	
    â”‚    â”‚        â”‚   â”œâ”€â”€ client
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ ClientSocket.java
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ MyClientHandler.java  
    â”‚    â”‚        â”‚   â”œâ”€â”€ codec
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ RpcDecoder.java
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ RpcEncoder.java  
    â”‚    â”‚        â”‚   â”œâ”€â”€ future
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ SyncWrite.java 	
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ SyncWriteFuture.java	
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ SyncWriteMap.java	
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ WriteFuture.java	
    â”‚    â”‚        â”‚   â”œâ”€â”€ msg
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ Request.java
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ Response.java 
    â”‚    â”‚        â”‚   â”œâ”€â”€ server
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ MyServerHandler.java
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ ServerSocket.java 	
    â”‚    â”‚        â”‚   â””â”€â”€ util
    â”‚    â”‚        â”‚ 	  â””â”€â”€ SerializationUtil.java 	
    â”‚    â”‚        â”œâ”€â”€ reflect
    â”‚    â”‚        â”‚   â”œâ”€â”€ JDKInvocationHandler.java	
    â”‚    â”‚        â”‚   â””â”€â”€ JDKProxy.java
    â”‚    â”‚        â”œâ”€â”€ registry
    â”‚    â”‚        â”‚   â””â”€â”€ RedisRegistryCenter.java	
    â”‚    â”‚        â””â”€â”€ util	
    â”‚ 	  â””â”€â”€ resource
    â”‚          â””â”€â”€ META-INF
    â”‚                â”œâ”€â”€ rpc.xsd
    â”‚                â”œâ”€â”€ spring.handlers
    â”‚                â””â”€â”€ spring.schemas	
    â””â”€â”€ test
         â”œâ”€â”€ java
         â”‚   â””â”€â”€ org.itstack.demo.test
         â”‚       â”œâ”€â”€ service
         â”‚       â”‚   â”œâ”€â”€ impl
         â”‚   	 â”‚   â”‚   â””â”€â”€ HelloServiceImpl.java  
         â”‚   	 â”‚   â””â”€â”€ HelloService.java
         â”‚       â””â”€â”€ ApiTest.java				 
         â””â”€â”€ resource  
		     â”œâ”€â”€ itstack-rpc-center.xml
             â”œâ”€â”€ itstack-rpc-consumer.xml		 
			 â”œâ”€â”€ itstack-rpc-provider.xml
			 â””â”€â”€ log4j.xml			 

```

>ConsumerBean.java

```java
package org.itstack.demo.rpc.config.spring.bean;

import com.alibaba.fastjson.JSON;
import io.netty.channel.ChannelFuture;
import org.itstack.demo.rpc.config.ConsumerConfig;
import org.itstack.demo.rpc.domain.RpcProviderConfig;
import org.itstack.demo.rpc.network.client.ClientSocket;
import org.itstack.demo.rpc.network.msg.Request;
import org.itstack.demo.rpc.reflect.JDKProxy;
import org.itstack.demo.rpc.registry.RedisRegistryCenter;
import org.itstack.demo.rpc.util.ClassLoaderUtils;
import org.springframework.beans.factory.FactoryBean;
import org.springframework.util.Assert;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/6
 */
public class ConsumerBean<T> extends ConsumerConfig<T> implements FactoryBean {

    private ChannelFuture channelFuture;

    private RpcProviderConfig rpcProviderConfig;

    @Override
    public Object getObject() throws Exception {

        //ä»redisè·å–é“¾æ¥
        if (null == rpcProviderConfig) {
            String infoStr = RedisRegistryCenter.obtainProvider(nozzle, alias);
            rpcProviderConfig = JSON.parseObject(infoStr, RpcProviderConfig.class);
        }
        Assert.isTrue(null != rpcProviderConfig);

        //è·å–é€šä¿¡channel
        if (null == channelFuture) {
            ClientSocket clientSocket = new ClientSocket(rpcProviderConfig.getHost(), rpcProviderConfig.getPort());
            new Thread(clientSocket).start();
            for (int i = 0; i < 100; i++) {
                if (null != channelFuture) break;
                Thread.sleep(500);
                channelFuture = clientSocket.getFuture();
            }
        }
        Assert.isTrue(null != channelFuture);

        Request request = new Request();
        request.setChannel(channelFuture.channel());
        request.setNozzle(nozzle);
        request.setRef(rpcProviderConfig.getRef());
        request.setAlias(alias);
        return (T) JDKProxy.getProxy(ClassLoaderUtils.forName(nozzle), request);
    }

    @Override
    public Class<?> getObjectType() {
        try {
            return ClassLoaderUtils.forName(nozzle);
        } catch (ClassNotFoundException e) {
            return null;
        }
    }

    @Override
    public boolean isSingleton() {
        return true;
    }


}
```

>ProviderBean.java

```java
package org.itstack.demo.rpc.config.spring.bean;

import com.alibaba.fastjson.JSON;
import org.itstack.demo.rpc.config.ProviderConfig;
import org.itstack.demo.rpc.domain.LocalServerInfo;
import org.itstack.demo.rpc.domain.RpcProviderConfig;
import org.itstack.demo.rpc.registry.RedisRegistryCenter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/6
 */
public class ProviderBean extends ProviderConfig implements ApplicationContextAware {

    private Logger logger = LoggerFactory.getLogger(ProviderBean.class);

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {

        RpcProviderConfig rpcProviderConfig = new RpcProviderConfig();
        rpcProviderConfig.setNozzle(nozzle);
        rpcProviderConfig.setRef(ref);
        rpcProviderConfig.setAlias(alias);
        rpcProviderConfig.setHost(LocalServerInfo.LOCAL_HOST);
        rpcProviderConfig.setPort(LocalServerInfo.LOCAL_PORT);

        //æ³¨å†Œç”Ÿäº§è€…
        long count = RedisRegistryCenter.registryProvider(nozzle, alias, JSON.toJSONString(rpcProviderConfig));

        logger.info("æ³¨å†Œç”Ÿäº§è€…ï¼š{} {} {}", nozzle, alias, count);
    }

}
```

>ServerBean.java

```java
package org.itstack.demo.rpc.config.spring.bean;

import org.itstack.demo.rpc.config.ServerConfig;
import org.itstack.demo.rpc.domain.LocalServerInfo;
import org.itstack.demo.rpc.network.server.ServerSocket;
import org.itstack.demo.rpc.registry.RedisRegistryCenter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/6
 */
public class ServerBean extends ServerConfig implements ApplicationContextAware {

    private Logger logger = LoggerFactory.getLogger(ServerBean.class);

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        //å¯åŠ¨æ³¨å†Œä¸­å¿ƒ
        logger.info("å¯åŠ¨æ³¨å†Œä¸­å¿ƒ ...");
        RedisRegistryCenter.init(host, port);
        logger.info("å¯åŠ¨æ³¨å†Œä¸­å¿ƒå®Œæˆ {} {}", host, port);

        //åˆå§‹åŒ–æœåŠ¡ç«¯
        logger.info("åˆå§‹åŒ–ç”Ÿäº§ç«¯æœåŠ¡ ...");
        ServerSocket serverSocket = new ServerSocket(applicationContext);
        Thread thread = new Thread(serverSocket);
        thread.start();
        while (!serverSocket.isActiveSocketServer()) {
            try {
                Thread.sleep(500);
            } catch (InterruptedException ignore) {
            }
        }

        logger.info("åˆå§‹åŒ–ç”Ÿäº§ç«¯æœåŠ¡å®Œæˆ {} {}", LocalServerInfo.LOCAL_HOST, LocalServerInfo.LOCAL_PORT);
    }


}
```

>MyClientHandler.java

```java
package org.itstack.demo.rpc.network.client;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import org.itstack.demo.rpc.network.future.SyncWriteFuture;
import org.itstack.demo.rpc.network.future.SyncWriteMap;
import org.itstack.demo.rpc.network.msg.Response;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/6
 */
public class MyClientHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object obj) throws Exception {
        Response msg = (Response) obj;
        String requestId = msg.getRequestId();
        SyncWriteFuture future = (SyncWriteFuture) SyncWriteMap.syncKey.get(requestId);
        if (future != null) {
            future.setResponse(msg);
        }
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }

}
```

>MyServerHandler.java

```java
package org.itstack.demo.rpc.network.server;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.ReferenceCountUtil;
import org.itstack.demo.rpc.network.msg.Request;
import org.itstack.demo.rpc.network.msg.Response;
import org.itstack.demo.rpc.util.ClassLoaderUtils;
import org.springframework.context.ApplicationContext;

import java.lang.reflect.Method;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/6
 */
public class MyServerHandler extends ChannelInboundHandlerAdapter {

    private ApplicationContext applicationContext;

    MyServerHandler(ApplicationContext applicationContext) {
        this.applicationContext = applicationContext;
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object obj) {
        try {
            Request msg = (Request) obj;
            //è°ƒç”¨
            Class<?> classType = ClassLoaderUtils.forName(msg.getNozzle());
            Method addMethod = classType.getMethod(msg.getMethodName(), msg.getParamTypes());
            Object objectBean = applicationContext.getBean(msg.getRef());
            Object result = addMethod.invoke(objectBean, msg.getArgs());
            //åé¦ˆ
            Response request = new Response();
            request.setRequestId(msg.getRequestId());
            request.setResult(result);
            ctx.writeAndFlush(request);
            //é‡Šæ”¾
            ReferenceCountUtil.release(msg);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.flush();
    }

}
```

>JDKInvocationHandler.java

```java
package org.itstack.demo.rpc.reflect;


import org.itstack.demo.rpc.network.future.SyncWrite;
import org.itstack.demo.rpc.network.msg.Request;
import org.itstack.demo.rpc.network.msg.Response;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;

public class JDKInvocationHandler implements InvocationHandler {

    private Request request;

    public JDKInvocationHandler(Request request) {
        this.request = request;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        String methodName = method.getName();
        Class[] paramTypes = method.getParameterTypes();
        if ("toString".equals(methodName) && paramTypes.length == 0) {
            return request.toString();
        } else if ("hashCode".equals(methodName) && paramTypes.length == 0) {
            return request.hashCode();
        } else if ("equals".equals(methodName) && paramTypes.length == 1) {
            return request.equals(args[0]);
        }
        //è®¾ç½®å‚æ•°
        request.setMethodName(methodName);
        request.setParamTypes(paramTypes);
        request.setArgs(args);
        request.setRef(request.getRef());
        Response response = new SyncWrite().writeAndSync(request.getChannel(), request, 5000);
        //å¼‚æ­¥è°ƒç”¨
        return response.getResult();

    }

}
```

>JDKProxy.java

```java
package org.itstack.demo.rpc.reflect;


import org.itstack.demo.rpc.network.msg.Request;
import org.itstack.demo.rpc.util.ClassLoaderUtils;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;

public class JDKProxy {

    public static <T> T getProxy(Class<T> interfaceClass, Request request) throws Exception {
        InvocationHandler handler = new JDKInvocationHandler(request);
        ClassLoader classLoader = ClassLoaderUtils.getCurrentClassLoader();
        T result = (T) Proxy.newProxyInstance(classLoader, new Class[]{interfaceClass}, handler);
        return result;
    }

}
```

>RedisRegistryCenter.java

```java
package org.itstack.demo.rpc.registry;

import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;
import redis.clients.jedis.JedisPoolConfig;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/7
 * redis æ¨¡æ‹ŸRPCæ³¨å†Œä¸­å¿ƒ
 */
public class RedisRegistryCenter {

    private static Jedis jedis;   //éåˆ‡ç‰‡é¢å®¢æˆ·ç«¯è¿æ¥

    //åˆå§‹åŒ–redis
    public static void init(String host, int port) {
        // æ± åŸºæœ¬é…ç½®
        JedisPoolConfig config = new JedisPoolConfig();
        config.setMaxIdle(5);
        config.setTestOnBorrow(false);
        JedisPool jedisPool = new JedisPool(config, host, port);
        jedis = jedisPool.getResource();
    }

    /**
     * æ³¨å†Œç”Ÿäº§è€…
     *
     * @param nozzle æ¥å£
     * @param alias  åˆ«å
     * @param info   ä¿¡æ¯
     * @return æ³¨å†Œç»“æœ
     */
    public static Long registryProvider(String nozzle, String alias, String info) {
        return jedis.sadd(nozzle + "_" + alias, info);
    }

    /**
     * è·å–ç”Ÿäº§è€…
     * æ¨¡æ‹Ÿæƒé‡ï¼Œéšæœºè·å–
     * @param nozzle æ¥å£åç§°
     */
    public static String obtainProvider(String nozzle, String alias) {
        return jedis.srandmember(nozzle + "_" + alias);
    }

    public static Jedis jedis() {
        return jedis;
    }

}
```

>ApiTest.java

```java
public class ApiTest {

    public static void main(String[] args) {
        String[] configs = {"itstack-rpc-center.xml", "itstack-rpc-provider.xml", "itstack-rpc-consumer.xml"};
        new ClassPathXmlApplicationContext(configs);
    }

}
```

## æ¡†æ¶ï¼Œæµ‹è¯•ç»“æœ

```java
2019-....ClassPathXmlApplicationContext:prepareRefresh:510] - Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@299a06ac: startup date [Tue May 07 20:19:47 CST 2019]; root of context hierarchy
2019-...ml.XmlBeanDefinitionReader:loadBeanDefinitions:315] - Loading XML bean definitions from class path resource [spring/itstack-rpc-center.xml]
2019-...ml.XmlBeanDefinitionReader:loadBeanDefinitions:315] - Loading XML bean definitions from class path resource [spring/itstack-rpc-provider.xml]
2019-...ml.XmlBeanDefinitionReader:loadBeanDefinitions:315] - Loading XML bean definitions from class path resource [spring/itstack-rpc-consumer.xml]
2019-...upport.DefaultListableBeanFactory:preInstantiateSingletons:577] - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@7e0b0338: defining beans [consumer_itstack,provider_helloService,consumer_helloService]; root of factory hierarchy
2019-...bean.ServerBean:setApplicationContext:25] - å¯åŠ¨æ³¨å†Œä¸­å¿ƒ ...
2019-...bean.ServerBean:setApplicationContext:27] - å¯åŠ¨æ³¨å†Œä¸­å¿ƒå®Œæˆ 127.0.0.1 6379
2019-...bean.ServerBean:setApplicationContext:30] - åˆå§‹åŒ–ç”Ÿäº§ç«¯æœåŠ¡ ...
2019-...bean.ServerBean:setApplicationContext:41] - åˆå§‹åŒ–ç”Ÿäº§ç«¯æœåŠ¡å®Œæˆ 10.13.81.104 22201
2019-...bean.ProviderBean:setApplicationContext:35] - æ³¨å†Œç”Ÿäº§è€…ï¼šorg.itstack.demo.test.service.HelloService itStackRpc 0
```

## æ¡†æ¶åº”ç”¨
ä¸ºäº†æµ‹è¯•æˆ‘ä»¬å†™ä¸¤ä¸ªæµ‹è¯•å·¥ç¨‹ï¼›itstack-demo-rpc-providerã€itstack-demo-rpc-consumer


>itstack-demo-rpc-provider æä¾›ç”Ÿäº§è€…æ¥å£

```
itstack-demo-rpc-provider
â”œâ”€â”€ itstack-demo-rpc-provider-export
â”‚   â””â”€â”€ src
â”‚        â””â”€â”€ main
â”‚            â””â”€â”€ java
â”‚                 â””â”€â”€ org.itstack.demo.rpc.provider.export
â”‚                     â”œâ”€â”€ domain 
â”‚                     â”‚   â””â”€â”€ Hi.java
â”‚                     â””â”€â”€ HelloService.java
â”‚   
â””â”€â”€ itstack-demo-rpc-provider-web
    â””â”€â”€ src
         â””â”€â”€ main
             â”œâ”€â”€ java
             â”‚    â””â”€â”€ org.itstack.demo.rpc.provider.web
			 â”‚	      â””â”€â”€ HelloServiceImpl.java
             â””â”€â”€ resources
                  â””â”€â”€ spring
					  â””â”€â”€ spring-itstack-rpc-provider.xml
```

>HelloService.java

```java
public interface HelloService {

    String hi();

    String say(String str);

    String sayHi(Hi hi);

}
```

>HelloServiceImpl.java

```java
@Controller("helloService")
public class HelloServiceImpl implements HelloService {

    @Override
    public String hi() {
        return "hi itstack rpc";
    }

    @Override
    public String say(String str) {
        return str;
    }

    @Override
    public String sayHi(Hi hi) {
        return hi.getUserName() + " sayï¼š" + hi.getSayMsg();
    }

}
```

>spring-itstack-rpc-provider.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpc="http://rpc.itstack.org/schema/rpc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	  http://rpc.itstack.org/schema/rpc http://rpc.itstack.org/schema/rpc/rpc.xsd">

    <!-- æ³¨å†Œä¸­å¿ƒ -->
    <rpc:server id="rpcServer" host="127.0.0.1" port="6379"/>

    <rpc:provider id="helloServiceRpc" nozzle="org.itstack.demo.rpc.provider.export.HelloService"
                  ref="helloService" alias="itstackRpc"/>

</beans>
```


>itstack-demo-rpc-consumer æä¾›æ¶ˆè´¹è€…è°ƒç”¨

```
itstack-demo-rpc-consumer
â””â”€â”€ src
     â”œâ”€â”€ main
     â”‚   â”œâ”€â”€ java    
     â”‚   â””â”€â”€ resources
     â”‚       â””â”€â”€ spring
	 â”‚	         â””â”€â”€ spring-itstack-rpc-consumer.xml
     â”‚   
	 â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org.itstack.demo.test
                 â””â”€â”€ ConsumerTest.java				 
```

>spring-itstack-rpc-consumer.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpc="http://rpc.itstack.org/schema/rpc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	  http://rpc.itstack.org/schema/rpc http://rpc.itstack.org/schema/rpc/rpc.xsd">

    <!-- æ³¨å†Œä¸­å¿ƒ -->
    <rpc:server id="consumer_itstack" host="127.0.0.1" port="6379"/>

    <rpc:consumer id="helloService" nozzle="org.itstack.demo.rpc.provider.export.HelloService" alias="itstackRpc"/>

</beans>
```

>ConsumerTest.java

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration("/spring-config.xml")
public class ConsumerTest {

    @Resource(name = "helloService")
    private HelloService helloService;

    @Test
    public void test() {
        
        String hi = helloService.hi();
        System.out.println("æµ‹è¯•ç»“æœï¼š" + hi);

        String say = helloService.say("hello world");
        System.out.println("æµ‹è¯•ç»“æœï¼š" + say);

        Hi hiReq = new Hi();
        hiReq.setUserName("ä»˜æ ˆ");
        hiReq.setSayMsg("ä»˜å¯æ•Œå›½ï¼Œæ ˆæ— ä¸èƒœ");
        String hiRes = helloService.sayHi(hiReq);

        System.out.println("æµ‹è¯•ç»“æœï¼š" + hiRes);
    }

}
```

## åº”ç”¨ï¼Œæµ‹è¯•ç»“æœ æµ‹è¯•æ—¶å¯åŠ¨redis

### å¯åŠ¨ProviderTest Redisä¸­çš„æ³¨å†Œæ•°æ®

```java
redis 127.0.0.1:6379> srandmember org.itstack.demo.rpc.provider.export.HelloService_itstackRpc
"{\"alias\":\"itstackRpc\",\"host\":\"10.13.81.104\",\"nozzle\":\"org.itstack.demo.rpc.provider.export.HelloService\",\"port\":22201,\"ref\":\"helloService\"}"
redis 127.0.0.1:6379>
```

### æ‰§è¡ŒConsumerTestä¸­çš„å•å…ƒæµ‹è¯•æ–¹æ³•

```java
log4j:WARN No appenders could be found for logger (org.springframework.test.context.junit4.SpringJUnit4ClassRunner).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
æµ‹è¯•ç»“æœï¼šhi itstack rpc
æµ‹è¯•ç»“æœï¼šhello world
æµ‹è¯•ç»“æœï¼šä»˜æ ˆ sayï¼šä»˜å¯æ•Œå›½ï¼Œæ ˆæ— ä¸èƒœ

Process finished with exit code 0
```

å¾®ä¿¡æœç´¢ã€Œ**bugstackè™«æ´æ ˆ**ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ**rpcæ¡ˆä¾‹æºç **ã€è·å–æœ¬æ–‡æºç &æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼

