---
layout: post
category: itstack-demo-netty-3
title: æ‰‹å†™RPCæ¡†æ¶ç¬¬ä¸€ç« ã€Šè‡ªå®šä¹‰é…ç½®xmlã€‹
tagline: by ä»˜æ”¿å§”
tag: [netty,itstack-demo-netty-3]
lock: need
---

# æ‰‹å†™RPCæ¡†æ¶ç¬¬ä¸€ç« ã€Šè‡ªå®šä¹‰é…ç½®xmlã€‹

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## æ¡ˆä¾‹ä»‹ç»
æœ¬æ¡ˆä¾‹é€šè¿‡ä¸‰ä¸ªç« èŠ‚æ¥å®ç°ä¸€å…±ç®€å•çš„rpcæ¡†æ¶ï¼Œç”¨äºæ·±å…¥å­¦ä¹ rpcæ¡†æ¶æ˜¯å¦‚ä½•é€šä¿¡çš„ï¼Œå½“å‰ç« èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰xmlæ–‡ä»¶å¹¶è¿›è¡Œè§£æã€‚æƒ³è§£æè‡ªå®šä¹‰çš„xmlé¦–å…ˆå®šä¹‰è‡ªå·±çš„xsdæ–‡ä»¶ï¼Œå¹¶ä¸”å®ç°springçš„NamespaceHandlerSupportã€BeanDefinitionParserï¼Œä¸¤ä¸ªæ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®
RPCï¼ˆRemote Procedure Callï¼‰â€”è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚RPCåè®®å‡å®šæŸäº›ä¼ è¾“åè®®çš„å­˜åœ¨ï¼Œå¦‚TCPæˆ–UDPï¼Œä¸ºé€šä¿¡ç¨‹åºä¹‹é—´æºå¸¦ä¿¡æ¯æ•°æ®ã€‚åœ¨OSIç½‘ç»œé€šä¿¡æ¨¡å‹ä¸­ï¼ŒRPCè·¨è¶Šäº†ä¼ è¾“å±‚å’Œåº”ç”¨å±‚ã€‚RPCä½¿å¾—å¼€å‘åŒ…æ‹¬ç½‘ç»œåˆ†å¸ƒå¼å¤šç¨‹åºåœ¨å†…çš„åº”ç”¨ç¨‹åºæ›´åŠ å®¹æ˜“ã€‚
RPCé‡‡ç”¨å®¢æˆ·æœº/æœåŠ¡å™¨æ¨¡å¼ã€‚è¯·æ±‚ç¨‹åºå°±æ˜¯ä¸€ä¸ªå®¢æˆ·æœºï¼Œè€ŒæœåŠ¡æä¾›ç¨‹åºå°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ã€‚é¦–å…ˆï¼Œå®¢æˆ·æœºè°ƒç”¨è¿›ç¨‹å‘é€ä¸€ä¸ªæœ‰è¿›ç¨‹å‚æ•°çš„è°ƒç”¨ä¿¡æ¯åˆ°æœåŠ¡è¿›ç¨‹ï¼Œç„¶åç­‰å¾…åº”ç­”ä¿¡æ¯ã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼Œè¿›ç¨‹ä¿æŒç¡çœ çŠ¶æ€ç›´åˆ°è°ƒç”¨ä¿¡æ¯åˆ°è¾¾ä¸ºæ­¢ã€‚å½“ä¸€ä¸ªè°ƒç”¨ä¿¡æ¯åˆ°è¾¾ï¼ŒæœåŠ¡å™¨è·å¾—è¿›ç¨‹å‚æ•°ï¼Œè®¡ç®—ç»“æœï¼Œå‘é€ç­”å¤ä¿¡æ¯ï¼Œç„¶åç­‰å¾…ä¸‹ä¸€ä¸ªè°ƒç”¨ä¿¡æ¯ï¼Œæœ€åï¼Œå®¢æˆ·ç«¯è°ƒç”¨è¿›ç¨‹æ¥æ”¶ç­”å¤ä¿¡æ¯ï¼Œè·å¾—è¿›ç¨‹ç»“æœï¼Œç„¶åè°ƒç”¨æ‰§è¡Œç»§ç»­è¿›è¡Œã€‚

>Dubboæ˜¯ [1]  é˜¿é‡Œå·´å·´å…¬å¸å¼€æºçš„ä¸€ä¸ªé«˜æ€§èƒ½ä¼˜ç§€çš„æœåŠ¡æ¡†æ¶ï¼Œä½¿å¾—åº”ç”¨å¯é€šè¿‡é«˜æ€§èƒ½çš„ RPC å®ç°æœåŠ¡çš„è¾“å‡ºå’Œè¾“å…¥åŠŸèƒ½ï¼Œå¯ä»¥å’Œ [2]  Springæ¡†æ¶æ— ç¼é›†æˆã€‚
Dubboæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€è½»é‡çº§çš„å¼€æºJava RPCæ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šé¢å‘æ¥å£çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ™ºèƒ½å®¹é”™å’Œè´Ÿè½½å‡è¡¡ï¼Œä»¥åŠæœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°ã€‚

## ç¯å¢ƒå‡†å¤‡
1. jdk 1.8.0
2. IntelliJ IDEA Community Edition 2018.3.1 x64

## ä»£ç ç¤ºä¾‹
```
itstack-demo-rpc-01
â””â”€â”€ src
    â””â”€â”€ main
    â”‚    â”œâ”€â”€ java
    â”‚    â”‚   â””â”€â”€ org.itstack.demo.rpc.config
    â”‚    â”‚        â”œâ”€â”€ spring
    â”‚    â”‚        â”‚   â”œâ”€â”€ bean
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ ConsumerBean.java
    â”‚    â”‚        â”‚   â”‚   â”œâ”€â”€ ProviderBean.java
    â”‚    â”‚        â”‚   â”‚   â””â”€â”€ ServerBean.java 
    â”‚    â”‚        â”‚   â”œâ”€â”€ MyBeanDefinitionParser.java   
    â”‚    â”‚        â”‚   â””â”€â”€ MyNamespaceHandler.java
    â”‚    â”‚        â”œâ”€â”€ ConsumerConfig.java   
    â”‚    â”‚        â”œâ”€â”€ ProviderConfig.java   
    â”‚    â”‚        â””â”€â”€ ProviderConfig.java   
    â”‚    â””â”€â”€ resource
    â”‚        â””â”€â”€ META-INF
    â”‚            â”œâ”€â”€ rpc.xsd
    â”‚            â”œâ”€â”€ spring.handlers
    â”‚            â””â”€â”€ spring.schemas 
    â””â”€â”€ test
         â”œâ”€â”€ java
         â”‚   â””â”€â”€ org.itstack.demo.test
         â”‚       â”œâ”€â”€ service
         â”‚       â”‚   â”œâ”€â”€ impl
         â”‚       â”‚   â”‚   â””â”€â”€ HelloServiceImpl.java  
         â”‚       â”‚   â””â”€â”€ HelloService.java
         â”‚       â””â”€â”€ ApiTest.java                
         â””â”€â”€ resource  
             â”œâ”€â”€ itstack-rpc-consumer.xml        
             â”œâ”€â”€ itstack-rpc-provider.xml
             â””â”€â”€ log4j.xml
```

>ProviderConfig.java

```java
public class ProviderConfig {

    private String nozzle; //æ¥å£
    private String ref;    //æ˜ å°„
    private String alias;  //åˆ«å

    //å‘å¸ƒ
    protected void doExport() {
        System.out.format("ç”Ÿäº§è€…ä¿¡æ¯=> [æ¥å£ï¼š%s] [æ˜ å°„ï¼š%s] [åˆ«åï¼š%s] \r\n", nozzle, ref, alias);
    }

    public String getNozzle() {
        return nozzle;
    }

    public void setNozzle(String nozzle) {
        this.nozzle = nozzle;
    }

    public String getRef() {
        return ref;
    }

    public void setRef(String ref) {
        this.ref = ref;
    }

    public String getAlias() {
        return alias;
    }

    public void setAlias(String alias) {
        this.alias = alias;
    }
}
```

>ProviderBean.java

```java
public class ProviderBean extends ProviderConfig implements ApplicationContextAware {

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        //å‘å¸ƒç”Ÿäº§è€…
        doExport();
    }

}
```

>MyBeanDefinitionParser.java

```java
public class MyBeanDefinitionParser implements BeanDefinitionParser {

    private final Class<?> beanClass;

    MyBeanDefinitionParser(Class<?> beanClass) {
        this.beanClass = beanClass;
    }

    @Override
    public BeanDefinition parse(Element element, ParserContext parserContext) {

        RootBeanDefinition beanDefinition = new RootBeanDefinition();
        beanDefinition.setBeanClass(beanClass);
        beanDefinition.setLazyInit(false);
        String beanName = element.getAttribute("id");
        parserContext.getRegistry().registerBeanDefinition(beanName, beanDefinition);

        for (Method method : beanClass.getMethods()) {
            if (!isProperty(method, beanClass)) continue;
            String name = method.getName();
            String methodName = name.substring(3, 4).toLowerCase() + name.substring(4);
            String value = element.getAttribute(methodName);
            beanDefinition.getPropertyValues().addPropertyValue(methodName, value);
        }

        return beanDefinition;
    }

    private boolean isProperty(Method method, Class beanClass) {

        String methodName = method.getName();
        boolean flag = methodName.length() > 3 && methodName.startsWith("set") && Modifier.isPublic(method.getModifiers()) && method.getParameterTypes().length == 1;
        Method getter = null;
        if (!flag) return false;

        Class<?> type = method.getParameterTypes()[0];
        try {
            getter = beanClass.getMethod("get" + methodName.substring(3));
        } catch (NoSuchMethodException ignore) {

        }

        if (null == getter) {
            try {
                getter = beanClass.getMethod("is" + methodName.substring(3));
            } catch (NoSuchMethodException ignore) {

            }
        }

        flag = getter != null && Modifier.isPublic(getter.getModifiers()) && type.equals(getter.getReturnType());

        return flag;

    }

}
```

>MyNamespaceHandler.java

```java
public class MyNamespaceHandler extends NamespaceHandlerSupport {

    @Override
    public void init() {
        registerBeanDefinitionParser("consumer", new MyBeanDefinitionParser(ConsumerBean.class));
        registerBeanDefinitionParser("provider", new MyBeanDefinitionParser(ProviderBean.class));
        registerBeanDefinitionParser("server", new MyBeanDefinitionParser(ServerBean.class));
    }

}
```

>rpc.xsd

```xml
<?xml version="1.0" encoding="UTF-8"?>
<xsd:schema xmlns="http://rpc.itstack.org/schema/rpc"
            xmlns:xsd="http://www.w3.org/2001/XMLSchema"
            xmlns:beans="http://www.springframework.org/schema/beans"
            targetNamespace="http://rpc.itstack.org/schema/rpc"
            elementFormDefault="qualified" attributeFormDefault="unqualified">
    <xsd:import namespace="http://www.springframework.org/schema/beans"/>

    <!-- org.itstack.demo.rpc.config.ServerConfig -->
    <xsd:element name="server">
        <xsd:complexType>
            <xsd:complexContent>
                <xsd:extension base="beans:identifiedType">
                    <xsd:attribute name="host" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æ ˆå°åœ°ç‚¹ ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                    <xsd:attribute name="port" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æ ˆå°å²¸å£  ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                </xsd:extension>
            </xsd:complexContent>
        </xsd:complexType>
    </xsd:element>

    <!-- org.itstack.demo.rpc.config.ConsumerConfig -->
    <xsd:element name="consumer">
        <xsd:complexType>
            <xsd:complexContent>
                <xsd:extension base="beans:identifiedType">
                    <xsd:attribute name="nozzle" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æ¥å£åç§° ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                    <xsd:attribute name="alias" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æœåŠ¡åˆ«ååˆ†ç»„ä¿¡æ¯  ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                </xsd:extension>
            </xsd:complexContent>
        </xsd:complexType>
    </xsd:element>

    <!-- org.itstack.demo.rpc.config.ProviderConfig -->
    <xsd:element name="provider">
        <xsd:complexType>
            <xsd:complexContent>
                <xsd:extension base="beans:identifiedType">
                    <xsd:attribute name="nozzle" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æ¥å£åç§° ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                    <xsd:attribute name="ref" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æ¥å£å®ç°ç±»  ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                    <xsd:attribute name="alias" type="xsd:string">
                        <xsd:annotation>
                            <xsd:documentation><![CDATA[ æœåŠ¡åˆ«ååˆ†ç»„ä¿¡æ¯  ]]></xsd:documentation>
                        </xsd:annotation>
                    </xsd:attribute>
                </xsd:extension>
            </xsd:complexContent>
        </xsd:complexType>
    </xsd:element>
</xsd:schema>
```

>spring.handlers

```
http\://rpc.itstack.org/schema/rpc=org.itstack.demo.rpc.config.spring.MyNamespaceHandler
```

>spring.schemas

```
http\://rpc.itstack.org/schema/rpc/rpc.xsd=META-INF/rpc.xsd
```

## æµ‹è¯•éƒ¨åˆ†

>itstack-rpc-consumer.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpc="http://rpc.itstack.org/schema/rpc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	  http://rpc.itstack.org/schema/rpc http://rpc.itstack.org/schema/rpc/rpc.xsd">

    <!-- redisé…ç½®ï¼Œä¿å­˜é“¾æ¥ -->
    <rpc:server id="consumer_itstack" host="127.0.0.1" port="6379"/>

    <rpc:consumer id="consumer_helloService" nozzle="org.itstack.demo.test.service.HelloService" alias="itStackRpc"/>

</beans>
```

>itstack-rpc-provider.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpc="http://rpc.itstack.org/schema/rpc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	  http://rpc.itstack.org/schema/rpc http://rpc.itstack.org/schema/rpc/rpc.xsd">

    <rpc:provider id="provider_helloService" nozzle="org.itstack.demo.test.service.HelloService"
                 ref="helloService" alias="itStackRpc" />

</beans>
```

>ApiTest.java

```java
package org.itstack.demo.test;

import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/5/4
 * æœ¬ç« èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•è¯»å–è‡ªå®šä¹‰é…ç½®xmlæ–‡ä»¶å­—æ®µä¿¡æ¯
 */
public class ApiTest {

    public static void main(String[] args) {
        String[] configs = {"itstack-rpc-consumer.xml", "itstack-rpc-provider.xml"};
        new ClassPathXmlApplicationContext(configs);
    }

}
```

## æµ‹è¯•ç»“æœ

```java
2019-05-07 19:44:24,805 main  INFO [org.springframework.context.support.ClassPathXmlApplicationContext:prepareRefresh:510] - Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@299a06ac: startup date [Tue May 07 19:44:24 CST 2019]; root of context hierarchy
2019-05-07 19:44:24,872 main  INFO [org.springframework.beans.factory.xml.XmlBeanDefinitionReader:loadBeanDefinitions:315] - Loading XML bean definitions from class path resource [itstack-rpc-consumer.xml]
2019-05-07 19:44:24,972 main  INFO [org.springframework.beans.factory.xml.XmlBeanDefinitionReader:loadBeanDefinitions:315] - Loading XML bean definitions from class path resource [itstack-rpc-provider.xml]
2019-05-07 19:44:25,008 main  INFO [org.springframework.beans.factory.support.DefaultListableBeanFactory:preInstantiateSingletons:577] - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@192b07fd: defining beans [consumer_itstack,consumer_helloService,provider_helloService]; root of factory hierarchy
æœåŠ¡ç«¯ä¿¡æ¯=> [æ³¨å†Œä¸­å¿ƒåœ°å€ï¼š127.0.0.1] [æ³¨å†Œä¸­å¿ƒç«¯å£ï¼š6379] 
ç”Ÿäº§è€…ä¿¡æ¯=> [æ¥å£ï¼šorg.itstack.demo.test.service.HelloService] [æ˜ å°„ï¼šhelloService] [åˆ«åï¼šitStackRpc] 
```

å¾®ä¿¡æœç´¢ã€Œ**bugstackè™«æ´æ ˆ**ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ**rpcæ¡ˆä¾‹æºç **ã€è·å–æœ¬æ–‡æºç &æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼
