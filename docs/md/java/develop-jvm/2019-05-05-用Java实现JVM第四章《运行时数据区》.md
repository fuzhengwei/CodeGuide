---
layout: post
category: itstack-demo-jvm
title: ç”¨Javaå®ç°JVMç¬¬å››ç« ã€Šè¿è¡Œæ—¶æ•°æ®åŒºã€‹
tagline: by ä»˜æ”¿å§”
tag: [jvm,itstack-demo-jvm]
---

# ç”¨Javaå®ç°JVMç¬¬å››ç« ã€Šè¿è¡Œæ—¶æ•°æ®åŒºã€‹

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

![](https://fuzhengwei.github.io/assets/images/pic-content/2019/08/jvm04.png)

## æ¡ˆä¾‹ä»‹ç»
æœ¬æ¡ˆä¾‹åˆæ­¥å®ç°è¿è¡Œæ—¶æ•°æ®åŒºé‡Œï¼›çº¿ç¨‹ã€Javaè™šæ‹Ÿæœºæ ˆã€å¸§ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨ã€‚
>åœ¨è¿è¡ŒJavaç¨‹åºæ—¶ï¼ŒJavaè™šæ‹Ÿæœºéœ€è¦ä½¿ç”¨å†…å­˜æ¥å­˜æ”¾å„ç§å„æ ·çš„æ•°æ®ã€‚Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠè¿™äº›å†…å­˜åŒºåŸŸå«ä½œè¿è¡Œæ—¶æ•°æ®åŒºã€‚è¿è¡Œæ—¶æ•°æ®åŒºå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ï¼Œå¦ä¸€ç±»åˆ™æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚å¤šçº¿ç¨‹å…±äº«çš„è¿è¡Œæ—¶æ•°æ®åŒºéœ€è¦åœ¨Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºå¥½åœ¨Javaè™šæ‹Ÿæœºæ¨å‡ºæ—¶é”€æ¯ã€‚çº¿ç¨‹ç§æœ‰çš„è¿è¡Œæ—¶æ•°æ®åŒºåˆ™åœ¨åˆ›å»ºçº¿ç¨‹æ—¶æ‰åˆ›å»ºï¼Œçº¿ç¨‹é€€å‡ºæ—¶é”€æ¯ã€‚

>çº¿ç¨‹ç§æœ‰çš„è¿è¡Œæ—¶æ•°æ®åŒºç”¨äºè¾…åŠ©æ‰§è¡ŒJavaå­—èŠ‚ç ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„pcå¯„å­˜å™¨ï¼ˆProgram Counterï¼‰å’ŒJavaè™šæ‹Ÿæœºæ ˆï¼ˆJVM Stackï¼‰ã€‚Javaè™šæ‹Ÿæœºæ ˆåˆç”±æ ˆå¸§ï¼ˆStack Frameï¼Œåé¢ç®€ç§°å¸§ï¼‰æ„æˆï¼Œå¸§ä¸­ä¿å­˜æ–¹æ³•æ‰§è¡Œçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variableï¼‰å’Œæ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰ç­‰ã€‚åœ¨ä»»ä¸€æ—¶åˆ»ï¼ŒæŸä¸€çº¿ç¨‹è‚¯å®šæ˜¯åœ¨æ‰§è¡ŒæŸä¸ªæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å«ä½œè¯¥çº¿ç¨‹çš„å½“å‰æ–¹æ³•ï¼›æ‰§è¡Œè¯¥æ–¹æ³•çš„å¸§å«ä½œçº¿ç¨‹çš„å½“å‰å¸§ï¼›å£°æ˜è¯¥æ–¹æ³•çš„ç±»å«ä½œå½“å‰ç±»ã€‚å¦‚æœå½“å‰æ–¹æ³•æ˜¯Javaæ–¹æ³•ï¼Œåˆ™pcå¯„å­˜å™¨ä¸­å­˜æ”¾å½“å‰æ­£åœ¨æ‰§è¡Œçš„Javaè™šæ‹ŸæœºæŒ‡ä»¤çš„åœ°å€ï¼Œå¦åˆ™ï¼Œå½“å‰æ–¹æ³•æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œpcå¯„å­˜å™¨ä¸­çš„å€¼æ²¡æœ‰æ˜ç¡®å®šä¹‰ã€‚

```java
Run-Time Data Area
â”œâ”€â”€ Thread
â”‚   â””â”€â”€ pc
â”‚  	â””â”€â”€ Jvm Stack  
â”‚       â””â”€â”€ Frame
â”‚  	        â”œâ”€â”€ Local Variable
â”‚  	        â””â”€â”€ Operand Stack
â””â”€â”€ Heap
    â”œâ”€â”€ Method Area
	â”‚   â””â”€â”€ Class
	â”‚       â”œâ”€â”€ Run-Time
	â”‚ 	    â””â”€â”€ Constant Pool
	â””â”€â”€ Object
```

## ç¯å¢ƒå‡†å¤‡
1. jdk 1.8.0
2. IntelliJ IDEA Community Edition 2018.3.1 x64

## é…ç½®ä¿¡æ¯
1. è°ƒè¯•é…ç½®
    1. é…ç½®ä½ç½®ï¼šRun/Debug Configurations -> program arguments
    2. é…ç½®å†…å®¹ï¼š-Xjre "C:\Program Files\Java\jdk1.8.0_161\jre" E:\itstack\git\istack-demo\itstack-demo-jvm\itstack-demo-jvm-04\target\test-classes\org\itstack\demo\test\HelloWorld

## ä»£ç ç¤ºä¾‹
```java
itstack-demo-jvm-04
â”œâ”€â”€ pom.xml
â””â”€â”€ src
    â””â”€â”€ main
    â”‚    â””â”€â”€ java
    â”‚        â””â”€â”€ org.itstack.demo.jvm
	â”‚             â”œâ”€â”€ classfile
    â”‚             â”‚   â”œâ”€â”€ attributes   {BootstrapMethods/Code/ConstantValue...}
    â”‚             â”‚   â”œâ”€â”€ constantpool {CONSTANT_TAG_CLASS/CONSTANT_TAG_FIELDREF/CONSTANT_TAG_METHODREF...}
    â”‚             â”‚   â”œâ”€â”€ ClassFile.java
    â”‚             â”‚   â”œâ”€â”€ ClassReader.java
    â”‚             â”‚   â””â”€â”€ MemberInfo.java	
    â”‚             â”œâ”€â”€ classpath
    â”‚             â”‚   â”œâ”€â”€ impl
    â”‚             â”‚   â”‚   â”œâ”€â”€ CompositeEntry.java
    â”‚             â”‚   â”‚   â”œâ”€â”€ DirEntry.java 
    â”‚             â”‚   â”‚   â”œâ”€â”€ WildcardEntry.java 
    â”‚             â”‚   â”‚   â””â”€â”€ ZipEntry.java    
    â”‚             â”‚   â”œâ”€â”€ Classpath.java
    â”‚             â”‚   â””â”€â”€ Entry.java   
    â”‚             â”œâ”€â”€ rtda
    â”‚             â”‚   â”œâ”€â”€ Frame.java
    â”‚             â”‚   â”œâ”€â”€ JvmStack.java
    â”‚             â”‚   â”œâ”€â”€ LocalVars.java
    â”‚             â”‚   â”œâ”€â”€ OperandStack.java
    â”‚             â”‚   â”œâ”€â”€ Slot.java	
    â”‚             â”‚   â””â”€â”€ Thread.java
    â”‚             â”œâ”€â”€ Cmd.java
    â”‚             â””â”€â”€ Main.java
    â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org.itstack.demo.test
                 â””â”€â”€ HelloWorld.java
```

>Frame.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * æ ˆå¸§
 */
public class Frame {

    //stack is implemented as linked list
    Frame lower;

    //å±€éƒ¨å˜é‡è¡¨
    private LocalVars localVars;

    //æ“ä½œæ•°æ ˆ
    private OperandStack operandStack;

    public Frame(int maxLocals, int maxStack) {
        this.localVars = new LocalVars(maxLocals);
        this.operandStack = new OperandStack(maxStack);
    }

    public LocalVars localVars(){
        return localVars;
    }

    public OperandStack operandStack(){
        return operandStack;
    }

}
```

>JvmStack.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * è™šæ‹Ÿæœºæ ˆ
 */
public class JvmStack {

    private int maxSize;
    private int size;
    private Frame _top;

    public JvmStack(int maxSize) {
        this.maxSize = maxSize;
    }

    public void push(Frame frame) {
        if (this.size > this.maxSize) {
            throw new StackOverflowError();
        }

        if (this._top != null) {
            frame.lower = this._top;
        }

        this._top = frame;
        this.size++;
    }

    public Frame pop() {
        if (this._top == null) {
            throw new RuntimeException("jvm stack is empty!");
        }

        Frame top = this._top;
        this._top = top.lower;
        top.lower = null;
        this.size--;

        return top;
    }

    public Frame top(){
        if (this._top == null){
            throw new RuntimeException("jvm stack is empty!");
        }
        return this._top;
    }

}
```
>LocalVars.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * å±€éƒ¨å˜é‡è¡¨
 */
public class LocalVars {

    private Slot[] slots;

    public LocalVars(int maxLocals) {
        if (maxLocals > 0) {
            slots = new Slot[maxLocals];
            for (int i = 0; i < maxLocals; i++) {
                slots[i] = new Slot();
            }
        }
    }

    public void setInt(int idx, int val) {
        this.slots[idx].num = val;
    }

    public int getInt(int idx) {
        return slots[idx].num;
    }

    public void setFloat(int idx, float val) {
        this.slots[idx].num = (Float.valueOf(val)).intValue();
    }

    public Float getFloat(int idx) {
        int num = this.slots[idx].num;
        return (float) num;
    }

    public void setLong(int idx, long val) {
        this.slots[idx].num = (int) val;
        this.slots[idx + 1].num = (int) (val >> 32);
    }

    public Long getLong(int idx) {
        int low = this.slots[idx].num;
        int high = this.slots[idx + 1].num;
        return ((long) high << 32) | (long) low;
    }

    public void setDouble(int idx, double val) {
        setLong(idx, (long) val);
    }

    public Double getDouble(int idx) {
        return Double.valueOf(getLong(idx));
    }

    public void setRef(int idx, Object ref) {
        slots[idx].ref = ref;
    }

    public Object getRef(int idx) {
        return slots[idx].ref;
    }

}
```

>OperandStack.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * æ“ä½œæ•°æ ˆ
 */
public class OperandStack {

    private int size = 0;
    private Slot[] slots;

    public OperandStack(int maxStack) {
        if (maxStack > 0) {
            slots = new Slot[maxStack];
            for (int i = 0; i < maxStack; i++) {
                slots[i] = new Slot();
            }
        }
    }

    public void pushInt(int val) {
        slots[size].num = val;
        size++;
    }

    public int popInt(){
        size --;
        return slots[size].num;
    }

    public void pushRef(Object ref){
        slots[size].ref = ref;
        size++;
    }

    public Object popRef(){
        size --;
        Object ref = slots[size].ref;
        slots[size].ref = null;
        return ref;
    }

}
```

>Slot.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * æ•°æ®æ§½
 */
public class Slot {

    int num;
    Object ref;

}
```

>Thread.java

```java
package org.itstack.demo.jvm.rtda;

/**
 * http://www.itstack.org
 * create by fuzhengwei on 2019/4/26
 * çº¿ç¨‹
 */
public class Thread {

    //Program Counter å¯„å­˜å™¨
    private int pc;

    //è™šæ‹Ÿæœºæ ˆ
    private JvmStack stack;

    public Thread(){
        this.stack = new JvmStack(1024);
    }

    public int pc(){
        return this.pc;
    }

    public void setPC(int pc){
        this.pc = pc;
    }

    public void pushFrame(Frame frame){
        this.stack.push(frame);
    }

    public Frame popFrame(){
        return this.stack.pop();
    }

    public Frame currentFrame(){
        return this.stack.top();
    }

}
```

## æµ‹è¯•ç»“æœ
```java
100
-100
null
-100
```

å¾®ä¿¡æœç´¢ã€Œ**bugstackè™«æ´æ ˆ**ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ**ç”¨Javaå®ç°jvmæºç **ã€è·å–æœ¬æ–‡æºç &æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼
