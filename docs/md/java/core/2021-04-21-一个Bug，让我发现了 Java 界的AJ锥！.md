---
layout: post
category: itstack-code-life
title: ä¸€ä¸ªBugï¼Œè®©æˆ‘å‘ç°äº† Java ç•Œçš„.AJ(é”¥)ï¼
tagline: by å°å‚…å“¥
tag: [java,itstack-code-life]
excerpt: ä¼™ä¼´å­¦å°å‚…å“¥çš„ä¸­é—´ä»¶ï¼Œè¯´å†™ä¸ªåˆ‡é¢è¿è¡Œä¸äº†ï¼Œæ’æŸ¥BUGåŸå°¾è¿‡ç¨‹åˆ†æè¿˜å­¦åˆ°äº†æ–°çŸ¥è¯†ã€‚æ¥ä¸‹æ¥æˆ‘å¸¦ç€å¤§å®¶ä¸€èµ·çœ‹çœ‹ä»€ä¹ˆæ˜¯å¿«ä¹æ˜Ÿçƒï¼Œä»–æ˜¯æ€ä¹ˆä¸€é¡¿éªšæ“ä½œè®©åˆ‡é¢æ‹¦æˆªä¸åˆ°çš„ï¼
lock: need
---

# ä¸€ä¸ªBugï¼Œè®©æˆ‘å‘ç°äº† Java ç•Œçš„.AJ(é”¥)ï¼

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)
<br/>åŸæ–‡ï¼š[https://mp.weixin.qq.com/s/ArZX-gA1WTon864tjtvjag](https://mp.weixin.qq.com/s/ArZX-gA1WTon864tjtvjag)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`è¯æˆ‘æ”¾è¿™ï¼Œè¸©è¿‡çš„å‘è¶Šå¤šå¤´å‘è¶Šå°‘ï¼`

è¯´æ¥ä¹Ÿæ˜¯å¥‡æ€ªï¼Œåªè¦æ˜¯å­¦ç¼–ç¨‹çš„ï¼Œä»åˆæ¬¡æ¥è§¦çš„ Java åˆ°å®‰è£… JDKã€IDEAã€MYSQLï¼Œ å†åˆ°æ¥è§¦ Springã€MyBatisã€RPCã€MQï¼Œå“ªæ€•æœ‰æ—¶å€™åœ¨æµ…çš„å‘ä¹Ÿä¼šè·³è¿›å»å°å°é²œï¼Œä¸€éæŠ“ç€å¤´å‘ï¼Œä¸€æ‰‹ç‚¹ç€é¼ æ ‡ä¹Ÿå‡ ä¹æ˜¯ä½ çš„å¸¸æ€ã€‚*ä½ çš„é”®ç›˜é‡Œæ€»æ˜¯æœ‰å¾ˆå¤šè¢«æŠ“ç¢çš„å¤´å‘ï¼*

ä½†ï¼Œå“ªæ€•æ˜¯æŠ“äº†è¿™ä¹ˆå¤´å‘ï¼Œè¿˜æ˜¯é‡åˆ°äº†ä¸€ä¸ªæ»¡è„‘å­éƒ½æ˜¯éªšæ“ä½œçš„å°ä¼™ã€‚**â€œå‚…å“¥ï¼Œæˆ‘çš„åˆ‡é¢æ€ä¹ˆæ‹¦æˆªä¸åˆ°ï¼Ÿæˆ‘æ˜¯ç…§ç€ä½ çš„[ã€ŠSpringBoot ä¸­é—´ä»¶è®¾è®¡å’Œå¼€å‘ã€‹](https://bugstack.cn/itstack-ark-middleware/2021/03/31/SpringBoot-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%BC%80%E5%8F%91-%E4%B8%93%E6%A0%8F%E5%B0%8F%E5%86%8C%E4%B8%8A%E7%BA%BF%E5%95%A6.html)ä¸“æ å†™çš„ï¼Œä½ ç»™æˆ‘çœ‹çœ‹å§ï¼Œæˆ‘éƒ½å¼„äº†ä¸€å¤©äº†â€**

æ¥ä¸‹æ¥æˆ‘å¸¦ç€å¤§å®¶ä¸€èµ·çœ‹çœ‹ä»€ä¹ˆæ˜¯å¿«ä¹æ˜Ÿçƒï¼Œä»–æ˜¯æ€ä¹ˆä¸€é¡¿éªšæ“ä½œè®©åˆ‡é¢æ‹¦æˆªä¸åˆ°çš„ï¼

## äºŒã€æ»¡è„‘å­éƒ½æ˜¯éªšæ“ä½œ

### 1. é‡åˆ°é—®é¢˜

ä¸Šå‘¨ï¼Œè°¢é£æœº(~~åŒ–å~~)å‘è¿‡æ¥äº†è‡ªå·±çš„æ‰‹æ’¸çš„ä¸­é—´ä»¶æºç ï¼Œè¯´è¿™ä»£ç éƒ½æ²¡æœ‰å•¥æ€ä¹ˆå°±ä¸èƒ½åˆ‡é¢å‘¢ï¼Ÿ

![](https://bugstack.cn/assets/images/story/story-2-01.png)

- æœ€å¼€å§‹æˆ‘å¤§æ„äº†ï¼Œè®©è°¢é£æœºå‘äº†ä¸€äº›ä»£ç æˆªå›¾ã€‚
- çœ‹æˆªå›¾çš„ä»£ç ï¼Œè¿™å®Œå…¨å°±å’Œæˆ‘å†™çš„ä¸­é—´ä»¶é‡Œçš„ä»£ç ä¸€æ¯›ä¸€æ ·ï¼Œæ²¡å•¥é—®é¢˜å‘€ï¼ŒåŒ…è·¯å¾„ä¹Ÿèƒ½æ‰«æåˆ°ï¼Œå’‹å°±ä¸èƒ½åˆ‡é¢äº†ï¼Ÿ
- æˆ‘è¯´ä½ æ‰“ä¸ªæ–­ç‚¹è°ƒè¯•ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆåˆ‡ä¸åˆ°äº†å‘¢ï¼Ÿå˜¿ï¼Œè°ƒè¯•äº†ï¼Œç›´æ¥é€šè¿‡ï¼Œå°±æ˜¯æ²¡åˆ‡é¢åˆ°ã€‚
- æ­¤æ—¶æˆ‘æ€è€ƒäº†JDKç‰ˆæœ¬ã€ç¯å¢ƒé…ç½®ã€Springä¸Šä¸‹æ–‡ã€åˆ‡é¢çš„å®šä¹‰ã€åŒ…çš„è·¯å¾„ä»¥åŠè¿™å°å­æ˜¯å¦å¿½æ‚ æˆ‘ï¼Ÿ
- æœ€åæˆ‘æŠ±ç€è¿™å°å­å¿½æ‚ æˆ‘çš„å¿ƒé‡Œï¼ŒæŠŠæºç è¦è¿‡æ¥äº†ã€‚

### 2. å‘ç°é—®é¢˜

çœ‹äº†å‡ éæºç æ²¡å‘ç°é—®é¢˜ï¼Œå¼€å§‹è°ƒè¯•ï¼Œè¿˜çœŸå®ƒå“ˆæ‹‰å“¨çš„ä¸è¿›è¿™ä¸ªåˆ‡é¢ï¼Œæ¥ä¸‹æ¥ï¼›
- è°¢é£æœºçš„æºç ä¿ç•™ï¼Œå¤åˆ¶å‡ºæ¥ä¸€ä»½æ–°çš„ã€‚
- æˆ‘çš„ç›®çš„è¦å…ˆè®©ä»–è·‘èµ·æ¥ï¼Œåœ¨ç ”ç©¶ã€‚æ¥ä¸‹æ¥æˆ‘æŠŠè‡ªå·±çš„å·¥ç¨‹é‡Œçš„ `DoJoinPoint` æ‹·è´è¿‡æ¥ç²˜è´´è¿›å»ï¼Œå™—å¯Ÿä¸€ä¸‹è´´è¿›å»äº†ï¼Œæ²¡æç¤ºæ›¿æ¢ï¼Œè™½ç„¶æœ‰æŠ¥é”™ä½†ä¸¤ä¸ªç±»èƒ½å…±å­˜ï¼Œå¦‚ä¸‹ï¼š
 ![](https://bugstack.cn/assets/images/story/story-2-02.png)
  - è¿™å°±ç¥å¥‡äº†å“ˆï¼Œæˆ‘å½“æ—¶æ€€ç–‘æ˜¯ä¸å®ƒé‚£ `DoJoinPoint` ä¸æ˜¯ä¸€ä¸ªæ­£ç» Java ç±»ï¼Œè·¯å¾„ä¸å¯¹ï¼Ÿæœ‰çœ‹ä¸è§çš„ç‰¹æ®Šå­—ç¬¦ï¼Ÿ
- æ—¢ç„¶å‘ç°è¿™ä¸ªç±»ä¸å¯¹ï¼Œé‚£è¡Œå…ˆåˆ æ‰ã€‚è®©ç¨‹åºå…ˆè·‘èµ·æ¥ï¼Œç¡®ä¿é™¤äº†è¿™ä¸ªç±»å…¶ä»–çš„å†…å®¹æ²¡æœ‰é—®é¢˜ï¼Œè¿™æ ·ä¹Ÿå¥½æ’æŸ¥é—®é¢˜ã€‚
- è¿˜åˆ«è¯´ï¼Œå»æ‰è¿™ä¸ªé”™è¯¯ç±»ï¼Œç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œæ‹¦æˆªåˆ°åˆ‡é¢å†…å®¹äº†ã€‚
- æ—¢ç„¶ç¨‹åºèƒ½è·‘äº†ï¼Œæˆ‘å°±æƒ³ç€è¿™å¯ä»¥çœ‹çœ‹é—®é¢˜å‡ºåœ¨å“ªäº†ï¼Œæ²¡æƒ³åˆ°å°±åªæ‰“å¼€ä¸ªæ–‡ä»¶å¤¹ï¼Œå°±å‘ç°äº†ä¸€ä¸ªç¥å¥‡çš„**AJ**ï¼è¿™è´§å‹æ ¹å°±ä¸æ˜¯ Java ç±»ï¼
  ![](https://bugstack.cn/assets/images/story/story-2-03.png)

### 3. æ’æŸ¥é—®é¢˜

è¦ä¸æ˜¯IDEAæŠŠ `.aj` è¿™è´§æ˜¾ç¤ºæˆ C ç±»çš„å›¾æ ‡ï¼Œå¯èƒ½æ—©å°±å‘ç°é—®é¢˜äº†ã€‚ç´§æ¥ç€æŠŠè¿™é”™è¯¯ç±»çš„æˆªå›¾å‘ç»™äº†è°¢é£æœºï¼Œé—®å®ƒä½ æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Ÿ*ä»–è¯´å®è¯äº†*
- è°¢é£æœºå…ˆè¯´è‡ªå·±å·æ‡’äº†ï¼Œå“ˆå“ˆå“ˆï¼Œè®©äººæ€ªä¸å¥½æ„æ€çš„ï¼
- ä»–è¯´åœ¨åˆ›å»º `DoJoinPoint` æ—¶ï¼Œçœ‹åˆ°ä¸€ä¸ª Aspect çš„é€‰é¡¹ï¼Œä»¥ä¸ºè¿™ä¸ªå°±æ˜¯åˆ›å»ºåˆ‡é¢çš„å¿«æ·æ“ä½œï¼Œå¦‚å›¾ï¼›
  ![](https://bugstack.cn/assets/images/story/story-2-04.png)
- åˆ›å»ºå®Œæˆä»¥åå‘ç°æœ‰ç‚¹ä¸å¯¹ï¼Œä¸æ˜¯ class ç±»å‹çš„ï¼Œæ˜¯ä¸ª aspectï¼Œäºæ˜¯ä»–æ‰‹åŠ¨æŠŠ aspect æ”¹æˆäº† classï¼Œå¦‚å›¾ï¼›
  ![](https://bugstack.cn/assets/images/story/story-2-05.png)
- æ‰€ä»¥ï¼Œè°¢é£æœºå®é™…åˆ›å»ºå‡ºæ¥çš„æ˜¯ä¸€ä¸ª aspect çš„ä»¥ `.aj` ç»“å°¾çš„ç±»ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ­£ç»çš„ Java ç±»ï¼Œæ‰€ä»¥åˆ‡é¢ä¸åˆ°ï¼Œä¹Ÿæ ¹æœ¬æ²¡æœ‰å¯¹åº”çš„ class æ–‡ä»¶ã€‚  
  
## ä¸‰ã€å¦‚ä½•æ­£ç¡®ä½¿ç”¨ Aspect çš„ .aj ç±»

**AspectJ**ï¼Œç®€ç§° AJ  ~~æˆ‘è‡ªå·±è¯´çš„~~

AspectJ å…¶å®ä¹Ÿæ˜¯ AOP çš„ä¸€ç§å®ç°æŠ€æœ¯ï¼ŒåŠŸèƒ½ç±»ä¼¼äºæ‹¦æˆªå™¨ï¼Œåœ¨é›†æˆåœ¨ IntelliJ IDEA å¼€å‘å·¥å…·é‡Œã€‚åœ¨ä½¿ç”¨ IntelliJ IDEA ç¼–å†™ AspectJ ä»£ç ä¹‹å‰éœ€è¦æœ¬æœºå…ˆå®‰è£… AspectJ å·¥å…·åŒ…ã€‚*å¦åˆ™ä½ çš„ `.aj` ç±»ä¸èƒ½è¿è¡Œï¼ŒåŒæ—¶IDEAç±»æ˜¾ç¤ºå‡ºæ¥çš„ `.aj` ç±»ï¼Œä¹Ÿæ˜¯Cçš„æ ‡è¯†*

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥èŠèŠå…³äºè¿™ä¸ªä¸œè¥¿æ€ä¹ˆä½¿ç”¨ï¼Œåˆ«å†è¢« `.aj` éª—äº†ã€‚

### 1. å®‰è£… AspectJ 

åœ¨ä½¿ç”¨ AspectJ ä¹‹å‰ï¼Œéœ€è¦å»å®˜ç½‘ä¸‹è½½ä¸€ä¸ªå®‰è£…åŒ…ï¼Œåœ°å€ï¼š[https://www.eclipse.org/aspectj/downloads.php](https://www.eclipse.org/aspectj/downloads.php) *å¦‚æœå®˜ç½‘ä¸‹è½½çš„å¾ˆæ…¢ï¼Œå¯ä»¥ä»æˆ‘æä¾›çš„æºç ä¸­è·å–ï¼Œä¹Ÿå¯ä»¥ä»å…¶ä»–é€”å¾„æœç´¢ä¸‹è½½ aspectj-1.9.4.jar*

ä¸‹è½½å®Œæˆå®‰è£…ï¼›
- åŒå‡»å®‰è£…
- å‘½ä»¤å®‰è£… `java -jar aspectj-1.9.4.jar`
- é…ç½®è¯´æ˜ï¼šæ²¡æœ‰é…ç½®ï¼Œå‚»ç“œå¼ä¸‹ä¸€æ­¥å°±å¯ä»¥äº†

![](https://bugstack.cn/assets/images/story/story-2-06.png)

- é»˜è®¤é…ç½®å®‰è£…å®Œæˆä»¥åä¼šåœ¨Cç›˜åˆ›å»ºå‡ºä¸€ä¸ªæ–‡ä»¶å¤¹ `C:\aspectj1.9`ï¼ŒåŒ…æ‹¬ï¼šbinã€docã€libç­‰ï¼Œåé¢æˆ‘ä»¬å°±ä¼šä½¿ç”¨åˆ°è¿™äº›å†…å®¹ã€‚

### 2. AspectJ æ’ä»¶

åœ¨ä¸“ä¸šç‰ˆ IDEA ä¸­å¼€å‘ AspectJï¼Œéœ€è¦å®‰è£…ä»¥ä¸‹ä¸¤ä¸ªæ’ä»¶ï¼š

- `Spring AOP/@AspectJ`
- `AspectJ Support`

![](https://bugstack.cn/assets/images/story/story-2-07.png)

### 3. æ·»åŠ ä¾èµ– aspectjrt.jar

å¼€å§‹ä¹‹å‰éœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ  `aspectjrt.jar` ä¾èµ–ï¼Œ`aspectjrt.jar` å³ AspectJ å®‰è£…ç›®å½•ä¸­`lib`ç›®å½•ä¸‹çš„jaråŒ…ã€‚*ä½ å¯ä»¥å¤åˆ¶åˆ°å·¥ç¨‹ä¸­å¼•å…¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¼•å…¥*

![](https://bugstack.cn/assets/images/story/story-2-08.png)

1. åœ¨å·¥ç¨‹ä¸Šé¼ æ ‡å³é”®ï¼Œç‚¹å‡» Open Module Setting æ‰“å¼€ `Project Structure`
2. ç‚¹å‡» Libraries é€‰é¡¹å¡ï¼Œå’Œä¸Šé¢çš„ + å·ï¼Œåˆ›å»º New Project Library
3. é€‰æ‹© `C:\aspectj1.9\lib\aspectjrt.jar` è·¯å¾„ï¼Œç‚¹å‡»å³å¯é…ç½®å®Œæˆ

### 4. é…ç½®AspectJç¼–è¯‘å™¨

IDEA é»˜è®¤ä½¿ç”¨ `javac` ç¼–è¯‘å™¨ï¼Œè¿™é‡Œéœ€è¦é…ç½® AspectJ çš„ç¼–è¯‘å™¨ `ajc`ï¼Œåœ¨ IDEA ä¸­åšç›¸åº”é…ç½®ã€‚

![](https://bugstack.cn/assets/images/story/story-2-09.png)

1. æ‰“å¼€ `IDEA -> File  -> Settings` å¯¹è¯
2. é€‰æ‹© `Buildï¼ŒExecutionï¼ŒDeployment -> Compiler -> Java Compiler`
3. Use complierï¼šé€‰æ‹© Ajc
4. åœ¨ `Path to aspectjtools.jar` é‡Œé…ç½®è·¯å¾„ `C:\aspectj1.9\lib\aspectjtools.jar`

### 5. æ¡ˆä¾‹æµ‹è¯•

**åˆ›å»º Aspect ç±»**

```java
public aspect DoAspect {

    pointcut logPointcut():call(* ApiTest.hi(..));

    void around():call(void ApiTest.hi(..)){
        System.out.println("call å¼€å§‹...");
        proceed();
        System.out.println("call ç»“æŸ...");
    }

    before(): logPointcut(){
        System.out.println("æ–¹æ³•æ‰§è¡Œ before");
    }

    after(): logPointcut(){
        System.out.println("æ–¹æ³•æ‰§è¡Œ after");
    }

}
```

**æµ‹è¯•ç±»**

```java
public class ApiTest {

    public void hi(){
        System.out.println("Hi Aspect");
    }

    public static void main(String[] args) {
        ApiTest apiTest = new ApiTest();
        apiTest.hi();
    }

}
```

**æµ‹è¯•ç»“æœ**

```java
call å¼€å§‹...
æ–¹æ³•æ‰§è¡Œ before
Hi Aspect
call ç»“æŸ...
æ–¹æ³•æ‰§è¡Œ after

Process finished with exit code 0
```

- åˆ°è¿™ï¼Œæ‰æ˜¯ä¸€ä¸ªå…³äº Aspect ç±»çš„æ­£ç¡®æ‰“å¼€æ–¹å¼ï¼Œå…³äº Aspect çš„ä½¿ç”¨ä¹Ÿå¯ä»¥å°è¯•ææï¼Œæ­¤ç¯‡è¿˜åªæ˜¯å…³äºæ­¤ç±»åˆ‡é¢å†™æ³•çš„ä¸€ä¸ªå…¥é—¨ã€‚

## å››ã€æ€»ç»“

- ä½ çš„ä»£ç è¶Šç²—çŠ·ã€è¶Šè±ªæ”¾ã€è¶Šéªšæ°”ï¼Œå‡ ä¹ä½ é‡åˆ°çš„é—®é¢˜ä¹Ÿæ˜¯è¶Šå¤šçš„ï¼Œå¯èƒ½å°±æ˜¯å› ä¸ºæ²¡æœ‰éµå®ˆä¸€å®šçš„ç ”å‘æ‰§è¡Œè§„èŒƒï¼Œæ‰€ä»¥é‡åˆ°çš„è¿™äº›æœ‰ç‚¹å‚»çš„é—®é¢˜ï¼Œå‡ ä¹ä¼šæµªè´¹æ‰ä½ ä¸€ä¸ªä¸Šåˆæˆ–è€…ä¸€å¤©ã€‚
- ä½†æœ‰äº›æ—¶å€™å¦‚æœä½ èƒ½è®¤çœŸå¯¹å¾…ä½ å¼„å‡ºæ¥çš„bugï¼Œæ·±å…¥åˆ†æä¸‹å®ƒæ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Œå¹¶æŠŠå®ƒå¤ç°å‡ºæ¥ä¸€ç‚¹ç‚¹æ·±å…¥ç ”ç©¶ä¸‹ï¼Œå¯èƒ½ä¹Ÿä¼šå¾—åˆ°æ„æƒ³ä¸åˆ°çš„æ”¶è·ï¼Œä¹Ÿè¯´ä¸å®šã€‚æ‰€ä»¥å‡¡æ˜¯è®¤çœŸï¼Œå‡¡äº‹æ²¡æœ‰åäº‹ã€‚
- å…³äºåˆ‡é¢ã€å…³äºæºç ã€å…³äºå¼€å‘ï¼Œå¯èƒ½å¹¶ä¸åº”è¯¥åªæ³¨é‡äºåŠŸèƒ½å®ç°ï¼Œç”šè‡³æœ‰æ—¶å€™è¦æƒ³åŠæ³•é€ƒç¦»æ—¥å¤ä¸€æ—¥æ²¡æœ‰æˆé•¿çš„å·¥ä½œå†…å®¹ã€‚å¤šåœ¨é‚£äº›æœ‰ä»·å€¼çš„æŠ€æœ¯ä¸Šä¸‹åŠŸå¤«ï¼Œé‚£ä½ çš„æ”¶è·ä¹Ÿæ˜¯æœ€å¤šçš„ã€‚
