---
layout: post
category: itstack-demo-any
title: æœ‰ç‚¹å¹²è´§ | JDKã€CGLIBåŠ¨æ€ä»£ç†ä½¿ç”¨ä»¥åŠæºç åˆ†æ
tagline: by ä»˜æ”¿å§”
tag: [java,itstack-demo-any]
excerpt: åœ¨Javaä¸­åŠ¨æ€ä»£ç†æ˜¯éå¸¸é‡è¦ä¹Ÿæ˜¯éå¸¸æœ‰ç”¨çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åŠ¨æ€ä»£ç†æŠ€æœ¯å‡ ä¹ä¹Ÿå°±ä¸ä¼šæœ‰å„ç§ä¼˜ç§€æ¡†æ¶çš„å‡ºç°ï¼ŒåŒ…æ‹¬Springã€‚
lock: need
---

# æœ‰ç‚¹å¹²è´§ | JDKã€CGLIBåŠ¨æ€ä»£ç†ä½¿ç”¨ä»¥åŠæºç åˆ†æ

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## å‰è¨€ä»‹ç»
åœ¨Javaä¸­åŠ¨æ€ä»£ç†æ˜¯éå¸¸é‡è¦ä¹Ÿæ˜¯éå¸¸æœ‰ç”¨çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åŠ¨æ€ä»£ç†æŠ€æœ¯å‡ ä¹ä¹Ÿå°±ä¸ä¼šæœ‰å„ç§ä¼˜ç§€æ¡†æ¶çš„å‡ºç°ï¼ŒåŒ…æ‹¬Springã€‚
å…¶å®åœ¨åŠ¨æ€ä»£ç†çš„ä½¿ç”¨ä¸­ï¼Œé™¤äº†æˆ‘ä»¬å¹³æ—¶ç”¨çš„Springè¿˜æœ‰å¾ˆå¤šä¸­é—´ä»¶å’ŒæœåŠ¡éƒ½ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œä¾‹å¦‚ï¼›
1. RPCé€šä¿¡æ¡†æ¶Dubboï¼Œåœ¨é€šä¿¡çš„æ—¶å€™ç”±æœåŠ¡ç«¯æä¾›ä¸€ä¸ªæ¥å£æè¿°ä¿¡æ¯çš„Jarï¼Œè°ƒç”¨ç«¯è¿›è¡Œå¼•ç”¨ï¼Œä¹‹ååœ¨è°ƒç”¨ç«¯å¼•ç”¨åç”Ÿæˆäº†å¯¹åº”çš„ä»£ç†ç±»ï¼Œå½“æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œå®é™…éœ€è¦èµ°åˆ°ä»£ç†ç±»å‘æœåŠ¡æä¾›ç«¯å‘é€è¯·æ±‚ä¿¡æ¯ï¼Œç›´è‡³å†…å®¹å›ä¼ ã€‚
2. å¦å¤–åœ¨ä½¿ç”¨Mybatisæ—¶å€™å¯ä»¥çŸ¥é“åªéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œä¸éœ€è¦å®ç°å…·ä½“æ–¹æ³•å°±å¯ä»¥è°ƒç”¨åˆ°Mapperä¸­å®šä¹‰çš„æ•°æ®åº“æ“ä½œä¿¡æ¯äº†ã€‚è¿™æ ·æå¤§çš„ç®€åŒ–äº†ä»£ç çš„å¼€å‘ï¼Œåˆå¢å¼ºäº†æ•ˆç‡ã€‚
3. æœ€åä¸çŸ¥é“ä½ è‡ªå·±æ˜¯å¦å°è¯•è¿‡å¼€å‘ä¸€äº›åŸºäºä»£ç†ç±»çš„æ¡†æ¶ï¼Œä»¥æ­¤æ¥ä¼˜åŒ–ä¸šåŠ¡ä»£ç ã€‚ä¹Ÿå°±æ˜¯å°†ä¸šåŠ¡ä»£ç ä¸­éä¸šåŠ¡é€»è¾‘åˆé€šç”¨æ€§çš„åŠŸèƒ½æŠ½ç¦»å‡ºæ¥ï¼Œå¼€å‘ä¸ºç‹¬ç«‹çš„ç»„ä»¶ã€‚**æ¨èä¸ªæ¡ˆä¾‹ï¼Œæ–¹ä¾¿çŸ¥é“ä»£ç†ç±»çš„åº”ç”¨ï¼š**[æ‰‹å†™RPCæ¡†æ¶ç¬¬ä¸‰ç« ã€ŠRPCä¸­é—´ä»¶ã€‹](https://bugstack.cn/itstack-demo-netty-3/2019/09/03/%E6%89%8B%E5%86%99RPC%E6%A1%86%E6%9E%B6%E7%AC%AC%E4%B8%89%E7%AB%A0-RPC%E4%B8%AD%E9%97%B4%E4%BB%B6.html)

## ä»£ç†æ–¹å¼
åŠ¨æ€ä»£ç†å¯ä»¥ä½¿ç”¨Jdkæ–¹å¼ä¹Ÿå¯ä»¥ä½¿ç”¨CGLBï¼Œä»–ä»¬çš„åŒºåˆ«ï¼Œå¦‚ä¸‹ï¼›

| ç±»å‹ | æœºåˆ¶ | å›è°ƒæ–¹å¼ |é€‚ç”¨åœºæ™¯  | æ•ˆç‡ |
|:--------|:-------|:-------|:-------|:-------|
|JDK | å§”æ‰˜æœºåˆ¶ï¼Œä»£ç†ç±»å’Œç›®æ ‡ç±»éƒ½å®ç°äº†åŒæ ·çš„æ¥å£ï¼ŒInvocationHandleræŒæœ‰ç›®æ ‡ç±»ï¼Œä»£ç†ç±»å§”æ‰˜InvocationHandlerå»è°ƒç”¨ç›®æ ‡ç±»çš„åŸå§‹æ–¹æ³• |åå°„ | ç›®æ ‡ç±»æ˜¯æ¥å£ç±»| æ•ˆç‡ç“¶é¢ˆåœ¨åå°„è°ƒç”¨ç¨æ…¢|
| CGLIB| ç»§æ‰¿æœºåˆ¶ï¼Œä»£ç†ç±»ç»§æ‰¿äº†ç›®æ ‡ç±»å¹¶é‡å†™äº†ç›®æ ‡æ–¹æ³•ï¼Œé€šè¿‡å›è°ƒå‡½æ•°MethodInterceptorè°ƒç”¨çˆ¶ç±»æ–¹æ³•æ‰§è¡ŒåŸå§‹é€»è¾‘|é€šè¿‡FastClassæ–¹æ³•ç´¢å¼•è°ƒç”¨ | éæ¥å£ç±»ï¼Œéfinalç±»ï¼Œéfinalæ–¹æ³•|ç¬¬ä¸€æ¬¡è°ƒç”¨å› ä¸ºè¦ç”Ÿæˆå¤šä¸ªClasså¯¹è±¡è¾ƒJDKæ–¹å¼æ…¢ï¼Œå¤šæ¬¡è°ƒç”¨å› ä¸ºæœ‰æ–¹æ³•ç´¢å¼•è¾ƒåå°„æ–¹å¼å¿«ï¼Œå¦‚æœæ–¹æ³•è¿‡å¤šswitch caseè¿‡å¤šå…¶æ•ˆç‡è¿˜éœ€æµ‹è¯• |

## æ¡ˆä¾‹å·¥ç¨‹

```java
itstack-demo-test
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ org.itstack.demo
    â”‚           â”œâ”€â”€ proxy
    â”‚           â”‚	â””â”€â”€ cglib
    â”‚           â”‚	    â””â”€â”€ CglibProxy.java
    â”‚           â”œâ”€â”€ jdk	
    â”‚           â”‚	â”œâ”€â”€ reflect
    â”‚           â”‚	â”‚   â”œâ”€â”€ JDKInvocationHandler.java
    â”‚           â”‚	â”‚   â””â”€â”€ JDKProxy.java		
    â”‚           â”‚   â””â”€â”€ util
    â”‚           â”‚	    â””â”€â”€ ClassLoaderUtils.java	
    â”‚           â””â”€â”€ service
    â”‚           	â”œâ”€â”€ IUserService.java
    â”‚           	â””â”€â”€ UserService.java	
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.test
                â””â”€â”€ ApiTest.java
```

### åŸºç¡€æ¥å£å’Œæ–¹æ³•ä¾¿äºéªŒè¯

>service/IUserService.java

```java
public interface IUserService {

    String queryUserNameById(String userId);

}
```

>service/UserService.java

```java
public class UserService implements IUserService {

    public String queryUserNameById(String userId) {
        return "hi user " + userId;
    }

}
```

### JDKåŠ¨æ€ä»£ç†

>reflect/JDKInvocationHandler.java & ä»£ç†ç±»åå°„è°ƒç”¨

- å®ç°InvocationHandler.invokeï¼Œç”¨äºæ–¹æ³•å¢å¼ºï½›ç›‘æ§ã€æ‰§è¡Œå…¶ä»–ä¸šåŠ¡é€»è¾‘ã€è¿œç¨‹è°ƒç”¨ç­‰ï½
- å¦‚æœæœ‰éœ€è¦é¢å¤–çš„å‚æ•°å¯ä»¥æä¾›æ„é€ æ–¹æ³•

```java
public class JDKInvocationHandler implements InvocationHandler {

    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println(method.getName());
        return "æˆ‘è¢«JDKProxyä»£ç†äº†";
    }

}
```

>reflect/JDKProxy.java & å®šä¹‰ä¸€ä¸ªä»£ç†ç±»è·å–çš„æœåŠ¡

- Proxy.newProxyInstance æ¥å®é™…ç”Ÿæˆä»£ç†ç±»ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼›
  1. Class<?> cl = getProxyClass0(loader, intfs); æŸ¥æ‰¾æˆ–ç”ŸæˆæŒ‡å®šçš„ä»£ç†ç±»
  2. proxyClassCache.get(loader, interfaces); ä»£ç†ç±»çš„ç¼“å­˜ä¸­è·å–
  3. subKeyFactory.apply(key, parameter)      ç»§ç»­ä¸‹ä¸€å±‚     
  4. byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags); ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç 

```java
public class JDKProxy {

    public static <T> T getProxy(Class<T> interfaceClass) throws Exception {
        InvocationHandler handler = new JDKInvocationHandler();
        ClassLoader classLoader = ClassLoaderUtils.getCurrentClassLoader();
        T result = (T) Proxy.newProxyInstance(classLoader, new Class[]{interfaceClass}, handler);
        return result;
    }

}
```

>ApiTest.test_proxy_jdk() & æ‰§è¡Œè°ƒç”¨å¹¶è¾“å‡ºåå°„ç±»çš„å­—èŠ‚ç 

- ä»£ç†åè°ƒç”¨æ–¹æ³•éªŒè¯
- é€šè¿‡ä½¿ç”¨ProxyGenerator.generateProxyClassè·å–å®é™…çš„å­—èŠ‚ç ï¼ŒæŸ¥çœ‹ä»£ç†ç±»çš„å†…å®¹

```java
@Test
public void test_proxy_jdk() throws Exception {

	IUserService proxy = (IUserService) JDKProxy.getProxy(ClassLoaderUtils.forName("org.itstack.demo.service.IUserService"));
	String userName = proxy.queryUserNameById("10001");
	System.out.println(userName);

	String name = "ProxyUserService";
	byte[] data = ProxyGenerator.generateProxyClass(name, new Class[]{IUserService.class});

	// è¾“å‡ºç±»å­—èŠ‚ç 
	FileOutputStream out = null;
	try {
		out = new FileOutputStream(name + ".class");
		System.out.println((new File("")).getAbsolutePath());
		out.write(data);
	} catch (FileNotFoundException e) {
		e.printStackTrace();
	} catch (IOException e) {
		e.printStackTrace();
	} finally {
		if (null != out) try {
			out.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

}
```

**è¾“å‡ºç»“æœ**

```java
queryUserNameById
æˆ‘è¢«JDKProxyä»£ç†äº†
```

**å°†ç”Ÿæˆçš„ä»£ç†ç±»è¿›è¡Œåç¼–è¯‘jd-gui**

éƒ¨åˆ†å†…å®¹æŠ½å–ï¼Œå¯ä»¥çœ‹åˆ°æ¯”è¾ƒæ ¸å¿ƒçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨çš„æ—¶å€™èµ°åˆ°äº†è¿™é‡Œ

```java
public final String queryUserNameById(String paramString)
    throws 
{
try
{
  return (String)this.h.invoke(this, m3, new Object[] { paramString });
}
catch (Error|RuntimeException localError)
{
  throw localError;
}
catch (Throwable localThrowable)
{
  throw new UndeclaredThrowableException(localThrowable);
}
}
  

static
{
try
{
  m1 = Class.forName("java.lang.Object").getMethod("equals", new Class[] { Class.forName("java.lang.Object") });
  m2 = Class.forName("java.lang.Object").getMethod("toString", new Class[0]);
  m0 = Class.forName("java.lang.Object").getMethod("hashCode", new Class[0]);
  m3 = Class.forName("org.itstack.demo.service.IUserService").getMethod("queryUserNameById", new Class[] { Class.forName("java.lang.String") });
  return;
}
catch (NoSuchMethodException localNoSuchMethodException)
{
  throw new NoSuchMethodError(localNoSuchMethodException.getMessage());
}
catch (ClassNotFoundException localClassNotFoundException)
{
  throw new NoClassDefFoundError(localClassNotFoundException.getMessage());
}
}
```

### CGLIBåŠ¨æ€ä»£ç†

>cglib/CglibProxy.java

- æä¾›æ„é€ æ–¹æ³•ï¼Œç”ŸæˆCGLIBçš„ä»£ç†ç±»ï¼Œå›è°ƒthis
- interceptå¯ä»¥è¿›è¡Œæ–¹æ³•çš„å¢å¼ºï¼Œå¤„ç†ç›¸å…³ä¸šåŠ¡é€»è¾‘
- CGLIBæ˜¯é€šè¿‡ASMæ¥æ“ä½œå­—èŠ‚ç ç”Ÿæˆç±»

```java
public class CglibProxy implements MethodInterceptor {

    public Object newInstall(Object object) {
        return Enhancer.create(object.getClass(), this);
    }

    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
        System.out.println("æˆ‘è¢«CglibProxyä»£ç†äº†");
        return methodProxy.invokeSuper(o, objects);
    }

}
```

>ApiTest.test_proxy_cglib() & è°ƒç”¨ä»£ç†ç±»

```java
@Test
public void test_proxy_cglib() {
    CglibProxy cglibProxy = new CglibProxy();
    UserService userService = (UserService) cglibProxy.newInstall(new UserService());
    String userName = userService.queryUserNameById("10001");
    System.out.println(userName);
}
```

**è¾“å‡ºç»“æœ**

```java
æˆ‘è¢«CglibProxyä»£ç†äº†
hi user 10001
```

## ç»¼ä¸Šæ€»ç»“

- åœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨ä¸­ä¸¤ç§æ–¹å¼éƒ½æœ‰æ‰€ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¾ç…§ä¸åŒçš„è¯‰æ±‚è¿›è¡Œé€‰æ‹©
- å¾€å¾€åŠ¨æ€ä»£ç†ä¼šå’Œæ³¨è§£å…±åŒä½¿ç”¨ï¼Œä»£ç†ç±»æ‹¿åˆ°ä»¥åè·å–æ–¹æ³•çš„æ³¨è§£ï¼Œå¹¶åšç›¸åº”çš„ä¸šåŠ¡æ“ä½œ
- æœ‰æ—¶å€™ä½ æ˜¯å¦ä¼šé‡åˆ°å¢åŠ AOPä¸ç”Ÿæ•ˆï¼Œå› ä¸ºæœ‰æ—¶å€™æœ‰äº›ç±»æ˜¯è¢«ä»£ç†æ“ä½œçš„ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä½ çš„è‡ªå®šä¹‰æ³¨è§£ä¹Ÿå°±æ˜¯åˆ‡é¢
