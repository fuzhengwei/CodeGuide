---
layout: post
category: interview
title: é¢ç»æ‰‹å†Œ Â· ç¬¬19ç¯‡ã€ŠThread.start() ï¼Œå®ƒæ˜¯æ€ä¹ˆè®©çº¿ç¨‹å¯åŠ¨çš„å‘¢ï¼Ÿã€‹  
tagline: by å°å‚…å“¥
tag: [java,interview]
excerpt: çº³å°¼ï¼ï¼Ÿå·¥ä½œäº†è¿™ä¹ˆä¹…ï¼Œè¿˜ä¸çŸ¥é“çº¿ç¨‹æ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼ŸåŸºæœ¬æ ¸å¿ƒè¿‡ç¨‹åŒ…æ‹¬ï¼šJava åˆ›å»ºçº¿ç¨‹å’Œå¯åŠ¨ã€è°ƒç”¨æœ¬åœ°æ–¹æ³• start0()ã€JVM ä¸­ JVM_StartThread çš„åˆ›å»ºå’Œå¯åŠ¨ã€è®¾ç½®çº¿ç¨‹çŠ¶æ€ç­‰å¾…è¢«å”¤é†’ã€æ ¹æ®ä¸åŒçš„OSå¯åŠ¨çº¿ç¨‹å¹¶å”¤é†’ã€æœ€åå›è°ƒ run() æ–¹æ³•å¯åŠ¨ Java çº¿ç¨‹ã€‚
lock: need
---

# é¢ç»æ‰‹å†Œ Â· ç¬¬19ç¯‡ã€ŠThread.start() ï¼Œå®ƒæ˜¯æ€ä¹ˆè®©çº¿ç¨‹å¯åŠ¨çš„å‘¢ï¼Ÿã€‹ 

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`æœ‰å¥è¯ï¼šæ­£å› ä¸ºä½ ä¼˜ç§€ï¼Œæ‰€ä»¥éš¾ä»¥å“è¶Šï¼`

åˆšå¼€å§‹å¬è¿™å¥è¯è¿˜åœ¨ä¸Šå­¦ï¼Œæ—¢ä¸å“è¶Šã€ä¹Ÿä¸ä¼˜ç§€ï¼Œç”šè‡³å¯èƒ½è¿˜æœ‰ç‚¹ç¬¨ï¼ä½†çªç„¶ä»æŸæ¬¡çˆ¬åˆ°ç­çº§çš„å‰å‡ ååï¼Œå¼€å§‹å–œæ¬¢ä¸Šäº†è¿™ç§æ„Ÿè§‰ï¼ŒåŸæ¥å‰é¢çš„é£æ™¯æ˜¯å¦‚æ­¤ç¿çƒ‚ğŸ˜œï¼

ä¼˜ç§€å’Œå“è¶Šå·®çš„ä¸æ˜¯ä¸€ä¸ªç­‰çº§ï¼Œå½“ä½ æ„Ÿè§‰è‡ªå·±ä¼˜ç§€åï¼Œè¿˜èƒ½ä¿æŒç©ºç“¶çš„å¿ƒæ€å¼€å§‹ï¼Œæ‰èƒ½é€æ­¥çš„åƒå“è¶Šè¿ˆè¿›ï¼Œå¹¶æ¼«æ¼«é•¿ï¼

æ˜¯ä¸å°æ—¶å€™æ›´å®¹æ˜“å­¦ä¼šæ›´å¤šçš„çŸ¥è¯†ï¼Œä½†è¶Šå¤§è¶Šç¬¨äº†ï¼äººå¯èƒ½å¾ˆå®¹æ˜“è¢«è‡ªå·±çš„å¹´çºªå¤§äº†ï¼Œå½“æˆé•¿è€…ã€‚å´å¾ˆå°‘èƒ½ä¿æŒä¸€ä¸ªä½å§¿æ€è°¦å‘çš„å¿ƒæ€ï¼Œä¸æ–­çš„å­¦ä¹ ã€‚`æ‰€ä»¥æœ€å`ï¼Œæ”¾ä¸ä¸‹è‡ªå·±ï¼Œä¹Ÿæ‹¾ä¸èµ·èƒ½åŠ›ã€‚

å–œæ¬¢ä¸€å¥è¯ï¼Œ`è“æ˜¯å¤©çš„é¢œè‰²ã€çº¢æ˜¯ç«çš„è±¡å¾ï¼Œæˆ‘ä¸å­¦å¤§æµ·æŠ„è¢­å¤©çš„è“ã€ä¹Ÿä¸å­¦æ™šéœæ¨¡æ‹Ÿç«çš„çº¢ã€‚æˆ‘å°±æ˜¯æˆ‘ï¼Œç”Ÿå‘½æ˜¯æˆ‘çš„ã€å‘½è¿æ˜¯æˆ‘çš„`ã€‚**å¥èº«ä¹Ÿæ˜¯ä½ çš„ã€å­¦ä¹ ä¹Ÿæ˜¯ä½ çš„**ï¼Œåªè¦ä½ æœ‰ä¸€ä¸ªå¥½å¿ƒæ€ï¼Œè‡ªç„¶ä¼šèµ°åˆ°å‰é¢å“è¶Šé‚£é‡Œï¼

## äºŒã€é¢è¯•é¢˜

`è°¢é£æœºï¼Œå°è®°ï¼` *ç å¾·*ï¼Œå¹´è½»äººå†™ä»£ç å¥½çŒ–ç‹‚ï¼Œä¸éµå®ˆè§„èŒƒè¿˜å–·æˆ‘ï¼Œä½ è¦`è€—å­å°¾æ±`ï¼è°¢é£æœºéª‚éª‚å’§å’§çš„ä¸‹ç­åï¼Œæ‰¾é¢è¯•å®˜èŠå¿ƒå¾—ã€‚

**è°¢é£æœº**ï¼šæˆ‘æ„Ÿè§‰å¤©å¤©å°±åƒæ´»åœ¨ç²ªå †ï¼Œä»£ç éƒ½æ˜¯ä¹±ç³Ÿç³Ÿï¼Œæˆ‘æœ‰å¿ƒæ— åŠ›ï¼

**é¢è¯•å®˜**ï¼šæ€ä¹ˆï¼Œæƒ³è·³æ§½äº†ï¼Ÿ

**è°¢é£æœº**ï¼šæƒ³å»å†™ä»£ç æœ‰è§„èŒƒçš„å…¬å¸ï¼Œæƒ³æå‡ï¼

**é¢è¯•å®˜**ï¼šå—¯ï¼ç¡®å®ï¼Œæœ‰äº›å¤§å…¬å¸çš„ä»£ç è´¨é‡è¦å¥½ä¸€äº›ã€‚ä½†æ˜¯ä½ ä¹Ÿè¦è‡ªèº«èƒ½åŠ›å¼ºçš„ã€‚

**è°¢é£æœº**ï¼šæ˜¯çš„ï¼Œæˆ‘ä¸€ç›´åœ¨åŠªåŠ›å­¦ä¹ ï¼å‡†å¤‡è·‘è·¯ï¼

**é¢è¯•å®˜**ï¼šé‚£æˆ‘é¡ºä¾¿è€ƒä½ ä¸ªé¢˜ï¼Œçœ‹çœ‹ä½ è¿›å¤§å‚çš„å‡ ç‡å¤§ä¸ã€‚`å—¯... Java çº¿ç¨‹å¦‚ä½•å¯åŠ¨çš„ï¼Ÿ`

**è°¢é£æœº**ï¼šå¦‚ä½•å¯åŠ¨çš„ï¼Ÿ`start` å¯åŠ¨çš„ï¼

**é¢è¯•å®˜**ï¼šè¿˜æœ‰å—ï¼Ÿ

**è°¢é£æœº**ï¼šå—¯...ï¼Œæ²¡äº†ï¼

**é¢è¯•å®˜**ï¼šå—¯ï¼Œå¯èƒ½`ä¼šä¸ä¸ä¼š`è¿™ä¸€ä¸ªé¢˜å¹¶ä¸ä¼šè®©ä½ ä»£ç æœ‰å¤šç‰›ã€æœ‰å¤šå¥½ï¼Œä½†æ˜¯ä½ çš„æŠ€æœ¯æ ˆæ·±åº¦å’Œå¹¿åº¦ï¼Œå†³å®šä½ çš„ç¼–ç¨‹èŒä¸šç”Ÿæ¶¯æ˜¯å¦æœ‰ä¸€æ¡åº·åº„å¤§é“ã€‚è¿˜æ˜¯è¦å¤šåŠªåŠ›ï¼

## ä¸‰ã€çº¿ç¨‹å¯åŠ¨åˆ†æ

```java
new Thread(() -> {
    // todo
}).start();
```

**å’³å’³**ï¼ŒJava çš„çº¿ç¨‹åˆ›å»ºå’Œå¯åŠ¨éå¸¸ç®€å•ï¼Œä½†å¦‚æœé—®`ä¸€ä¸ªçº¿ç¨‹æ˜¯æ€ä¹ˆå¯åŠ¨èµ·æ¥çš„`å¾€å¾€å¹¶ä¸æ¸…æ¥šï¼Œç”šè‡³ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¯åŠ¨æ—¶æ˜¯`è°ƒç”¨start()`ï¼Œè€Œä¸æ˜¯`è°ƒç”¨run()`æ–¹æ³•å‘¢ï¼Ÿ

**é‚£ä¹ˆ**ï¼Œä¸ºäº†è®©å¤§å®¶æœ‰ä¸€ä¸ªæ›´ç›´è§‚çš„è®¤çŸ¥ï¼Œæˆ‘ä»¬å…ˆç«™åœ¨ä¸Šå¸è§†è§’ã€‚æŠŠè¿™æ®µ Java çš„çº¿ç¨‹ä»£ç ï¼Œåˆ° JDK æ–¹æ³•ä½¿ç”¨ï¼Œä»¥åŠ JVM çš„ç›¸åº”å¤„ç†è¿‡ç¨‹ï¼Œå±•ç¤ºç»™å¤§å®¶ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬åç»­é€æ­¥åˆ†æã€‚

![å›¾ 19-1 çº¿ç¨‹å¯åŠ¨åˆ†æ](https://bugstack.cn/assets/images/2020/interview/interview-19-1.png)

**ä»¥ä¸Š**ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯åŠ¨çš„æ•´ä½“è¿‡ç¨‹åˆ†æï¼Œä¼šæ¶‰åŠåˆ°å¦‚ä¸‹çŸ¥è¯†ç‚¹ï¼š
- çº¿ç¨‹çš„å¯åŠ¨ä¼šæ¶‰åŠåˆ°æœ¬åœ°æ–¹æ³•ï¼ˆJNIï¼‰çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯é‚£éƒ¨åˆ† C++ ç¼–å†™çš„ä»£ç ã€‚
- JVM çš„å®ç°ä¸­ä¼šæœ‰ä¸åŒæ“ä½œç³»ç»Ÿå¯¹çº¿ç¨‹çš„ç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚ï¼šWinã€Linuxã€Unixã€‚
- çº¿ç¨‹çš„å¯åŠ¨ä¼šæ¶‰åŠåˆ°çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆRUNNABLEï¼‰ï¼Œä»¥åŠå”¤é†’æ“ä½œï¼Œæ‰€ä»¥æœ€ç»ˆä¼šæœ‰å›è°ƒæ“ä½œã€‚*ä¹Ÿå°±æ˜¯è°ƒç”¨æˆ‘ä»¬çš„ run() æ–¹æ³•*

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¼€å§‹é€æ­¥åˆ†ææ¯ä¸€æ­¥æºç çš„æ‰§è¡Œå†…å®¹ï¼Œä»è€Œäº†è§£çº¿ç¨‹å¯åŠ¨è¿‡ç¨‹ã€‚

## å››ã€çº¿ç¨‹å¯åŠ¨è¿‡ç¨‹

### 1. Thread start UML å›¾

![å›¾ 19-2 Thread start UML å›¾](https://bugstack.cn/assets/images/2020/interview/interview-19-2.png)

å¦‚å›¾ 19-2 æ˜¯çº¿ç¨‹çš„å¯åŠ¨è¿‡ç¨‹æ—¶åºå›¾ï¼Œæ•´ä½“çš„é“¾è·¯è¾ƒé•¿ï¼Œä¼šæ¶‰åŠåˆ° JVM çš„æ“ä½œã€‚æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š
1. `Thread.c`ï¼š[https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c](https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c)
2. `jvm.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp)
3. `thread.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp)
4. `os.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp)
5. `os_linux.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp)
6. `os_windows.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp)
6. `vmSymbols.hpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp)

### 2. Java å±‚é¢ Thread å¯åŠ¨

#### 2.1 start() æ–¹æ³•

```java
new Thread(() -> {
    // todo
}).start();

// JDK æºç 
public synchronized void start() {

    if (threadStatus != 0)
        throw new IllegalThreadStateException();

    group.add(this);
    boolean started = false;
    try {
        start0();
        started = true;
    } finally {
        try {
            if (!started) {
                group.threadStartFailed(this);
            }
        } catch (Throwable ignore) {}
    }
}
```

- çº¿ç¨‹å¯åŠ¨æ–¹æ³• `start()`ï¼Œåœ¨å®ƒçš„æ–¹æ³•è‹±æ–‡æ³¨é‡Šä¸­å·²ç»æŠŠæ ¸å¿ƒå†…å®¹æè¿°å‡ºæ¥ã€‚`Causes this thread to begin execution; the Java Virtual Machine calls the run method of this thread.` è¿™æ®µè¯çš„æ„æ€æ˜¯ï¼šç”± JVM è°ƒç”¨æ­¤çº¿ç¨‹çš„ run æ–¹æ³•ï¼Œä½¿çº¿ç¨‹å¼€å§‹æ‰§è¡Œã€‚*å…¶å®è¿™å°±æ˜¯ä¸€ä¸ª JVM çš„å›è°ƒè¿‡ç¨‹ï¼Œä¸‹æ–‡æºç åˆ†æä¸­ä¼šè®²åˆ°*
- å¦å¤– `start()` æ˜¯ä¸€ä¸ª `synchronized` æ–¹æ³•ï¼Œä½†ä¸ºäº†é¿å…å¤šæ¬¡è°ƒç”¨ï¼Œåœ¨æ–¹æ³•ä¸­ä¼šç”±çº¿ç¨‹çŠ¶æ€åˆ¤æ–­ã€‚`threadStatus != 0`ã€‚
- `group.add(this)`ï¼Œæ˜¯æŠŠå½“å‰çº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹ç»„ï¼ŒThreadGroupã€‚
- `start0()`ï¼Œæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œé€šè¿‡ JNI æ–¹å¼è°ƒç”¨æ‰§è¡Œã€‚è¿™ä¸€æ­¥çš„æ“ä½œæ‰æ˜¯å¯åŠ¨çº¿ç¨‹çš„æ ¸å¿ƒæ­¥éª¤ã€‚

#### 2.2 start0() æœ¬åœ°æ–¹æ³•

```java
// æœ¬åœ°æ–¹æ³• start0
private native void start0();

// æ³¨å†Œæœ¬åœ°æ–¹æ³•
public class Thread implements Runnable {
    /* Make sure registerNatives is the first thing <clinit> does. */
    private static native void registerNatives();
    static {
        registerNatives();
    }
    // ...
}    
```

- `start0()`ï¼Œæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨çº¿ç¨‹ã€‚
- `registerNatives()`ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨äºæ³¨å†Œçº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦çš„ä¸€äº›æœ¬åœ°æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š`start0`ã€`isAlive`ã€`yield`ã€`sleep`ã€`interrupt0`ç­‰ã€‚

**registerNatives**ï¼Œæœ¬åœ°æ–¹æ³•å®šä¹‰åœ¨ `Thread.c` ä¸­ï¼Œä»¥ä¸‹æ˜¯å®šä¹‰çš„æ ¸å¿ƒæºç ï¼š

```java
static JNINativeMethod methods[] = {
    {"start0",           "()V",        (void *)&JVM_StartThread},
    {"stop0",            "(" OBJ ")V", (void *)&JVM_StopThread},
    {"isAlive",          "()Z",        (void *)&JVM_IsThreadAlive},
    {"suspend0",         "()V",        (void *)&JVM_SuspendThread},
    {"resume0",          "()V",        (void *)&JVM_ResumeThread},
    {"setPriority0",     "(I)V",       (void *)&JVM_SetThreadPriority},
    {"yield",            "()V",        (void *)&JVM_Yield},
    {"sleep",            "(J)V",       (void *)&JVM_Sleep},
    {"currentThread",    "()" THD,     (void *)&JVM_CurrentThread},
    {"interrupt0",       "()V",        (void *)&JVM_Interrupt},
    {"holdsLock",        "(" OBJ ")Z", (void *)&JVM_HoldsLock},
    {"getThreads",        "()[" THD,   (void *)&JVM_GetAllThreads},
    {"dumpThreads",      "([" THD ")[[" STE, (void *)&JVM_DumpThreads},
    {"setNativeName",    "(" STR ")V", (void *)&JVM_SetNativeThreadName},
};
```

- **æºç **ï¼š[https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c](https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c)
- ä»å®šä¹‰ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ`start0` æ–¹æ³•ä¼šæ‰§è¡Œ `&JVM_StartThread` æ–¹æ³•ï¼Œæœ€ç»ˆç”± JVM å±‚é¢å¯åŠ¨çº¿ç¨‹ã€‚

### 3. JVM åˆ›å»ºçº¿ç¨‹

#### 3.1 JVM_StartThread

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp)

```java
JVM_ENTRY(void, JVM_StartThread(JNIEnv* env, jobject jthread))
  JVMWrapper("JVM_StartThread");
  JavaThread *native_thread = NULL;
  
  // åˆ›å»ºçº¿ç¨‹
  native_thread = new JavaThread(&thread_entry, sz);
  // å¯åŠ¨çº¿ç¨‹
  Thread::start(native_thread);

JVM_END
```

- è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒå¤šï¼Œä½†æ ¸å¿ƒå†…å®¹ä¸»è¦æ˜¯`åˆ›å»ºçº¿ç¨‹`å’Œ`å¯åŠ¨çº¿ç¨‹`ï¼Œå¦å¤– `&thread_entry` ä¹Ÿæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

**thread_entryï¼Œçº¿ç¨‹å…¥å£**

```java
static void thread_entry(JavaThread* thread, TRAPS) {
  HandleMark hm(THREAD);
  Handle obj(THREAD, thread->threadObj());
  JavaValue result(T_VOID);
  JavaCalls::call_virtual(&result,
                          obj,
                          KlassHandle(THREAD, SystemDictionary::Thread_klass()),
                          vmSymbols::run_method_name(),
                          vmSymbols::void_method_signature(),
                          THREAD);
}
```

**é‡ç‚¹**ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹å¼•å…¥è¿™ä¸ªçº¿ç¨‹å…¥å£çš„æ–¹æ³•æ—¶ï¼Œ`thread_entry` ä¸­åŒ…æ‹¬äº† Java çš„å›è°ƒå‡½æ•° `JavaCalls::call_virtual`ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°ä¼šç”± JVM è°ƒç”¨ã€‚

**vmSymbols::run_method_name()**ï¼Œå°±æ˜¯é‚£ä¸ªè¢«å›è°ƒçš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp)

```java
#define VM_SYMBOLS_DO(template, do_alias)
template(run_method_name, "run") 
```

- è¿™ä¸ª `run` å°±æ˜¯æˆ‘ä»¬çš„ Java ç¨‹åºä¸­ä¼šè¢«è°ƒç”¨çš„ run æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æŒ‰ç…§ä»£ç æ‰§è¡Œé“¾è·¯ï¼Œå¯»æ‰¾åˆ°è¿™ä¸ªè¢«å›è°ƒçš„æ–¹æ³•åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ã€‚

#### 3.2 JavaThread

```java
native_thread = new JavaThread(&thread_entry, sz);
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ `JavaThread` çš„æºç æ‰§è¡Œå†…å®¹ã€‚

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp)

```java
JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
  Thread()
#if INCLUDE_ALL_GCS
  , _satb_mark_queue(&_satb_mark_queue_set),
  _dirty_card_queue(&_dirty_card_queue_set)
#endif // INCLUDE_ALL_GCS
{
  if (TraceThreadEvents) {
    tty->print_cr("creating thread %p", this);
  }
  initialize();
  _jni_attach_state = _not_attaching_via_jni;
  set_entry_point(entry_point);
  // Create the native thread itself.
  // %note runtime_23
  os::ThreadType thr_type = os::java_thread;
  thr_type = entry_point == &compiler_thread_entry ? os::compiler_thread :os::java_thread;
  os::create_thread(this, thr_type, stack_sz);
}
```

- `ThreadFunction entry_point`ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„ `thread_entry` æ–¹æ³•ã€‚
- `size_t stack_sz`ï¼Œè¡¨ç¤ºè¿›ç¨‹ä¸­å·²æœ‰çš„çº¿ç¨‹ä¸ªæ•°ã€‚
- **è¿™ä¸¤ä¸ªå‚æ•°**ï¼Œéƒ½ä¼šä¼ é€’ç»™ `os::create_thread` æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ä½¿ç”¨ã€‚

#### 3.3 os::create_thread

**æºç **ï¼š

- `os_linux.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp)
- `os_windows.cpp`ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp)

`ä¼—æ‰€å‘¨çŸ¥ï¼ŒJVM æ˜¯ä¸ªå•¥ï¼`ï¼Œæ‰€ä»¥å®ƒçš„ OS æœåŠ¡å®ç°ï¼ŒLinux è¿˜æœ‰ Windows ç­‰ï¼Œéƒ½ä¼šå®ç°çº¿ç¨‹çš„åˆ›å»ºé€»è¾‘ã€‚*è¿™æœ‰ç‚¹åƒé€‚é…å™¨æ¨¡å¼*

**os_linux -> os::create_thread**

```java
bool os::create_thread(Thread* thread, ThreadType thr_type, size_t stack_size) {
  assert(thread->osthread() == NULL, "caller responsible");

  // Allocate the OSThread object
  OSThread* osthread = new OSThread(NULL, NULL);
  // Initial state is ALLOCATED but not INITIALIZED
  osthread->set_state(ALLOCATED);
  
  pthread_t tid;
  int ret = pthread_create(&tid, &attr, (void* (*)(void*)) java_start, thread);

  return true;
}
```

- `osthread->set_state(ALLOCATED)`ï¼Œåˆå§‹åŒ–å·²åˆ†é…çš„çŠ¶æ€ï¼Œä½†æ­¤æ—¶å¹¶æ²¡æœ‰åˆå§‹åŒ–ã€‚
- `pthread_create`ï¼Œæ˜¯ç±»Unixæ“ä½œç³»ç»Ÿï¼ˆUnixã€Linuxã€Mac OS Xç­‰ï¼‰çš„åˆ›å»ºçº¿ç¨‹çš„å‡½æ•°ã€‚
- `java_start`ï¼Œé‡ç‚¹å…³æ³¨ç±»ï¼Œæ˜¯å®é™…åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•ã€‚

#### 3.4 java_start

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp)

```java
static void *java_start(Thread *thread) {

  // çº¿ç¨‹ID
  int pid = os::current_process_id();

  // è®¾ç½®çº¿ç¨‹
  ThreadLocalStorage::set_thread(thread);

  // è®¾ç½®çº¿ç¨‹çŠ¶æ€ï¼šINITIALIZED åˆå§‹åŒ–å®Œæˆ
  osthread->set_state(INITIALIZED);
  
  // å”¤é†’æ‰€æœ‰çº¿ç¨‹
  sync->notify_all();

 // å¾ªç¯ï¼Œåˆå§‹åŒ–çŠ¶æ€ï¼Œåˆ™ä¸€è‡´ç­‰å¾… wait
 while (osthread->get_state() == INITIALIZED) {
    sync->wait(Mutex::_no_safepoint_check_flag);
 }

  // ç­‰å¾…å”¤é†’åï¼Œæ‰§è¡Œ run æ–¹æ³•
  thread->run();

  return 0;
}
```

- JVM è®¾ç½®çº¿ç¨‹çŠ¶æ€ï¼ŒINITIALIZED åˆå§‹åŒ–å®Œæˆã€‚
- `sync->notify_all()`ï¼Œå”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚
- `osthread->get_state() == INITIALIZED`ï¼Œwhile å¾ªç¯ç­‰å¾…
- `thread->run()`ï¼Œæ˜¯ç­‰å¾…çº¿ç¨‹å”¤é†’åï¼Œä¹Ÿå°±æ˜¯çŠ¶æ€å˜æ›´åï¼Œæ‰èƒ½æ‰§è¡Œåˆ°ã€‚*è¿™åœ¨æˆ‘ä»¬çš„çº¿ç¨‹æ‰§è¡ŒUMLå›¾ä¸­ï¼Œä¹Ÿæœ‰æ‰€ä½“ç°*

### 4. JVM å¯åŠ¨çº¿ç¨‹

```java
JVM_ENTRY(void, JVM_StartThread(JNIEnv* env, jobject jthread))
  JVMWrapper("JVM_StartThread");
  JavaThread *native_thread = NULL;
  
  // åˆ›å»ºçº¿ç¨‹
  native_thread = new JavaThread(&thread_entry, sz);
  // å¯åŠ¨çº¿ç¨‹
  Thread::start(native_thread);

JVM_END
```

- `JVM_StartThread` ä¸­æœ‰ä¸¤æ­¥ï¼Œåˆ›å»ºï¼ˆ`new JavaThread`ï¼‰ã€å¯åŠ¨ï¼ˆ`Thread::start`ï¼‰ã€‚åˆ›å»ºçš„è¿‡ç¨‹èŠå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬èŠå¯åŠ¨ã€‚

#### 4.1 Thread::start

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp)

```java
void Thread::start(Thread* thread) {
  trace("start", thread);

  if (!DisableStartThread) {
    if (thread->is_Java_thread()) {
      java_lang_Thread::set_thread_status(((JavaThread*)thread)->threadObj(),
                                          java_lang_Thread::RUNNABLE);
    }
    // ä¸åŒçš„ OS ä¼šæœ‰ä¸åŒçš„å¯åŠ¨ä»£ç é€»è¾‘
    os::start_thread(thread);
  }
}
```

- å¦‚æœæ²¡æœ‰ç¦ç”¨çº¿ç¨‹ `DisableStartThread` å¹¶ä¸”æ˜¯ Java çº¿ç¨‹ `thread->is_Java_thread()`ï¼Œé‚£ä¹ˆè®¾ç½®çº¿ç¨‹çŠ¶æ€ä¸º `RUNNABLE`ã€‚
- `os::start_thread(thread)`ï¼Œè°ƒç”¨çº¿ç¨‹å¯åŠ¨æ–¹æ³•ã€‚*ä¸åŒçš„ OS ä¼šæœ‰ä¸åŒçš„å¯åŠ¨ä»£ç é€»è¾‘*

#### 4.2 os::start_thread(thread)

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp)

```java
void os::start_thread(Thread* thread) {
  // guard suspend/resume
  MutexLockerEx ml(thread->SR_lock(), Mutex::_no_safepoint_check_flag);
  OSThread* osthread = thread->osthread();
  osthread->set_state(RUNNABLE);
  pd_start_thread(thread);
}
```

- `osthread->set_state(RUNNABLE)`ï¼Œè®¾ç½®çº¿ç¨‹çŠ¶æ€ `RUNNABLE`
- `pd_start_thread(thread)`ï¼Œå¯åŠ¨çº¿ç¨‹ï¼Œè¿™ä¸ªå°±ç”±å„ä¸ª OS å®ç°ç±»ï¼Œå®ç°å„è‡ªç³»ç»Ÿçš„å¯åŠ¨æ–¹æ³•äº†ã€‚*æ¯”å¦‚ï¼Œwindowsç³»ç»Ÿå’ŒLinuxç³»ç»Ÿçš„ä»£ç æ˜¯å®Œå…¨ä¸åŒçš„ã€‚*

#### 4.3 pd_start_thread(thread)

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp)

```java
void os::pd_start_thread(Thread* thread) {
  OSThread * osthread = thread->osthread();
  assert(osthread->get_state() != INITIALIZED, "just checking");
  Monitor* sync_with_child = osthread->startThread_lock();
  MutexLockerEx ml(sync_with_child, Mutex::_no_safepoint_check_flag);
  sync_with_child->notify();
}
```

- è¿™éƒ¨åˆ†ä»£ç  `notify()` æœ€å…³é”®ï¼Œå®ƒå¯ä»¥å”¤é†’çº¿ç¨‹ã€‚
- çº¿ç¨‹å”¤é†’åï¼Œ`3.4 ä¸­çš„ thread->run();` å°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚

### 5. JVM çº¿ç¨‹å›è°ƒ

#### 5.1 thread->run()[JavaThread::run()]

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp)

```java
// The first routine called by a new Java thread
void JavaThread::run() {
  // ... åˆå§‹åŒ–çº¿ç¨‹æ“ä½œ
  
  thread_main_inner();
}
```

- os_linux.cpp ç±»ä¸­çš„ java_start é‡Œçš„ thread->run()ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ thread.cpp çš„ JavaThread::run() æ–¹æ³•ã€‚
- è¿™éƒ¨åˆ†è¿˜éœ€è¦ç»§ç»­å¾€ä¸‹çœ‹ï¼Œ`thread_main_inner();` æ–¹æ³•ã€‚

#### 5.2 thread_main_inner

**æºç **ï¼š[https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp](https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp)

```java
void JavaThread::thread_main_inner() {

  if (!this->has_pending_exception() &&
      !java_lang_Thread::is_stillborn(this->threadObj())) {
    {
      ResourceMark rm(this);
      this->set_native_thread_name(this->get_thread_name());
    }
    HandleMark hm(this);
    this->entry_point()(this, this);
  }

  DTRACE_THREAD_PROBE(stop, this);

  this->exit(false);
  delete this;
}
```

- è¿™é‡Œæœ‰ä½ ç†Ÿæ‚‰çš„è®¾ç½®çš„çº¿ç¨‹åç§°ï¼Œ`this->set_native_thread_name(this->get_thread_name())`ã€‚
- `this->entry_point()`ï¼Œå®é™…è°ƒç”¨çš„å°±æ˜¯  3.1 ä¸­çš„ thread_entry æ–¹æ³•ã€‚
- `thread_entry`ï¼Œæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° `JavaCalls::call_virtual` é‡Œçš„`vmSymbols::run_method_name()`ã€‚ä¹Ÿå°±æ˜¯ run() æ–¹æ³•ï¼Œè‡³æ­¤çº¿ç¨‹å¯åŠ¨å®Œæˆã€‚*ç»ˆäºä¸²å›æ¥äº†ï¼*

## äº”ã€æ€»ç»“

- çº¿ç¨‹çš„å¯åŠ¨è¿‡ç¨‹æ¶‰åŠåˆ°äº† JVM çš„å‚ä¸ï¼Œæ‰€ä»¥å¦‚æœæ²¡æœ‰è®¤çœŸäº†è§£è¿‡ï¼Œç¡®å®å¾ˆéš¾ä»ä¸€ä¸ªæœ¬åœ°æ–¹æ³•äº†è§£çš„å¦‚æ­¤é€å½»ã€‚
- æ•´ä¸ªæºç åˆ†æå¯ä»¥ç»“åˆç€ä»£ç è°ƒç”¨UMLæ—¶åºå›¾è¿›è¡Œå­¦ä¹ ï¼ŒåŸºæœ¬æ ¸å¿ƒè¿‡ç¨‹åŒ…æ‹¬ï¼š`Java åˆ›å»ºçº¿ç¨‹å’Œå¯åŠ¨`ã€`è°ƒç”¨æœ¬åœ°æ–¹æ³• start0()`ã€`JVM ä¸­ JVM_StartThread çš„åˆ›å»ºå’Œå¯åŠ¨`ã€`è®¾ç½®çº¿ç¨‹çŠ¶æ€ç­‰å¾…è¢«å”¤é†’`ã€`æ ¹æ®ä¸åŒçš„OSå¯åŠ¨çº¿ç¨‹å¹¶å”¤é†’`ã€`æœ€åå›è°ƒ run() æ–¹æ³•å¯åŠ¨ Java çº¿ç¨‹`ã€‚
- æœ‰æ—¶å€™å¯èƒ½åªæ˜¯ä¸€æ­¥å¾ˆç®€å•çš„æ–¹æ³•ï¼Œä¹Ÿä¼šæœ‰å®ƒçš„æ·±å…¥ä¹‹å¤„ï¼Œå½“çœŸçš„æ‡‚äº†ä»¥åï¼Œå°±ä¸ç”¨æ­»è®°ç¡¬èƒŒã€‚*å¦‚æœéœ€è¦è·å¾—ä»¥ä¸Šé«˜æ¸…å¤§å›¾ï¼Œå¯ä»¥æ·»åŠ å°å‚…å“¥å¾®ä¿¡(`fustack`)ï¼Œå¤‡æ³¨ï¼šThreadå¤§å›¾*
