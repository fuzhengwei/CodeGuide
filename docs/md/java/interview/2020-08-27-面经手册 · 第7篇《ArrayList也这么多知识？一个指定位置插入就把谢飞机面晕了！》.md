---
layout: post
category: interview
title: é¢ç»æ‰‹å†Œ Â· ç¬¬7ç¯‡ã€ŠArrayListä¹Ÿè¿™ä¹ˆå¤šçŸ¥è¯†ï¼Ÿä¸€ä¸ªæŒ‡å®šä½ç½®æ’å…¥å°±æŠŠè°¢é£æœºé¢æ™•äº†ï¼ã€‹
tagline: by å°å‚…å“¥
tag: [java,interview]
excerpt: ArrayListä½¿ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ã€æ€ä¹ˆåˆå§‹åŒ–ã€å›ºå®šä½ç½®æ’å…¥æŠ¥é”™å—ã€æ‰©å®¹å¤§å°æ˜¯å¤šå°‘ã€æ•°æ®æ€ä¹ˆè¿ç§»ã€å¦‚ä½•ä½¿ç”¨æ€§èƒ½æ›´å¥½ï¼Œç­‰ç­‰ã€‚äº†è§£ä¸€ä¸ªçŸ¥è¯†å¾€å¾€è¦ä»æ ¹æœ¬å­¦ä¹ ï¼Œå‡ ä¸ªç®€å•çš„é¢è¯•é¢˜åªèƒ½ä½œä¸ºè¾¹è§’çš„è€ƒç‚¹ï¼Œåªæœ‰è‡ªå·±çœŸçš„æŒæ¡äº†æ‰èƒ½æŠ—ä½ä»»ä½•å‘é—®å’Œè¿ç”¨åˆ°å¼€å‘ä¸­ã€‚
lock: need
---

# é¢ç»æ‰‹å†Œ Â· ç¬¬7ç¯‡ã€ŠArrayListä¹Ÿè¿™ä¹ˆå¤šçŸ¥è¯†ï¼Ÿä¸€ä¸ªæŒ‡å®šä½ç½®æ’å…¥å°±æŠŠè°¢é£æœºé¢æ™•äº†ï¼ã€‹

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`æ•°æ®ç»“æ„æ˜¯å†™å¥½ä»£ç çš„åŸºç¡€ï¼`

è¯´åˆ°æ•°æ®ç»“æ„åŸºæœ¬åŒ…æ‹¬ï¼›æ•°ç»„ã€é“¾è¡¨ã€é˜Ÿåˆ—ã€çº¢é»‘æ ‘ç­‰ï¼Œä½†å½“ä½ çœ‹åˆ°è¿™äº›æ•°æ®ç»“æ„ä»¥åŠæƒ³åˆ°è‡ªå·±å¹³æ—¶çš„å¼€å‘ï¼Œä¼¼ä¹å¹¶æ²¡æœ‰ç”¨åˆ°è¿‡ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦å­¦ä¹ æ•°æ®ç»“æ„ï¼Ÿ

å…¶å®è¿™äº›çŸ¥è¯†ç‚¹ä½ å¹¶ä¸æ˜¯æ²¡æœ‰ç”¨åˆ°çš„ï¼Œè€Œæ˜¯Javaä¸­çš„APIå·²ç»å°†å„ä¸ªæ•°æ®ç»“æ„å°è£…æˆå¯¹åº”çš„å·¥å…·ç±»ï¼Œä¾‹å¦‚ArrayListã€LinkedListã€HashMapç­‰ï¼Œå°±åƒåœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œå°å‚…å“¥å†™äº†5ç¯‡æ–‡ç« å°†è¿‘2ä¸‡å­—æ¥åˆ†æHashMapï¼Œä»è€Œå­¦ä¹ å®ƒçš„æ ¸å¿ƒè®¾è®¡é€»è¾‘ã€‚

å¯èƒ½æœ‰äººè§‰å¾—è¿™ç±»çŸ¥è¯†å°±åƒ**å…«è‚¡æ–‡**ï¼Œå­¦ä¹ åªæ˜¯ä¸ºäº†åº”ä»˜é¢è¯•ã€‚å¦‚æœä½ çœŸçš„æŠŠè¿™äº›ç”¨äºæ”¯æ’‘å…¶æ•´ä¸ªè¯­è¨€çš„æ ¹åŸºå½“å…«è‚¡æ–‡å­¦ä¹ ï¼Œé‚£ä¹ˆç¡¬èƒŒä¸‹æ¥ä¸ä¼šæœ‰å¤šå°‘æ”¶è·ã€‚ç†ç§‘å­¦ä¹ æ›´åœ¨ä¹é€»è¾‘ï¼Œé‡åœ¨æ˜¯ç†è§£åŸºæœ¬åŸç†ï¼Œæœ‰äº†åŸç†åŸºç¡€å°±å¤ç”¨è¿™æ ·çš„æŠ€æœ¯è¿ç”¨åˆ°å®é™…çš„ä¸šåŠ¡å¼€å‘ã€‚

é‚£ä¹ˆï¼Œä½ ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°è¿™æ ·çš„æŠ€æœ¯å‘¢ï¼Ÿå°±æ˜¯ï¼Œå½“ä½ è€ƒè™‘ä½“é‡ã€å¤¯å®æœåŠ¡ã€ç¢ç£¨æ€§èƒ½æ—¶ï¼Œå°±ä¼šé€æ¸çš„æ·±å…¥åˆ°æ•°æ®ç»“æ„ä»¥åŠæ ¸å¿ƒçš„åŸºæœ¬åŸç†å½“ä¸­ï¼Œé‚£é‡Œçš„æ¯ä¸€åˆ†æ·±å…¥ï¼Œéƒ½ä¼šè®©æ•´ä¸ªæœåŠ¡æ€§èƒ½æˆæŒ‡æ•°çš„æå‡ã€‚

## äºŒã€é¢è¯•é¢˜

**è°¢é£æœº**ï¼Œå¬è¯´ä½ æœ€è¿‘åœ¨å®¶å¾ˆåŠªåŠ›å­¦ä¹ HashMapï¼Ÿé‚£è€ƒä½ ä¸ªArrayListçŸ¥è¯†ç‚¹ğŸ¦€

ä½ çœ‹ä¸‹é¢è¿™æ®µä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```java
public static void main(String[] args) {
    List<String> list = new ArrayList<String>(10);
    list.add(2, "1");
    System.out.println(list.get(0));
}
```

å—¯ï¼Ÿä¸çŸ¥é“ï¼ğŸ‘€çœ¼ç›çœ‹é¢˜ï¼Œçœ‹æˆ‘è„¸å¹²å•¥ï¼Ÿå¥½å¥½å¥½ï¼Œå‘Šè¯‰ä½ å§ï¼Œè¿™æ ·ä¼šæŠ¥é”™ï¼è‡³äºä¸ºä»€ä¹ˆï¼Œå›å®¶çœ‹çœ‹ä¹¦å§ã€‚

```java
Exception in thread "main" java.lang.IndexOutOfBoundsException: Index: 2, Size: 0
	at java.util.ArrayList.rangeCheckForAdd(ArrayList.java:665)
	at java.util.ArrayList.add(ArrayList.java:477)
	at org.itstack.interview.test.ApiTest.main(ApiTest.java:13)

Process finished with exit code 1
```

*ğŸ¤­è°¢é£æœºæ˜¯æ‡µäº†ï¼Œå’±ä»¬ä¸€ç‚¹ç‚¹åˆ†æArrayList*

## ä¸‰ã€æ•°æ®ç»“æ„

`Array + List = æ•°ç»„ + åˆ—è¡¨ = ArrayList = æ•°ç»„åˆ—è¡¨`

![](https://bugstack.cn/assets/images/2020/interview/interview-8-01.png)

ArrayListçš„æ•°æ®ç»“æ„æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œåªä¸è¿‡è¿™ä¸ªæ•°ç»„ä¸åƒæˆ‘ä»¬æ™®é€šå®šä¹‰çš„æ•°ç»„ï¼Œå®ƒå¯ä»¥åœ¨ArrayListçš„ç®¡ç†ä¸‹æ’å…¥æ•°æ®æ—¶æŒ‰éœ€åŠ¨æ€æ‰©å®¹ã€æ•°æ®æ‹·è´ç­‰æ“ä½œã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€æ­¥åˆ†æArrayListçš„æºç ï¼Œä¹ŸåŒæ—¶è§£ç­”`è°¢é£æœº`çš„ç–‘é—®ã€‚

## å››ã€æºç åˆ†æ

### 1. åˆå§‹åŒ–

```java
List<String> list = new ArrayList<String>(10);

public ArrayList() {
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}

 /**
  * Constructs an empty list with the specified initial capacity.
  *
  * @param  initialCapacity  the initial capacity of the list
  * @throws IllegalArgumentException if the specified initial capacity
  *         is negative
  */
 public ArrayList(int initialCapacity) {
     if (initialCapacity > 0) {
         this.elementData = new Object[initialCapacity];
     } else if (initialCapacity == 0) {
         this.elementData = EMPTY_ELEMENTDATA;
     } else {
         throw new IllegalArgumentException("Illegal Capacity: "+
                                            initialCapacity);
     }
 }
```

- é€šå¸¸æƒ…å†µç©ºæ„é€ å‡½æ•°åˆå§‹åŒ–ArrayListæ›´å¸¸ç”¨ï¼Œè¿™ç§æ–¹å¼æ•°ç»„çš„é•¿åº¦ä¼šåœ¨ç¬¬ä¸€æ¬¡æ’å…¥æ•°æ®æ—¶å€™è¿›è¡Œè®¾ç½®ã€‚
- å½“æˆ‘ä»¬å·²ç»çŸ¥é“è¦å¡«å……å¤šå°‘ä¸ªå…ƒç´ åˆ°ArrayListä¸­ï¼Œæ¯”å¦‚500ä¸ªã€1000ä¸ªï¼Œé‚£ä¹ˆä¸ºäº†æä¾›æ€§èƒ½ï¼Œå‡å°‘ArrayListä¸­çš„æ‹·è´æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ä¼šç›´æ¥åˆå§‹åŒ–ä¸€ä¸ªé¢„å…ˆè®¾å®šå¥½çš„é•¿åº¦ã€‚
- å¦å¤–ï¼Œ`EMPTY_ELEMENTDATA` æ˜¯ä¸€ä¸ªå®šä¹‰å¥½çš„ç©ºå¯¹è±¡ï¼›`private static final Object[] EMPTY_ELEMENTDATA = {}`

#### 1.1 æ–¹å¼01ï¼›æ™®é€šæ–¹å¼

```java
ArrayList<String> list = new ArrayList<String>();
list.add("aaa");
list.add("bbb");
list.add("ccc");
```

- è¿™ä¸ªæ–¹å¼å¾ˆç®€å•ä¹Ÿæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚

#### 1.2 æ–¹å¼02ï¼›å†…éƒ¨ç±»æ–¹å¼

```java
ArrayList<String> list = new ArrayList<String>() \\{
    add("aaa");
    add("bbb");
    add("ccc");
\\};
```

- è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ï¼Œè€Œä¸”çœå»äº†å¤šä½™çš„ä»£ç é‡ã€‚

#### 1.3 æ–¹å¼03ï¼›Arrays.asList

```java
 ArrayList<String> list = new ArrayList<String>(Arrays.asList("aaa", "bbb", "ccc"));
```

ä»¥ä¸Šæ˜¯é€šè¿‡`Arrays.asList`ä¼ é€’ç»™`ArrayList`æ„é€ å‡½æ•°çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼›

##### 1.3.1 ArrayListæ„é€ å‡½æ•°

```java
public ArrayList(Collection<? extends E> c) {
    elementData = c.toArray();
    if ((size = elementData.length) != 0) {
        // c.toArray might (incorrectly) not return Object[] (see 6260652)
        if (elementData.getClass() != Object[].class)
            elementData = Arrays.copyOf(elementData, size, Object[].class);
    } else {
        // replace with empty array.
        this.elementData = EMPTY_ELEMENTDATA;
    }
}
```

- é€šè¿‡æ„é€ å‡½æ•°å¯ä»¥çœ‹åˆ°ï¼Œåªè¦å®ç°`Collection`ç±»çš„éƒ½å¯ä»¥ä½œä¸ºå…¥å‚ã€‚
- åœ¨é€šè¿‡è½¬ä¸ºæ•°ç»„ä»¥åŠæ‹·è´`Arrays.copyOf`åˆ°`Object[]`é›†åˆä¸­åœ¨èµ‹å€¼ç»™å±æ€§`elementData`ã€‚

**æ³¨æ„ï¼šc.toArray might (incorrectly) not return Object[] (`see 6260652`)**

see 6260652 æ˜¯JDK bugåº“çš„ç¼–å·ï¼Œæœ‰ç‚¹åƒå•†å“skuï¼Œbugåœ°å€:[https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6260652](https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6260652)

é‚£è¿™æ˜¯ä¸ªä»€ä¹ˆbugå‘¢ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹é¢è¿™æ®µä»£ç ï¼›

```java
@Test
public void t(){
    List<Integer> list1 = Arrays.asList(1, 2, 3);
    System.out.println("é€šè¿‡æ•°ç»„è½¬æ¢ï¼š" + (list1.toArray().getClass() == Object[].class));
    
    ArrayList<Integer> list2 = new ArrayList<Integer>(Arrays.asList(1, 2, 3));
    System.out.println("é€šè¿‡é›†åˆè½¬æ¢ï¼š" + (list2.toArray().getClass() == Object[].class));
}
```

æµ‹è¯•ç»“æœï¼š

```java
é€šè¿‡æ•°ç»„è½¬æ¢ï¼šfalse
é€šè¿‡é›†åˆè½¬æ¢ï¼štrue

Process finished with exit code 0
```

- `public Object[] toArray()` è¿”å›çš„ç±»å‹ä¸ä¸€å®šå°±æ˜¯ `Object[]`ï¼Œå…¶ç±»å‹å–å†³äºå…¶è¿”å›çš„å®é™…ç±»å‹ï¼Œæ¯•ç«Ÿ Object æ˜¯çˆ¶ç±»ï¼Œå®ƒå¯ä»¥æ˜¯å…¶ä»–ä»»æ„ç±»å‹ã€‚
- å­ç±»å®ç°å’Œçˆ¶ç±»åŒåçš„æ–¹æ³•ï¼Œä»…ä»…è¿”å›å€¼ä¸ä¸€è‡´æ—¶ï¼Œé»˜è®¤è°ƒç”¨çš„æ˜¯å­ç±»çš„å®ç°æ–¹æ³•ã€‚

é€ æˆè¿™ä¸ªç»“æœçš„åŸå› ï¼Œå¦‚ä¸‹ï¼›
1. Arrays.asList ä½¿ç”¨çš„æ˜¯ï¼š`Arrays.copyOf(this.a, size,(Class<? extends T[]>) a.getClass());`
2. ArrayList æ„é€ å‡½æ•°ä½¿ç”¨çš„æ˜¯ï¼š`Arrays.copyOf(elementData, size, Object[].class);` 

##### 1.3.2 Arrays.asList

**ä½ çŸ¥é“å—ï¼Ÿ**
- Arrays.asList æ„å»ºçš„é›†åˆï¼Œä¸èƒ½èµ‹å€¼ç»™ ArrayList
- Arrays.asList æ„å»ºçš„é›†åˆï¼Œä¸èƒ½å†æ·»åŠ å…ƒç´ 
- Arrays.asList æ„å»ºçš„é›†åˆï¼Œä¸èƒ½å†åˆ é™¤å…ƒç´ 

é‚£è¿™åˆ°åº•ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸ºArrays.asListæ„å»ºå‡ºæ¥çš„Listä¸new ArrayListå¾—åˆ°çš„Listï¼Œå‹æ ¹å°±ä¸æ˜¯ä¸€ä¸ªListï¼ç±»å…³ç³»å›¾å¦‚ä¸‹ï¼›

![å°å‚…å“¥ bugstack.cn & Listç±»å…³ç³»å›¾](https://bugstack.cn/assets/images/2020/interview/interview-8-02.png)

ä»ä»¥ä¸Šçš„ç±»å›¾å…³ç³»å¯ä»¥çœ‹åˆ°ï¼›
1. è¿™ä¸¤ä¸ªListå‹æ ¹ä¸åŒä¸€ä¸ªä¸œè¥¿ï¼Œè€Œä¸”Arrasysä¸‹çš„Listæ˜¯ä¸€ä¸ªç§æœ‰ç±»ï¼Œåªèƒ½é€šè¿‡asListä½¿ç”¨ï¼Œä¸èƒ½å•ç‹¬åˆ›å»ºã€‚
2. å¦å¤–è¿˜æœ‰è¿™ä¸ªArrayListä¸èƒ½æ·»åŠ å’Œåˆ é™¤ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒçš„å®ç°æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒArraysç±»ä¸­ï¼Œè¿™éƒ¨åˆ†æºç ï¼›`private static class ArrayList<E> extends AbstractList<E> implements RandomAccess, java.io.Serializable`

*æ­¤å¤–ï¼ŒArraysæ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œé‡Œé¢è¿˜æœ‰ä¸€äº›éå¸¸å¥½ç”¨çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼›äºŒåˆ†æŸ¥æ‰¾`Arrays.binarySearch`ã€æ’åº`Arrays.sort`ç­‰*

#### 1.4 æ–¹å¼04ï¼›Collections.ncopies

`Collections.nCopies` æ˜¯é›†åˆæ–¹æ³•ä¸­ç”¨äºç”Ÿæˆå¤šå°‘ä»½æŸä¸ªæŒ‡å®šå…ƒç´ çš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±ç”¨å®ƒæ¥åˆå§‹åŒ–ArrayListï¼Œå¦‚ä¸‹ï¼›

```java
ArrayList<Integer> list = new ArrayList<Integer>(Collections.nCopies(10, 0));
```

- è¿™ä¼šåˆå§‹åŒ–ä¸€ä¸ªç”±10ä¸ª0ç»„æˆçš„é›†åˆã€‚

### 2. æ’å…¥

ArrayListå¯¹å…ƒç´ çš„æ’å…¥ï¼Œå…¶å®å°±æ˜¯å¯¹æ•°ç»„çš„æ“ä½œï¼Œåªä¸è¿‡éœ€è¦ç‰¹å®šæ—¶å€™æ‰©å®¹ã€‚

#### 2.1 æ™®é€šæ’å…¥

```java
List<String> list = new ArrayList<String>();
list.add("aaa");
list.add("bbb");
list.add("ccc");
```

å½“æˆ‘ä»¬ä¾æ¬¡æ’å…¥æ·»åŠ å…ƒç´ æ—¶ï¼ŒArrayList.addæ–¹æ³•åªæ˜¯æŠŠå…ƒç´ è®°å½•åˆ°æ•°ç»„çš„å„ä¸ªä½ç½®ä¸Šäº†ï¼Œæºç å¦‚ä¸‹ï¼›

```java
/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return <tt>true</tt> (as specified by {@link Collection#add})
 */
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;
    return true;
}
```

- è¿™æ˜¯æ’å…¥å…ƒç´ æ—¶å€™çš„æºç ï¼Œ`size++`è‡ªå¢ï¼ŒæŠŠå¯¹åº”å…ƒç´ æ·»åŠ è¿›å»ã€‚

#### 2.2 æ’å…¥æ—¶æ‰©å®¹

åœ¨å‰é¢`åˆå§‹åŒ–`éƒ¨åˆ†è®²åˆ°ï¼ŒArrayListé»˜è®¤åˆå§‹åŒ–æ—¶ä¼šç”³è¯·10ä¸ªé•¿åº¦çš„ç©ºé—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªé•¿åº¦åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆæ‰©å®¹çš„å‘¢ï¼Ÿ

ä»æ ¹æœ¬ä¸Šåˆ†ææ¥è¯´ï¼Œæ•°ç»„æ˜¯å®šé•¿çš„ï¼Œå¦‚æœè¶…è¿‡åŸæ¥å®šé•¿é•¿åº¦ï¼Œæ‰©å®¹åˆ™éœ€è¦ç”³è¯·æ–°çš„æ•°ç»„é•¿åº¦ï¼Œå¹¶æŠŠåŸæ•°ç»„å…ƒç´ æ‹·è´åˆ°æ–°æ•°ç»„ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼›

![å°å‚…å“¥ bugstack.cn & æ•°ç»„æ‰©å®¹](https://bugstack.cn/assets/images/2020/interview/interview-8-03.png)

å›¾ä¸­ä»‹ç»äº†å½“Listç»“åˆå¯ç”¨ç©ºé—´é•¿åº¦ä¸è¶³æ—¶åˆ™éœ€è¦æ‰©å®¹ï¼Œè¿™ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹æ­¥éª¤ï¼›
1. åˆ¤æ–­é•¿åº¦å……è¶³ï¼›`ensureCapacityInternal(size + 1);`
2. å½“åˆ¤æ–­é•¿åº¦ä¸è¶³æ—¶ï¼Œåˆ™é€šè¿‡æ‰©å¤§å‡½æ•°ï¼Œè¿›è¡Œæ‰©å®¹ï¼›`grow(int minCapacity)`
3. æ‰©å®¹çš„é•¿åº¦è®¡ç®—ï¼›`int newCapacity = oldCapacity + (oldCapacity >> 1);`ï¼Œæ—§å®¹é‡ + æ—§å®¹é‡å³ç§»1ä½ï¼Œè¿™ç›¸å½“äºæ‰©å®¹ä¸ºåŸæ¥å®¹é‡çš„`(int)3/2`ã€‚
   4. 	10ï¼Œæ‰©å®¹æ—¶ï¼š1010 + 1010 >> 1 = 1010 + 0101 = 10 + 5 = 15
   2. 7ï¼Œæ‰©å®¹æ—¶ï¼š0111 + 0111 >> 1 = 0111 + 0011 = 7 + 3 = 10
4. å½“æ‰©å®¹å®Œä»¥åï¼Œå°±éœ€è¦è¿›è¡ŒæŠŠæ•°ç»„ä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°æ•°ç»„ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šç”¨åˆ°` Arrays.copyOf(elementData, newCapacity);`ï¼Œä½†ä»–çš„åº•å±‚ç”¨åˆ°çš„æ˜¯ï¼›`System.arraycopy`

**System.arraycopyï¼›**

```java
@Test
public void test_arraycopy() {
    int[] oldArr = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
    int[] newArr = new int[oldArr.length + (oldArr.length >> 1)];
    System.arraycopy(oldArr, 0, newArr, 0, oldArr.length);
    
    newArr[11] = 11;
    newArr[12] = 12;
    newArr[13] = 13;
    newArr[14] = 14;
    
    System.out.println("æ•°ç»„å…ƒç´ ï¼š" + JSON.toJSONString(newArr));
    System.out.println("æ•°ç»„é•¿åº¦ï¼š" + newArr.length);
    
    /**
     * æµ‹è¯•ç»“æœ
     * 
     * æ•°ç»„å…ƒç´ ï¼š[1,2,3,4,5,6,7,8,9,10,0,11,12,13,14]
     * æ•°ç»„é•¿åº¦ï¼š15
     */
}
```

- æ‹·è´æ•°ç»„çš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œä¸»è¦æ˜¯å¯¹`System.arraycopy`çš„æ“ä½œã€‚
- ä¸Šé¢å°±æ˜¯æŠŠæ•°ç»„`oldArr`æ‹·è´åˆ°`newArr`ï¼ŒåŒæ—¶æ–°æ•°ç»„çš„é•¿åº¦ï¼Œé‡‡ç”¨å’ŒArrayListä¸€æ ·çš„è®¡ç®—é€»è¾‘ï¼›`oldArr.length + (oldArr.length >> 1)`

#### 2.3 æŒ‡å®šä½ç½®æ’å…¥

```java
list.add(2, "1");
```

åˆ°è¿™ï¼Œç»ˆäºå¯ä»¥è¯´è¯´`è°¢é£æœº`çš„é¢è¯•é¢˜ï¼Œè¿™æ®µä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Œå¦‚ä¸‹ï¼›

```java
Exception in thread "main" java.lang.IndexOutOfBoundsException: Index: 2, Size: 0
	at java.util.ArrayList.rangeCheckForAdd(ArrayList.java:665)
	at java.util.ArrayList.add(ArrayList.java:477)
	at org.itstack.interview.test.ApiTest.main(ApiTest.java:14)
```

**å…¶å®**ï¼Œä¸€æ®µæŠ¥é”™æç¤ºï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ç¿»å¼€ä¸‹æºç å­¦ä¹ ä¸‹ã€‚

##### 2.3.1 å®¹é‡éªŒè¯

```java
public void add(int index, E element) {
    rangeCheckForAdd(index);
    
    ...
}

private void rangeCheckForAdd(int index) {
    if (index > size || index < 0)
        throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
}
```

- æŒ‡å®šä½ç½®æ’å…¥é¦–å…ˆè¦åˆ¤æ–­`rangeCheckForAdd`ï¼Œsizeçš„é•¿åº¦ã€‚
- é€šè¿‡ä¸Šé¢çš„å…ƒç´ æ’å…¥æˆ‘ä»¬çŸ¥é“ï¼Œæ¯æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œsizeè‡ªå¢ä¸€æ¬¡`size++`ã€‚
- æ‰€ä»¥å³ä½¿æˆ‘ä»¬ç”³è¯·äº†10ä¸ªå®¹é‡é•¿åº¦çš„ArrayListï¼Œä½†æ˜¯æŒ‡å®šä½ç½®æ’å…¥ä¼šä¾èµ–äºsizeè¿›è¡Œåˆ¤æ–­ï¼Œæ‰€ä»¥ä¼šæŠ›å‡º`IndexOutOfBoundsException`å¼‚å¸¸ã€‚

##### 2.3.2 å…ƒç´ è¿ç§»

![å°å‚…å“¥ bugstack.cn & æ’å…¥å…ƒç´ è¿ç§»](https://bugstack.cn/assets/images/2020/interview/interview-8-04.png)

æŒ‡å®šä½ç½®æ’å…¥çš„æ ¸å¿ƒæ­¥éª¤åŒ…æ‹¬ï¼›
1. åˆ¤æ–­sizeï¼Œæ˜¯å¦å¯ä»¥æ’å…¥ã€‚
2. åˆ¤æ–­æ’å…¥åæ˜¯å¦éœ€è¦æ‰©å®¹ï¼›`ensureCapacityInternal(size + 1);`ã€‚
3. æ•°æ®å…ƒç´ è¿ç§»ï¼ŒæŠŠä»å¾…æ’å…¥ä½ç½®åçš„å…ƒç´ ï¼Œé¡ºåºå¾€åè¿ç§»ã€‚
4. ç»™æ•°ç»„çš„æŒ‡å®šä½ç½®èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯æŠŠå¾…æ’å…¥å…ƒç´ æ’å…¥è¿›æ¥ã€‚

**éƒ¨åˆ†æºç ï¼š**

```java
public void add(int index, E element) {
	...
	// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ä»¥åŠæ‰©å®¹æ“ä½œ
	ensureCapacityInternal(size + 1);
    // æ•°æ®æ‹·è´è¿ç§»ï¼ŒæŠŠå¾…æ’å…¥ä½ç½®ç©ºå‡ºæ¥
    System.arraycopy(elementData, index, elementData, index + 1,
                     size - index);
    // æ•°æ®æ’å…¥æ“ä½œ                  
    elementData[index] = element;
    size++;
}
```

- è¿™éƒ¨åˆ†æºç çš„ä¸»è¦æ ¸å¿ƒæ˜¯åœ¨ï¼Œ`System.arraycopy`ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»æ¼”ç¤ºè¿‡ç›¸åº”çš„æ“ä½œæ–¹å¼ã€‚
- è¿™é‡Œåªæ˜¯è®¾å®šäº†æŒ‡å®šä½ç½®çš„è¿ç§»ï¼Œå¯ä»¥æŠŠä¸Šé¢çš„æ¡ˆä¾‹ä»£ç å¤åˆ¶ä¸‹æ¥åšæµ‹è¯•éªŒè¯ã€‚

**å®è·µï¼š**

```java
List<String> list = new ArrayList<String>(Collections.nCopies(9, "a"));
System.out.println("åˆå§‹åŒ–ï¼š" + list);

list.add(2, "b");
System.out.println("æ’å…¥åï¼š" + list);
```

**æµ‹è¯•ç»“æœï¼š**

```java
åˆå§‹åŒ–ï¼š[a, a, a, a, a, a, a, a, a]
æ’å…¥åï¼š[a, a, 1, a, a, a, a, a, a, a]

Process finished with exit code 0
```

- æŒ‡å®šä½ç½®å·²ç»æ’å…¥å…ƒç´ `1`ï¼Œåé¢çš„æ•°æ®å‘åè¿ç§»å®Œæˆã€‚

### 3. åˆ é™¤

æœ‰äº†æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ çš„ç»éªŒï¼Œç†è§£åˆ é™¤çš„è¿‡é•¿å°±æ¯”è¾ƒå®¹æ˜“äº†ï¼Œå¦‚ä¸‹å›¾ï¼›

![å°å‚…å“¥ bugstack.cn & åˆ é™¤å…ƒç´ ](https://bugstack.cn/assets/images/2020/interview/interview-8-05.png)

è¿™é‡Œæˆ‘ä»¬ç»“åˆç€ä»£ç ï¼š

```java
public E remove(int index) {
    rangeCheck(index);
    modCount++;
    E oldValue = elementData(index);
    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index,
                         numMoved);
    elementData[--size] = null; // clear to let GC do its work
    return oldValue;
}
```

åˆ é™¤çš„è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ï¼›
1. æ ¡éªŒæ˜¯å¦è¶Šç•Œï¼›`rangeCheck(index);`
2. è®¡ç®—åˆ é™¤å…ƒç´ çš„ç§»åŠ¨é•¿åº¦`numMoved`ï¼Œå¹¶é€šè¿‡`System.arraycopy`è‡ªå·±æŠŠå…ƒç´ å¤åˆ¶ç»™è‡ªå·±ã€‚
3. æŠŠç»“å°¾å…ƒç´ æ¸…ç©ºï¼Œnullã€‚

**è¿™é‡Œæˆ‘ä»¬åšä¸ªä¾‹å­ï¼š**

```java
@Test
public void test_copy_remove() {
    int[] oldArr = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
    int index = 2;
    int numMoved = 10 - index - 1;
    System.arraycopy(oldArr, index + 1, oldArr, index, numMoved);
    System.out.println("æ•°ç»„å…ƒç´ ï¼š" + JSON.toJSONString(oldArr));
}
```

- è®¾å®šä¸€ä¸ªæ‹¥æœ‰10ä¸ªå…ƒç´ çš„æ•°ç»„ï¼ŒåŒæ ·æŒ‰ç…§ArrayListçš„è§„åˆ™è¿›è¡Œç§»åŠ¨å…ƒç´ ã€‚
- æ³¨æ„ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿç»“æœï¼Œè¿™é‡Œæ²¡æœ‰æŠŠç»“å°¾å…ƒç´ è®¾ç½®ä¸ºnullã€‚

**æµ‹è¯•ç»“æœï¼š**

```java
æ•°ç»„å…ƒç´ ï¼š[1,2,4,5,6,7,8,9,10,10]

Process finished with exit code 0
```

- å¯ä»¥çœ‹åˆ°æŒ‡å®šä½ç½® index = 2ï¼Œå…ƒç´ å·²ç»è¢«åˆ æ‰ã€‚
- åŒæ—¶æ•°ç»„å·²ç»ç§»åŠ¨ç”¨`å…ƒç´ 4`å æ®äº†åŸæ¥`å…ƒç´ 3`çš„ä½ç½®ï¼ŒåŒæ—¶ç»“å°¾çš„10è¿˜ç­‰å¾…åˆ é™¤ã€‚*è¿™å°±æ˜¯ä¸ºä»€ä¹ˆArrayListä¸­æœ‰è¿™ä¹ˆä¸€å¥ä»£ç ï¼›elementData[--size] = null*

### 4. æ‰©å±•

å¦‚æœç»™ä½ ä¸€ç»„å…ƒç´ ï¼›`aã€bã€cã€dã€eã€fã€g`ï¼Œéœ€è¦ä½ æ”¾åˆ°ArrayListä¸­ï¼Œä½†æ˜¯è¦æ±‚è·å–ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼Œä½ æ€ä¹ˆå¤„ç†ï¼Ÿ

æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦çŸ¥é“å…ƒç´ æ·»åŠ åˆ°é›†åˆä¸­åçŸ¥é“å®ƒçš„ä½ç½®ï¼Œè€Œè¿™ä¸ªä½ç½®å‘¢ï¼Œå…¶å®å¯ä»¥é€šè¿‡å“ˆå¸Œå€¼ä¸é›†åˆé•¿åº¦ä¸è¿ç®—ï¼Œå¾—å‡ºå­˜æ”¾æ•°æ®çš„ä¸‹æ ‡ï¼Œå¦‚ä¸‹å›¾ï¼›

![å°å‚…å“¥ bugstack.cn & ä¸‹æ ‡è®¡ç®—](https://bugstack.cn/assets/images/2020/interview/interview-8-06.png)

- å¦‚å›¾å°±æ˜¯è®¡ç®—å‡ºæ¯ä¸€ä¸ªå…ƒç´ åº”è¯¥å­˜æ”¾çš„ä½ç½®ï¼Œè¿™æ ·å°±å¯ä»¥O(1)å¤æ‚åº¦è·å–å…ƒç´ ã€‚

#### 4.1 ä»£ç æ“ä½œ(æ·»åŠ å…ƒç´ )

```java
List<String> list = new ArrayList<String>(Collections.<String>nCopies(8, "0"));

list.set("a".hashCode() & 8 - 1, "a");
list.set("b".hashCode() & 8 - 1, "b");
list.set("c".hashCode() & 8 - 1, "c");
list.set("d".hashCode() & 8 - 1, "d");
list.set("e".hashCode() & 8 - 1, "e");
list.set("f".hashCode() & 8 - 1, "f");
list.set("g".hashCode() & 8 - 1, "g");
```

- ä»¥ä¸Šæ˜¯åˆå§‹åŒ–`ArrayList`ï¼Œå¹¶å­˜æ”¾ç›¸åº”çš„å…ƒç´ ã€‚å­˜æ”¾æ—¶å€™è®¡ç®—å‡ºæ¯ä¸ªå…ƒç´ çš„ä¸‹æ ‡å€¼ã€‚

#### 4.2 ä»£ç æ“ä½œ(è·å–å…ƒç´ )

```java
System.out.println("å…ƒç´ é›†åˆ:" + list);
System.out.println("è·å–å…ƒç´ f [\"f\".hashCode() & 8 - 1)] Idxï¼š" + ("f".hashCode() & (8 - 1)) + " å…ƒç´ ï¼š" + list.get("f".hashCode() & 8 - 1));
System.out.println("è·å–å…ƒç´ e [\"e\".hashCode() & 8 - 1)] Idxï¼š" + ("e".hashCode() & (8 - 1)) + " å…ƒç´ ï¼š" + list.get("e".hashCode() & 8 - 1));
System.out.println("è·å–å…ƒç´ d [\"d\".hashCode() & 8 - 1)] Idxï¼š" + ("d".hashCode() & (8 - 1)) + " å…ƒç´ ï¼š" + list.get("d".hashCode() & 8 - 1));
```

#### 4.3 æµ‹è¯•ç»“æœ

```java
å…ƒç´ é›†åˆ:[0, a, b, c, d, e, f, g]

è·å–å…ƒç´ f ["f".hashCode() & 8 - 1)] Idxï¼š6 å…ƒç´ ï¼šf
è·å–å…ƒç´ e ["e".hashCode() & 8 - 1)] Idxï¼š5 å…ƒç´ ï¼še
è·å–å…ƒç´ d ["d".hashCode() & 8 - 1)] Idxï¼š4 å…ƒç´ ï¼šd

Process finished with exit code 0
```

- é€šè¿‡æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¸‹æ ‡ä½ç½®0æ˜¯åˆå§‹å…ƒç´ ï¼Œå…ƒç´ æ˜¯æŒ‰ç…§æŒ‡å®šçš„ä¸‹æ ‡è¿›è¡Œæ’å…¥çš„ã€‚
- é‚£ä¹ˆç°åœ¨è·å–å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)ï¼Œæ˜¯ä¸æœ‰ç‚¹åƒ`HashMap`ä¸­çš„æ¡¶ç»“æ„ã€‚

## äº”ã€æ€»ç»“

- å°±åƒæˆ‘ä»¬å¼€å¤´è¯´çš„ä¸€æ ·ï¼Œæ•°æ®ç»“æ„æ˜¯ä½ å†™å‡ºä»£ç çš„åŸºç¡€ï¼Œæ›´æ˜¯å†™å‡ºé«˜çº§ä»£ç çš„æ ¸å¿ƒã€‚åªæœ‰äº†è§£å¥½æ•°æ®ç»“æ„ï¼Œæ‰èƒ½æ›´é€å½»çš„ç†è§£ç¨‹åºè®¾è®¡ã€‚*å¹¶ä¸æ˜¯æ‰€æœ‰çš„é€»è¾‘éƒ½æ˜¯forå¾ªç¯*
- é¢è¯•é¢˜åªæ˜¯å¼•å¯¼ä½ å­¦ä¹ çš„ç‚¹ï¼Œä½†ä¸èƒ½ä¸ºäº†é¢è¯•é¢˜è€Œå¿½ç•¥æ›´é‡è¦çš„æ ¸å¿ƒçŸ¥è¯†å­¦ä¹ ï¼ŒèƒŒä¸€ä¸¤é“é¢˜æ˜¯ä¸å¯èƒ½æŠ—ä½æ·±åº¦é—®çš„ã€‚å› ä¸ºä»»ä½•ä¸€ä¸ªè€ƒç‚¹ï¼Œéƒ½ä¸åªæ˜¯ä¸€ç§é—®æ³•ï¼Œå¾€å¾€å¯ä»¥ä»å¾ˆå¤šæ–¹é¢è¿›è¡Œæé—®å’Œè€ƒæŸ¥ã€‚å°±åƒä½ çœ‹å®Œæ•´ç¯‡æ–‡ç« ï¼Œæ˜¯å¦ç†è§£äº†æ²¡æœ‰è¯´åˆ°çš„çŸ¥è¯†ï¼Œå½“ä½ å›ºå®šä½ç½®æ’å…¥æ•°æ®æ—¶ä¼šè¿›è¡Œæ•°æ®è¿ç§»ï¼Œé‚£ä¹ˆåœ¨æ‹¥æœ‰å¤§é‡æ•°æ®çš„ArrayListä¸­æ˜¯ä¸é€‚åˆè¿™ä¹ˆåšçš„ï¼Œéå¸¸å½±å“æ€§èƒ½ã€‚
- åœ¨æœ¬ç« çš„å†…å®¹ç¼–å†™çš„æ—¶å€™ä¹Ÿå‚è€ƒåˆ°ä¸€äº›ä¼˜ç§€çš„èµ„æ–™ï¼Œå°¤å…¶å‘ç°è¿™ä»½å¤–æ–‡æ–‡æ¡£ï¼›[https://beginnersbook.com/](https://beginnersbook.com/) å¤§å®¶å¯ä»¥å‚è€ƒå­¦ä¹ ã€‚
