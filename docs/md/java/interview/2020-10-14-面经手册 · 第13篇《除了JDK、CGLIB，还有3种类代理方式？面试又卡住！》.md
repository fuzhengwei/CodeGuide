---
layout: post
category: interview
title: é¢ç»æ‰‹å†Œ Â· ç¬¬13ç¯‡ã€Šé™¤äº†JDKã€CGLIBï¼Œè¿˜æœ‰3ç§ç±»ä»£ç†æ–¹å¼ï¼Ÿé¢è¯•åˆå¡ä½ï¼ã€‹
tagline: by å°å‚…å“¥
tag: [java,interview]
excerpt: æ‹“å®½æŠ€æœ¯å±‚é¢ã€æŒ–æ˜æŠ€æœ¯æ·±åº¦ï¼Œå¼ºåŒ–æŠ€æœ¯è®¤çŸ¥ã€çªç ´æŠ€æœ¯ç“¶é¢ˆï¼ä½ èƒ½äº†è§£å¤šå°‘æŠ€æœ¯æ˜¯å’Œä½ å¯¹ä¸€ä¸ªæŠ€æœ¯çš„ç†è§£æ·±åº¦æœ‰å…³ï¼Œè€Œä½ èƒ½å¯¹ä¸€ä¸ªæŠ€æœ¯æ¢ç©¶çš„å¤šæ·±åˆæ˜¯éœ€è¦ä½ æœ‰ä¸€å®šçš„å¹¿åº¦è®¤çŸ¥ã€‚å¦åˆ™å¦‚æœåªå»äº†è§£çš®æ¯›æˆ–è€…æ­»ç£•ä¸€æ®µä»£ç ï¼Œæ”¶è·éƒ½ä¸ä¸€å®šæœ‰å¤šå¤§ï¼Œæˆ–è€…è¦ä»˜å‡ºå¾ˆå¤§çš„æˆæœ¬ã€‚
lock: need
---

# é¢ç»æ‰‹å†Œ Â· ç¬¬13ç¯‡ã€Šé™¤äº†JDKã€CGLIBï¼Œè¿˜æœ‰3ç§ç±»ä»£ç†æ–¹å¼ï¼Ÿé¢è¯•åˆå¡ä½ï¼ã€‹

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

## ä¸€ã€å‰è¨€

`ç¼–ç¨‹å­¦ä¹ ï¼Œå…ˆé“ºå®½åº¦è¿˜æ˜¯æŒ–æ·±åº¦ï¼Ÿ`

å…¶å®æŠ€æœ¯å®½åº¦ä¸æŠ€æœ¯æ·±åº¦æ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œä½ èƒ½äº†è§£å¤šå°‘æŠ€æœ¯æ˜¯å’Œä½ å¯¹ä¸€ä¸ªæŠ€æœ¯çš„ç†è§£æ·±åº¦æœ‰å…³ï¼Œè€Œä½ èƒ½å¯¹ä¸€ä¸ªæŠ€æœ¯æ¢ç©¶çš„å¤šæ·±åˆæ˜¯éœ€è¦ä½ æœ‰ä¸€å®šçš„å¹¿åº¦è®¤çŸ¥ã€‚å¦åˆ™å¦‚æœåªå»äº†è§£çš®æ¯›æˆ–è€…æ­»ç£•ä¸€æ®µä»£ç ï¼Œæ”¶è·éƒ½ä¸ä¸€å®šæœ‰å¤šå¤§ï¼Œæˆ–è€…è¦ä»˜å‡ºå¾ˆå¤§çš„æˆæœ¬ã€‚

`æŠ€æœ¯ç“¶é¢ˆï¼Œä¸å¹´é¾„ç›¸å…³è¿˜æ˜¯å¤§å‚ï¼Ÿ`

äº²èº«å½“è¿‡é¢è¯•å®˜å¾ˆä¹…ï¼Œä¹Ÿé¢è¯•è¿‡å¾ˆå¤šäººã€‚æœ‰æ—¶å€™ä¸ä¸€å®šå¹´é¾„å¾ˆå¤§å°±æŠ€æœ¯å¥½ï¼Œä¹Ÿä¸ä¸€å®šåˆšå·¥ä½œ2å¹´å·¦å³å°±ä¸è¡Œã€‚å¾€å¾€æˆ‘ä»¬è¯´çš„ä¸€äº›é¢è¯•é€ ç«ç®­ï¼Œä½†æ˜¯åœ¨è¿™äº›æ±‚èŒè€…çš„å›ç­”ä¸­ï¼Œéƒ½èƒ½ç»™å‡ºéå¸¸å‡†ç¡®çš„ç­”æ¡ˆã€‚ä¹Ÿå°±æ˜¯ä»–èƒ½å›ç­”åˆ°ç‚¹ä¸Šï¼Œè¿™æ˜¯æ‡‚äº†æ‰èƒ½åšåˆ°çš„ã€‚

å·¥ä½œæ—¶é•¿ä¸æ˜¯å¦åœ¨å¤§å‚ï¼Œè¿™äº›éƒ½æ˜¯èƒ½æ¥è§¦åˆ°èµ„æºçš„å¤šå°‘ï¼Œçœ‹åˆ°æŠ€æœ¯è§è¯†çš„é«˜åº¦ã€‚ä½†çœŸçš„æƒ³æŠŠè¿™äº›ä¸œè¥¿å¸æ”¶ç»™è‡ªå·±ï¼Œè¿˜æ˜¯éœ€è¦ä¸ªäººçš„æ‹¼æã€‚å¦åˆ™å¾ˆå¤šä¸œè¥¿å³ä½¿æ‘†åœ¨ä½ é¢å‰ï¼Œä½ ä¹Ÿå¾ˆéš¾çœ‹åˆ°ã€‚*ä½ èƒ½çœ‹åˆ°çš„å¤šæ•°æ—¶å€™åªæ˜¯æ ‡é¢˜*

## äºŒã€é¢è¯•é¢˜

`è°¢é£æœºï¼Œå°è®°`ï¼Œ10.1å‡æœŸç©å—¨äº†çš„é£æœºï¼Œä¼¼ä¹å·²ç»æ”¾å‡å‰ç»™è‡ªå·±å®šçš„å­¦ä¹ ç›®æ ‡äº†ï¼ä½†ä¸€æƒ³åˆ°è¿˜æœ‰ä¸€åœºé¢è¯•ï¼Œä¸ç”±å¾—ä¸´æ—¶æŠ±ä½›è„šï¼Œå¼€å§‹çœ‹å°å‚…å“¥çš„åšå®¢ï¼š[bugstack.cn](https://bugstack.cn/)

**é¢è¯•å®˜**ï¼šé£æœºï¼Œçœ‹ä½ æ…Œé‡Œæ…Œå¼ çš„å‘¢ï¼Ÿ

**è°¢é£æœº**ï¼šæ²¡æœ‰ï¼Œæ²¡æœ‰ï¼Œåˆšæ‰æ€•æ¥ä¸åŠè·‘ä¸Šæ¥¼çš„ã€‚

**é¢è¯•å®˜**ï¼šå¥½ï¼æˆ‘çœ‹ä½ çš„ç®€å†ä¹Ÿæ²¡æ›´æ–°ï¼Œé‚£æˆ‘ä»¬è¿™æ¬¡èŠèŠåŠ¨æ€ä»£ç†å’Œåå°„å§ï¼Œä½ äº†è§£æ€ä¹ˆä»£ç†ä¸€ä¸ªç±»å—ï¼Ÿ

**è°¢é£æœº**ï¼šè¿™ä¸ªæˆ‘çŸ¥é“ï¼Œä½¿ç”¨JDKè‡ªå¸¦çš„ç±»`Proxy`å¯ä»¥ä»£ç†ä¸€ä¸ªç±»ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨CGLIBä»£ç†ã€‚

**é¢è¯•å®˜**ï¼šå—¯ï¼Œé‚£è¿™ä¸¤ä¸ªä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

**è°¢é£æœº**ï¼šå¥½åƒä¸€ä¸ªæ˜¯JDKçš„éœ€è¦æœ‰æ¥å£ï¼ŒCGLIBçš„ä¸éœ€è¦ã€‚

**é¢è¯•å®˜**ï¼šä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

**è°¢é£æœº**ï¼šä¸ºä»€ä¹ˆï¼Ÿè¿™...

**é¢è¯•å®˜**ï¼šé‚£ä½ è‡ªå·±å¼€å‘æ—¶ï¼Œç”¨ä»£ç†åšä»€ä¹ˆä¸šåŠ¡å—ï¼Ÿ

**è°¢é£æœº**ï¼š... å¥½åƒä¹Ÿæ²¡æœ‰ï¼

`é£æœºåªèƒ½æºœæºœçš„å›å®¶äº†ï¼ŒæŠ€æœ¯æ·±åº¦ä¸è¶³ï¼Œä¹Ÿæ²¡æœ‰å®é™…åº”ç”¨è¿‡ï¼Œè¿˜éœ€è¦å¾ˆå¤šè¡¥å…¨çš„å†…å®¹ï¼`

## ä¸‰ã€äº”ç§ç±»ä»£ç†çš„æ–¹å¼

`ä¸å‡ºæ„å¤–`ï¼Œä½ å¯èƒ½åªçŸ¥é“ä¸¤ç§ç±»ä»£ç†çš„æ–¹å¼ã€‚ä¸€ç§æ˜¯JDKè‡ªå¸¦çš„ï¼Œå¦å¤–ä¸€ç§æ˜¯CGLIBã€‚

æˆ‘ä»¬å…ˆå®šä¹‰å‡ºä¸€ä¸ªæ¥å£å’Œç›¸åº”çš„å®ç°ç±»ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ä»£ç†ç±»åœ¨æ–¹æ³•ä¸­æ·»åŠ è¾“å‡ºä¿¡æ¯ã€‚

**å®šä¹‰æ¥å£**

```java
public interface IUserApi {

    String queryUserInfo();

}
```

**å®ç°æ¥å£**

```java
public class UserApi implements IUserApi {

    public String queryUserInfo() {
        return "å°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼";
    }

}
```

å¥½ï¼æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»™è¿™ä¸ªç±»æ–¹æ³•ä½¿ç”¨ä»£ç†åŠ å…¥ä¸€è¡Œé¢å¤–è¾“å‡ºçš„ä¿¡æ¯ã€‚

### 0. å…ˆè¡¥å……ä¸€ç‚¹åå°„çš„çŸ¥è¯†

```java
@Test
public void test_reflect() throws Exception {
    Class<UserApi> clazz = UserApi.class;
    Method queryUserInfo = clazz.getMethod("queryUserInfo");
    Object invoke = queryUserInfo.invoke(clazz.newInstance());
    System.out.println(invoke);
}
```

***

- æŒ‡æ•°ï¼šâ­â­
- ç‚¹è¯„ï¼šæœ‰ä»£ç†åœ°æ–¹å‡ ä¹å°±ä¼šæœ‰åå°„ï¼Œä»–ä»¬æ˜¯ä¸€å¥—äº’ç›¸é…åˆä½¿ç”¨çš„åŠŸèƒ½ç±»ã€‚åœ¨åå°„ä¸­å¯ä»¥è°ƒç”¨æ–¹æ³•ã€è·å–å±æ€§ã€æ‹¿åˆ°æ³¨è§£ç­‰ç›¸å…³å†…å®¹ã€‚è¿™äº›éƒ½å¯ä»¥ä¸æ¥ä¸‹æ¥çš„ç±»ä»£ç†ç»„åˆä½¿ç”¨ï¼Œå®Œæˆå„ç§æ¡†æ¶ä¸­çš„æŠ€æœ¯åœºæ™¯ã€‚

### 1. JDKä»£ç†æ–¹å¼

```java
public class JDKProxy {

    public static <T> T getProxy(Class clazz) throws Exception {
        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
        return (T) Proxy.newProxyInstance(classLoader, new Class[]{clazz}, new InvocationHandler() {
            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                System.out.println(method.getName() + " ä½ è¢«ä»£ç†äº†ï¼ŒBy JDKProxyï¼");
                return "å°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼";
            }
        });
    }

}

@Test
public void test_JDKProxy() throws Exception {
    IUserApi userApi = JDKProxy.getProxy(IUserApi.class);
    String invoke = userApi.queryUserInfo();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", invoke);
}

/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy JDKProxyï¼
 * 19:55:47.319 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */
```

***

- æŒ‡æ•°ï¼šâ­â­
- åœºæ™¯ï¼šä¸­é—´ä»¶å¼€å‘ã€è®¾è®¡æ¨¡å¼ä¸­ä»£ç†æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼åº”ç”¨
- ç‚¹è¯„ï¼šè¿™ç§JDKè‡ªå¸¦çš„ç±»ä»£ç†æ–¹å¼æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•çš„ä¸€ç§ã€‚åŸºæœ¬ä¼šåœ¨ä¸€äº›ä¸­é—´ä»¶ä»£ç é‡Œçœ‹åˆ°ä¾‹å¦‚ï¼šæ•°æ®åº“è·¯ç”±ç»„ä»¶ã€Redisç»„ä»¶ç­‰ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ–¹å¼åº”ç”¨åˆ°è®¾è®¡æ¨¡å¼ä¸­ã€‚

### 2. CGLIBä»£ç†æ–¹å¼

```java
public class CglibProxy implements MethodInterceptor {
    public Object newInstall(Object object) {
        return Enhancer.create(object.getClass(), this);
    }
    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
        System.out.println("æˆ‘è¢«CglibProxyä»£ç†äº†");
        return methodProxy.invokeSuper(o, objects);
    }
}

@Test
public void test_CglibProxy() throws Exception {
    CglibProxy cglibProxy = new CglibProxy();
    UserApi userApi = (UserApi) cglibProxy.newInstall(new UserApi());
    String invoke = userApi.queryUserInfo();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", invoke);
}

/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy CglibProxyï¼
 * 19:55:47.319 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */
```

***

- æŒ‡æ•°ï¼šâ­â­â­
- åœºæ™¯ï¼šSpringã€AOPåˆ‡é¢ã€é‰´æƒæœåŠ¡ã€ä¸­é—´ä»¶å¼€å‘ã€RPCæ¡†æ¶ç­‰
- ç‚¹è¯„ï¼šCGLIBä¸åŒäºJDKï¼Œå®ƒçš„åº•å±‚ä½¿ç”¨ASMå­—èŠ‚ç æ¡†æ¶åœ¨ç±»ä¸­ä¿®æ”¹æŒ‡ä»¤ç å®ç°ä»£ç†ï¼Œæ‰€ä»¥è¿™ç§ä»£ç†æ–¹å¼ä¹Ÿå°±ä¸éœ€è¦åƒJDKé‚£æ ·éœ€è¦æ¥å£æ‰èƒ½ä»£ç†ã€‚åŒæ—¶å¾—ç›Šäºå­—èŠ‚ç æ¡†æ¶çš„ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™ç§ä»£ç†æ–¹å¼ä¹Ÿä¼šæ¯”ä½¿ç”¨JDKä»£ç†çš„æ–¹å¼å¿«1.5~2.0å€ã€‚

### 3. ASMä»£ç†æ–¹å¼

```java
public class ASMProxy extends ClassLoader {

    public static <T> T getProxy(Class clazz) throws Exception {

        ClassReader classReader = new ClassReader(clazz.getName());
        ClassWriter classWriter = new ClassWriter(classReader, ClassWriter.COMPUTE_MAXS);

        classReader.accept(new ClassVisitor(ASM5, classWriter) {
            @Override
            public MethodVisitor visitMethod(int access, final String name, String descriptor, String signature, String[] exceptions) {

                // æ–¹æ³•è¿‡æ»¤
                if (!"queryUserInfo".equals(name))
                    return super.visitMethod(access, name, descriptor, signature, exceptions);

                final MethodVisitor methodVisitor = super.visitMethod(access, name, descriptor, signature, exceptions);

                return new AdviceAdapter(ASM5, methodVisitor, access, name, descriptor) {

                    @Override
                    protected void onMethodEnter() {
                        // æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§
                        methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
                        // åŠ è½½å¸¸é‡ load constant
                        methodVisitor.visitLdcInsn(name + " ä½ è¢«ä»£ç†äº†ï¼ŒBy ASMï¼");
                        // è°ƒç”¨æ–¹æ³•
                        methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);
                        super.onMethodEnter();
                    }
                };
            }
        }, ClassReader.EXPAND_FRAMES);

        byte[] bytes = classWriter.toByteArray();

        return (T) new ASMProxy().defineClass(clazz.getName(), bytes, 0, bytes.length).newInstance();
    }

}

@Test
public void test_ASMProxy() throws Exception {
    IUserApi userApi = ASMProxy.getProxy(UserApi.class);
    String invoke = userApi.queryUserInfo();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", invoke);
}

/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy ASMï¼
 * 20:12:26.791 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */
```

***

- æŒ‡æ•°ï¼šâ­â­â­â­â­
- åœºæ™¯ï¼šå…¨é“¾è·¯ç›‘æ§ã€ç ´è§£å·¥å…·åŒ…ã€CGLIBã€Springè·å–ç±»å…ƒæ•°æ®ç­‰
- ç‚¹è¯„ï¼šè¿™ç§ä»£ç†å°±æ˜¯ä½¿ç”¨å­—èŠ‚ç ç¼–ç¨‹çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå®ƒçš„å®ç°æ–¹å¼ç›¸å¯¹å¤æ‚ï¼Œè€Œä¸”éœ€è¦äº†è§£Javaè™šæ‹Ÿæœºè§„èŒƒç›¸å…³çš„çŸ¥è¯†ã€‚å› ä¸ºä½ çš„æ¯ä¸€æ­¥ä»£ç†æ“ä½œï¼Œéƒ½æ˜¯åœ¨æ“ä½œå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š`Opcodes.GETSTATIC`ã€`Opcodes.INVOKEVIRTUAL`ï¼Œé™¤äº†è¿™äº›è¿˜æœ‰å°200ä¸ªå¸¸ç”¨çš„æŒ‡ä»¤ã€‚ä½†è¿™ç§æœ€æ¥è¿‘åº•å±‚çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ€å¿«çš„æ–¹å¼ã€‚æ‰€ä»¥åœ¨ä¸€äº›ä½¿ç”¨å­—èŠ‚ç æ’è£…çš„å…¨é“¾è·¯ç›‘æ§ä¸­ï¼Œä¼šéå¸¸å¸¸è§ã€‚

### 4. Byte-Buddyä»£ç†æ–¹å¼

```java
public class ByteBuddyProxy {

    public static <T> T getProxy(Class clazz) throws Exception {

        DynamicType.Unloaded<?> dynamicType = new ByteBuddy()
                .subclass(clazz)
                .method(ElementMatchers.<MethodDescription>named("queryUserInfo"))
                .intercept(MethodDelegation.to(InvocationHandler.class))
                .make();

        return (T) dynamicType.load(Thread.currentThread().getContextClassLoader()).getLoaded().newInstance();
    }

}

@RuntimeType
public static Object intercept(@Origin Method method, @AllArguments Object[] args, @SuperCall Callable<?> callable) throws Exception {
    System.out.println(method.getName() + " ä½ è¢«ä»£ç†äº†ï¼ŒBy Byte-Buddyï¼");
    return callable.call();
}

@Test
public void test_ByteBuddyProxy() throws Exception {
    IUserApi userApi = ByteBuddyProxy.getProxy(UserApi.class);
    String invoke = userApi.queryUserInfo();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", invoke);
}

/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy Byte-Buddyï¼
 * 20:19:44.498 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */
```

***

- æŒ‡æ•°ï¼šâ­â­â­â­
- åœºæ™¯ï¼šAOPåˆ‡é¢ã€ç±»ä»£ç†ã€ç»„ä»¶ã€ç›‘æ§ã€æ—¥å¿—
- ç‚¹è¯„ï¼š`Byte Buddy` ä¹Ÿæ˜¯ä¸€ä¸ªå­—èŠ‚ç æ“ä½œçš„ç±»åº“ï¼Œä½† `Byte Buddy` çš„ä½¿ç”¨æ–¹å¼æ›´åŠ ç®€å•ã€‚æ— éœ€ç†è§£å­—èŠ‚ç æŒ‡ä»¤ï¼Œå³å¯ä½¿ç”¨ç®€å•çš„ API å°±èƒ½å¾ˆå®¹æ˜“æ“ä½œå­—èŠ‚ç ï¼Œæ§åˆ¶ç±»å’Œæ–¹æ³•ã€‚æ¯”èµ·JDKåŠ¨æ€ä»£ç†ã€cglibï¼ŒByte Buddyåœ¨æ€§èƒ½ä¸Šå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚**å¦å¤–**ï¼Œ2015å¹´10æœˆï¼ŒByte Buddyè¢« Oracle æˆäºˆäº† Duke's Choiceå¤§å¥–ã€‚è¯¥å¥–é¡¹å¯¹Byte Buddyçš„â€œ JavaæŠ€æœ¯æ–¹é¢çš„å·¨å¤§åˆ›æ–° â€è¡¨ç¤ºèµèµã€‚

### 5. Javassistä»£ç†æ–¹å¼

```java
public class JavassistProxy extends ClassLoader {

    public static <T> T getProxy(Class clazz) throws Exception {

        ClassPool pool = ClassPool.getDefault();
        // è·å–ç±»
        CtClass ctClass = pool.get(clazz.getName());
        // è·å–æ–¹æ³•
        CtMethod ctMethod = ctClass.getDeclaredMethod("queryUserInfo");
        // æ–¹æ³•å‰åŠ å¼º
        ctMethod.insertBefore("{System.out.println(\"" + ctMethod.getName() + " ä½ è¢«ä»£ç†äº†ï¼ŒBy Javassist\");}");

        byte[] bytes = ctClass.toBytecode();

        return (T) new JavassistProxy().defineClass(clazz.getName(), bytes, 0, bytes.length).newInstance();
    }

}

@Test
public void test_JavassistProxy() throws Exception {
    IUserApi userApi = JavassistProxy.getProxy(UserApi.class)
    String invoke = userApi.queryUserInfo();
    logger.info("æµ‹è¯•ç»“æœï¼š{}", invoke);
}

/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy Javassist
 * 20:23:39.139 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */
```

***

- æŒ‡æ•°ï¼šâ­â­â­â­
- åœºæ™¯ï¼šå…¨é“¾è·¯ç›‘æ§ã€ç±»ä»£ç†ã€AOP
- ç‚¹è¯„ï¼š`Javassist` æ˜¯ä¸€ä¸ªä½¿ç”¨éå¸¸å¹¿çš„å­—èŠ‚ç æ’è£…æ¡†æ¶ï¼Œå‡ ä¹ä¸€å¤§éƒ¨åˆ†éå…¥ä¾µçš„å…¨é“¾è·¯ç›‘æ§éƒ½æ˜¯ä¼šé€‰æ‹©ä½¿ç”¨è¿™ä¸ªæ¡†æ¶ã€‚å› ä¸ºå®ƒä¸æƒ³ASMé‚£æ ·æ“ä½œå­—èŠ‚ç å¯¼è‡´é£é™©ï¼ŒåŒæ—¶å®ƒçš„åŠŸèƒ½ä¹Ÿéå¸¸é½å…¨ã€‚å¦å¤–ï¼Œè¿™ä¸ªæ¡†æ¶å³å¯ä½¿ç”¨å®ƒæ‰€æä¾›çš„æ–¹å¼ç›´æ¥ç¼–å†™æ’è£…ä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­—èŠ‚ç æŒ‡ä»¤è¿›è¡Œæ§åˆ¶ç”Ÿæˆä»£ç ï¼Œæ‰€ä»¥ç»¼åˆæ¥çœ‹ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„å­—èŠ‚ç æ¡†æ¶ã€‚

## å››ã€æ€»ç»“

![](https://bugstack.cn/assets/images/2020/interview/interview-14-01.png)

- ä»£ç†çš„å®é™…ç›®çš„å°±æ˜¯é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µï¼Œæ›¿æ¢æ‰åŸæœ‰çš„å®ç°ç±»æˆ–è€…ç»™åŸæœ‰çš„å®ç°ç±»æ³¨å…¥æ–°çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚è€Œè¿™äº›æŠ€æœ¯æœ€ç»ˆéƒ½ä¼šç”¨åˆ°ä¸€äº›æ¡†æ¶åº”ç”¨ã€ä¸­é—´ä»¶å¼€å‘ä»¥åŠç±»ä¼¼éå…¥ä¾µçš„å…¨é“¾è·¯ç›‘æ§ä¸­ã€‚
- ä¸€ä¸ªæŠ€æœ¯æ ˆæ·±åº¦çš„å­¦ä¹ èƒ½è®©ä½ é€å½»çš„äº†è§£åˆ°ä¸€äº›åŸºæœ¬çš„æ ¹æœ¬åŸç†ï¼Œé€šè¿‡è¿™æ ·çš„å­¦ä¹ å¯ä»¥è§£æƒ‘æ‰ä¸€äº›ä¼¼æ‡‚éæ‡‚çš„ç–‘é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™æ ·æŠ€æœ¯çš„æ‹“å±•è®©è‡ªå·±æœ‰æ›´å¥½çš„å·¥ä½œæœºä¼šå’Œè–ªèµ„å¾…é‡ã€‚
- è¿™äº›æŠ€æœ¯å­¦èµ·æ¥å¹¶ä¸ä¼šå¾ˆå®¹æ˜“ï¼Œç”šè‡³å¯èƒ½è¿˜æœ‰ä¸€äº›çƒ§è„‘ã€‚ä½†æ¯ä¸€æ®µå€¼å¾—æ·±å…¥å­¦ä¹ çš„æŠ€æœ¯éƒ½èƒ½å¸®åŠ©ä½ çªç ´ä¸€å®šé˜¶æ®µçš„æŠ€æœ¯ç“¶é¢ˆã€‚
