---
title: ç¬¬4èŠ‚ï¼šæ”¯æŒå¤šæ¸ é“å¯¹è¯
pay: https://t.zsxq.com/12pbqTH3P
---

# ã€ŠChatGPT å¾®æœåŠ¡åº”ç”¨ä½“ç³»æ„å»ºã€‹ - chatgpt-sdk ç¬¬4èŠ‚ï¼šæ”¯æŒå¤šæ¸ é“å¯¹è¯

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

- **æœ¬ç« éš¾åº¦**ï¼šâ˜…â˜…â˜†â˜†â˜†
- **æœ¬ç« é‡ç‚¹**ï¼šè®© ChatGPT SDK æ”¯æŒå¤šç§æ¸ é“çš„å¯¹è¯ï¼Œå› ä¸º ChatGPT çš„ API é™¤äº†å®˜ç½‘ä»¥å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¬å¸æœ‰ç›¸åº”çš„èµ„è´¨ï¼Œä»–ä»¬ä¼šæä¾›å¯¹åº”çš„ ApiHostã€ApiKeyï¼Œä»¥åŠ 3.5/4.0 æ¨¡å‹ã€‚
- **è¯¾ç¨‹è§†é¢‘**ï¼š[https://t.zsxq.com/12BVNBcAe](https://t.zsxq.com/12BVNBcAe)

## ä¸€ã€æœ¬ç« è¯‰æ±‚

åŸæœ¬åœ¨ ChatGPT SDK ä¸­ï¼Œæˆ‘ä»¬æƒ³è°ƒç”¨ä¸€ä¸ª ChatGPT çš„æ¥å£ï¼Œæ˜¯åœ¨ SDK åˆå§‹åŒ–é˜¶æ®µè®¾ç½® ApiKeyã€ApiHostï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è®¿é—®ç”¨æˆ·éƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸€å¥—çš„ ApiKeyã€ApiHost ä¸Šæ¥ã€‚ä½†å¯¹äºä¸€äº›ç‰¹æ®Šåœºæ™¯ï¼Œéœ€è¦ç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸åŒçš„ ApiKey ç”šè‡³å¯èƒ½è¿˜æœ‰å¯¹åº”çš„ ApiHost æ—¶ï¼Œç›®å‰çš„ SDK å°±ä¸å¥½æ‰©å±•äº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å®Œå–„è¿™å—çš„åŠŸèƒ½ï¼Œè®© ChatGPT SDK æ”¯æŒä¸åŒçš„æ¸ é“å¯¹è¯ã€‚

å¦å¤–åœ¨æœ¬èŠ‚ä¸­ä¼šä½¿ç”¨ @Deprecated æ³¨é‡Šæ‰ `authToken`ï¼Œåç»­ä¸åœ¨éœ€è¦ä½¿ç”¨ã€‚å¦‚æœä½ çš„æœåŠ¡è®¾ç½®äº† Token æ ¡éªŒï¼Œå¯ä»¥ç»§ç»­ä¿ç•™ã€‚

## äºŒã€æµç¨‹è®¾è®¡

æ•´ä¸ªæµç¨‹ä¸ºï¼›æ‰©å±•ä¼šè¯å…¥å‚ä¿¡æ¯ï¼Œåœ¨ HTTP å®¢æˆ·ç«¯ä¸­æ”¯æŒåŠ¨æ€å‚æ•°å¤„ç†ï¼›

<div align="center">
    <img src="https://bugstack.cn/images/article/project/chatgpt/chatgpt-sdk-04-01.png?raw=true" width="450px">
</div>

- å°å‚…å“¥ä¼šåœ¨åŸæœ‰çš„ SDK ä¸­å¢åŠ å¯¹å‚æ•°çš„é€ä¼ å¤„ç†ï¼Œé‡ç‚¹æ¶‰åŠå¯¹ OpenAiInterceptor çš„æ”¹é€ ã€‚ç›¸å½“äºä½ è¦åŠ¨æ€çš„å¤„ç† ApiKey çš„å‚æ•°ä¼ é€’ã€‚å¦å¤– ApiHost æ˜¯å·²ç»åŠ¨æ€çš„æ‹¼æ¥åˆ° URL é‡æ–°ç»„åˆäº†ã€‚
- é‚£ä¹ˆç°åœ¨çš„ DefaultOpenAiSession#chatCompletions æ¥å£ï¼Œå°±æœ‰äº†åŠ¨æ€ä½¿ç”¨ ApiHostã€ApiKey çš„èƒ½åŠ›ã€‚

## ä¸‰ã€æ–¹æ¡ˆå®ç°

### 1. å·¥ç¨‹ç»“æ„

<div align="center">
    <img src="https://bugstack.cn/images/article/project/chatgpt/chatgpt-sdk-04-02.png?raw=true" width="850px">
</div>

- å¦‚å›¾å·¥ç¨‹ä¸­çš„è“è‰²éƒ¨åˆ†ï¼Œä¸ºæœ¬æ¬¡éœ€è¦ä¿®æ”¹çš„ä»£ç åŒºåŸŸã€‚
- å­¦ä¹ æ—¶å€™å¯ä»¥ï¼Œä»¥æ¥å£ OpenAiSession#chatCompletions ä¸ºå…¥å£ï¼Œä¼šçœ‹åˆ°æ•´ä¸ªæ¨¡å—çš„ä¿®æ”¹å˜åŒ–ã€‚

### 2. æ¥å£å®šä¹‰ - æ‰©å±•ä¸€ä¸ªæ–°æ¥å£

**æºç **ï¼š`cn.bugstack.chatgpt.session.OpenAiSession`

```java
/**
 * é—®ç­”æ¨¡å‹ GPT-3.5/4.0 & æµå¼åé¦ˆ
 *
 * @param apiHostByUser         è‡ªå®šä¹‰host
 * @param apiKeyByUser          è‡ªå®šä¹‰Key
 * @param chatCompletionRequest è¯·æ±‚ä¿¡æ¯
 * @param eventSourceListener   å®ç°ç›‘å¬ï¼›é€šè¿‡ç›‘å¬çš„ onEvent æ–¹æ³•æ¥æ”¶æ•°æ®
 * @return åº”ç­”ç»“æœ
 */
EventSource chatCompletions(String apiHostByUser, String apiKeyByUser, ChatCompletionRequest chatCompletionRequest, EventSourceListener eventSourceListener) throws JsonProcessingException;
```

- é‡è½½ä¸€ä¸ª chatCompletions æ–¹æ³•ï¼Œå¢åŠ  apiHostByUserã€apiKeyByUser ä¸¤ä¸ªå­—æ®µã€‚ä¾¿äºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸»æœºéœ€è¦çš„ hostã€key

### 3. æ¥å£å®ç°

**æºç **ï¼š`cn.bugstack.chatgpt.session.defaults.DefaultOpenAiSession`

```java
public EventSource chatCompletions(String apiHostByUser, String apiKeyByUser, ChatCompletionRequest chatCompletionRequest, EventSourceListener eventSourceListener) throws JsonProcessingException {
    // æ ¸å¿ƒå‚æ•°æ ¡éªŒï¼›ä¸å¯¹ç”¨æˆ·çš„ä¼ å‚åšæ›´æ”¹ï¼Œåªè¿”å›é”™è¯¯ä¿¡æ¯ã€‚
    if (!chatCompletionRequest.isStream()) {
        throw new RuntimeException("illegal parameter stream is false!");
    }
    
    // åŠ¨æ€è®¾ç½® Hostã€Keyï¼Œä¾¿äºç”¨æˆ·ä¼ é€’è‡ªå·±çš„ä¿¡æ¯
    String apiHost = Constants.NULL.equals(apiHostByUser) ? configuration.getApiHost() : apiHostByUser;
    String apiKey = Constants.NULL.equals(apiKeyByUser) ? configuration.getApiKey() : apiKeyByUser;
    
    // æ„å»ºè¯·æ±‚ä¿¡æ¯
    Request request = new Request.Builder()
            // url: https://api.openai.com/v1/chat/completions - é€šè¿‡ IOpenAiApi é…ç½®çš„ POST æ¥å£ï¼Œç”¨è¿™æ ·çš„æ–¹å¼ä»ç»Ÿä¸€çš„åœ°æ–¹è·å–é…ç½®ä¿¡æ¯
            .url(apiHost.concat(IOpenAiApi.v1_chat_completions))
            .addHeader("apiKey", apiKey)
            // å°è£…è¯·æ±‚å‚æ•°ä¿¡æ¯ï¼Œå¦‚æœä½¿ç”¨äº† Fastjson ä¹Ÿå¯ä»¥æ›¿æ¢ ObjectMapper è½¬æ¢å¯¹è±¡
            .post(RequestBody.create(MediaType.parse(ContentType.JSON.getValue()), new ObjectMapper().writeValueAsString(chatCompletionRequest)))
            .build();
            
    // è¿”å›ç»“æœä¿¡æ¯ï¼›EventSource å¯¹è±¡å¯ä»¥å–æ¶ˆåº”ç­”
    return factory.newEventSource(request, eventSourceListener);
}    
```

- æ¥å£çš„å®ç°æœ‰2éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯é€ä¼  URL ä¸€ä¸ªæ˜¯è®¾ç½® apiKey å†™å…¥è¿›å»ã€‚
- ä¹‹åéœ€è¦åœ¨ã€è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨ã€‘ä¸­ï¼Œè®¾ç½® URL å’Œ ApiKeyã€‚

### 4. è‡ªå®šä¹‰æ‹¦æˆªå™¨

**æºç **ï¼š`cn.bugstack.chatgpt.interceptor.OpenAiInterceptor`

```java
public Response intercept(Chain chain) throws IOException {
    // 1. è·å–åŸå§‹ Request
    Request original = chain.request();
    
    // 2. è¯»å– apiKeyï¼›ä¼˜å…ˆä½¿ç”¨è‡ªå·±ä¼ é€’çš„ apiKey
    String apiKeyByUser = original.header("apiKey");
    String apiKey = Constants.NULL.equals(apiKeyByUser) ? apiKeyBySystem : apiKeyByUser;
    
    // 3. æ„å»º Request
    Request request = original.newBuilder()
            .url(original.url())
            .header(Header.AUTHORIZATION.getValue(), "Bearer " + apiKey)
            .header(Header.CONTENT_TYPE.getValue(), ContentType.JSON.getValue())
            .method(original.method(), original.body())
            .build();
            
    // 4. è¿”å›æ‰§è¡Œç»“æœ
    return chain.proceed(request);
}
```

- å› ä¸ºåç»­å·²ç»ä¸åœ¨éœ€è¦ authToken æ‰€ä»¥è¿™é‡Œçš„å®ç°å·²ç»å»æ‰äº†è¿™ä¸ªå­—æ®µçš„ä½¿ç”¨ã€‚
- é€šè¿‡åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†è‡ªå·±çš„ apiKey æ¥åˆ¤æ–­ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„è¿˜æ˜¯ç”¨æˆ·è‡ªå·±ä¼ çš„ï¼Œç³»ç»Ÿé»˜è®¤çš„å°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºä¼šè¯çš„æ—¶å€™åˆå§‹åŒ–çš„ã€‚ã€è¿™æ ·å°±å¯ä»¥æ»¡è¶³ç”¨æˆ·å¯ä»¥ä½“éªŒä½¿ç”¨ OpenAI ä¹Ÿå¯ä»¥ç»‘å®šè‡ªå·±çš„ APIKey ä½¿ç”¨ã€‘

## å››ã€åŠŸèƒ½éªŒè¯

### 1. å¿…è¦ä¿¡æ¯

1. å®˜ç½‘åŸå§‹ apiHost https://api.openai.com/ - å®˜ç½‘çš„Keyå¯ç›´æ¥ä½¿ç”¨
2. ä¸‰æ–¹å…¬å¸ apiHost https://pro-share-aws-api.zcyai.com/ - éœ€è¦æ‰¾æˆ‘è·å¾— Key

### 2. å•å…ƒæµ‹è¯•

```java
@Before
public void test_OpenAiSessionFactory() {
    // 1. é…ç½®æ–‡ä»¶ [è”ç³»å°å‚…å“¥è·å–key]
    // 1.1 å®˜ç½‘åŸå§‹ apiHost https://api.openai.com/ - å®˜ç½‘çš„Keyå¯ç›´æ¥ä½¿ç”¨
    // 1.2 ä¸‰æ–¹å…¬å¸ apiHost https://pro-share-aws-api.zcyai.com/ - éœ€è¦æ‰¾æˆ‘è·å¾— Key ã€æ”¯æŒ3.5\4.0æµå¼é—®ç­”æ¨¡å‹è°ƒç”¨ï¼Œæœ‰äº›æ¨¡å‹å·²åºŸå¼ƒä¸å¯¹æ¥ä½¿ç”¨ã€‘
    Configuration configuration = new Configuration();
    configuration.setApiHost("https://pro-share-aws-api.zcyai.com/");
    configuration.setApiKey("sk-8Fpeb11ARRIi5JGQCe480fCcF688436a8d9e3c7a6553Af2b");
    
    // 2. ä¼šè¯å·¥å‚
    OpenAiSessionFactory factory = new DefaultOpenAiSessionFactory(configuration);
    
    // 3. å¼€å¯ä¼šè¯
    this.openAiSession = factory.openSession();
}
```

```java
public void test_chat_completions_stream() throws JsonProcessingException, InterruptedException {
    // 1. åˆ›å»ºå‚æ•°
    ChatCompletionRequest chatCompletion = ChatCompletionRequest
            .builder()
            .stream(true)
            .messages(Collections.singletonList(Message.builder().role(Constants.Role.USER).content("1+1").build()))
            .model(ChatCompletionRequest.Model.GPT_3_5_TURBO.getCode())
            .maxTokens(1024)
            .build();
            
    // 2. ç”¨æˆ·é…ç½® ã€å¯é€‰å‚æ•°ï¼Œæ”¯æŒä¸åŒæ¸ é“çš„ apiHostã€apiKeyã€‘- æ–¹ä¾¿ç»™æ¯ä¸ªç”¨æˆ·éƒ½åˆ†é…äº†è‡ªå·±çš„keyï¼Œç”¨äºå”®å–åœºæ™¯
    String apiHost = "https://pro-share-aws-api.zcyai.com/";
    String apiKey = "sk-UAOxqX3EnM0zXxrz07CbC9E905E74549B4FdCcFcAd6bFbA3";
    
    // 3. å‘èµ·è¯·æ±‚
    EventSource eventSource = openAiSession.chatCompletions(apiHost, apiKey, chatCompletion, new EventSourceListener() {
        @Override
        public void onEvent(EventSource eventSource, String id, String type, String data) {
            log.info("æµ‹è¯•ç»“æœ id:{} type:{} data:{}", id, type, data);
        }
        @Override
        public void onFailure(EventSource eventSource, Throwable t, Response response) {
            log.error("å¤±è´¥ code:{} message:{}", response.code(), response.message());
        }
    });
    
    // ç­‰å¾…
    new CountDownLatch(1).await();
}
```

- é¦–å…ˆï¼Œåœ¨æµ‹è¯•ä¸­ `@Before` æ–¹æ³•ä¸‹åˆå§‹åŒ–è®¾ç½®äº† ApiHostã€ApiKey è¿™ä¸ªä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ç”¨æˆ·éƒ½ä½¿ç”¨çš„è®¾ç½®ã€‚
- ä¹‹åï¼Œåœ¨ test_chat_completions_stream æµ‹è¯•ä¸­ï¼Œåˆè®¾ç½®äº†ç”¨æˆ·è‡ªå·±çš„ apiHostã€apiKeyï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨è°ƒç”¨çš„æ—¶å€™æ ¹æ®éœ€è¦è‡ªå·±è®¾ç½®äº†ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·è´­ä¹°çš„é…ç½®ã€‚

### 3. æµ‹è¯•ç»“æœ

```java
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"role":"assistant","content":""},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":"1"},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":"+"},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":"1"},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":" equals"},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":" "},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":"2"},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{"content":"."},"finish_reason":null}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š{"id":"chatcmpl-85SMBxN77xL024C4ExM7kaZAl93IV","object":"chat.completion.chunk","created":1696311335,"model":"gpt-3.5-turbo-0613","choices":[{"index":0,"delta":{},"finish_reason":"stop"}]}
[OkHttp https://pro-share-aws-api.zcyai.com/...] INFO cn.bugstack.chatgpt.test.ApiTest - æµ‹è¯•ç»“æœï¼š[DONE]
```

- æµå¼å¯¹è¯è¿”å›ç»“æœã€‚

## äº”ã€è¯»è€…ä½œä¸š

- ç®€å•ä½œä¸šï¼šå­¦ä¹ æœ¬ç« çš„ä»£ç ï¼Œå®ŒæˆåŠŸèƒ½çš„å¼€å‘å’Œæµ‹è¯•ã€‚
- å¤æ‚ä½œä¸šï¼šåšåˆ°ç°åœ¨çš„ç« èŠ‚ï¼Œä»¥åŠæœ‰ openai.itedus.cn åœ¨å‰é¢å¼•è·¯ï¼Œä½ ä¹Ÿä¼šæœ‰äº†ä¸€äº›æƒ³æ³•ã€‚é‚£ä¹ˆä½ å®Œå…¨å¯ä»¥æ ¹æ®è¿™äº›å†…å®¹åšä¸€äº›æ‰©å±•å®ç°ï¼Œè®©ä½ çš„ OpenAI å³å¯è‡ªå·±ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥è®©åˆ«äººä½¿ç”¨ã€‚