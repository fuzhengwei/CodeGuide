---
title: ç½‘ç«™æç¤ºç”¨å…¬ä¼—å·æ‰«ç ç™»å½•ï¼Œä»–ä»¬æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
lock: need
---

# ã€å°åœºæ™¯è®­ç»ƒè¥ã€‘ç½‘ç«™æç¤ºç”¨å…¬ä¼—å·æ‰«ç ç™»å½•ï¼Œä»–ä»¬æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

ä½œè€…ï¼šå°å‚…å“¥
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„

<iframe id="B-Video" src="//player.bilibili.com/player.html?aid=1901077704&bvid=BV1um411f7f8&cid=1454096803&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="100%" height="480"> </iframe>

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æŠ€æœ¯UPä¸»å°å‚…å“¥ã€‚

ä½œä¸ºä¸€ä¸ªæŠ€æœ¯ç å†œï¼Œåœ¨ä½¿ç”¨ç¤¾åŒºã€è®ºå›æˆ–è€…å„ç±»AIæœåŠ¡çš„æ—¶ï¼Œç»å¸¸ä¼šçœ‹åˆ°è¿™æ ·ä¸€ä¸ªæç¤ºï¼šâ€œä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·æ‰«ç ç™»å½•â€ã€‚é‚£å› ä¸ºè¿™ç§çš„ç™»å½•æ–¹å¼é™¤äº†ç™»å½•ï¼Œè¿˜å¯ä»¥è®©ç”¨æˆ·æ²‰æ·€åˆ°å…¬ä¼—å·ä¸Šï¼Œä»¥åè¿˜èƒ½æ¥æ”¶åˆ°å…¬ä¼—å·æ¨å¹¿ï¼Œå¯è°“æ˜¯ä¸€ä¸¾ä¸¤å¾—ã€‚é‚£å®ƒæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼ŸğŸ¤”

<div align="center">
    <img src="https://bugstack.cn/images/article/project/chatgpt/chatgpt-extra-230905-01.png?raw=true" width="150px">
</div>

å°å‚…å“¥ï¼Œå…ˆä¸¾ä¸ªè¿™æ ·ç™»å½•çš„ä¾‹å­ğŸŒ°ï¼Œè®©å¤§å®¶ç†Ÿæ‚‰ä¸‹è¿™ä¸ªä¸šåŠ¡åœºæ™¯ã€‚

è¿™æ˜¯ä¸€ä¸ª CSDN å¾®ä¿¡æ‰«ç ç™»å½•çš„åœºæ™¯ï¼Œé€šè¿‡ F12 æ‰“å¼€æµè§ˆå™¨çš„æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°ä¸æ–­çš„è¯·æ±‚ä¸€ä¸ªç½‘ç»œåœ°å€ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‰«ç ã€‚å½“ä½ ä½¿ç”¨å¾®ä¿¡æ‰«ç åï¼Œåˆ™ä¼šç™»å½•æˆåŠŸè·³è½¬åˆ°ç½‘ç«™çš„é¦–é¡µã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-01.png" width="750px">
</div>

é€šè¿‡è¿™æ ·çš„ä¸€ä¸ªé¡µé¢æ•ˆæœå±•ç¤ºï¼Œæˆ‘ä»¬ç²—ç•¥çš„å¯ä»¥çŸ¥é“ï¼Œç”¨æˆ·é¡µé¢ä¸æ–­çš„ checkScan æ£€æµ‹ï¼Œæ˜¯éœ€è¦ç”¨åˆ°ä¸€ä¸ªå”¯ä¸€IDå€¼ã€‚è€Œå½“ç”¨æˆ·ç”¨å¾®ä¿¡æ‰«ç åï¼Œè¿™ä¸ªå”¯ä¸€IDå€¼åˆ™å¯ä»¥é€šè¿‡å¾®ä¿¡å…¬ä¼—å·è·å–åˆ°å¹¶ä¿å­˜ï¼ŒåŒæ—¶åˆ›å»ºå‡ºå”¯ä¸€ID å’Œ Token çš„æ˜ å°„å…³ç³»ã€‚é‚£ä¹ˆå½“ checkScan æ‰«æåˆ°æœåŠ¡ç«¯æœ‰è¿™ä¹ˆä¸€ä¸ªæ˜ å°„ï¼Œåˆ™å¯ä»¥æŠŠ Token å–å›æ¥å­˜åˆ°æµè§ˆå™¨ä¸­ï¼Œè®©ç”¨æˆ·ç™»å½•æˆåŠŸã€‚

æµç¨‹å°±æ˜¯è¿™æ ·ï¼Œé‚£å…·ä½“çš„ä»£ç å®ç°æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥å°å‚…å“¥å°±ç»™å¤§å®¶åˆ†äº«ä¸‹ï¼Œæ€ä¹ˆæ¥å®ç°ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆã€‚

>æ–‡æœ«æä¾›äº†ã€Œæ˜Ÿçƒï¼šç å†œä¼šé”ã€ğŸ§§ä¼˜æƒ åŠ å…¥æ–¹å¼ï¼Œä»¥åŠæœ¬èŠ‚è¯¾ç¨‹çš„ä»£ç åœ°å€ã€‚é¡¹ç›®æ¼”ç¤ºåœ°å€ï¼š[https://gaga.plus](https://gaga.plus)

## ä¸€ã€æµç¨‹è®¾è®¡

å¾®ä¿¡æ‰«ç ç™»å½•çš„æµç¨‹ä¸»è¦åŒ…æ‹¬ï¼›ç”¨æˆ·ã€æµè§ˆå™¨ã€åç«¯æœåŠ¡ã€å…¬ä¼—å·ï¼Œè¿™å››ä¸ªéƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡UMLæµç¨‹å›¾ï¼Œäº†è§£ä¸‹æ•´ä¸ªè°ƒç”¨å…³ç³»ã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-02.png" width="700px">
</div>

- é¦–å…ˆï¼Œç”±ç”¨æˆ·å‘èµ·ç™»å½•æ“ä½œã€‚è®©WEBé¡µé¢ä»æœåŠ¡ç«¯è·å–ç™»å½•å‡­è¯ã€‚
- ä¹‹åï¼Œå‰ç«¯é¡µé¢æ‹¿åˆ°ç™»å½•å‡­è¯åï¼Œå¯ä»¥ä½¿ç”¨ Ticket ä»å…¬ä¼—å·æœåŠ¡å¹³å°æ¢å–äºŒç»´ç ã€‚
- æœ€åï¼Œç”¨æˆ·æ‰«ç ç™»å½•ã€‚æ‰«ç åï¼ŒæœåŠ¡ç«¯ä¼šæ¥æ”¶åˆ°æ¥è‡ªå…¬ä¼—å·çš„å›è°ƒæ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å†æŠŠå›è°ƒæ¶ˆæ¯ä¸­çš„ openidã€ç”¨æˆ·å”¯ä¸€æ ‡è¯†ã€‘å’Œ ticket è¿›è¡Œç»‘å®šã€‚è¿™ä¸ªæ—¶å€™ä½ ä¹Ÿå¯ä»¥åˆ›å»ºå‡º jwt token åé¦ˆç»™å‰ç«¯ï¼Œä½œä¸ºç™»å½•æˆåŠŸçš„å­˜å‚¨ä¿¡æ¯ï¼Œåç»­æ ¡éªŒ jwt token å°±å¯ä»¥äº†ã€‚

æœ‰äº†è¿™æ ·ä¸€ä¸ªæµç¨‹çš„ç†è§£ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹ä¸‹ä»£ç æ˜¯å¦‚ä½•å®ç°çš„äº†ã€‚

## äºŒã€å¯¹æ¥æ–‡æ¡£ - å…¬ä¼—å·å¹³å°

- å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•å¹³å°ï¼š[https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index) - `ä¸éœ€è¦ç”³è¯·å…¬ä¼—å·å³å¯å®Œæˆæµ‹è¯•ï¼Œç±»ä¼¼æ²™ç®±ç¯å¢ƒ`
- è·å– Access Token æ–‡æ¡£ï¼š[https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)
- ç”Ÿæˆå¸¦å‚æ•°çš„äºŒç»´ç ï¼š[https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html) - `æœ€ç»ˆå°±æ˜¯ç”¨æˆ·æ‰«æçš„äºŒç»´ç `
- å†…ç½‘ç©¿é€å·¥å…·ï¼Œ[natapp.cn](https://natapp.cn/) - å› ä¸ºéœ€è¦è®©å…¬ä¼—å·è°ƒç”¨åˆ°æœ¬åœ°çš„æœåŠ¡ï¼Œæ‰€éœ€è¦æŠŠä½ çš„æœåŠ¡æ˜ å°„åˆ°å…¬ç½‘ä¸Šä½¿ç”¨ã€‚æ³¨æ„ï¼›è¦é€‰æ‹©ä»˜è´¹çš„12å…ƒï¼Œå¦åˆ™ä¸èƒ½å¯¹æ¥ã€‚

## ä¸‰ã€åŠŸèƒ½å®ç°

å°å‚…å“¥è¿™é‡Œé‡‡ç”¨äº† DDD çš„å·¥ç¨‹æ¨¡å‹ç»“æ„ï¼Œå¼€å‘å…¬ä¼—å·æ‰«ç ç™»å½•æœåŠ¡ç«¯æ¡ˆä¾‹ã€‚å¦‚æœä½ å¯¹ DDD è¿˜ä¸æ˜¯å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥çœ‹ä¸‹å°å‚…å“¥å†™çš„ç³»åˆ— DDD æ•™ç¨‹ï¼›[ã€ŠJava ç®€æ˜æ•™ç¨‹ã€‹](https://bugstack.cn/md/road-map/road-map.html)

### 1. å·¥ç¨‹ç»“æ„

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-03.png" width="400px">
</div>

- xfg-dev-tech-app æ˜¯å¯åŠ¨åº”ç”¨ç¨‹åºçš„å…¥å£ï¼Œå…¶ä»–æ¨¡å—ä¹Ÿè¢«ç›´æ¥æˆ–è€…é—´æ¥çš„å¼•å…¥åˆ° app æ¨¡å—ä¸‹ï¼Œè¿™æ ·æ‰èƒ½è¢« Spring æ‰«æåŠ è½½ã€‚
- xfg-dev-tech-infrastructure æ˜¯åŸºç¡€è®¾æ–½å±‚ï¼Œç”¨äºå¯¹æ¥å¤–éƒ¨æ¥å£ã€ç¼“å­˜ã€æ•°æ®åº“ç­‰ç›¸å…³å†…å®¹çš„è¿æ¥ä½¿ç”¨ã€‚æœ¬èŠ‚ä¸»è¦æ˜¯å¯¹æ¥å¾®ä¿¡å¼€å‘å¹³å°çš„æ¥å£ã€‚é‡‡ç”¨çš„æ˜¯ retrofit2 æŠ€æœ¯æ¡†æ¶ï¼Œè¿™æ ·å¯¹æ¥èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚
- xfg-dev-tech-domain æ˜¯åŠŸèƒ½å®ç°å±‚ï¼Œåƒæ˜¯ç™»å½•çš„å…·ä½“å®ç°ï¼Œå°±æ˜¯åœ¨ domain é¢†åŸŸå±‚å®ç°çš„ã€‚ä½ å°†æ¥ä½¿ç”¨ DDD åšçš„å…¶ä»–åŠŸèƒ½ï¼Œä¹Ÿæ˜¯æ”¾åˆ° domain é¢†åŸŸä¸‹å®ç°ï¼Œæ¯ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å°±æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚
- xfg-dev-tech-types ç”¨äºå®šä¹‰åŸºæœ¬çš„ç±»å‹ã€æšä¸¾ã€é”™è¯¯ç ç­‰å†…å®¹ã€‚

### 2. äºŒç»´ç è·å–

ä»[å¾®ä¿¡å®˜ç½‘æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html)é˜…è¯»å¯ä»¥çŸ¥é“ï¼Œä¸ºäº†è·å–æ‰«ç ç™»å½•çš„äºŒç»´ç ï¼Œåˆ™éœ€è¦3æ­¥ï¼›
1. å…ˆè·å– AccessTokenï¼Œå®ƒæ˜¯å…¬ä¼—å·çš„å…¨å±€å”¯ä¸€æ¥å£è°ƒç”¨å‡­æ®ï¼Œå…¬ä¼—å·è°ƒç”¨å„æ¥å£æ—¶éƒ½éœ€ä½¿ç”¨access_tokenã€‚
2. é€šè¿‡ AccessToken è·å– ticket å‡­è¯ï¼Œå‡­è¯ç”¨äºè¡”æ¥ç”¨æˆ·æ‰«ç ç™»å½•å’Œå…¬ä¼—å·å›è°ƒåè·å–å‡­è¯ï¼Œä»¥æ­¤å…³è”ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚
3. é€šè¿‡ ticket ä¼ é€’ç»™å‰ç«¯ï¼Œå‰ç«¯é¡µé¢è®¿é—®å¾®ä¿¡åœ°å€ç›´æ¥è·å–äºŒç»´ç ã€‚

#### 2.1 æ¥å£å¯¹æ¥ - retrofit2

```java
public interface IWeixinApiService {

    /**
     * è·å– Access token
     * æ–‡æ¡£ï¼š<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html">Get_access_token</a>
     *
     * @param grantType è·å–access_tokenå¡«å†™client_credential
     * @param appId     ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯
     * @param appSecret ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ï¼Œå³appsecret
     * @return å“åº”ç»“æœ
     */
    @GET("cgi-bin/token")
    Call<WeixinTokenResponseDTO> getToken(
            @Query("grant_type") String grantType,
            @Query("appid") String appId,
            @Query("secret") String appSecret
    );

    /**
     * è·å–å‡­æ® ticket
     * æ–‡æ¡£ï¼š<a href="https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html">Generating_a_Parametric_QR_Code</a>
     * <a href="https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=TICKET">å‰ç«¯æ ¹æ®å‡­è¯å±•ç¤ºäºŒç»´ç </a>
     *
     * @param accessToken            getToken è·å–çš„ token ä¿¡æ¯
     * @param weixinQrCodeRequestDTO å…¥å‚å¯¹è±¡
     * @return åº”ç­”ç»“æœ
     */
    @POST("cgi-bin/qrcode/create")
    Call<WeixinQrCodeResponseDTO> createQrCode(@Query("access_token") String accessToken, @Body WeixinQrCodeRequestDTO weixinQrCodeRequestDTO);

}
```

- ä½¿ç”¨ retrofit2 å¯¹æ¥æ¥å£ï¼Œå®ƒå¯ä»¥ä»¥ä¸€ç§é¢å‘å¯¹è±¡çš„æ€ç»´ï¼Œä½¿ç”¨ HTTP æ¥å£ï¼Œå…å»è‡ªå·±å¤„ç†ä¸­é—´çš„å¯¹æ¥è¿‡ç¨‹ã€‚
- å¦å¤– okhttp3 æ¡†æ¶å¯¹æ¥æ¥å£ä¹Ÿéå¸¸å¥½ç”¨ï¼Œæœ‰çš„æ—¶å€™å¯ä»¥é…åˆä¸€èµ·ä½¿ç”¨ã€‚

```java
@Slf4j
@Configuration
public class Retrofit2Config {

    private static final String BASE_URL = "https://api.weixin.qq.com/";

    @Bean
    public Retrofit retrofit() {
        return new Retrofit.Builder()
                .baseUrl(BASE_URL)
                .addConverterFactory(JacksonConverterFactory.create())
                .build();
    }

    @Bean
    public IWeixinApiService weixinApiService(Retrofit retrofit) {
        return retrofit.create(IWeixinApiService.class);
    }

}
```

- ä½¿ç”¨ retrofit2 å¼€å‘å¥½æ¥å£åï¼Œåœ¨å† xfg-dev-tech-app æ¨¡å—çš„ config æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»ºæœåŠ¡ã€‚ã€è¿™æœ‰ç‚¹åƒ MyBatis çš„ Dao æ¥å£ä¸€æ ·ï¼Œåªéœ€è¦å®šä¹‰å¥½æ¥å£å³å¯ã€‘

#### 2.2 ApiPost è¯·æ±‚

æ¥å£ï¼š`https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=TICKET`

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-06.png" width="950px">
</div>

- APIPost æ¨¡æ‹Ÿç½‘é¡µè·å¾—çš„æ‰«ç ç™»å½•çš„äºŒç»´ç ã€‚
- æ¥ä¸‹æ¥ç¨‹åºåˆ°æµ‹è¯•çš„æ—¶å€™ï¼Œäº§ç”Ÿçš„ ticket ä¼šæ”¾åˆ°è¿™é‡Œæ¨¡æ‹Ÿä½¿ç”¨ã€‚

### 3. ç™»å½•ç å¼€å‘

**æºç **ï¼š`cn.bugstack.xfg.dev.tech.trigger.http.LoginController`

```java
@Slf4j
@RestController()
@CrossOrigin("*")
@RequestMapping("/api/v1/login/")
public class LoginController {

    @Resource
    private ILoginService loginService;

    @RequestMapping(value = "weixin_qrcode_ticket", method = RequestMethod.GET)
    public Response<String> weixinQrCodeTicket() {
        try {
            String qrCodeTicket = loginService.createQrCodeTicket();
            log.info("ç”Ÿæˆå¾®ä¿¡æ‰«ç ç™»å½• ticket {}", qrCodeTicket);
            return Response.<String>builder()
                    .code(Constants.ResponseCode.SUCCESS.getCode())
                    .info(Constants.ResponseCode.SUCCESS.getInfo())
                    .data(qrCodeTicket)
                    .build();
        } catch (Exception e) {
            log.info("ç”Ÿæˆå¾®ä¿¡æ‰«ç ç™»å½• ticket å¤±è´¥", e);
            return Response.<String>builder()
                    .code(Constants.ResponseCode.UN_ERROR.getCode())
                    .info(Constants.ResponseCode.UN_ERROR.getInfo())
                    .build();
        }
    }

    @RequestMapping(value = "check_login", method = RequestMethod.GET)
    public Response<String> checkLogin(@RequestParam String ticket) {
        try {
            String openidToken = loginService.checkLogin(ticket);
            log.info("æ‰«ææ£€æµ‹ç™»å½•ç»“æœ ticket:{} openidToken:{}", ticket, openidToken);
            if (StringUtils.isNotBlank(openidToken)) {
                return Response.<String>builder()
                        .code(Constants.ResponseCode.SUCCESS.getCode())
                        .info(Constants.ResponseCode.SUCCESS.getInfo())
                        .data(openidToken)
                        .build();
            } else {
                return Response.<String>builder()
                        .code(Constants.ResponseCode.NO_LOGIN.getCode())
                        .info(Constants.ResponseCode.NO_LOGIN.getInfo())
                        .build();
            }
        } catch (Exception e) {
            log.info("æ‰«ææ£€æµ‹ç™»å½•ç»“æœå¤±è´¥ ticket:{}", ticket);
            return Response.<String>builder()
                    .code(Constants.ResponseCode.UN_ERROR.getCode())
                    .info(Constants.ResponseCode.UN_ERROR.getInfo())
                    .build();
        }
    }

}
```

å¼€å‘ä¸¤ä¸ªæ¥å£ï¼›

1. `/api/v1/login/weixin_qrcode_ticket` -  è·å–å¾®ä¿¡ ticket å‡­è¯
2. `/api/v1/login/check_login` - è½®è®­éªŒè¯ç™»å½•

### 4. å…¬ä¼—å·å¼€å‘

é¦–å…ˆï¼Œåªè¦åšå…¬ä¼—å·å¼€å‘çš„æµç¨‹ï¼Œå°±å¿…é¡»æœ‰å…¬ä¼—å·çš„å¯¹æ¥ã€‚è¿™ä¸ªå¯¹æ¥å°±æ˜¯ä½ åœ¨è‡ªå·±æŒ‰ç…§å…¬ä¼—å·æ–‡æ¡£å¼€å‘å¥½å¯¹æ¥ç¨‹åºï¼Œé…ç½®åˆ°å…¬ä¼—å·å¹³å°ã€‚

#### 4.1 é…ç½®è¯´æ˜

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-04.png" width="950px">
</div>

å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯ä½ åœ¨ç™»å½•å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•å¹³å°ï¼Œæ·»åŠ æ¥å£é…ç½®å’ŒJSå®‰å…¨åŸŸåä»¥åçœ‹åˆ°çš„å†…å®¹ã€‚

1. æœ€é¡¶ä¸Šï¼Œå¾®ä¿¡å·ï¼Œéœ€è¦é…ç½®åˆ° xfg-dev-tech-weixin-login çš„ application-dev.yml æ–‡ä»¶ä¸­ã€‚
2. æµ‹è¯•å·ä¿¡æ¯ appIDã€appsecretï¼Œä¹Ÿéœ€è¦é…ç½®åˆ° application-dev.yml æ–‡ä»¶ä¸­ã€‚
3. æ¥å£ä¿¡æ¯çš„é…ç½®ï¼Œéœ€è¦ä½ åœ¨å¯åŠ¨ xfg-dev-tech-weixin-loginï¼ŒåŒæ—¶åœ¨æœ¬åœ°æµ‹è¯•æ—¶å¯åŠ¨ natapp å†…ç½‘ç©¿é€å·¥å…·åã€‚ç”¨ä½ çš„å†…ç½‘ç©¿é€åœ°å€ï¼Œå’Œå·¥ç¨‹çš„è¯·æ±‚åœ°å€çš„ URL é…ç½®åˆ°å…¬ä¼—å·æ¥å£é‡Œã€‚é…ç½®çš„æ—¶å€™ä¼šè¿›è¡ŒéªŒç­¾ï¼ŒéªŒç­¾æˆåŠŸåˆ™é…ç½®æˆåŠŸã€‚
4. ä½ è¿˜è¦æ‰«æå…³æ³¨`æµ‹è¯•å·äºŒç»´ç `ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°æµ‹è¯•ä¿¡æ¯ã€‚

#### 4.2 éªŒç­¾æœåŠ¡

**æºç **ï¼š`cn.bugstack.xfg.dev.tech.trigger.http.WeixinPortalController`

```java
@Slf4j
@RestController()
@CrossOrigin("*")
@RequestMapping("/api/v1/weixin/portal/")
public class WeixinPortalController {

    @Value("${weixin.config.originalid}")
    private String originalid;
    @Resource
    private Cache<String, String> openidToken;

    /**
     * éªŒç­¾ï¼Œç¡¬ç¼–ç  token b8b6 - æŒ‰éœ€ä¿®æ”¹
     */
    @GetMapping(value = "receive", produces = "text/plain;charset=utf-8")
    public String validate(@RequestParam(value = "signature", required = false) String signature,
                           @RequestParam(value = "timestamp", required = false) String timestamp,
                           @RequestParam(value = "nonce", required = false) String nonce,
                           @RequestParam(value = "echostr", required = false) String echostr) {
        try {
            log.info("å¾®ä¿¡å…¬ä¼—å·éªŒç­¾ä¿¡æ¯å¼€å§‹ [{}, {}, {}, {}]", signature, timestamp, nonce, echostr);
            if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) {
                throw new IllegalArgumentException("è¯·æ±‚å‚æ•°éæ³•ï¼Œè¯·æ ¸å®!");
            }
            boolean check = SignatureUtil.check("b8b6", signature, timestamp, nonce);
            log.info("å¾®ä¿¡å…¬ä¼—å·éªŒç­¾ä¿¡æ¯å®Œæˆ checkï¼š{}", check);
            if (!check) {
                return null;
            }
            return echostr;
        } catch (Exception e) {
            log.error("å¾®ä¿¡å…¬ä¼—å·éªŒç­¾ä¿¡æ¯å¤±è´¥ [{}, {}, {}, {}]", signature, timestamp, nonce, echostr, e);
            return null;
        }
    }

    /**
     * å›è°ƒï¼Œæ¥æ”¶å…¬ä¼—å·æ¶ˆæ¯ã€æ‰«æç™»å½•ï¼Œä¼šæ¥æ”¶åˆ°æ¶ˆæ¯ã€‘
     */
    @PostMapping(value = "receive", produces = "application/xml; charset=UTF-8")
    public String post(@RequestBody String requestBody,
                       @RequestParam("signature") String signature,
                       @RequestParam("timestamp") String timestamp,
                       @RequestParam("nonce") String nonce,
                       @RequestParam("openid") String openid,
                       @RequestParam(name = "encrypt_type", required = false) String encType,
                       @RequestParam(name = "msg_signature", required = false) String msgSignature) {
        try {
            log.info("æ¥æ”¶å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯è¯·æ±‚{}å¼€å§‹ {}", openid, requestBody);
            // æ¶ˆæ¯è½¬æ¢
            MessageTextEntity message = XmlUtil.xmlToBean(requestBody, MessageTextEntity.class);

            // æ‰«ç ç™»å½•ã€æ¶ˆæ¯ç±»å‹å’Œäº‹ä»¶ã€‘
            if ("event".equals(message.getMsgType()) && "SCAN".equals(message.getEvent())) {
                // å®é™…çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥ç”Ÿæˆ jwt çš„ token è®©å‰ç«¯å­˜å‚¨
                openidToken.put(message.getTicket(), openid);
                return buildMessageTextEntity(openid, "ç™»å½•æˆåŠŸ");
            }

            log.info("æ¥æ”¶å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯è¯·æ±‚{}å®Œæˆ {}", openid, requestBody);
            return buildMessageTextEntity(openid, "æµ‹è¯•æœ¬æ¡ˆä¾‹ï¼Œéœ€è¦è¯·æ‰«ç ç™»å½•ï¼");
        } catch (Exception e) {
            log.error("æ¥æ”¶å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯è¯·æ±‚{}å¤±è´¥ {}", openid, requestBody, e);
            return "";
        }
    }

    private String buildMessageTextEntity(String openid, String content) {
        MessageTextEntity res = new MessageTextEntity();
        // å…¬ä¼—å·åˆ†é…çš„ID
        res.setFromUserName(originalid);
        res.setToUserName(openid);
        res.setCreateTime(String.valueOf(System.currentTimeMillis() / 1000L));
        res.setMsgType("text");
        res.setContent(content);
        return XmlUtil.beanToXml(res);
    }

}
```

- éªŒç­¾å’Œæ¥æ”¶å…¬ä¼—å·å›è°ƒï¼Œæ˜¯ä¸€ä¸ªå›ºå®šçš„ä»£ç ï¼ŒåŒæ—¶éªŒç­¾å’Œæ¥æ”¶å…¬ä¼—å·å›è°ƒä¹Ÿéƒ½æ˜¯åŒä¸€ä¸ªæ¥å£åå­—ï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯ get è¯·æ±‚ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ post è¯·æ±‚ã€‚éªŒç­¾åœ°å€ï¼š`http://xfg-studio.natapp1.cc/api/v1/weixin/portal/receive` ä½ éœ€è¦æ›´æ¢ä¸ºä½ çš„å†…ç½‘ç©¿é€åŸŸååœ°å€ã€‚
- åœ¨æ¥æ”¶å…¬ä¼—å·å›è°ƒä¸­ï¼Œæœ‰ä¸€å—å›ºå®šçš„ä»£ç ã€‚æ¥æ”¶å…¬ä¼—å·æ¶ˆæ¯ç±»å‹ä¸ºäº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹ä¸ºæ‰«ç ï¼ˆSCANï¼‰ï¼Œä»ä¸­å¯ä»¥è·å¾— ticket è¿™ä¸ªå”¯ä¸€å‡­è¯ã€‚
- éªŒè¯ç™»å½•æ—¶ï¼Œç®€å•æ¨¡æ‹Ÿå†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚`openidToken.put(message.getTicket(), openid);` å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¼šè½¬æ¢ä¸ºç™»å½•çš„ jwt token æ•°æ®ã€‚

#### 4.3 å†…ç½‘ç©¿é€

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-05.png" width="950px">
</div>

- å†…ç½‘ç©¿é€å·¥å…·ï¼Œè´­ä¹°ä¸€ä¸ª12å…ƒçš„ä»˜è´¹éš§é“ã€‚[https://natapp.cn/](https://natapp.cn/)
- è´­ä¹°åï¼Œé…ç½®ä½ çš„éš§é“æœ¬åœ°ç«¯å£ä¸º 8091 ä¹Ÿå°±æ˜¯ä½ æœ¬åœ° SpringBoot ç¨‹åºçš„ç«¯å£ã€‚`å¦‚æœä½ ä¸æ˜¯ 8091 ç«¯å£ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºå…¶ä»–çš„`
- è½¯ä»¶ä¸‹è½½ï¼Œå†…ç½‘ç©¿é€éœ€è¦ä¸€ä¸ªæœ¬åœ°çš„è½¯ä»¶ã€‚ä½ å¯ä»¥ä»å®ƒçš„ç½‘ç«™ä¸‹è½½ã€‚[https://natapp.cn/#download](https://natapp.cn/#download) å„ä¸ªç‰ˆæœ¬ä¹Ÿéƒ½æ”¯æŒï¼Œé‡Œé¢ä¹Ÿæœ‰ç›¸å…³çš„ä½¿ç”¨æ•™ç¨‹ã€‚
- å®‰è£…è½¯ä»¶åï¼Œå¯åŠ¨ natapp å’Œåº”ç”¨ï¼Œå°±å¯ä»¥æŠŠä½ çš„åœ°å€é…ç½®åˆ°ä¸Šé¢äº†ã€‚

## å››ã€åŠŸèƒ½éªŒè¯

### 1. å¯åŠ¨ SpringBoot æœåŠ¡

```java
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::               (v2.7.12)
24-02-25.17:13:00.372 [main            ] INFO  EndpointLinksResolver  - Exposing 1 endpoint(s) beneath base path '/actuator'
24-02-25.17:13:00.405 [main            ] INFO  Http11NioProtocol      - Starting ProtocolHandler ["http-nio-8091"]
24-02-25.17:13:00.440 [main            ] INFO  TomcatWebServer        - Tomcat started on port(s): 8091 (http) with context path ''
24-02-25.17:13:00.461 [main            ] INFO  Application            - Started Application in 4.268 seconds (JVM running for 4.941)
```

### 2. å¯åŠ¨å†…ç½‘ç©¿é€

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-07.png" width="750px">
</div>

- ä» [natapp.cn](https://natapp.cn/tunnel/lists) ä½ çš„éš§é“ä¸­è·å– authtoken é…ç½®åˆ°æœ¬åœ°ä½ ä¸‹è½½çš„è½¯ä»¶é‡Œã€‚ã€æˆ‘ä¸‹è½½çš„macç‰ˆæœ¬ã€‘
- ä¹‹åä½ å¯ä»¥åŒå‡»å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`./natapp å¯åŠ¨`

### 3. è·å–äºŒç»´ç 

#### 3.1 è·å– ticket å‡­è¯

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-08.png" width="850px">
</div>

è®¿é—®æ¥å£ï¼š[http://xfg-studio.natapp1.cc/api/v1/login/weixin_qrcode_ticket](http://xfg-studio.natapp1.cc/api/v1/login/weixin_qrcode_ticket) - ä½ éœ€è¦æ›¿æ¢ä¸ºä½ çš„åœ°å€ã€‚

#### 3.2 ç”ŸæˆäºŒç»´ç 

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-09.png" width="850px">
</div>

è®¿é—®æ¥å£ï¼š[http://xfg-studio.natapp1.cc/api/v1/login/check_login](http://xfg-studio.natapp1.cc/api/v1/login/check_login) - ä½ éœ€è¦æ›¿æ¢ä¸ºä½ çš„åœ°å€ã€‚

### 4. æ‰«ç ç™»å½•

ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç ï¼Œè§‚å¯ŸæœåŠ¡ç«¯æ—¥å¿—å’Œæ‰‹æœºæç¤ºã€‚

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-10.png" width="450px">
</div>

```java
24-02-25.17:25:09.096 [http-nio-8091-exec-3] INFO  LoginController        - ç”Ÿæˆå¾®ä¿¡æ‰«ç ç™»å½• ticket gQHN7zwAAAAAAAAAAS5odHRwOi8vd2VpeGluLnFxLmNvbS9xLzAycTRMbnB4TDBjckcxT043cjFCMWoAAgR1B9tlAwQ8AAAA
24-02-25.17:25:18.793 [http-nio-8091-exec-5] INFO  WeixinPortalController - æ¥æ”¶å¾®ä¿¡å…¬ä¼—å·ä¿¡æ¯è¯·æ±‚or0Ab6ivwmypESVp_bYuk92T6SvUå¼€å§‹ <xml><ToUserName><![CDATA[gh_e067c267e056]]></ToUserName>
<FromUserName><![CDATA[or0Ab6ivwmypESVp_bYuk92T6SvU]]></FromUserName>
<CreateTime>1708853118</CreateTime>
<MsgType><![CDATA[event]]></MsgType>
<Event><![CDATA[SCAN]]></Event>
<EventKey><![CDATA[100601]]></EventKey>
<Ticket><![CDATA[gQHN7zwAAAAAAAAAAS5odHRwOi8vd2VpeGluLnFxLmNvbS9xLzAycTRMbnB4TDBjckcxT043cjFCMWoAAgR1B9tlAwQ8AAAA]]></Ticket>
</xml>
```

- æ‰«ç ç™»å½•åï¼Œå¯ä»¥çœ‹è§åé¦ˆçš„çŠ¶æ€ä¿¡æ¯ä»¥åŠæœåŠ¡ç«¯çš„æ—¥å¿—ã€‚

### 5. å¾ªç¯æ¨¡æ‹Ÿç™»å½•

<div align="center">
    <img src="https://bugstack.cn/images/article/project/ddd-scene-solution/xfg-dev-tech-weixin-login-11.png" width="850px">
</div>

- è®¿é—®æ¥å£ï¼š[http://xfg-studio.natapp1.cc/api/v1/login/check_login](http://xfg-studio.natapp1.cc/api/v1/login/check_login) - ä½ éœ€è¦æ›¿æ¢ä¸ºä½ çš„åœ°å€ã€‚
- å¥½ï¼Œåˆ°è¿™è¡¨æ˜å·²ç»ç™»å½•æˆåŠŸï¼Œå¹¶è¿”å›openidä¿¡æ¯ã€‚è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ª token ä¿å­˜åˆ°æµè§ˆå™¨ã€‚

## äº”ã€åŠ å…¥å­¦ä¹ 

**æ³¨æ„**ï¼ŒåŠ å…¥æ˜Ÿçƒã€Œç å†œä¼šé”ã€å³å¯å­¦ä¹ å°å‚…å“¥æ‰€æœ‰å®æˆ˜é¡¹ç›®ï¼Œæ˜Ÿçƒç±»ä¼¼äºç§æœ‰æŠ€æœ¯æœ‹å‹åœˆï¼Œå°å‚…å“¥æ˜¯æŠ€æœ¯ç¾¤ä¸»ï¼Œä¸ºå¤§å®¶æä¾›1v1çš„æŠ€æœ¯å­¦ä¹ ç­”ç–‘ã€‚

>ğŸ§§é¡¹ç›®åœ°å€ï¼šhttps://gaga.plus - è¿›å…¥æŸ¥çœ‹æ˜Ÿçƒ8ä¸ªå®æˆ˜é¡¹ç›®ï¼Œæ—©ç‚¹å­¦ä¹ ï¼Œå†²å‡»Offerï¼
